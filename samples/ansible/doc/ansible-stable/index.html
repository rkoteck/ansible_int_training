

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script type="text/javascript" src="//www.redhat.com/dtm.js"></script>

  <!-- Google Tag Manager Data Layer -->
  <script>
   dataLayer = [];
  </script>
  <!-- End Google Tag Manager Data Layer -->




  
  <title>Ansible Documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'./',
        VERSION:'2.4',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  false
      };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

    

  

  
  

  
    <link rel="stylesheet" href="_static/css/badge_only.css" type="text/css" />
  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="None" href="index.html#document-index"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

  <style>
    .search-reset-start {
        color: #463E3F;
        float: right;
        position: relative;
        top: -25px;
        left: -10px;
        z-index: 10;
     }
     .search-reset-start:hover {
        cursor: pointer;
        color: #2980B9;
     }
     #search-box-id {
        padding-right: 25px;
     }
  </style>

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300'
    rel='stylesheet' type='text/css'>


<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://ansible.readthedocs.io/en/latest/" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'index'
</script>

<script type="text/javascript" src="_static/readthedocs-dynamic-include.js"></script>

<!-- end RTD <extrahead> --></head>

<body class="wy-body-for-nav">

  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PSB293" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-PSB293');</script>
  <!-- End Google Tag Manager -->

    <div class="DocSite-globalNav ansibleNav">
        <ul>
            <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
            <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
            <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
            <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
            <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
        </ul>
    </div>

  <a class="DocSite-nav" href="/">
    <img class="DocSiteNav-logo"
      src="_static/images/logo_invert.png"
      alt="Ansible Logo">
    <div class="DocSiteNav-title">
      Documentation
    </div>
  </a>

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">

      <div style="background-color:#5bbdbf;height=80px;margin:'auto auto auto auto'">
        <a class="DocSiteProduct-header DocSiteProduct-header--core" href="/">
            <div class="DocSiteProduct-productName">
                <div class="DocSiteProduct-logoText">
                    Ansible  
                    <div class="DocSiteProduct-CurrentVersion" align="right">
                      v2.4
                  </div>
                </div>
            </div>
        </a>
        

          <div class="DocSiteProduct-CheckVersionPara">For previous versions, see the  <a class="DocSiteProduct-versionheader" href="/#coreversionselect">documentation archive.</a></div>
      </div>

      <div id="menu-id" class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-intro">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_getting_started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_inventory">Inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_dynamic_inventory">Dynamic Inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_patterns">Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_adhoc">Introduction To Ad-Hoc Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_configuration">Configuration file</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_bsd">BSD Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_windows">Windows Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-intro_networking">Networking Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-quickstart">Quickstart Video</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-playbooks">Playbooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_intro">Intro to Playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_reuse">Creating Reusable Playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_variables">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_templating">Templating (Jinja2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_conditionals">Conditionals</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_loops">Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_blocks">Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_strategies">Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_best_practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-playbooks_special_topics">Playbooks: Special Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-become">Become (Privilege Escalation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_acceleration">Accelerated Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_async">Asynchronous Actions and Polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_checkmode">Check Mode (&#8220;Dry Run&#8221;)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_debugger">Playbook Debugger</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_delegation">Delegation, Rolling Updates, and Local Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_environment">Setting the Environment (and Working With Proxies)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-language-specific-version-managers">Working With Language-Specific Version Managers</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_error_handling">Error Handling In Playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_advanced_syntax">Advanced Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_lookups">Lookups</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#examples">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_prompts">Prompts</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_tags">Tags</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_vault">Using Vault in playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-playbooks_startnstep">Start and Step</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-modules">About Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-modules_intro">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-common_return_values">Return Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-modules_support">Module Maintenance &amp; Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-vault">Ansible Vault</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#what-can-be-encrypted-with-vault">What Can Be Encrypted With Vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#creating-encrypted-files">Creating Encrypted Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#editing-encrypted-files">Editing Encrypted Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#rekeying-encrypted-files">Rekeying Encrypted Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#encrypting-unencrypted-files">Encrypting Unencrypted Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#decrypting-encrypted-files">Decrypting Encrypted Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#viewing-encrypted-files">Viewing Encrypted Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#use-encrypt-string-to-create-encrypted-variables-to-embed-in-yaml">Use encrypt_string to create encrypted variables to embed in yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vault-ids-and-multiple-vault-passwords">Vault Ids and Multiple Vault Passwords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#providing-vault-passwords">Providing Vault Passwords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#speeding-up-vault-operations">Speeding Up Vault Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vault-format">Vault Format</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vault-payload-format-1-1">Vault Payload Format 1.1</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-command_line_tools">Command Line Tools</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-guides">Detailed Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_aws">Amazon Web Services Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_azure">Getting Started with Azure</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_rax">Rackspace Cloud Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_gce">Google Cloud Platform Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_cloudstack">CloudStack Cloud Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_vagrant">Using Vagrant and Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_rolling_upgrade">Continuous Delivery and Rolling Upgrades</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_docker">Getting Started with Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-guide_packet">Using Ansible with the Packet host</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-dev_guide/index">Developer Information</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#ansible-developer-guide">Ansible Developer Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-tower">Ansible Tower</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-community">Community Information &amp; Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#ansible-users">Ansible Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#for-current-and-prospective-developers">For Current and Prospective Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#other-topics">Other Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#community-code-of-conduct">Community Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#contributors-license-agreement">Contributors License Agreement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-galaxy">Ansible Galaxy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-website">The Website</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-command-line-tool">The command line tool</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-test_strategies">Testing Strategies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#integrating-testing-with-ansible-playbooks">Integrating Testing With Ansible Playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-right-level-of-testing">The Right Level of Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#check-mode-as-a-drift-test">Check Mode As A Drift Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#modules-that-are-useful-for-testing">Modules That Are Useful for Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#testing-lifecycle">Testing Lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#integrating-testing-with-rolling-updates">Integrating Testing With Rolling Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#achieving-continuous-deployment">Achieving Continuous Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-faq">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-can-i-set-the-path-or-any-other-environment-variable-for-a-task-or-entire-playbook">How can I set the PATH or any other environment variable for a task or entire playbook?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-handle-different-machines-needing-different-user-accounts-or-ports-to-log-in-with">How do I handle different machines needing different user accounts or ports to log in with?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-get-ansible-to-reuse-connections-enable-kerberized-ssh-or-have-ansible-pay-attention-to-my-local-ssh-config-file">How do I get ansible to reuse connections, enable Kerberized SSH, or have Ansible pay attention to my local SSH config file?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-configure-a-jump-host-to-access-servers-that-i-have-no-direct-access-to">How do I configure a jump host to access servers that I have no direct access to?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-speed-up-management-inside-ec2">How do I speed up management inside EC2?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-handle-python-pathing-not-having-a-python-2-x-in-usr-bin-python-on-a-remote-machine">How do I handle python pathing not having a Python 2.X in /usr/bin/python on a remote machine?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#what-is-the-best-way-to-make-content-reusable-redistributable">What is the best way to make content reusable/redistributable?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#where-does-the-configuration-file-live-and-what-can-i-configure-in-it">Where does the configuration file live and what can I configure in it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-disable-cowsay">How do I disable cowsay?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-see-a-list-of-all-of-the-ansible-variables">How do I see a list of all of the ansible_ variables?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-see-all-the-inventory-vars-defined-for-my-host">How do I see all the inventory vars defined for my host?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-loop-over-a-list-of-hosts-in-a-group-inside-of-a-template">How do I loop over a list of hosts in a group, inside of a template?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-access-a-variable-name-programmatically">How do I access a variable name programmatically?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-access-a-variable-of-the-first-host-in-a-group">How do I access a variable of the first host in a group?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-copy-files-recursively-onto-a-target-host">How do I copy files recursively onto a target host?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-access-shell-environment-variables">How do I access shell environment variables?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-generate-crypted-passwords-for-the-user-module">How do I generate crypted passwords for the user module?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#can-i-get-training-on-ansible">Can I get training on Ansible?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#is-there-a-web-interface-rest-api-etc">Is there a web interface / REST API / etc?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-submit-a-change-to-the-documentation">How do I submit a change to the documentation?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#how-do-i-keep-secret-data-in-my-playbook">How do I keep secret data in my playbook?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#when-should-i-use-also-how-to-interpolate-variables-or-dynamic-variable-names">When should I use {{ }}? Also, how to interpolate variables or dynamic variable names</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#why-don-t-you-ship-in-x-format">Why don&#8217;t you ship in X format?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#i-don-t-see-my-question-here">I don&#8217;t see my question here</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-glossary">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-YAMLSyntax">YAML Syntax</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#yaml-basics">YAML Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#gotchas">Gotchas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-porting_guides">Ansible Porting Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-python_3_support">Python 3 Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#testing-python-3-with-commands-and-playbooks">Testing Python 3 with commands and playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#testing-python-3-module-support">Testing Python 3 module support</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#what-to-do-if-an-incompatibility-is-found">What to do if an incompatibility is found</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-release_and_maintenance">Release and maintenance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#release-cycle">Release cycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#release-status">Release status</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#development-and-stable-version-maintenance-workflow">Development and stable version maintenance workflow</a></li>
</ul>
</li>
</ul>

        


    <div class="DocSite-sideNav ansibleNav">
       <ul class="">
       <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
       <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
       <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
       <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
       <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
       </ul>
     </div>

    <!-- changeable widget -->
    <div id="sideBanner">
    <br/>
    <a href="https://www.ansible.com/docs-left?utm_source=docs">
      <img style="border-width:0px;" src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-left-rail.png" />
    </a>
    </div>


      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Ansible Documentation</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">

          <!-- Banner ads
          <div class="DocSiteBanner">
            <a class="DocSiteBanner-imgWrapper"
                href="https://www.ansible.com/docs-top?utm_source=docs">
                <img src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-top-left.png">
            </a>
            <a class="DocSiteBanner-imgWrapper"
                href="https://www.ansible.com/docs-top?utm_source=docs">
                <img src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-top-right.png">
            </a>
        </div> -->

          <ul class="wy-breadcrumbs">
  <li><a href="index.html#document-index">Docs</a> &raquo;</li>
  <li><a href="">Ansible Documentation</a></li>
  
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/ansible/ansible/blob/devel/docs/docsite/rst/index.rst" class="icon icon-github"> Edit on GitHub</a>
    </li>
  
</ul>
<hr/>

          <div id="page-content">
          
  <div class="section" id="ansible-documentation">
<h1>Ansible Documentation<a class="headerlink" href="#ansible-documentation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="about-ansible">
<h2>About Ansible<a class="headerlink" href="#about-ansible" title="Permalink to this headline">¶</a></h2>
<p>Welcome to the Ansible documentation!</p>
<p>Ansible is an IT automation tool.  It can configure systems, deploy software, and orchestrate more advanced IT tasks
such as continuous deployments or zero downtime rolling updates.</p>
<p>Ansible&#8217;s main goals are simplicity and ease-of-use. It also has a strong focus on security and reliability, featuring a minimum of moving parts, usage of OpenSSH for transport (with an accelerated socket mode and pull modes as alternatives), and a language that is designed around auditability by humans&#8211;even those not familiar with the program.</p>
<p>We believe simplicity is relevant to all sizes of environments, so we design for busy users of all types: developers, sysadmins, release engineers, IT managers, and everyone in between. Ansible is appropriate for managing all environments, from small setups with a handful of instances to enterprise environments with many thousands of instances.</p>
<p>Ansible manages machines in an agent-less manner. There is never a question of how to
upgrade remote daemons or the problem of not being able to manage systems because daemons are uninstalled.  Because OpenSSH is one of the most peer-reviewed open source components, security exposure is greatly reduced. Ansible is decentralized&#8211;it relies on your existing OS credentials to control access to remote machines. If needed, Ansible can easily connect with Kerberos, LDAP, and other centralized authentication management systems.</p>
<p>This documentation covers the current released version of Ansible (2.4) and also some development version features (&#8216;devel&#8217;).  For recent features, we note in each section the version of Ansible where the feature was added.</p>
<p>Ansible, Inc. releases a new major release of Ansible approximately every two months.  The core application evolves somewhat conservatively, valuing simplicity in language design and setup. However, the community around new modules and plugins being developed and contributed moves very quickly, typically adding 20 or so new modules in each release.</p>
<div class="toctree-wrapper compound">
<span id="document-intro"></span><div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>Before we start exploring the main components of Ansible &#8211; playbooks, configuration management, deployment, and orchestration &#8211; we&#8217;ll learn how to get Ansible installed and cover some basic concepts.  We&#8217;ll also go over how to execute ad-hoc commands in parallel across your nodes using /usr/bin/ansible, and see what modules are available in Ansible&#8217;s core (you can also write your own, which is covered later).</p>
<div class="toctree-wrapper compound">
<span id="document-intro_installation"></span><div class="section" id="installation">
<h4><a class="toc-backref" href="#id8">Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#installation" id="id8">Installation</a><ul>
<li><a class="reference internal" href="#basics-what-will-be-installed" id="id9">Basics / What Will Be Installed</a></li>
<li><a class="reference internal" href="#what-version-to-pick" id="id10">What Version To Pick?</a></li>
<li><a class="reference internal" href="#control-machine-requirements" id="id11">Control Machine Requirements</a></li>
<li><a class="reference internal" href="#managed-node-requirements" id="id12">Managed Node Requirements</a></li>
<li><a class="reference internal" href="#installing-the-control-machine" id="id13">Installing the Control Machine</a><ul>
<li><a class="reference internal" href="#latest-release-via-yum" id="id14">Latest Release Via Yum</a></li>
<li><a class="reference internal" href="#latest-releases-via-apt-ubuntu" id="id15">Latest Releases Via Apt (Ubuntu)</a></li>
<li><a class="reference internal" href="#latest-releases-via-apt-debian" id="id16">Latest Releases Via Apt (Debian)</a></li>
<li><a class="reference internal" href="#latest-releases-via-portage-gentoo" id="id17">Latest Releases Via Portage (Gentoo)</a></li>
<li><a class="reference internal" href="#latest-releases-via-pkg-freebsd" id="id18">Latest Releases Via pkg (FreeBSD)</a></li>
<li><a class="reference internal" href="#latest-releases-on-mac-osx" id="id19">Latest Releases on Mac OSX</a></li>
<li><a class="reference internal" href="#latest-releases-via-opencsw-solaris" id="id20">Latest Releases Via OpenCSW (Solaris)</a></li>
<li><a class="reference internal" href="#latest-releases-via-pacman-arch-linux" id="id21">Latest Releases Via Pacman (Arch Linux)</a></li>
<li><a class="reference internal" href="#latest-releases-via-pip" id="id22">Latest Releases Via Pip</a></li>
<li><a class="reference internal" href="#tarballs-of-tagged-releases" id="id23">Tarballs of Tagged Releases</a></li>
<li><a class="reference internal" href="#running-from-source" id="id24">Running From Source</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ansible-on-github" id="id25">Ansible on GitHub</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="basics-what-will-be-installed">
<span id="what-will-be-installed"></span><h5><a class="toc-backref" href="#id9">Basics / What Will Be Installed</a><a class="headerlink" href="#basics-what-will-be-installed" title="Permalink to this headline">¶</a></h5>
<p>Ansible by default manages machines over the SSH protocol.</p>
<p>Once Ansible is installed, it will not add a database, and there will be no daemons to start or keep running.  You only need to install it on one machine (which could easily be a laptop) and it can manage an entire fleet of remote machines from that central point.  When Ansible manages remote machines, it does not leave software installed or running on them, so there&#8217;s no real question about how to upgrade Ansible when moving to a new version.</p>
</div>
<div class="section" id="what-version-to-pick">
<span id="what-version"></span><h5><a class="toc-backref" href="#id10">What Version To Pick?</a><a class="headerlink" href="#what-version-to-pick" title="Permalink to this headline">¶</a></h5>
<p>Because it runs so easily from source and does not require any installation of software on remote
machines, many users will actually track the development version.</p>
<p>Ansible&#8217;s release cycles are usually about four months long. Due to this short release cycle,
minor bugs will generally be fixed in the next release versus maintaining backports on the stable branch.
Major bugs will still have maintenance releases when needed, though these are infrequent.</p>
<p>If you are wishing to run the latest released version of Ansible and you are running Red Hat Enterprise Linux (TM), CentOS, Fedora, Debian, or Ubuntu, we recommend using the OS package manager.</p>
<p>For other installation options, we recommend installing via &#8220;pip&#8221;, which is the Python package manager, though other options are also available.</p>
<p>If you wish to track the development release to use and test the latest features, we will share
information about running from source.  It&#8217;s not necessary to install the program to run from source.</p>
</div>
<div class="section" id="control-machine-requirements">
<span id="id1"></span><h5><a class="toc-backref" href="#id11">Control Machine Requirements</a><a class="headerlink" href="#control-machine-requirements" title="Permalink to this headline">¶</a></h5>
<p>Currently Ansible can be run from any machine with Python 2 (versions 2.6 or 2.7) or Python 3 (versions 3.5 and higher) installed (Windows isn&#8217;t supported for the control machine).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible 2.2 introduces a tech preview of support for Python 3 (versions 3.5 and higher). For more information, see <a class="reference external" href="http://docs.ansible.com/ansible/python_3_support.html">Python 3 Support</a>.</p>
</div>
<p>This includes Red Hat, Debian, CentOS, OS X, any of the BSDs, and so on.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As of version 2.0, Ansible uses a few more file handles to manage its forks. Mac OS X by default is configured for a small amount of file handles, so if you want to use 15 or more forks you&#8217;ll need to raise the ulimit with <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">launchctl</span> <span class="pre">limit</span> <span class="pre">maxfiles</span> <span class="pre">unlimited</span></code>. This command can also fix any &#8220;Too many open files&#8221; error.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Please note that some modules and plugins have additional requirements. For modules these need to be satisfied on the &#8216;target&#8217; machine and should be listed in the module specific docs.</p>
</div>
</div>
<div class="section" id="managed-node-requirements">
<span id="id2"></span><h5><a class="toc-backref" href="#id12">Managed Node Requirements</a><a class="headerlink" href="#managed-node-requirements" title="Permalink to this headline">¶</a></h5>
<p>On the managed nodes, you need a way to communicate, which is normally ssh. By
default this uses sftp. If that&#8217;s not available, you can switch to scp in
<code class="file docutils literal"><span class="pre">ansible.cfg</span></code>.  You also need Python 2.6 or later.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible&#8217;s &#8220;raw&#8221; module (for executing commands in a quick and dirty
way) and the script module don&#8217;t even need that.  So technically, you can use
Ansible to install python-simplejson using the raw module, which
then allows you to use everything else.  (That&#8217;s jumping ahead
though.)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have SELinux enabled on remote nodes, you will also want to install
libselinux-python on them before using any copy/file/template related functions in
Ansible. You can of course still use the yum module in Ansible to install this package on
remote systems that do not have it.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Ansible 2.2 introduces a tech preview of support for Python 3. For more information, see <a class="reference external" href="http://docs.ansible.com/ansible/python_3_support.html">Python 3 Support</a>.</p>
<p>By default, Ansible uses Python 2 in order to maintain compatibility with older distributions
such as RHEL 6. However, some Linux distributions (Gentoo, Arch) may not have a
Python 2.X interpreter installed by default.  On those systems, you should install one, and set
the &#8216;ansible_python_interpreter&#8217; variable in inventory (see <a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a>) to point at your 2.X Python.  Distributions
like Red Hat Enterprise Linux, CentOS, Fedora, and Ubuntu all have a 2.X interpreter installed
by default and this does not apply to those distributions.  This is also true of nearly all
Unix systems.</p>
<p class="last">If you need to bootstrap these remote systems by installing Python 2.X,
using the &#8216;raw&#8217; module will be able to do it remotely. For example,
<code class="docutils literal"><span class="pre">ansible</span> <span class="pre">myhost</span> <span class="pre">--sudo</span> <span class="pre">-m</span> <span class="pre">raw</span> <span class="pre">-a</span> <span class="pre">&quot;yum</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">python2</span> <span class="pre">python-simplejson&quot;</span></code>
would install Python 2.X and the simplejson module needed to run ansible and its modules.</p>
</div>
</div>
<div class="section" id="installing-the-control-machine">
<span id="id4"></span><h5><a class="toc-backref" href="#id13">Installing the Control Machine</a><a class="headerlink" href="#installing-the-control-machine" title="Permalink to this headline">¶</a></h5>
<div class="section" id="latest-release-via-yum">
<span id="from-yum"></span><h6><a class="toc-backref" href="#id14">Latest Release Via Yum</a><a class="headerlink" href="#latest-release-via-yum" title="Permalink to this headline">¶</a></h6>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We’ve changed how the Ansible community packages are distributed.
For users of RHEL/CentOS/Scientific Linux version 7, the Ansible community RPM
package will transition from the EPEL repository to the Extras channel.  There will be no
change for version 6 of RHEL/CentOS/Scientific Linux since Extras is not a part of version 6.</p>
</div>
<p>RPMs for RHEL7 are available from <a class="reference external" href="https://access.redhat.com/solutions/912213">the Extras channel</a>.</p>
<p>RPMs for RHEL6 are available from yum for <a class="reference external" href="http://fedoraproject.org/wiki/EPEL">EPEL</a> 6 and currently supported
Fedora distributions.</p>
<p>Ansible will also have RPMs/YUM-repo available at <cite>&lt;https://releases.ansible.com/ansible/rpms/</cite>.</p>
<p>Ansible version 2.4 can manage earlier operating
systems that contain Python 2.6 or higher.</p>
<p>You can also build an RPM yourself.  From the root of a checkout or tarball, use the <code class="docutils literal"><span class="pre">make</span> <span class="pre">rpm</span></code> command to build an RPM you can distribute and install.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git clone git://github.com/ansible/ansible.git
$ <span class="nb">cd</span> ./ansible
$ make rpm
$ sudo rpm -Uvh ./rpm-build/ansible-*.noarch.rpm
</pre></div>
</div>
</div>
<div class="section" id="latest-releases-via-apt-ubuntu">
<span id="from-apt"></span><h6><a class="toc-backref" href="#id15">Latest Releases Via Apt (Ubuntu)</a><a class="headerlink" href="#latest-releases-via-apt-ubuntu" title="Permalink to this headline">¶</a></h6>
<p>Ubuntu builds are available <a class="reference external" href="https://launchpad.net/~ansible/+archive/ansible">in a PPA here</a>.</p>
<p>To configure the PPA on your machine and install ansible run these commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo apt-get update
$ sudo apt-get install software-properties-common
$ sudo apt-add-repository ppa:ansible/ansible
$ sudo apt-get update
$ sudo apt-get install ansible
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On older Ubuntu distributions, &#8220;software-properties-common&#8221; is called &#8220;python-software-properties&#8221;.</p>
</div>
<p>Debian/Ubuntu packages can also be built from the source checkout, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ make deb
</pre></div>
</div>
<p>You may also wish to run from source to get the latest, which is covered above.</p>
</div>
<div class="section" id="latest-releases-via-apt-debian">
<h6><a class="toc-backref" href="#id16">Latest Releases Via Apt (Debian)</a><a class="headerlink" href="#latest-releases-via-apt-debian" title="Permalink to this headline">¶</a></h6>
<p>Debian users may leverage the same source as the Ubuntu PPA.</p>
<p>Add the following line to /etc/apt/sources.list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main
</pre></div>
</div>
<p>Then run these commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 93C4A3FD7BB9C367
$ sudo apt-get update
$ sudo apt-get install ansible
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method has been verified with the Trusty sources in Debian Jessie and Stretch but may not be supported in earlier versions.</p>
</div>
</div>
<div class="section" id="latest-releases-via-portage-gentoo">
<h6><a class="toc-backref" href="#id17">Latest Releases Via Portage (Gentoo)</a><a class="headerlink" href="#latest-releases-via-portage-gentoo" title="Permalink to this headline">¶</a></h6>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ emerge -av app-admin/ansible
</pre></div>
</div>
<p>To install the newest version, you may need to unmask the ansible package prior to emerging:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;app-admin/ansible&#39;</span> &gt;&gt; /etc/portage/package.accept_keywords
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have Python 3 as a default Python slot on your Gentoo nodes (default setting), then you
must set <code class="docutils literal"><span class="pre">ansible_python_interpreter</span> <span class="pre">=</span> <span class="pre">/usr/bin/python2</span></code> in your group or inventory variables.</p>
</div>
</div>
<div class="section" id="latest-releases-via-pkg-freebsd">
<h6><a class="toc-backref" href="#id18">Latest Releases Via pkg (FreeBSD)</a><a class="headerlink" href="#latest-releases-via-pkg-freebsd" title="Permalink to this headline">¶</a></h6>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo pkg install ansible
</pre></div>
</div>
<p>You may also wish to install from ports, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo make -C /usr/ports/sysutils/ansible install
</pre></div>
</div>
</div>
<div class="section" id="latest-releases-on-mac-osx">
<span id="on-macos"></span><h6><a class="toc-backref" href="#id19">Latest Releases on Mac OSX</a><a class="headerlink" href="#latest-releases-on-mac-osx" title="Permalink to this headline">¶</a></h6>
<p>The preferred way to install ansible on a Mac is via pip.</p>
<p>The instructions can be found in <a class="reference internal" href="#latest-releases-via-pip">Latest Releases Via Pip</a> section.</p>
</div>
<div class="section" id="latest-releases-via-opencsw-solaris">
<span id="from-pkgutil"></span><h6><a class="toc-backref" href="#id20">Latest Releases Via OpenCSW (Solaris)</a><a class="headerlink" href="#latest-releases-via-opencsw-solaris" title="Permalink to this headline">¶</a></h6>
<p>Ansible is available for Solaris as <a class="reference external" href="https://www.opencsw.org/packages/ansible/">SysV package from OpenCSW</a>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># pkgadd -d http://get.opencsw.org/now</span>
<span class="c1"># /opt/csw/bin/pkgutil -i ansible</span>
</pre></div>
</div>
</div>
<div class="section" id="latest-releases-via-pacman-arch-linux">
<span id="from-pacman"></span><h6><a class="toc-backref" href="#id21">Latest Releases Via Pacman (Arch Linux)</a><a class="headerlink" href="#latest-releases-via-pacman-arch-linux" title="Permalink to this headline">¶</a></h6>
<p>Ansible is available in the Community repository:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ pacman -S ansible</span>
</pre></div>
</div>
<p>The AUR has a PKGBUILD for pulling directly from Github called <a class="reference external" href="https://aur.archlinux.org/packages/ansible-git">ansible-git</a>.</p>
<p>Also see the <a class="reference external" href="https://wiki.archlinux.org/index.php/Ansible">Ansible</a> page on the ArchWiki.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have Python 3 as a default Python slot on your Arch nodes (default setting), then you
must set <code class="docutils literal"><span class="pre">ansible_python_interpreter</span> <span class="pre">=</span> <span class="pre">/usr/bin/python2</span></code> in your group or inventory variables.</p>
</div>
</div>
<div class="section" id="latest-releases-via-pip">
<span id="from-pip"></span><h6><a class="toc-backref" href="#id22">Latest Releases Via Pip</a><a class="headerlink" href="#latest-releases-via-pip" title="Permalink to this headline">¶</a></h6>
<p>Ansible can be installed via &#8220;pip&#8221;, the Python package manager.  If &#8216;pip&#8217; isn&#8217;t already available in
your version of Python, you can get pip by:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ sudo easy_install pip</span>
</pre></div>
</div>
<p>Then install Ansible with <a class="footnote-reference" href="#id7" id="id5">[1]</a>:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ sudo pip install ansible</span>
</pre></div>
</div>
<p>Or if you are looking for the latest development version:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">pip install git+git://github.com/ansible/ansible.git@devel</span>
</pre></div>
</div>
<p>If you are installing on OS X Mavericks, you may encounter some noise from your compiler.  A workaround is to do the following:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ sudo CFLAGS=-Qunused-arguments CPPFLAGS=-Qunused-arguments pip install ansible</span>
</pre></div>
</div>
<p>Readers that use virtualenv can also install Ansible under virtualenv, though we&#8217;d recommend to not worry about it and just install Ansible globally.  Do not use easy_install to install ansible directly.</p>
</div>
<div class="section" id="tarballs-of-tagged-releases">
<span id="tagged-releases"></span><h6><a class="toc-backref" href="#id23">Tarballs of Tagged Releases</a><a class="headerlink" href="#tarballs-of-tagged-releases" title="Permalink to this headline">¶</a></h6>
<p>Packaging Ansible or wanting to build a local package yourself, but don&#8217;t want to do a git checkout?  Tarballs of releases are available on the <a class="reference external" href="http://releases.ansible.com/ansible">Ansible downloads</a> page.</p>
<p>These releases are also tagged in the <a class="reference external" href="https://github.com/ansible/ansible/releases">git repository</a> with the release version.</p>
</div>
<div class="section" id="running-from-source">
<span id="from-source"></span><h6><a class="toc-backref" href="#id24">Running From Source</a><a class="headerlink" href="#running-from-source" title="Permalink to this headline">¶</a></h6>
<p>Ansible is easy to run from a checkout - root permissions are not required
to use it and there is no software to actually install.  No daemons
or database setup are required.  Because of this, many users in our community use the
development version of Ansible all of the time so they can take advantage of new features
when they are implemented and easily contribute to the project. Because there is
nothing to install, following the development version is significantly easier than most
open source projects.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are intending to use Tower as the Control Machine, do not use a source install. Please use OS package manager (like <code class="docutils literal"><span class="pre">apt/yum</span></code>) or <code class="docutils literal"><span class="pre">pip</span></code> to install a stable version.</p>
</div>
<p>To install from source, clone the Ansible git repository:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git clone git://github.com/ansible/ansible.git --recursive
$ <span class="nb">cd</span> ./ansible
</pre></div>
</div>
<p>Once git has cloned the Ansible repository, setup the Ansible environment:</p>
<p>Using Bash:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> ./hacking/env-setup
</pre></div>
</div>
<p>Using Fish:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ . ./hacking/env-setup.fish</span>
</pre></div>
</div>
<p>If you want to suppress spurious warnings/errors, use:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ source ./hacking/env-setup -q</span>
</pre></div>
</div>
<p>If you don&#8217;t have pip installed in your version of Python, install pip:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ sudo easy_install pip</span>
</pre></div>
</div>
<p>Ansible also uses the following Python modules that need to be installed <a class="footnote-reference" href="#id7" id="id6">[1]</a>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo pip install -r ./requirements.txt
</pre></div>
</div>
<p>To update ansible checkouts, use pull-with-rebase so any local changes are replayed.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git pull --rebase
</pre></div>
</div>
<p>Note: when updating ansible checkouts that are v2.2 and older, be sure to not
only update the source tree, but also the &#8220;submodules&#8221; in git which point at
Ansible&#8217;s own modules.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git pull --rebase <span class="c1">#same as above</span>
$ git submodule update --init --recursive
</pre></div>
</div>
<p>Once running the env-setup script you&#8217;ll be running from checkout and the default inventory file
will be /etc/ansible/hosts.  You can optionally specify an inventory file (see <a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a>)
other than /etc/ansible/hosts:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="s2">&quot;127.0.0.1&quot;</span> &gt; ~/ansible_hosts
$ <span class="nb">export</span> <span class="nv">ANSIBLE_INVENTORY</span><span class="o">=</span>~/ansible_hosts
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ANSIBLE_INVENTORY is available starting at 1.9 and substitutes the deprecated ANSIBLE_HOSTS</p>
</div>
<p>You can read more about the inventory file in later parts of the manual.</p>
<p>Now let&#8217;s test things with a ping command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -m ping --ask-pass
</pre></div>
</div>
<p>You can also use &#8220;sudo make install&#8221;.</p>
</div>
</div>
<div class="section" id="ansible-on-github">
<span id="getting-ansible"></span><h5><a class="toc-backref" href="#id25">Ansible on GitHub</a><a class="headerlink" href="#ansible-on-github" title="Permalink to this headline">¶</a></h5>
<p>You may also wish to follow the <a class="reference external" href="https://github.com/ansible/ansible">GitHub project</a> if
you have a GitHub account.  This is also where we keep the issue tracker for sharing
bugs and feature ideas.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Learning ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id5">1</a>, <a class="fn-backref" href="#id6">2</a>)</em> If you have issues with the &#8220;pycrypto&#8221; package install on Mac OSX, then you may need to try <code class="docutils literal"><span class="pre">CC=clang</span> <span class="pre">sudo</span> <span class="pre">-E</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">pycrypto</span></code>.</td></tr>
</tbody>
</table>
</div>
</div>
<span id="document-intro_getting_started"></span><div class="section" id="getting-started">
<h4><a class="toc-backref" href="#id3">Getting Started</a><a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#getting-started" id="id3">Getting Started</a><ul>
<li><a class="reference internal" href="#foreword" id="id4">Foreword</a></li>
<li><a class="reference internal" href="#remote-connection-information" id="id5">Remote Connection Information</a></li>
<li><a class="reference internal" href="#your-first-commands" id="id6">Your first commands</a></li>
<li><a class="reference internal" href="#host-key-checking" id="id7">Host Key Checking</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="foreword">
<span id="gs-about"></span><h5><a class="toc-backref" href="#id4">Foreword</a><a class="headerlink" href="#foreword" title="Permalink to this headline">¶</a></h5>
<p>Now that you&#8217;ve read <a class="reference internal" href="index.html#document-intro_installation"><span class="doc">Installation</span></a> and installed Ansible, it&#8217;s time to get
started with some ad-hoc commands.</p>
<p>What we are showing first are not the powerful configuration/deployment/orchestration features of Ansible.
These features are handled by playbooks which are covered in a separate section.</p>
<p>This section is about how to initially get Ansible running.  Once you understand these concepts, read <a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a> for some more detail, and then you&#8217;ll be ready to begin learning about playbooks and explore the most interesting parts!</p>
</div>
<div class="section" id="remote-connection-information">
<span id="id1"></span><h5><a class="toc-backref" href="#id5">Remote Connection Information</a><a class="headerlink" href="#remote-connection-information" title="Permalink to this headline">¶</a></h5>
<p>Before we get started, it&#8217;s important to understand how Ansible communicates with remote
machines over SSH.</p>
<p>By default, Ansible 1.3 and later will try to use native
OpenSSH for remote communication when possible.  This enables ControlPersist (a performance feature), Kerberos, and options in <code class="docutils literal"><span class="pre">~/.ssh/config</span></code> such as Jump Host setup.  However, when using Enterprise Linux 6 operating systems as the control machine (Red Hat Enterprise Linux and derivatives such as CentOS), the version of OpenSSH may be too old to support ControlPersist. On these operating systems, Ansible will fallback into using a high-quality Python implementation of
OpenSSH called &#8216;paramiko&#8217;.  If you wish to use features like Kerberized SSH and more, consider using Fedora, OS X, or Ubuntu as your control machine until a newer version of OpenSSH is available for your platform &#8211; or engage &#8216;accelerated mode&#8217; in Ansible.  See <a class="reference internal" href="index.html#document-playbooks_acceleration"><span class="doc">Accelerated Mode</span></a>.</p>
<p>In releases up to and including Ansible 1.2, the default was strictly paramiko.  Native SSH had to be explicitly selected with the <code class="docutils literal"><span class="pre">-c</span></code> ssh option or set in the configuration file.</p>
<p>Occasionally you&#8217;ll encounter a device that doesn&#8217;t support SFTP. This is rare, but should it occur, you can switch to SCP mode in <a class="reference internal" href="index.html#document-intro_configuration"><span class="doc">Configuration file</span></a>.</p>
<p>When speaking with remote machines, Ansible by default assumes you are using SSH keys.  SSH keys are encouraged but password authentication can also be used where needed by supplying the option <code class="docutils literal"><span class="pre">--ask-pass</span></code>.  If using sudo features and when sudo requires a password, also supply <code class="docutils literal"><span class="pre">--ask-become-pass</span></code> (previously <code class="docutils literal"><span class="pre">--ask-sudo-pass</span></code> which has been deprecated).</p>
<p>While it may be common sense, it is worth sharing: Any management system benefits from being run near the machines being managed. If you are running Ansible in a cloud, consider running it from a machine inside that cloud.  In most cases this will work better than on the open Internet.</p>
<p>As an advanced topic, Ansible doesn&#8217;t just have to connect remotely over SSH.  The transports are pluggable, and there are options for managing things locally, as well as managing chroot, lxc, and jail containers.  A mode called &#8216;ansible-pull&#8217; can also invert the system and have systems &#8216;phone home&#8217; via scheduled git checkouts to pull configuration directives from a central repository.</p>
</div>
<div class="section" id="your-first-commands">
<span id="id2"></span><h5><a class="toc-backref" href="#id6">Your first commands</a><a class="headerlink" href="#your-first-commands" title="Permalink to this headline">¶</a></h5>
<p>Now that you&#8217;ve installed Ansible, it&#8217;s time to get started with some basics.</p>
<p>Edit (or create) <code class="docutils literal"><span class="pre">/etc/ansible/hosts</span></code> and put one or more remote systems in it. Your
public SSH key should be located in <code class="docutils literal"><span class="pre">authorized_keys</span></code> on those systems:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">192.0.2.50</span>
<span class="l l-Scalar l-Scalar-Plain">aserver.example.org</span>
<span class="l l-Scalar l-Scalar-Plain">bserver.example.org</span>
</pre></div>
</div>
<p>This is an inventory file, which is also explained in greater depth here:  <a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a>.</p>
<p>We&#8217;ll assume you are using SSH keys for authentication.  To set up SSH agent to avoid retyping passwords, you can
do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ssh-agent bash
$ ssh-add ~/.ssh/id_rsa
</pre></div>
</div>
<p>(Depending on your setup, you may wish to use Ansible&#8217;s <code class="docutils literal"><span class="pre">--private-key</span></code> option to specify a pem file instead)</p>
<p>Now ping all your nodes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -m ping
</pre></div>
</div>
<p>Ansible will attempt to remote connect to the machines using your current
user name, just like SSH would.  To override the remote user name, just use the &#8216;-u&#8217; parameter.</p>
<p>If you would like to access sudo mode, there are also flags to do that:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># as bruce</span>
$ ansible all -m ping -u bruce
<span class="c1"># as bruce, sudoing to root</span>
$ ansible all -m ping -u bruce --sudo
<span class="c1"># as bruce, sudoing to batman</span>
$ ansible all -m ping -u bruce --sudo --sudo-user batman

<span class="c1"># With latest version of ansible `sudo` is deprecated so use become</span>
<span class="c1"># as bruce, sudoing to root</span>
$ ansible all -m ping -u bruce -b
<span class="c1"># as bruce, sudoing to batman</span>
$ ansible all -m ping -u bruce -b --become-user batman
</pre></div>
</div>
<p>(The sudo implementation is changeable in Ansible&#8217;s configuration file if you happen to want to use a sudo
replacement.  Flags passed to sudo (like -H) can also be set there.)</p>
<p>Now run a live command on all of your nodes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -a <span class="s2">&quot;/bin/echo hello&quot;</span>
</pre></div>
</div>
<p>Congratulations!  You&#8217;ve just contacted your nodes with Ansible.  It&#8217;s
soon going to be time to: read about some more real-world cases in <a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a>,
explore what you can do with different modules, and to learn about the Ansible
<a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a> language.  Ansible is not just about running commands, it
also has powerful configuration management and deployment features.  There&#8217;s more to
explore, but you already have a fully working infrastructure!</p>
<p>Tips</p>
<p>When running commands, you can specify the local server by using &#8220;localhost&#8221; or &#8220;127.0.0.1&#8221; for the server name.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible localhost -m ping -e <span class="s1">&#39;ansible_python_interpreter=&quot;/usr/bin/env python&quot;&#39;</span>
</pre></div>
</div>
<p>You can specify localhost explicitly by adding this to your inventory file:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">localhost ansible_connection=local ansible_python_interpreter=&quot;/usr/bin/env python&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="host-key-checking">
<span id="a-note-about-host-key-checking"></span><h5><a class="toc-backref" href="#id7">Host Key Checking</a><a class="headerlink" href="#host-key-checking" title="Permalink to this headline">¶</a></h5>
<p>Ansible 1.2.1 and later have host key checking enabled by default.</p>
<p>If a host is reinstalled and has a different key in &#8216;known_hosts&#8217;, this will result in an error message until corrected.  If a host is not initially in &#8216;known_hosts&#8217; this will result in prompting for confirmation of the key, which results in an interactive experience if using Ansible, from say, cron.  You might not want this.</p>
<p>If you understand the implications and wish to disable this behavior, you can do so by editing <code class="docutils literal"><span class="pre">/etc/ansible/ansible.cfg</span></code> or <code class="docutils literal"><span class="pre">~/.ansible.cfg</span></code>:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">defaults</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">host_key_checking = False</span>
</pre></div>
</div>
<p>Alternatively this can be set by the <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_HOST_KEY_CHECKING</span></code> environment variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span>False
</pre></div>
</div>
<p>Also note that host key checking in paramiko mode is reasonably slow, therefore switching to &#8216;ssh&#8217; is also recommended when using this feature.</p>
<p id="a-note-about-logging">Ansible will log some information about module arguments on the remote system in the remote syslog, unless a task or play is marked with a &#8220;no_log: True&#8221; attribute. This is explained later.</p>
<p>To enable basic logging on the control machine see <a class="reference internal" href="index.html#document-intro_configuration"><span class="doc">Configuration file</span></a> document and set the &#8216;log_path&#8217; configuration file setting.  Enterprise users may also be interested in <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a>.  Tower provides a very robust database logging feature where it is possible to drill down and see history based on hosts, projects, and particular inventories over time &#8211; explorable both graphically and through a REST API.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a></dt>
<dd>More information about inventory</dd>
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Learning Ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-intro_inventory"></span><div class="section" id="inventory">
<span id="id1"></span><h4><a class="toc-backref" href="#id5">Inventory</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#inventory" id="id5">Inventory</a><ul>
<li><a class="reference internal" href="#hosts-and-groups" id="id6">Hosts and Groups</a></li>
<li><a class="reference internal" href="#host-variables" id="id7">Host Variables</a></li>
<li><a class="reference internal" href="#group-variables" id="id8">Group Variables</a></li>
<li><a class="reference internal" href="#groups-of-groups-and-group-variables" id="id9">Groups of Groups, and Group Variables</a></li>
<li><a class="reference internal" href="#default-groups" id="id10">Default groups</a></li>
<li><a class="reference internal" href="#splitting-out-host-and-group-specific-data" id="id11">Splitting Out Host and Group Specific Data</a></li>
<li><a class="reference internal" href="#list-of-behavioral-inventory-parameters" id="id12">List of Behavioral Inventory Parameters</a></li>
<li><a class="reference internal" href="#non-ssh-connection-types" id="id13">Non-SSH connection types</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible works against multiple systems in your infrastructure at the same time.
It does this by selecting portions of systems listed in Ansible&#8217;s inventory,
which defaults to being saved in the location <code class="docutils literal"><span class="pre">/etc/ansible/hosts</span></code>.
You can specify a different inventory file using the <code class="docutils literal"><span class="pre">-i</span> <span class="pre">&lt;path&gt;</span></code> option on the command line.</p>
<p>Not only is this inventory configurable, but you can also use multiple inventory files at the same time and
pull inventory from dynamic or cloud sources or different formats (YAML, ini, etc), as described in <a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a>.
Introduced in version 2.4, Ansible has inventory plugins to make this flexible and customizable.</p>
<div class="section" id="hosts-and-groups">
<span id="inventoryformat"></span><h5><a class="toc-backref" href="#id6">Hosts and Groups</a><a class="headerlink" href="#hosts-and-groups" title="Permalink to this headline">¶</a></h5>
<p>The inventory file can be in one of many formats, depending on the inventory plugins you have.
For this example, the format for <code class="docutils literal"><span class="pre">/etc/ansible/hosts</span></code> is an INI-like (one of Ansible&#8217;s defaults) and looks like this:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">mail.example.com</span>

<span class="k">[webservers]</span>
<span class="na">foo.example.com</span>
<span class="na">bar.example.com</span>

<span class="k">[dbservers]</span>
<span class="na">one.example.com</span>
<span class="na">two.example.com</span>
<span class="na">three.example.com</span>
</pre></div>
</div>
<p>The headings in brackets are group names, which are used in classifying systems
and deciding what systems you are controlling at what times and for what purpose.</p>
<p>A YAML version would look like:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">mail.example.com</span>
  <span class="l l-Scalar l-Scalar-Plain">children</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">webservers</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">foo.example.com</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">bar.example.com</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">dbservers</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">one.example.com</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">two.example.com</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">three.example.com</span><span class="p p-Indicator">:</span>
</pre></div>
</div>
<p>It is ok to put systems in more than one group, for instance a server could be both a webserver and a dbserver.
If you do, note that variables will come from all of the groups they are a member of. Variable precedence is detailed in a later chapter.</p>
<p>If you have hosts that run on non-standard SSH ports you can put the port number after the hostname with a colon.
Ports listed in your SSH config file won&#8217;t be used with the <cite>paramiko</cite> connection but will be used with the <cite>openssh</cite> connection.</p>
<p>To make things explicit, it is suggested that you set them if things are not running on the default port:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">badwolf.example.com:5309</span>
</pre></div>
</div>
<p>Suppose you have just static IPs and want to set up some aliases that live in your host file, or you are connecting through tunnels.
You can also describe hosts via variables:</p>
<p>In INI:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">jumper ansible_port</span><span class="o">=</span><span class="s">5555 ansible_host=192.0.2.50</span>
</pre></div>
</div>
<p>In YAML:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">jumper</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ansible_port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5555</span>
    <span class="l l-Scalar l-Scalar-Plain">ansible_host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.0.2.50</span>
</pre></div>
</div>
<p>In the above example, trying to ansible against the host alias &#8220;jumper&#8221; (which may not even be a real hostname) will contact 192.0.2.50 on port 5555.
Note that this is using a feature of the inventory file to define some special variables.
Generally speaking, this is not the best way to define variables that describe your system policy, but we&#8217;ll share suggestions on doing this later.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Values passed in the INI format using the <code class="docutils literal"><span class="pre">key=value</span></code> syntax are not interpreted as Python literal structure
(strings, numbers, tuples, lists, dicts, booleans, None), but as a string. For example <code class="docutils literal"><span class="pre">var=FALSE</span></code> would create a string equal to &#8216;FALSE&#8217;.
Do not rely on types set during definition, always make sure you specify type with a filter when needed when consuming the variable.</p>
</div>
<p>If you are adding a lot of hosts following similar patterns, you can do this rather than listing each hostname:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[webservers]</span>
<span class="na">www[01:50].example.com</span>
</pre></div>
</div>
<p>For numeric patterns, leading zeros can be included or removed, as desired. Ranges are inclusive.  You can also define alphabetic ranges:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[databases]</span>
<span class="na">db-[a:f].example.com</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible 2.0 has deprecated the “ssh” from <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code>, <code class="docutils literal"><span class="pre">ansible_ssh_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_ssh_port</span></code> to become <code class="docutils literal"><span class="pre">ansible_user</span></code>, <code class="docutils literal"><span class="pre">ansible_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_port</span></code>. If you are using a version of Ansible prior to 2.0,  you should continue using the older style variables (<code class="docutils literal"><span class="pre">ansible_ssh_*</span></code>). These shorter variables are ignored, without warning, in older versions of Ansible.</p>
</div>
<p>You can also select the connection type and user on a per host basis:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[targets]</span>

<span class="na">localhost              ansible_connection</span><span class="o">=</span><span class="s">local</span>
<span class="na">other1.example.com     ansible_connection</span><span class="o">=</span><span class="s">ssh        ansible_user=mpdehaan</span>
<span class="na">other2.example.com     ansible_connection</span><span class="o">=</span><span class="s">ssh        ansible_user=mdehaan</span>
</pre></div>
</div>
<p>As mentioned above, setting these in the inventory file is only a shorthand, and we&#8217;ll discuss how to store them in individual files in the &#8216;host_vars&#8217; directory a bit later on.</p>
</div>
<div class="section" id="host-variables">
<span id="id2"></span><h5><a class="toc-backref" href="#id7">Host Variables</a><a class="headerlink" href="#host-variables" title="Permalink to this headline">¶</a></h5>
<p>As described above, it is easy to assign variables to hosts that will be used later in playbooks:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[atlanta]</span>
<span class="na">host1 http_port</span><span class="o">=</span><span class="s">80 maxRequestsPerChild=808</span>
<span class="na">host2 http_port</span><span class="o">=</span><span class="s">303 maxRequestsPerChild=909</span>
</pre></div>
</div>
</div>
<div class="section" id="group-variables">
<span id="id3"></span><h5><a class="toc-backref" href="#id8">Group Variables</a><a class="headerlink" href="#group-variables" title="Permalink to this headline">¶</a></h5>
<p>Variables can also be applied to an entire group at once:</p>
<p>The INI way:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[atlanta]</span>
<span class="na">host1</span>
<span class="na">host2</span>

<span class="k">[atlanta:vars]</span>
<span class="na">ntp_server</span><span class="o">=</span><span class="s">ntp.atlanta.example.com</span>
<span class="na">proxy</span><span class="o">=</span><span class="s">proxy.atlanta.example.com</span>
</pre></div>
</div>
<p>The YAML version:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">atlanta</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">host1</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">host2</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ntp_server</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ntp.atlanta.example.com</span>
    <span class="l l-Scalar l-Scalar-Plain">proxy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">proxy.atlanta.example.com</span>
</pre></div>
</div>
<p>Be aware that this is only a convenient way to apply variables to multiple hosts at once; even though you can target hosts by group, <strong>variables are always flattened to the host level</strong> before a play is executed.</p>
</div>
<div class="section" id="groups-of-groups-and-group-variables">
<span id="subgroups"></span><h5><a class="toc-backref" href="#id9">Groups of Groups, and Group Variables</a><a class="headerlink" href="#groups-of-groups-and-group-variables" title="Permalink to this headline">¶</a></h5>
<p>It is also possible to make groups of groups using the <code class="docutils literal"><span class="pre">:children</span></code> suffix in INI or the <code class="docutils literal"><span class="pre">children:</span></code> entry in YAML.
You can apply variables using <code class="docutils literal"><span class="pre">:vars</span></code> or <code class="docutils literal"><span class="pre">vars:</span></code>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[atlanta]</span>
<span class="na">host1</span>
<span class="na">host2</span>

<span class="k">[raleigh]</span>
<span class="na">host2</span>
<span class="na">host3</span>

<span class="k">[southeast:children]</span>
<span class="na">atlanta</span>
<span class="na">raleigh</span>

<span class="k">[southeast:vars]</span>
<span class="na">some_server</span><span class="o">=</span><span class="s">foo.southeast.example.com</span>
<span class="na">halon_system_timeout</span><span class="o">=</span><span class="s">30</span>
<span class="na">self_destruct_countdown</span><span class="o">=</span><span class="s">60</span>
<span class="na">escape_pods</span><span class="o">=</span><span class="s">2</span>

<span class="k">[usa:children]</span>
<span class="na">southeast</span>
<span class="na">northeast</span>
<span class="na">southwest</span>
<span class="na">northwest</span>
</pre></div>
</div>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">children</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">usa</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">children</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">southeast</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">children</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">atlanta</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">host1</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">host2</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">raleigh</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">host2</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">host3</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">some_server</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foo.southeast.example.com</span>
            <span class="l l-Scalar l-Scalar-Plain">halon_system_timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
            <span class="l l-Scalar l-Scalar-Plain">self_destruct_countdown</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
            <span class="l l-Scalar l-Scalar-Plain">escape_pods</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
      <span class=" -Error"> </span><span class="l l-Scalar l-Scalar-Plain">northeast</span><span class="p p-Indicator">:</span>
       <span class="l l-Scalar l-Scalar-Plain">northwest</span><span class="p p-Indicator">:</span>
       <span class="l l-Scalar l-Scalar-Plain">southwest</span><span class="p p-Indicator">:</span>
</pre></div>
</div>
<p>If you need to store lists or hash data, or prefer to keep host and group specific variables separate from the inventory file, see the next section.
Child groups have a couple of properties to note:</p>
<blockquote>
<div><ul class="simple">
<li>Any host that is member of a child group is automatically a member of the parent group.</li>
<li>A child group&#8217;s variables will have higher precedence (override) a parent group&#8217;s variables.</li>
<li>Groups can have multiple parents and children, but not circular relationships.</li>
<li>Hosts can also be in multiple groups, but there will only be <strong>one</strong> instance of a host, merging the data from the multiple groups.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="default-groups">
<span id="id4"></span><h5><a class="toc-backref" href="#id10">Default groups</a><a class="headerlink" href="#default-groups" title="Permalink to this headline">¶</a></h5>
<p>There are two default groups: <code class="docutils literal"><span class="pre">all</span></code> and <code class="docutils literal"><span class="pre">ungrouped</span></code>. <code class="docutils literal"><span class="pre">all</span></code> contains every host.
<code class="docutils literal"><span class="pre">ungrouped</span></code> contains all hosts that don&#8217;t have another group aside from <code class="docutils literal"><span class="pre">all</span></code>.
Every host will always belong to at least 2 groups.
Though <code class="docutils literal"><span class="pre">all</span></code> and <code class="docutils literal"><span class="pre">ungrouped</span></code> are always present, they can be implicit and not appear in group listings like <code class="docutils literal"><span class="pre">group_names</span></code>.</p>
</div>
<div class="section" id="splitting-out-host-and-group-specific-data">
<span id="splitting-out-vars"></span><h5><a class="toc-backref" href="#id11">Splitting Out Host and Group Specific Data</a><a class="headerlink" href="#splitting-out-host-and-group-specific-data" title="Permalink to this headline">¶</a></h5>
<p>The preferred practice in Ansible is to not store variables in the main inventory file.</p>
<p>In addition to storing variables directly in the inventory file, host and group variables can be stored in individual files relative to the inventory file (not directory, it is always the file).</p>
<p>These variable files are in YAML format. Valid file extensions include &#8216;.yml&#8217;, &#8216;.yaml&#8217;, &#8216;.json&#8217;, or no file extension.
See <a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a> if you are new to YAML.</p>
<p>Assuming the inventory file path is:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">/etc/ansible/hosts</span>
</pre></div>
</div>
<p>If the host is named &#8216;foosball&#8217;, and in groups &#8216;raleigh&#8217; and &#8216;webservers&#8217;, variables
in YAML files at the following locations will be made available to the host:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">/etc/ansible/group_vars/raleigh</span> <span class="c1"># can optionally end in &#39;.yml&#39;, &#39;.yaml&#39;, or &#39;.json&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">/etc/ansible/group_vars/webservers</span>
<span class="l l-Scalar l-Scalar-Plain">/etc/ansible/host_vars/foosball</span>
</pre></div>
</div>
<p>For instance, suppose you have hosts grouped by datacenter, and each datacenter
uses some different servers.  The data in the groupfile &#8216;/etc/ansible/group_vars/raleigh&#8217; for
the &#8216;raleigh&#8217; group might look like:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">ntp_server</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">acme.example.org</span>
<span class="l l-Scalar l-Scalar-Plain">database_server</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">storage.example.org</span>
</pre></div>
</div>
<p>It is okay if these files do not exist, as this is an optional feature.</p>
<p>As an advanced use case, you can create <em>directories</em> named after your groups or hosts, and
Ansible will read all the files in these directories. An example with the &#8216;raleigh&#8217; group:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">/etc/ansible/group_vars/raleigh/db_settings</span>
<span class="l l-Scalar l-Scalar-Plain">/etc/ansible/group_vars/raleigh/cluster_settings</span>
</pre></div>
</div>
<p>All hosts that are in the &#8216;raleigh&#8217; group will have the variables defined in these files
available to them. This can be very useful to keep your variables organized when a single
file starts to be too big, or when you want to use <a class="reference internal" href="index.html#document-playbooks_vault"><span class="doc">Ansible Vault</span></a> on a part of a group&#8217;s
variables. Note that this only works on Ansible 1.4 or later.</p>
<p>Tip: In Ansible 1.2 or later the <code class="docutils literal"><span class="pre">group_vars/</span></code> and <code class="docutils literal"><span class="pre">host_vars/</span></code> directories can exist in
the playbook directory OR the inventory directory. If both paths exist, variables in the playbook
directory will override variables set in the inventory directory.</p>
<p>Tip: Keeping your inventory file and variables in a git repo (or other version control)
is an excellent way to track changes to your inventory and host variables.</p>
</div>
<div class="section" id="list-of-behavioral-inventory-parameters">
<span id="behavioral-parameters"></span><h5><a class="toc-backref" href="#id12">List of Behavioral Inventory Parameters</a><a class="headerlink" href="#list-of-behavioral-inventory-parameters" title="Permalink to this headline">¶</a></h5>
<p>As alluded to above, setting the following variables controls how ansible interacts with remote hosts.</p>
<p>Host connection:</p>
<dl class="docutils">
<dt>ansible_connection</dt>
<dd>Connection type to the host. This can be the name of any of ansible&#8217;s connection plugins. SSH protocol types are <code class="docutils literal"><span class="pre">smart</span></code>, <code class="docutils literal"><span class="pre">ssh</span></code> or <code class="docutils literal"><span class="pre">paramiko</span></code>.  The default is smart. Non-SSH based types are described in the next section.</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible 2.0 has deprecated the “ssh” from <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code>, <code class="docutils literal"><span class="pre">ansible_ssh_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_ssh_port</span></code> to become <code class="docutils literal"><span class="pre">ansible_user</span></code>, <code class="docutils literal"><span class="pre">ansible_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_port</span></code>. If you are using a version of Ansible prior to 2.0,  you should continue using the older style variables (<code class="docutils literal"><span class="pre">ansible_ssh_*</span></code>). These shorter variables are ignored, without warning, in older versions of Ansible.</p>
</div>
<p>General for all connections:</p>
<dl class="docutils">
<dt>ansible_host</dt>
<dd>The name of the host to connect to, if different from the alias you wish to give to it.</dd>
<dt>ansible_port</dt>
<dd>The ssh port number, if not 22</dd>
<dt>ansible_user</dt>
<dd>The default ssh user name to use.</dd>
</dl>
<p>Specific to the SSH connection:</p>
<dl class="docutils">
<dt>ansible_ssh_pass</dt>
<dd>The ssh password to use (never store this variable in plain text; always use a vault. See <a class="reference internal" href="index.html#best-practices-for-variables-and-vaults"><span class="std std-ref">Variables and Vaults</span></a>)</dd>
<dt>ansible_ssh_private_key_file</dt>
<dd>Private key file used by ssh.  Useful if using multiple keys and you don&#8217;t want to use SSH agent.</dd>
<dt>ansible_ssh_common_args</dt>
<dd>This setting is always appended to the default command line for <strong class="command">sftp</strong>, <strong class="command">scp</strong>,
and <strong class="command">ssh</strong>. Useful to configure a <code class="docutils literal"><span class="pre">ProxyCommand</span></code> for a certain host (or
group).</dd>
<dt>ansible_sftp_extra_args</dt>
<dd>This setting is always appended to the default <strong class="command">sftp</strong> command line.</dd>
<dt>ansible_scp_extra_args</dt>
<dd>This setting is always appended to the default <strong class="command">scp</strong> command line.</dd>
<dt>ansible_ssh_extra_args</dt>
<dd>This setting is always appended to the default <strong class="command">ssh</strong> command line.</dd>
<dt>ansible_ssh_pipelining</dt>
<dd>Determines whether or not to use SSH pipelining. This can override the <code class="docutils literal"><span class="pre">pipelining</span></code> setting in <code class="file docutils literal"><span class="pre">ansible.cfg</span></code>.</dd>
<dt>ansible_ssh_executable (added in version 2.2)</dt>
<dd>This setting overrides the default behavior to use the system <strong class="command">ssh</strong>. This can override the <code class="docutils literal"><span class="pre">ssh_executable</span></code> setting in <code class="file docutils literal"><span class="pre">ansible.cfg</span></code>.</dd>
</dl>
<p>Privilege escalation (see <a class="reference internal" href="index.html#document-become"><span class="doc">Ansible Privilege Escalation</span></a> for further details):</p>
<dl class="docutils">
<dt>ansible_become</dt>
<dd>Equivalent to <code class="docutils literal"><span class="pre">ansible_sudo</span></code> or <code class="docutils literal"><span class="pre">ansible_su</span></code>, allows to force privilege escalation</dd>
<dt>ansible_become_method</dt>
<dd>Allows to set privilege escalation method</dd>
<dt>ansible_become_user</dt>
<dd>Equivalent to <code class="docutils literal"><span class="pre">ansible_sudo_user</span></code> or <code class="docutils literal"><span class="pre">ansible_su_user</span></code>, allows to set the user you become through privilege escalation</dd>
<dt>ansible_become_pass</dt>
<dd>Equivalent to <code class="docutils literal"><span class="pre">ansible_sudo_pass</span></code> or <code class="docutils literal"><span class="pre">ansible_su_pass</span></code>, allows you to set the privilege escalation password (never store this variable in plain text; always use a vault. See <a class="reference internal" href="index.html#best-practices-for-variables-and-vaults"><span class="std std-ref">Variables and Vaults</span></a>)</dd>
<dt>ansible_become_exe</dt>
<dd>Equivalent to <code class="docutils literal"><span class="pre">ansible_sudo_exe</span></code> or <code class="docutils literal"><span class="pre">ansible_su_exe</span></code>, allows you to set the executable for the escalation method selected</dd>
<dt>ansible_become_flags</dt>
<dd>Equivalent to <code class="docutils literal"><span class="pre">ansible_sudo_flags</span></code> or <code class="docutils literal"><span class="pre">ansible_su_flags</span></code>, allows you to set the flags passed to the selected escalation method. This can be also set globally in <code class="file docutils literal"><span class="pre">ansible.cfg</span></code> in the <code class="docutils literal"><span class="pre">sudo_flags</span></code> option</dd>
</dl>
<p>Remote host environment parameters:</p>
<dl class="docutils">
<dt>ansible_shell_type</dt>
<dd>The shell type of the target system. You should not use this setting unless you have set the <code class="docutils literal"><span class="pre">ansible_shell_executable</span></code> to a non-Bourne (sh) compatible shell.
By default commands are formatted using <code class="docutils literal"><span class="pre">sh</span></code>-style syntax.
Setting this to <code class="docutils literal"><span class="pre">csh</span></code> or <code class="docutils literal"><span class="pre">fish</span></code> will cause commands executed on target systems to follow those shell&#8217;s syntax instead.</dd>
<dt>ansible_python_interpreter</dt>
<dd>The target host python path. This is useful for systems with more
than one Python or not located at <strong class="command">/usr/bin/python</strong> such as *BSD, or where <strong class="command">/usr/bin/python</strong>
is not a 2.X series Python.  We do not use the <strong class="command">/usr/bin/env</strong> mechanism as that requires the remote user&#8217;s
path to be set right and also assumes the <strong class="program">python</strong> executable is named python, where the executable might
be named something like <strong class="program">python2.6</strong>.</dd>
<dt>ansible_*_interpreter</dt>
<dd>Works for anything such as ruby or perl and works just like <code class="docutils literal"><span class="pre">ansible_python_interpreter</span></code>.
This replaces shebang of modules which will run on that host.</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<dl class="docutils">
<dt>ansible_shell_executable</dt>
<dd>This sets the shell the ansible controller will use on the target machine,
overrides <code class="docutils literal"><span class="pre">executable</span></code> in <code class="file docutils literal"><span class="pre">ansible.cfg</span></code> which defaults to
<strong class="command">/bin/sh</strong>.  You should really only change it if is not possible
to use <strong class="command">/bin/sh</strong> (i.e. <strong class="command">/bin/sh</strong> is not installed on the target
machine or cannot be run from sudo.).</dd>
</dl>
<p>Examples from an Ansible-INI host file:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">some_host         ansible_port=2222     ansible_user=manager</span>
<span class="l l-Scalar l-Scalar-Plain">aws_host          ansible_ssh_private_key_file=/home/example/.ssh/aws.pem</span>
<span class="l l-Scalar l-Scalar-Plain">freebsd_host      ansible_python_interpreter=/usr/local/bin/python</span>
<span class="l l-Scalar l-Scalar-Plain">ruby_module_host  ansible_ruby_interpreter=/usr/bin/ruby.1.9.3</span>
</pre></div>
</div>
</div>
<div class="section" id="non-ssh-connection-types">
<h5><a class="toc-backref" href="#id13">Non-SSH connection types</a><a class="headerlink" href="#non-ssh-connection-types" title="Permalink to this headline">¶</a></h5>
<p>As stated in the previous section, Ansible executes playbooks over SSH but it is not limited to this connection type.
With the host specific parameter <code class="docutils literal"><span class="pre">ansible_connection=&lt;connector&gt;</span></code>, the connection type can be changed.
The following non-SSH based connectors are available:</p>
<p><strong>local</strong></p>
<p>This connector can be used to deploy the playbook to the control machine itself.</p>
<p><strong>docker</strong></p>
<p>This connector deploys the playbook directly into Docker containers using the local Docker client. The following parameters are processed by this connector:</p>
<dl class="docutils">
<dt>ansible_host</dt>
<dd>The name of the Docker container to connect to.</dd>
<dt>ansible_user</dt>
<dd>The user name to operate within the container. The user must exist inside the container.</dd>
<dt>ansible_become</dt>
<dd>If set to <code class="docutils literal"><span class="pre">true</span></code> the <code class="docutils literal"><span class="pre">become_user</span></code> will be used to operate within the container.</dd>
<dt>ansible_docker_extra_args</dt>
<dd>Could be a string with any additional arguments understood by Docker, which are not command specific. This parameter is mainly used to configure a remote Docker daemon to use.</dd>
</dl>
<p>Here is an example of how to instantly deploy to created containers:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">create jenkins container</span>
  <span class="l l-Scalar l-Scalar-Plain">docker_container</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">docker_host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">myserver.net:4243</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my_jenkins</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">add container to inventory</span>
  <span class="l l-Scalar l-Scalar-Plain">add_host</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my_jenkins</span>
    <span class="l l-Scalar l-Scalar-Plain">ansible_connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>
    <span class="l l-Scalar l-Scalar-Plain">ansible_docker_extra_args</span><span class="p p-Indicator">:</span> <span class="s">&quot;--tlsverify</span><span class="nv"> </span><span class="s">--tlscacert=/path/to/ca.pem</span><span class="nv"> </span><span class="s">--tlscert=/path/to/client-cert.pem</span><span class="nv"> </span><span class="s">--tlskey=/path/to/client-key.pem</span><span class="nv"> </span><span class="s">-H=tcp://myserver.net:4243&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ansible_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="l l-Scalar l-Scalar-Plain">changed_when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">create directory for ssh keys</span>
  <span class="l l-Scalar l-Scalar-Plain">delegate_to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my_jenkins</span>
  <span class="l l-Scalar l-Scalar-Plain">file</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="s">&quot;/var/jenkins_home/.ssh/jupiter&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">directory</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you&#8217;re reading the docs from the beginning, this may be the first example you&#8217;ve seen of an Ansible playbook. This is not an inventory file.
Playbooks will be covered in great detail later in the docs.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a></dt>
<dd>Pulling inventory from dynamic sources, such as cloud providers</dd>
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Learning Ansible’s configuration, deployment, and orchestration language.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-intro_dynamic_inventory"></span><div class="section" id="dynamic-inventory">
<span id="id1"></span><h4><a class="toc-backref" href="#id4">Dynamic Inventory</a><a class="headerlink" href="#dynamic-inventory" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#dynamic-inventory" id="id4">Dynamic Inventory</a><ul>
<li><a class="reference internal" href="#example-the-cobbler-external-inventory-script" id="id5">Example: The Cobbler External Inventory Script</a></li>
<li><a class="reference internal" href="#example-aws-ec2-external-inventory-script" id="id6">Example: AWS EC2 External Inventory Script</a></li>
<li><a class="reference internal" href="#example-openstack-external-inventory-script" id="id7">Example: OpenStack External Inventory Script</a><ul>
<li><a class="reference internal" href="#explicit-use-of-inventory-script" id="id8">Explicit use of inventory script</a></li>
<li><a class="reference internal" href="#implicit-use-of-inventory-script" id="id9">Implicit use of inventory script</a></li>
<li><a class="reference internal" href="#refresh-the-cache" id="id10">Refresh the cache</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-inventory-scripts" id="id11">Other inventory scripts</a></li>
<li><a class="reference internal" href="#using-inventory-directories-and-multiple-inventory-sources" id="id12">Using Inventory Directories and Multiple Inventory Sources</a></li>
<li><a class="reference internal" href="#static-groups-of-dynamic-groups" id="id13">Static Groups of Dynamic Groups</a></li>
</ul>
</li>
</ul>
</div>
<p>Often a user of a configuration management system will want to keep inventory
in a different software system.  Ansible provides a basic text-based system as described in
<a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a> but what if you want to use something else?</p>
<p>Frequent examples include pulling inventory from a cloud provider, LDAP, <a class="reference external" href="http://cobbler.github.com">Cobbler</a>,
or a piece of expensive enterprisey CMDB software.</p>
<p>Ansible easily supports all of these options via an external inventory system.  The contrib/inventory directory contains some of these already &#8211; including options for EC2/Eucalyptus, Rackspace Cloud, and OpenStack, examples of some of which will be detailed below.</p>
<p><a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a> also provides a database to store inventory results that is both web and REST Accessible.  Tower syncs with all Ansible dynamic inventory sources you might be using, and also includes a graphical inventory editor. By having a database record of all of your hosts, it&#8217;s easy to correlate past event history and see which ones have had failures on their last playbook runs.</p>
<p>For information about writing your own dynamic inventory source, see <a class="reference internal" href="index.html#document-dev_guide/developing_inventory"><span class="doc">Developing Dynamic Inventory Sources</span></a>.</p>
<div class="section" id="example-the-cobbler-external-inventory-script">
<span id="cobbler-example"></span><h5><a class="toc-backref" href="#id5">Example: The Cobbler External Inventory Script</a><a class="headerlink" href="#example-the-cobbler-external-inventory-script" title="Permalink to this headline">¶</a></h5>
<p>It is expected that many Ansible users with a reasonable amount of physical hardware may also be <a class="reference external" href="http://cobbler.github.com">Cobbler</a> users.  (note: Cobbler was originally written by Michael DeHaan and is now led by James Cammarata, who also works for Ansible, Inc).</p>
<p>While primarily used to kickoff OS installations and manage DHCP and DNS, Cobbler has a generic
layer that allows it to represent data for multiple configuration management systems (even at the same time), and has
been referred to as a &#8216;lightweight CMDB&#8217; by some admins.</p>
<p>To tie Ansible&#8217;s inventory to Cobbler (optional), copy <a class="reference external" href="https://raw.github.com/ansible/ansible/devel/contrib/inventory/cobbler.py">this script</a> to <code class="docutils literal"><span class="pre">/etc/ansible</span></code> and <code class="docutils literal"><span class="pre">chmod</span> <span class="pre">+x</span></code> the file.  cobblerd will now need
to be running when you are using Ansible and you&#8217;ll need to use Ansible&#8217;s  <code class="docutils literal"><span class="pre">-i</span></code> command line option (e.g. <code class="docutils literal"><span class="pre">-i</span> <span class="pre">/etc/ansible/cobbler.py</span></code>).
This particular script will communicate with Cobbler using Cobbler&#8217;s XMLRPC API.</p>
<p>Also a <code class="docutils literal"><span class="pre">cobbler.ini</span></code> file should be added to <code class="docutils literal"><span class="pre">/etc/ansible</span></code> so Ansible knows where the Cobbler server is and some cache improvements can be used. For example:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">cobbler</span><span class="p p-Indicator">]</span>

<span class="c1"># Set Cobbler&#39;s hostname or IP address</span>
<span class="l l-Scalar l-Scalar-Plain">host = http://127.0.0.1/cobbler_api</span>

<span class="l l-Scalar l-Scalar-Plain"># API calls to Cobbler can be slow. For this reason, we cache the results of an API</span>
<span class="l l-Scalar l-Scalar-Plain"># call. Set this to the path you want cache files to be written to. Two files</span>
<span class="l l-Scalar l-Scalar-Plain"># will be written to this directory</span><span class="p p-Indicator">:</span>
<span class="c1">#   - ansible-cobbler.cache</span>
<span class="c1">#   - ansible-cobbler.index</span>

<span class="l l-Scalar l-Scalar-Plain">cache_path = /tmp</span>

<span class="c1"># The number of seconds a cache file is considered valid. After this many</span>
<span class="c1"># seconds, a new API call will be made, and the cache file will be updated.</span>

<span class="l l-Scalar l-Scalar-Plain">cache_max_age = 900</span>
</pre></div>
</div>
<p>First test the script by running <code class="docutils literal"><span class="pre">/etc/ansible/cobbler.py</span></code> directly.   You should see some JSON data output, but it may not have anything in it just yet.</p>
<p>Let&#8217;s explore what this does.  In Cobbler, assume a scenario somewhat like the following:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">cobbler profile add --name=webserver --distro=CentOS6-x86_64</span>
<span class="l l-Scalar l-Scalar-Plain">cobbler profile edit --name=webserver --mgmt-classes=&quot;webserver&quot; --ksmeta=&quot;a=2 b=3&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">cobbler system edit --name=foo --dns-name=&quot;foo.example.com&quot; --mgmt-classes=&quot;atlanta&quot; --ksmeta=&quot;c=4&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">cobbler system edit --name=bar --dns-name=&quot;bar.example.com&quot; --mgmt-classes=&quot;atlanta&quot; --ksmeta=&quot;c=5&quot;</span>
</pre></div>
</div>
<p>In the example above, the system &#8216;foo.example.com&#8217; will be addressable by ansible directly, but will also be addressable when using the group names &#8216;webserver&#8217; or &#8216;atlanta&#8217;.  Since Ansible uses SSH, we&#8217;ll try to contact system foo over &#8216;foo.example.com&#8217;, only, never just &#8216;foo&#8217;.  Similarly, if you try &#8220;ansible foo&#8221; it wouldn&#8217;t find the system... but &#8220;ansible &#8216;foo*&#8217;&#8221; would, because the system DNS name starts with &#8216;foo&#8217;.</p>
<p>The script doesn&#8217;t just provide host and group info.  In addition, as a bonus, when the &#8216;setup&#8217; module is run (which happens automatically when using playbooks), the variables &#8216;a&#8217;, &#8216;b&#8217;, and &#8216;c&#8217; will all be auto-populated in the templates:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="c1"># file: /srv/motd.j2</span>
<span class="l l-Scalar l-Scalar-Plain">Welcome, I am templated with a value of a=</span><span class="cp">{{</span> <span class="nv">a</span> <span class="cp">}}</span><span class="l l-Scalar l-Scalar-Plain">, b=</span><span class="cp">{{</span> <span class="nv">b</span> <span class="cp">}}</span><span class="l l-Scalar l-Scalar-Plain">, and c=</span><span class="cp">{{</span> <span class="nv">c</span> <span class="cp">}}</span>
</pre></div>
</div>
<p>Which could be executed just like this:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible webserver -m setup</span>
<span class="l l-Scalar l-Scalar-Plain">ansible webserver -m template -a &quot;src=/tmp/motd.j2 dest=/etc/motd&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The name &#8216;webserver&#8217; came from Cobbler, as did the variables for
the config file.  You can still pass in your own variables like
normal in Ansible, but variables from the external inventory script
will override any that have the same name.</p>
</div>
<p>So, with the template above (<code class="docutils literal"><span class="pre">motd.j2</span></code>), this would result in the following data being written to <code class="docutils literal"><span class="pre">/etc/motd</span></code> for system &#8216;foo&#8217;:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Welcome, I am templated with a value of a=2, b=3, and c=4</span>
</pre></div>
</div>
<p>And on system &#8216;bar&#8217; (bar.example.com):</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Welcome, I am templated with a value of a=2, b=3, and c=5</span>
</pre></div>
</div>
<p>And technically, though there is no major good reason to do it, this also works too:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible webserver -m shell -a &quot;echo </span><span class="cp">{{</span> <span class="nv">a</span> <span class="cp">}}</span><span class="l l-Scalar l-Scalar-Plain">&quot;</span>
</pre></div>
</div>
<p>So in other words, you can use those variables in arguments/actions as well.</p>
</div>
<div class="section" id="example-aws-ec2-external-inventory-script">
<span id="aws-example"></span><h5><a class="toc-backref" href="#id6">Example: AWS EC2 External Inventory Script</a><a class="headerlink" href="#example-aws-ec2-external-inventory-script" title="Permalink to this headline">¶</a></h5>
<p>If you use Amazon Web Services EC2, maintaining an inventory file might not be the best approach, because hosts may come and go over time, be managed by external applications, or you might even be using AWS autoscaling. For this reason, you can use the <a class="reference external" href="https://raw.github.com/ansible/ansible/devel/contrib/inventory/ec2.py">EC2 external inventory</a> script.</p>
<p>You can use this script in one of two ways. The easiest is to use Ansible&#8217;s <code class="docutils literal"><span class="pre">-i</span></code> command line option and specify the path to the script after
marking it executable:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible -i ec2.py -u ubuntu us-east-1d -m ping</span>
</pre></div>
</div>
<p>The second option is to copy the script to <cite>/etc/ansible/hosts</cite> and <cite>chmod +x</cite> it. You will also need to copy the <a class="reference external" href="https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/ec2.ini">ec2.ini</a> file to <cite>/etc/ansible/ec2.ini</cite>. Then you can run ansible as you would normally.</p>
<p>To successfully make an API call to AWS, you will need to configure Boto (the Python interface to AWS). There are a <a class="reference external" href="http://docs.pythonboto.org/en/latest/boto_config_tut.html">variety of methods</a> available, but the simplest is just to export two environment variables:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">export AWS_ACCESS_KEY_ID=&#39;AK123&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">export AWS_SECRET_ACCESS_KEY=&#39;abc123&#39;</span>
</pre></div>
</div>
<p>You can test the script by itself to make sure your config is correct:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">cd contrib/inventory</span>
<span class="l l-Scalar l-Scalar-Plain">./ec2.py --list</span>
</pre></div>
</div>
<p>After a few moments, you should see your entire EC2 inventory across all regions in JSON.</p>
<p>If you use Boto profiles to manage multiple AWS accounts, you can pass <code class="docutils literal"><span class="pre">--profile</span> <span class="pre">PROFILE</span></code> name to the <code class="docutils literal"><span class="pre">ec2.py</span></code> script. An example profile might be:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">profile dev</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">aws_access_key_id = &lt;dev access key&gt;</span>
<span class="l l-Scalar l-Scalar-Plain">aws_secret_access_key = &lt;dev secret key&gt;</span>

<span class="l l-Scalar l-Scalar-Plain">[profile prod]</span>
<span class="l l-Scalar l-Scalar-Plain">aws_access_key_id = &lt;prod access key&gt;</span>
<span class="l l-Scalar l-Scalar-Plain">aws_secret_access_key = &lt;prod secret key&gt;</span>
</pre></div>
</div>
<p>You can then run <code class="docutils literal"><span class="pre">ec2.py</span> <span class="pre">--profile</span> <span class="pre">prod</span></code> to get the inventory for the prod account, although this option is not supported by <code class="docutils literal"><span class="pre">ansible-playbook</span></code>.
You can also use the <code class="docutils literal"><span class="pre">AWS_PROFILE</span></code> variable - for example: <code class="docutils literal"><span class="pre">AWS_PROFILE=prod</span> <span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">ec2.py</span> <span class="pre">myplaybook.yml</span></code></p>
<p>Since each region requires its own API call, if you are only using a small set of regions, you can edit the <code class="docutils literal"><span class="pre">ec2.ini</span></code> file and comment out the regions you are not using.</p>
<p>There are other config options in <code class="docutils literal"><span class="pre">ec2.ini</span></code>, including cache control and destination variables. By default, the <code class="docutils literal"><span class="pre">ec2.ini</span></code> file is configured for <strong>all Amazon cloud services</strong>, but you can comment out any features that aren&#8217;t applicable. For example, if you don&#8217;t have <code class="docutils literal"><span class="pre">RDS</span></code> or <code class="docutils literal"><span class="pre">elasticache</span></code>, you can set them to <code class="docutils literal"><span class="pre">False</span></code></p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">ec2</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>

<span class="c1"># To exclude RDS instances from the inventory, uncomment and set to False.</span>
<span class="l l-Scalar l-Scalar-Plain">rds = False</span>

<span class="l l-Scalar l-Scalar-Plain"># To exclude ElastiCache instances from the inventory, uncomment and set to False.</span>
<span class="l l-Scalar l-Scalar-Plain">elasticache = False</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>At their heart, inventory files are simply a mapping from some name to a destination address. The default <code class="docutils literal"><span class="pre">ec2.ini</span></code> settings are configured for running Ansible from outside EC2 (from your laptop for example) &#8211; and this is not the most efficient way to manage EC2.</p>
<p>If you are running Ansible from within EC2, internal DNS names and IP addresses may make more sense than public DNS names. In this case, you can modify the <code class="docutils literal"><span class="pre">destination_variable</span></code> in <code class="docutils literal"><span class="pre">ec2.ini</span></code> to be the private DNS name of an instance. This is particularly important when running Ansible within a private subnet inside a VPC, where the only way to access an instance is via its private IP address. For VPC instances, <cite>vpc_destination_variable</cite> in <code class="docutils literal"><span class="pre">ec2.ini</span></code> provides a means of using which ever <a class="reference external" href="http://docs.pythonboto.org/en/latest/ref/ec2.html#module-boto.ec2.instance">boto.ec2.instance variable</a> makes the most sense for your use case.</p>
<p>The EC2 external inventory provides mappings to instances from several groups:</p>
<dl class="docutils">
<dt>Global</dt>
<dd>All instances are in group <code class="docutils literal"><span class="pre">ec2</span></code>.</dd>
<dt>Instance ID</dt>
<dd>These are groups of one since instance IDs are unique.
e.g.
<code class="docutils literal"><span class="pre">i-00112233</span></code>
<code class="docutils literal"><span class="pre">i-a1b1c1d1</span></code></dd>
<dt>Region</dt>
<dd>A group of all instances in an AWS region.
e.g.
<code class="docutils literal"><span class="pre">us-east-1</span></code>
<code class="docutils literal"><span class="pre">us-west-2</span></code></dd>
<dt>Availability Zone</dt>
<dd>A group of all instances in an availability zone.
e.g.
<code class="docutils literal"><span class="pre">us-east-1a</span></code>
<code class="docutils literal"><span class="pre">us-east-1b</span></code></dd>
<dt>Security Group</dt>
<dd>Instances belong to one or more security groups. A group is created for each security group, with all characters except alphanumerics, converted to underscores (_). Each group is prefixed by <code class="docutils literal"><span class="pre">security_group_</span></code>. Currently, dashes (-) are also converted to underscores (_). You can change using the replace_dash_in_groups setting in ec2.ini (this has changed across several versions so check the ec2.ini for details).
e.g.
<code class="docutils literal"><span class="pre">security_group_default</span></code>
<code class="docutils literal"><span class="pre">security_group_webservers</span></code>
<code class="docutils literal"><span class="pre">security_group_Pete_s_Fancy_Group</span></code></dd>
<dt>Tags</dt>
<dd>Each instance can have a variety of key/value pairs associated with it called Tags. The most common tag key is &#8216;Name&#8217;, though anything is possible. Each key/value pair is its own group of instances, again with special characters converted to underscores, in the format <code class="docutils literal"><span class="pre">tag_KEY_VALUE</span></code>
e.g.
<code class="docutils literal"><span class="pre">tag_Name_Web</span></code> can be used as is
<code class="docutils literal"><span class="pre">tag_Name_redis-master-001</span></code> becomes <code class="docutils literal"><span class="pre">tag_Name_redis_master_001</span></code>
<code class="docutils literal"><span class="pre">tag_aws_cloudformation_logical-id_WebServerGroup</span></code> becomes <code class="docutils literal"><span class="pre">tag_aws_cloudformation_logical_id_WebServerGroup</span></code></dd>
</dl>
<p>When the Ansible is interacting with a specific server, the EC2 inventory script is called again with the <code class="docutils literal"><span class="pre">--host</span> <span class="pre">HOST</span></code> option. This looks up the HOST in the index cache to get the instance ID, and then makes an API call to AWS to get information about that specific instance. It then makes information about that instance available as variables to your playbooks. Each variable is prefixed by <code class="docutils literal"><span class="pre">ec2_</span></code>. Here are some of the variables available:</p>
<ul class="simple">
<li>ec2_architecture</li>
<li>ec2_description</li>
<li>ec2_dns_name</li>
<li>ec2_id</li>
<li>ec2_image_id</li>
<li>ec2_instance_type</li>
<li>ec2_ip_address</li>
<li>ec2_kernel</li>
<li>ec2_key_name</li>
<li>ec2_launch_time</li>
<li>ec2_monitored</li>
<li>ec2_ownerId</li>
<li>ec2_placement</li>
<li>ec2_platform</li>
<li>ec2_previous_state</li>
<li>ec2_private_dns_name</li>
<li>ec2_private_ip_address</li>
<li>ec2_public_dns_name</li>
<li>ec2_ramdisk</li>
<li>ec2_region</li>
<li>ec2_root_device_name</li>
<li>ec2_root_device_type</li>
<li>ec2_security_group_ids</li>
<li>ec2_security_group_names</li>
<li>ec2_spot_instance_request_id</li>
<li>ec2_state</li>
<li>ec2_state_code</li>
<li>ec2_state_reason</li>
<li>ec2_status</li>
<li>ec2_subnet_id</li>
<li>ec2_tag_Name</li>
<li>ec2_tenancy</li>
<li>ec2_virtualization_type</li>
<li>ec2_vpc_id</li>
</ul>
<p>Both <code class="docutils literal"><span class="pre">ec2_security_group_ids</span></code> and <code class="docutils literal"><span class="pre">ec2_security_group_names</span></code> are comma-separated lists of all security groups. Each EC2 tag is a variable in the format <code class="docutils literal"><span class="pre">ec2_tag_KEY</span></code>.</p>
<p>To see the complete list of variables available for an instance, run the script by itself:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">cd contrib/inventory</span>
<span class="l l-Scalar l-Scalar-Plain">./ec2.py --host ec2-12-12-12-12.compute-1.amazonaws.com</span>
</pre></div>
</div>
<p>Note that the AWS inventory script will cache results to avoid repeated API calls, and this cache setting is configurable in ec2.ini.  To
explicitly clear the cache, you can run the ec2.py script with the <code class="docutils literal"><span class="pre">--refresh-cache</span></code> parameter:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./ec2.py --refresh-cache</span>
</pre></div>
</div>
</div>
<div class="section" id="example-openstack-external-inventory-script">
<span id="openstack-example"></span><h5><a class="toc-backref" href="#id7">Example: OpenStack External Inventory Script</a><a class="headerlink" href="#example-openstack-external-inventory-script" title="Permalink to this headline">¶</a></h5>
<p>If you use an OpenStack based cloud, instead of manually maintaining your own inventory file, you can use the openstack.py dynamic inventory to pull information about your compute instances directly from OpenStack.</p>
<p>You can download the latest version of the OpenStack inventory script <a class="reference external" href="https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/openstack.py">here</a></p>
<p>You can use the inventory script explicitly (by passing the <cite>-i openstack.py</cite> argument to Ansible) or implicitly (by placing the script at <cite>/etc/ansible/hosts</cite>).</p>
<div class="section" id="explicit-use-of-inventory-script">
<h6><a class="toc-backref" href="#id8">Explicit use of inventory script</a><a class="headerlink" href="#explicit-use-of-inventory-script" title="Permalink to this headline">¶</a></h6>
<p>Download the latest version of the OpenStack dynamic inventory script and make it executable:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">wget https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/openstack.py</span>
<span class="l l-Scalar l-Scalar-Plain">chmod +x openstack.py</span>
</pre></div>
</div>
<p>Source an OpenStack RC file:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">source openstack.rc</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An OpenStack RC file contains the environment variables required by the client tools to establish a connection with the cloud provider, such as the authentication URL, user name, password and region name. For more information on how to download, create or source an OpenStack RC file, please refer to <a class="reference external" href="http://docs.openstack.org/user-guide/common/cli_set_environment_variables_using_openstack_rc.html">Set environment variables using the OpenStack RC file</a>.</p>
</div>
<p>You can confirm the file has been successfully sourced by running a simple command, such as <cite>nova list</cite> and ensuring it return no errors.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The OpenStack command line clients are required to run the <cite>nova list</cite> command. For more information on how to install them, please refer to <a class="reference external" href="http://docs.openstack.org/user-guide/common/cli_install_openstack_command_line_clients.html">Install the OpenStack command-line clients</a>.</p>
</div>
<p>You can test the OpenStack dynamic inventory script manually to confirm it is working as expected:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./openstack.py --list</span>
</pre></div>
</div>
<p>After a few moments you should see some JSON output with information about your compute instances.</p>
<p>Once you confirm the dynamic inventory script is working as expected, you can tell Ansible to use the <cite>openstack.py</cite> script as an inventory file, as illustrated below:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible -i openstack.py all -m ping</span>
</pre></div>
</div>
</div>
<div class="section" id="implicit-use-of-inventory-script">
<h6><a class="toc-backref" href="#id9">Implicit use of inventory script</a><a class="headerlink" href="#implicit-use-of-inventory-script" title="Permalink to this headline">¶</a></h6>
<p>Download the latest version of the OpenStack dynamic inventory script, make it executable and copy it to <cite>/etc/ansible/hosts</cite>:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">wget https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/openstack.py</span>
<span class="l l-Scalar l-Scalar-Plain">chmod +x openstack.py</span>
<span class="l l-Scalar l-Scalar-Plain">sudo cp openstack.py /etc/ansible/hosts</span>
</pre></div>
</div>
<p>Download the sample configuration file, modify it to suit your needs and copy it to <cite>/etc/ansible/openstack.yml</cite>:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">wget https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/openstack.yml</span>
<span class="l l-Scalar l-Scalar-Plain">vi openstack.yml</span>
<span class="l l-Scalar l-Scalar-Plain">sudo cp openstack.yml /etc/ansible/</span>
</pre></div>
</div>
<p>You can test the OpenStack dynamic inventory script manually to confirm it is working as expected:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">/etc/ansible/hosts --list</span>
</pre></div>
</div>
<p>After a few moments you should see some JSON output with information about your compute instances.</p>
</div>
<div class="section" id="refresh-the-cache">
<h6><a class="toc-backref" href="#id10">Refresh the cache</a><a class="headerlink" href="#refresh-the-cache" title="Permalink to this headline">¶</a></h6>
<p>Note that the OpenStack dynamic inventory script will cache results to avoid repeated API calls. To explicitly clear the cache, you can run the openstack.py (or hosts) script with the <code class="docutils literal"><span class="pre">--refresh</span></code> parameter:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">./openstack.py --refresh --list</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="other-inventory-scripts">
<span id="id3"></span><h5><a class="toc-backref" href="#id11">Other inventory scripts</a><a class="headerlink" href="#other-inventory-scripts" title="Permalink to this headline">¶</a></h5>
<p>In addition to Cobbler and EC2, inventory scripts are also available for:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">BSD Jails</span>
<span class="l l-Scalar l-Scalar-Plain">DigitalOcean</span>
<span class="l l-Scalar l-Scalar-Plain">Google Compute Engine</span>
<span class="l l-Scalar l-Scalar-Plain">Linode</span>
<span class="l l-Scalar l-Scalar-Plain">OpenShift</span>
<span class="l l-Scalar l-Scalar-Plain">OpenStack Nova</span>
<span class="l l-Scalar l-Scalar-Plain">Ovirt</span>
<span class="l l-Scalar l-Scalar-Plain">SpaceWalk</span>
<span class="l l-Scalar l-Scalar-Plain">Vagrant (not to be confused with the provisioner in vagrant, which is preferred)</span>
<span class="l l-Scalar l-Scalar-Plain">Zabbix</span>
</pre></div>
</div>
<p>Sections on how to use these in more detail will be added over time, but by looking at the &#8220;contrib/inventory&#8221; directory of the Ansible checkout
it should be very obvious how to use them.  The process for the AWS inventory script is the same.</p>
<p>If you develop an interesting inventory script that might be general purpose, please submit a pull request &#8211; we&#8217;d likely be glad
to include it in the project.</p>
</div>
<div class="section" id="using-inventory-directories-and-multiple-inventory-sources">
<span id="using-multiple-sources"></span><h5><a class="toc-backref" href="#id12">Using Inventory Directories and Multiple Inventory Sources</a><a class="headerlink" href="#using-inventory-directories-and-multiple-inventory-sources" title="Permalink to this headline">¶</a></h5>
<p>If the location given to <code class="docutils literal"><span class="pre">-i</span></code> in Ansible is a directory (or as so configured in <code class="docutils literal"><span class="pre">ansible.cfg</span></code>), Ansible can use multiple inventory sources
at the same time.  When doing so, it is possible to mix both dynamic and statically managed inventory sources in the same ansible run.  Instant
hybrid cloud!</p>
<p>In an inventory directory, executable files will be treated as dynamic inventory sources and most other files as static sources. Files which end with any of the following will be ignored:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">~, .orig, .bak, .ini, .cfg, .retry, .pyc, .pyo</span>
</pre></div>
</div>
<p>You can replace this list with your own selection by configuring an <code class="docutils literal"><span class="pre">inventory_ignore_extensions</span></code> list in ansible.cfg, or setting the <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_INVENTORY_IGNORE</span></code> environment variable. The value in either case should be a comma-separated list of patterns, as shown above.</p>
<p>Any <code class="docutils literal"><span class="pre">group_vars</span></code> and <code class="docutils literal"><span class="pre">host_vars</span></code> subdirectories in an inventory directory will be interpreted as expected, making inventory directories a powerful way to organize different sets of configurations.</p>
</div>
<div class="section" id="static-groups-of-dynamic-groups">
<span id="static-groups-of-dynamic"></span><h5><a class="toc-backref" href="#id13">Static Groups of Dynamic Groups</a><a class="headerlink" href="#static-groups-of-dynamic-groups" title="Permalink to this headline">¶</a></h5>
<p>When defining groups of groups in the static inventory file, the child groups
must also be defined in the static inventory file, or ansible will return an
error. If you want to define a static group of dynamic child groups, define
the dynamic groups as empty in the static inventory file. For example:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">tag_Name_staging_foo</span><span class="p p-Indicator">]</span>

<span class="p p-Indicator">[</span><span class="nv">tag_Name_staging_bar</span><span class="p p-Indicator">]</span>

<span class="p p-Indicator">[</span><span class="nv">staging</span><span class="p p-Indicator">:</span><span class="nv">children</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">tag_Name_staging_foo</span>
<span class="l l-Scalar l-Scalar-Plain">tag_Name_staging_bar</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a></dt>
<dd>All about static inventory files</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-intro_patterns"></span><div class="section" id="patterns">
<h4><a class="toc-backref" href="#id1">Patterns</a><a class="headerlink" href="#patterns" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#patterns" id="id1">Patterns</a></li>
</ul>
</div>
<p>Patterns in Ansible are how we decide which hosts to manage.  This can mean what hosts to communicate with, but in terms
of <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a> it actually means what hosts to apply a particular configuration or IT process to.</p>
<p>We&#8217;ll go over how to use the command line in <a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a> section, however, basically it looks like this:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible &lt;pattern_goes_here&gt; -m &lt;module_name&gt; -a &lt;arguments&gt;</span>
</pre></div>
</div>
<p>Such as:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible webservers -m service -a &quot;name=httpd state=restarted&quot;</span>
</pre></div>
</div>
<p>A pattern usually refers to a set of groups (which are sets of hosts) &#8211; in the above case, machines in the &#8220;webservers&#8221; group.</p>
<p>Anyway, to use Ansible, you&#8217;ll first need to know how to tell Ansible which hosts in your inventory to talk to.
This is done by designating particular host names or groups of hosts.</p>
<p>The following patterns are equivalent and target all hosts in the inventory:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">all</span>
<span class="l l-Scalar l-Scalar-Plain">*</span>
</pre></div>
</div>
<p>It is also possible to address a specific host or set of hosts by name:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">one.example.com</span>
<span class="l l-Scalar l-Scalar-Plain">one.example.com:two.example.com</span>
<span class="l l-Scalar l-Scalar-Plain">192.0.2.50</span>
<span class="l l-Scalar l-Scalar-Plain">192.0.2.*</span>
</pre></div>
</div>
<p>The following patterns address one or more groups.  Groups separated by a colon indicate an &#8220;OR&#8221; configuration.
This means the host may be in either one group or the other:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<span class="l l-Scalar l-Scalar-Plain">webservers:dbservers</span>
</pre></div>
</div>
<p>You can exclude groups as well, for instance, all machines must be in the group webservers but not in the group phoenix:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">webservers:!phoenix</span>
</pre></div>
</div>
<p>You can also specify the intersection of two groups.  This would mean the hosts must be in the group webservers and
the host must also be in the group staging:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">webservers:&amp;staging</span>
</pre></div>
</div>
<p>You can do combinations:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">webservers:dbservers:&amp;staging:!phoenix</span>
</pre></div>
</div>
<p>The above configuration means &#8220;all machines in the groups &#8216;webservers&#8217; and &#8216;dbservers&#8217; are to be managed if they are in
the group &#8216;staging&#8217; also, but the machines are not to be managed if they are in the group &#8216;phoenix&#8217; ... whew!</p>
<p>You can also use variables if you want to pass some group specifiers via the &#8220;-e&#8221; argument to ansible-playbook, but this
is uncommonly used:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">webservers:!</span><span class="cp">{{</span><span class="nv">excluded</span><span class="cp">}}</span><span class="l l-Scalar l-Scalar-Plain">:&amp;</span><span class="cp">{{</span><span class="nv">required</span><span class="cp">}}</span>
</pre></div>
</div>
<p>You also don&#8217;t have to manage by strictly defined groups.  Individual host names, IPs and groups, can also be referenced using
wildcards</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>*.example.com
*.com
</pre></div>
</div>
<p>It&#8217;s also ok to mix wildcard patterns and groups at the same time:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">one*.com:dbservers</span>
</pre></div>
</div>
<p>You can select a host or subset of hosts from a group by their position. For example, given the following group:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">webservers</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">cobweb</span>
<span class="l l-Scalar l-Scalar-Plain">webbing</span>
<span class="l l-Scalar l-Scalar-Plain">weber</span>
</pre></div>
</div>
<p>You can refer to hosts within the group by adding a subscript to the group name:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">webservers[0]</span>       <span class="c1"># == cobweb</span>
<span class="l l-Scalar l-Scalar-Plain">webservers[-1]</span>      <span class="c1"># == weber</span>
<span class="l l-Scalar l-Scalar-Plain">webservers[0:1]</span>     <span class="c1"># == webservers[0],webservers[1]</span>
                    <span class="c1"># == cobweb,webbing</span>
<span class="l l-Scalar l-Scalar-Plain">webservers[1:]</span>      <span class="c1"># == webbing,weber</span>
</pre></div>
</div>
<p>Most people don&#8217;t specify patterns as regular expressions, but you can.  Just start the pattern with a &#8216;~&#8217;:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">~(web|db).*\.example\.com</span>
</pre></div>
</div>
<p>While we&#8217;re jumping a bit ahead, additionally, you can add an exclusion criteria just by supplying the <code class="docutils literal"><span class="pre">--limit</span></code> flag to /usr/bin/ansible or /usr/bin/ansible-playbook:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook site.yml --limit datacenter2</span>
</pre></div>
</div>
<p>And if you want to read the list of hosts from a file, prefix the file name with &#8216;&#64;&#8217;.  Since Ansible 1.2:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook site.yml --limit @retry_hosts.txt</span>
</pre></div>
</div>
<p>Easy enough.  See <a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a> and then <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a> for how to apply this knowledge.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">With the exception of version 1.9, you can use &#8216;,&#8217; instead of &#8216;:&#8217; as a host list separator. The &#8216;,&#8217; is preferred specially when dealing with ranges and ipv6.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As of 2.0 the &#8216;;&#8217; is deprecated as a host list separator.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Learning ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-intro_adhoc"></span><div class="section" id="introduction-to-ad-hoc-commands">
<h4><a class="toc-backref" href="#id7">Introduction To Ad-Hoc Commands</a><a class="headerlink" href="#introduction-to-ad-hoc-commands" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction-to-ad-hoc-commands" id="id7">Introduction To Ad-Hoc Commands</a><ul>
<li><a class="reference internal" href="#parallelism-and-shell-commands" id="id8">Parallelism and Shell Commands</a></li>
<li><a class="reference internal" href="#file-transfer" id="id9">File Transfer</a></li>
<li><a class="reference internal" href="#managing-packages" id="id10">Managing Packages</a></li>
<li><a class="reference internal" href="#users-and-groups" id="id11">Users and Groups</a></li>
<li><a class="reference internal" href="#deploying-from-source-control" id="id12">Deploying From Source Control</a></li>
<li><a class="reference internal" href="#managing-services" id="id13">Managing Services</a></li>
<li><a class="reference internal" href="#time-limited-background-operations" id="id14">Time Limited Background Operations</a></li>
<li><a class="reference internal" href="#gathering-facts" id="id15">Gathering Facts</a></li>
</ul>
</li>
</ul>
</div>
<p>The following examples show how to use <cite>/usr/bin/ansible</cite> for running
ad hoc tasks.</p>
<p>What&#8217;s an ad-hoc command?</p>
<p>An ad-hoc command is something that you might type in to do something really
quick, but don&#8217;t want to save for later.</p>
<p>This is a good place to start to understand the basics of what Ansible can do
prior to learning the playbooks language &#8211; ad-hoc commands can also be used
to do quick things that you might not necessarily want to write a full playbook for.</p>
<p>Generally speaking, the true power of Ansible lies in playbooks.
Why would you use ad-hoc tasks versus playbooks?</p>
<p>For instance, if you wanted to power off all of your lab for Christmas vacation,
you could execute a quick one-liner in Ansible without writing a playbook.</p>
<p>For configuration management and deployments, though, you&#8217;ll want to pick up on
using &#8216;/usr/bin/ansible-playbook&#8217; &#8211; the concepts you will learn here will
port over directly to the playbook language.</p>
<p>(See <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a> for more information about those)</p>
<p>If you haven&#8217;t read <a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a> already, please look that over a bit first
and then we&#8217;ll get going.</p>
<div class="section" id="parallelism-and-shell-commands">
<span id="id1"></span><h5><a class="toc-backref" href="#id8">Parallelism and Shell Commands</a><a class="headerlink" href="#parallelism-and-shell-commands" title="Permalink to this headline">¶</a></h5>
<p>Arbitrary example.</p>
<p>Let&#8217;s use Ansible&#8217;s command line tool to reboot all web servers in Atlanta, 10 at a time.  First, let&#8217;s
set up SSH-agent so it can remember our credentials:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ssh-agent bash
$ ssh-add ~/.ssh/id_rsa
</pre></div>
</div>
<p>If you don&#8217;t want to use ssh-agent and want to instead SSH with a
password instead of keys, you can with <code class="docutils literal"><span class="pre">--ask-pass</span></code> (<code class="docutils literal"><span class="pre">-k</span></code>), but
it&#8217;s much better to just use ssh-agent.</p>
<p>Now to run the command on all servers in a group, in this case,
<em>atlanta</em>, in 10 parallel forks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible atlanta -a <span class="s2">&quot;/sbin/reboot&quot;</span> -f <span class="m">10</span>
</pre></div>
</div>
<p>/usr/bin/ansible will default to running from your user account.  If you do not like this
behavior, pass in &#8220;-u username&#8221;.  If you want to run commands as a different user, it looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible atlanta -a <span class="s2">&quot;/usr/bin/foo&quot;</span> -u username
</pre></div>
</div>
<p>Often you&#8217;ll not want to just do things from your user account.  If you want to run commands through privilege escalation:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible atlanta -a <span class="s2">&quot;/usr/bin/foo&quot;</span> -u username --become <span class="o">[</span>--ask-become-pass<span class="o">]</span>
</pre></div>
</div>
<p>Use <code class="docutils literal"><span class="pre">--ask-become-pass</span></code> (<code class="docutils literal"><span class="pre">-K</span></code>) if you are not using a passwordless privilege escalation method (sudo/su/pfexec/doas/etc).
This will interactively prompt you for the password to use.
Use of a passwordless setup makes things easier to automate, but it&#8217;s not required.</p>
<p>It is also possible to become a user other than root using
<code class="docutils literal"><span class="pre">--become-user</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible atlanta -a <span class="s2">&quot;/usr/bin/foo&quot;</span> -u username --become-user otheruser <span class="o">[</span>--ask-become-pass<span class="o">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Rarely, some users have security rules where they constrain their sudo/pbrun/doas environment to running specific command paths only.
This does not work with ansible&#8217;s no-bootstrapping philosophy and hundreds of different modules.
If doing this, use Ansible from a special account that does not have this constraint.
One way of doing this without sharing access to unauthorized users would be gating Ansible with <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a>, which
can hold on to an SSH credential and let members of certain organizations use it on their behalf without having direct access.</p>
</div>
<p>Ok, so those are basics.  If you didn&#8217;t read about patterns and groups yet, go back and read <a class="reference internal" href="index.html#document-intro_patterns"><span class="doc">Patterns</span></a>.</p>
<p>The <code class="docutils literal"><span class="pre">-f</span> <span class="pre">10</span></code> in the above specifies the usage of 10 simultaneous
processes to use.   You can also set this in <a class="reference internal" href="index.html#document-intro_configuration"><span class="doc">Configuration file</span></a> to avoid setting it again.  The default is actually 5, which
is really small and conservative.  You are probably going to want to talk to a lot more simultaneous hosts so feel free
to crank this up.  If you have more hosts than the value set for the fork count, Ansible will talk to them, but it will
take a little longer.  Feel free to push this value as high as your system can handle!</p>
<p>You can also select what Ansible &#8220;module&#8221; you want to run.  Normally commands also take a <code class="docutils literal"><span class="pre">-m</span></code> for module name, but
the default module name is &#8216;command&#8217;, so we didn&#8217;t need to
specify that all of the time.  We&#8217;ll use <code class="docutils literal"><span class="pre">-m</span></code> in later examples to
run some other <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <span class="xref std std-ref">command</span> module does not support extended shell syntax like piping and redirects (although
shell variables will always work). If your command requires shell-specific syntax, use the <cite>shell</cite> module
instead. Read more about the differences on the <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> page.</p>
</div>
<p>Using the <span class="xref std std-ref">shell</span> module looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible raleigh -m shell -a <span class="s1">&#39;echo $TERM&#39;</span>
</pre></div>
</div>
<p>When running any command with the Ansible <em>ad hoc</em> CLI (as opposed to
<a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a>), pay particular attention to shell quoting rules, so
the local shell doesn&#8217;t eat a variable before it gets passed to Ansible.
For example, using double rather than single quotes in the above example would
evaluate the variable on the box you were on.</p>
<p>So far we&#8217;ve been demoing simple command execution, but most Ansible modules are not simple imperative scripts. Instead, they use a declarative model,
calculating and executing the actions required to reach a specified final state.
Furthermore, they achieve a form of idempotence by checking the current state
before they begin, and if the current state matches the specified final state,
doing nothing.
However, we also recognize that running arbitrary commands can be valuable, so Ansible easily supports both.</p>
</div>
<div class="section" id="file-transfer">
<span id="id2"></span><h5><a class="toc-backref" href="#id9">File Transfer</a><a class="headerlink" href="#file-transfer" title="Permalink to this headline">¶</a></h5>
<p>Here&#8217;s another use case for the <cite>/usr/bin/ansible</cite> command line.  Ansible can SCP lots of files to multiple machines in parallel.</p>
<p>To transfer a file directly to many servers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible atlanta -m copy -a <span class="s2">&quot;src=/etc/hosts dest=/tmp/hosts&quot;</span>
</pre></div>
</div>
<p>If you use playbooks, you can also take advantage of the <code class="docutils literal"><span class="pre">template</span></code> module,
which takes this another step further.  (See module and playbook documentation).</p>
<p>The <code class="docutils literal"><span class="pre">file</span></code> module allows changing ownership and permissions on files.  These
same options can be passed directly to the <code class="docutils literal"><span class="pre">copy</span></code> module as well:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m file -a <span class="s2">&quot;dest=/srv/foo/a.txt mode=600&quot;</span>
$ ansible webservers -m file -a <span class="s2">&quot;dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">file</span></code> module can also create directories, similar to <code class="docutils literal"><span class="pre">mkdir</span> <span class="pre">-p</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m file -a <span class="s2">&quot;dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory&quot;</span>
</pre></div>
</div>
<p>As well as delete directories (recursively) and delete files:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m file -a <span class="s2">&quot;dest=/path/to/c state=absent&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="managing-packages">
<span id="id3"></span><h5><a class="toc-backref" href="#id10">Managing Packages</a><a class="headerlink" href="#managing-packages" title="Permalink to this headline">¶</a></h5>
<p>There are modules available for yum and apt.  Here are some examples
with yum.</p>
<p>Ensure a package is installed, but don&#8217;t update it:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m yum -a <span class="s2">&quot;name=acme state=present&quot;</span>
</pre></div>
</div>
<p>Ensure a package is installed to a specific version:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m yum -a <span class="s2">&quot;name=acme-1.5 state=present&quot;</span>
</pre></div>
</div>
<p>Ensure a package is at the latest version:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m yum -a <span class="s2">&quot;name=acme state=latest&quot;</span>
</pre></div>
</div>
<p>Ensure a package is not installed:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m yum -a <span class="s2">&quot;name=acme state=absent&quot;</span>
</pre></div>
</div>
<p>Ansible has modules for managing packages under many platforms.  If there isn&#8217;t
a module for your package manager, you can install packages using the
command module or (better!) contribute a module for your package manager.
Stop by the mailing list for info/details.</p>
</div>
<div class="section" id="users-and-groups">
<span id="id4"></span><h5><a class="toc-backref" href="#id11">Users and Groups</a><a class="headerlink" href="#users-and-groups" title="Permalink to this headline">¶</a></h5>
<p>The &#8216;user&#8217; module allows easy creation and manipulation of
existing user accounts, as well as removal of user accounts that may
exist:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -m user -a <span class="s2">&quot;name=foo password=&lt;crypted password here&gt;&quot;</span>

$ ansible all -m user -a <span class="s2">&quot;name=foo state=absent&quot;</span>
</pre></div>
</div>
<p>See the <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> section for details on all of the available options, including
how to manipulate groups and group membership.</p>
</div>
<div class="section" id="deploying-from-source-control">
<span id="from-source-control"></span><h5><a class="toc-backref" href="#id12">Deploying From Source Control</a><a class="headerlink" href="#deploying-from-source-control" title="Permalink to this headline">¶</a></h5>
<p>Deploy your webapp straight from git:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m git -a <span class="s2">&quot;repo=git://foo.example.org/repo.git dest=/srv/myapp version=HEAD&quot;</span>
</pre></div>
</div>
<p>Since Ansible modules can notify change handlers it is possible to
tell Ansible to run specific tasks when the code is updated, such as
deploying Perl/Python/PHP/Ruby directly from git and then restarting
apache.</p>
</div>
<div class="section" id="managing-services">
<span id="id5"></span><h5><a class="toc-backref" href="#id13">Managing Services</a><a class="headerlink" href="#managing-services" title="Permalink to this headline">¶</a></h5>
<p>Ensure a service is started on all webservers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m service -a <span class="s2">&quot;name=httpd state=started&quot;</span>
</pre></div>
</div>
<p>Alternatively, restart a service on all webservers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m service -a <span class="s2">&quot;name=httpd state=restarted&quot;</span>
</pre></div>
</div>
<p>Ensure a service is stopped:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible webservers -m service -a <span class="s2">&quot;name=httpd state=stopped&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="time-limited-background-operations">
<span id="id6"></span><h5><a class="toc-backref" href="#id14">Time Limited Background Operations</a><a class="headerlink" href="#time-limited-background-operations" title="Permalink to this headline">¶</a></h5>
<p>Long running operations can be run in the background, and it is possible to
check their status later. For example, to execute <code class="docutils literal"><span class="pre">long_running_operation</span></code>
asynchronously in the background, with a timeout of 3600 seconds (<code class="docutils literal"><span class="pre">-B</span></code>),
and without polling (<code class="docutils literal"><span class="pre">-P</span></code>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -B <span class="m">3600</span> -P <span class="m">0</span> -a <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<p>If you do decide you want to check on the job status later, you can use the
async_status module, passing it the job id that was returned when you ran
the original job in the background:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible web1.example.com -m async_status -a <span class="s2">&quot;jid=488359678239.2844&quot;</span>
</pre></div>
</div>
<p>Polling is built-in and looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -B <span class="m">1800</span> -P <span class="m">60</span> -a <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<p>The above example says &#8220;run for 30 minutes max (<code class="docutils literal"><span class="pre">-B</span></code> 30*60=1800),
poll for status (<code class="docutils literal"><span class="pre">-P</span></code>) every 60 seconds&#8221;.</p>
<p>Poll mode is smart so all jobs will be started before polling will begin on any machine.
Be sure to use a high enough <code class="docutils literal"><span class="pre">--forks</span></code> value if you want to get all of your jobs started
very quickly. After the time limit (in seconds) runs out (<code class="docutils literal"><span class="pre">-B</span></code>), the process on
the remote nodes will be terminated.</p>
<p>Typically you&#8217;ll only be backgrounding long-running
shell commands or software upgrades.  Backgrounding the copy module does not do a background file transfer.  <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a> also support polling, and have a simplified syntax for this.</p>
</div>
<div class="section" id="gathering-facts">
<span id="checking-facts"></span><h5><a class="toc-backref" href="#id15">Gathering Facts</a><a class="headerlink" href="#gathering-facts" title="Permalink to this headline">¶</a></h5>
<p>Facts are described in the playbooks section and represent discovered variables about a
system.  These can be used to implement conditional execution of tasks but also just to get ad-hoc information about your system. You can see all facts via:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -m setup
</pre></div>
</div>
<p>It&#8217;s also possible to filter this output to just export certain facts, see the &#8220;setup&#8221; module documentation for details.</p>
<p>Read more about facts at <a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a> once you&#8217;re ready to read up on <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_configuration"><span class="doc">Configuration file</span></a></dt>
<dd>All about the Ansible config file</dd>
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>A list of available modules</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Using Ansible for configuration management &amp; deployment</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-intro_configuration"></span><div class="section" id="configuration-file">
<h4><a class="toc-backref" href="#id82">Configuration file</a><a class="headerlink" href="#configuration-file" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#configuration-file" id="id82">Configuration file</a><ul>
<li><a class="reference internal" href="#getting-the-latest-configuration" id="id83">Getting the latest configuration</a></li>
<li><a class="reference internal" href="#environmental-configuration" id="id84">Environmental configuration</a></li>
<li><a class="reference internal" href="#explanation-of-values-by-section" id="id85">Explanation of values by section</a><ul>
<li><a class="reference internal" href="#general-defaults" id="id86">General defaults</a><ul>
<li><a class="reference internal" href="#action-plugins" id="id87">action_plugins</a></li>
<li><a class="reference internal" href="#allow-unsafe-lookups" id="id88">allow_unsafe_lookups</a></li>
<li><a class="reference internal" href="#allow-world-readable-tmpfiles" id="id89">allow_world_readable_tmpfiles</a></li>
<li><a class="reference internal" href="#ansible-managed" id="id90">ansible_managed</a></li>
<li><a class="reference internal" href="#ask-pass" id="id91">ask_pass</a></li>
<li><a class="reference internal" href="#ask-sudo-pass" id="id92">ask_sudo_pass</a></li>
<li><a class="reference internal" href="#ask-vault-pass" id="id93">ask_vault_pass</a></li>
<li><a class="reference internal" href="#bin-ansible-callbacks" id="id94">bin_ansible_callbacks</a></li>
<li><a class="reference internal" href="#callback-plugins" id="id95">callback_plugins</a></li>
<li><a class="reference internal" href="#callback-whitelist" id="id96">callback_whitelist</a></li>
<li><a class="reference internal" href="#command-warnings" id="id97">command_warnings</a></li>
<li><a class="reference internal" href="#connection-plugins" id="id98">connection_plugins</a></li>
<li><a class="reference internal" href="#deprecation-warnings" id="id99">deprecation_warnings</a></li>
<li><a class="reference internal" href="#display-args-to-stdout" id="id100">display_args_to_stdout</a></li>
<li><a class="reference internal" href="#display-skipped-hosts" id="id101">display_skipped_hosts</a></li>
<li><a class="reference internal" href="#error-on-undefined-vars" id="id102">error_on_undefined_vars</a></li>
<li><a class="reference internal" href="#executable" id="id103">executable</a></li>
<li><a class="reference internal" href="#filter-plugins" id="id104">filter_plugins</a></li>
<li><a class="reference internal" href="#force-color" id="id105">force_color</a></li>
<li><a class="reference internal" href="#force-handlers" id="id106">force_handlers</a></li>
<li><a class="reference internal" href="#forks" id="id107">forks</a></li>
<li><a class="reference internal" href="#fact-caching" id="id108">fact_caching</a></li>
<li><a class="reference internal" href="#fact-caching-connection" id="id109">fact_caching_connection</a></li>
<li><a class="reference internal" href="#fact-caching-timeout" id="id110">fact_caching_timeout</a></li>
<li><a class="reference internal" href="#fact-path" id="id111">fact_path</a></li>
<li><a class="reference internal" href="#gathering" id="id112">gathering</a></li>
<li><a class="reference internal" href="#hash-behaviour" id="id113">hash_behaviour</a></li>
<li><a class="reference internal" href="#hostfile" id="id114">hostfile</a></li>
<li><a class="reference internal" href="#host-key-checking" id="id115">host_key_checking</a></li>
<li><a class="reference internal" href="#internal-poll-interval" id="id116">internal_poll_interval</a></li>
<li><a class="reference internal" href="#inventory" id="id117">inventory</a></li>
<li><a class="reference internal" href="#inventory-ignore-extensions" id="id118">inventory_ignore_extensions</a></li>
<li><a class="reference internal" href="#jinja2-extensions" id="id119">jinja2_extensions</a></li>
<li><a class="reference internal" href="#library" id="id120">library</a></li>
<li><a class="reference internal" href="#local-tmp" id="id121">local_tmp</a></li>
<li><a class="reference internal" href="#log-path" id="id122">log_path</a></li>
<li><a class="reference internal" href="#lookup-plugins" id="id123">lookup_plugins</a></li>
<li><a class="reference internal" href="#merge-multiple-cli-tags" id="id124">merge_multiple_cli_tags</a></li>
<li><a class="reference internal" href="#module-lang" id="id125">module_lang</a></li>
<li><a class="reference internal" href="#module-name" id="id126">module_name</a></li>
<li><a class="reference internal" href="#module-set-locale" id="id127">module_set_locale</a></li>
<li><a class="reference internal" href="#module-utils" id="id128">module_utils</a></li>
<li><a class="reference internal" href="#nocolor" id="id129">nocolor</a></li>
<li><a class="reference internal" href="#nocows" id="id130">nocows</a></li>
<li><a class="reference internal" href="#pattern" id="id131">pattern</a></li>
<li><a class="reference internal" href="#poll-interval" id="id132">poll_interval</a></li>
<li><a class="reference internal" href="#private-key-file" id="id133">private_key_file</a></li>
<li><a class="reference internal" href="#remote-port" id="id134">remote_port</a></li>
<li><a class="reference internal" href="#remote-tmp" id="id135">remote_tmp</a></li>
<li><a class="reference internal" href="#remote-user" id="id136">remote_user</a></li>
<li><a class="reference internal" href="#restrict-facts-namespace" id="id137">restrict_facts_namespace</a></li>
<li><a class="reference internal" href="#retry-files-enabled" id="id138">retry_files_enabled</a></li>
<li><a class="reference internal" href="#retry-files-save-path" id="id139">retry_files_save_path</a></li>
<li><a class="reference internal" href="#roles-path" id="id140">roles_path</a></li>
<li><a class="reference internal" href="#squash-actions" id="id141">squash_actions</a></li>
<li><a class="reference internal" href="#stdout-callback" id="id142">stdout_callback</a></li>
<li><a class="reference internal" href="#strategy-plugins" id="id143">strategy_plugins</a></li>
<li><a class="reference internal" href="#strategy" id="id144">strategy</a></li>
<li><a class="reference internal" href="#sudo-exe" id="id145">sudo_exe</a></li>
<li><a class="reference internal" href="#sudo-flags" id="id146">sudo_flags</a></li>
<li><a class="reference internal" href="#sudo-user" id="id147">sudo_user</a></li>
<li><a class="reference internal" href="#system-warnings" id="id148">system_warnings</a></li>
<li><a class="reference internal" href="#timeout" id="id149">timeout</a></li>
<li><a class="reference internal" href="#transport" id="id150">transport</a></li>
<li><a class="reference internal" href="#vars-plugins" id="id151">vars_plugins</a></li>
<li><a class="reference internal" href="#vault-password-file" id="id152">vault_password_file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#privilege-escalation-settings" id="id153">Privilege Escalation Settings</a><ul>
<li><a class="reference internal" href="#become" id="id154">become</a></li>
<li><a class="reference internal" href="#become-method" id="id155">become_method</a></li>
<li><a class="reference internal" href="#become-user" id="id156">become_user</a></li>
<li><a class="reference internal" href="#become-ask-pass" id="id157">become_ask_pass</a></li>
<li><a class="reference internal" href="#become-allow-same-user" id="id158">become_allow_same_user</a></li>
</ul>
</li>
<li><a class="reference internal" href="#paramiko-specific-settings" id="id159">Paramiko Specific Settings</a><ul>
<li><a class="reference internal" href="#record-host-keys" id="id160">record_host_keys</a></li>
<li><a class="reference internal" href="#proxy-command" id="id161">proxy_command</a></li>
</ul>
</li>
<li><a class="reference internal" href="#openssh-specific-settings" id="id162">OpenSSH Specific Settings</a><ul>
<li><a class="reference internal" href="#ssh-args" id="id163">ssh_args</a></li>
<li><a class="reference internal" href="#control-path" id="id164">control_path</a></li>
<li><a class="reference internal" href="#control-path-dir" id="id165">control_path_dir</a></li>
<li><a class="reference internal" href="#retries" id="id166">retries</a></li>
<li><a class="reference internal" href="#scp-if-ssh" id="id167">scp_if_ssh</a></li>
<li><a class="reference internal" href="#pipelining" id="id168">pipelining</a></li>
<li><a class="reference internal" href="#ssh-executable" id="id169">ssh_executable</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accelerated-mode-settings" id="id170">Accelerated Mode Settings</a><ul>
<li><a class="reference internal" href="#accelerate-port" id="id171">accelerate_port</a></li>
<li><a class="reference internal" href="#accelerate-timeout" id="id172">accelerate_timeout</a></li>
<li><a class="reference internal" href="#accelerate-connect-timeout" id="id173">accelerate_connect_timeout</a></li>
<li><a class="reference internal" href="#accelerate-daemon-timeout" id="id174">accelerate_daemon_timeout</a></li>
<li><a class="reference internal" href="#accelerate-multi-key" id="id175">accelerate_multi_key</a></li>
</ul>
</li>
<li><a class="reference internal" href="#selinux-specific-settings" id="id176">Selinux Specific Settings</a><ul>
<li><a class="reference internal" href="#special-context-filesystems" id="id177">special_context_filesystems</a></li>
<li><a class="reference internal" href="#libvirt-lxc-noseclabel" id="id178">libvirt_lxc_noseclabel</a></li>
<li><a class="reference internal" href="#show-custom-stats" id="id179">show_custom_stats</a></li>
</ul>
</li>
<li><a class="reference internal" href="#galaxy-settings" id="id180">Galaxy Settings</a><ul>
<li><a class="reference internal" href="#server" id="id181">server</a></li>
<li><a class="reference internal" href="#ignore-certs" id="id182">ignore_certs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>Certain settings in Ansible are adjustable via a configuration file.  The stock configuration should be sufficient
for most users, but there may be reasons you would want to change them.</p>
<p>Changes can be made and used in a configuration file which will be processed in the following order:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>* ANSIBLE_CONFIG <span class="o">(</span>an environment variable<span class="o">)</span>
* ansible.cfg <span class="o">(</span>in the current directory<span class="o">)</span>
* .ansible.cfg <span class="o">(</span>in the home directory<span class="o">)</span>
* /etc/ansible/ansible.cfg
</pre></div>
</div>
<p>Prior to 1.5 the order was:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>* ansible.cfg <span class="o">(</span>in the current directory<span class="o">)</span>
* ANSIBLE_CONFIG <span class="o">(</span>an environment variable<span class="o">)</span>
* .ansible.cfg <span class="o">(</span>in the home directory<span class="o">)</span>
* /etc/ansible/ansible.cfg
</pre></div>
</div>
<p>Ansible will process the above list and use the first file found. Settings in files are not merged.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Comments
The configuration file is one variant of an INI format.  Both the hash
sign (&#8220;#&#8221;) and semicolon (&#8221;;&#8221;) are allowed as comment markers when the
comment starts the line.  However, if the comment is inline with regular
values, only the semicolon is allowed to introduce the comment.  For
instance:</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># some basic default values...</span>
<span class="nv">inventory</span> <span class="o">=</span> /etc/ansible/hosts  <span class="p">;</span> This points to the file that lists your hosts
</pre></div>
</div>
</div>
<div class="section" id="getting-the-latest-configuration">
<span id="id1"></span><h5><a class="toc-backref" href="#id83">Getting the latest configuration</a><a class="headerlink" href="#getting-the-latest-configuration" title="Permalink to this headline">¶</a></h5>
<p>If installing ansible from a package manager, the latest ansible.cfg should be present in /etc/ansible, possibly
as a &#8221;.rpmnew&#8221; file (or other) as appropriate in the case of updates.</p>
<p>If you have installed from pip or from source, however, you may want to create this file in order to override
default settings in Ansible.</p>
<p>You may wish to consult the <a class="reference external" href="https://raw.github.com/ansible/ansible/devel/examples/ansible.cfg">ansible.cfg in source control</a> for all of the possible latest values.</p>
</div>
<div class="section" id="environmental-configuration">
<span id="id2"></span><h5><a class="toc-backref" href="#id84">Environmental configuration</a><a class="headerlink" href="#environmental-configuration" title="Permalink to this headline">¶</a></h5>
<p>Ansible also allows configuration of settings via environment variables.  If
these environment variables are set, they will override any setting loaded
from the configuration file.  These variables are defined in <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/constants.py">constants.py</a>.</p>
</div>
<div class="section" id="explanation-of-values-by-section">
<span id="config-values-by-section"></span><h5><a class="toc-backref" href="#id85">Explanation of values by section</a><a class="headerlink" href="#explanation-of-values-by-section" title="Permalink to this headline">¶</a></h5>
<p>The configuration file is broken up into sections.  Most options are in the &#8220;general&#8221; section but some sections of the file
are specific to certain connection types.</p>
<div class="section" id="general-defaults">
<span id="id3"></span><h6><a class="toc-backref" href="#id86">General defaults</a><a class="headerlink" href="#general-defaults" title="Permalink to this headline">¶</a></h6>
<p>In the [defaults] section of ansible.cfg, the following settings are tunable:</p>
<div class="section" id="action-plugins">
<span id="cfg-action-plugins"></span><h7><a class="toc-backref" href="#id87">action_plugins</a><a class="headerlink" href="#action-plugins" title="Permalink to this headline">¶</a></h7>
<p>Actions are pieces of code in ansible that enable things like module execution, templating, and so forth.</p>
<p>This is a developer-centric feature that allows low-level extensions around Ansible to be loaded from
different locations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">action_plugins</span> <span class="o">=</span> ~/.ansible/plugins/action_plugins/:/usr/share/ansible_plugins/action_plugins
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for more details.</p>
</div>
<div class="section" id="allow-unsafe-lookups">
<span id="id4"></span><h7><a class="toc-backref" href="#id88">allow_unsafe_lookups</a><a class="headerlink" href="#allow-unsafe-lookups" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.3,: </span>2.3.1</p>
</div>
<p>When enabled, this option allows lookup plugins (whether used in variables as <cite>{{lookup(&#8216;foo&#8217;)}}</cite> or as a loop as <cite>with_foo</cite>) to return data that is <strong>not</strong> marked &#8220;unsafe&#8221;. By default, such data is marked as unsafe to prevent the templating engine from evaluating any jinja2 templating language, as this could represent a security risk.</p>
<p>This option is provided to allow for backwards-compatibility, however users should first consider adding <cite>allow_unsafe=True</cite> to any lookups which may be expected to contain data which may be run through the templating engine later. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span>lookup<span class="o">(</span><span class="s1">&#39;pipe&#39;</span>, <span class="s1">&#39;/path/to/some/command&#39;</span>, <span class="nv">allow_unsafe</span><span class="o">=</span>True<span class="o">)}}</span>
</pre></div>
</div>
</div>
<div class="section" id="allow-world-readable-tmpfiles">
<span id="id5"></span><h7><a class="toc-backref" href="#id89">allow_world_readable_tmpfiles</a><a class="headerlink" href="#allow-world-readable-tmpfiles" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>This makes the temporary files created on the machine to be world readable and will issue a warning instead of failing the task.</p>
<p>It is useful when becoming an unprivileged user:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">allow_world_readable_tmpfiles</span><span class="o">=</span>True
</pre></div>
</div>
</div>
<div class="section" id="ansible-managed">
<span id="id6"></span><h7><a class="toc-backref" href="#id90">ansible_managed</a><a class="headerlink" href="#ansible-managed" title="Permalink to this headline">¶</a></h7>
<p>The <code class="docutils literal"><span class="pre">ansible_managed</span></code> string can be inserted into files written by
Ansible&#8217;s config templating system:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_managed <span class="o">}}</span>
</pre></div>
</div>
<p>The default value indicates that Ansible is managing a file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ansible_managed</span> <span class="o">=</span> Ansible managed
</pre></div>
</div>
<p>This string can be helpful to indicate that a file should not
be directly edited because Ansible may overwrite the contents of the file.</p>
<p>There are several special placeholder values that can be placed in the <code class="docutils literal"><span class="pre">ansible_managed</span></code> string.  These are not in the default <code class="docutils literal"><span class="pre">ansible_managed</span></code> string because they can cause Ansible to behave as though the
entire template has changed when only the ansible_managed string has
changed.</p>
<p>These placeholder values, along with the situations which can lead Ansible to
report a template as changed when they are used, are listed below:</p>
<ul class="simple">
<li>Standard directives that can be used with :func:~time.strftime:.
The time referred to is the modification time of the template file.  Many
revision control systems timestamp files according to when they are checked
out, not the last time the file was modified.  That means Ansible will think
the file has been modified anytime there is a fresh checkout.</li>
</ul>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">{file}</span></code>: expands to the name of the full path to the template file.  If
Ansible is run with multiple checkouts of the same configuration repository
(for instance, in each sysadmin&#8217;s home directory), then the path will differ
in each checkout causing Ansible to behave as though the file has been modified.</li>
<li><code class="docutils literal"><span class="pre">{host}</span></code>: expands to the hostname of the machine <strong class="program">ansible</strong> is run
on.  If <strong class="program">ansible</strong> is invoked on multiple machines (for instance,
each sysadmin can checkout the configuration repository on their workstation
and run <strong class="program">ansible</strong> there), then the host will vary on each of these
machines.  This will cause Ansible to behave as though the file has been modified.</li>
<li><code class="docutils literal"><span class="pre">{uid}</span></code>: expands to the owner of the template file.  If Ansible is run
on checkouts of the configuration repository made by separate users (for
instance, if multiple system administrators are making checkouts of the
repository with their own accounts) then this will cause Ansible to behave as if
the file has been modified.</li>
</ul>
</div>
<div class="section" id="ask-pass">
<span id="id7"></span><h7><a class="toc-backref" href="#id91">ask_pass</a><a class="headerlink" href="#ask-pass" title="Permalink to this headline">¶</a></h7>
<p>This controls whether an Ansible playbook should prompt for a password by default.  The default behavior is no:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ask_pass</span> <span class="o">=</span> True
</pre></div>
</div>
<p>If using SSH keys for authentication, it&#8217;s probably not needed to change this setting.</p>
</div>
<div class="section" id="ask-sudo-pass">
<span id="id8"></span><h7><a class="toc-backref" href="#id92">ask_sudo_pass</a><a class="headerlink" href="#ask-sudo-pass" title="Permalink to this headline">¶</a></h7>
<p>Similar to ask_pass, this controls whether an Ansible playbook should prompt for a sudo password by default when
sudoing.  The default behavior is also no:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ask_sudo_pass</span> <span class="o">=</span> True
</pre></div>
</div>
<p>Users on platforms where sudo passwords are enabled should consider changing this setting.</p>
</div>
<div class="section" id="ask-vault-pass">
<span id="id9"></span><h7><a class="toc-backref" href="#id93">ask_vault_pass</a><a class="headerlink" href="#ask-vault-pass" title="Permalink to this headline">¶</a></h7>
<p>This controls whether an Ansible playbook should prompt for the vault password by default.  The default behavior is no:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ask_vault_pass</span> <span class="o">=</span> True
</pre></div>
</div>
</div>
<div class="section" id="bin-ansible-callbacks">
<span id="id10"></span><h7><a class="toc-backref" href="#id94">bin_ansible_callbacks</a><a class="headerlink" href="#bin-ansible-callbacks" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>Controls whether callback plugins are loaded when running /usr/bin/ansible.  This may be used to log activity from
the command line, send notifications, and so on.  Callback plugins are always loaded for /usr/bin/ansible-playbook
if present and cannot be disabled:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">bin_ansible_callbacks</span> <span class="o">=</span> False
</pre></div>
</div>
<p>Prior to 1.8, callbacks were never loaded for /usr/bin/ansible.</p>
</div>
<div class="section" id="callback-plugins">
<span id="id11"></span><h7><a class="toc-backref" href="#id95">callback_plugins</a><a class="headerlink" href="#callback-plugins" title="Permalink to this headline">¶</a></h7>
<p>Callbacks are pieces of code in ansible that get called on specific events, permitting to trigger notifications.</p>
<p>This is a developer-centric feature that allows low-level extensions around Ansible to be loaded from
different locations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">callback_plugins</span> <span class="o">=</span> ~/.ansible/plugins/callback:/usr/share/ansible/plugins/callback
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for more details</p>
</div>
<div class="section" id="callback-whitelist">
<span id="id12"></span><h7><a class="toc-backref" href="#id96">callback_whitelist</a><a class="headerlink" href="#callback-whitelist" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>Now ansible ships with all included callback plugins ready to use but they are disabled by default.
This setting lets you enable a list of additional callbacks. This cannot change or override the
default stdout callback, use <a class="reference internal" href="#stdout-callback"><span class="std std-ref">stdout_callback</span></a> for that:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">callback_whitelist</span> <span class="o">=</span> timer,mail
</pre></div>
</div>
</div>
<div class="section" id="command-warnings">
<span id="id13"></span><h7><a class="toc-backref" href="#id97">command_warnings</a><a class="headerlink" href="#command-warnings" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>By default since Ansible 1.8, Ansible will issue a warning when the shell or
command module is used and the command appears to be similar to an existing
Ansible module. For example, this can include reminders to use the &#8216;git&#8217; module
instead of shell commands to execute &#8216;git&#8217;.  Using modules when possible over
arbitrary shell commands can lead to more reliable and consistent playbook runs,
and also easier to maintain playbooks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">command_warnings</span> <span class="o">=</span> False
</pre></div>
</div>
<p>These warnings can be silenced by adjusting the following
setting or adding warn=yes or warn=no to the end of the command line
parameter string, like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: usage of git that could be replaced with the git module
  shell: git update foo <span class="nv">warn</span><span class="o">=</span>yes
</pre></div>
</div>
</div>
<div class="section" id="connection-plugins">
<span id="id14"></span><h7><a class="toc-backref" href="#id98">connection_plugins</a><a class="headerlink" href="#connection-plugins" title="Permalink to this headline">¶</a></h7>
<p>Connections plugin permit to extend the channel used by ansible to transport commands and files.</p>
<p>This is a developer-centric feature that allows low-level extensions around Ansible to be loaded from
different locations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">connection_plugins</span> <span class="o">=</span> ~/.ansible/plugins/connection_plugins/:/usr/share/ansible_plugins/connection_plugins
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for more details</p>
</div>
<div class="section" id="deprecation-warnings">
<span id="id15"></span><h7><a class="toc-backref" href="#id99">deprecation_warnings</a><a class="headerlink" href="#deprecation-warnings" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>Allows disabling of deprecating warnings in ansible-playbook output:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">deprecation_warnings</span> <span class="o">=</span> True
</pre></div>
</div>
<p>Deprecation warnings indicate usage of legacy features that are slated for removal in a future release of Ansible.</p>
</div>
<div class="section" id="display-args-to-stdout">
<span id="id16"></span><h7><a class="toc-backref" href="#id100">display_args_to_stdout</a><a class="headerlink" href="#display-args-to-stdout" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.0.</span></p>
</div>
<p>By default, ansible-playbook will print a header for each task that is run to
stdout.  These headers will contain the <code class="docutils literal"><span class="pre">name:</span></code> field from the task if you
specified one.  If you didn&#8217;t then ansible-playbook uses the task&#8217;s action to
help you tell which task is presently running.  Sometimes you run many of the
same action and so you want more information about the task to differentiate
it from others of the same action.  If you set this variable to <code class="docutils literal"><span class="pre">True</span></code> in
the config then ansible-playbook will also include the task&#8217;s arguments in the
header.</p>
<p>This setting defaults to <code class="docutils literal"><span class="pre">False</span></code> because there is a chance that you have
sensitive values in your parameters and do not want those to be printed to
stdout:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">display_args_to_stdout</span> <span class="o">=</span> False
</pre></div>
</div>
<p>If you set this to <code class="docutils literal"><span class="pre">True</span></code> you should be sure that you have secured your
environment&#8217;s stdout (no one can shoulder surf your screen and you aren&#8217;t
saving stdout to an insecure file) or made sure that all of your playbooks
explicitly added the <code class="docutils literal"><span class="pre">no_log:</span> <span class="pre">True</span></code> parameter to tasks which have sensistive
values   See <a class="reference internal" href="index.html#keep-secret-data"><span class="std std-ref">How do I keep secret data in my playbook?</span></a> for more information.</p>
</div>
<div class="section" id="display-skipped-hosts">
<span id="id17"></span><h7><a class="toc-backref" href="#id101">display_skipped_hosts</a><a class="headerlink" href="#display-skipped-hosts" title="Permalink to this headline">¶</a></h7>
<p>If set to <cite>False</cite>, ansible will not display any status for a task that is skipped. The default behavior is to display skipped tasks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">display_skipped_hosts</span> <span class="o">=</span> True
</pre></div>
</div>
<p>Note that Ansible will always show the task header for any task, regardless of whether or not the task is skipped.</p>
</div>
<div class="section" id="error-on-undefined-vars">
<span id="id18"></span><h7><a class="toc-backref" href="#id102">error_on_undefined_vars</a><a class="headerlink" href="#error-on-undefined-vars" title="Permalink to this headline">¶</a></h7>
<p>On by default since Ansible 1.3, this causes ansible to fail steps that reference variable names that are likely
typoed:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">error_on_undefined_vars</span> <span class="o">=</span> True
</pre></div>
</div>
<p>If set to False, any &#8216;{{ template_expression }}&#8217; that contains undefined variables will be rendered in a template
or ansible action line exactly as written.</p>
</div>
<div class="section" id="executable">
<span id="id19"></span><h7><a class="toc-backref" href="#id103">executable</a><a class="headerlink" href="#executable" title="Permalink to this headline">¶</a></h7>
<p>This indicates the command to use to spawn a shell under a sudo environment.  Users may need to change this to /bin/bash in rare instances when sudo is constrained, but in most cases it may be left as is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">executable</span> <span class="o">=</span> /bin/bash
</pre></div>
</div>
<p>Starting in version 2.1 this can be overridden by the inventory var <code class="docutils literal"><span class="pre">ansible_shell_executable</span></code>.</p>
</div>
<div class="section" id="filter-plugins">
<span id="id20"></span><h7><a class="toc-backref" href="#id104">filter_plugins</a><a class="headerlink" href="#filter-plugins" title="Permalink to this headline">¶</a></h7>
<p>Filters are specific functions that can be used to extend the template system.</p>
<p>This is a developer-centric feature that allows low-level extensions around Ansible to be loaded from
different locations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">filter_plugins</span> <span class="o">=</span> ~/.ansible/plugins/filter_plugins/:/usr/share/ansible_plugins/filter_plugins
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for more details</p>
</div>
<div class="section" id="force-color">
<span id="id21"></span><h7><a class="toc-backref" href="#id105">force_color</a><a class="headerlink" href="#force-color" title="Permalink to this headline">¶</a></h7>
<p>This options forces color mode even when running without a TTY:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">force_color</span> <span class="o">=</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="section" id="force-handlers">
<span id="id22"></span><h7><a class="toc-backref" href="#id106">force_handlers</a><a class="headerlink" href="#force-handlers" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.1.</span></p>
</div>
<p>This option causes notified handlers to run on a host even if a failure occurs on that host:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">force_handlers</span> <span class="o">=</span> True
</pre></div>
</div>
<p>The default is False, meaning that handlers will not run if a failure has occurred on a host.
This can also be set per play or on the command line. See <a class="reference internal" href="index.html#handlers-and-failure"><span class="std std-ref">Handlers and Failure</span></a> for more details.</p>
</div>
<div class="section" id="forks">
<span id="id23"></span><h7><a class="toc-backref" href="#id107">forks</a><a class="headerlink" href="#forks" title="Permalink to this headline">¶</a></h7>
<p>This is the default number of parallel processes to spawn when communicating with remote hosts.  Since Ansible 1.3,
the fork number is automatically limited to the number of possible hosts at runtime, so this is really a limit of how much
network and CPU load you think you can handle.  Many users may set this to 50, some set it to 500 or more.  If you
have a large number of hosts, higher values will make actions across all of those hosts complete faster.  The default
is very very conservative:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">forks</span> <span class="o">=</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="section" id="fact-caching">
<span id="id24"></span><h7><a class="toc-backref" href="#id108">fact_caching</a><a class="headerlink" href="#fact-caching" title="Permalink to this headline">¶</a></h7>
<p>This option allows you to configure fact caching.  When a fact cache
is enabled and there is valid data for a host, Ansible will use that rather than running an implicit <code class="docutils literal"><span class="pre">setup</span></code> job on a remote host.</p>
<p>The value of this option should be the name of a cache plugin.
Current versions of Ansible include <code class="docutils literal"><span class="pre">redis</span></code> and <code class="docutils literal"><span class="pre">jsonfile</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">fact_caching</span> <span class="o">=</span> jsonfile
</pre></div>
</div>
</div>
<div class="section" id="fact-caching-connection">
<span id="id25"></span><h7><a class="toc-backref" href="#id109">fact_caching_connection</a><a class="headerlink" href="#fact-caching-connection" title="Permalink to this headline">¶</a></h7>
<p>This option tells Ansible where to cache facts.  The value is plugin
dependent.  For the <code class="docutils literal"><span class="pre">jsonfile</span></code> plugin, it should be a path to a
local directory.  For the <code class="docutils literal"><span class="pre">redis</span></code> plugin, the value is a
<code class="docutils literal"><span class="pre">host:port:database</span></code> triplet:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">fact_caching_connection</span> <span class="o">=</span> localhost:6379:0
</pre></div>
</div>
</div>
<div class="section" id="fact-caching-timeout">
<span id="id26"></span><h7><a class="toc-backref" href="#id110">fact_caching_timeout</a><a class="headerlink" href="#fact-caching-timeout" title="Permalink to this headline">¶</a></h7>
<p>This option tells Ansible when to expire values from the cache.
Setting this value to 0 effectively disables expiry, and a positive
value is a TTL in seconds:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">fact_caching_timeout</span> <span class="o">=</span> <span class="m">86400</span>
</pre></div>
</div>
</div>
<div class="section" id="fact-path">
<span id="id27"></span><h7><a class="toc-backref" href="#id111">fact_path</a><a class="headerlink" href="#fact-path" title="Permalink to this headline">¶</a></h7>
<p>This option allows you to globally configure a custom path for <span class="xref std std-ref">_local_facts</span>:: for the implied <cite>setup</cite> task when using implied fact gathering.</p>
<blockquote>
<div>fact_path = /home/centos/ansible_facts.d</div></blockquote>
<p>The default is to use the default from the <a class="reference external" href="https://docs.ansible.com/ansible/setup_module.html">setup module</a>: <code class="docutils literal"><span class="pre">/etc/ansible/facts.d</span></code>
This ONLY affects fact gathering triggered by a play when <cite>gather_facts: True</cite>.</p>
</div>
<div class="section" id="gathering">
<span id="id28"></span><h7><a class="toc-backref" href="#id112">gathering</a><a class="headerlink" href="#gathering" title="Permalink to this headline">¶</a></h7>
<p>New in 1.6, the &#8216;gathering&#8217; setting controls the default policy of facts gathering (variables discovered about remote systems).</p>
<p>The value &#8216;implicit&#8217; is the default, which means that the fact cache will be ignored and facts will be gathered per play unless &#8216;gather_facts: False&#8217; is set.
The value &#8216;explicit&#8217; is the inverse, facts will not be gathered unless directly requested in the play.
The value &#8216;smart&#8217; means each new host that has no facts discovered will be scanned, but if the same host is addressed in multiple plays it will not be contacted again in the playbook run.
This option can be useful for those wishing to save fact gathering time. Both &#8216;smart&#8217; and &#8216;explicit&#8217; will use the fact cache:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">gathering</span> <span class="o">=</span> smart
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>You can specify a subset of gathered facts, via the play&#8217;s gather_facts directive, using the following option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">gather_subset</span> <span class="o">=</span> all
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">all:</th><td class="field-body">gather all subsets (the default)</td>
</tr>
<tr class="field-even field"><th class="field-name">network:</th><td class="field-body">gather network facts</td>
</tr>
<tr class="field-odd field"><th class="field-name">hardware:</th><td class="field-body">gather hardware facts (longest facts to retrieve)</td>
</tr>
<tr class="field-even field"><th class="field-name">virtual:</th><td class="field-body">gather facts about virtual machines hosted on the machine</td>
</tr>
<tr class="field-odd field"><th class="field-name">ohai:</th><td class="field-body">gather facts from ohai</td>
</tr>
<tr class="field-even field"><th class="field-name">facter:</th><td class="field-body">gather facts from facter</td>
</tr>
</tbody>
</table>
<p>You can combine them using a comma separated list (ex: network,virtual,facter)</p>
<p>You can also disable specific subsets by prepending with a <cite>!</cite> like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Don&#39;t gather hardware facts, facts from chef&#39;s ohai or puppet&#39;s facter</span>
<span class="nv">gather_subset</span> <span class="o">=</span> !hardware,!ohai,!facter
</pre></div>
</div>
<p>A set of basic facts are always collected no matter which additional subsets
are selected.  If you want to collect the minimal amount of facts, use
<cite>!all</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">gather_subset</span> <span class="o">=</span> !all
</pre></div>
</div>
</div>
<div class="section" id="hash-behaviour">
<h7><a class="toc-backref" href="#id113">hash_behaviour</a><a class="headerlink" href="#hash-behaviour" title="Permalink to this headline">¶</a></h7>
<p>Ansible by default will override variables in specific precedence orders, as described in <a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a>.  When a variable
of higher precedence wins, it will replace the other value.</p>
<p>Some users prefer that variables that are hashes (aka &#8216;dictionaries&#8217; in Python terms) are merged.  This setting is called &#8216;merge&#8217;. This is not the default behavior and it does not affect variables whose values are scalars (integers, strings) or
arrays.  We generally recommend not using this setting unless you think you have an absolute need for it, and playbooks in the
official examples repos do not use this setting:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">hash_behaviour</span> <span class="o">=</span> replace
</pre></div>
</div>
<p>The valid values are either &#8216;replace&#8217; (the default) or &#8216;merge&#8217;.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>If you want to merge hashes without changing the global settings, use
the <cite>combine</cite> filter described in <a class="reference internal" href="index.html#document-playbooks_filters"><span class="doc">Filters</span></a>.</p>
</div>
<div class="section" id="hostfile">
<span id="id29"></span><h7><a class="toc-backref" href="#id114">hostfile</a><a class="headerlink" href="#hostfile" title="Permalink to this headline">¶</a></h7>
<p>This is a deprecated setting since 1.9, please look at <a class="reference internal" href="#inventory-file"><span class="std std-ref">inventory</span></a> for the new setting.</p>
</div>
<div class="section" id="host-key-checking">
<span id="id30"></span><h7><a class="toc-backref" href="#id115">host_key_checking</a><a class="headerlink" href="#host-key-checking" title="Permalink to this headline">¶</a></h7>
<p>As described in <a class="reference internal" href="index.html#document-intro_getting_started"><span class="doc">Getting Started</span></a>, host key checking is on by default in Ansible 1.3 and later.  If you understand the
implications and wish to disable it, you may do so here by setting the value to False:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">host_key_checking</span> <span class="o">=</span> True
</pre></div>
</div>
</div>
<div class="section" id="internal-poll-interval">
<span id="id31"></span><h7><a class="toc-backref" href="#id116">internal_poll_interval</a><a class="headerlink" href="#internal-poll-interval" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>This sets the interval (in seconds) of Ansible internal processes polling each other.
Lower values improve performance with large playbooks at the expense of extra CPU load.
Higher values are more suitable for Ansible usage in automation scenarios, when UI responsiveness is not required but CPU usage might be a concern.
Default corresponds to the value hardcoded in Ansible ≤ 2.1:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">internal_poll_interval</span><span class="o">=</span><span class="m">0</span>.001
</pre></div>
</div>
</div>
<div class="section" id="inventory">
<span id="inventory-file"></span><h7><a class="toc-backref" href="#id117">inventory</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h7>
<p>This is the default location of the inventory file, script, or directory that Ansible will use to determine what hosts it has available
to talk to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">inventory</span> <span class="o">=</span> /etc/ansible/hosts
</pre></div>
</div>
<p>It used to be called hostfile in Ansible before 1.9</p>
</div>
<div class="section" id="inventory-ignore-extensions">
<span id="id32"></span><h7><a class="toc-backref" href="#id118">inventory_ignore_extensions</a><a class="headerlink" href="#inventory-ignore-extensions" title="Permalink to this headline">¶</a></h7>
<p>Comma-separated list of file extension patterns to ignore when Ansible inventory
is a directory with multiple sources (static and dynamic):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">inventory_ignore_extensions</span> <span class="o">=</span> ~, .orig, .bak, .ini, .cfg, .retry, .pyc, .pyo
</pre></div>
</div>
<p>This option can be overridden by setting <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_INVENTORY_IGNORE</span></code>
environment variable.</p>
</div>
<div class="section" id="jinja2-extensions">
<span id="id33"></span><h7><a class="toc-backref" href="#id119">jinja2_extensions</a><a class="headerlink" href="#jinja2-extensions" title="Permalink to this headline">¶</a></h7>
<p>This is a developer-specific feature that allows enabling additional Jinja2 extensions:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">jinja2_extensions</span> <span class="o">=</span> jinja2.ext.do,jinja2.ext.i18n
</pre></div>
</div>
<p>If you do not know what these do, you probably don&#8217;t need to change this setting :)</p>
</div>
<div class="section" id="library">
<span id="id34"></span><h7><a class="toc-backref" href="#id120">library</a><a class="headerlink" href="#library" title="Permalink to this headline">¶</a></h7>
<p>This is the default location Ansible looks to find modules:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">library</span> <span class="o">=</span> /usr/share/ansible
</pre></div>
</div>
<p>Ansible can look in multiple locations if you feed it a colon
separated path, and it also will look for modules in the <code class="file docutils literal"><span class="pre">./library</span></code>
directory alongside a playbook.</p>
<p>This can be used to manage modules pulled from several different locations.
For instance, a site wishing to checkout modules from several different git
repositories might handle it like this:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir -p /srv/modules
<span class="gp">$</span> <span class="nb">cd</span> /srv/modules
<span class="gp">$</span> git checkout https://vendor_modules .
<span class="gp">$</span> git checkout ssh://custom_modules .
<span class="gp">$</span> <span class="nb">export</span> <span class="nv">ANSIBLE_LIBRARY</span><span class="o">=</span>/srv/modules/custom_modules:/srv/modules/vendor_modules
<span class="gp">$</span> ansible <span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
<p>In case of modules with the same name, the library paths are searched in order
and the first module found with that name is used.</p>
</div>
<div class="section" id="local-tmp">
<span id="id35"></span><h7><a class="toc-backref" href="#id121">local_tmp</a><a class="headerlink" href="#local-tmp" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>When Ansible gets ready to send a module to a remote machine it usually has to
add a few things to the module: Some boilerplate code, the module&#8217;s
parameters, and a few constants from the config file.  This combination of
things gets stored in a temporary file until ansible exits and cleans up after
itself.  The default location is a subdirectory of the user&#8217;s home directory.
If you&#8217;d like to change that, you can do so by altering this setting:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">local_tmp</span> <span class="o">=</span> ~/.ansible/tmp
</pre></div>
</div>
<p>Ansible will then choose a random directory name inside this location.</p>
</div>
<div class="section" id="log-path">
<span id="id36"></span><h7><a class="toc-backref" href="#id122">log_path</a><a class="headerlink" href="#log-path" title="Permalink to this headline">¶</a></h7>
<p>If present and configured in ansible.cfg, Ansible will log information about executions at the designated location.  Be sure
the user running Ansible has permissions on the logfile:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">log_path</span><span class="o">=</span>/var/log/ansible.log
</pre></div>
</div>
<p>This behavior is not on by default.  Note that ansible will, without this setting, record module arguments called to the
syslog of managed machines.  Password arguments are excluded.</p>
<p>For Enterprise users seeking more detailed logging history, you may be interested in <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a>.</p>
</div>
<div class="section" id="lookup-plugins">
<span id="id37"></span><h7><a class="toc-backref" href="#id123">lookup_plugins</a><a class="headerlink" href="#lookup-plugins" title="Permalink to this headline">¶</a></h7>
<p>This is a developer-centric feature that allows low-level extensions around Ansible to be loaded from
different locations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">lookup_plugins</span> <span class="o">=</span> ~/.ansible/plugins/lookup_plugins/:/usr/share/ansible_plugins/lookup_plugins
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for more details</p>
</div>
<div class="section" id="merge-multiple-cli-tags">
<span id="id38"></span><h7><a class="toc-backref" href="#id124">merge_multiple_cli_tags</a><a class="headerlink" href="#merge-multiple-cli-tags" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p>This allows changing how multiple <code class="xref std std-option docutils literal"><span class="pre">--tags</span></code> and <code class="xref std std-option docutils literal"><span class="pre">--skip-tags</span></code>
arguments are handled on the command line.  Specifying <code class="xref std std-option docutils literal"><span class="pre">--tags</span></code> more
than once merges all of the <code class="xref std std-option docutils literal"><span class="pre">--tags</span></code> options together.  If you want
the pre-2.4.x behaviour where only the last value of <code class="xref std std-option docutils literal"><span class="pre">--tags</span></code> is used,
then set this to False.  The same holds true for <code class="xref std std-option docutils literal"><span class="pre">--skip-tags</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The default value for this in 2.3 is False.  In 2.4, the
default value is True.  After 2.8, the option will be removed.
Multiple <code class="xref std std-option docutils literal"><span class="pre">--tags</span></code> and multiple <code class="xref std std-option docutils literal"><span class="pre">--skip-tags</span></code> will always
be merged together.</p>
</div>
</div>
<div class="section" id="module-lang">
<span id="id39"></span><h7><a class="toc-backref" href="#id125">module_lang</a><a class="headerlink" href="#module-lang" title="Permalink to this headline">¶</a></h7>
<p>This is to set the default language to communicate between the module and the system.
By default, the value is value <cite>LANG</cite> on the controller or, if unset, <cite>en_US.UTF-8</cite> (it used to be <cite>C</cite> in previous versions):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">module_lang</span> <span class="o">=</span> en_US.UTF-8
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is only used if <a class="reference internal" href="#module-set-locale"><span class="std std-ref">module_set_locale</span></a> is set to True.</p>
</div>
</div>
<div class="section" id="module-name">
<span id="id40"></span><h7><a class="toc-backref" href="#id126">module_name</a><a class="headerlink" href="#module-name" title="Permalink to this headline">¶</a></h7>
<p>This is the default module name (-m) value for /usr/bin/ansible.  The default is the &#8216;command&#8217; module.
Remember the command module doesn&#8217;t support shell variables, pipes, or quotes, so you might wish to change
it to &#8216;shell&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">module_name</span> <span class="o">=</span> <span class="nb">command</span>
</pre></div>
</div>
</div>
<div class="section" id="module-set-locale">
<span id="id41"></span><h7><a class="toc-backref" href="#id127">module_set_locale</a><a class="headerlink" href="#module-set-locale" title="Permalink to this headline">¶</a></h7>
<p>This boolean value controls whether or not Ansible will prepend locale-specific environment variables (as specified
via the <a class="reference internal" href="#module-lang"><span class="std std-ref">module_lang</span></a> configuration option). If enabled, it results in the LANG, LC_MESSAGES, and LC_ALL
being set when the module is executed on the given remote system.  By default this is disabled.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The module_set_locale option was added in Ansible-2.1 and defaulted to
True.  The default was changed to False in Ansible-2.2</p>
</div>
</div>
<div class="section" id="module-utils">
<span id="id42"></span><h7><a class="toc-backref" href="#id128">module_utils</a><a class="headerlink" href="#module-utils" title="Permalink to this headline">¶</a></h7>
<p>This is the default location Ansible looks to find module_utils:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">module_utils</span> <span class="o">=</span> /usr/share/ansible/my_module_utils
</pre></div>
</div>
<p>module_utils are python modules that Ansible is able to combine with Ansible
modules when sending them to the remote machine.  Having custom module_utils
is useful for extracting common code when developing a set of site-specific
modules.</p>
<p>Ansible can look in multiple locations if you feed it a colon
separated path, and it also will look for modules in the
<code class="file docutils literal"><span class="pre">./module_utils</span></code> directory alongside a playbook.</p>
</div>
<div class="section" id="nocolor">
<span id="id43"></span><h7><a class="toc-backref" href="#id129">nocolor</a><a class="headerlink" href="#nocolor" title="Permalink to this headline">¶</a></h7>
<p>By default ansible will try to colorize output to give a better indication of failure and status information.
If you dislike this behavior you can turn it off by setting &#8216;nocolor&#8217; to 1:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">nocolor</span> <span class="o">=</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="section" id="nocows">
<span id="id44"></span><h7><a class="toc-backref" href="#id130">nocows</a><a class="headerlink" href="#nocows" title="Permalink to this headline">¶</a></h7>
<p>By default ansible will take advantage of cowsay if installed to make /usr/bin/ansible-playbook runs more exciting.
Why?  We believe systems management should be a happy experience.  If you do not like the cows, you can disable them
by setting &#8216;nocows&#8217; to 1:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">nocows</span> <span class="o">=</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="section" id="pattern">
<span id="id45"></span><h7><a class="toc-backref" href="#id131">pattern</a><a class="headerlink" href="#pattern" title="Permalink to this headline">¶</a></h7>
<p>This is the default group of hosts to talk to in a playbook if no &#8220;hosts:&#8221; stanza is supplied.  The default is to talk
to all hosts.  You may wish to change this to protect yourself from surprises:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">hosts</span> <span class="o">=</span> *
</pre></div>
</div>
<p>Note that /usr/bin/ansible always requires a host pattern and does not use this setting, only /usr/bin/ansible-playbook.</p>
</div>
<div class="section" id="poll-interval">
<span id="id46"></span><h7><a class="toc-backref" href="#id132">poll_interval</a><a class="headerlink" href="#poll-interval" title="Permalink to this headline">¶</a></h7>
<p>For asynchronous tasks in Ansible (covered in <a class="reference internal" href="index.html#document-playbooks_async"><span class="doc">Asynchronous Actions and Polling</span></a>), this is how often to check back on the status of those
tasks when an explicit poll interval is not supplied.  The default is a reasonably moderate 15 seconds which is a tradeoff
between checking in frequently and providing a quick turnaround when something may have completed:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">poll_interval</span> <span class="o">=</span> <span class="m">15</span>
</pre></div>
</div>
</div>
<div class="section" id="private-key-file">
<span id="id47"></span><h7><a class="toc-backref" href="#id133">private_key_file</a><a class="headerlink" href="#private-key-file" title="Permalink to this headline">¶</a></h7>
<p>If you are using a pem file to authenticate with machines rather than SSH agent or passwords, you can set the default
value here to avoid re-specifying <code class="docutils literal"><span class="pre">--private-key</span></code> with every invocation:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">private_key_file</span><span class="o">=</span>/path/to/file.pem
</pre></div>
</div>
</div>
<div class="section" id="remote-port">
<span id="id48"></span><h7><a class="toc-backref" href="#id134">remote_port</a><a class="headerlink" href="#remote-port" title="Permalink to this headline">¶</a></h7>
<p>This sets the default SSH port on all of your systems, for systems that didn&#8217;t specify an alternative value in inventory.
The default is the standard 22:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">remote_port</span> <span class="o">=</span> <span class="m">22</span>
</pre></div>
</div>
</div>
<div class="section" id="remote-tmp">
<span id="id49"></span><h7><a class="toc-backref" href="#id135">remote_tmp</a><a class="headerlink" href="#remote-tmp" title="Permalink to this headline">¶</a></h7>
<p>Ansible works by transferring modules to your remote machines, running them, and then cleaning up after itself.  In some
cases, you may not wish to use the default location and would like to change the path.  You can do so by altering this
setting:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">remote_tmp</span> <span class="o">=</span> ~/.ansible/tmp
</pre></div>
</div>
<p>The default is to use a subdirectory of the user&#8217;s home directory.  Ansible will then choose a random directory name
inside this location.</p>
</div>
<div class="section" id="remote-user">
<span id="id50"></span><h7><a class="toc-backref" href="#id136">remote_user</a><a class="headerlink" href="#remote-user" title="Permalink to this headline">¶</a></h7>
<p>This is the default username ansible will connect as for /usr/bin/ansible-playbook.  Note that /usr/bin/ansible will
always default to the current user if this is not defined:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">remote_user</span> <span class="o">=</span> root
</pre></div>
</div>
</div>
<div class="section" id="restrict-facts-namespace">
<span id="id51"></span><h7><a class="toc-backref" href="#id137">restrict_facts_namespace</a><a class="headerlink" href="#restrict-facts-namespace" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
<p>This allows restricting facts in their own namespace (under ansible_facts) instead of pushing them into the main.
False by default. Can also be set via the environment variable <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_RESTRICT_FACTS</span></code>. Using <cite>ansible_system</cite> as an example:</p>
<p>When False:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">var</span><span class="o">=</span>ansible_system
</pre></div>
</div>
<p>When True:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">var</span><span class="o">=</span>ansible_facts.ansible_system
</pre></div>
</div>
</div>
<div class="section" id="retry-files-enabled">
<span id="id52"></span><h7><a class="toc-backref" href="#id138">retry_files_enabled</a><a class="headerlink" href="#retry-files-enabled" title="Permalink to this headline">¶</a></h7>
<p>This controls whether a failed Ansible playbook should create a .retry file. The default setting is True:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">retry_files_enabled</span> <span class="o">=</span> False
</pre></div>
</div>
</div>
<div class="section" id="retry-files-save-path">
<span id="id53"></span><h7><a class="toc-backref" href="#id139">retry_files_save_path</a><a class="headerlink" href="#retry-files-save-path" title="Permalink to this headline">¶</a></h7>
<p>The retry files save path is where Ansible will save .retry files when a playbook fails and retry_files_enabled is True (the default).
The default location is adjacent to the play (~/ in versions older than 2.0) and can be changed to any writeable path:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">retry_files_save_path</span> <span class="o">=</span> ~/.ansible/retry-files
</pre></div>
</div>
<p>The directory will be created if it does not already exist.</p>
</div>
<div class="section" id="roles-path">
<span id="cfg-roles-path"></span><h7><a class="toc-backref" href="#id140">roles_path</a><a class="headerlink" href="#roles-path" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>The roles path indicate additional directories beyond the &#8216;roles/&#8217; subdirectory of a playbook project to search to find Ansible
roles.  For instance, if there was a source control repository of common roles and a different repository of playbooks, you might
choose to establish a convention to checkout roles in /opt/mysite/roles like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">roles_path</span> <span class="o">=</span> /opt/mysite/roles
</pre></div>
</div>
<p>Additional paths can be provided separated by colon characters, in the same way as other pathstrings:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">roles_path</span> <span class="o">=</span> /opt/mysite/roles:/opt/othersite/roles
</pre></div>
</div>
<p>Roles will be first searched for in the playbook directory.  Should a role not be found, it will indicate all the possible paths
that were searched.</p>
</div>
<div class="section" id="squash-actions">
<span id="cfg-squash-actions"></span><h7><a class="toc-backref" href="#id141">squash_actions</a><a class="headerlink" href="#squash-actions" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>Ansible can optimise actions that call modules that support list parameters when using with_ looping.
Instead of calling the module once for each item, the module is called once with the full list.</p>
<p>The default value for this setting is only for certain package managers, but it can be used for any module:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">squash_actions</span> <span class="o">=</span> apk,apt,dnf,homebrew,package,pacman,pkgng,yum,zypper
</pre></div>
</div>
<p>Currently, this is only supported for modules that have a name parameter, and only when the item is the
only thing being passed to the parameter.</p>
</div>
<div class="section" id="stdout-callback">
<span id="id54"></span><h7><a class="toc-backref" href="#id142">stdout_callback</a><a class="headerlink" href="#stdout-callback" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>This setting allows you to override the default stdout callback for ansible-playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">stdout_callback</span> <span class="o">=</span> skippy
</pre></div>
</div>
</div>
<div class="section" id="strategy-plugins">
<span id="cfg-strategy-plugins"></span><h7><a class="toc-backref" href="#id143">strategy_plugins</a><a class="headerlink" href="#strategy-plugins" title="Permalink to this headline">¶</a></h7>
<p>Strategy plugin allow users to change the way in which Ansible runs tasks on targeted hosts.</p>
<p>This is a developer-centric feature that allows low-level extensions around Ansible to be loaded from
different locations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">strategy_plugins</span> <span class="o">=</span> ~/.ansible/plugins/strategy_plugins/:/usr/share/ansible_plugins/strategy_plugins
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for more details</p>
</div>
<div class="section" id="strategy">
<span id="cfg-strategy"></span><h7><a class="toc-backref" href="#id144">strategy</a><a class="headerlink" href="#strategy" title="Permalink to this headline">¶</a></h7>
<p>Strategy allow to change the default strategy used by Ansible:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">strategy</span> <span class="o">=</span> free
</pre></div>
</div>
</div>
<div class="section" id="sudo-exe">
<span id="id55"></span><h7><a class="toc-backref" href="#id145">sudo_exe</a><a class="headerlink" href="#sudo-exe" title="Permalink to this headline">¶</a></h7>
<p>If using an alternative sudo implementation on remote machines, the path to sudo can be replaced here provided
the sudo implementation is matching CLI flags with the standard sudo:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">sudo_exe</span> <span class="o">=</span> sudo
</pre></div>
</div>
</div>
<div class="section" id="sudo-flags">
<span id="id56"></span><h7><a class="toc-backref" href="#id146">sudo_flags</a><a class="headerlink" href="#sudo-flags" title="Permalink to this headline">¶</a></h7>
<p>Additional flags to pass to sudo when engaging sudo support. The default is &#8216;-H -S -n&#8217; which sets the HOME environment
variable, prompts for passwords via STDIN, and avoids prompting the user for input of any kind. Note that &#8216;-n&#8217; will conflict
with using password-less sudo auth, such as pam_ssh_agent_auth. In some situations you may wish to add or remove flags, but
in general most users will not need to change this setting::</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">sudo_flags</span><span class="o">=</span>-H -S -n
</pre></div>
</div>
</div>
<div class="section" id="sudo-user">
<span id="id57"></span><h7><a class="toc-backref" href="#id147">sudo_user</a><a class="headerlink" href="#sudo-user" title="Permalink to this headline">¶</a></h7>
<p>This is the default user to sudo to if <code class="docutils literal"><span class="pre">--sudo-user</span></code> is not specified or &#8216;sudo_user&#8217; is not specified in an Ansible
playbook.  The default is the most logical: &#8216;root&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">sudo_user</span> <span class="o">=</span> root
</pre></div>
</div>
</div>
<div class="section" id="system-warnings">
<span id="id58"></span><h7><a class="toc-backref" href="#id148">system_warnings</a><a class="headerlink" href="#system-warnings" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>Allows disabling of warnings related to potential issues on the system running ansible itself (not on the managed hosts):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">system_warnings</span> <span class="o">=</span> True
</pre></div>
</div>
<p>These may include warnings about 3rd party packages or other conditions that should be resolved if possible.</p>
</div>
<div class="section" id="timeout">
<span id="id59"></span><h7><a class="toc-backref" href="#id149">timeout</a><a class="headerlink" href="#timeout" title="Permalink to this headline">¶</a></h7>
<p>This is the default SSH timeout to use on connection attempts:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">timeout</span> <span class="o">=</span> <span class="m">10</span>
</pre></div>
</div>
</div>
<div class="section" id="transport">
<span id="id60"></span><h7><a class="toc-backref" href="#id150">transport</a><a class="headerlink" href="#transport" title="Permalink to this headline">¶</a></h7>
<p>This is the default transport to use if &#8220;-c &lt;transport_name&gt;&#8221; is not specified to /usr/bin/ansible or /usr/bin/ansible-playbook.
The default is &#8216;smart&#8217;, which will use &#8216;ssh&#8217; (OpenSSH based) if the local operating system is new enough to support ControlPersist
technology, and then will otherwise use &#8216;paramiko&#8217;.  Other transport options include &#8216;local&#8217;, &#8216;chroot&#8217;, &#8216;jail&#8217;, and so on.</p>
<p>Users should usually leave this setting as &#8216;smart&#8217; and let their playbooks choose an alternate setting when needed with the
&#8216;connection:&#8217; play parameter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">transport</span> <span class="o">=</span> paramiko
</pre></div>
</div>
</div>
<div class="section" id="vars-plugins">
<span id="id61"></span><h7><a class="toc-backref" href="#id151">vars_plugins</a><a class="headerlink" href="#vars-plugins" title="Permalink to this headline">¶</a></h7>
<p>This is a developer-centric feature that allows low-level extensions around Ansible to be loaded from
different locations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">vars_plugins</span> <span class="o">=</span> ~/.ansible/plugins/vars_plugins/:/usr/share/ansible_plugins/vars_plugins
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for more details</p>
</div>
<div class="section" id="vault-password-file">
<span id="id62"></span><h7><a class="toc-backref" href="#id152">vault_password_file</a><a class="headerlink" href="#vault-password-file" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.7.</span></p>
</div>
<p>Configures the path to the Vault password file as an alternative to specifying <code class="docutils literal"><span class="pre">--vault-password-file</span></code> on the command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">vault_password_file</span> <span class="o">=</span> /path/to/vault_password_file
</pre></div>
</div>
<p>As of 1.7 this file can also be a script. If you are using a script instead of a flat file, ensure that it is marked as executable, and that the password is printed to standard output. If your script needs to prompt for data, prompts can be sent to standard error.</p>
</div>
</div>
<div class="section" id="privilege-escalation-settings">
<span id="privilege-escalation"></span><h6><a class="toc-backref" href="#id153">Privilege Escalation Settings</a><a class="headerlink" href="#privilege-escalation-settings" title="Permalink to this headline">¶</a></h6>
<p>Ansible can use existing privilege escalation systems to allow a user to execute tasks as another. As of 1.9 ‘become’ supersedes the old sudo/su, while still being backwards compatible.  Settings live under the [privilege_escalation] header.</p>
<div class="section" id="become">
<span id="id63"></span><h7><a class="toc-backref" href="#id154">become</a><a class="headerlink" href="#become" title="Permalink to this headline">¶</a></h7>
<p>The equivalent of adding sudo: or su: to a play or task, set to true/yes to activate privilege escalation. The default behavior is no:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">become</span> <span class="o">=</span> True
</pre></div>
</div>
</div>
<div class="section" id="become-method">
<span id="id64"></span><h7><a class="toc-backref" href="#id155">become_method</a><a class="headerlink" href="#become-method" title="Permalink to this headline">¶</a></h7>
<p>Set the privilege escalation method. The default is <code class="docutils literal"><span class="pre">sudo</span></code>, other options are <code class="docutils literal"><span class="pre">su</span></code>, <code class="docutils literal"><span class="pre">pbrun</span></code>, <code class="docutils literal"><span class="pre">pfexec</span></code>, <code class="docutils literal"><span class="pre">doas</span></code>, <code class="docutils literal"><span class="pre">ksu</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">become_method</span> <span class="o">=</span> su
</pre></div>
</div>
</div>
<div class="section" id="become-user">
<span id="id65"></span><h7><a class="toc-backref" href="#id156">become_user</a><a class="headerlink" href="#become-user" title="Permalink to this headline">¶</a></h7>
<p>The equivalent to ansible_sudo_user or ansible_su_user, allows to set the user you become through privilege escalation. The default is &#8216;root&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">become_user</span> <span class="o">=</span> root
</pre></div>
</div>
</div>
<div class="section" id="become-ask-pass">
<span id="id66"></span><h7><a class="toc-backref" href="#id157">become_ask_pass</a><a class="headerlink" href="#become-ask-pass" title="Permalink to this headline">¶</a></h7>
<p>Ask for privilege escalation password, the default is False:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">become_ask_pass</span> <span class="o">=</span> True
</pre></div>
</div>
</div>
<div class="section" id="become-allow-same-user">
<span id="id67"></span><h7><a class="toc-backref" href="#id158">become_allow_same_user</a><a class="headerlink" href="#become-allow-same-user" title="Permalink to this headline">¶</a></h7>
<p>Most of the time, using <em>sudo</em> to run a command as the same user who is running
<em>sudo</em> itself is unnecessary overhead, so Ansible does not allow it. However,
depending on the <em>sudo</em> configuration, it may be necessary to run a command as
the same user through <em>sudo</em>, such as to switch SELinux contexts. For this
reason, you can set <code class="docutils literal"><span class="pre">become_allow_same_user</span></code> to <code class="docutils literal"><span class="pre">True</span></code> and disable this
optimization.</p>
</div>
</div>
<div class="section" id="paramiko-specific-settings">
<span id="paramiko-settings"></span><h6><a class="toc-backref" href="#id159">Paramiko Specific Settings</a><a class="headerlink" href="#paramiko-specific-settings" title="Permalink to this headline">¶</a></h6>
<p>Paramiko is the default SSH connection implementation on Enterprise Linux 6 or earlier, and is not used by default on other
platforms.  Settings live under the [paramiko_connection] header.</p>
<div class="section" id="record-host-keys">
<span id="id68"></span><h7><a class="toc-backref" href="#id160">record_host_keys</a><a class="headerlink" href="#record-host-keys" title="Permalink to this headline">¶</a></h7>
<p>The default setting of yes will record newly discovered and approved (if host key checking is enabled) hosts in the user&#8217;s hostfile.
This setting may be inefficient for large numbers of hosts, and in those situations, using the ssh transport is definitely recommended
instead.  Setting it to False will improve performance and is recommended when host key checking is disabled:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">record_host_keys</span> <span class="o">=</span> True
</pre></div>
</div>
</div>
<div class="section" id="proxy-command">
<span id="paramiko-proxy-command"></span><h7><a class="toc-backref" href="#id161">proxy_command</a><a class="headerlink" href="#proxy-command" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>Use an OpenSSH like ProxyCommand for proxying all Paramiko SSH connections through a bastion or jump host. Requires a minimum of Paramiko version 1.9.0. On Enterprise Linux 6 this is provided by <code class="docutils literal"><span class="pre">python-paramiko1.10</span></code> in the EPEL repository:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">proxy_command</span> <span class="o">=</span> ssh -W <span class="s2">&quot;%h:%p&quot;</span> bastion
</pre></div>
</div>
</div>
</div>
<div class="section" id="openssh-specific-settings">
<span id="openssh-settings"></span><h6><a class="toc-backref" href="#id162">OpenSSH Specific Settings</a><a class="headerlink" href="#openssh-specific-settings" title="Permalink to this headline">¶</a></h6>
<p>Under the [ssh_connection] header, the following settings are tunable for SSH connections.  OpenSSH is the default connection type for Ansible
on OSes that are new enough to support ControlPersist.  (This means basically all operating systems except Enterprise Linux 6 or earlier).</p>
<div class="section" id="ssh-args">
<span id="id69"></span><h7><a class="toc-backref" href="#id163">ssh_args</a><a class="headerlink" href="#ssh-args" title="Permalink to this headline">¶</a></h7>
<p>If set, this will pass a specific set of options to Ansible rather than Ansible&#8217;s usual defaults:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ssh_args</span> <span class="o">=</span> -o <span class="nv">ControlMaster</span><span class="o">=</span>auto -o <span class="nv">ControlPersist</span><span class="o">=</span>60s
</pre></div>
</div>
<p>In particular, users may wish to raise the ControlPersist time to encourage performance.  A value of 30 minutes may
be appropriate. If <code class="docutils literal"><span class="pre">-o</span> <span class="pre">ControlPath</span></code> is set in <code class="docutils literal"><span class="pre">ssh_args</span></code>, the <code class="docutils literal"><span class="pre">control_path</span></code> setting is not used.</p>
</div>
<div class="section" id="control-path">
<span id="id70"></span><h7><a class="toc-backref" href="#id164">control_path</a><a class="headerlink" href="#control-path" title="Permalink to this headline">¶</a></h7>
<p>This is the location to save ControlPath sockets. This defaults to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">control_path</span><span class="o">=</span>%<span class="o">(</span>directory<span class="o">)</span>s/ansible-ssh-%%h-%%p-%%r
</pre></div>
</div>
<p>On some systems with very long hostnames or very long path names (caused by long user names or
deeply nested home directories) this can exceed the character limit on
file socket names (108 characters for most platforms). In that case, you
may wish to shorten the string to something like the below:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">control_path</span> <span class="o">=</span> %<span class="o">(</span>directory<span class="o">)</span>s/%%h-%%r
</pre></div>
</div>
<p>Ansible 1.4 and later will instruct users to run with &#8220;-vvvv&#8221; in situations where it hits this problem
and if so it is easy to tell there is too long of a Control Path filename.  This may be frequently
encountered on EC2. This setting is ignored if <code class="docutils literal"><span class="pre">-o</span> <span class="pre">ControlPath</span></code> is set in <code class="docutils literal"><span class="pre">ssh_args</span></code>.</p>
</div>
<div class="section" id="control-path-dir">
<span id="id71"></span><h7><a class="toc-backref" href="#id165">control_path_dir</a><a class="headerlink" href="#control-path-dir" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p>This is the base directory of the ControlPath sockets.
It is the <code class="docutils literal"><span class="pre">%(directory)s</span></code> part of the <code class="docutils literal"><span class="pre">control_path</span></code> option.
This defaults to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">control_path_dir</span><span class="o">=</span>~/.ansible/cp
</pre></div>
</div>
</div>
<div class="section" id="retries">
<span id="id72"></span><h7><a class="toc-backref" href="#id166">retries</a><a class="headerlink" href="#retries" title="Permalink to this headline">¶</a></h7>
<p>Adds the option to retry failed ssh executions if the failure is encountered in ssh itself, not the remote command. This can be helpful if there are transient network issues. Enabled by setting retries to an integer greater than 1. Defaults to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">retries</span> <span class="o">=</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="section" id="scp-if-ssh">
<span id="id73"></span><h7><a class="toc-backref" href="#id167">scp_if_ssh</a><a class="headerlink" href="#scp-if-ssh" title="Permalink to this headline">¶</a></h7>
<p>Occasionally users may be managing a remote system that doesn&#8217;t have SFTP enabled.  If set to True, we can
cause scp to be used to transfer remote files instead:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">scp_if_ssh</span> <span class="o">=</span> False
</pre></div>
</div>
<p>There&#8217;s really no reason to change this unless problems are encountered, and then there&#8217;s also no real drawback
to managing the switch.  Most environments support SFTP by default and this doesn&#8217;t usually need to be changed.</p>
</div>
<div class="section" id="pipelining">
<span id="id74"></span><h7><a class="toc-backref" href="#id168">pipelining</a><a class="headerlink" href="#pipelining" title="Permalink to this headline">¶</a></h7>
<p>Enabling pipelining reduces the number of SSH operations required to
execute a module on the remote server, by executing many ansible modules without actual file transfer.
This can result in a very significant performance improvement when enabled, however when using &#8220;sudo:&#8221; operations you must
first disable &#8216;requiretty&#8217; in /etc/sudoers on all managed hosts.</p>
<p>By default, this option is disabled to preserve compatibility with
sudoers configurations that have requiretty (the default on many distros), but is highly
recommended if you can enable it, eliminating the need for <a class="reference internal" href="index.html#document-playbooks_acceleration"><span class="doc">Accelerated Mode</span></a>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">pipelining</span> <span class="o">=</span> False
</pre></div>
</div>
</div>
<div class="section" id="ssh-executable">
<span id="id75"></span><h7><a class="toc-backref" href="#id169">ssh_executable</a><a class="headerlink" href="#ssh-executable" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>This is the location of the ssh binary. It defaults to <code class="docutils literal"><span class="pre">ssh</span></code> which will use the first ssh binary available in <code class="docutils literal"><span class="pre">$PATH</span></code>. This config can also be overridden with <code class="docutils literal"><span class="pre">ansible_ssh_executable</span></code> inventory variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ssh_executable</span><span class="o">=</span><span class="s2">&quot;/usr/local/bin/ssh&quot;</span>
</pre></div>
</div>
<p>This option is usually not required, it might be useful when access to system ssh is restricted, or when using ssh wrappers to connect to remote hosts.</p>
</div>
</div>
<div class="section" id="accelerated-mode-settings">
<span id="accelerate-settings"></span><h6><a class="toc-backref" href="#id170">Accelerated Mode Settings</a><a class="headerlink" href="#accelerated-mode-settings" title="Permalink to this headline">¶</a></h6>
<p>Under the [accelerate] header, the following settings are tunable for <a class="reference internal" href="index.html#document-playbooks_acceleration"><span class="doc">Accelerated Mode</span></a>.  Acceleration is
a useful performance feature to use if you cannot enable <a class="reference internal" href="#pipelining"><span class="std std-ref">pipelining</span></a> in your environment, but is probably
not needed if you can.</p>
<div class="section" id="accelerate-port">
<span id="id76"></span><h7><a class="toc-backref" href="#id171">accelerate_port</a><a class="headerlink" href="#accelerate-port" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>This is the port to use for accelerated mode:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">accelerate_port</span> <span class="o">=</span> <span class="m">5099</span>
</pre></div>
</div>
</div>
<div class="section" id="accelerate-timeout">
<span id="id77"></span><h7><a class="toc-backref" href="#id172">accelerate_timeout</a><a class="headerlink" href="#accelerate-timeout" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>This setting controls the timeout for receiving data from a client. If no data is received during this time, the socket connection will be closed. A keepalive packet is sent back to the controller every 15 seconds, so this timeout should not be set lower than 15 (by default, the timeout is 30 seconds):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">accelerate_timeout</span> <span class="o">=</span> <span class="m">30</span>
</pre></div>
</div>
</div>
<div class="section" id="accelerate-connect-timeout">
<span id="id78"></span><h7><a class="toc-backref" href="#id173">accelerate_connect_timeout</a><a class="headerlink" href="#accelerate-connect-timeout" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>This setting controls the timeout for the socket connect call, and should be kept relatively low. The connection to the <cite>accelerate_port</cite> will be attempted 3 times before Ansible will fall back to ssh or paramiko (depending on your default connection setting) to try and start the accelerate daemon remotely. The default setting is 1.0 seconds:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">accelerate_connect_timeout</span> <span class="o">=</span> <span class="m">1</span>.0
</pre></div>
</div>
<p>Note, this value can be set to less than one second, however it is probably not a good idea to do so unless you&#8217;re on a very fast and reliable LAN. If you&#8217;re connecting to systems over the internet, it may be necessary to increase this timeout.</p>
</div>
<div class="section" id="accelerate-daemon-timeout">
<span id="id79"></span><h7><a class="toc-backref" href="#id174">accelerate_daemon_timeout</a><a class="headerlink" href="#accelerate-daemon-timeout" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>This setting controls the timeout for the accelerated daemon, as measured in minutes. The default daemon timeout is 30 minutes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">accelerate_daemon_timeout</span> <span class="o">=</span> <span class="m">30</span>
</pre></div>
</div>
<p>Note, prior to 1.6, the timeout was hard-coded from the time of the daemon&#8217;s launch. For version 1.6+, the timeout is now based on the last activity to the daemon and is configurable via this option.</p>
</div>
<div class="section" id="accelerate-multi-key">
<span id="id80"></span><h7><a class="toc-backref" href="#id175">accelerate_multi_key</a><a class="headerlink" href="#accelerate-multi-key" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>If enabled, this setting allows multiple private keys to be uploaded to the daemon. Any clients connecting to the daemon must also enable this option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">accelerate_multi_key</span> <span class="o">=</span> yes
</pre></div>
</div>
<p>New clients first connect to the target node over SSH to upload the key, which is done via a local socket file, so they must have the same access as the user that launched the daemon originally.</p>
</div>
</div>
<div class="section" id="selinux-specific-settings">
<span id="selinux-settings"></span><h6><a class="toc-backref" href="#id176">Selinux Specific Settings</a><a class="headerlink" href="#selinux-specific-settings" title="Permalink to this headline">¶</a></h6>
<p>These are settings that control SELinux interactions.</p>
<div class="section" id="special-context-filesystems">
<h7><a class="toc-backref" href="#id177">special_context_filesystems</a><a class="headerlink" href="#special-context-filesystems" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.</span></p>
</div>
<p>This is a list of file systems that require special treatment when dealing with security context.
The normal behaviour is for operations to copy the existing context or use the user default, this changes it to use a file system dependent context.
The default list is: nfs,vboxsf,fuse,ramfs:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">special_context_filesystems</span> <span class="o">=</span> nfs,vboxsf,fuse,ramfs,myspecialfs
</pre></div>
</div>
</div>
<div class="section" id="libvirt-lxc-noseclabel">
<h7><a class="toc-backref" href="#id178">libvirt_lxc_noseclabel</a><a class="headerlink" href="#libvirt-lxc-noseclabel" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>This setting causes libvirt to connect to lxc containers by passing &#8211;noseclabel to virsh.
This is necessary when running on systems which do not have SELinux.
The default behavior is no:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">libvirt_lxc_noseclabel</span> <span class="o">=</span> True
</pre></div>
</div>
</div>
<div class="section" id="show-custom-stats">
<span id="id81"></span><h7><a class="toc-backref" href="#id179">show_custom_stats</a><a class="headerlink" href="#show-custom-stats" title="Permalink to this headline">¶</a></h7>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p>If enabled, this setting will display custom stats (set via set_stats plugin) when using the default callback.</p>
</div>
</div>
<div class="section" id="galaxy-settings">
<h6><a class="toc-backref" href="#id180">Galaxy Settings</a><a class="headerlink" href="#galaxy-settings" title="Permalink to this headline">¶</a></h6>
<p>The following options can be set in the [galaxy] section of ansible.cfg:</p>
<div class="section" id="server">
<h7><a class="toc-backref" href="#id181">server</a><a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h7>
<p>Override the default Galaxy server value of <a class="reference external" href="https://galaxy.ansible.com">https://galaxy.ansible.com</a>. Useful if you have a hosted version of the Galaxy web app or want to point to the testing site <a class="reference external" href="https://galaxy-qa.ansible.com">https://galaxy-qa.ansible.com</a>. It does not work against private, hosted repos, which Galaxy can use for fetching and installing roles.</p>
</div>
<div class="section" id="ignore-certs">
<h7><a class="toc-backref" href="#id182">ignore_certs</a><a class="headerlink" href="#ignore-certs" title="Permalink to this headline">¶</a></h7>
<p>If set to <em>yes</em>, ansible-galaxy will not validate TLS certificates. This can be useful for testing against a server with a self-signed certificate.</p>
</div>
</div>
</div>
</div>
<span id="document-intro_bsd"></span><div class="section" id="bsd-support">
<h4><a class="toc-backref" href="#id3">BSD Support</a><a class="headerlink" href="#bsd-support" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#bsd-support" id="id3">BSD Support</a><ul>
<li><a class="reference internal" href="#working-with-bsd" id="id4">Working with BSD</a></li>
<li><a class="reference internal" href="#bootstrapping-bsd" id="id5">Bootstrapping BSD</a></li>
<li><a class="reference internal" href="#setting-the-python-interpreter" id="id6">Setting the Python interpreter</a></li>
<li><a class="reference internal" href="#which-modules-are-available" id="id7">Which modules are available?</a></li>
<li><a class="reference internal" href="#using-bsd-as-the-control-machine" id="id8">Using BSD as the control machine</a></li>
<li><a class="reference internal" href="#bsd-facts" id="id9">BSD Facts</a></li>
<li><a class="reference internal" href="#bsd-efforts-and-contributions" id="id10">BSD Efforts and Contributions</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="working-with-bsd">
<span id="id1"></span><h5><a class="toc-backref" href="#id4">Working with BSD</a><a class="headerlink" href="#working-with-bsd" title="Permalink to this headline">¶</a></h5>
<p>Ansible manages Linux/Unix machines using SSH by default. BSD machines are no exception, however this document covers some of the differences you may encounter with Ansible when working with BSD variants.</p>
<p>Typically, Ansible will try to default to using OpenSSH as a connection method. This is suitable when using SSH keys to authenticate, but when using SSH passwords, Ansible relies on sshpass. Most
versions of sshpass do not deal particularly well with BSD login prompts, so when using SSH passwords against BSD machines, it is recommended to change the transport method to paramiko. You can do this in ansible.cfg globally or you can set it as an inventory/group/host variable. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>freebsd<span class="o">]</span>
mybsdhost1 <span class="nv">ansible_connection</span><span class="o">=</span>paramiko
</pre></div>
</div>
<p>Ansible is agentless by default, however certain software is required on the target machines. Using Python 2.4 on the agents requires an additional py-simplejson package/library to be installed, however this library is already included in Python 2.5 and above.
Operating without Python is possible with the <code class="docutils literal"><span class="pre">raw</span></code> module. Although this module can be used to bootstrap Ansible and install Python on BSD variants (see below), it is very limited and the use of Python is required to make full use of Ansible&#8217;s features.</p>
</div>
<div class="section" id="bootstrapping-bsd">
<span id="bootstrap-bsd"></span><h5><a class="toc-backref" href="#id5">Bootstrapping BSD</a><a class="headerlink" href="#bootstrapping-bsd" title="Permalink to this headline">¶</a></h5>
<p>As mentioned above, you can bootstrap Ansible with the <code class="docutils literal"><span class="pre">raw</span></code> module and remotely install Python on targets. The following example installs Python 2.7 which includes the json library required for full functionality of Ansible.
On your control machine you can simply execute the following for most versions of FreeBSD:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible -m raw -a “pkg install -y python27” mybsdhost1
</pre></div>
</div>
<p>Once this is done you can now use other Ansible modules apart from the <code class="docutils literal"><span class="pre">raw</span></code> module.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example used pkg as used on FreeBSD, however you should be able to substitute the appropriate package tool for your BSD; the package name may also differ. Refer to the package list or documentation of the BSD variant you are using for the exact Python package name you intend to install.</p>
</div>
</div>
<div class="section" id="setting-the-python-interpreter">
<span id="python-location"></span><h5><a class="toc-backref" href="#id6">Setting the Python interpreter</a><a class="headerlink" href="#setting-the-python-interpreter" title="Permalink to this headline">¶</a></h5>
<p>To support a variety of Unix/Linux operating systems and distributions, Ansible cannot always rely on the existing environment or <code class="docutils literal"><span class="pre">env</span></code> variables to locate the correct Python binary. By default, modules point at <code class="docutils literal"><span class="pre">/usr/bin/python</span></code> as this is the most common location. On BSD variants, this path may differ, so it is advised to inform Ansible of the binary&#8217;s location, through the <code class="docutils literal"><span class="pre">ansible_python_interpreter</span></code> inventory variable. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>freebsd:vars<span class="o">]</span>
<span class="nv">ansible_python_interpreter</span><span class="o">=</span>/usr/local/bin/python2.7
</pre></div>
</div>
<p>If you use additional plugins beyond those bundled with Ansible, you can set similar variables for <code class="docutils literal"><span class="pre">bash</span></code>, <code class="docutils literal"><span class="pre">perl</span></code> or <code class="docutils literal"><span class="pre">ruby</span></code>, depending on how the plugin is written. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>freebsd:vars<span class="o">]</span>
<span class="nv">ansible_python_interpreter</span><span class="o">=</span>/usr/local/bin/python
<span class="nv">ansible_perl_interpreter</span><span class="o">=</span>/usr/bin/perl5
</pre></div>
</div>
</div>
<div class="section" id="which-modules-are-available">
<h5><a class="toc-backref" href="#id7">Which modules are available?</a><a class="headerlink" href="#which-modules-are-available" title="Permalink to this headline">¶</a></h5>
<p>The majority of the core Ansible modules are written for a combination of Linux/Unix machines and other generic services, so most should function well on the BSDs with the obvious exception of those that are aimed at Linux-only technologies (such as LVG).</p>
</div>
<div class="section" id="using-bsd-as-the-control-machine">
<h5><a class="toc-backref" href="#id8">Using BSD as the control machine</a><a class="headerlink" href="#using-bsd-as-the-control-machine" title="Permalink to this headline">¶</a></h5>
<p>Using BSD as the control machine is as simple as installing the Ansible package for your BSD variant or by following the <code class="docutils literal"><span class="pre">pip</span></code> or &#8216;from source&#8217; instructions.</p>
</div>
<div class="section" id="bsd-facts">
<span id="id2"></span><h5><a class="toc-backref" href="#id9">BSD Facts</a><a class="headerlink" href="#bsd-facts" title="Permalink to this headline">¶</a></h5>
<p>Ansible gathers facts from the BSDs in a similar manner to Linux machines, but since the data, names and structures can vary for network, disks and other devices, one should expect the output to be slightly different yet still familiar to a BSD administrator.</p>
</div>
<div class="section" id="bsd-efforts-and-contributions">
<span id="bsd-contributions"></span><h5><a class="toc-backref" href="#id10">BSD Efforts and Contributions</a><a class="headerlink" href="#bsd-efforts-and-contributions" title="Permalink to this headline">¶</a></h5>
<p>BSD support is important to us at Ansible. Even though the majority of our contributors use and target Linux we have an active BSD community and strive to be as BSD friendly as possible.
Please feel free to report any issues or incompatibilities you discover with BSD; pull requests with an included fix are also welcome!</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Learning ansible&#8217;s configuration management language</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>How to write modules</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-intro_windows"></span><div class="section" id="windows-support">
<h4><a class="toc-backref" href="#id5">Windows Support</a><a class="headerlink" href="#windows-support" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#windows-support" id="id5">Windows Support</a><ul>
<li><a class="reference internal" href="#windows-how-does-it-work" id="id6">Windows: How Does It Work</a></li>
<li><a class="reference internal" href="#installing-on-the-control-machine" id="id7">Installing on the Control Machine</a></li>
<li><a class="reference internal" href="#using-a-windows-control-machine" id="id8">Using a Windows control machine</a></li>
<li><a class="reference internal" href="#authentication-options" id="id9">Authentication Options</a><ul>
<li><a class="reference internal" href="#certificate" id="id10">Certificate</a></li>
<li><a class="reference internal" href="#kerberos" id="id11">Kerberos</a><ul>
<li><a class="reference internal" href="#installing-python-kerberos-dependencies" id="id12">Installing python-kerberos dependencies</a></li>
<li><a class="reference internal" href="#installing-python-kerberos" id="id13">Installing python-kerberos</a></li>
<li><a class="reference internal" href="#configuring-kerberos" id="id14">Configuring Kerberos</a></li>
<li><a class="reference internal" href="#testing-a-kerberos-connection" id="id15">Testing a kerberos connection</a></li>
<li><a class="reference internal" href="#automatic-kerberos-ticket-management" id="id16">Automatic kerberos ticket management</a></li>
<li><a class="reference internal" href="#troubleshooting-kerberos-connections" id="id17">Troubleshooting kerberos connections</a></li>
</ul>
</li>
<li><a class="reference internal" href="#credssp" id="id18">CredSSP</a><ul>
<li><a class="reference internal" href="#installing-requests-credssp" id="id19">Installing requests-credssp</a></li>
<li><a class="reference internal" href="#credssp-and-tls-1-2" id="id20">CredSSP and TLS 1.2</a></li>
</ul>
</li>
<li><a class="reference internal" href="#credential-delegation" id="id21">Credential Delegation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inventory" id="id22">Inventory</a></li>
<li><a class="reference internal" href="#windows-system-prep" id="id23">Windows System Prep</a></li>
<li><a class="reference internal" href="#getting-to-powershell-3-0-or-higher" id="id24">Getting to PowerShell 3.0 or higher</a></li>
<li><a class="reference internal" href="#what-modules-are-available" id="id25">What modules are available</a></li>
<li><a class="reference internal" href="#developers-supported-modules-and-how-it-works" id="id26">Developers: Supported modules and how it works</a></li>
<li><a class="reference internal" href="#windows-facts" id="id27">Windows Facts</a></li>
<li><a class="reference internal" href="#windows-playbook-examples" id="id28">Windows Playbook Examples</a></li>
<li><a class="reference internal" href="#windows-contributions" id="id29">Windows Contributions</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="windows-how-does-it-work">
<span id="id1"></span><h5><a class="toc-backref" href="#id6">Windows: How Does It Work</a><a class="headerlink" href="#windows-how-does-it-work" title="Permalink to this headline">¶</a></h5>
<p>As you may have already read, Ansible manages Linux/Unix machines using SSH by default.</p>
<p>Starting in version 1.7, Ansible also contains support for managing Windows machines.  This uses
native PowerShell remoting, rather than SSH.</p>
<p>Ansible will still be run from a Linux control machine, and uses the &#8220;winrm&#8221; Python module to talk to remote hosts.
While not supported by Microsoft or Ansible, this Linux control machine can be a Windows Subsystem for Linux (WSL) bash shell.</p>
<p>No additional software needs to be installed on the remote machines for Ansible to manage them, it still maintains the agentless properties that make it popular on Linux/Unix.</p>
<p>Note that it is expected you have a basic understanding of Ansible prior to jumping into this section, so if you haven&#8217;t written a Linux playbook first, it might be worthwhile to dig in there first.</p>
</div>
<div class="section" id="installing-on-the-control-machine">
<span id="windows-installing"></span><h5><a class="toc-backref" href="#id7">Installing on the Control Machine</a><a class="headerlink" href="#installing-on-the-control-machine" title="Permalink to this headline">¶</a></h5>
<p>On a Linux control machine:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>pip install <span class="s2">&quot;pywinrm&gt;=0.2.2&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">on distributions with multiple python versions, use pip2 or pip2.x, where x matches the python minor version Ansible is running under.</p>
</div>
</div>
<div class="section" id="using-a-windows-control-machine">
<span id="windows-control-machine"></span><h5><a class="toc-backref" href="#id8">Using a Windows control machine</a><a class="headerlink" href="#using-a-windows-control-machine" title="Permalink to this headline">¶</a></h5>
<p>A Linux control machine is required to manage Windows hosts. This Linux control machine can be a Windows Subsystem for Linux (WSL) bash shell.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Running Ansible from a Windows control machine directly is not a goal of the project.  Refrain from asking for this feature, as it limits what technologies, features, and code we can use in the main project in the future.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Windows Subsystem for Linux (Beta) is not supported by Microsoft or Ansible and should not be used for production systems.</p>
</div>
<p>If you would like to experiment with the Windows Subsystem for Linux (WSL), first enable the Windows Subsystem for Linux using
<a class="reference external" href="https://www.jeffgeerling.com/blog/2017/using-ansible-through-windows-10s-subsystem-linux">these instructions</a>.
This requires a reboot.</p>
<p>Once WSL is enabled, you can open the Bash terminal. At the prompt, you can quickly start using the latest Ansible release by running the following commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install python-pip git libffi-dev libssl-dev -y
pip install ansible pywinrm

<span class="c1"># this step is only necessary for Windows builds earlier than 16188, and must be repeated each time bash is launched,</span>
<span class="c1"># unless bash is launched as ``bash --login``</span>
<span class="c1"># see https://github.com/Microsoft/BashOnWindows/issues/2148 and</span>
<span class="c1"># https://github.com/Microsoft/BashOnWindows/issues/816#issuecomment-301216901 for details</span>
<span class="nb">source</span> ~/.profile
</pre></div>
</div>
<p>After you&#8217;ve successfully run these commands, you can start to create your inventory, write example playbooks and start targeting systems using the plethora of available Windows modules.</p>
<p>If you want to run Ansible from source for development purposes, simply uninstall the pip-installed version (which will leave all the necessary dependencies behind), then clone the Ansible source, and run the hacking script to configure it to run from source:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>pip uninstall ansible -y
git clone https://github.com/ansible/ansible.git
<span class="nb">source</span> ansible/hacking/env-setup
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible is also reported to &#8220;work&#8221; on Cygwin, but installation is more cumbersome, and will incur sporadic failures due to Cygwin&#8217;s implementation of <code class="docutils literal"><span class="pre">fork()</span></code>.</p>
</div>
</div>
<div class="section" id="authentication-options">
<h5><a class="toc-backref" href="#id9">Authentication Options</a><a class="headerlink" href="#authentication-options" title="Permalink to this headline">¶</a></h5>
<p>When connecting to a Windows host there are different authentication options that can be used. The options and the features they support are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="20%" />
<col width="34%" />
<col width="29%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Local Accounts</th>
<th class="head">Active Directory Accounts</th>
<th class="head">Credential Delegation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Basic</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr class="row-odd"><td>Certificate</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr class="row-even"><td>Kerberos</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>NTLM</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="row-even"><td>CredSSP</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>You can specify which authentication option you wish to use by setting it to the <code class="docutils literal"><span class="pre">ansible_winrm_transport</span></code> variable.</p>
<div class="section" id="certificate">
<h6><a class="toc-backref" href="#id10">Certificate</a><a class="headerlink" href="#certificate" title="Permalink to this headline">¶</a></h6>
<p>Certificate authentication is similar to SSH where a certificate is assigned to a local user and instead of using a password to authenticate a certificate is used instead.</p>
</div>
<div class="section" id="kerberos">
<h6><a class="toc-backref" href="#id11">Kerberos</a><a class="headerlink" href="#kerberos" title="Permalink to this headline">¶</a></h6>
<p>Kerberos is the preferred option compared to NTLM to use when using an Active Directory account but it requires a few extra steps to set up on the Ansible control host. You will need to install the &#8220;python-kerberos&#8221; module on the Ansible control host (and the MIT krb5 libraries it depends on). The Ansible control host also requires a properly configured computer account in Active Directory.</p>
<div class="section" id="installing-python-kerberos-dependencies">
<h7><a class="toc-backref" href="#id12">Installing python-kerberos dependencies</a><a class="headerlink" href="#installing-python-kerberos-dependencies" title="Permalink to this headline">¶</a></h7>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Via Yum</span>
yum -y install python-devel krb5-devel krb5-libs krb5-workstation

<span class="c1"># Via Apt (Ubuntu)</span>
sudo apt-get install python-dev libkrb5-dev krb5-user

<span class="c1"># Via Portage (Gentoo)</span>
emerge -av app-crypt/mit-krb5
emerge -av dev-python/setuptools

<span class="c1"># Via pkg (FreeBSD)</span>
sudo pkg install security/krb5

<span class="c1"># Via OpenCSW (Solaris)</span>
pkgadd -d http://get.opencsw.org/now
/opt/csw/bin/pkgutil -U
/opt/csw/bin/pkgutil -y -i libkrb5_3

<span class="c1"># Via Pacman (Arch Linux)</span>
pacman -S krb5
</pre></div>
</div>
</div>
<div class="section" id="installing-python-kerberos">
<h7><a class="toc-backref" href="#id13">Installing python-kerberos</a><a class="headerlink" href="#installing-python-kerberos" title="Permalink to this headline">¶</a></h7>
<p>Once you&#8217;ve installed the necessary dependencies, the python-kerberos wrapper can be installed via pip:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>pip install pywinrm<span class="o">[</span>kerberos<span class="o">]</span>
</pre></div>
</div>
<p>Kerberos is installed and configured by default on OS X and many Linux distributions. If your control machine has not already done this for you, you will need to.</p>
</div>
<div class="section" id="configuring-kerberos">
<h7><a class="toc-backref" href="#id14">Configuring Kerberos</a><a class="headerlink" href="#configuring-kerberos" title="Permalink to this headline">¶</a></h7>
<p>Edit your /etc/krb5.conf (which should be installed as a result of installing packages above) and add the following information for each domain you need to connect to:</p>
<p>In the section that starts with</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[realms]</span>
</pre></div>
</div>
<p>add the full domain name and the fully qualified domain names of your primary and secondary Active Directory domain controllers.  It should look something like this:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[realms]</span>

 <span class="na">MY.DOMAIN.COM</span> <span class="o">=</span> <span class="s">{</span>
<span class="s">  kdc = domain-controller1.my.domain.com</span>
<span class="s">  kdc = domain-controller2.my.domain.com</span>
<span class="s"> }</span>
</pre></div>
</div>
<p>and in the [domain_realm] section add a line like the following for each domain you want to access:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[domain_realm]</span>
    <span class="na">.my.domain.com</span> <span class="o">=</span> <span class="s">MY.DOMAIN.COM</span>
</pre></div>
</div>
<p>You may wish to configure other settings here, such as the default domain.</p>
</div>
<div class="section" id="testing-a-kerberos-connection">
<h7><a class="toc-backref" href="#id15">Testing a kerberos connection</a><a class="headerlink" href="#testing-a-kerberos-connection" title="Permalink to this headline">¶</a></h7>
<p>If you have installed krb5-workstation (yum) or krb5-user (apt-get) you can use the following command to test that you can be authorised by your domain controller.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>kinit user@MY.DOMAIN.COM
</pre></div>
</div>
<p>Note that the domain part has to be fully qualified and must be in upper case.</p>
<p>To see what tickets if any you have acquired, use the command klist</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>klist
</pre></div>
</div>
</div>
<div class="section" id="automatic-kerberos-ticket-management">
<h7><a class="toc-backref" href="#id16">Automatic kerberos ticket management</a><a class="headerlink" href="#automatic-kerberos-ticket-management" title="Permalink to this headline">¶</a></h7>
<p>Ansible defaults to automatically managing kerberos tickets (as of Ansible 2.3) when both username and password are specified for a host that&#8217;s configured for kerberos. A new ticket is created in a temporary credential cache for each host, before each task executes (to minimize the chance of ticket expiration). The temporary credential caches are deleted after each task, and will not interfere with the default credential cache.</p>
<p>To disable automatic ticket management (e.g., to use an existing SSO ticket or call <code class="docutils literal"><span class="pre">kinit</span></code> manually to populate the default credential cache), set <code class="docutils literal"><span class="pre">ansible_winrm_kinit_mode=manual</span></code> via inventory.</p>
<p>Automatic ticket management requires a standard <code class="docutils literal"><span class="pre">kinit</span></code> binary on the control host system path. To specify a different location or binary name, set the <code class="docutils literal"><span class="pre">ansible_winrm_kinit_cmd</span></code> inventory var to the fully-qualified path to an MIT krbv5 <code class="docutils literal"><span class="pre">kinit</span></code>-compatible binary.</p>
</div>
<div class="section" id="troubleshooting-kerberos-connections">
<h7><a class="toc-backref" href="#id17">Troubleshooting kerberos connections</a><a class="headerlink" href="#troubleshooting-kerberos-connections" title="Permalink to this headline">¶</a></h7>
<p>If you unable to connect using kerberos, check the following:</p>
<p>Ensure that forward and reverse DNS lookups are working properly on your domain.</p>
<p>To test this, ping the windows host you want to control by name then use the ip address returned with nslookup.  You should get the same name back from DNS when you use nslookup on the ip address.</p>
<p>If you get different hostnames back than the name you originally pinged, speak to your active directory administrator and get them to check that DNS Scavenging is enabled and that DNS and DHCP are updating each other.</p>
<p>Ensure that the Ansible controller has a properly configured computer account in the domain.</p>
<p>Check your Ansible controller&#8217;s clock is synchronised with your domain controller.  Kerberos is time sensitive and a little clock drift can cause tickets not be granted.</p>
<p>Check you are using the real fully qualified domain name for the domain.  Sometimes domains are commonly known to users by aliases.  To check this run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>kinit -C user@MY.DOMAIN.COM
klist
</pre></div>
</div>
<p>If the domain name returned by klist is different from the domain name you requested, you are requesting using an alias, and you need to update your krb5.conf so you are using the fully qualified domain name, not its alias.</p>
</div>
</div>
<div class="section" id="credssp">
<span id="windows-inventory"></span><h6><a class="toc-backref" href="#id18">CredSSP</a><a class="headerlink" href="#credssp" title="Permalink to this headline">¶</a></h6>
<p>CredSSP authentication can be used to authenticate with both domain and local accounts. It allows credential delegation to do second hop authentication on a remote host by sending an encrypted form of the credentials to the remote host using the CredSSP protocol.</p>
<div class="section" id="installing-requests-credssp">
<h7><a class="toc-backref" href="#id19">Installing requests-credssp</a><a class="headerlink" href="#installing-requests-credssp" title="Permalink to this headline">¶</a></h7>
<p>To install credssp you can use pip to install the requests-credssp library:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>pip install pywinrm<span class="o">[</span>credssp<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="credssp-and-tls-1-2">
<h7><a class="toc-backref" href="#id20">CredSSP and TLS 1.2</a><a class="headerlink" href="#credssp-and-tls-1-2" title="Permalink to this headline">¶</a></h7>
<p>CredSSP requires the remote host to have TLS 1.2 configured or else the connection will fail. TLS 1.2 is installed by default from Server 2012 and Windows 8 onwards. For Server 2008, 2008 R2 and Windows 7 you can add TLS 1.2 support by:</p>
<ul class="simple">
<li>Installing the <a class="reference external" href="https://support.microsoft.com/en-us/help/3080079/update-to-add-rds-support-for-tls-1.1-and-tls-1.2-in-windows-7-or-windows-server-2008-r2">TLS 1.2 update from Microsoft</a></li>
<li>Adding the TLS 1.2 registry keys as shown on this <a class="reference external" href="https://technet.microsoft.com/en-us/library/dn786418.aspx#BKMK_SchannelTR_TLS12">page</a></li>
</ul>
</div>
</div>
<div class="section" id="credential-delegation">
<h6><a class="toc-backref" href="#id21">Credential Delegation</a><a class="headerlink" href="#credential-delegation" title="Permalink to this headline">¶</a></h6>
<p>If you need to interact with a remote resource or run a process that requires the credentials to be stored in the current session like a certreq.exe then an authentication protocol that supports credential delegation needs to be used.</p>
</div>
</div>
<div class="section" id="inventory">
<h5><a class="toc-backref" href="#id22">Inventory</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h5>
<p>Ansible&#8217;s windows support relies on a few standard variables to indicate the username, password, and connection type (windows) of the remote hosts.  These variables are most easily set up in inventory.  This is used instead of SSH-keys or passwords as normally fed into Ansible:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>windows<span class="o">]</span>
winserver1.example.com
winserver2.example.com
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible 2.0 has deprecated the “ssh” from <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code>, <code class="docutils literal"><span class="pre">ansible_ssh_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_ssh_port</span></code> to become <code class="docutils literal"><span class="pre">ansible_user</span></code>, <code class="docutils literal"><span class="pre">ansible_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_port</span></code>. If you are using a version of Ansible prior to 2.0,  you should continue using the older style variables (<code class="docutils literal"><span class="pre">ansible_ssh_*</span></code>). These shorter variables are ignored, without warning, in older versions of Ansible.</p>
</div>
<p>In <code class="docutils literal"><span class="pre">group_vars/windows.yml</span></code>, define the following inventory variables:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># it is suggested that these be encrypted with ansible-vault:</span>
<span class="c1"># ansible-vault edit group_vars/windows.yml</span>

ansible_user: Administrator
ansible_password: SecretPasswordGoesHere
ansible_port: <span class="m">5986</span>
ansible_connection: winrm
<span class="c1"># The following is necessary for Python 2.7.9+ (or any older Python that has backported SSLContext, eg, Python 2.7.5 on RHEL7) when using default WinRM self-signed certificates:</span>
ansible_winrm_server_cert_validation: ignore
</pre></div>
</div>
<p>Attention for the older style variables (<code class="docutils literal"><span class="pre">ansible_ssh_*</span></code>): ansible_ssh_password doesn&#8217;t exist, should be ansible_ssh_pass.</p>
<p>Although Ansible is mostly an SSH-oriented system, Windows management will not happen over SSH (<a class="reference external" href="http://blogs.msdn.com/b/powershell/archive/2015/06/03/looking-forward-microsoft-support-for-secure-shell-ssh.aspx">yet</a>).</p>
<p>If you have installed the <code class="docutils literal"><span class="pre">kerberos</span></code> module and <code class="docutils literal"><span class="pre">ansible_user</span></code> contains <code class="docutils literal"><span class="pre">&#64;</span></code> (e.g. <code class="docutils literal"><span class="pre">username&#64;realm</span></code>), Ansible will first attempt Kerberos authentication. <em>This method uses the principal you are authenticated to Kerberos with on the control machine and not</em> <code class="docutils literal"><span class="pre">ansible_user</span></code>. If that fails, either because you are not signed into Kerberos on the control machine or because the corresponding domain account on the remote host is not available, then Ansible will fall back to &#8220;plain&#8221; username/password authentication.</p>
<p>When using your playbook, don&#8217;t forget to specify <code class="docutils literal"><span class="pre">--ask-vault-pass</span></code> to provide the password to unlock the file.</p>
<p>Test your configuration like so, by trying to contact your Windows nodes.  Note this is not an ICMP ping, but tests the Ansible
communication channel that leverages Windows remoting:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible windows <span class="o">[</span>-i inventory<span class="o">]</span> -m win_ping --ask-vault-pass
</pre></div>
</div>
<p>If you haven&#8217;t done anything to prep your systems yet, this won&#8217;t work yet.  This is covered in a later
section about how to enable PowerShell remoting - and if necessary - how to upgrade PowerShell to
a version that is 3 or higher.</p>
<p>You&#8217;ll run this command again later though, to make sure everything is working.</p>
<p>Since 2.0, the following custom inventory variables are also supported for additional configuration of WinRM connections</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ansible_winrm_scheme</span></code>: Specify the connection scheme (<code class="docutils literal"><span class="pre">http</span></code> or <code class="docutils literal"><span class="pre">https</span></code>) to use for the WinRM connection.  Ansible uses <code class="docutils literal"><span class="pre">https</span></code> by default unless the port is 5985.</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_path</span></code>: Specify an alternate path to the WinRM endpoint.  Ansible uses <code class="docutils literal"><span class="pre">/wsman</span></code> by default.</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_realm</span></code>: Specify the realm to use for Kerberos authentication.  If the username contains <code class="docutils literal"><span class="pre">&#64;</span></code>, Ansible will use the part of the username after <code class="docutils literal"><span class="pre">&#64;</span></code> by default.</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_transport</span></code>: Specify one or more transports as a comma-separated list.  By default, Ansible will use <code class="docutils literal"><span class="pre">kerberos,plaintext</span></code> if the <code class="docutils literal"><span class="pre">kerberos</span></code> module is installed and a realm is defined, otherwise <code class="docutils literal"><span class="pre">plaintext</span></code>.</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_server_cert_validation</span></code>: Specify the server certificate validation mode (<code class="docutils literal"><span class="pre">ignore</span></code> or <code class="docutils literal"><span class="pre">validate</span></code>). Ansible defaults to <code class="docutils literal"><span class="pre">validate</span></code> on Python 2.7.9 and higher, which will result in certificate validation errors against the Windows self-signed certificates. Unless verifiable certificates have been configured on the WinRM listeners, this should be set to <code class="docutils literal"><span class="pre">ignore</span></code>.</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_kerberos_delegation</span></code>: Set to <code class="docutils literal"><span class="pre">true</span></code> to enable delegation of commands on the remote host when using kerberos.</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_operation_timeout_sec</span></code>: Increase the default timeout for WinRM operations (default: <code class="docutils literal"><span class="pre">20</span></code>).</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_read_timeout_sec</span></code>: Increase the WinRM read timeout if you experience read timeout errors (default: <code class="docutils literal"><span class="pre">30</span></code>), e.g. intermittent network issues.</li>
<li><code class="docutils literal"><span class="pre">ansible_winrm_*</span></code>: Any additional keyword arguments supported by <code class="docutils literal"><span class="pre">winrm.Protocol</span></code> may be provided.</li>
</ul>
</div>
<div class="section" id="windows-system-prep">
<span id="id2"></span><h5><a class="toc-backref" href="#id23">Windows System Prep</a><a class="headerlink" href="#windows-system-prep" title="Permalink to this headline">¶</a></h5>
<p>In order for Ansible to manage your windows machines, you will have to enable and configure PowerShell remoting.</p>
<p>To automate the setup of WinRM, you can run the <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1">examples/scripts/ConfigureRemotingForAnsible.ps1</a> script on the remote machine in a PowerShell console as an administrator.</p>
<p>The example script accepts a few arguments which Admins may choose to use to modify the default setup slightly, which might be appropriate in some cases.</p>
<p>Pass the <code class="docutils literal"><span class="pre">-CertValidityDays</span></code> option to customize the expiration date of the generated certificate:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>powershell.exe -File ConfigureRemotingForAnsible.ps1 -CertValidityDays <span class="m">100</span>
</pre></div>
</div>
<p>Pass the <code class="docutils literal"><span class="pre">-EnableCredSSP</span></code> switch to enable CredSSP as an authentication option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>powershell.exe -File ConfigureRemotingForAnsible.ps1 -EnableCredSSP
</pre></div>
</div>
<p>Pass the <code class="docutils literal"><span class="pre">-ForceNewSSLCert</span></code> switch to force a new SSL certificate to be attached to an already existing winrm listener. (Avoids SSL winrm errors on syspreped Windows images after the CN changes):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>powershell.exe -File ConfigureRemotingForAnsible.ps1 -ForceNewSSLCert
</pre></div>
</div>
<p>Pass the <code class="docutils literal"><span class="pre">-SkipNetworkProfileCheck</span></code> switch to configure winrm to listen on PUBLIC zone interfaces.  (Without this option, the script will fail if any network interface on device is in PUBLIC zone):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>powershell.exe -File ConfigureRemotingForAnsible.ps1 -SkipNetworkProfileCheck
</pre></div>
</div>
<p>To troubleshoot the <code class="docutils literal"><span class="pre">ConfigureRemotingForAnsible.ps1</span></code> writes every change it makes to the Windows EventLog (useful when run unattendedly). Additionally the <code class="docutils literal"><span class="pre">-Verbose</span></code> option can be used to get more information on screen about what it is doing.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On Windows 7 and Server 2008 R2 machines, due to a bug in Windows
Management Framework 3.0, it may be necessary to install this
hotfix <a class="reference external" href="http://support.microsoft.com/kb/2842230">http://support.microsoft.com/kb/2842230</a> to avoid receiving
out of memory and stack overflow exceptions.  Newly-installed Server 2008
R2 systems which are not fully up to date with windows updates are known
to have this issue.</p>
<p class="last">Windows 8.1 and Server 2012 R2 are not affected by this issue as they
come with Windows Management Framework 4.0.</p>
</div>
</div>
<div class="section" id="getting-to-powershell-3-0-or-higher">
<span id="getting-to-powershell-three-or-higher"></span><h5><a class="toc-backref" href="#id24">Getting to PowerShell 3.0 or higher</a><a class="headerlink" href="#getting-to-powershell-3-0-or-higher" title="Permalink to this headline">¶</a></h5>
<p>PowerShell 3.0 or higher is needed for most provided Ansible modules for Windows, and is also required to run the above setup script. Note that PowerShell 3.0 is only supported on Windows 7 SP1, Windows Server 2008 SP1, and later releases of Windows.</p>
<p>Looking at an Ansible checkout, copy the <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/examples/scripts/upgrade_to_ps3.ps1">examples/scripts/upgrade_to_ps3.ps1</a> script onto the remote host and run a PowerShell console as an administrator.  You will now be running PowerShell 3 and can try connectivity again using the <code class="docutils literal"><span class="pre">win_ping</span></code> technique referenced above.</p>
</div>
<div class="section" id="what-modules-are-available">
<span id="what-windows-modules-are-available"></span><h5><a class="toc-backref" href="#id25">What modules are available</a><a class="headerlink" href="#what-modules-are-available" title="Permalink to this headline">¶</a></h5>
<p>Most of the Ansible modules in core Ansible are written for a combination of Linux/Unix machines and arbitrary web services, though there are various
Windows-only modules. These are listed in the <a class="reference external" href="http://docs.ansible.com/list_of_windows_modules.html">&#8220;windows&#8221; subcategory of the Ansible module index</a>.</p>
<p>In addition, the following core modules/action-plugins work with Windows:</p>
<ul class="simple">
<li>add_host</li>
<li>assert</li>
<li>async_status</li>
<li>debug</li>
<li>fail</li>
<li>fetch</li>
<li>group_by</li>
<li>include</li>
<li>include_role</li>
<li>include_vars</li>
<li>meta</li>
<li>pause</li>
<li>raw</li>
<li>script</li>
<li>set_fact</li>
<li>set_stats</li>
<li>setup</li>
<li>slurp</li>
<li>template (also: win_template)</li>
<li>wait_for_connection</li>
</ul>
<p>Some modules can be utilised in playbooks that target windows by delegating to localhost, depending on what you are
attempting to achieve.  For example, <code class="docutils literal"><span class="pre">assemble</span></code> can be used to create a file on your ansible controller that is then
sent to your windows targets using <code class="docutils literal"><span class="pre">win_copy</span></code>.</p>
<p>In many cases, there is no need to use or write an Ansible module. In particular, the <code class="docutils literal"><span class="pre">script</span></code> module can be used to run arbitrary PowerShell scripts, allowing Windows administrators familiar with PowerShell a very native way to do things, as in the following playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: windows
  tasks:
    - script: foo.ps1 --argument --other-argument
</pre></div>
</div>
<p>But also the <code class="docutils literal"><span class="pre">win_shell</span></code> module allows for running Powershell snippets inline:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: windows
  tasks:
    - name: Remove Appx packages <span class="o">(</span>and their hindering file assocations<span class="o">)</span>
      win_shell: <span class="p">|</span>
        Get-AppxPackage -name <span class="s2">&quot;Microsoft.ZuneMusic&quot;</span> <span class="p">|</span> Remove-AppxPackage
        Get-AppxPackage -name <span class="s2">&quot;Microsoft.ZuneVideo&quot;</span> <span class="p">|</span> Remove-AppxPackage
</pre></div>
</div>
</div>
<div class="section" id="developers-supported-modules-and-how-it-works">
<span id="developers-developers-developers"></span><h5><a class="toc-backref" href="#id26">Developers: Supported modules and how it works</a><a class="headerlink" href="#developers-supported-modules-and-how-it-works" title="Permalink to this headline">¶</a></h5>
<p>Developing Ansible modules are covered in a <a class="reference external" href="http://docs.ansible.com/developing_modules.html">later section of the documentation</a>, with a focus on Linux/Unix.
What if you want to write Windows modules for Ansible though?</p>
<p>For Windows, Ansible modules are implemented in PowerShell.  Skim those Linux/Unix module development chapters before proceeding. Windows modules in the core and extras repo live in a <code class="docutils literal"><span class="pre">windows/</span></code> subdir. Custom modules can go directly into the Ansible <code class="docutils literal"><span class="pre">library/</span></code> directories or those added in ansible.cfg. Documentation lives in a <code class="docutils literal"><span class="pre">.py</span></code> file with the same name. For example, if a module is named <code class="docutils literal"><span class="pre">win_ping</span></code>, there will be embedded documentation in the <code class="docutils literal"><span class="pre">win_ping.py</span></code> file, and the actual PowerShell code will live in a <code class="docutils literal"><span class="pre">win_ping.ps1</span></code> file. Take a look at the sources and this will make more sense.</p>
<p>Modules (ps1 files) should start as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!powershell</span>
<span class="c1"># &lt;license&gt;</span>

<span class="c1"># WANT_JSON</span>
<span class="c1"># POWERSHELL_COMMON</span>

<span class="c1"># code goes here, reading in stdin as JSON and outputting JSON</span>
</pre></div>
</div>
<p>The above magic is necessary to tell Ansible to mix in some common code and also know how to push modules out.  The common code contains some nice wrappers around working with hash data structures and emitting JSON results, and possibly a few more useful things.  Regular Ansible has this same concept for reusing Python code - this is just the windows equivalent.</p>
<p>What modules you see in <code class="docutils literal"><span class="pre">windows/</span></code> are just a start.  Additional modules may be submitted as pull requests to github.</p>
</div>
<div class="section" id="windows-facts">
<span id="id3"></span><h5><a class="toc-backref" href="#id27">Windows Facts</a><a class="headerlink" href="#windows-facts" title="Permalink to this headline">¶</a></h5>
<p>Just as with Linux/Unix, facts can be gathered for windows hosts, which will return things such as the operating system version.  To see what variables are available about a windows host, run the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible winhost.example.com -m setup
</pre></div>
</div>
<p>Note that this command invocation is exactly the same as the Linux/Unix equivalent.</p>
</div>
<div class="section" id="windows-playbook-examples">
<span id="windows-playbook-example"></span><h5><a class="toc-backref" href="#id28">Windows Playbook Examples</a><a class="headerlink" href="#windows-playbook-examples" title="Permalink to this headline">¶</a></h5>
<p>Here is an example of pushing and running a PowerShell script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> script module
  hosts: windows
  tasks:
    - name: run <span class="nb">test</span> script
      script: files/test_script.ps1
</pre></div>
</div>
<p>Running individual commands uses the <code class="docutils literal"><span class="pre">win_command</span> <span class="pre">&lt;https://docs.ansible.com/ansible/win_command_module.html&gt;</span></code> or <code class="docutils literal"><span class="pre">win_shell</span> <span class="pre">&lt;https://docs.ansible.com/ansible/win_shell_module.html&gt;</span></code> module, as opposed to the shell or command module as is common on Linux/Unix operating systems:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> raw module
  hosts: windows
  tasks:
    - name: run ipconfig
      win_command: ipconfig
      register: ipconfig
    - debug: <span class="nv">var</span><span class="o">=</span>ipconfig
</pre></div>
</div>
<p>Running common DOS commands like <code class="docutils literal"><span class="pre">del</span></code>, <code class="docutils literal"><span class="pre">move</span></code>, or <code class="docutils literal"><span class="pre">copy</span></code> is unlikely to work on a remote Windows Server using Powershell, but they can work by prefacing the commands with <code class="docutils literal"><span class="pre">CMD</span> <span class="pre">/C</span></code> and enclosing the command in double quotes as in this example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: another raw module example
  hosts: windows
  tasks:
     - name: Move file on remote Windows Server from one location to another
       win_command: CMD /C <span class="s2">&quot;MOVE /Y C:\teststuff\myfile.conf C:\builds\smtp.conf&quot;</span>
</pre></div>
</div>
<p>You may wind up with a more readable playbook by using the PowerShell equivalents of DOS commands.  For example, to achieve the same effect as the example above, you could use:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: another raw module example demonstrating powershell one liner
  hosts: windows
  tasks:
     - name: Move file on remote Windows Server from one location to another
       win_command: Powershell.exe <span class="s2">&quot;Move-Item C:\teststuff\myfile.conf C:\builds\smtp.conf&quot;</span>
</pre></div>
</div>
<p>Bear in mind that using <code class="docutils literal"><span class="pre">win_command</span></code> or <code class="docutils literal"><span class="pre">win_shell</span></code> will always report <code class="docutils literal"><span class="pre">changed</span></code>, and it is your responsibility to ensure PowerShell will need to handle idempotency as appropriate (the move examples above are inherently not idempotent), so where possible use (or write) a module.</p>
<p>Here&#8217;s an example of how to use the <code class="docutils literal"><span class="pre">win_stat</span></code> module to test for file existence. Note that the data returned by the <code class="docutils literal"><span class="pre">win_stat</span></code> module is slightly different than what is provided by the Linux equivalent:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> stat module
  hosts: windows
  tasks:
    - name: <span class="nb">test</span> stat module on file
      win_stat: <span class="nv">path</span><span class="o">=</span><span class="s2">&quot;C:/Windows/win.ini&quot;</span>
      register: stat_file

    - debug: <span class="nv">var</span><span class="o">=</span>stat_file

    - name: check stat_file result
      assert:
          that:
             - <span class="s2">&quot;stat_file.stat.exists&quot;</span>
             - <span class="s2">&quot;not stat_file.stat.isdir&quot;</span>
             - <span class="s2">&quot;stat_file.stat.size &gt; 0&quot;</span>
             - <span class="s2">&quot;stat_file.stat.md5&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="windows-contributions">
<span id="id4"></span><h5><a class="toc-backref" href="#id29">Windows Contributions</a><a class="headerlink" href="#windows-contributions" title="Permalink to this headline">¶</a></h5>
<p>Windows support in Ansible is still relatively new, and contributions are quite welcome, whether this is in the
form of new modules, tweaks to existing modules, documentation, or something else.  Please stop by the ansible-devel mailing list if you would like to get involved and say hi.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>How to write modules</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Learning Ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://docs.ansible.com/list_of_windows_modules.html">List of Windows Modules</a></dt>
<dd>Windows specific module list, all implemented in PowerShell</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-intro_networking"></span><div class="section" id="networking-support">
<h4><a class="toc-backref" href="#id3">Networking Support</a><a class="headerlink" href="#networking-support" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#networking-support" id="id3">Networking Support</a><ul>
<li><a class="reference internal" href="#working-with-networking-devices" id="id4">Working with Networking Devices</a></li>
<li><a class="reference internal" href="#network-automation-installation" id="id5">Network Automation Installation</a></li>
<li><a class="reference internal" href="#available-networking-modules" id="id6">Available Networking Modules</a></li>
<li><a class="reference internal" href="#connecting-to-networking-devices" id="id7">Connecting to Networking Devices</a></li>
<li><a class="reference internal" href="#networking-environment-variables" id="id8">Networking Environment Variables</a></li>
<li><a class="reference internal" href="#conditionals-in-networking-modules" id="id9">Conditionals in Networking Modules</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="working-with-networking-devices">
<span id="id1"></span><h5><a class="toc-backref" href="#id4">Working with Networking Devices</a><a class="headerlink" href="#working-with-networking-devices" title="Permalink to this headline">¶</a></h5>
<p>Starting with Ansible version 2.1, you can now use the familiar Ansible models of playbook authoring and module development to manage heterogenous networking devices.  Ansible supports a growing number of network devices using both CLI over SSH and API (when available) transports.</p>
</div>
<div class="section" id="network-automation-installation">
<span id="networking-installation"></span><h5><a class="toc-backref" href="#id5">Network Automation Installation</a><a class="headerlink" href="#network-automation-installation" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Install the <a class="reference external" href="http://docs.ansible.com/ansible/intro_installation.html">latest Ansible release</a>.</li>
</ul>
</div>
<div class="section" id="available-networking-modules">
<span id="networking-module-index"></span><h5><a class="toc-backref" href="#id6">Available Networking Modules</a><a class="headerlink" href="#available-networking-modules" title="Permalink to this headline">¶</a></h5>
<p>Most standard Ansible modules are designed to work with Linux/Unix or Windows machines and will not work with networking devices. Some modules (including &#8220;slurp&#8221;, &#8220;raw&#8221;, and &#8220;setup&#8221;) are platform-agnostic and will work with networking devices.</p>
<p>To see what modules are available for networking devices, please browse the <a class="reference external" href="https://docs.ansible.com/ansible/list_of_network_modules.html#">&#8220;networking&#8221; section of the Ansible module index</a>.</p>
</div>
<div class="section" id="connecting-to-networking-devices">
<span id="understanding-provider-arguments"></span><h5><a class="toc-backref" href="#id7">Connecting to Networking Devices</a><a class="headerlink" href="#connecting-to-networking-devices" title="Permalink to this headline">¶</a></h5>
<p>All core networking modules implement a <em>provider</em> argument, which is a collection of arguments used to define the characteristics of how to connect to the device.  This section will assist in understanding how the provider argument is used.</p>
<p>Each core network module supports an underlying operating system and transport.  The operating system is a one-to-one match with the module, and the transport maintains a one-to-many relationship to the operating system as appropriate. Some network operating systems only have a single transport option.</p>
<p>Each core network module supports some basic arguments for configuring the transport:</p>
<ul class="simple">
<li>host - defines the hostname or IP address of the remote host</li>
<li>port - defines the port to connect to</li>
<li>username - defines the username to use to authenticate the connection</li>
<li>password - defines the password to use to authenticate the connection</li>
<li>transport - defines the type of connection transport to build</li>
<li>authorize - enables privilege escalation for devices that require it</li>
<li>auth_pass  - defines the password, if needed, for privilege escalation</li>
</ul>
<p>Individual modules can set defaults for these arguments to common values that match device default configuration settings.  For instance, the default value for transport is universally &#8216;cli&#8217;.  Some modules support other values such as EOS (eapi) and NXOS (nxapi), while some only support &#8216;cli&#8217;.  All arguments are fully documented for each module.</p>
<p>By allowing individual tasks to set the transport arguments independently, modules that use different transport mechanisms and authentication credentials can be combined as necessary.</p>
<p>One downside to this approach is that every task needs to include the required arguments.  This is where the provider argument comes into play. The provider argument accepts keyword arguments and passes them through to the task to assign connection and authentication parameters.</p>
<p>The following two config modules are essentially identical (using nxos_config) as an example but it applies to all core networking modules:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
nxos_config:
   src: config.j2
   host: <span class="s2">&quot;{{ inventory_hostname }}&quot;</span>
   username: <span class="s2">&quot;{{ ansible_ssh_user }}&quot;</span>
   password: <span class="s2">&quot;{{ ansible_ssh_pass }}&quot;</span>
   transport: cli

---
vars:
   cli:
      host: <span class="s2">&quot;{{ inventory_hostname }}&quot;</span>
      username: <span class="s2">&quot;{{ ansible_ssh_user }}&quot;</span>
      password: <span class="s2">&quot;{{ ansible_ssh_pass }} &quot;</span>
      transport: cli


nxos_config:
   src: config.j2
   provider: <span class="s2">&quot;{{ cli }}&quot;</span>
</pre></div>
</div>
<p>Given the above two examples that are equivalent, the arguments can also be used to establish precedence and defaults.  Consider the following example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
vars:
    cli:
       host: <span class="s2">&quot;{{ inventory_hostname }}&quot;</span>
       username: operator
       password: secret
       transport: cli

tasks:
- nxos_config:
   src: config.j2
   provider: <span class="s2">&quot;{{ cli }}&quot;</span>
   username: admin
   password: admin
</pre></div>
</div>
<p>In this example, the values of admin for username and admin for password will override the values of operator in cli[&#8216;username&#8217;] and secret in cli[&#8216;password&#8217;])</p>
<p>This is true for all values in the provider including transport.  So you could have a singular task that is now supported over CLI or NXAPI (assuming the configuration is value).</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
vars:
    cli:
       host: <span class="s2">&quot;{{ inventory_hostname }}&quot;</span>
       username: operator
       password: secret
       transport: cli

tasks:
  - nxos_config:
      src: config.j2
      provider: <span class="s2">&quot;{{ cli }}&quot;</span>
      transport: nxapi
</pre></div>
</div>
<p>If all values are provided via the provider argument, the rules for requirements are still honored for the module.   For instance, take the following scenario:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
vars:
  conn:
     password: cisco_pass
     transport: cli

tasks:
- nxos_config:
  src: config.j2
  provider: <span class="s2">&quot;{{ conn }}&quot;</span>
</pre></div>
</div>
<p>Running the above task will cause an error to be generated with a message that required parameters are missing.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;missing required arguments: username,host&quot;</span>
</pre></div>
</div>
<p>Overall, this provides a very granular level of control over how credentials are used with modules.  It provides the playbook designer maximum control for changing context during a playbook run as needed.</p>
</div>
<div class="section" id="networking-environment-variables">
<span id="id2"></span><h5><a class="toc-backref" href="#id8">Networking Environment Variables</a><a class="headerlink" href="#networking-environment-variables" title="Permalink to this headline">¶</a></h5>
<p>The following environment variables are available to Ansible networking modules:</p>
<p>username <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_NET_USERNAME</span></code></p>
<p>password <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_NET_PASSWORD</span></code></p>
<p>ssh_keyfile <span class="target" id="index-2"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_NET_SSH_KEYFILE</span></code></p>
<p>authorize <span class="target" id="index-3"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_NET_AUTHORIZE</span></code></p>
<p>auth_pass <span class="target" id="index-4"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_NET_AUTH_PASS</span></code></p>
<p>Variables are evaulated in the following order, listed from lowest to highest priority:</p>
<ul class="simple">
<li>Default</li>
<li>Environment</li>
<li>Provider</li>
<li>Task arguments</li>
</ul>
</div>
<div class="section" id="conditionals-in-networking-modules">
<span id="networking-module-conditionals"></span><h5><a class="toc-backref" href="#id9">Conditionals in Networking Modules</a><a class="headerlink" href="#conditionals-in-networking-modules" title="Permalink to this headline">¶</a></h5>
<p>Ansible allows you to use conditionals to control the flow of your playbooks. Ansible networking command modules use the following unique conditional statements.</p>
<ul class="simple">
<li>eq - Equal</li>
<li>neq - Not equal</li>
<li>gt - Greater than</li>
<li>ge - Greater than or equal</li>
<li>lt - Less than</li>
<li>le - Less than or equal</li>
<li>contains - Object contains specified item</li>
</ul>
<p>Conditional statements evaluate the results from the commands that are
executed remotely on the device.  Once the task executes the command
set, the waitfor argument can be used to evaluate the results before
returning control to the Ansible playbook.</p>
<p>For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: <span class="nb">wait</span> <span class="k">for</span> interface to be admin enabled
  eos_command:
      commands:
          - show interface Ethernet4 <span class="p">|</span> json
      waitfor:
          - <span class="s2">&quot;result[0].interfaces.Ethernet4.interfaceStatus eq connected&quot;</span>
</pre></div>
</div>
<p>In the above example task, the command <code class="code docutils literal"><span class="pre">show</span> <span class="pre">interface</span> <span class="pre">Ethernet4</span> <span class="pre">|</span> <span class="pre">json</span></code>
is executed on the remote device and the results are evaluated.  If
the path
<code class="code docutils literal"><span class="pre">(result[0].interfaces.Ethernet4.interfaceStatus)</span></code> is not equal to
&#8220;connected&#8221;, then the command is retried.  This process continues
until either the condition is satisfied or the number of retries has
expired (by default, this is 10 retries at 1 second intervals).</p>
<p>The commands module can also evaluate more than one set of command
results in an interface.  For instance:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: <span class="nb">wait</span> <span class="k">for</span> interfaces to be admin enabled
  eos_command:
      commands:
          - show interface Ethernet4 <span class="p">|</span> json
          - show interface Ethernet5 <span class="p">|</span> json
      waitfor:
          - <span class="s2">&quot;result[0].interfaces.Ethernet4.interfaceStatus eq connected&quot;</span>
          - <span class="s2">&quot;result[1].interfaces.Ethernet4.interfaceStatus eq connected&quot;</span>
</pre></div>
</div>
<p>In the above example, two commands are executed on the
remote device, and the results are evaluated.  By specifying the result
index value (0 or 1), the correct result output is checked against the
conditional.</p>
<p>The waitfor argument must always start with result and then the
command index in [], where 0 is the first command in the commands list,
1 is the second command, 2 is the third and so on.</p>
</div>
</div>
</div>
</div>
<span id="document-quickstart"></span><div class="section" id="quickstart-video">
<h3>Quickstart Video<a class="headerlink" href="#quickstart-video" title="Permalink to this headline">¶</a></h3>
<p>We&#8217;ve recorded a short video that shows how to get started with Ansible that you may like to use alongside the documentation.</p>
<p>The <a class="reference external" href="https://www.ansible.com/quick-start-video">quickstart video</a> is about 13 minutes long and will show you some of the basics about your
first steps with Ansible.</p>
<p>Enjoy, and be sure to visit the rest of the documentation to learn more.</p>
</div>
<span id="document-playbooks"></span><div class="section" id="playbooks">
<h3>Playbooks<a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h3>
<p>Playbooks are Ansible&#8217;s configuration, deployment, and orchestration language.  They can describe a policy you want your remote systems to enforce, or a set of steps in a general IT process.</p>
<p>If Ansible modules are the tools in your workshop, playbooks are your instruction manuals, and your inventory of hosts are your raw material.</p>
<p>At a basic level, playbooks can be used to manage configurations of and deployments to remote machines.  At a more advanced level, they can sequence multi-tier rollouts involving rolling updates, and can delegate actions to other hosts, interacting with monitoring servers and load balancers along the way.</p>
<p>While there&#8217;s a lot of information here, there&#8217;s no need to learn everything at once.  You can start small and pick up more features
over time as you need them.</p>
<p>Playbooks are designed to be human-readable and are developed in a basic text language.  There are multiple
ways to organize playbooks and the files they include, and we&#8217;ll offer up some suggestions on that and making the most out of Ansible.</p>
<p>It is recommended to look at <a class="reference external" href="https://github.com/ansible/ansible-examples">Example Playbooks</a> while reading along with the playbook documentation.  These illustrate best practices as well as how to put many of the various concepts together.</p>
<div class="toctree-wrapper compound">
<span id="document-playbooks_intro"></span><div class="section" id="intro-to-playbooks">
<h4>Intro to Playbooks<a class="headerlink" href="#intro-to-playbooks" title="Permalink to this headline">¶</a></h4>
<div class="section" id="about-playbooks">
<span id="id1"></span><h5>About Playbooks<a class="headerlink" href="#about-playbooks" title="Permalink to this headline">¶</a></h5>
<p>Playbooks are a completely different way to use ansible than in adhoc task execution mode, and are
particularly powerful.</p>
<p>Simply put, playbooks are the basis for a really simple configuration management and multi-machine deployment system,
unlike any that already exist, and one that is very well suited to deploying complex applications.</p>
<p>Playbooks can declare configurations, but they can also orchestrate steps of
any manual ordered process, even as different steps must bounce back and forth
between sets of machines in particular orders.  They can launch tasks
synchronously or asynchronously.</p>
<p>While you might run the main <code class="docutils literal"><span class="pre">/usr/bin/ansible</span></code> program for ad-hoc
tasks, playbooks are more likely to be kept in source control and used
to push out your configuration or assure the configurations of your
remote systems are in spec.</p>
<p>There are also some full sets of playbooks illustrating a lot of these techniques in the
<a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-examples repository</a>.  We&#8217;d recommend
looking at these in another tab as you go along.</p>
<p>There are also many jumping off points after you learn playbooks, so hop back to the documentation
index after you&#8217;re done with this section.</p>
</div>
<div class="section" id="playbook-language-example">
<span id="id2"></span><h5>Playbook Language Example<a class="headerlink" href="#playbook-language-example" title="Permalink to this headline">¶</a></h5>
<p>Playbooks are expressed in YAML format (see <a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a>) and have a minimum of syntax, which intentionally
tries to not be a programming language or script, but rather a model of a configuration or a process.</p>
<p>Each playbook is composed of one or more &#8216;plays&#8217; in a list.</p>
<p>The goal of a play is to map a group of hosts to some well defined roles, represented by
things ansible calls tasks.  At a basic level, a task is nothing more than a call
to an ansible module (see <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a>).</p>
<p>By composing a playbook of multiple &#8216;plays&#8217;, it is possible to
orchestrate multi-machine deployments, running certain steps on all
machines in the webservers group, then certain steps on the database
server group, then more commands back on the webservers group, etc.</p>
<p>&#8220;plays&#8221; are more or less a sports analogy.  You can have quite a lot of plays that affect your systems
to do different things.  It&#8217;s not as if you were just defining one particular state or model, and you
can run different plays at different times.</p>
<p>For starters, here&#8217;s a playbook that contains just one play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  vars:
    http_port: <span class="m">80</span>
    max_clients: <span class="m">200</span>
  remote_user: root
  tasks:
  - name: ensure apache is at the latest version
    yum: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>latest
  - name: write the apache config file
    template: <span class="nv">src</span><span class="o">=</span>/srv/httpd.j2 <span class="nv">dest</span><span class="o">=</span>/etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running <span class="o">(</span>and <span class="nb">enable</span> it at boot<span class="o">)</span>
    service: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>started <span class="nv">enabled</span><span class="o">=</span>yes
  handlers:
    - name: restart apache
      service: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>When working with tasks that have really long parameters or modules that take
many parameters, you can break tasks items over multiple lines to improve the
structure. Below is another version of the above example but using
YAML dictionaries to supply the modules with their <code class="docutils literal"><span class="pre">key=value</span></code> arguments.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  vars:
    http_port: <span class="m">80</span>
    max_clients: <span class="m">200</span>
  remote_user: root
  tasks:
  - name: ensure apache is at the latest version
    yum:
      name: httpd
      state: latest
  - name: write the apache config file
    template:
      src: /srv/httpd.j2
      dest: /etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running
    service:
      name: httpd
      state: started
  handlers:
    - name: restart apache
      service:
        name: httpd
        state: restarted
</pre></div>
</div>
<p>Playbooks can contain multiple plays. You may have a playbook that targets first
the web servers, and then the database servers. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  remote_user: root

  tasks:
  - name: ensure apache is at the latest version
    yum: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>latest
  - name: write the apache config file
    template: <span class="nv">src</span><span class="o">=</span>/srv/httpd.j2 <span class="nv">dest</span><span class="o">=</span>/etc/httpd.conf

- hosts: databases
  remote_user: root

  tasks:
  - name: ensure postgresql is at the latest version
    yum: <span class="nv">name</span><span class="o">=</span>postgresql <span class="nv">state</span><span class="o">=</span>latest
  - name: ensure that postgresql is started
    service: <span class="nv">name</span><span class="o">=</span>postgresql <span class="nv">state</span><span class="o">=</span>started
</pre></div>
</div>
<p>You can use this method to switch between the host group you&#8217;re targeting,
the username logging into the remote servers, whether to sudo or not, and so
forth. Plays, like tasks, run in the order specified in the playbook: top to
bottom.</p>
<p>Below, we&#8217;ll break down what the various features of the playbook language are.</p>
</div>
<div class="section" id="basics">
<span id="playbook-basics"></span><h5>Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h5>
<div class="section" id="hosts-and-users">
<span id="playbook-hosts-and-users"></span><h6>Hosts and Users<a class="headerlink" href="#hosts-and-users" title="Permalink to this headline">¶</a></h6>
<p>For each play in a playbook, you get to choose which machines in your infrastructure
to target and what remote user to complete the steps (called tasks) as.</p>
<p>The <code class="docutils literal"><span class="pre">hosts</span></code> line is a list of one or more groups or host patterns,
separated by colons, as described in the <a class="reference internal" href="index.html#document-intro_patterns"><span class="doc">Patterns</span></a>
documentation.  The <code class="docutils literal"><span class="pre">remote_user</span></code> is just the name of the user account:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  remote_user: root
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">remote_user</span></code> parameter was formerly called just <code class="docutils literal"><span class="pre">user</span></code>. It was renamed in Ansible 1.4 to make it more distinguishable from the <strong>user</strong> module (used to create users on remote systems).</p>
</div>
<p>Remote users can also be defined per task:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  remote_user: root
  tasks:
    - name: <span class="nb">test</span> connection
      ping:
      remote_user: yourname
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">remote_user</span></code> parameter for tasks was added in 1.4.</p>
</div>
<p>Support for running things as another user is also available (see <a class="reference internal" href="index.html#document-become"><span class="doc">Become (Privilege Escalation)</span></a>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  remote_user: yourname
  become: yes
</pre></div>
</div>
<p>You can also use become on a particular task instead of the whole play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  remote_user: yourname
  tasks:
    - service: <span class="nv">name</span><span class="o">=</span>nginx <span class="nv">state</span><span class="o">=</span>started
      become: yes
      become_method: sudo
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The become syntax deprecates the old sudo/su specific syntax beginning in 1.9.</p>
</div>
<p>You can also login as you, and then become a user different than root:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  remote_user: yourname
  become: yes
  become_user: postgres
</pre></div>
</div>
<p>You can also use other privilege escalation methods, like su:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  remote_user: yourname
  become: yes
  become_method: su
</pre></div>
</div>
<p>If you need to specify a password to sudo, run <code class="docutils literal"><span class="pre">ansible-playbook</span></code> with <code class="docutils literal"><span class="pre">--ask-become-pass</span></code> or
when using the old sudo syntax <code class="docutils literal"><span class="pre">--ask-sudo-pass</span></code> (<code class="docutils literal"><span class="pre">-K</span></code>).  If you run a become playbook and the
playbook seems to hang, it&#8217;s probably stuck at the privilege escalation prompt.
Just <cite>Control-C</cite> to kill it and run it again adding the appropriate password.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">When using <code class="docutils literal"><span class="pre">become_user</span></code> to a user other than root, the module
arguments are briefly written into a random tempfile in <code class="docutils literal"><span class="pre">/tmp</span></code>.
These are deleted immediately after the command is executed.  This
only occurs when changing privileges from a user like &#8216;bob&#8217; to &#8216;timmy&#8217;,
not when going from &#8216;bob&#8217; to &#8216;root&#8217;, or logging in directly as &#8216;bob&#8217; or
&#8216;root&#8217;.  If it concerns you that this data is briefly readable
(not writable), avoid transferring unencrypted passwords with
<cite>become_user</cite> set.  In other cases, <code class="docutils literal"><span class="pre">/tmp</span></code> is not used and this does
not come into play. Ansible also takes care to not log password
parameters.</p>
</div>
<div class="versionadded" id="order">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
<p>You can also control the order in which hosts are run. The default is to follow the order supplied by the inventory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  order: sorted
  gather_facts: False
  tasks:
    - debug: <span class="nv">var</span><span class="o">=</span>inventory_hostname
</pre></div>
</div>
<p>Possible values for order are:</p>
<dl class="docutils">
<dt>inventory:</dt>
<dd>The default. The order is &#8216;as provided&#8217; by the inventory</dd>
<dt>reverse_inventory:</dt>
<dd>As the name implies, this reverses the order &#8216;as provided&#8217; by the inventory</dd>
<dt>sorted:</dt>
<dd>Hosts are alphabetically sorted by name</dd>
<dt>reverse_sorted:</dt>
<dd>Hosts are sorted by name in reverse alphabetical order</dd>
<dt>shuffle:</dt>
<dd>Hosts are randomly ordered each run</dd>
</dl>
</div>
<div class="section" id="tasks-list">
<span id="id3"></span><h6>Tasks list<a class="headerlink" href="#tasks-list" title="Permalink to this headline">¶</a></h6>
<p>Each play contains a list of tasks.  Tasks are executed in order, one
at a time, against all machines matched by the host pattern,
before moving on to the next task.  It is important to understand that, within a play,
all hosts are going to get the same task directives.  It is the purpose of a play to map
a selection of hosts to tasks.</p>
<p>When running the playbook, which runs top to bottom, hosts with failed tasks are
taken out of the rotation for the entire playbook.  If things fail, simply correct the playbook file and rerun.</p>
<p>The goal of each task is to execute a module, with very specific arguments.
Variables, as mentioned above, can be used in arguments to modules.</p>
<p>Modules should be idempotent, that is, running a module multiple times
in a sequence should have the same effect as running it just once. One
way to achieve idempotency is to have a module check whether its desired
final state has already been achieved, and if that state has been achieved,
to exit without performing any actions. If all the modules a playbook uses
are idempotent, then the playbook itself is likely to be idempotent, so
re-running the playbook should be safe.</p>
<p>The <strong>command</strong> and <strong>shell</strong> modules will typically rerun the same command again,
which is totally ok if the command is something like
<code class="docutils literal"><span class="pre">chmod</span></code> or <code class="docutils literal"><span class="pre">setsebool</span></code>, etc.  Though there is a <code class="docutils literal"><span class="pre">creates</span></code> flag available which can
be used to make these modules also idempotent.</p>
<p>Every task should have a <code class="docutils literal"><span class="pre">name</span></code>, which is included in the output from
running the playbook.   This is human readable output, and so it is
useful to provide good descriptions of each task step.  If the name
is not provided though, the string fed to &#8216;action&#8217; will be used for
output.</p>
<p>Tasks can be declared using the legacy <code class="docutils literal"><span class="pre">action:</span> <span class="pre">module</span> <span class="pre">options</span></code> format, but
it is recommended that you use the more conventional <code class="docutils literal"><span class="pre">module:</span> <span class="pre">options</span></code> format.
This recommended format is used throughout the documentation, but you may
encounter the older format in some playbooks.</p>
<p>Here is what a basic task looks like. As with most modules,
the service module takes <code class="docutils literal"><span class="pre">key=value</span></code> arguments:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: make sure apache is running
    service: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>started
</pre></div>
</div>
<p>The <strong>command</strong> and <strong>shell</strong> modules are the only modules that just take a list
of arguments and don&#8217;t use the <code class="docutils literal"><span class="pre">key=value</span></code> form.  This makes
them work as simply as you would expect:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: <span class="nb">enable</span> selinux
    command: /sbin/setenforce <span class="m">1</span>
</pre></div>
</div>
<p>The <strong>command</strong> and <strong>shell</strong> module care about return codes, so if you have a command
whose successful exit code is not zero, you may wish to do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: run this <span class="nb">command</span> and ignore the result
    shell: /usr/bin/somecommand <span class="o">||</span> /bin/true
</pre></div>
</div>
<p>Or this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: run this <span class="nb">command</span> and ignore the result
    shell: /usr/bin/somecommand
    ignore_errors: True
</pre></div>
</div>
<p>If the action line is getting too long for comfort you can break it on
a space and indent any continuation lines:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: Copy ansible inventory file to client
    copy: <span class="nv">src</span><span class="o">=</span>/etc/ansible/hosts <span class="nv">dest</span><span class="o">=</span>/etc/ansible/hosts
            <span class="nv">owner</span><span class="o">=</span>root <span class="nv">group</span><span class="o">=</span>root <span class="nv">mode</span><span class="o">=</span><span class="m">0644</span>
</pre></div>
</div>
<p>Variables can be used in action lines.   Suppose you defined
a variable called <code class="docutils literal"><span class="pre">vhost</span></code> in the <code class="docutils literal"><span class="pre">vars</span></code> section, you could do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: create a virtual host file <span class="k">for</span> <span class="o">{{</span> vhost <span class="o">}}</span>
    template: <span class="nv">src</span><span class="o">=</span>somefile.j2 <span class="nv">dest</span><span class="o">=</span>/etc/httpd/conf.d/<span class="o">{{</span> vhost <span class="o">}}</span>
</pre></div>
</div>
<p>Those same variables are usable in templates, which we&#8217;ll get to later.</p>
<p>Now in a very basic playbook all the tasks will be listed directly in that play, though it will usually
make more sense to break up tasks as described in <a class="reference internal" href="index.html#document-playbooks_reuse"><span class="doc">Creating Reusable Playbooks</span></a>.</p>
</div>
</div>
<div class="section" id="action-shorthand">
<span id="id4"></span><h5>Action Shorthand<a class="headerlink" href="#action-shorthand" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.8.</span></p>
</div>
<p>Ansible prefers listing modules like this in 0.8 and later:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>template: <span class="nv">src</span><span class="o">=</span>templates/foo.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
</pre></div>
</div>
<p>You will notice in earlier versions, this was only available as:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>action: template <span class="nv">src</span><span class="o">=</span>templates/foo.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
</pre></div>
</div>
<p>The old form continues to work in newer versions without any plan of deprecation.</p>
</div>
<div class="section" id="handlers-running-operations-on-change">
<span id="handlers"></span><h5>Handlers: Running Operations On Change<a class="headerlink" href="#handlers-running-operations-on-change" title="Permalink to this headline">¶</a></h5>
<p>As we&#8217;ve mentioned, modules should be idempotent and can relay when
they have made a change on the remote system.   Playbooks recognize this and
have a basic event system that can be used to respond to change.</p>
<p>These &#8216;notify&#8217; actions are triggered at the end of each block of tasks in a play, and will only be
triggered once even if notified by multiple different tasks.</p>
<p>For instance, multiple resources may indicate
that apache needs to be restarted because they have changed a config file,
but apache will only be bounced once to avoid unnecessary restarts.</p>
<p>Here&#8217;s an example of restarting two services when the contents of a file
change, but only if the file changes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: template configuration file
  template: <span class="nv">src</span><span class="o">=</span>template.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
  notify:
     - restart memcached
     - restart apache
</pre></div>
</div>
<p>The things listed in the <code class="docutils literal"><span class="pre">notify</span></code> section of a task are called
handlers.</p>
<p>Handlers are lists of tasks, not really any different from regular
tasks, that are referenced by a globally unique name, and are notified
by notifiers.  If nothing notifies a handler, it will not
run.  Regardless of how many tasks notify a handler, it will run only
once, after all of the tasks complete in a particular play.</p>
<p>Here&#8217;s an example handlers section:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>handlers:
    - name: restart memcached
      service: <span class="nv">name</span><span class="o">=</span>memcached <span class="nv">state</span><span class="o">=</span>restarted
    - name: restart apache
      service: <span class="nv">name</span><span class="o">=</span>apache <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>As of Ansible 2.2, handlers can also &#8220;listen&#8221; to generic topics, and tasks can notify those topics as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>handlers:
    - name: restart memcached
      service: <span class="nv">name</span><span class="o">=</span>memcached <span class="nv">state</span><span class="o">=</span>restarted
      listen: <span class="s2">&quot;restart web services&quot;</span>
    - name: restart apache
      service: <span class="nv">name</span><span class="o">=</span>apache <span class="nv">state</span><span class="o">=</span>restarted
      listen: <span class="s2">&quot;restart web services&quot;</span>

tasks:
    - name: restart everything
      command: <span class="nb">echo</span> <span class="s2">&quot;this task will restart the web services&quot;</span>
      notify: <span class="s2">&quot;restart web services&quot;</span>
</pre></div>
</div>
<p>This use makes it much easier to trigger multiple handlers. It also decouples handlers from their names,
making it easier to share handlers among playbooks and roles (especially when using 3rd party roles from
a shared source like Galaxy).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>Notify handlers are always run in the same order they are defined, <cite>not</cite> in the order listed in the notify-statement. This is also the case for handlers using <cite>listen</cite>.</li>
<li>Handler names and <cite>listen</cite> topics live in a global namespace.</li>
<li>If two handler tasks have the same name, only one will run.
<a class="reference external" href="https://github.com/ansible/ansible/issues/4943">*</a></li>
<li>You cannot notify a handler that is defined inside of an include. As of Ansible 2.1, this does work, however the include must be <cite>static</cite>.</li>
</ul>
</div>
<p>Roles are described later on, but it&#8217;s worthwhile to point out that:</p>
<ul class="simple">
<li>handlers notified within <code class="docutils literal"><span class="pre">pre_tasks</span></code>, <code class="docutils literal"><span class="pre">tasks</span></code>, and <code class="docutils literal"><span class="pre">post_tasks</span></code> sections are automatically flushed in the end of section where they were notified;</li>
<li>handlers notified within <code class="docutils literal"><span class="pre">roles</span></code> section are automatically flushed in the end of <code class="docutils literal"><span class="pre">tasks</span></code> section, but before any <code class="docutils literal"><span class="pre">tasks</span></code> handlers.</li>
</ul>
<p>If you ever want to flush all the handler commands immediately though, in 1.2 and later, you can:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
   - shell: some tasks go here
   - meta: flush_handlers
   - shell: some other tasks
</pre></div>
</div>
<p>In the above example any queued up handlers would be processed early when the <code class="docutils literal"><span class="pre">meta</span></code>
statement was reached.  This is a bit of a niche case but can come in handy from
time to time.</p>
</div>
<div class="section" id="executing-a-playbook">
<span id="id6"></span><h5>Executing A Playbook<a class="headerlink" href="#executing-a-playbook" title="Permalink to this headline">¶</a></h5>
<p>Now that you&#8217;ve learned playbook syntax, how do you run a playbook?  It&#8217;s simple.
Let&#8217;s run a playbook using a parallelism level of 10:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook playbook.yml -f <span class="m">10</span>
</pre></div>
</div>
</div>
<div class="section" id="ansible-pull">
<span id="id7"></span><h5>Ansible-Pull<a class="headerlink" href="#ansible-pull" title="Permalink to this headline">¶</a></h5>
<p>Should you want to invert the architecture of Ansible, so that nodes check in to a central location, instead
of pushing configuration out to them, you can.</p>
<p>The <code class="docutils literal"><span class="pre">ansible-pull</span></code> is a small script that will checkout a repo of configuration instructions from git, and then
run <code class="docutils literal"><span class="pre">ansible-playbook</span></code> against that content.</p>
<p>Assuming you load balance your checkout location, <code class="docutils literal"><span class="pre">ansible-pull</span></code> scales essentially infinitely.</p>
<p>Run <code class="docutils literal"><span class="pre">ansible-pull</span> <span class="pre">--help</span></code> for details.</p>
<p>There&#8217;s also a <a class="reference external" href="https://github.com/ansible/ansible-examples/blob/master/language_features/ansible_pull.yml">clever playbook</a> available to configure <code class="docutils literal"><span class="pre">ansible-pull</span></code> via a crontab from push mode.</p>
</div>
<div class="section" id="tips-and-tricks">
<span id="id8"></span><h5>Tips and Tricks<a class="headerlink" href="#tips-and-tricks" title="Permalink to this headline">¶</a></h5>
<p>To check the syntax of a playbook, use <code class="docutils literal"><span class="pre">ansible-playbook</span></code> with the <code class="docutils literal"><span class="pre">--syntax-check</span></code> flag. This will run the
playbook file through the parser to ensure its included files, roles, etc. have no syntax problems.</p>
<p>Look at the bottom of the playbook execution for a summary of the nodes that were targeted
and how they performed.   General failures and fatal &#8220;unreachable&#8221; communication attempts are
kept separate in the counts.</p>
<p>If you ever want to see detailed output from successful modules as well as unsuccessful ones,
use the <code class="docutils literal"><span class="pre">--verbose</span></code> flag.  This is available in Ansible 0.5 and later.</p>
<p>Ansible playbook output is vastly upgraded if the cowsay
package is installed.  Try it!</p>
<p>To see what hosts would be affected by a playbook before you run it, you
can do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook playbook.yml --list-hosts
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Various tips about managing playbooks in the real world</dd>
<dt><a class="reference internal" href="index.html#document-index"><span class="doc">Ansible Documentation</span></a></dt>
<dd>Hop back to the documentation index for a lot of special topics about playbooks</dd>
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference internal" href="index.html#document-intro_patterns"><span class="doc">Patterns</span></a></dt>
<dd>Learn about how to select hosts</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">Github examples directory</a></dt>
<dd>Complete end-to-end playbook examples</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_reuse"></span><div class="section" id="creating-reusable-playbooks">
<h4>Creating Reusable Playbooks<a class="headerlink" href="#creating-reusable-playbooks" title="Permalink to this headline">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-playbooks_reuse_includes"></span><div class="section" id="including-and-importing">
<h5><a class="toc-backref" href="#id1">Including and Importing</a><a class="headerlink" href="#including-and-importing" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#including-and-importing" id="id1">Including and Importing</a><ul>
<li><a class="reference internal" href="#includes-vs-imports" id="id2">Includes vs. Imports</a></li>
<li><a class="reference internal" href="#importing-playbooks" id="id3">Importing Playbooks</a></li>
<li><a class="reference internal" href="#including-and-importing-task-files" id="id4">Including and Importing Task Files</a></li>
<li><a class="reference internal" href="#including-and-importing-roles" id="id5">Including and Importing Roles</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="includes-vs-imports">
<h6><a class="toc-backref" href="#id2">Includes vs. Imports</a><a class="headerlink" href="#includes-vs-imports" title="Permalink to this headline">¶</a></h6>
<p>As noted in <a class="reference internal" href="index.html#document-playbooks_reuse"><span class="doc">Creating Reusable Playbooks</span></a>, include and import statements are very similar, however the Ansible executor engine treats them very differently.</p>
<ul class="simple">
<li>All <code class="docutils literal"><span class="pre">import*</span></code> statements are pre-processed at the time playbooks are parsed.</li>
<li>All <code class="docutils literal"><span class="pre">include*</span></code> statements are processed as they encountered during the execution of the playbook.</li>
</ul>
<p>Please refer to  <a class="reference internal" href="index.html#document-playbooks_reuse"><span class="doc">Creating Reusable Playbooks</span></a> for documentation concerning the trade-offs one may encounter when using each type.</p>
<p>Also be aware that this behaviour changed in 2.4; prior to that Ansible version only <code class="docutils literal"><span class="pre">include</span></code> was available, and it behaved differently depending on context.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
</div>
<div class="section" id="importing-playbooks">
<h6><a class="toc-backref" href="#id3">Importing Playbooks</a><a class="headerlink" href="#importing-playbooks" title="Permalink to this headline">¶</a></h6>
<p>It is possible to include playbooks inside a master playbook. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- import_playbook: webservers.yml
- import_playbook: databases.yml
</pre></div>
</div>
<p>The plays and tasks in each playbook listed will be run in the order they are listed, just as if they had been defined here directly.</p>
<p>Prior to 2.4 only <code class="docutils literal"><span class="pre">include</span></code> was available and worked for both playbooks and tasks as both import and include.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
</div>
<div class="section" id="including-and-importing-task-files">
<h6><a class="toc-backref" href="#id4">Including and Importing Task Files</a><a class="headerlink" href="#including-and-importing-task-files" title="Permalink to this headline">¶</a></h6>
<p>Use of included task lists is a great way to define a role that system is going to fulfill. A task include file simply contains a flat list of tasks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># common_tasks.yml</span>
---
- name: placeholder foo
  command: /bin/foo
- name: placeholder bar
  command: /bin/bar
</pre></div>
</div>
<p>You can then use <code class="docutils literal"><span class="pre">import_tasks</span></code> or <code class="docutils literal"><span class="pre">include_tasks</span></code> to include this file in your main task list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
- import_tasks: common_tasks.yml
<span class="c1"># or</span>
- include_tasks: common_tasks.yml
</pre></div>
</div>
<p>You can also pass variables into imports and includes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
- import_tasks: wordpress.yml <span class="nv">wp_user</span><span class="o">=</span>timmy
- import_tasks: wordpress.yml <span class="nv">wp_user</span><span class="o">=</span>alice
- import_tasks: wordpress.yml <span class="nv">wp_user</span><span class="o">=</span>bob
</pre></div>
</div>
<p>Variables can also be passed to include files using an alternative syntax, which also supports structured variables like dictionaries and lists:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
- include_tasks: wordpress.yml
  vars:
    wp_user: timmy
    ssh_keys:
    - <span class="s2">&quot;{{ lookup(&#39;file&#39;, &#39;keys/one.pub&#39;) }}&quot;</span>
    - <span class="s2">&quot;{{ lookup(&#39;file&#39;, &#39;keys/two.pub&#39;) }}&quot;</span>
</pre></div>
</div>
<p>Using either syntax, variables passed in can then be used in the included files. These variables will only be available to tasks within the included file. See <span class="xref doc">variable_precedence</span> for more details on variable inheritance and precedence.</p>
<p>Task include statements can be used at arbitrary depth.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Static and dynamic can be mixed, however this is not recommended as it may lead to difficult-to-diagnose bugs in your playbooks.</p>
</div>
<p>Includes and imports can also be used in the <code class="docutils literal"><span class="pre">handlers:</span></code> section; for instance, if you want to define how to restart apache, you only have to do that once for all of your playbooks.  You might make a handlers.yml that looks like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># more_handlers.yml</span>
---
- name: restart apache
  service: <span class="nv">name</span><span class="o">=</span>apache <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>And in your main playbook file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>handlers:
- include_tasks: more_handlers.yml
<span class="c1"># or</span>
- import_tasks: more_handlers.yml
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Be sure to refer to the limitations/trade-offs for handlers noted in <a class="reference internal" href="index.html#document-playbooks_reuse"><span class="doc">Creating Reusable Playbooks</span></a>.</p>
</div>
<p>You can mix in includes along with your regular non-included tasks and handlers.</p>
</div>
<div class="section" id="including-and-importing-roles">
<h6><a class="toc-backref" href="#id5">Including and Importing Roles</a><a class="headerlink" href="#including-and-importing-roles" title="Permalink to this headline">¶</a></h6>
<p>Please refer to <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a> for details on including and importing roles.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Review the basic Playbook language features</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Various tips about managing playbooks in the real world</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditionals in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Loops in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">GitHub Ansible examples</a></dt>
<dd>Complete playbook files from the GitHub project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_reuse_roles"></span><div class="section" id="roles">
<h5><a class="toc-backref" href="#id2">Roles</a><a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#roles" id="id2">Roles</a><ul>
<li><a class="reference internal" href="#role-directory-structure" id="id3">Role Directory Structure</a></li>
<li><a class="reference internal" href="#using-roles" id="id4">Using Roles</a></li>
<li><a class="reference internal" href="#role-duplication-and-execution" id="id5">Role Duplication and Execution</a></li>
<li><a class="reference internal" href="#role-default-variables" id="id6">Role Default Variables</a></li>
<li><a class="reference internal" href="#role-dependencies" id="id7">Role Dependencies</a></li>
<li><a class="reference internal" href="#embedding-modules-and-plugins-in-roles" id="id8">Embedding Modules and Plugins In Roles</a></li>
<li><a class="reference internal" href="#role-search-path" id="id9">Role Search Path</a></li>
<li><a class="reference internal" href="#ansible-galaxy" id="id10">Ansible Galaxy</a></li>
</ul>
</li>
</ul>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.2.</span></p>
</div>
<p>Roles are ways of automatically loading certain vars_files, tasks, and handlers based on a known file structure.  Grouping content by roles also allows easy sharing of roles with other users.</p>
<div class="section" id="role-directory-structure">
<h6><a class="toc-backref" href="#id3">Role Directory Structure</a><a class="headerlink" href="#role-directory-structure" title="Permalink to this headline">¶</a></h6>
<p>Example project structure:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>site.yml
webservers.yml
fooservers.yml
roles/
   common/
     tasks/
     handlers/
     files/
     templates/
     vars/
     defaults/
     meta/
   webservers/
     tasks/
     defaults/
     meta/
</pre></div>
</div>
<p>Roles expect files to be in certain directory names. Roles must include at least one of these directories, however it is perfectly fine to exclude any which are not being used. When in use, each directory must contain a <code class="docutils literal"><span class="pre">main.yml</span></code> file, which contains the relevant content:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">tasks</span></code> - contains the main list of tasks to be executed by the role.</li>
<li><code class="docutils literal"><span class="pre">handlers</span></code> - contains handlers, which may be used by this role or even anywhere outside this role.</li>
<li><code class="docutils literal"><span class="pre">defaults</span></code> - default variables for the role (see <span class="xref doc">Variables</span> for more information).</li>
<li><code class="docutils literal"><span class="pre">vars</span></code> - other variables for the role (see <span class="xref doc">Variables</span> for more information).</li>
<li><code class="docutils literal"><span class="pre">files</span></code> - contains files which can be deployed via this role.</li>
<li><code class="docutils literal"><span class="pre">templates</span></code> - contains templates which can be deployed via this role.</li>
<li><code class="docutils literal"><span class="pre">meta</span></code> - defines some meta data for this role. See below for more details.</li>
</ul>
<p>Other YAML files may be included in certain directories. For example, it is common practice to have platform-specific tasks included from the <code class="docutils literal"><span class="pre">tasks/main.yml</span></code> file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># roles/example/tasks/main.yml</span>
- name: added in <span class="m">2</span>.4, previouslly you used <span class="s1">&#39;include&#39;</span>
  import_tasks: redhat.yml
  when: ansible_os_platform<span class="p">|</span><span class="nv">lower</span> <span class="o">==</span> <span class="s1">&#39;redhat&#39;</span>
- import_tasks: debian.yml
  when: ansible_os_platform<span class="p">|</span><span class="nv">lower</span> <span class="o">==</span> <span class="s1">&#39;debian&#39;</span>

<span class="c1"># roles/example/tasks/redhat.yml</span>
- yum:
    name: <span class="s2">&quot;httpd&quot;</span>
    state: present

<span class="c1"># roles/example/tasks/debian.yml</span>
- apt:
    name: <span class="s2">&quot;apache2&quot;</span>
    state: present
</pre></div>
</div>
<p>Roles may also include modules and other plugin types. For more information, please refer to the <span class="xref doc">Embedding Modules and Plugins In Roles</span> section below.</p>
</div>
<div class="section" id="using-roles">
<h6><a class="toc-backref" href="#id4">Using Roles</a><a class="headerlink" href="#using-roles" title="Permalink to this headline">¶</a></h6>
<p>The classic (original) way to use roles is via the <code class="docutils literal"><span class="pre">roles:</span></code> option for a given play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  roles:
     - common
     - webservers
</pre></div>
</div>
<p>This designates the following behaviors, for each role &#8216;x&#8217;:</p>
<ul class="simple">
<li>If roles/x/tasks/main.yml exists, tasks listed therein will be added to the play.</li>
<li>If roles/x/handlers/main.yml exists, handlers listed therein will be added to the play.</li>
<li>If roles/x/vars/main.yml exists, variables listed therein will be added to the play.</li>
<li>If roles/x/defaults/main.yml exists, variables listed therein will be added to the play.</li>
<li>If roles/x/meta/main.yml exists, any role dependencies listed therein will be added to the list of roles (1.3 and later).</li>
<li>Any copy, script, template or include tasks (in the role) can reference files in roles/x/{files,templates,tasks}/ (dir depends on task) without having to path them relatively or absolutely.</li>
</ul>
<p>When used in this manner, the order of execution for your playbook is as follows:</p>
<ul class="simple">
<li>Any <code class="docutils literal"><span class="pre">pre_tasks</span></code> defined in the play.</li>
<li>Any handlers triggered so far will be run.</li>
<li>Each role listed in <code class="docutils literal"><span class="pre">roles</span></code> will execute in turn. Any role dependencies defined in the roles <code class="docutils literal"><span class="pre">meta/main.yml</span></code> will be run first, subject to tag filtering and conditionals.</li>
<li>Any <code class="docutils literal"><span class="pre">tasks</span></code> defined in the play.</li>
<li>Any handlers triggered so far will be run.</li>
<li>Any <code class="docutils literal"><span class="pre">post_tasks</span></code> defined in the play.</li>
<li>Any handlers triggered so far will be run.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">See below for more information regarding role dependencies.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If using tags with tasks (described later as a means of only running part of a playbook), be sure to also tag your pre_tasks, post_tasks, and role dependencies and pass those along as well, especially if the pre/post tasks and role dependencies are used for monitoring outage window control or load balancing.</p>
</div>
<p>As of Ansible 2.4, you can now use roles inline with any other tasks using <code class="docutils literal"><span class="pre">import_role</span></code> or <code class="docutils literal"><span class="pre">include_role</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  tasks:
  - debug:
      msg: <span class="s2">&quot;before we run our role&quot;</span>
  - import_role:
      name: example
  - include_role:
      name: example
  - debug:
      msg: <span class="s2">&quot;after we ran our role&quot;</span>
</pre></div>
</div>
<p>When roles are defined in the classic manner, they are treated as static imports and processed during playbook parsing.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">include_role</span></code> option was introduced in Ansible 2.3. The usage has changed slightly as of Ansible 2.4 to match the include (dynamic) vs. import (static) usage. See <span class="xref doc">Dynamic vs. Static</span> for more details.</p>
</div>
<p>The name used for the role can be a simple name (see <span class="xref doc">Role Search Path</span> below), or it can be a fully qualified path:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  roles:
    - <span class="o">{</span> role: <span class="s1">&#39;/path/to/my/roles/common&#39;</span> <span class="o">}</span>
</pre></div>
</div>
<p>Roles can accept parameters:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  roles:
    - common
    - <span class="o">{</span> role: foo_app_instance, dir: <span class="s1">&#39;/opt/a&#39;</span>, app_port: <span class="m">5000</span> <span class="o">}</span>
    - <span class="o">{</span> role: foo_app_instance, dir: <span class="s1">&#39;/opt/b&#39;</span>, app_port: <span class="m">5001</span> <span class="o">}</span>
</pre></div>
</div>
<p>Or, using the newer syntax:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  tasks:
  - include_role:
       name: foo_app_instance
    vars:
      dir: <span class="s1">&#39;/opt/a&#39;</span>
      app_port: <span class="m">5000</span>
  ...
</pre></div>
</div>
<p>You can conditionally execute a role. This is not generally recommended with the classic syntax, but is common when using <code class="docutils literal"><span class="pre">import_role</span></code> or <code class="docutils literal"><span class="pre">include_role</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  tasks:
  - include_role:
      name: some_role
    when: <span class="s2">&quot;ansible_os_family == &#39;RedHat&#39;&quot;</span>
</pre></div>
</div>
<p>Finally, you may wish to assign tags to the roles you specify. You can do so inline:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  roles:
    - <span class="o">{</span> role: foo, tags: <span class="o">[</span><span class="s2">&quot;bar&quot;</span>, <span class="s2">&quot;baz&quot;</span><span class="o">]</span> <span class="o">}</span>
</pre></div>
</div>
<p>Or, again, using the newer syntax:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  tasks:
  - import_role:
      name: foo
    tags:
    - bar
    - baz
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This <em>tags all of the tasks in that role with the tags specified</em>, appending to any tags that are specified inside the role. The tags in this example will <em>not</em> be added to tasks inside an <code class="docutils literal"><span class="pre">include_role</span></code>. Tag the <code class="docutils literal"><span class="pre">include_role</span></code> task directly in order to apply tags to tasks in included roles. If you find yourself building a role with lots of tags and you want to call subsets of the role at different times, you should consider just splitting that role into multiple roles.</p>
</div>
</div>
<div class="section" id="role-duplication-and-execution">
<h6><a class="toc-backref" href="#id5">Role Duplication and Execution</a><a class="headerlink" href="#role-duplication-and-execution" title="Permalink to this headline">¶</a></h6>
<p>Ansible will only allow a role to execute once, even if defined multiple times, if the parameters defined on the role are not different for each definition. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  roles:
  - foo
  - foo
</pre></div>
</div>
<p>Given the above, the role <code class="docutils literal"><span class="pre">foo</span></code> will only be run once.</p>
<p>To make roles run more than once, there are two options:</p>
<ol class="arabic simple">
<li>Pass different parameters in each role definition.</li>
<li>Add <code class="docutils literal"><span class="pre">allow_duplicates:</span> <span class="pre">true</span></code> to the <code class="docutils literal"><span class="pre">meta/main.yml</span></code> file for the role.</li>
</ol>
<p>Example 1 - passing different paramters:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
  roles:
  - <span class="o">{</span> role: foo, message: <span class="s2">&quot;first&quot;</span> <span class="o">}</span>
  - <span class="o">{</span> role: foo, message: <span class="s2">&quot;second&quot;</span> <span class="o">}</span>
</pre></div>
</div>
<p>In this example, because each role definition has different parameters, <code class="docutils literal"><span class="pre">foo</span></code> will run twice.</p>
<p>Example 2 - using <code class="docutils literal"><span class="pre">allow_duplicates:</span> <span class="pre">true</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># playbook.yml</span>
---
- hosts: webservers
  roles:
  - foo
  - foo

<span class="c1"># roles/foo/meta/main.yml</span>
---
allow_duplicates: <span class="nb">true</span>
</pre></div>
</div>
<p>In this example, <code class="docutils literal"><span class="pre">foo</span></code> will run twice because we have explicitly enabled it to do so.</p>
</div>
<div class="section" id="role-default-variables">
<h6><a class="toc-backref" href="#id6">Role Default Variables</a><a class="headerlink" href="#role-default-variables" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>Role default variables allow you to set default variables for included or dependent roles (see below). To create
defaults, simply add a <code class="docutils literal"><span class="pre">defaults/main.yml</span></code> file in your role directory. These variables will have the lowest priority
of any variables available, and can be easily overridden by any other variable, including inventory variables.</p>
</div>
<div class="section" id="role-dependencies">
<h6><a class="toc-backref" href="#id7">Role Dependencies</a><a class="headerlink" href="#role-dependencies" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>Role dependencies allow you to automatically pull in other roles when using a role. Role dependencies are stored in the <code class="docutils literal"><span class="pre">meta/main.yml</span></code> file contained within the role directory, as noted above. This file should contain a list of roles and parameters to insert before the specified role, such as the following in an example <code class="docutils literal"><span class="pre">roles/myapp/meta/main.yml</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
dependencies:
  - <span class="o">{</span> role: common, some_parameter: <span class="m">3</span> <span class="o">}</span>
  - <span class="o">{</span> role: apache, apache_port: <span class="m">80</span> <span class="o">}</span>
  - <span class="o">{</span> role: postgres, dbname: blarg, other_parameter: <span class="m">12</span> <span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Role dependencies must use the classic role definition style.</p>
</div>
<p>Role dependencies are always executed before the role that includes them, and may be recursive. Dependencies also follow the duplication rules specified above. If another role also lists it as a dependency, it will not be run again based on the same rules given above.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Always remember that when using <code class="docutils literal"><span class="pre">allow_duplicates:</span> <span class="pre">true</span></code>, it needs to be in the dependent role&#8217;s <code class="docutils literal"><span class="pre">meta/main.yml</span></code>, not the parent.</p>
</div>
<p>For example, a role named <code class="docutils literal"><span class="pre">car</span></code> depends on a role named <code class="docutils literal"><span class="pre">wheel</span></code> as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
dependencies:
- <span class="o">{</span> role: wheel, n: <span class="m">1</span> <span class="o">}</span>
- <span class="o">{</span> role: wheel, n: <span class="m">2</span> <span class="o">}</span>
- <span class="o">{</span> role: wheel, n: <span class="m">3</span> <span class="o">}</span>
- <span class="o">{</span> role: wheel, n: <span class="m">4</span> <span class="o">}</span>
</pre></div>
</div>
<p>And the <code class="docutils literal"><span class="pre">wheel</span></code> role depends on two roles: <code class="docutils literal"><span class="pre">tire</span></code> and <code class="docutils literal"><span class="pre">brake</span></code>. The <code class="docutils literal"><span class="pre">meta/main.yml</span></code> for wheel would then contain the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
dependencies:
- <span class="o">{</span> role: tire <span class="o">}</span>
- <span class="o">{</span> role: brake <span class="o">}</span>
</pre></div>
</div>
<p>And the <code class="docutils literal"><span class="pre">meta/main.yml</span></code> for <code class="docutils literal"><span class="pre">tire</span></code> and <code class="docutils literal"><span class="pre">brake</span></code> would contain the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
allow_duplicates: <span class="nb">true</span>
</pre></div>
</div>
<p>The resulting order of execution would be as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tire<span class="o">(</span><span class="nv">n</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
brake<span class="o">(</span><span class="nv">n</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
wheel<span class="o">(</span><span class="nv">n</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
tire<span class="o">(</span><span class="nv">n</span><span class="o">=</span><span class="m">2</span><span class="o">)</span>
brake<span class="o">(</span><span class="nv">n</span><span class="o">=</span><span class="m">2</span><span class="o">)</span>
wheel<span class="o">(</span><span class="nv">n</span><span class="o">=</span><span class="m">2</span><span class="o">)</span>
...
car
</pre></div>
</div>
<p>Note that we did not have to use <code class="docutils literal"><span class="pre">allow_duplicates:</span> <span class="pre">true</span></code> for <code class="docutils literal"><span class="pre">wheel</span></code>, because each instance defined by <code class="docutils literal"><span class="pre">car</span></code> uses different parameter values.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Variable inheritance and scope are detailed in the <a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a>.</p>
</div>
</div>
<div class="section" id="embedding-modules-and-plugins-in-roles">
<h6><a class="toc-backref" href="#id8">Embedding Modules and Plugins In Roles</a><a class="headerlink" href="#embedding-modules-and-plugins-in-roles" title="Permalink to this headline">¶</a></h6>
<p>This is an advanced topic that should not be relevant for most users.</p>
<p>If you write a custom module (see <a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a>) or a plugin (see <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a>), you may wish to distribute it as part of a role.
Generally speaking, Ansible as a project is very interested in taking high-quality modules into ansible core for inclusion, so this shouldn&#8217;t be the norm, but it&#8217;s quite easy to do.</p>
<p>A good example for this is if you worked at a company called AcmeWidgets, and wrote an internal module that helped configure your internal software, and you wanted other
people in your organization to easily use this module &#8211; but you didn&#8217;t want to tell everyone how to configure their Ansible library path.</p>
<p>Alongside the &#8216;tasks&#8217; and &#8216;handlers&#8217; structure of a role, add a directory named &#8216;library&#8217;.  In this &#8216;library&#8217; directory, then include the module directly inside of it.</p>
<p>Assuming you had this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles/
   my_custom_modules/
       library/
          module1
          module2
</pre></div>
</div>
<p>The module will be usable in the role itself, as well as any roles that are called <em>after</em> this role, as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: webservers
  roles:
    - my_custom_modules
    - some_other_role_using_my_custom_modules
    - yet_another_role_using_my_custom_modules
</pre></div>
</div>
<p>This can also be used, with some limitations, to modify modules in Ansible&#8217;s core distribution, such as to use development versions of modules before they are released in production releases.  This is not always advisable as API signatures may change in core components, however, and is not always guaranteed to work.  It can be a handy way of carrying a patch against a core module, however, should you have good reason for this.  Naturally the project prefers that contributions be directed back to github whenever possible via a pull request.</p>
<p>The same mechanism can be used to embed and distribute plugins in a role, using the same schema. For example, for a filter plugin:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles/
   my_custom_filter/
       filter_plugins
          filter1
          filter2
</pre></div>
</div>
<p>They can then be used in a template or a jinja template in any role called after &#8216;my_custom_filter&#8217;</p>
</div>
<div class="section" id="role-search-path">
<h6><a class="toc-backref" href="#id9">Role Search Path</a><a class="headerlink" href="#role-search-path" title="Permalink to this headline">¶</a></h6>
<p>Ansible will search for roles in the following way:</p>
<ul class="simple">
<li>A <code class="docutils literal"><span class="pre">roles/</span></code> directory, relative to the playbook file.</li>
<li>By default, in <code class="docutils literal"><span class="pre">/etc/ansible/roles</span></code></li>
</ul>
<p>In Ansible 1.4 and later you can configure an additional roles_path to search for roles.  Use this to check all of your common roles out to one location, and share them easily between multiple playbook projects.  See <a class="reference internal" href="index.html#document-intro_configuration"><span class="doc">Configuration file</span></a> for details about how to set this up in ansible.cfg.</p>
</div>
<div class="section" id="ansible-galaxy">
<h6><a class="toc-backref" href="#id10">Ansible Galaxy</a><a class="headerlink" href="#ansible-galaxy" title="Permalink to this headline">¶</a></h6>
<p><a class="reference external" href="https://galaxy.ansible.com">Ansible Galaxy</a> is a free site for finding, downloading, rating, and reviewing all kinds of community developed Ansible roles and can be a great way to get a jumpstart on your automation projects.</p>
<p>You can sign up with social auth, and the download client &#8216;ansible-galaxy&#8217; is included in Ansible 1.4.2 and later.</p>
<p>Read the &#8220;About&#8221; page on the Galaxy site for more information.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-galaxy"><span class="doc">Ansible Galaxy</span></a></dt>
<dd>How to share roles on galaxy, role management</dd>
<dt><a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Review the basic Playbook language features</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Various tips about managing playbooks in the real world</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditionals in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Loops in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">GitHub Ansible examples</a></dt>
<dd>Complete playbook files from the GitHub project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
</div>
<p>While it is possible to write a playbook in one very large file (and you might start out learning playbooks this way), eventually you&#8217;ll want to reuse files and start to organize things. In Ansible, there are three ways to do this: includes, imports, and roles.</p>
<p>Includes and imports (added in 2.4) allow users to break up large playbooks into smaller files, which can be used across multiple parent playbooks or even multiple times within the same Playbook.</p>
<p>Roles allow more than just tasks to be packaged together and can include variables, handlers, or even modules and other plugins. Unlike includes and imports, roles can also be uploaded and shared via Ansible Galaxy.</p>
<div class="section" id="dynamic-vs-static">
<h5>Dynamic vs. Static<a class="headerlink" href="#dynamic-vs-static" title="Permalink to this headline">¶</a></h5>
<p>Ansible has two modes of operation for reusable content: dynamic and static.</p>
<p>In Ansible 2.0, the concept of <em>dynamic</em> includes was introduced. Due to some limitations with making all includes dynamic in this way, the ability to force includes to be <em>static</em> was introduced in Ansible 2.1. Because the <em>include</em> task became overloaded to encompass both static and dynamic syntaxes, and because the default behavior of an include could change based on other options set on the Task, Ansible 2.4 introduces the concept of <code class="docutils literal"><span class="pre">include</span></code> vs. <code class="docutils literal"><span class="pre">import</span></code>.</p>
<p>If you use any <code class="docutils literal"><span class="pre">import*</span></code> Task (<code class="docutils literal"><span class="pre">import_playbook</span></code>, <code class="docutils literal"><span class="pre">import_tasks</span></code>, etc.), it will be <em>static</em>.
If you use any <code class="docutils literal"><span class="pre">include*</span></code> Task (<code class="docutils literal"><span class="pre">include_tasks</span></code>, <code class="docutils literal"><span class="pre">include_role</span></code>, etc.), it will be <em>dynamic</em>.</p>
<p>The bare <code class="docutils literal"><span class="pre">include</span></code> task (which was used for both Task files and Playbook-level includes) is still available, however it is now considered <em>deprecated</em>.</p>
</div>
<div class="section" id="differences-between-static-and-dynamic">
<h5>Differences Between Static and Dynamic<a class="headerlink" href="#differences-between-static-and-dynamic" title="Permalink to this headline">¶</a></h5>
<p>The two modes of operation are pretty simple:</p>
<ul class="simple">
<li>Ansible pre-processes all static imports during Playbook parsing time.</li>
<li>Dynamic includes are processed during runtime at the point in which that task is encountered.</li>
</ul>
<p>When it comes to Ansible task options like <code class="docutils literal"><span class="pre">tags</span></code> and conditional statements (<code class="docutils literal"><span class="pre">when:</span></code>):</p>
<ul class="simple">
<li>For static imports, the parent task options will be copied to all child tasks contained within the import.</li>
<li>For dynamic includes, the task options will <em>only</em> apply to the dynamic task as it is evaluated, and will not be copied to child tasks.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Roles are a somewhat special case. Prior to Ansible 2.3, roles were always statically included via the special <code class="docutils literal"><span class="pre">roles:</span></code> option for a given play and were always executed first before any other play tasks (unless <code class="docutils literal"><span class="pre">pre_tasks</span></code> were used). Roles can still be used this way, however, Ansible 2.3 introduced the <code class="docutils literal"><span class="pre">include_role</span></code> option to allow roles to be executed inline with other tasks.</p>
</div>
</div>
<div class="section" id="tradeoffs-and-pitfalls-between-includes-and-imports">
<h5>Tradeoffs and Pitfalls Between Includes and Imports<a class="headerlink" href="#tradeoffs-and-pitfalls-between-includes-and-imports" title="Permalink to this headline">¶</a></h5>
<p>Using <code class="docutils literal"><span class="pre">include*</span></code> vs. <code class="docutils literal"><span class="pre">import*</span></code> has some advantages as well as some tradeoffs which users should consider when choosing to use each:</p>
<p>The primary advantage of using <code class="docutils literal"><span class="pre">include*</span></code> statements is looping. When a loop is used with an include, the included tasks or role will be executed once for each item in the loop.</p>
<p>Using <code class="docutils literal"><span class="pre">include*</span></code> does have some limitations when compared to <code class="docutils literal"><span class="pre">import*</span></code> statements:</p>
<ul class="simple">
<li>Tags which only exist inside a dynamic include will not show up in &#8211;list-tags output.</li>
<li>Tasks which only exist inside a dynamic include will not show up in &#8211;list-tasks output.</li>
<li>You cannot use <code class="docutils literal"><span class="pre">notify</span></code> to trigger a handler name which comes from inside a dynamic include (see note below).</li>
<li>You cannot use <code class="docutils literal"><span class="pre">--start-at-task</span></code> to begin execution at a task inside a dynamic include.</li>
</ul>
<p>Using <code class="docutils literal"><span class="pre">import*</span></code> can also have some limitations when compared to dynamic includes:</p>
<ul class="simple">
<li>As noted above, loops cannot be used with imports at all.</li>
<li>When using variables for the target file or role name, variables from inventory sources (host/group vars, etc.) cannot be used.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Regarding the use of <code class="docutils literal"><span class="pre">notify</span></code> for dynamic tasks: it is still possible to trigger the dynamic include itself, which would result in all tasks within the include being run.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Review the basic Playbook language features</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditionals in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Loops in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Various tips about managing playbooks in the real world</dd>
<dt><a class="reference internal" href="index.html#document-galaxy"><span class="doc">Ansible Galaxy</span></a></dt>
<dd>How to share roles on galaxy, role management</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">GitHub Ansible examples</a></dt>
<dd>Complete playbook files from the GitHub project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_variables"></span><div class="section" id="variables">
<h4><a class="toc-backref" href="#id14">Variables</a><a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#variables" id="id14">Variables</a><ul>
<li><a class="reference internal" href="#what-makes-a-valid-variable-name" id="id15">What Makes A Valid Variable Name</a></li>
<li><a class="reference internal" href="#variables-defined-in-inventory" id="id16">Variables Defined in Inventory</a></li>
<li><a class="reference internal" href="#variables-defined-in-a-playbook" id="id17">Variables Defined in a Playbook</a></li>
<li><a class="reference internal" href="#variables-defined-from-included-files-and-roles" id="id18">Variables defined from included files and roles</a></li>
<li><a class="reference internal" href="#using-variables-about-jinja2" id="id19">Using Variables: About Jinja2</a></li>
<li><a class="reference internal" href="#jinja2-filters" id="id20">Jinja2 Filters</a></li>
<li><a class="reference internal" href="#hey-wait-a-yaml-gotcha" id="id21">Hey Wait, A YAML Gotcha</a></li>
<li><a class="reference internal" href="#information-discovered-from-systems-facts" id="id22">Information discovered from systems: Facts</a></li>
<li><a class="reference internal" href="#turning-off-facts" id="id23">Turning Off Facts</a></li>
<li><a class="reference internal" href="#local-facts-facts-d" id="id24">Local Facts (Facts.d)</a></li>
<li><a class="reference internal" href="#ansible-version" id="id25">Ansible version</a></li>
<li><a class="reference internal" href="#fact-caching" id="id26">Fact Caching</a></li>
<li><a class="reference internal" href="#registered-variables" id="id27">Registered Variables</a></li>
<li><a class="reference internal" href="#accessing-complex-variable-data" id="id28">Accessing Complex Variable Data</a></li>
<li><a class="reference internal" href="#magic-variables-and-how-to-access-information-about-other-hosts" id="id29">Magic Variables, and How To Access Information About Other Hosts</a></li>
<li><a class="reference internal" href="#variable-file-separation" id="id30">Variable File Separation</a></li>
<li><a class="reference internal" href="#passing-variables-on-the-command-line" id="id31">Passing Variables On The Command Line</a></li>
<li><a class="reference internal" href="#variable-precedence-where-should-i-put-a-variable" id="id32">Variable Precedence: Where Should I Put A Variable?</a></li>
<li><a class="reference internal" href="#variable-scopes" id="id33">Variable Scopes</a></li>
<li><a class="reference internal" href="#variable-examples" id="id34">Variable Examples</a></li>
<li><a class="reference internal" href="#advanced-syntax" id="id35">Advanced Syntax</a></li>
</ul>
</li>
</ul>
</div>
<p>While automation exists to make it easier to make things repeatable, all of your systems are likely not exactly alike.</p>
<p>On some systems you may want to set some behavior or configuration that is slightly different from others.</p>
<p>Also, some of the observed behavior or state
of remote systems might need to influence how you configure those systems.  (Such as you might need to find out the IP
address of a system and even use it as a configuration value on another system).</p>
<p>You might have some templates for configuration files that are mostly the same, but slightly different based on those variables.</p>
<p>Variables in Ansible are how we deal with differences between systems.</p>
<p>To understand variables you&#8217;ll also want to dig into <a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a> and <a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a>.
Useful things like the <strong>group_by</strong> module
and the <code class="docutils literal"><span class="pre">when</span></code> conditional can also be used with variables, and to help manage differences between systems.</p>
<p>It&#8217;s highly recommended that you consult the ansible-examples github repository to see a lot of examples of variables put to use.</p>
<p>For best practices advice, refer to <a class="reference internal" href="index.html#best-practices-for-variables-and-vaults"><span class="std std-ref">Variables and Vaults</span></a> in the <em>Best Practices</em> chapter.</p>
<div class="section" id="what-makes-a-valid-variable-name">
<span id="valid-variable-names"></span><h5><a class="toc-backref" href="#id15">What Makes A Valid Variable Name</a><a class="headerlink" href="#what-makes-a-valid-variable-name" title="Permalink to this headline">¶</a></h5>
<p>Before we start using variables it&#8217;s important to know what are valid variable names.</p>
<p>Variable names should be letters, numbers, and underscores.  Variables should always start with a letter.</p>
<p><code class="docutils literal"><span class="pre">foo_port</span></code> is a great variable.  <code class="docutils literal"><span class="pre">foo5</span></code> is fine too.</p>
<p><code class="docutils literal"><span class="pre">foo-port</span></code>, <code class="docutils literal"><span class="pre">foo</span> <span class="pre">port</span></code>, <code class="docutils literal"><span class="pre">foo.port</span></code> and <code class="docutils literal"><span class="pre">12</span></code> are not valid variable names.</p>
<p>YAML also supports dictionaries which map keys to values.  For instance:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>foo:
  field1: one
  field2: two
</pre></div>
</div>
<p>You can then reference a specific field in the dictionary using either bracket
notation or dot notation:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>foo<span class="o">[</span><span class="s1">&#39;field1&#39;</span><span class="o">]</span>
foo.field1
</pre></div>
</div>
<p>These will both reference the same value (&#8220;one&#8221;).  However, if you choose to
use dot notation be aware that some keys can cause problems because they
collide with attributes and methods of python dictionaries.  You should use
bracket notation instead of dot notation if you use keys which start and end
with two underscores (Those are reserved for special meanings in python) or
are any of the known public attributes:</p>
<p><code class="docutils literal"><span class="pre">add</span></code>, <code class="docutils literal"><span class="pre">append</span></code>, <code class="docutils literal"><span class="pre">as_integer_ratio</span></code>, <code class="docutils literal"><span class="pre">bit_length</span></code>, <code class="docutils literal"><span class="pre">capitalize</span></code>, <code class="docutils literal"><span class="pre">center</span></code>, <code class="docutils literal"><span class="pre">clear</span></code>, <code class="docutils literal"><span class="pre">conjugate</span></code>, <code class="docutils literal"><span class="pre">copy</span></code>, <code class="docutils literal"><span class="pre">count</span></code>, <code class="docutils literal"><span class="pre">decode</span></code>, <code class="docutils literal"><span class="pre">denominator</span></code>, <code class="docutils literal"><span class="pre">difference</span></code>, <code class="docutils literal"><span class="pre">difference_update</span></code>, <code class="docutils literal"><span class="pre">discard</span></code>, <code class="docutils literal"><span class="pre">encode</span></code>, <code class="docutils literal"><span class="pre">endswith</span></code>, <code class="docutils literal"><span class="pre">expandtabs</span></code>, <code class="docutils literal"><span class="pre">extend</span></code>, <code class="docutils literal"><span class="pre">find</span></code>, <code class="docutils literal"><span class="pre">format</span></code>, <code class="docutils literal"><span class="pre">fromhex</span></code>, <code class="docutils literal"><span class="pre">fromkeys</span></code>, <code class="docutils literal"><span class="pre">get</span></code>, <code class="docutils literal"><span class="pre">has_key</span></code>, <code class="docutils literal"><span class="pre">hex</span></code>, <code class="docutils literal"><span class="pre">imag</span></code>, <code class="docutils literal"><span class="pre">index</span></code>, <code class="docutils literal"><span class="pre">insert</span></code>, <code class="docutils literal"><span class="pre">intersection</span></code>, <code class="docutils literal"><span class="pre">intersection_update</span></code>, <code class="docutils literal"><span class="pre">isalnum</span></code>, <code class="docutils literal"><span class="pre">isalpha</span></code>, <code class="docutils literal"><span class="pre">isdecimal</span></code>, <code class="docutils literal"><span class="pre">isdigit</span></code>, <code class="docutils literal"><span class="pre">isdisjoint</span></code>, <code class="docutils literal"><span class="pre">is_integer</span></code>, <code class="docutils literal"><span class="pre">islower</span></code>, <code class="docutils literal"><span class="pre">isnumeric</span></code>, <code class="docutils literal"><span class="pre">isspace</span></code>, <code class="docutils literal"><span class="pre">issubset</span></code>, <code class="docutils literal"><span class="pre">issuperset</span></code>, <code class="docutils literal"><span class="pre">istitle</span></code>, <code class="docutils literal"><span class="pre">isupper</span></code>, <code class="docutils literal"><span class="pre">items</span></code>, <code class="docutils literal"><span class="pre">iteritems</span></code>, <code class="docutils literal"><span class="pre">iterkeys</span></code>, <code class="docutils literal"><span class="pre">itervalues</span></code>, <code class="docutils literal"><span class="pre">join</span></code>, <code class="docutils literal"><span class="pre">keys</span></code>, <code class="docutils literal"><span class="pre">ljust</span></code>, <code class="docutils literal"><span class="pre">lower</span></code>, <code class="docutils literal"><span class="pre">lstrip</span></code>, <code class="docutils literal"><span class="pre">numerator</span></code>, <code class="docutils literal"><span class="pre">partition</span></code>, <code class="docutils literal"><span class="pre">pop</span></code>, <code class="docutils literal"><span class="pre">popitem</span></code>, <code class="docutils literal"><span class="pre">real</span></code>, <code class="docutils literal"><span class="pre">remove</span></code>, <code class="docutils literal"><span class="pre">replace</span></code>, <code class="docutils literal"><span class="pre">reverse</span></code>, <code class="docutils literal"><span class="pre">rfind</span></code>, <code class="docutils literal"><span class="pre">rindex</span></code>, <code class="docutils literal"><span class="pre">rjust</span></code>, <code class="docutils literal"><span class="pre">rpartition</span></code>, <code class="docutils literal"><span class="pre">rsplit</span></code>, <code class="docutils literal"><span class="pre">rstrip</span></code>, <code class="docutils literal"><span class="pre">setdefault</span></code>, <code class="docutils literal"><span class="pre">sort</span></code>, <code class="docutils literal"><span class="pre">split</span></code>, <code class="docutils literal"><span class="pre">splitlines</span></code>, <code class="docutils literal"><span class="pre">startswith</span></code>, <code class="docutils literal"><span class="pre">strip</span></code>, <code class="docutils literal"><span class="pre">swapcase</span></code>, <code class="docutils literal"><span class="pre">symmetric_difference</span></code>, <code class="docutils literal"><span class="pre">symmetric_difference_update</span></code>, <code class="docutils literal"><span class="pre">title</span></code>, <code class="docutils literal"><span class="pre">translate</span></code>, <code class="docutils literal"><span class="pre">union</span></code>, <code class="docutils literal"><span class="pre">update</span></code>, <code class="docutils literal"><span class="pre">upper</span></code>, <code class="docutils literal"><span class="pre">values</span></code>, <code class="docutils literal"><span class="pre">viewitems</span></code>, <code class="docutils literal"><span class="pre">viewkeys</span></code>, <code class="docutils literal"><span class="pre">viewvalues</span></code>, <code class="docutils literal"><span class="pre">zfill</span></code>.</p>
</div>
<div class="section" id="variables-defined-in-inventory">
<span id="variables-in-inventory"></span><h5><a class="toc-backref" href="#id16">Variables Defined in Inventory</a><a class="headerlink" href="#variables-defined-in-inventory" title="Permalink to this headline">¶</a></h5>
<p>We&#8217;ve actually already covered a lot about variables in another section, so far this shouldn&#8217;t be terribly new, but
a bit of a refresher.</p>
<p>Often you&#8217;ll want to set variables based on what groups a machine is in.  For instance, maybe machines in Boston
want to use &#8216;boston.ntp.example.com&#8217; as an NTP server.</p>
<p>See the <a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a> document for multiple ways on how to define variables in inventory.</p>
</div>
<div class="section" id="variables-defined-in-a-playbook">
<span id="playbook-variables"></span><h5><a class="toc-backref" href="#id17">Variables Defined in a Playbook</a><a class="headerlink" href="#variables-defined-in-a-playbook" title="Permalink to this headline">¶</a></h5>
<p>In a playbook, it&#8217;s possible to define variables directly inline like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: webservers
  vars:
    http_port: <span class="m">80</span>
</pre></div>
</div>
<p>This can be nice as it&#8217;s right there when you are reading the playbook.</p>
</div>
<div class="section" id="variables-defined-from-included-files-and-roles">
<span id="included-variables"></span><h5><a class="toc-backref" href="#id18">Variables defined from included files and roles</a><a class="headerlink" href="#variables-defined-from-included-files-and-roles" title="Permalink to this headline">¶</a></h5>
<p>It turns out we&#8217;ve already talked about variables in another place too.</p>
<p>As described in <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a>, variables can also be included in the playbook via include files, which may or may
not be part of an &#8220;Ansible Role&#8221;.  Usage of roles is preferred as it provides a nice organizational system.</p>
</div>
<div class="section" id="using-variables-about-jinja2">
<span id="about-jinja2"></span><h5><a class="toc-backref" href="#id19">Using Variables: About Jinja2</a><a class="headerlink" href="#using-variables-about-jinja2" title="Permalink to this headline">¶</a></h5>
<p>It&#8217;s nice enough to know about how to define variables, but how do you use them?</p>
<p>Ansible allows you to
reference variables in your playbooks using the Jinja2 templating system.  While you can do a lot of complex
things in Jinja, only the basics are things you really need to learn at first.</p>
<p>For instance, in a simple template, you can do something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>My amp goes to <span class="o">{{</span> max_amp_value <span class="o">}}</span>
</pre></div>
</div>
<p>And that will provide the most basic form of variable substitution.</p>
<p>This is also valid directly in playbooks, and you&#8217;ll occasionally want to do things like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>template: <span class="nv">src</span><span class="o">=</span>foo.cfg.j2 <span class="nv">dest</span><span class="o">={{</span> remote_install_path <span class="o">}}</span>/foo.cfg
</pre></div>
</div>
<p>In the above example, we used a variable to help decide where to place a file.</p>
<p>Inside a template you automatically have access to all of the variables that are in scope for a host.  Actually
it&#8217;s more than that &#8211; you can also read variables about other hosts.  We&#8217;ll show how to do that in a bit.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ansible allows Jinja2 loops and conditionals in templates, but in playbooks, we do not use them.  Ansible
playbooks are pure machine-parseable YAML.  This is a rather important feature as it means it is possible to code-generate
pieces of files, or to have other ecosystem tools read Ansible files.  Not everyone will need this but it can unlock
possibilities.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks_templating"><span class="doc">Templating (Jinja2)</span></a></dt>
<dd>More information about Jinja2 templating</dd>
</dl>
</div>
</div>
<div class="section" id="jinja2-filters">
<span id="id1"></span><h5><a class="toc-backref" href="#id20">Jinja2 Filters</a><a class="headerlink" href="#jinja2-filters" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These are infrequently utilized features.  Use them if they fit a use case you have, but this is optional knowledge.</p>
</div>
<p>Filters in Jinja2 are a way of transforming template expressions from one kind of data into another.  Jinja2
ships with many of these. See <a class="reference external" href="http://jinja.pocoo.org/docs/templates/#builtin-filters">builtin filters</a> in the official Jinja2 template documentation.</p>
<p>In addition to those, Ansible supplies many more. See the <a class="reference internal" href="index.html#document-playbooks_filters"><span class="doc">Filters</span></a> document
for a list of available filters and example usage guide.</p>
</div>
<div class="section" id="hey-wait-a-yaml-gotcha">
<span id="yaml-gotchas"></span><h5><a class="toc-backref" href="#id21">Hey Wait, A YAML Gotcha</a><a class="headerlink" href="#hey-wait-a-yaml-gotcha" title="Permalink to this headline">¶</a></h5>
<p>YAML syntax requires that if you start a value with <code class="docutils literal"><span class="pre">{{</span> <span class="pre">foo</span> <span class="pre">}}</span></code> you quote the whole line, since it wants to be
sure you aren&#8217;t trying to start a YAML dictionary.  This is covered on the <a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a> page.</p>
<p>This won&#8217;t work:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: app_servers
  vars:
      app_path: <span class="o">{{</span> base_path <span class="o">}}</span>/22
</pre></div>
</div>
<p>Do it like this and you&#8217;ll be fine:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: app_servers
  vars:
       app_path: <span class="s2">&quot;{{ base_path }}/22&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="information-discovered-from-systems-facts">
<span id="vars-and-facts"></span><h5><a class="toc-backref" href="#id22">Information discovered from systems: Facts</a><a class="headerlink" href="#information-discovered-from-systems-facts" title="Permalink to this headline">¶</a></h5>
<p>There are other places where variables can come from, but these are a type of variable that are discovered, not set by the user.</p>
<p>Facts are information derived from speaking with your remote systems.</p>
<p>An example of this might be the ip address of the remote host, or what the operating system is.</p>
<p>To see what information is available, try the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible hostname -m setup
</pre></div>
</div>
<p>This will return a ginormous amount of variable data, which may look like this, as taken from Ansible 1.4 on a Ubuntu 12.04 system</p>
<p>In the above the model of the first harddrive may be referenced in a template or playbook as:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_devices.sda.model <span class="o">}}</span>
</pre></div>
</div>
<p>Similarly, the hostname as the system reports it is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_nodename <span class="o">}}</span>
</pre></div>
</div>
<p>and the unqualified hostname shows the string before the first period(.):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_hostname <span class="o">}}</span>
</pre></div>
</div>
<p>Facts are frequently used in conditionals (see <a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a>) and also in templates.</p>
<p>Facts can be also used to create dynamic groups of hosts that match particular criteria, see the <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> documentation on <strong>group_by</strong> for details, as well as in generalized conditional statements as discussed in the <a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a> chapter.</p>
</div>
<div class="section" id="turning-off-facts">
<span id="disabling-facts"></span><h5><a class="toc-backref" href="#id23">Turning Off Facts</a><a class="headerlink" href="#turning-off-facts" title="Permalink to this headline">¶</a></h5>
<p>If you know you don&#8217;t need any fact data about your hosts, and know everything about your systems centrally, you
can turn off fact gathering.  This has advantages in scaling Ansible in push mode with very large numbers of
systems, mainly, or if you are using Ansible on experimental platforms.   In any play, just do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: whatever
  gather_facts: no
</pre></div>
</div>
</div>
<div class="section" id="local-facts-facts-d">
<span id="local-facts"></span><h5><a class="toc-backref" href="#id24">Local Facts (Facts.d)</a><a class="headerlink" href="#local-facts-facts-d" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>As discussed in the playbooks chapter, Ansible facts are a way of getting data about remote systems for use in playbook variables.</p>
<p>Usually these are discovered automatically by the <strong>setup</strong> module in Ansible. Users can also write custom facts modules, as described
in the API guide.  However, what if you want to have a simple way to provide system or user
provided data for use in Ansible variables, without writing a fact module?</p>
<p>For instance, what if you want users to be able to control some aspect about how their systems are managed? &#8220;Facts.d&#8221; is one such mechanism.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Perhaps &#8220;local facts&#8221; is a bit of a misnomer, it means &#8220;locally supplied user values&#8221; as opposed to &#8220;centrally supplied user values&#8221;, or what facts are &#8211; &#8220;locally dynamically determined values&#8221;.</p>
</div>
<p>If a remotely managed system has an <code class="docutils literal"><span class="pre">/etc/ansible/facts.d</span></code> directory, any files in this directory
ending in <code class="docutils literal"><span class="pre">.fact</span></code>, can be JSON, INI, or executable files returning JSON, and these can supply local facts in Ansible.
An alternate directory can be specified using the <code class="docutils literal"><span class="pre">fact_path</span></code> play directive.</p>
<p>For instance assume a <code class="docutils literal"><span class="pre">/etc/ansible/facts.d/preferences.fact</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>general<span class="o">]</span>
<span class="nv">asdf</span><span class="o">=</span><span class="m">1</span>
<span class="nv">bar</span><span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
<p>This will produce a hash variable fact named <code class="docutils literal"><span class="pre">general</span></code> with <code class="docutils literal"><span class="pre">asdf</span></code> and <code class="docutils literal"><span class="pre">bar</span></code> as members.
To validate this, run the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible &lt;hostname&gt; -m setup -a <span class="s2">&quot;filter=ansible_local&quot;</span>
</pre></div>
</div>
<p>And you will see the following fact added:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="s2">&quot;ansible_local&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;preferences&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;general&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;asdf&quot;</span> : <span class="s2">&quot;1&quot;</span>,
                <span class="s2">&quot;bar&quot;</span>  : <span class="s2">&quot;2&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
<p>And this data can be accessed in a <code class="docutils literal"><span class="pre">template/playbook</span></code> as:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_local.preferences.general.asdf <span class="o">}}</span>
</pre></div>
</div>
<p>The local namespace prevents any user supplied fact from overriding system facts
or variables defined elsewhere in the playbook.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The key part in the key=value pairs will be converted into lowercase inside the ansible_local variable. Using the example above, if the ini file contained <code class="docutils literal"><span class="pre">XYZ=3</span></code> in the <code class="docutils literal"><span class="pre">[general]</span></code> section, then you should expect to access it as: <code class="docutils literal"><span class="pre">{{</span> <span class="pre">ansible_local.preferences.general.xyz</span> <span class="pre">}}</span></code> and not <code class="docutils literal"><span class="pre">{{</span> <span class="pre">ansible_local.preferences.general.XYZ</span> <span class="pre">}}</span></code>. This is because Ansible uses Python&#8217;s <a class="reference external" href="https://docs.python.org/2/library/configparser.html">ConfigParser</a> which passes all option names through the <a class="reference external" href="https://docs.python.org/2/library/configparser.html#ConfigParser.RawConfigParser.optionxform">optionxform</a> method and this method&#8217;s default implementation converts option names to lower case.</p>
</div>
<p>If you have a playbook that is copying over a custom fact and then running it, making an explicit call to re-run the setup module
can allow that fact to be used during that particular play.  Otherwise, it will be available in the next play that gathers fact information.
Here is an example of what that might look like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: webservers
  tasks:
    - name: create directory <span class="k">for</span> ansible custom facts
      file: <span class="nv">state</span><span class="o">=</span>directory <span class="nv">recurse</span><span class="o">=</span>yes <span class="nv">path</span><span class="o">=</span>/etc/ansible/facts.d
    - name: install custom impi fact
      copy: <span class="nv">src</span><span class="o">=</span>ipmi.fact <span class="nv">dest</span><span class="o">=</span>/etc/ansible/facts.d
    - name: re-read facts after adding custom fact
      setup: <span class="nv">filter</span><span class="o">=</span>ansible_local
</pre></div>
</div>
<p>In this pattern however, you could also write a fact module as well, and may wish to consider this as an option.</p>
</div>
<div class="section" id="ansible-version">
<span id="id2"></span><h5><a class="toc-backref" href="#id25">Ansible version</a><a class="headerlink" href="#ansible-version" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>To adapt playbook behavior to specific version of ansible, a variable ansible_version is available, with the following
structure:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="s2">&quot;ansible_version&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;full&quot;</span>: <span class="s2">&quot;2.0.0.2&quot;</span>,
    <span class="s2">&quot;major&quot;</span>: <span class="m">2</span>,
    <span class="s2">&quot;minor&quot;</span>: <span class="m">0</span>,
    <span class="s2">&quot;revision&quot;</span>: <span class="m">0</span>,
    <span class="s2">&quot;string&quot;</span>: <span class="s2">&quot;2.0.0.2&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fact-caching">
<span id="id3"></span><h5><a class="toc-backref" href="#id26">Fact Caching</a><a class="headerlink" href="#fact-caching" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>As shown elsewhere in the docs, it is possible for one server to reference variables about another, like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> hostvars<span class="o">[</span><span class="s1">&#39;asdf.example.com&#39;</span><span class="o">][</span><span class="s1">&#39;ansible_os_family&#39;</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
<p>With &#8220;Fact Caching&#8221; disabled, in order to do this, Ansible must have already talked to &#8216;asdf.example.com&#8217; in the
current play, or another play up higher in the playbook.  This is the default configuration of ansible.</p>
<p>To avoid this, Ansible 1.8 allows the ability to save facts between playbook runs, but this feature must be manually
enabled.  Why might this be useful?</p>
<p>Imagine, for instance, a very large infrastructure with thousands of hosts.  Fact caching could be configured to run nightly, but
configuration of a small set of servers could run ad-hoc or periodically throughout the day.  With fact-caching enabled, it would
not be necessary to &#8220;hit&#8221; all servers to reference variables and information about them.</p>
<p>With fact caching enabled, it is possible for machine in one group to reference variables about machines in the other group, despite
the fact that they have not been communicated with in the current execution of /usr/bin/ansible-playbook.</p>
<p>To benefit from cached facts, you will want to change the <code class="docutils literal"><span class="pre">gathering</span></code> setting to <code class="docutils literal"><span class="pre">smart</span></code> or <code class="docutils literal"><span class="pre">explicit</span></code> or set <code class="docutils literal"><span class="pre">gather_facts</span></code> to <code class="docutils literal"><span class="pre">False</span></code> in most plays.</p>
<p>Currently, Ansible ships with two persistent cache plugins: redis and jsonfile.</p>
<p>To configure fact caching using redis, enable it in <code class="docutils literal"><span class="pre">ansible.cfg</span></code> as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>defaults<span class="o">]</span>
<span class="nv">gathering</span> <span class="o">=</span> smart
<span class="nv">fact_caching</span> <span class="o">=</span> redis
<span class="nv">fact_caching_timeout</span> <span class="o">=</span> <span class="m">86400</span>
<span class="c1"># seconds</span>
</pre></div>
</div>
<p>To get redis up and running, perform the equivalent OS commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>yum install redis
service redis start
pip install redis
</pre></div>
</div>
<p>Note that the Python redis library should be installed from pip, the version packaged in EPEL is too old for use by Ansible.</p>
<p>In current embodiments, this feature is in beta-level state and the Redis plugin does not support port or password configuration, this is expected to change in the near future.</p>
<p>To configure fact caching using jsonfile, enable it in <code class="docutils literal"><span class="pre">ansible.cfg</span></code> as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>defaults<span class="o">]</span>
<span class="nv">gathering</span> <span class="o">=</span> smart
<span class="nv">fact_caching</span> <span class="o">=</span> jsonfile
<span class="nv">fact_caching_connection</span> <span class="o">=</span> /path/to/cachedir
<span class="nv">fact_caching_timeout</span> <span class="o">=</span> <span class="m">86400</span>
<span class="c1"># seconds</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">fact_caching_connection</span></code> is a local filesystem path to a writeable
directory (ansible will attempt to create the directory if one does not exist).</p>
<p><code class="docutils literal"><span class="pre">fact_caching_timeout</span></code> is the number of seconds to cache the recorded facts.</p>
</div>
<div class="section" id="registered-variables">
<span id="id4"></span><h5><a class="toc-backref" href="#id27">Registered Variables</a><a class="headerlink" href="#registered-variables" title="Permalink to this headline">¶</a></h5>
<p>Another major use of variables is running a command and using the result of that command to save the result into a variable. Results will vary from module to module. Use of <code class="docutils literal"><span class="pre">-v</span></code> when executing playbooks will show possible values for the results.</p>
<p>The value of a task being executed in ansible can be saved in a variable and used later.  See some examples of this in the
<a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a> chapter.</p>
<p>While it&#8217;s mentioned elsewhere in that document too, here&#8217;s a quick syntax example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: web_servers

  tasks:

     - shell: /usr/bin/foo
       register: foo_result
       ignore_errors: True

     - shell: /usr/bin/bar
       when: foo_result.rc <span class="o">==</span> <span class="m">5</span>
</pre></div>
</div>
<p>Registered variables are valid on the host the remainder of the playbook run, which is the same as the lifetime of &#8220;facts&#8221;
in Ansible.  Effectively registered variables are just like facts.</p>
<p>When using <code class="docutils literal"><span class="pre">register</span></code> with a loop the data structure placed in the variable during a loop, will contain a <code class="docutils literal"><span class="pre">results</span></code> attribute, that is a list of all responses from the module. For a more in-depth example of how this works, see the <a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a> section on using register with a loop.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If a task fails or is skipped, the variable still is registered with a failure or skipped status, the only way to avoid registering a variable is using tags.</p>
</div>
</div>
<div class="section" id="accessing-complex-variable-data">
<span id="id5"></span><h5><a class="toc-backref" href="#id28">Accessing Complex Variable Data</a><a class="headerlink" href="#accessing-complex-variable-data" title="Permalink to this headline">¶</a></h5>
<p>We already talked about facts a little higher up in the documentation.</p>
<p>Some provided facts, like networking information, are made available as nested data structures.  To access
them a simple <code class="docutils literal"><span class="pre">{{</span> <span class="pre">foo</span> <span class="pre">}}</span></code> is not sufficient, but it is still easy to do.   Here&#8217;s how we get an IP address:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_eth0<span class="o">[</span><span class="s2">&quot;ipv4&quot;</span><span class="o">][</span><span class="s2">&quot;address&quot;</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
<p>OR alternatively:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_eth0.ipv4.address <span class="o">}}</span>
</pre></div>
</div>
<p>Similarly, this is how we access the first element of an array:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> foo<span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="magic-variables-and-how-to-access-information-about-other-hosts">
<span id="magic-variables-and-hostvars"></span><h5><a class="toc-backref" href="#id29">Magic Variables, and How To Access Information About Other Hosts</a><a class="headerlink" href="#magic-variables-and-how-to-access-information-about-other-hosts" title="Permalink to this headline">¶</a></h5>
<p>Even if you didn&#8217;t define them yourself, Ansible provides a few variables for you automatically.
The most important of these are <code class="docutils literal"><span class="pre">hostvars</span></code>, <code class="docutils literal"><span class="pre">group_names</span></code>, and <code class="docutils literal"><span class="pre">groups</span></code>.  Users should not use
these names themselves as they are reserved.  <code class="docutils literal"><span class="pre">environment</span></code> is also reserved.</p>
<p><code class="docutils literal"><span class="pre">hostvars</span></code> lets you ask about the variables of another host, including facts that have been gathered
about that host.  If, at this point, you haven&#8217;t talked to that host yet in any play in the playbook
or set of playbooks, you can still get the variables, but you will not be able to see the facts.</p>
<p>If your database server wants to use the value of a &#8216;fact&#8217; from another node, or an inventory variable
assigned to another node, it&#8217;s easy to do so within a template or even an action line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> hostvars<span class="o">[</span><span class="s1">&#39;test.example.com&#39;</span><span class="o">][</span><span class="s1">&#39;ansible_distribution&#39;</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Additionally, <code class="docutils literal"><span class="pre">group_names</span></code> is a list (array) of all the groups the current host is in.  This can be used in templates using Jinja2 syntax to make template source files that vary based on the group membership (or role) of the host</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">if</span> <span class="s1">&#39;webserver&#39;</span> <span class="k">in</span> <span class="nv">group_names</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">   # some part of a configuration file that only applies to webservers</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">groups</span></code> is a list of all the groups (and hosts) in the inventory.  This can be used to enumerate all hosts within a group.
For example:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">host</span> <span class="k">in</span> <span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;app_servers&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">   # something that applies to all app servers.</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>A frequently used idiom is walking a group to find all IP addresses in that group</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">host</span> <span class="k">in</span> <span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;app_servers&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">   </span><span class="cp">{{</span> <span class="nv">hostvars</span><span class="o">[</span><span class="nv">host</span><span class="o">][</span><span class="s1">&#39;ansible_eth0&#39;</span><span class="o">][</span><span class="s1">&#39;ipv4&#39;</span><span class="o">][</span><span class="s1">&#39;address&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>An example of this could include pointing a frontend proxy server to all of the app servers, setting up the correct firewall rules between servers, etc.
You need to make sure that the facts of those hosts have been populated before though, for example by running a play against them if the facts have not been cached recently (fact caching was added in Ansible 1.8).</p>
<p>Additionally, <code class="docutils literal"><span class="pre">inventory_hostname</span></code> is the name of the hostname as configured in Ansible&#8217;s inventory host file.  This can
be useful for when you don&#8217;t want to rely on the discovered hostname <code class="docutils literal"><span class="pre">ansible_hostname</span></code> or for other mysterious
reasons.  If you have a long FQDN, <code class="docutils literal"><span class="pre">inventory_hostname_short</span></code> also contains the part up to the first
period, without the rest of the domain.</p>
<p><code class="docutils literal"><span class="pre">play_hosts</span></code> has been deprecated in 2.2, it was the same as the new <code class="docutils literal"><span class="pre">ansible_play_batch</span></code> variable.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p><code class="docutils literal"><span class="pre">ansible_play_hosts</span></code> is the full list of all hosts still active in the current play.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p><code class="docutils literal"><span class="pre">ansible_play_batch</span></code> is available as a list of hostnames that are in scope for the current &#8216;batch&#8217; of the play. The batch size is defined by <code class="docutils literal"><span class="pre">serial</span></code>, when not set it is equivalent to the whole play (making it the same as <code class="docutils literal"><span class="pre">ansible_play_hosts</span></code>).</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p><code class="docutils literal"><span class="pre">ansible_playbook_python</span></code> is the path to the python executable used to invoke the Ansible command line tool.</p>
<p>These vars may be useful for filling out templates with multiple hostnames or for injecting the list into the rules for a load balancer.</p>
<p>Don&#8217;t worry about any of this unless you think you need it.  You&#8217;ll know when you do.</p>
<p>Also available, <code class="docutils literal"><span class="pre">inventory_dir</span></code> is the pathname of the directory holding Ansible&#8217;s inventory host file, <code class="docutils literal"><span class="pre">inventory_file</span></code> is the pathname and the filename pointing to the Ansible&#8217;s inventory host file.</p>
<p><code class="docutils literal"><span class="pre">playbook_dir</span></code> contains the playbook base directory.</p>
<p>We then have <code class="docutils literal"><span class="pre">role_path</span></code> which will return the current role&#8217;s pathname (since 1.8). This will only work inside a role.</p>
<p>And finally, <code class="docutils literal"><span class="pre">ansible_check_mode</span></code> (added in version 2.1), a boolean magic variable which will be set to <code class="docutils literal"><span class="pre">True</span></code> if you run Ansible with <code class="docutils literal"><span class="pre">--check</span></code>.</p>
</div>
<div class="section" id="variable-file-separation">
<span id="variable-file-separation-details"></span><h5><a class="toc-backref" href="#id30">Variable File Separation</a><a class="headerlink" href="#variable-file-separation" title="Permalink to this headline">¶</a></h5>
<p>It&#8217;s a great idea to keep your playbooks under source control, but
you may wish to make the playbook source public while keeping certain
important variables private.  Similarly, sometimes you may just
want to keep certain information in different files, away from
the main playbook.</p>
<p>You can do this by using an external variables file, or files, just like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: all
  remote_user: root
  vars:
    favcolor: blue
  vars_files:
    - /vars/external_vars.yml

  tasks:

  - name: this is just a placeholder
    command: /bin/echo foo
</pre></div>
</div>
<p>This removes the risk of sharing sensitive data with others when
sharing your playbook source with them.</p>
<p>The contents of each variables file is a simple YAML dictionary, like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># in the above example, this would be vars/external_vars.yml</span>
somevar: somevalue
password: magic
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It&#8217;s also possible to keep per-host and per-group variables in very
similar files, this is covered in <a class="reference internal" href="index.html#splitting-out-vars"><span class="std std-ref">Splitting Out Host and Group Specific Data</span></a>.</p>
</div>
</div>
<div class="section" id="passing-variables-on-the-command-line">
<span id="id6"></span><h5><a class="toc-backref" href="#id31">Passing Variables On The Command Line</a><a class="headerlink" href="#passing-variables-on-the-command-line" title="Permalink to this headline">¶</a></h5>
<p>In addition to <code class="docutils literal"><span class="pre">vars_prompt</span></code> and <code class="docutils literal"><span class="pre">vars_files</span></code>, it is possible to send variables over
the Ansible command line.  This is particularly useful when writing a generic release playbook
where you may want to pass in the version of the application to deploy:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook release.yml --extra-vars <span class="s2">&quot;version=1.23.45 other_variable=foo&quot;</span>
</pre></div>
</div>
<p>This is useful, for, among other things, setting the hosts group or the user for the playbook.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: <span class="s1">&#39;{{ hosts }}&#39;</span>
  remote_user: <span class="s1">&#39;{{ user }}&#39;</span>

  tasks:
     - ...

ansible-playbook release.yml --extra-vars <span class="s2">&quot;hosts=vipers user=starbuck&quot;</span>
</pre></div>
</div>
<p>As of Ansible 1.2, you can also pass in extra vars as quoted JSON, like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>--extra-vars <span class="s1">&#39;{&quot;pacman&quot;:&quot;mrs&quot;,&quot;ghosts&quot;:[&quot;inky&quot;,&quot;pinky&quot;,&quot;clyde&quot;,&quot;sue&quot;]}&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">key=value</span></code> form is obviously simpler, but it&#8217;s there if you need it!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Values passed in using the <code class="docutils literal"><span class="pre">key=value</span></code> syntax are interpreted as strings.
Use the JSON format if you need to pass in anything that shouldn&#8217;t be a string (Booleans, integers, floats, lists etc).</p>
</div>
<p>As of Ansible 1.3, extra vars can be loaded from a JSON file with the <code class="docutils literal"><span class="pre">&#64;</span></code> syntax:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>--extra-vars <span class="s2">&quot;@some_file.json&quot;</span>
</pre></div>
</div>
<p>Also as of Ansible 1.3, extra vars can be formatted as YAML, either on the command line
or in a file as above.</p>
</div>
<div class="section" id="variable-precedence-where-should-i-put-a-variable">
<span id="variable-precedence"></span><h5><a class="toc-backref" href="#id32">Variable Precedence: Where Should I Put A Variable?</a><a class="headerlink" href="#variable-precedence-where-should-i-put-a-variable" title="Permalink to this headline">¶</a></h5>
<p>A lot of folks may ask about how variables override another.  Ultimately it&#8217;s Ansible&#8217;s philosophy that it&#8217;s better
you know where to put a variable, and then you have to think about it a lot less.</p>
<p>Avoid defining the variable &#8220;x&#8221; in 47 places and then ask the question &#8220;which x gets used&#8221;.
Why?  Because that&#8217;s not Ansible&#8217;s Zen philosophy of doing things.</p>
<p>There is only one Empire State Building. One Mona Lisa, etc.  Figure out where to define a variable, and don&#8217;t make
it complicated.</p>
<p>However, let&#8217;s go ahead and get precedence out of the way!  It exists.  It&#8217;s a real thing, and you might have
a use for it.</p>
<p>If multiple variables of the same name are defined in different places, they get overwritten in a certain order.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible 2.0 has deprecated the “ssh” from <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code>, <code class="docutils literal"><span class="pre">ansible_ssh_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_ssh_port</span></code> to become <code class="docutils literal"><span class="pre">ansible_user</span></code>, <code class="docutils literal"><span class="pre">ansible_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_port</span></code>. If you are using a version of Ansible prior to 2.0,  you should continue using the older style variables (<code class="docutils literal"><span class="pre">ansible_ssh_*</span></code>). These shorter variables are ignored, without warning, in older versions of Ansible.</p>
</div>
<p>In 1.x, the precedence is as follows (with the last listed variables winning prioritization):</p>
<blockquote>
<div><ul class="simple">
<li>&#8220;role defaults&#8221;, which lose in priority to everything and are the most easily overridden</li>
<li>variables defined in inventory</li>
<li>facts discovered about a system</li>
<li>&#8220;most everything else&#8221; (command line switches, vars in play, included vars, role vars, etc.)</li>
<li>connection variables (<code class="docutils literal"><span class="pre">ansible_user</span></code>, etc.)</li>
<li>extra vars (<code class="docutils literal"><span class="pre">-e</span></code> in the command line) always win</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In versions prior to 1.5.4, facts discovered about a system were in the &#8220;most everything else&#8221; category above.</p>
</div>
<p>In 2.x, we have made the order of precedence more specific (with the last listed variables winning prioritization):</p>
<blockquote>
<div><ul class="simple">
<li>role defaults <a class="footnote-reference" href="#id10" id="id7">[1]</a></li>
<li>inventory file or script group vars <a class="footnote-reference" href="#id11" id="id8">[2]</a></li>
<li>inventory group_vars/all</li>
<li>playbook group_vars/all</li>
<li>inventory group_vars/*</li>
<li>playbook group_vars/*</li>
<li>inventory file or script host vars <a class="footnote-reference" href="#id11" id="id9">[2]</a></li>
<li>inventory host_vars/*</li>
<li>playbook host_vars/*</li>
<li>host facts</li>
<li>play vars</li>
<li>play vars_prompt</li>
<li>play vars_files</li>
<li>role vars (defined in role/vars/main.yml)</li>
<li>block vars (only for tasks in block)</li>
<li>task vars (only for the task)</li>
<li>role (and include_role) params</li>
<li>include params</li>
<li>include_vars</li>
<li>set_facts / registered vars</li>
<li>extra vars (always win precedence)</li>
</ul>
</div></blockquote>
<p>Basically, anything that goes into &#8220;role defaults&#8221; (the defaults folder inside the role) is the most malleable and easily overridden. Anything in the vars directory of the role overrides previous versions of that variable in namespace.  The idea here to follow is that the more explicit you get in scope, the more precedence it takes with command line <code class="docutils literal"><span class="pre">-e</span></code> extra vars always winning.  Host and/or inventory variables can win over role defaults, but not explicit includes like the vars directory or an <code class="docutils literal"><span class="pre">include_vars</span></code> task.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[1]</a></td><td>Tasks in each role will see their own role&#8217;s defaults. Tasks defined outside of a role will see the last role&#8217;s defaults.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><em>(<a class="fn-backref" href="#id8">1</a>, <a class="fn-backref" href="#id9">2</a>)</em> Variables defined in inventory file or provided by dynamic inventory.</td></tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Within any section, redefining a var will overwrite the previous instance.
If multiple groups have the same variable, the last one loaded wins.
If you define a variable twice in a play&#8217;s vars: section, the 2nd one wins.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the previous describes the default config <cite>hash_behavior=replace</cite>, switch to &#8216;merge&#8217; to only partially overwrite.</p>
</div>
<p>Another important thing to consider (for all versions) is that connection variables override config, command line and play/role/task specific options and directives.  For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible -u lola myhost
</pre></div>
</div>
<p>This will still connect as <code class="docutils literal"><span class="pre">ramon</span></code> because <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code> is set to <code class="docutils literal"><span class="pre">ramon</span></code> in inventory for myhost.
For plays/tasks this is also true for <code class="docutils literal"><span class="pre">remote_user</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: myhost
  tasks:
   - command: i&#39;ll connect as ramon still
     remote_user: lola
</pre></div>
</div>
<p>This is done so host-specific settings can override the general settings. These variables are normally defined per host or group in inventory,
but they behave like other variables. If you want to override the remote user globally (even over inventory) you can use extra vars:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible... -e <span class="s2">&quot;ansible_user=&lt;user&gt;&quot;</span>
</pre></div>
</div>
<p>You can also override as a normal variable in a play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  vars:
    ansible_user: lola
  tasks:
    - command: i&#39;ll connect as lola!
</pre></div>
</div>
</div>
<div class="section" id="variable-scopes">
<span id="id12"></span><h5><a class="toc-backref" href="#id33">Variable Scopes</a><a class="headerlink" href="#variable-scopes" title="Permalink to this headline">¶</a></h5>
<p>Ansible has 3 main scopes:</p>
<blockquote>
<div><ul class="simple">
<li>Global: this is set by config, environment variables and the command line</li>
<li>Play: each play and contained structures, vars entries (vars; vars_files; vars_prompt), role defaults and vars.</li>
<li>Host: variables directly associated to a host, like inventory, include_vars, facts or registered task outputs</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="variable-examples">
<span id="id13"></span><h5><a class="toc-backref" href="#id34">Variable Examples</a><a class="headerlink" href="#variable-examples" title="Permalink to this headline">¶</a></h5>
<p>That seems a little theoretical.  Let&#8217;s show some examples and where you would choose to put what based on the kind of control you might want over values.</p>
<p>First off, group variables are super powerful.</p>
<p>Site wide defaults should be defined as a <code class="docutils literal"><span class="pre">group_vars/all</span></code> setting.  Group variables are generally placed alongside
your inventory file.  They can also be returned by a dynamic inventory script (see <a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a>) or defined
in things like <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a> from the UI or API:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: /etc/ansible/group_vars/all</span>
<span class="c1"># this is the site wide default</span>
ntp_server: default-time.example.com
</pre></div>
</div>
<p>Regional information might be defined in a <code class="docutils literal"><span class="pre">group_vars/region</span></code> variable.  If this group is a child of the <code class="docutils literal"><span class="pre">all</span></code> group (which it is, because all groups are), it will override the group that is higher up and more general:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: /etc/ansible/group_vars/boston</span>
ntp_server: boston-time.example.com
</pre></div>
</div>
<p>If for some crazy reason we wanted to tell just a specific host to use a specific NTP server, it would then override the group variable!:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: /etc/ansible/host_vars/xyz.boston.example.com</span>
ntp_server: override.example.com
</pre></div>
</div>
<p>So that covers inventory and what you would normally set there.  It&#8217;s a great place for things that deal with geography or behavior.  Since groups are frequently the entity that maps roles onto hosts, it is sometimes a shortcut to set variables on the group instead of defining them on a role.  You could go either way.</p>
<p>Remember:  Child groups override parent groups, and hosts always override their groups.</p>
<p>Next up: learning about role variable precedence.</p>
<p>We&#8217;ll pretty much assume you are using roles at this point.  You should be using roles for sure.  Roles are great.  You are using
roles aren&#8217;t you?  Hint hint.</p>
<p>Ok, so if you are writing a redistributable role with reasonable defaults, put those in the <code class="docutils literal"><span class="pre">roles/x/defaults/main.yml</span></code> file.  This means
the role will bring along a default value but ANYTHING in Ansible will override it.  It&#8217;s just a default.  That&#8217;s why it says &#8220;defaults&#8221; :)
See <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a> for more info about this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: roles/x/defaults/main.yml</span>
<span class="c1"># if not overridden in inventory or as a parameter, this is the value that will be used</span>
http_port: <span class="m">80</span>
</pre></div>
</div>
<p>If you are writing a role and want to ensure the value in the role is absolutely used in that role, and is not going to be overridden
by inventory, you should put it in <code class="docutils literal"><span class="pre">roles/x/vars/main.yml</span></code> like so, and inventory values cannot override it.  <code class="docutils literal"><span class="pre">-e</span></code> however, still will:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: roles/x/vars/main.yml</span>
<span class="c1"># this will absolutely be used in this role</span>
http_port: <span class="m">80</span>
</pre></div>
</div>
<p>So the above is a great way to plug in constants about the role that are always true.  If you are not sharing your role with others,
app specific behaviors like ports is fine to put in here.  But if you are sharing roles with others, putting variables in here might
be bad. Nobody will be able to override them with inventory, but they still can by passing a parameter to the role.</p>
<p>Parameterized roles are useful.</p>
<p>If you are using a role and want to override a default, pass it as a parameter to the role like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles:
   - <span class="o">{</span> role: apache, http_port: <span class="m">8080</span> <span class="o">}</span>
</pre></div>
</div>
<p>This makes it clear to the playbook reader that you&#8217;ve made a conscious choice to override some default in the role, or pass in some
configuration that the role can&#8217;t assume by itself.  It also allows you to pass something site-specific that isn&#8217;t really part of the
role you are sharing with others.</p>
<p>This can often be used for things that might apply to some hosts multiple times,
like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles:
   - <span class="o">{</span> role: app_user, name: Ian    <span class="o">}</span>
   - <span class="o">{</span> role: app_user, name: Terry  <span class="o">}</span>
   - <span class="o">{</span> role: app_user, name: Graham <span class="o">}</span>
   - <span class="o">{</span> role: app_user, name: John   <span class="o">}</span>
</pre></div>
</div>
<p>That&#8217;s a bit arbitrary, but you can see how the same role was invoked multiple times.  In that example it&#8217;s quite likely there was
no default for &#8216;name&#8217; supplied at all.  Ansible can yell at you when variables aren&#8217;t defined &#8211; it&#8217;s the default behavior in fact.</p>
<p>So that&#8217;s a bit about roles.</p>
<p>There are a few bonus things that go on with roles.</p>
<p>Generally speaking, variables set in one role are available to others.  This means if you have a <code class="docutils literal"><span class="pre">roles/common/vars/main.yml</span></code> you
can set variables in there and make use of them in other roles and elsewhere in your playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles:
   - <span class="o">{</span> role: common_settings <span class="o">}</span>
   - <span class="o">{</span> role: something, foo: <span class="m">12</span> <span class="o">}</span>
   - <span class="o">{</span> role: something_else <span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are some protections in place to avoid the need to namespace variables.
In the above, variables defined in common_settings are most definitely available to &#8216;something&#8217; and &#8216;something_else&#8217; tasks, but if
&#8220;something&#8217;s&#8221; guaranteed to have foo set at 12, even if somewhere deep in common settings it set foo to 20.</p>
</div>
<p>So, that&#8217;s precedence, explained in a more direct way.  Don&#8217;t worry about precedence, just think about if your role is defining a
variable that is a default, or a &#8220;live&#8221; variable you definitely want to use.  Inventory lies in precedence right in the middle, and
if you want to forcibly override something, use <code class="docutils literal"><span class="pre">-e</span></code>.</p>
<p>If you found that a little hard to understand, take a look at the <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-examples</a> repo on our github for a bit more about
how all of these things can work together.</p>
</div>
<div class="section" id="advanced-syntax">
<h5><a class="toc-backref" href="#id35">Advanced Syntax</a><a class="headerlink" href="#advanced-syntax" title="Permalink to this headline">¶</a></h5>
<p>For information about advanced YAML syntax used to declare variables and have more control over the data placed in YAML files used by Ansible, see <a class="reference internal" href="index.html#document-playbooks_advanced_syntax"><span class="doc">Advanced Syntax</span></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_filters"><span class="doc">Filters</span></a></dt>
<dd>Jinja2 filters and their uses</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Looping in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_templating"></span><div class="section" id="templating-jinja2">
<h4><a class="toc-backref" href="#id1">Templating (Jinja2)</a><a class="headerlink" href="#templating-jinja2" title="Permalink to this headline">¶</a></h4>
<p>As already referenced in the variables section, Ansible uses Jinja2 templating to enable dynamic expressions and access to variables.
Ansible greatly expands the number of filters and tests available, as well as adding a new plugin type: lookups.</p>
<p>Please note that all templating happens on the Ansible controller before the task is sent and executed on the target machine. This is done to minimize the requirements on the target (jinja2 is only required on the controller) and to be able to pass the minimal information needed for the task, so the target machine does not need a copy of all the data that the controller has access to.</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#templating-jinja2" id="id1">Templating (Jinja2)</a></li>
</ul>
</div>
<div class="toctree-wrapper compound">
<span id="document-playbooks_filters"></span><div class="section" id="filters">
<h5><a class="toc-backref" href="#id8">Filters</a><a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#filters" id="id8">Filters</a><ul>
<li><a class="reference internal" href="#filters-for-formatting-data" id="id9">Filters For Formatting Data</a></li>
<li><a class="reference internal" href="#forcing-variables-to-be-defined" id="id10">Forcing Variables To Be Defined</a></li>
<li><a class="reference internal" href="#defaulting-undefined-variables" id="id11">Defaulting Undefined Variables</a></li>
<li><a class="reference internal" href="#omitting-parameters" id="id12">Omitting Parameters</a></li>
<li><a class="reference internal" href="#list-filters" id="id13">List Filters</a></li>
<li><a class="reference internal" href="#set-theory-filters" id="id14">Set Theory Filters</a></li>
<li><a class="reference internal" href="#random-number-filter" id="id15">Random Number Filter</a></li>
<li><a class="reference internal" href="#shuffle-filter" id="id16">Shuffle Filter</a></li>
<li><a class="reference internal" href="#math" id="id17">Math</a></li>
<li><a class="reference internal" href="#json-query-filter" id="id18">JSON Query Filter</a></li>
<li><a class="reference internal" href="#ip-address-filter" id="id19">IP address filter</a></li>
<li><a class="reference internal" href="#network-cli-filters" id="id20">Network CLI filters</a></li>
<li><a class="reference internal" href="#hashing-filters" id="id21">Hashing filters</a></li>
<li><a class="reference internal" href="#combining-hashes-dictionaries" id="id22">Combining hashes/dictionaries</a></li>
<li><a class="reference internal" href="#extracting-values-from-containers" id="id23">Extracting values from containers</a></li>
<li><a class="reference internal" href="#comment-filter" id="id24">Comment Filter</a></li>
<li><a class="reference internal" href="#url-split-filter" id="id25">URL Split Filter</a></li>
<li><a class="reference internal" href="#regular-expression-filters" id="id26">Regular Expression Filters</a></li>
<li><a class="reference internal" href="#id7" id="id27">Other Useful Filters</a></li>
<li><a class="reference internal" href="#combination-filters" id="id28">Combination Filters</a></li>
<li><a class="reference internal" href="#debugging-filters" id="id29">Debugging Filters</a></li>
</ul>
</li>
</ul>
</div>
<p>Filters in Ansible are from Jinja2, and are used for transforming data inside a template expression.  Jinja2 ships with many filters. See <a class="reference external" href="http://jinja.pocoo.org/docs/templates/#builtin-filters">builtin filters</a> in the official Jinja2 template documentation.</p>
<p>Take into account that templating happens on the Ansible controller, <strong>not</strong> on the task&#8217;s target host, so filters also execute on the controller as they manipulate local data.</p>
<p>In addition the ones provided by Jinja2, Ansible ships with it&#8217;s own and allows users to add their own custom filters.</p>
<div class="section" id="filters-for-formatting-data">
<span id="id1"></span><h6><a class="toc-backref" href="#id9">Filters For Formatting Data</a><a class="headerlink" href="#filters-for-formatting-data" title="Permalink to this headline">¶</a></h6>
<p>The following filters will take a data structure in a template and render it in a slightly different format.  These
are occasionally useful for debugging:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> some_variable <span class="p">|</span> to_json <span class="o">}}</span>
<span class="o">{{</span> some_variable <span class="p">|</span> to_yaml <span class="o">}}</span>
</pre></div>
</div>
<p>For human readable output, you can use:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> some_variable <span class="p">|</span> to_nice_json <span class="o">}}</span>
<span class="o">{{</span> some_variable <span class="p">|</span> to_nice_yaml <span class="o">}}</span>
</pre></div>
</div>
<p>It&#8217;s also possible to change the indentation of both (new in version 2.2):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> some_variable <span class="p">|</span> to_nice_json<span class="o">(</span><span class="nv">indent</span><span class="o">=</span><span class="m">2</span><span class="o">)</span> <span class="o">}}</span>
<span class="o">{{</span> some_variable <span class="p">|</span> to_nice_yaml<span class="o">(</span><span class="nv">indent</span><span class="o">=</span><span class="m">8</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Alternatively, you may be reading in some already formatted data:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> some_variable <span class="p">|</span> from_json <span class="o">}}</span>
<span class="o">{{</span> some_variable <span class="p">|</span> from_yaml <span class="o">}}</span>
</pre></div>
</div>
<p>for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - shell: cat /some/path/to/file.json
    register: result

  - set_fact: <span class="nv">myvar</span><span class="o">=</span><span class="s2">&quot;{{ result.stdout | from_json }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="forcing-variables-to-be-defined">
<span id="id2"></span><h6><a class="toc-backref" href="#id10">Forcing Variables To Be Defined</a><a class="headerlink" href="#forcing-variables-to-be-defined" title="Permalink to this headline">¶</a></h6>
<p>The default behavior from ansible and ansible.cfg is to fail if variables are undefined, but you can turn this off.</p>
<p>This allows an explicit check with this feature off:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> variable <span class="p">|</span> mandatory <span class="o">}}</span>
</pre></div>
</div>
<p>The variable value will be used as is, but the template evaluation will raise an error if it is undefined.</p>
</div>
<div class="section" id="defaulting-undefined-variables">
<span id="id3"></span><h6><a class="toc-backref" href="#id11">Defaulting Undefined Variables</a><a class="headerlink" href="#defaulting-undefined-variables" title="Permalink to this headline">¶</a></h6>
<p>Jinja2 provides a useful &#8216;default&#8217; filter, that is often a better approach to failing if a variable is not defined:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> some_variable <span class="p">|</span> default<span class="o">(</span><span class="m">5</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>In the above example, if the variable &#8216;some_variable&#8217; is not defined, the value used will be 5, rather than an error
being raised.</p>
</div>
<div class="section" id="omitting-parameters">
<span id="omitting-undefined-variables"></span><h6><a class="toc-backref" href="#id12">Omitting Parameters</a><a class="headerlink" href="#omitting-parameters" title="Permalink to this headline">¶</a></h6>
<p>As of Ansible 1.8, it is possible to use the default filter to omit module parameters using the special <cite>omit</cite> variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: touch files with an optional mode
  file: <span class="nv">dest</span><span class="o">={{</span>item.path<span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>touch <span class="nv">mode</span><span class="o">={{</span>item.mode<span class="p">|</span>default<span class="o">(</span>omit<span class="o">)}}</span>
  with_items:
    - path: /tmp/foo
    - path: /tmp/bar
    - path: /tmp/baz
      mode: <span class="s2">&quot;0444&quot;</span>
</pre></div>
</div>
<p>For the first two files in the list, the default mode will be determined by the umask of the system as the <cite>mode=</cite>
parameter will not be sent to the file module while the final file will receive the <cite>mode=0444</cite> option.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are &#8220;chaining&#8221; additional filters after the <cite>default(omit)</cite> filter, you should instead do something like this:
<cite>&#8220;{{ foo | default(None) | some_filter or omit }}&#8221;</cite>. In this example, the default <cite>None</cite> (python null) value will cause the
later filters to fail, which will trigger the <cite>or omit</cite> portion of the logic. Using omit in this manner is very specific to
the later filters you&#8217;re chaining though, so be prepared for some trial and error if you do this.</p>
</div>
</div>
<div class="section" id="list-filters">
<span id="id4"></span><h6><a class="toc-backref" href="#id13">List Filters</a><a class="headerlink" href="#list-filters" title="Permalink to this headline">¶</a></h6>
<p>These filters all operate on list variables.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>To get the minimum value from list of numbers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> list1 <span class="p">|</span> min <span class="o">}}</span>
</pre></div>
</div>
<p>To get the maximum value from a list of numbers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="o">[</span><span class="m">3</span>, <span class="m">4</span>, <span class="m">2</span><span class="o">]</span> <span class="p">|</span> max <span class="o">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="set-theory-filters">
<span id="id5"></span><h6><a class="toc-backref" href="#id14">Set Theory Filters</a><a class="headerlink" href="#set-theory-filters" title="Permalink to this headline">¶</a></h6>
<p>All these functions return a unique set from sets or lists.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>To get a unique set from a list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> list1 <span class="p">|</span> unique <span class="o">}}</span>
</pre></div>
</div>
<p>To get a union of two lists:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> list1 <span class="p">|</span> union<span class="o">(</span>list2<span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get the intersection of 2 lists (unique list of all items in both):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> list1 <span class="p">|</span> intersect<span class="o">(</span>list2<span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get the difference of 2 lists (items in 1 that don&#8217;t exist in 2):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> list1 <span class="p">|</span> difference<span class="o">(</span>list2<span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get the symmetric difference of 2 lists (items exclusive to each list):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> list1 <span class="p">|</span> symmetric_difference<span class="o">(</span>list2<span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="random-number-filter">
<span id="random-filter"></span><h6><a class="toc-backref" href="#id15">Random Number Filter</a><a class="headerlink" href="#random-number-filter" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>This filter can be used similar to the default jinja2 random filter (returning a random item from a sequence of
items), but can also generate a random number based on a range.</p>
<p>To get a random item from a list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="s2">&quot;{{ [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]|random }}&quot;</span>
<span class="c1"># =&gt; &#39;c&#39;</span>
</pre></div>
</div>
<p>To get a random number from 0 to supplied end:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="s2">&quot;{{ 59 |random}} * * * * root /script/from/cron&quot;</span>
<span class="c1"># =&gt; &#39;21 * * * * root /script/from/cron&#39;</span>
</pre></div>
</div>
<p>Get a random number from 0 to 100 but in steps of 10:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="m">100</span> <span class="p">|</span>random<span class="o">(</span><span class="nv">step</span><span class="o">=</span><span class="m">10</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; 70</span>
</pre></div>
</div>
<p>Get a random number from 1 to 100 but in steps of 10:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="m">100</span> <span class="p">|</span>random<span class="o">(</span><span class="m">1</span>, <span class="m">10</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; 31</span>
<span class="o">{{</span> <span class="m">100</span> <span class="p">|</span>random<span class="o">(</span><span class="nv">start</span><span class="o">=</span><span class="m">1</span>, <span class="nv">step</span><span class="o">=</span><span class="m">10</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; 51</span>
</pre></div>
</div>
<p>As of Ansible version 2.3, it&#8217;s also possible to initialize the random number generator from a seed. This way, you can create random-but-idempotent numbers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="s2">&quot;{{ 59 |random(seed=inventory_hostname) }} * * * * root /script/from/cron&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="shuffle-filter">
<h6><a class="toc-backref" href="#id16">Shuffle Filter</a><a class="headerlink" href="#shuffle-filter" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>This filter will randomize an existing list, giving a different order every invocation.</p>
<p>To get a random list from an existing  list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span>,<span class="s1">&#39;b&#39;</span>,<span class="s1">&#39;c&#39;</span><span class="o">]</span><span class="p">|</span>shuffle <span class="o">}}</span>
<span class="c1"># =&gt; [&#39;c&#39;,&#39;a&#39;,&#39;b&#39;]</span>
<span class="o">{{</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span>,<span class="s1">&#39;b&#39;</span>,<span class="s1">&#39;c&#39;</span><span class="o">]</span><span class="p">|</span>shuffle <span class="o">}}</span>
<span class="c1"># =&gt; [&#39;b&#39;,&#39;c&#39;,&#39;a&#39;]</span>
</pre></div>
</div>
<p>As of Ansible version 2.3, it&#8217;s also possible to shuffle a list idempotent. All you need is a seed.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span>,<span class="s1">&#39;b&#39;</span>,<span class="s1">&#39;c&#39;</span><span class="o">]</span><span class="p">|</span>shuffle<span class="o">(</span><span class="nv">seed</span><span class="o">=</span>inventory_hostname<span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; [&#39;b&#39;,&#39;a&#39;,&#39;c&#39;]</span>
</pre></div>
</div>
<p>note that when used with a non &#8216;listable&#8217; item it is a noop, otherwise it always returns a list</p>
</div>
<div class="section" id="math">
<span id="math-stuff"></span><h6><a class="toc-backref" href="#id17">Math</a><a class="headerlink" href="#math" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.</span></p>
</div>
<p>Get the logarithm (default is e):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> myvar <span class="p">|</span> log <span class="o">}}</span>
</pre></div>
</div>
<p>Get the base 10 logarithm:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> myvar <span class="p">|</span> log<span class="o">(</span><span class="m">10</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Give me the power of 2! (or 5):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> myvar <span class="p">|</span> pow<span class="o">(</span><span class="m">2</span><span class="o">)</span> <span class="o">}}</span>
<span class="o">{{</span> myvar <span class="p">|</span> pow<span class="o">(</span><span class="m">5</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Square root, or the 5th:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> myvar <span class="p">|</span> root <span class="o">}}</span>
<span class="o">{{</span> myvar <span class="p">|</span> root<span class="o">(</span><span class="m">5</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Note that jinja2 already provides some like abs() and round().</p>
</div>
<div class="section" id="json-query-filter">
<h6><a class="toc-backref" href="#id18">JSON Query Filter</a><a class="headerlink" href="#json-query-filter" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>Sometimes you end up with a complex data structure in JSON format and you need to extract only a small set of data within it. The <strong>json_query</strong> filter lets you query a complex JSON structure and iterate over it using a with_items structure.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This filter is built upon <strong>jmespath</strong>, and you can use the same syntax. For examples, see <a class="reference external" href="http://jmespath.org/examples.html">jmespath examples</a>.</p>
</div>
<p>Now, let&#8217;s take the following data structure:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>domain_definition:
    domain:
        cluster:
            - name: <span class="s2">&quot;cluster1&quot;</span>
            - name: <span class="s2">&quot;cluster2&quot;</span>
        server:
            - name: <span class="s2">&quot;server11&quot;</span>
              cluster: <span class="s2">&quot;cluster1&quot;</span>
              port: <span class="s2">&quot;8080&quot;</span>
            - name: <span class="s2">&quot;server12&quot;</span>
              cluster: <span class="s2">&quot;cluster1&quot;</span>
              port: <span class="s2">&quot;8090&quot;</span>
            - name: <span class="s2">&quot;server21&quot;</span>
              cluster: <span class="s2">&quot;cluster2&quot;</span>
              port: <span class="s2">&quot;9080&quot;</span>
            - name: <span class="s2">&quot;server22&quot;</span>
              cluster: <span class="s2">&quot;cluster2&quot;</span>
              port: <span class="s2">&quot;9090&quot;</span>
        library:
            - name: <span class="s2">&quot;lib1&quot;</span>
              target: <span class="s2">&quot;cluster1&quot;</span>
            - name: <span class="s2">&quot;lib2&quot;</span>
              target: <span class="s2">&quot;cluster2&quot;</span>
</pre></div>
</div>
<p>To extract all clusters from this structure, you can use the following query:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="s2">&quot;Display all cluster names&quot;</span>
  debug: <span class="nv">var</span><span class="o">=</span>item
  with_items: <span class="s2">&quot;{{domain_definition|json_query(&#39;domain.cluster[*].name&#39;)}}&quot;</span>
</pre></div>
</div>
<p>Same thing for all server names:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="s2">&quot;Display all server names&quot;</span>
  debug: <span class="nv">var</span><span class="o">=</span>item
  with_items: <span class="s2">&quot;{{domain_definition|json_query(&#39;domain.server[*].name&#39;)}}&quot;</span>
</pre></div>
</div>
<p>This example shows ports from cluster1:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="s2">&quot;Display all server names from cluster1&quot;</span>
  debug: <span class="nv">var</span><span class="o">=</span>item
  with_items: <span class="s2">&quot;{{domain_definition|json_query(server_name_cluster1_query)}}&quot;</span>
  vars:
    server_name_cluster1_query: <span class="s2">&quot;domain.server[?cluster==&#39;cluster1&#39;].port&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can use a variable to make the query more readable.</p>
</div>
<p>In this example, we get a hash map with all ports and names of a cluster:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="s2">&quot;Display all server ports and names from cluster1&quot;</span>
  debug: <span class="nv">var</span><span class="o">=</span>item
  with_items: <span class="s2">&quot;{{domain_definition|json_query(server_name_cluster1_query)}}&quot;</span>
  vars:
    server_name_cluster1_query: <span class="s2">&quot;domain.server[?cluster==&#39;cluster2&#39;].{name: name, port: port}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="ip-address-filter">
<span id="ipaddr-filter"></span><h6><a class="toc-backref" href="#id19">IP address filter</a><a class="headerlink" href="#ip-address-filter" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.</span></p>
</div>
<p>To test if a string is a valid IP address:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> myvar <span class="p">|</span> ipaddr <span class="o">}}</span>
</pre></div>
</div>
<p>You can also require a specific IP protocol version:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> myvar <span class="p">|</span> ipv4 <span class="o">}}</span>
<span class="o">{{</span> myvar <span class="p">|</span> ipv6 <span class="o">}}</span>
</pre></div>
</div>
<p>IP address filter can also be used to extract specific information from an IP
address. For example, to get the IP address itself from a CIDR, you can use:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s1">&#39;192.0.2.1/24&#39;</span> <span class="p">|</span> ipaddr<span class="o">(</span><span class="s1">&#39;address&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>More information about <code class="docutils literal"><span class="pre">ipaddr</span></code> filter and complete usage guide can be found
in <a class="reference internal" href="index.html#document-playbooks_filters_ipaddr"><span class="doc">ipaddr filter</span></a>.</p>
</div>
<div class="section" id="network-cli-filters">
<span id="network-filters"></span><h6><a class="toc-backref" href="#id20">Network CLI filters</a><a class="headerlink" href="#network-cli-filters" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
<p>To convert the output of a network device CLI command into structured JSON
output, use the <code class="docutils literal"><span class="pre">parse_cli</span></code> filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> output <span class="p">|</span> parse_cli<span class="o">(</span><span class="s1">&#39;path/to/spec&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">parse_cli</span></code> filter will load the spec file and pass the command output
through, it returning JSON output.  The spec file is a YAML yaml that defines
how to parse the CLI output.</p>
<p>The spec file should be valid formatted YAML.  It defines how to parse the CLI
output and return JSON data.  Below is an example of a valid spec file that
will parse the output from the <code class="docutils literal"><span class="pre">show</span> <span class="pre">vlan</span></code> command.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
vars:
  vlan:
    vlan_id: <span class="s2">&quot;{{ item.vlan_id }}&quot;</span>
    name: <span class="s2">&quot;{{ item.name }}&quot;</span>
    enabled: <span class="s2">&quot;{{ item.state != &#39;act/lshut&#39; }}&quot;</span>
    state: <span class="s2">&quot;{{ item.state }}&quot;</span>

keys:
  vlans:
    type: list
    value: <span class="s2">&quot;{{ vlan }}&quot;</span>
    items: <span class="s2">&quot;^(?P&lt;vlan_id&gt;\\d+)\\s+(?P&lt;name&gt;\\w+)\\s+(?P&lt;state&gt;active|act/lshut|suspended)&quot;</span>
  state_static:
    value: present
</pre></div>
</div>
<p>The spec file above will return a JSON data structure that is a list of hashes
with the parsed VLAN information.</p>
<p>The same command could be parsed into a hash by using the key and values
directives.  Here is an example of how to parse the output into a hash
value using the same <code class="docutils literal"><span class="pre">show</span> <span class="pre">vlan</span></code> command.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
vars:
  vlan:
    key: <span class="s2">&quot;{{ item.vlan_id }}&quot;</span>
    values:
      vlan_id: <span class="s2">&quot;{{ item.vlan_id }}&quot;</span>
      name: <span class="s2">&quot;{{ item.name }}&quot;</span>
      enabled: <span class="s2">&quot;{{ item.state != &#39;act/lshut&#39; }}&quot;</span>
      state: <span class="s2">&quot;{{ item.state }}&quot;</span>

keys:
  vlans:
    type: list
    value: <span class="s2">&quot;{{ vlan }}&quot;</span>
    items: <span class="s2">&quot;^(?P&lt;vlan_id&gt;\\d+)\\s+(?P&lt;name&gt;\\w+)\\s+(?P&lt;state&gt;active|act/lshut|suspended)&quot;</span>
  state_static:
    value: present
</pre></div>
</div>
<p>Another common use case for parsing CLI commands is to break a large command
into blocks that can parsed.  This can be done using the <code class="docutils literal"><span class="pre">start_block</span></code> and
<code class="docutils literal"><span class="pre">end_block</span></code> directives to break the command into blocks that can be parsed.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
vars:
  interface:
    name: <span class="s2">&quot;{{ item[0].match[0] }}&quot;</span>
    state: <span class="s2">&quot;{{ item[1].state }}&quot;</span>
    mode: <span class="s2">&quot;{{ item[2].match[0] }}&quot;</span>

keys:
  interfaces:
    value: <span class="s2">&quot;{{ interface }}&quot;</span>
    start_block: <span class="s2">&quot;^Ethernet.*</span>$<span class="s2">&quot;</span>
    end_block: <span class="s2">&quot;^</span>$<span class="s2">&quot;</span>
    items:
      - <span class="s2">&quot;^(?P&lt;name&gt;Ethernet\\d\\/\\d*)&quot;</span>
      - <span class="s2">&quot;admin state is (?P&lt;state&gt;.+),&quot;</span>
      - <span class="s2">&quot;Port mode is (.+)&quot;</span>
</pre></div>
</div>
<p>The example above will parse the output of <code class="docutils literal"><span class="pre">show</span> <span class="pre">interface</span></code> into a list of
hashes.</p>
<p>The network filters also support parsing the output of a CLI command using the
TextFSM library.  To parse the CLI output with TextFSM use the following
filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> output <span class="p">|</span> parse_cli_textfsm<span class="o">(</span><span class="s1">&#39;path/to/fsm&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Use of the TextFSM filter requires the TextFSM library to be installed.</p>
</div>
<div class="section" id="hashing-filters">
<span id="hash-filters"></span><h6><a class="toc-backref" href="#id21">Hashing filters</a><a class="headerlink" href="#hashing-filters" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.</span></p>
</div>
<p>To get the sha1 hash of a string:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s1">&#39;test1&#39;</span><span class="p">|</span>hash<span class="o">(</span><span class="s1">&#39;sha1&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get the md5 hash of a string:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s1">&#39;test1&#39;</span><span class="p">|</span>hash<span class="o">(</span><span class="s1">&#39;md5&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Get a string checksum:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s1">&#39;test2&#39;</span><span class="p">|</span>checksum <span class="o">}}</span>
</pre></div>
</div>
<p>Other hashes (platform dependent):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s1">&#39;test2&#39;</span><span class="p">|</span>hash<span class="o">(</span><span class="s1">&#39;blowfish&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get a sha512 password hash (random salt):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s1">&#39;passwordsaresecret&#39;</span><span class="p">|</span>password_hash<span class="o">(</span><span class="s1">&#39;sha512&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get a sha256 password hash with a specific salt:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s1">&#39;secretpassword&#39;</span><span class="p">|</span>password_hash<span class="o">(</span><span class="s1">&#39;sha256&#39;</span>, <span class="s1">&#39;mysecretsalt&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>Hash types available depend on the master system running ansible,
&#8216;hash&#8217; depends on hashlib password_hash depends on passlib (<a class="reference external" href="http://passlib.readthedocs.io/en/stable/lib/passlib.hash.html">http://passlib.readthedocs.io/en/stable/lib/passlib.hash.html</a>).</p>
</div>
<div class="section" id="combining-hashes-dictionaries">
<span id="combine-filter"></span><h6><a class="toc-backref" href="#id22">Combining hashes/dictionaries</a><a class="headerlink" href="#combining-hashes-dictionaries" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>The <cite>combine</cite> filter allows hashes to be merged. For example, the
following would override keys in one hash:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="o">{</span><span class="s1">&#39;a&#39;</span>:1, <span class="s1">&#39;b&#39;</span>:2<span class="o">}</span><span class="p">|</span>combine<span class="o">({</span><span class="s1">&#39;b&#39;</span>:3<span class="o">})</span> <span class="o">}}</span>
</pre></div>
</div>
<p>The resulting hash would be:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span><span class="s1">&#39;a&#39;</span>:1, <span class="s1">&#39;b&#39;</span>:3<span class="o">}</span>
</pre></div>
</div>
<p>The filter also accepts an optional <cite>recursive=True</cite> parameter to not
only override keys in the first hash, but also recurse into nested
hashes and merge their keys too</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{{</span> <span class="o">{</span><span class="s1">&#39;a&#39;</span><span class="o">:{</span><span class="s1">&#39;foo&#39;</span><span class="o">:</span><span class="m">1</span><span class="o">,</span> <span class="s1">&#39;bar&#39;</span><span class="o">:</span><span class="m">2</span><span class="o">},</span> <span class="s1">&#39;b&#39;</span><span class="o">:</span><span class="m">2</span><span class="o">}|</span><span class="nf">combine</span><span class="o">({</span><span class="s1">&#39;a&#39;</span><span class="o">:{</span><span class="s1">&#39;bar&#39;</span><span class="o">:</span><span class="m">3</span><span class="o">,</span> <span class="s1">&#39;baz&#39;</span><span class="o">:</span><span class="m">4</span><span class="cp">}}</span><span class="x">, recursive=True) }}</span>
</pre></div>
</div>
<p>This would result in:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span><span class="s1">&#39;a&#39;</span>:<span class="o">{</span><span class="s1">&#39;foo&#39;</span>:1, <span class="s1">&#39;bar&#39;</span>:3, <span class="s1">&#39;baz&#39;</span>:4<span class="o">}</span>, <span class="s1">&#39;b&#39;</span>:2<span class="o">}</span>
</pre></div>
</div>
<p>The filter can also take multiple arguments to merge:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> a<span class="p">|</span>combine<span class="o">(</span>b, c, d<span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>In this case, keys in <cite>d</cite> would override those in <cite>c</cite>, which would
override those in <cite>b</cite>, and so on.</p>
<p>This behaviour does not depend on the value of the <cite>hash_behaviour</cite>
setting in <cite>ansible.cfg</cite>.</p>
</div>
<div class="section" id="extracting-values-from-containers">
<span id="extract-filter"></span><h6><a class="toc-backref" href="#id23">Extracting values from containers</a><a class="headerlink" href="#extracting-values-from-containers" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>The <cite>extract</cite> filter is used to map from a list of indices to a list of
values from a container (hash or array):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="o">[</span><span class="m">0</span>,2<span class="o">]</span><span class="p">|</span>map<span class="o">(</span><span class="s1">&#39;extract&#39;</span>, <span class="o">[</span><span class="s1">&#39;x&#39;</span>,<span class="s1">&#39;y&#39;</span>,<span class="s1">&#39;z&#39;</span><span class="o">])</span><span class="p">|</span>list <span class="o">}}</span>
<span class="o">{{</span> <span class="o">[</span><span class="s1">&#39;x&#39;</span>,<span class="s1">&#39;y&#39;</span><span class="o">]</span><span class="p">|</span>map<span class="o">(</span><span class="s1">&#39;extract&#39;</span>, <span class="o">{</span><span class="s1">&#39;x&#39;</span>: <span class="m">42</span>, <span class="s1">&#39;y&#39;</span>: <span class="m">31</span><span class="o">})</span><span class="p">|</span>list <span class="o">}}</span>
</pre></div>
</div>
<p>The results of the above expressions would be:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span><span class="s1">&#39;x&#39;</span>, <span class="s1">&#39;z&#39;</span><span class="o">]</span>
<span class="o">[</span><span class="m">42</span>, <span class="m">31</span><span class="o">]</span>
</pre></div>
</div>
<p>The filter can take another argument:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> groups<span class="o">[</span><span class="s1">&#39;x&#39;</span><span class="o">]</span><span class="p">|</span>map<span class="o">(</span><span class="s1">&#39;extract&#39;</span>, hostvars, <span class="s1">&#39;ec2_ip_address&#39;</span><span class="o">)</span><span class="p">|</span>list <span class="o">}}</span>
</pre></div>
</div>
<p>This takes the list of hosts in group &#8216;x&#8217;, looks them up in <cite>hostvars</cite>,
and then looks up the <cite>ec2_ip_address</cite> of the result. The final result
is a list of IP addresses for the hosts in group &#8216;x&#8217;.</p>
<p>The third argument to the filter can also be a list, for a recursive
lookup inside the container:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">|</span>map<span class="o">(</span><span class="s1">&#39;extract&#39;</span>, b, <span class="o">[</span><span class="s1">&#39;x&#39;</span>,<span class="s1">&#39;y&#39;</span><span class="o">])</span><span class="p">|</span>list <span class="o">}}</span>
</pre></div>
</div>
<p>This would return a list containing the value of <cite>b[&#8216;a&#8217;][&#8216;x&#8217;][&#8216;y&#8217;]</cite>.</p>
</div>
<div class="section" id="comment-filter">
<span id="id6"></span><h6><a class="toc-backref" href="#id24">Comment Filter</a><a class="headerlink" href="#comment-filter" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>The <cite>comment</cite> filter allows to decorate the text with a chosen comment
style. For example the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s2">&quot;Plain style (default)&quot;</span> <span class="p">|</span> comment <span class="o">}}</span>
</pre></div>
</div>
<p>will produce this output:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Plain style (default)</span>
<span class="c1">#</span>
</pre></div>
</div>
<p>Similar way can be applied style for C (<code class="docutils literal"><span class="pre">//...</span></code>), C block
(<code class="docutils literal"><span class="pre">/*...*/</span></code>), Erlang (<code class="docutils literal"><span class="pre">%...</span></code>) and XML (<code class="docutils literal"><span class="pre">&lt;!--...--&gt;</span></code>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s2">&quot;C style&quot;</span> <span class="p">|</span> comment<span class="o">(</span><span class="s1">&#39;c&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="o">{{</span> <span class="s2">&quot;C block style&quot;</span> <span class="p">|</span> comment<span class="o">(</span><span class="s1">&#39;cblock&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="o">{{</span> <span class="s2">&quot;Erlang style&quot;</span> <span class="p">|</span> comment<span class="o">(</span><span class="s1">&#39;erlang&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="o">{{</span> <span class="s2">&quot;XML style&quot;</span> <span class="p">|</span> comment<span class="o">(</span><span class="s1">&#39;xml&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>It is also possible to fully customize the comment style:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s2">&quot;Custom style&quot;</span> <span class="p">|</span> comment<span class="o">(</span><span class="s1">&#39;plain&#39;</span>, <span class="nv">prefix</span><span class="o">=</span><span class="s1">&#39;#######\n#&#39;</span>, <span class="nv">postfix</span><span class="o">=</span><span class="s1">&#39;#\n#######\n   ###\n    #&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>That will create the following output:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1">#######</span>
<span class="c1">#</span>
<span class="c1"># Custom style</span>
<span class="c1">#</span>
<span class="c1">#######</span>
   <span class="c1">###</span>
    <span class="c1">#</span>
</pre></div>
</div>
<p>The filter can also be applied to any Ansible variable. For example to
make the output of the <code class="docutils literal"><span class="pre">ansible_managed</span></code> variable more readable, we can
change the definition in the <code class="docutils literal"><span class="pre">ansible.cfg</span></code> file to this:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="x">[defaults]</span>

<span class="x">ansible_managed = This file is managed by Ansible.%n</span>
<span class="x">  template: {file}</span>
<span class="x">  date: %Y-%m-%d %H:%M:%S</span>
<span class="x">  user: {uid}</span>
<span class="x">  host: {host}</span>
</pre></div>
</div>
<p>and then use the variable with the <cite>comment</cite> filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_managed <span class="p">|</span> comment <span class="o">}}</span>
</pre></div>
</div>
<p>which will produce this output:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># This file is managed by Ansible.</span>
<span class="c1">#</span>
<span class="c1"># template: /home/ansible/env/dev/ansible_managed/roles/role1/templates/test.j2</span>
<span class="c1"># date: 2015-09-10 11:02:58</span>
<span class="c1"># user: ansible</span>
<span class="c1"># host: myhost</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
<div class="section" id="url-split-filter">
<span id="other-useful-filters"></span><h6><a class="toc-backref" href="#id25">URL Split Filter</a><a class="headerlink" href="#url-split-filter" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
<p>The <code class="docutils literal"><span class="pre">urlsplit</span></code> filter extracts the fragment, hostname, netloc, password, path, port, query, scheme, and username from an URL. With no arguments, returns a dictionary of all the fields:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;hostname&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;www.acme.com&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;netloc&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;user:password@www.acme.com:9000&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;username&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;user&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;password&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;password&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;path&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;/dir/index.html&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;port&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;9000&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;scheme&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;http&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;query&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;query=term&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit<span class="o">(</span><span class="s1">&#39;fragment&#39;</span><span class="o">)</span> <span class="o">}}</span>
<span class="c1"># =&gt; &#39;fragment&#39;</span>

<span class="o">{{</span> <span class="s2">&quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#frament&quot;</span> <span class="p">|</span> urlsplit <span class="o">}}</span>
<span class="c1"># =&gt;</span>
<span class="c1">#   {</span>
<span class="c1">#       &quot;fragment&quot;: &quot;fragment&quot;,</span>
<span class="c1">#       &quot;hostname&quot;: &quot;www.acme.com&quot;,</span>
<span class="c1">#       &quot;netloc&quot;: &quot;user:password@www.acme.com:9000&quot;,</span>
<span class="c1">#       &quot;password&quot;: &quot;password&quot;,</span>
<span class="c1">#       &quot;path&quot;: &quot;/dir/index.html&quot;,</span>
<span class="c1">#       &quot;port&quot;: 9000,</span>
<span class="c1">#       &quot;query&quot;: &quot;query=term&quot;,</span>
<span class="c1">#       &quot;scheme&quot;: &quot;http&quot;,</span>
<span class="c1">#       &quot;username&quot;: &quot;user&quot;</span>
<span class="c1">#   }</span>
</pre></div>
</div>
</div>
<div class="section" id="regular-expression-filters">
<h6><a class="toc-backref" href="#id26">Regular Expression Filters</a><a class="headerlink" href="#regular-expression-filters" title="Permalink to this headline">¶</a></h6>
<p>To search a string with a regex, use the &#8220;regex_search&#8221; filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># search for &quot;foo&quot; in &quot;foobar&quot;</span>
<span class="o">{{</span> <span class="s1">&#39;foobar&#39;</span> <span class="p">|</span> regex_search<span class="o">(</span><span class="s1">&#39;(foo)&#39;</span><span class="o">)</span> <span class="o">}}</span>

<span class="c1"># will return empty if it cannot find a match</span>
<span class="o">{{</span> <span class="s1">&#39;ansible&#39;</span> <span class="p">|</span> regex_search<span class="o">(</span><span class="s1">&#39;(foobar)&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To search for all occurrences of regex matches, use the &#8220;regex_findall&#8221; filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Return a list of all IPv4 addresses in the string</span>
<span class="o">{{</span> <span class="s1">&#39;Some DNS servers are 8.8.8.8 and 8.8.4.4&#39;</span> <span class="p">|</span> regex_findall<span class="o">(</span><span class="s1">&#39;\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To replace text in a string with regex, use the &#8220;regex_replace&#8221; filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># convert &quot;ansible&quot; to &quot;able&quot;</span>
<span class="o">{{</span> <span class="s1">&#39;ansible&#39;</span> <span class="p">|</span> regex_replace<span class="o">(</span><span class="s1">&#39;^a.*i(.*)$&#39;</span>, <span class="s1">&#39;a\\1&#39;</span><span class="o">)</span> <span class="o">}}</span>

<span class="c1"># convert &quot;foobar&quot; to &quot;bar&quot;</span>
<span class="o">{{</span> <span class="s1">&#39;foobar&#39;</span> <span class="p">|</span> regex_replace<span class="o">(</span><span class="s1">&#39;^f.*o(.*)$&#39;</span>, <span class="s1">&#39;\\1&#39;</span><span class="o">)</span> <span class="o">}}</span>

<span class="c1"># convert &quot;localhost:80&quot; to &quot;localhost, 80&quot; using named groups</span>
<span class="o">{{</span> <span class="s1">&#39;localhost:80&#39;</span> <span class="p">|</span> regex_replace<span class="o">(</span><span class="s1">&#39;^(?P&lt;host&gt;.+):(?P&lt;port&gt;\\d+)$&#39;</span>, <span class="s1">&#39;\\g&lt;host&gt;, \\g&lt;port&gt;&#39;</span><span class="o">)</span> <span class="o">}}</span>

<span class="c1"># convert &quot;localhost:80&quot; to &quot;localhost&quot;</span>
<span class="o">{{</span> <span class="s1">&#39;localhost:80&#39;</span> <span class="p">|</span> regex_replace<span class="o">(</span><span class="s1">&#39;:80&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Prior to ansible 2.0, if &#8220;regex_replace&#8221; filter was used with variables inside YAML arguments (as opposed to simpler &#8216;key=value&#8217; arguments),
then you needed to escape backreferences (e.g. <code class="docutils literal"><span class="pre">\\1</span></code>) with 4 backslashes (<code class="docutils literal"><span class="pre">\\\\</span></code>) instead of 2 (<code class="docutils literal"><span class="pre">\\</span></code>).</p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>To escape special characters within a regex, use the &#8220;regex_escape&#8221; filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># convert &#39;^f.*o(.*)$&#39; to &#39;\^f\.\*o\(\.\*\)\$&#39;</span>
<span class="o">{{</span> <span class="s1">&#39;^f.*o(.*)$&#39;</span> <span class="p">|</span> regex_escape<span class="o">()</span> <span class="o">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h6><a class="toc-backref" href="#id27">Other Useful Filters</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h6>
<p>To add quotes for shell usage:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- shell: <span class="nb">echo</span> <span class="o">{{</span> string_value <span class="p">|</span> quote <span class="o">}}</span>
</pre></div>
</div>
<p>To use one value on true and another on false (new in version 1.9):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> <span class="o">(</span><span class="nv">name</span> <span class="o">==</span> <span class="s2">&quot;John&quot;</span><span class="o">)</span> <span class="p">|</span> ternary<span class="o">(</span><span class="s1">&#39;Mr&#39;</span>,<span class="s1">&#39;Ms&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To concatenate a list into a string:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> list <span class="p">|</span> join<span class="o">(</span><span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get the last name of a file path, like &#8216;foo.txt&#8217; out of &#8216;/etc/asdf/foo.txt&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> basename <span class="o">}}</span>
</pre></div>
</div>
<p>To get the last name of a windows style file path (new in version 2.0):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> win_basename <span class="o">}}</span>
</pre></div>
</div>
<p>To separate the windows drive letter from the rest of a file path (new in version 2.0):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> win_splitdrive <span class="o">}}</span>
</pre></div>
</div>
<p>To get only the windows drive letter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> win_splitdrive <span class="p">|</span> first <span class="o">}}</span>
</pre></div>
</div>
<p>To get the rest of the path without the drive letter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> win_splitdrive <span class="p">|</span> last <span class="o">}}</span>
</pre></div>
</div>
<p>To get the directory from a path:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> dirname <span class="o">}}</span>
</pre></div>
</div>
<p>To get the directory from a windows path (new version 2.0):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> win_dirname <span class="o">}}</span>
</pre></div>
</div>
<p>To expand a path containing a tilde (<cite>~</cite>) character (new in version 1.5):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> expanduser <span class="o">}}</span>
</pre></div>
</div>
<p>To get the real path of a link (new in version 1.8):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> realpath <span class="o">}}</span>
</pre></div>
</div>
<p>To get the relative path of a link, from a start point (new in version 1.7):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> path <span class="p">|</span> relpath<span class="o">(</span><span class="s1">&#39;/etc&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get the root and extension of a path or filename (new in version 2.0):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># with path == &#39;nginx.conf&#39; the return would be (&#39;nginx&#39;, &#39;.conf&#39;)</span>
<span class="o">{{</span> path <span class="p">|</span> splitext <span class="o">}}</span>
</pre></div>
</div>
<p>To work with Base64 encoded strings:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> encoded <span class="p">|</span> b64decode <span class="o">}}</span>
<span class="o">{{</span> decoded <span class="p">|</span> b64encode <span class="o">}}</span>
</pre></div>
</div>
<p>To create a UUID from a string (new in version 1.9):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> hostname <span class="p">|</span> to_uuid <span class="o">}}</span>
</pre></div>
</div>
<p>To cast values as certain types, such as when you input a string as &#8220;True&#8221; from a vars_prompt and the system
doesn&#8217;t know it is a boolean value:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="nb">test</span>
  when: some_string_value <span class="p">|</span> bool
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>To make use of one attribute from each item in a list of complex variables, use the &#8220;map&#8221; filter (see the <a class="reference external" href="http://jinja.pocoo.org/docs/dev/templates/#map">Jinja2 map() docs</a> for more):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># get a comma-separated list of the mount points (e.g. &quot;/,/mnt/stuff&quot;) on a host</span>
<span class="o">{{</span> ansible_mounts<span class="p">|</span>map<span class="o">(</span><span class="nv">attribute</span><span class="o">=</span><span class="s1">&#39;mount&#39;</span><span class="o">)</span><span class="p">|</span>join<span class="o">(</span><span class="s1">&#39;,&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>To get date object from string use the <cite>to_datetime</cite> filter, (new in version in 2.2):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># get amount of seconds between two dates, default date format is %Y-%m-%d %H:%M:%S but you can pass your own one</span>
<span class="o">{{</span> <span class="o">((</span><span class="s2">&quot;2016-08-14 20:00:12&quot;</span><span class="p">|</span>to_datetime<span class="o">)</span> - <span class="o">(</span><span class="s2">&quot;2015-12-25&quot;</span><span class="p">|</span>to_datetime<span class="o">(</span><span class="s1">&#39;%Y-%m-%d&#39;</span><span class="o">)))</span>.seconds  <span class="o">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="combination-filters">
<h6><a class="toc-backref" href="#id28">Combination Filters</a><a class="headerlink" href="#combination-filters" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p>This set of filters returns a list of combined lists.
To get permutations of a list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: give me largest permutations <span class="o">(</span>order matters<span class="o">)</span>
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ [1,2,3,4,5]|permutations|list }}&quot;</span>

- name: give me permutations of sets of three
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ [1,2,3,4,5]|permutations(3)|list }}&quot;</span>
</pre></div>
</div>
<p>Combinations always require a set size:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: give me combinations <span class="k">for</span> sets of two
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ [1,2,3,4,5]|combinations(2)|list }}&quot;</span>
</pre></div>
</div>
<p>To get a list combining the elements of other lists use <code class="docutils literal"><span class="pre">zip</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: give me list combo of two lists
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ [1,2,3,4,5]|zip([&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;])|list }}&quot;</span>

- name: give me shortest combo of two lists
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ [1,2,3]|zip([&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;])|list }}&quot;</span>
</pre></div>
</div>
<p>To always exhaust all list use <code class="docutils literal"><span class="pre">zip_longest</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: give me longest combo of three lists , fill with X
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ [1,2,3]|zip_longest([&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;], [21, 22, 23], fillvalue=&#39;X&#39;)|list }}&quot;</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
<p>To format a date using a string (like with the shell date command), use the &#8220;strftime&#8221; filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Display year-month-day</span>
<span class="o">{{</span> <span class="s1">&#39;%Y-%m-%d&#39;</span> <span class="p">|</span> strftime <span class="o">}}</span>

<span class="c1"># Display hour:min:sec</span>
<span class="o">{{</span> <span class="s1">&#39;%H:%M:%S&#39;</span> <span class="p">|</span> strftime <span class="o">}}</span>

<span class="c1"># Use ansible_date_time.epoch fact</span>
<span class="o">{{</span> <span class="s1">&#39;%Y-%m-%d %H:%M:%S&#39;</span> <span class="p">|</span> strftime<span class="o">(</span>ansible_date_time.epoch<span class="o">)</span> <span class="o">}}</span>

<span class="c1"># Use arbitrary epoch value</span>
<span class="o">{{</span> <span class="s1">&#39;%Y-%m-%d&#39;</span> <span class="p">|</span> strftime<span class="o">(</span><span class="m">0</span><span class="o">)</span> <span class="o">}}</span>          <span class="c1"># =&gt; 1970-01-01</span>
<span class="o">{{</span> <span class="s1">&#39;%Y-%m-%d&#39;</span> <span class="p">|</span> strftime<span class="o">(</span><span class="m">1441357287</span><span class="o">)</span> <span class="o">}}</span> <span class="c1"># =&gt; 2015-09-04</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To get all string possibilities, check <a class="reference external" href="https://docs.python.org/2/library/time.html#time.strftime">https://docs.python.org/2/library/time.html#time.strftime</a></p>
</div>
</div>
<div class="section" id="debugging-filters">
<h6><a class="toc-backref" href="#id29">Debugging Filters</a><a class="headerlink" href="#debugging-filters" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p>Use the <code class="docutils literal"><span class="pre">type_debug</span></code> filter to display the underlying Python type of a variable.
This can be useful in debugging in situations where you may need to know the exact
type of a variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> myvar <span class="p">|</span> type_debug <span class="o">}}</span>
</pre></div>
</div>
<p>A few useful filters are typically added with each new Ansible release.  The development documentation shows
how to extend Ansible filters by writing your own as plugins, though in general, we encourage new ones
to be added to core so everyone can make use of them.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Looping in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_tests"></span><div class="section" id="tests">
<h5><a class="toc-backref" href="#id2">Tests</a><a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#tests" id="id2">Tests</a><ul>
<li><a class="reference internal" href="#testing-strings" id="id3">Testing strings</a></li>
<li><a class="reference internal" href="#version-comparison" id="id4">Version Comparison</a></li>
<li><a class="reference internal" href="#group-theory-tests" id="id5">Group theory tests</a></li>
<li><a class="reference internal" href="#testing-paths" id="id6">Testing paths</a></li>
<li><a class="reference internal" href="#task-results" id="id7">Task results</a></li>
</ul>
</li>
</ul>
</div>
<p>Tests in Jinja2 are a way of evaluating template expressions and returning True or False.
Jinja2 ships with many of these. See <a class="reference external" href="http://jinja.pocoo.org/docs/templates/#builtin-tests">builtin tests</a> in the official Jinja2 template documentation.
Tests are very similar to filters and are used mostly the same way, but they can also be used in list processing filters, like C(map()) and C(select()) to choose items in the list.</p>
<p>Like all templating, tests always execute on the Ansible controller, <strong>not</strong> on the target of a task, as they test local data.</p>
<p>In addition to those Jinja2 tests, Ansible supplies a few more and users can easily create their own.</p>
<div class="section" id="testing-strings">
<span id="id1"></span><h6><a class="toc-backref" href="#id3">Testing strings</a><a class="headerlink" href="#testing-strings" title="Permalink to this headline">¶</a></h6>
<p>To match strings against a substring or a regex, use the &#8220;match&#8221; or &#8220;search&#8221; filter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars:
  url: <span class="s2">&quot;http://example.com/users/foo/resources/bar&quot;</span>

tasks:
    - debug: <span class="s2">&quot;msg=&#39;matched pattern 1&#39;&quot;</span>
      when: url <span class="p">|</span> match<span class="o">(</span><span class="s2">&quot;http://example.com/users/.*/resources/.*&quot;</span><span class="o">)</span>

    - debug: <span class="s2">&quot;msg=&#39;matched pattern 2&#39;&quot;</span>
      when: url <span class="p">|</span> search<span class="o">(</span><span class="s2">&quot;/users/.*/resources/.*&quot;</span><span class="o">)</span>

    - debug: <span class="s2">&quot;msg=&#39;matched pattern 3&#39;&quot;</span>
      when: url <span class="p">|</span> search<span class="o">(</span><span class="s2">&quot;/users/&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>&#8216;match&#8217; requires a complete match in the string, while &#8216;search&#8217; only requires matching a subset of the string.</p>
</div>
<div class="section" id="version-comparison">
<span id="testing-versions"></span><h6><a class="toc-backref" href="#id4">Version Comparison</a><a class="headerlink" href="#version-comparison" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>To compare a version number, such as checking if the <code class="docutils literal"><span class="pre">ansible_distribution_version</span></code>
version is greater than or equal to &#8216;12.04&#8217;, you can use the <code class="docutils literal"><span class="pre">version_compare</span></code> filter.</p>
<p>The <code class="docutils literal"><span class="pre">version_compare</span></code> filter can also be used to evaluate the <code class="docutils literal"><span class="pre">ansible_distribution_version</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> ansible_distribution_version <span class="p">|</span> version_compare<span class="o">(</span><span class="s1">&#39;12.04&#39;</span>, <span class="s1">&#39;&gt;=&#39;</span><span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">ansible_distribution_version</span></code> is greater than or equal to 12, this filter returns True, otherwise False.</p>
<p>The <code class="docutils literal"><span class="pre">version_compare</span></code> filter accepts the following operators:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt;, lt, &lt;<span class="o">=</span>, le, &gt;, gt, &gt;<span class="o">=</span>, ge, <span class="o">==</span>, <span class="o">=</span>, eq, !<span class="o">=</span>, &lt;&gt;, ne
</pre></div>
</div>
<p>This test also accepts a 3rd parameter, <code class="docutils literal"><span class="pre">strict</span></code> which defines if strict version parsing should
be used.  The default is <code class="docutils literal"><span class="pre">False</span></code>, but this setting as <code class="docutils literal"><span class="pre">True</span></code> uses more strict version parsing:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{{</span> sample_version_var <span class="p">|</span> version_compare<span class="o">(</span><span class="s1">&#39;1.0&#39;</span>, <span class="nv">operator</span><span class="o">=</span><span class="s1">&#39;lt&#39;</span>, <span class="nv">strict</span><span class="o">=</span>True<span class="o">)</span> <span class="o">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="group-theory-tests">
<span id="math-tests"></span><h6><a class="toc-backref" href="#id5">Group theory tests</a><a class="headerlink" href="#group-theory-tests" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>To see if a list includes or is included by another list, you can use &#8216;issubset&#8217; and &#8216;issuperset&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars:
    a: <span class="o">[</span><span class="m">1</span>,2,3,4,5<span class="o">]</span>
    b: <span class="o">[</span><span class="m">2</span>,3<span class="o">]</span>
tasks:
    - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;A includes B&quot;</span>
      when: a<span class="p">|</span>issuperset<span class="o">(</span>b<span class="o">)</span>

    - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;B is included in A&quot;</span>
      when: b<span class="p">|</span>issubset<span class="o">(</span>a<span class="o">)</span>
</pre></div>
</div>
<div class="versionadded" id="path-tests">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
<p>You can use <cite>any</cite> and <cite>all</cite> to check if any or all elements in a list are true or not:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars:
  mylist:
      - <span class="m">1</span>
      - <span class="nv">3</span> <span class="o">==</span> <span class="m">3</span>
      - True
  myotherlist:
      - False
      - True
tasks:

  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;all are true!&quot;</span>
    when: mylist is all

  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;at least one is true&quot;</span>
    when: myotherlist<span class="p">|</span>any
</pre></div>
</div>
</div>
<div class="section" id="testing-paths">
<h6><a class="toc-backref" href="#id6">Testing paths</a><a class="headerlink" href="#testing-paths" title="Permalink to this headline">¶</a></h6>
<p>The following tests can provide information about a path on the controller:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;path is a directory&quot;</span>
  when: mypath<span class="p">|</span>is_dir

- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;path is a file&quot;</span>
  when: mypath<span class="p">|</span>is_file

- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;path is a symlink&quot;</span>
  when: mypath<span class="p">|</span>is_link

- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;path already exists&quot;</span>
  when: mypath<span class="p">|</span>exists

- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;path is {{ (mypath|is_abs)|ternary(&#39;absolute&#39;,&#39;relative&#39;)}}&quot;</span>

- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;path is the same file as path2&quot;</span>
  when: mypath<span class="p">|</span>samefile<span class="o">(</span>path2<span class="o">)</span>

- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;path is a mount&quot;</span>
  when: mypath<span class="p">|</span>is_mount
</pre></div>
</div>
</div>
<div class="section" id="task-results">
<span id="test-task-results"></span><h6><a class="toc-backref" href="#id7">Task results</a><a class="headerlink" href="#task-results" title="Permalink to this headline">¶</a></h6>
<p>The following tasks are illustrative of the tests meant to check the status of tasks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

  - shell: /usr/bin/foo
    register: result
    ignore_errors: True

  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;it failed&quot;</span>
    when: result<span class="p">|</span>failed

  <span class="c1"># in most cases you&#39;ll want a handler, but if you want to do something right now, this is nice</span>
  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;it changed&quot;</span>
    when: result<span class="p">|</span>changed

  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;it succeeded in Ansible &gt;= 2.1&quot;</span>
    when: result<span class="p">|</span>succeeded

  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;it succeeded&quot;</span>
    when: result<span class="p">|</span>success

  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;it was skipped&quot;</span>
    when: result<span class="p">|</span>skipped
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">From 2.1, you can also use success, failure, change, and skip so that the grammar matches, for those who need to be strict about it.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Looping in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_lookups"></span><div class="section" id="lookups">
<h5><a class="toc-backref" href="#id3">Lookups</a><a class="headerlink" href="#lookups" title="Permalink to this headline">¶</a></h5>
<p>Lookup plugins allow access of data in Ansible from outside sources. Like all templating, these plugins are evaluated on the Ansible control
machine, and can include reading the filesystem but also contacting external datastores and services.
These values are then made available using the standard templating system in Ansible, and are typically used to load variables or templates with information from those systems.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is considered an advanced feature, and many users will probably not rely on these features.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lookups occur on the local computer, not on the remote computer.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lookups are executed with a cwd relative to the role or play, as opposed to local tasks which are executed with the cwd of the executed script.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since 1.9 you can pass wantlist=True to lookups to use in jinja2 template &#8220;for&#8221; loops.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Some lookups pass arguments to a shell. When using variables from a remote/untrusted source, use the <cite>|quote</cite> filter to ensure safe usage.</p>
</div>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#lookups" id="id3">Lookups</a><ul>
<li><a class="reference internal" href="#intro-to-lookups-getting-file-contents" id="id4">Intro to Lookups: Getting File Contents</a></li>
<li><a class="reference internal" href="#the-password-lookup" id="id5">The Password Lookup</a></li>
<li><a class="reference internal" href="#the-passwordstore-lookup" id="id6">The Passwordstore Lookup</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples" id="id7">Examples</a><ul>
<li><a class="reference internal" href="#the-csv-file-lookup" id="id8">The CSV File Lookup</a></li>
<li><a class="reference internal" href="#the-ini-file-lookup" id="id9">The INI File Lookup</a></li>
<li><a class="reference internal" href="#the-credstash-lookup" id="id10">The Credstash Lookup</a></li>
<li><a class="reference internal" href="#the-dns-lookup-dig" id="id11">The DNS Lookup (dig)</a></li>
<li><a class="reference internal" href="#mongodb-lookup" id="id12">MongoDB Lookup</a></li>
<li><a class="reference internal" href="#more-lookups" id="id13">More Lookups</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="intro-to-lookups-getting-file-contents">
<span id="getting-file-contents"></span><h6><a class="toc-backref" href="#id4">Intro to Lookups: Getting File Contents</a><a class="headerlink" href="#intro-to-lookups-getting-file-contents" title="Permalink to this headline">¶</a></h6>
<p>The file lookup is the most basic lookup type.</p>
<p>Contents can be read off the filesystem as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all
  vars:
     contents: <span class="s2">&quot;{{ lookup(&#39;file&#39;, &#39;/etc/foo.txt&#39;) }}&quot;</span>

  tasks:

     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;the value of foo.txt is {{ contents }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="the-password-lookup">
<span id="password-lookup"></span><h6><a class="toc-backref" href="#id5">The Password Lookup</a><a class="headerlink" href="#the-password-lookup" title="Permalink to this headline">¶</a></h6>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A great alternative to the password lookup plugin, if you don&#8217;t need to generate random passwords on a per-host basis, would be to use <a class="reference internal" href="index.html#document-playbooks_vault"><span class="doc">Using Vault in playbooks</span></a>.  Read the documentation there and consider using it first, it will be more desirable for most applications.</p>
</div>
<p><code class="docutils literal"><span class="pre">password</span></code> generates a random plaintext password and stores it in
a file at a given filepath.</p>
<p>(Docs about crypted save modes are pending)</p>
<p>If the file exists previously, it will retrieve its contents, behaving just like with_file. Usage of variables like &#8220;{{ inventory_hostname }}&#8221; in the filepath can be used to set
up random passwords per host (which simplifies password management in &#8216;host_vars&#8217; variables).</p>
<p>A special case is using <code class="docutils literal"><span class="pre">/dev/null</span></code> as a path. The password lookup will generate a new random password each time, but will not write it to <code class="docutils literal"><span class="pre">/dev/null</span></code>. This can be used when you need a password
without storing it on the controller.</p>
<p>Generated passwords contain a random mix of upper and lowercase ASCII letters, the
numbers 0-9 and punctuation (&#8221;. , : - _&#8221;). The default length of a generated password is 20 characters.
This length can be changed by passing an extra parameter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all

  tasks:

    - name: create a mysql user with a random password
      mysql_user:
        name: <span class="s2">&quot;{{ client }}&quot;</span>
        password: <span class="s2">&quot;{{ lookup(&#39;password&#39;, &#39;credentials/&#39; + client + &#39;/&#39; + tier + &#39;/&#39; + role + &#39;/mysqlpassword length=15&#39;) }}&quot;</span>
        priv: <span class="s2">&quot;{{ client }}_{{ tier }}_{{ role }}.*:ALL&quot;</span>

    <span class="c1"># (...)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the file already exists, no data will be written to it. If the file has contents, those contents will be read in as the password. Empty files cause the password to return as an empty string.</p>
</div>
<p>Caution: Since this runs on the ansible host as the user running the playbook, and &#8220;become&#8221; does not apply, the target file must be readable by the playbook user, or, if it does not exist, the playbook user must have sufficient privileges to create it. (So, for example, attempts to write into areas such as /etc will fail unless the entire playbook is being run as root).</p>
<p>Starting in version 1.4, password accepts a &#8220;chars&#8221; parameter to allow defining a custom character set in the generated passwords. It accepts comma separated list of names that are either string module attributes (ascii_letters,digits, etc) or are used literally:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all

  tasks:

    - name: create a mysql user with a random password using only ascii letters
      mysql_user: <span class="nv">name</span><span class="o">={{</span> client <span class="o">}}</span> <span class="nv">password</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;password&#39;, &#39;/tmp/passwordfile chars=ascii_letters&#39;) }}&quot;</span> <span class="nv">priv</span><span class="o">={{</span> client <span class="o">}}</span>_<span class="o">{{</span> tier <span class="o">}}</span>_<span class="o">{{</span> role <span class="o">}}</span>.*:ALL

    - name: create a mysql user with a random password using only digits
      mysql_user:
        name: <span class="s2">&quot;{{ client }}&quot;</span>
        password: <span class="s2">&quot;{{ lookup(&#39;password&#39;, &#39;/tmp/passwordfile chars=digits&#39;) }}&quot;</span>
        priv: <span class="s2">&quot;{{ client }}_{{ tier }}_{{ role }}.*:ALL&quot;</span>

    - name: create a mysql user with a random password using many different char sets
      mysql_user:
        name: <span class="s2">&quot;{{ client }}&quot;</span>
        password<span class="s2">&quot; &quot;</span><span class="o">{{</span> lookup<span class="o">(</span><span class="s1">&#39;password&#39;</span>, <span class="s1">&#39;/tmp/passwordfile chars=ascii_letters,digits,hexdigits,punctuation&#39;</span><span class="o">)</span> <span class="o">}}</span><span class="s2">&quot;</span>
<span class="s2">        priv: &quot;</span><span class="o">{{</span> client <span class="o">}}</span>_<span class="o">{{</span> tier <span class="o">}}</span>_<span class="o">{{</span> role <span class="o">}}</span>.*:ALL<span class="s2">&quot;</span>

<span class="s2">    # (...)</span>
</pre></div>
</div>
<p>To enter comma use two commas &#8216;,,&#8217; somewhere - preferably at the end. Quotes and double quotes are not supported.</p>
</div>
<div class="section" id="the-passwordstore-lookup">
<span id="passwordstore-lookup"></span><h6><a class="toc-backref" href="#id6">The Passwordstore Lookup</a><a class="headerlink" href="#the-passwordstore-lookup" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p>The <code class="docutils literal"><span class="pre">passwordstore</span></code> lookup enables Ansible to retrieve, create or update passwords from
the <a class="reference external" href="https://www.passwordstore.org">passwordstore.org</a> <code class="docutils literal"><span class="pre">pass</span></code> utility. It also retrieves YAML style keys stored as multilines
in the passwordfile.</p>
</div>
</div>
<div class="section" id="examples">
<h5><a class="toc-backref" href="#id7">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h5>
<p>Basic lookup. Fails if example/test doesn&#8217;t exist:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;passwordstore&#39;, &#39;example/test&#39;)}}&quot;</span>
</pre></div>
</div>
<p>Create pass with random 16 character password. If password exists just give the password:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;passwordstore&#39;, &#39;example/test create=true&#39;)}}&quot;</span>
</pre></div>
</div>
<p>Different size password:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;passwordstore&#39;, &#39;example/test create=true length=42&#39;)}}&quot;</span>
</pre></div>
</div>
<p>Create password and overwrite the password if it exists. As a bonus, this module includes the old password inside the pass file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;passwordstore&#39;, &#39;example/test create=true overwrite=true&#39;)}}&quot;</span>
</pre></div>
</div>
<p>Return the value for user in the KV pair user: username:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;passwordstore&#39;, &#39;example/test subkey=user&#39;)}}&quot;</span>
</pre></div>
</div>
<p>Return the entire password file content:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">password</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;passwordstore&#39;, &#39;example/test returnall=true&#39;)}}&quot;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>The location of the password-store directory can be specified in the following ways:</dt>
<dd><ul class="first last simple">
<li>Default is ~/.password-store</li>
<li>Can be overruled by PASSWORD_STORE_DIR environment variable</li>
<li>Can be overruled by &#8216;passwordstore: path/to/.password-store&#8217; ansible setting</li>
<li>Can be overruled by &#8216;directory=path&#8217; argument in the lookup call</li>
</ul>
</dd>
</dl>
<div class="section" id="the-csv-file-lookup">
<span id="csvfile-lookup"></span><h6><a class="toc-backref" href="#id8">The CSV File Lookup</a><a class="headerlink" href="#the-csv-file-lookup" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.5.</span></p>
</div>
<p>The <code class="docutils literal"><span class="pre">csvfile</span></code> lookup reads the contents of a file in CSV (comma-separated value)
format. The lookup looks for the row where the first column matches <code class="docutils literal"><span class="pre">keyname</span></code>, and
returns the value in the second column, unless a different column is specified.</p>
<p>The example below shows the contents of a CSV file named elements.csv with information about the
periodic table of elements:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Symbol,Atomic Number,Atomic Mass
H,1,1.008
He,2,4.0026
Li,3,6.94
Be,4,9.012
B,5,10.81
</pre></div>
</div>
<p>We can use the <code class="docutils literal"><span class="pre">csvfile</span></code> plugin to look up the atomic number or atomic of Lithium by its symbol:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;The atomic number of Lithium is {{ lookup(&#39;csvfile&#39;, &#39;Li file=elements.csv delimiter=,&#39;) }}&quot;</span>
- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;The atomic mass of Lithium is {{ lookup(&#39;csvfile&#39;, &#39;Li file=elements.csv delimiter=, col=2&#39;) }}&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">csvfile</span></code> lookup supports several arguments. The format for passing
arguments is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>lookup<span class="o">(</span><span class="s1">&#39;csvfile&#39;</span>, <span class="s1">&#39;key arg1=val1 arg2=val2 ...&#39;</span><span class="o">)</span>
</pre></div>
</div>
<p>The first value in the argument is the <code class="docutils literal"><span class="pre">key</span></code>, which must be an entry that
appears exactly once in column 0 (the first column, 0-indexed) of the table. All other arguments are optional.</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="11%" />
<col width="80%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Field</td>
<td>Default</td>
<td>Description</td>
</tr>
<tr class="row-even"><td>file</td>
<td>ansible.csv</td>
<td>Name of the file to load</td>
</tr>
<tr class="row-odd"><td>col</td>
<td>1</td>
<td>The column to output, indexed by 0</td>
</tr>
<tr class="row-even"><td>delimiter</td>
<td>TAB</td>
<td>Delimiter used by CSV file. As a special case, tab can be specified as either TAB or t.</td>
</tr>
<tr class="row-odd"><td>default</td>
<td>empty string</td>
<td>Default return value if the key is not in the csv file</td>
</tr>
<tr class="row-even"><td>encoding</td>
<td>utf-8</td>
<td>Encoding (character set) of the used CSV file (added in version 2.1)</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The default delimiter is TAB, <em>not</em> comma.</p>
</div>
</div>
<div class="section" id="the-ini-file-lookup">
<span id="ini-lookup"></span><h6><a class="toc-backref" href="#id9">The INI File Lookup</a><a class="headerlink" href="#the-ini-file-lookup" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>The <code class="docutils literal"><span class="pre">ini</span></code> lookup reads the contents of a file in INI format (key1=value1).
This plugin retrieve the value on the right side after the equal sign (&#8216;=&#8217;) of
a given section ([section]). You can also read a property file which - in this
case - does not contain section.</p>
<p>Here&#8217;s a simple example of an INI file with user/password configuration:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[production]</span>
<span class="c1"># My production information</span>
<span class="na">user</span><span class="o">=</span><span class="s">robert</span>
<span class="na">pass</span><span class="o">=</span><span class="s">somerandompassword</span>

<span class="k">[integration]</span>
<span class="c1"># My integration information</span>
<span class="na">user</span><span class="o">=</span><span class="s">gertrude</span>
<span class="na">pass</span><span class="o">=</span><span class="s">anotherpassword</span>
</pre></div>
</div>
<p>We can use the <code class="docutils literal"><span class="pre">ini</span></code> plugin to lookup user configuration:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;User in integration is {{ lookup(&#39;ini&#39;, &#39;user section=integration file=users.ini&#39;) }}&quot;</span>
- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;User in production  is {{ lookup(&#39;ini&#39;, &#39;user section=production  file=users.ini&#39;) }}&quot;</span>
</pre></div>
</div>
<p>Another example for this plugin is for looking for a value on java properties.
Here&#8217;s a simple properties we&#8217;ll take as an example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">user.name</span><span class="o">=</span><span class="s">robert</span>
<span class="na">user.pass</span><span class="o">=</span><span class="s">somerandompassword</span>
</pre></div>
</div>
<p>You can retrieve the <code class="docutils literal"><span class="pre">user.name</span></code> field with the following lookup:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;user.name is {{ lookup(&#39;ini&#39;, &#39;user.name type=properties file=user.properties&#39;) }}&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">ini</span></code> lookup supports several arguments like the csv plugin. The format for passing
arguments is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>lookup<span class="o">(</span><span class="s1">&#39;ini&#39;</span>, <span class="s1">&#39;key [type=&lt;properties|ini&gt;] [section=section] [file=file.ini] [re=true] [default=&lt;defaultvalue&gt;]&#39;</span><span class="o">)</span>
</pre></div>
</div>
<p>The first value in the argument is the <code class="docutils literal"><span class="pre">key</span></code>, which must be an entry that
appears exactly once on keys. All other arguments are optional.</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="11%" />
<col width="80%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Field</td>
<td>Default</td>
<td>Description</td>
</tr>
<tr class="row-even"><td>type</td>
<td>ini</td>
<td>Type of the file. Can be ini or properties (for java properties).</td>
</tr>
<tr class="row-odd"><td>file</td>
<td>ansible.ini</td>
<td>Name of the file to load</td>
</tr>
<tr class="row-even"><td>section</td>
<td>global</td>
<td>Default section where to lookup for key.</td>
</tr>
<tr class="row-odd"><td>re</td>
<td>False</td>
<td>The key is a regexp.</td>
</tr>
<tr class="row-even"><td>encoding</td>
<td>utf-8</td>
<td>Text encoding to use.</td>
</tr>
<tr class="row-odd"><td>default</td>
<td>empty string</td>
<td>return value if the key is not in the ini file</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In java properties files, there&#8217;s no need to specify a section.</p>
</div>
</div>
<div class="section" id="the-credstash-lookup">
<span id="credstash-lookup"></span><h6><a class="toc-backref" href="#id10">The Credstash Lookup</a><a class="headerlink" href="#the-credstash-lookup" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>Credstash is a small utility for managing secrets using AWS&#8217;s KMS and DynamoDB: <a class="reference external" href="https://github.com/fugue/credstash">https://github.com/fugue/credstash</a></p>
<p>First, you need to store your secrets with credstash:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">credstash put my-github-password secure123</span>

<span class="gp">#</span> my-github-password has been stored
</pre></div>
</div>
<p>Example usage:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: <span class="s2">&quot;Test credstash lookup plugin -- get my github password&quot;</span>
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Credstash lookup! {{ lookup(&#39;credstash&#39;, &#39;my-github-password&#39;) }}&quot;</span>
</pre></div>
</div>
<p>You can specify regions or tables to fetch secrets from:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: <span class="s2">&quot;Test credstash lookup plugin -- get my other password from us-west-1&quot;</span>
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Credstash lookup! {{ lookup(&#39;credstash&#39;, &#39;my-other-password&#39;, region=&#39;us-west-1&#39;) }}&quot;</span>


- name: <span class="s2">&quot;Test credstash lookup plugin -- get the company&#39;s github password&quot;</span>
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Credstash lookup! {{ lookup(&#39;credstash&#39;, &#39;company-github-password&#39;, table=&#39;company-passwords&#39;) }}&quot;</span>
</pre></div>
</div>
<p>If you use the context feature when putting your secret, you can get it by passing a dictionary to the context option like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: <span class="nb">test</span>
  hosts: localhost
  vars:
    context:
      app: my_app
      environment: production
  tasks:

  - name: <span class="s2">&quot;Test credstash lookup plugin -- get the password with a context passed as a variable&quot;</span>
    debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;credstash&#39;, &#39;some-password&#39;, context=context) }}&quot;</span>

  - name: <span class="s2">&quot;Test credstash lookup plugin -- get the password with a context defined here&quot;</span>
    debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;credstash&#39;, &#39;some-password&#39;, context=dict(app=&#39;my_app&#39;, environment=&#39;production&#39;)) }}&quot;</span>
</pre></div>
</div>
<p>If you&#8217;re not using 2.0 yet, you can do something similar with the credstash tool and the pipe lookup (see below):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Poor man&#39;s credstash lookup! {{ lookup(&#39;pipe&#39;, &#39;credstash -r us-west-1 get my-other-password&#39;) }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="the-dns-lookup-dig">
<span id="dns-lookup"></span><h6><a class="toc-backref" href="#id11">The DNS Lookup (dig)</a><a class="headerlink" href="#the-dns-lookup-dig" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.0.</span></p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This lookup depends on the <a class="reference external" href="http://www.dnspython.org/">dnspython</a>
library.</p>
</div>
<p>The <code class="docutils literal"><span class="pre">dig</span></code> lookup runs queries against DNS servers to retrieve DNS records for
a specific name (<em>FQDN</em> - fully qualified domain name). It is possible to lookup any DNS record in this manner.</p>
<p>There is a couple of different syntaxes that can be used to specify what record
should be retrieved, and for which name. It is also possible to explicitly
specify the DNS server(s) to use for lookups.</p>
<p>In its simplest form, the <code class="docutils literal"><span class="pre">dig</span></code> lookup plugin can be used to retrieve an IPv4
address (DNS <code class="docutils literal"><span class="pre">A</span></code> record) associated with <em>FQDN</em>:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you need to obtain the <code class="docutils literal"><span class="pre">AAAA</span></code> record (IPv6 address), you must
specify the record type explicitly. Syntax for specifying the record
type is described below.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The trailing dot in most of the examples listed is purely optional,
but is specified for completeness/correctness sake.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;The IPv4 address for example.com. is {{ lookup(&#39;dig&#39;, &#39;example.com.&#39;)}}&quot;</span>
</pre></div>
</div>
<p>In addition to (default) <code class="docutils literal"><span class="pre">A</span></code> record, it is also possible to specify a different
record type that should be queried. This can be done by either passing-in
additional parameter of format <code class="docutils literal"><span class="pre">qtype=TYPE</span></code> to the <code class="docutils literal"><span class="pre">dig</span></code> lookup, or by
appending <code class="docutils literal"><span class="pre">/TYPE</span></code> to the <em>FQDN</em> being queried. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;The TXT record for example.org. is {{ lookup(&#39;dig&#39;, &#39;example.org.&#39;, &#39;qtype=TXT&#39;) }}&quot;</span>
- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;The TXT record for example.org. is {{ lookup(&#39;dig&#39;, &#39;example.org./TXT&#39;) }}&quot;</span>
</pre></div>
</div>
<p>If multiple values are associated with the requested record, the results will be
returned as a comma-separated list. In such cases you may want to pass option
<code class="docutils literal"><span class="pre">wantlist=True</span></code> to the plugin, which will result in the record values being
returned as a list over which you can iterate later on:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;One of the MX records for gmail.com. is {{ item }}&quot;</span>
  with_items: <span class="s2">&quot;{{ lookup(&#39;dig&#39;, &#39;gmail.com./MX&#39;, wantlist=True) }}&quot;</span>
</pre></div>
</div>
<p>In case of reverse DNS lookups (<code class="docutils literal"><span class="pre">PTR</span></code> records), you can also use a convenience
syntax of format <code class="docutils literal"><span class="pre">IP_ADDRESS/PTR</span></code>. The following three lines would produce the
same output:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Reverse DNS for 192.0.2.5 is {{ lookup(&#39;dig&#39;, &#39;192.0.2.5/PTR&#39;) }}&quot;</span>
- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Reverse DNS for 192.0.2.5 is {{ lookup(&#39;dig&#39;, &#39;5.2.0.192.in-addr.arpa./PTR&#39;) }}&quot;</span>
- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Reverse DNS for 192.0.2.5 is {{ lookup(&#39;dig&#39;, &#39;5.2.0.192.in-addr.arpa.&#39;, &#39;qtype=PTR&#39;) }}&quot;</span>
</pre></div>
</div>
<p>By default, the lookup will rely on system-wide configured DNS servers for
performing the query. It is also possible to explicitly specify DNS servers to
query using the <code class="docutils literal"><span class="pre">&#64;DNS_SERVER_1,DNS_SERVER_2,...,DNS_SERVER_N</span></code> notation. This
needs to be passed-in as an additional parameter to the lookup. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Querying 198.51.100.23 for IPv4 address for example.com. produces {{ lookup(&#39;dig&#39;, &#39;example.com&#39;, &#39;@198.51.100.23&#39;) }}&quot;</span>
</pre></div>
</div>
<p>In some cases the DNS records may hold a more complex data structure, or it may
be useful to obtain the results in a form of a dictionary for future
processing. The <code class="docutils literal"><span class="pre">dig</span></code> lookup supports parsing of a number of such records,
with the result being returned as a dictionary. This way it is possible to
easily access such nested data. This return format can be requested by
passing-in the <code class="docutils literal"><span class="pre">flat=0</span></code> option to the lookup. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;XMPP service for gmail.com. is available at {{ item.target }} on port {{ item.port }}&quot;</span>
  with_items: <span class="s2">&quot;{{ lookup(&#39;dig&#39;, &#39;_xmpp-server._tcp.gmail.com./SRV&#39;, &#39;flat=0&#39;, wantlist=True) }}&quot;</span>
</pre></div>
</div>
<p>Take note that due to the way Ansible lookups work, you must pass the
<code class="docutils literal"><span class="pre">wantlist=True</span></code> argument to the lookup, otherwise Ansible will report errors.</p>
<p>Currently the dictionary results are supported for the following records:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><em>ALL</em> is not a record per-se, merely the listed fields are available
for any record results you retrieve in the form of a dictionary.</p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Record</td>
<td>Fields</td>
</tr>
<tr class="row-even"><td><em>ALL</em></td>
<td>owner, ttl, type</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>address</td>
</tr>
<tr class="row-even"><td>AAAA</td>
<td>address</td>
</tr>
<tr class="row-odd"><td>CNAME</td>
<td>target</td>
</tr>
<tr class="row-even"><td>DNAME</td>
<td>target</td>
</tr>
<tr class="row-odd"><td>DLV</td>
<td>algorithm, digest_type, key_tag, digest</td>
</tr>
<tr class="row-even"><td>DNSKEY</td>
<td>flags, algorithm, protocol, key</td>
</tr>
<tr class="row-odd"><td>DS</td>
<td>algorithm, digest_type, key_tag, digest</td>
</tr>
<tr class="row-even"><td>HINFO</td>
<td>cpu, os</td>
</tr>
<tr class="row-odd"><td>LOC</td>
<td>latitude, longitude, altitude, size, horizontal_precision, vertical_precision</td>
</tr>
<tr class="row-even"><td>MX</td>
<td>preference, exchange</td>
</tr>
<tr class="row-odd"><td>NAPTR</td>
<td>order, preference, flags, service, regexp, replacement</td>
</tr>
<tr class="row-even"><td>NS</td>
<td>target</td>
</tr>
<tr class="row-odd"><td>NSEC3PARAM</td>
<td>algorithm, flags, iterations, salt</td>
</tr>
<tr class="row-even"><td>PTR</td>
<td>target</td>
</tr>
<tr class="row-odd"><td>RP</td>
<td>mbox, txt</td>
</tr>
<tr class="row-even"><td>SOA</td>
<td>mname, rname, serial, refresh, retry, expire, minimum</td>
</tr>
<tr class="row-odd"><td>SPF</td>
<td>strings</td>
</tr>
<tr class="row-even"><td>SRV</td>
<td>priority, weight, port, target</td>
</tr>
<tr class="row-odd"><td>SSHFP</td>
<td>algorithm, fp_type, fingerprint</td>
</tr>
<tr class="row-even"><td>TLSA</td>
<td>usage, selector, mtype, cert</td>
</tr>
<tr class="row-odd"><td>TXT</td>
<td>strings</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="mongodb-lookup">
<span id="id1"></span><h6><a class="toc-backref" href="#id12">MongoDB Lookup</a><a class="headerlink" href="#mongodb-lookup" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This lookup depends on the <a class="reference external" href="http://www.mongodb.org/">pymongo 2.4+</a>
library.</p>
</div>
<p>The <code class="docutils literal"><span class="pre">MongoDB</span></code> lookup runs the <em>find()</em> command on a given <em>collection</em> on a given <em>MongoDB</em> server.</p>
<p>The result is a list of jsons, so slightly different from what PyMongo returns. In particular, <em>timestamps</em> are converted to epoch integers.</p>
<p>Currently, the following parameters are supported.</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="3%" />
<col width="3%" />
<col width="8%" />
<col width="76%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Parameter</td>
<td>Mandatory</td>
<td>Type</td>
<td>Default Value</td>
<td>Comment</td>
</tr>
<tr class="row-even"><td>connection_string</td>
<td>no</td>
<td>string</td>
<td>mongodb://localhost/</td>
<td>Can be any valid MongoDB connection string, supporting authentication, replicasets, etc. More info at <a class="reference external" href="https://docs.mongodb.org/manual/reference/connection-string/">https://docs.mongodb.org/manual/reference/connection-string/</a></td>
</tr>
<tr class="row-odd"><td>extra_connection_parameters</td>
<td>no</td>
<td>dict</td>
<td>{}</td>
<td>Dictionary with extra parameters like ssl, ssl_keyfile, maxPoolSize etc... Check the full list here: <a class="reference external" href="https://api.mongodb.org/python/current/api/pymongo/mongo_client.html#pymongo.mongo_client.MongoClient">https://api.mongodb.org/python/current/api/pymongo/mongo_client.html#pymongo.mongo_client.MongoClient</a></td>
</tr>
<tr class="row-even"><td>database</td>
<td>yes</td>
<td>string</td>
<td>&#160;</td>
<td>Name of the database which the query will be made</td>
</tr>
<tr class="row-odd"><td>collection</td>
<td>yes</td>
<td>string</td>
<td>&#160;</td>
<td>Name of the collection which the query will be made</td>
</tr>
<tr class="row-even"><td>filter</td>
<td>no</td>
<td>dict</td>
<td>[pymongo default]</td>
<td>Criteria of the output Example: { &#8220;hostname&#8221;: &#8220;batman&#8221; }</td>
</tr>
<tr class="row-odd"><td>projection</td>
<td>no</td>
<td>dict</td>
<td>[pymongo default]</td>
<td>Fields you want returned. Example: { &#8220;pid&#8221;: True    , &#8220;_id&#8221; : False , &#8220;hostname&#8221; : True }</td>
</tr>
<tr class="row-even"><td>skip</td>
<td>no</td>
<td>integer</td>
<td>[pymongo default]</td>
<td>How many results should be skept</td>
</tr>
<tr class="row-odd"><td>limit</td>
<td>no</td>
<td>integer</td>
<td>[pymongo default]</td>
<td>How many results should be shown</td>
</tr>
<tr class="row-even"><td>sort</td>
<td>no</td>
<td>list</td>
<td>[pymongo default]</td>
<td>Sorting rules. Please notice the constats are replaced by strings. [ [ &#8220;startTime&#8221; , &#8220;ASCENDING&#8221; ] , [ &#8220;age&#8221;, &#8220;DESCENDING&#8221; ] ]</td>
</tr>
<tr class="row-odd"><td>[any find() parameter]</td>
<td>no</td>
<td>[any]</td>
<td>[pymongo default]</td>
<td>Every parameter with exception to <em>connection_string</em>, <em>database</em> and <em>collection</em> are passed to pymongo directly.</td>
</tr>
</tbody>
</table>
<p>Please check <a class="reference external" href="https://api.mongodb.org/python/current/api/pymongo/collection.html?highlight=find#pymongo.collection.Collection.find">https://api.mongodb.org/python/current/api/pymongo/collection.html?highlight=find#pymongo.collection.Collection.find</a> for more detais.</p>
<p>Since there are too many parameters for this lookup method, below is a sample playbook which shows its usage and a nice way to feed the parameters:</p>
<div class="highlight-YAML+Jinja"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

  <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">mongodb_parameters</span><span class="p p-Indicator">:</span>
      <span class="c1">#optional parameter, default = &quot;mongodb://localhost/&quot;</span>
      <span class="c1"># connection_string: &quot;mongodb://localhost/&quot;</span>
      <span class="c1"># extra_connection_parameters: { &quot;ssl&quot; : True , &quot;ssl_certfile&quot;: /etc/self_signed_certificate.pem&quot; }</span>

      <span class="c1">#mandatory parameters</span>
      <span class="l l-Scalar l-Scalar-Plain">database</span><span class="p p-Indicator">:</span> <span class="s">&#39;local&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">collection</span><span class="p p-Indicator">:</span> <span class="s">&quot;startup_log&quot;</span>

      <span class="c1">#optional query  parameters</span>
      <span class="c1">#we accept any parameter from the normal mongodb query.</span>
      <span class="c1"># the official documentation is here</span>
      <span class="c1"># https://api.mongodb.org/python/current/api/pymongo/collection.html?highlight=find#pymongo.collection.Collection.find</span>
      <span class="c1"># filter:  { &quot;hostname&quot;: &quot;batman&quot; }</span>
      <span class="l l-Scalar l-Scalar-Plain">projection</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span> <span class="s">&quot;pid&quot;</span><span class="p p-Indicator">:</span> <span class="nv">True</span>    <span class="p p-Indicator">,</span> <span class="s">&quot;_id&quot;</span> <span class="p p-Indicator">:</span> <span class="nv">False</span> <span class="p p-Indicator">,</span> <span class="s">&quot;hostname&quot;</span> <span class="p p-Indicator">:</span> <span class="nv">True</span> <span class="p p-Indicator">}</span>
      <span class="c1"># skip: 0</span>
      <span class="l l-Scalar l-Scalar-Plain">limit</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="c1"># sort:  [ [ &quot;startTime&quot; , &quot;ASCENDING&quot; ] , [ &quot;age&quot;, &quot;DESCENDING&quot; ] ]</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;Mongo has already started with the following PID [</span><span class="cp">{{</span> <span class="nv">item.pid</span> <span class="cp">}}</span><span class="l l-Scalar l-Scalar-Plain">]&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">with_mongodb</span><span class="p p-Indicator">:</span> <span class="s">&quot;</span><span class="cp">{{</span><span class="nv">mongodb_parameters</span><span class="cp">}}</span><span class="s">&quot;</span>
</pre></div>
</div>
<p>Sample output:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">mdiez@batman:~/ansible$</span> ansible-playbook m.yml -i localhost.ini

<span class="go">PLAY [all] *********************************************************************</span>

<span class="go">TASK [debug] *******************************************************************</span>
<span class="go">Sunday 20 March 2016  22:40:39 +0200 (0:00:00.023)       0:00:00.023 **********</span>
<span class="go">ok: [localhost] =&gt; (item={u&#39;hostname&#39;: u&#39;batman&#39;, u&#39;pid&#39;: 60639L}) =&gt; {</span>
<span class="go">    &quot;item&quot;: {</span>
<span class="go">        &quot;hostname&quot;: &quot;batman&quot;,</span>
<span class="go">        &quot;pid&quot;: 60639</span>
<span class="go">    },</span>
<span class="go">    &quot;msg&quot;: &quot;Mongo has already started with the following PID [60639]&quot;</span>
<span class="go">}</span>

<span class="go">PLAY RECAP *********************************************************************</span>
<span class="go">localhost                  : ok=1    changed=0    unreachable=0    failed=0</span>

<span class="go">Sunday 20 March 2016  22:40:39 +0200 (0:00:00.067)       0:00:00.091 **********</span>
<span class="go">===============================================================================</span>
<span class="go">debug ------------------------------------------------------------------- 0.07s</span>
<span class="gp">mdiez@batman:~/ansible$</span>
</pre></div>
</div>
</div>
<div class="section" id="more-lookups">
<span id="id2"></span><h6><a class="toc-backref" href="#id13">More Lookups</a><a class="headerlink" href="#more-lookups" title="Permalink to this headline">¶</a></h6>
<p>Various <em>lookup plugins</em> allow additional ways to iterate over data.  In <a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a> you will learn
how to use them to walk over collections of numerous types.  However, they can also be used to pull in data
from remote sources, such as shell commands or even key value stores. This section will cover lookup plugins in this capacity.</p>
<p>Here are some examples:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all

  tasks:

     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;env&#39;,&#39;HOME&#39;) }} is an environment variable&quot;</span>

     - name: lines will iterate over each line from stdout of a <span class="nb">command</span>
       debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ item }} is a line from the result of this command&quot;</span>
       with_lines: cat /etc/motd

     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;pipe&#39;,&#39;date&#39;) }} is the raw result of running this command&quot;</span>

     - name: Always use quote filter to make sure your variables are safe to use with shell
       debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;pipe&#39;,&#39;getent &#39; + myuser|quote ) }}&quot;</span>

     - name: Quote variables with_lines also as it executes shell
       debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ item }} is a line from myfile&quot;</span>
       with_lines: <span class="s2">&quot;cat {{myfile|quote}}&quot;</span>

     - name: redis_kv lookup requires the Python redis package
       debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;redis_kv&#39;, &#39;redis://localhost:6379,somekey&#39;) }} is value in Redis for somekey&quot;</span>

     - name: dnstxt lookup requires the Python dnspython package
       debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;dnstxt&#39;, &#39;example.com&#39;) }} is a DNS TXT record for example.com&quot;</span>

     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;template&#39;, &#39;./some_template.j2&#39;) }} is a value from evaluation of this template&quot;</span>

     <span class="c1"># Since 2.4, you can pass in variables during evaluation</span>
     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;template&#39;, &#39;./some_template.j2&#39;, template_vars=dict(x=42)) }} is evaluated with x=42&quot;</span>

     - name: loading a json file from a template as a string
       debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;template&#39;, &#39;./some_json.json.j2&#39;, convert_data=False) }} is a value from evaluation of this template&quot;</span>


     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;etcd&#39;, &#39;foo&#39;) }} is a value from a locally running etcd&quot;</span>

     <span class="c1"># shelvefile lookup retrieves a string value corresponding to a key inside a Python shelve file</span>
     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ lookup(&#39;shelvefile&#39;, &#39;file=path_to_some_shelve_file.db key=key_to_retrieve&#39;) }}</span>

<span class="s2">     # The following lookups were added in 1.9</span>
<span class="s2">     # url lookup splits lines by default, an option to disable this was added in 2.4</span>
<span class="s2">     - debug: msg=&quot;</span><span class="o">{{</span>item<span class="o">}}</span><span class="s2">&quot;</span>
<span class="s2">       with_url:</span>
<span class="s2">            - &#39;https://github.com/gremlin.keys&#39;</span>

<span class="s2">     # outputs the cartesian product of the supplied lists</span>
<span class="s2">     - debug: msg=&quot;</span><span class="o">{{</span>item<span class="o">}}</span><span class="s2">&quot;</span>
<span class="s2">       with_cartesian:</span>
<span class="s2">            - &quot;</span><span class="o">{{</span>list1<span class="o">}}</span><span class="s2">&quot;</span>
<span class="s2">            - &quot;</span><span class="o">{{</span>list2<span class="o">}}</span><span class="s2">&quot;</span>
<span class="s2">            - [1,2,3,4,5,6]</span>

<span class="s2">     - name: Added in 2.3 allows using the system&#39;s keyring</span>
<span class="s2">       debug: msg={{lookup(&#39;keyring&#39;,&#39;myservice myuser&#39;)}}</span>
</pre></div>
</div>
<p>As an alternative, you can also assign lookup plugins to variables or use them elsewhere.
These macros are evaluated each time they are used in a task (or template):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars:
  motd_value: <span class="s2">&quot;{{ lookup(&#39;file&#39;, &#39;/etc/motd&#39;) }}&quot;</span>

tasks:

  - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;motd value is {{ motd_value }}&quot;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Looping in playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_python_version"></span><div class="section" id="python-version-and-templating">
<span id="pb-py-compat"></span><h5>Python Version and Templating<a class="headerlink" href="#python-version-and-templating" title="Permalink to this headline">¶</a></h5>
<p>Jinja2 templates leverage Python data types and standard functions.  This
makes for a rich set of operations that can be performed on data.  However,
this also means that certain specifics of the underlying Python becomes
visible to template authors.  Since Ansible playbooks use Jinja2 for templates
and variables, this means that playbook authors need to be aware of these
specifics as well.</p>
<p>Unless otherwise noted, these differences are only of interest when running
Ansible in Python2 versus Python3.  Changes within Python2 and Python3 are
generally small enough that they are not visible at the jinja2 level.</p>
<div class="section" id="dictionary-views">
<span id="pb-py-compat-dict-views"></span><h6>Dictionary Views<a class="headerlink" href="#dictionary-views" title="Permalink to this headline">¶</a></h6>
<p>In Python2, the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.keys" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.keys()</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.values" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.values()</span></code></a>, and <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.items" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.items()</span></code></a>
methods returns a list.  Jinja2 returns that to Ansible via a string
representation that Ansible can turn back into a list.  In Python3, those
methods return a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict-views" title="(in Python v3.6)"><span class="xref std std-ref">dictionary view</span></a> object.  The
string representation that Jinja2 returns for dictionary views cannot be parsed back
into a list by Ansible.  It is, however, easy to make this portable by
using the <a class="reference external" href="http://jinja.pocoo.org/docs/templates/#list" title="(in Jinja2 v2.10-dev)"><code class="xref py py-func docutils literal"><span class="pre">list</span></code></a> filter whenever using <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.keys" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.keys()</span></code></a>,
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.values" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.values()</span></code></a>, or <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.items" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.items()</span></code></a>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars:
  hosts:
    testhost1: <span class="m">127</span>.0.0.2
    testhost2: <span class="m">127</span>.0.0.3
tasks:
  - debug:
      msg: <span class="s1">&#39;{{ item }}&#39;</span>
    <span class="c1"># Only works with Python 2</span>
    <span class="c1">#with_items: &quot;{{ hosts.keys() }}&quot;</span>
    <span class="c1"># Works with both Python 2 and Python 3</span>
    with_items: <span class="s2">&quot;{{ hosts.keys() | list }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="dict-iteritems">
<span id="pb-py-compat-iteritems"></span><h6>dict.iteritems()<a class="headerlink" href="#dict-iteritems" title="Permalink to this headline">¶</a></h6>
<p>In Python2, dictionaries have <a class="reference external" href="https://docs.python.org/2/library/stdtypes.html#dict.iterkeys" title="(in Python v2.7)"><code class="xref py py-meth docutils literal"><span class="pre">iterkeys()</span></code></a>,
<a class="reference external" href="https://docs.python.org/2/library/stdtypes.html#dict.itervalues" title="(in Python v2.7)"><code class="xref py py-meth docutils literal"><span class="pre">itervalues()</span></code></a>, and <a class="reference external" href="https://docs.python.org/2/library/stdtypes.html#dict.iteritems" title="(in Python v2.7)"><code class="xref py py-meth docutils literal"><span class="pre">iteritems()</span></code></a> methods.  These methods
have been removed in Python3.  Playbooks and Jinja2 templates should use
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.keys" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.keys()</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.values" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.values()</span></code></a>, and <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.items" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">dict.items()</span></code></a> in order to be
compatible with both Python2 and Python3:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars:
  hosts:
    testhost1: <span class="m">127</span>.0.0.2
    testhost2: <span class="m">127</span>.0.0.3
tasks:
  - debug:
      msg: <span class="s1">&#39;{{ item }}&#39;</span>
    <span class="c1"># Only works with Python 2</span>
    <span class="c1">#with_items: &quot;{{ hosts.iteritems() }}&quot;</span>
    <span class="c1"># Works with both Python 2 and Python 3</span>
    with_items: <span class="s2">&quot;{{ hosts.items() | list }}&quot;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li>The <a class="reference internal" href="#pb-py-compat-dict-views"><span class="std std-ref">Dictionary Views</span></a> entry for information on
why the <a class="reference external" href="http://jinja.pocoo.org/docs/templates/#list" title="(in Jinja2 v2.10-dev)"><code class="xref py py-func docutils literal"><span class="pre">list</span> <span class="pre">filter</span></code></a> is necessary
here.</li>
</ul>
</div>
</div>
</div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a></dt>
<dd>Looping in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-playbooks_conditionals"></span><div class="section" id="conditionals">
<h4><a class="toc-backref" href="#id5">Conditionals</a><a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#conditionals" id="id5">Conditionals</a><ul>
<li><a class="reference internal" href="#the-when-statement" id="id6">The When Statement</a></li>
<li><a class="reference internal" href="#loops-and-conditionals" id="id7">Loops and Conditionals</a></li>
<li><a class="reference internal" href="#loading-in-custom-facts" id="id8">Loading in Custom Facts</a></li>
<li><a class="reference internal" href="#applying-when-to-roles-imports-and-includes" id="id9">Applying &#8216;when&#8217; to roles, imports, and includes</a></li>
<li><a class="reference internal" href="#conditional-imports" id="id10">Conditional Imports</a></li>
<li><a class="reference internal" href="#selecting-files-and-templates-based-on-variables" id="id11">Selecting Files And Templates Based On Variables</a></li>
<li><a class="reference internal" href="#register-variables" id="id12">Register Variables</a></li>
</ul>
</li>
</ul>
</div>
<p>Often the result of a play may depend on the value of a variable, fact (something learned about the remote system), or previous task result.
In some cases, the values of variables may depend on other variables.
Further, additional groups can be created to manage hosts based on whether the hosts match other criteria.
There are many options to control execution flow in Ansible.
More examples of supported conditionals can be located here: <a class="reference external" href="http://jinja.pocoo.org/docs/dev/templates/#comparisons">http://jinja.pocoo.org/docs/dev/templates/#comparisons</a></p>
<p>Let&#8217;s dig into what they are.</p>
<div class="section" id="the-when-statement">
<span id="id1"></span><h5><a class="toc-backref" href="#id6">The When Statement</a><a class="headerlink" href="#the-when-statement" title="Permalink to this headline">¶</a></h5>
<p>Sometimes you will want to skip a particular step on a particular host.
This could be something as simple as not installing a certain package if the operating system is a particular version,
or it could be something like performing some cleanup steps if a filesystem is getting full.</p>
<p>This is easy to do in Ansible with the <cite>when</cite> clause, which contains a raw Jinja2 expression without double curly braces (see <a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a>).
It&#8217;s actually pretty simple:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: <span class="s2">&quot;shut down Debian flavored systems&quot;</span>
    command: /sbin/shutdown -t now
    when: <span class="nv">ansible_os_family</span> <span class="o">==</span> <span class="s2">&quot;Debian&quot;</span>
    <span class="c1"># note that Ansible facts and vars like ansible_os_family can be used</span>
    <span class="c1"># directly in conditionals without double curly braces</span>
</pre></div>
</div>
<p>You can also use parentheses to group conditions:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: <span class="s2">&quot;shut down CentOS 6 and Debian 7 systems&quot;</span>
    command: /sbin/shutdown -t now
    when: <span class="o">(</span><span class="nv">ansible_distribution</span> <span class="o">==</span> <span class="s2">&quot;CentOS&quot;</span> and <span class="nv">ansible_distribution_major_version</span> <span class="o">==</span> <span class="s2">&quot;6&quot;</span><span class="o">)</span> or
          <span class="o">(</span><span class="nv">ansible_distribution</span> <span class="o">==</span> <span class="s2">&quot;Debian&quot;</span> and <span class="nv">ansible_distribution_major_version</span> <span class="o">==</span> <span class="s2">&quot;7&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Multiple conditions that all need to be true (a logical &#8216;and&#8217;) can also be specified as a list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: <span class="s2">&quot;shut down CentOS 6 systems&quot;</span>
    command: /sbin/shutdown -t now
    when:
      - <span class="nv">ansible_distribution</span> <span class="o">==</span> <span class="s2">&quot;CentOS&quot;</span>
      - <span class="nv">ansible_distribution_major_version</span> <span class="o">==</span> <span class="s2">&quot;6&quot;</span>
</pre></div>
</div>
<p>A number of Jinja2 &#8220;filters&#8221; can also be used in when statements, some of which are unique
and provided by Ansible.  Suppose we want to ignore the error of one statement and then
decide to do something conditionally based on success or failure:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - command: /bin/false
    register: result
    ignore_errors: True

  - command: /bin/something
    when: result<span class="p">|</span>failed

  <span class="c1"># In older versions of ansible use |success, now both are valid but succeeded uses the correct tense.</span>
  - command: /bin/something_else
    when: result<span class="p">|</span>succeeded

  - command: /bin/still/something_else
    when: result<span class="p">|</span>skipped
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the filters have been updated in 2.1 so both <cite>success</cite> and <cite>succeeded</cite> work (<cite>fail</cite>/<cite>failed</cite>, etc).</p>
</div>
<p>Note that was a little bit of foreshadowing on the &#8216;register&#8217; statement.  We&#8217;ll get to it a bit later in this chapter.</p>
<p>As a reminder, to see what facts are available on a particular system, you can do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible hostname.example.com -m setup
</pre></div>
</div>
<p>Tip: Sometimes you&#8217;ll get back a variable that&#8217;s a string and you&#8217;ll want to do a math operation comparison on it.  You can do this like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - shell: <span class="nb">echo</span> <span class="s2">&quot;only on Red Hat 6, derivatives, and later&quot;</span>
    when: <span class="nv">ansible_os_family</span> <span class="o">==</span> <span class="s2">&quot;RedHat&quot;</span> and ansible_lsb.major_release<span class="p">|</span>int &gt;<span class="o">=</span> <span class="m">6</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the above example requires the lsb_release package on the target host in order to return the ansible_lsb.major_release fact.</p>
</div>
<p>Variables defined in the playbooks or inventory can also be used.  An example may be the execution of a task based on a variable&#8217;s boolean value:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars:
  epic: <span class="nb">true</span>
</pre></div>
</div>
<p>Then a conditional execution might look like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
    - shell: <span class="nb">echo</span> <span class="s2">&quot;This certainly is epic!&quot;</span>
      when: epic
</pre></div>
</div>
<p>or:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
    - shell: <span class="nb">echo</span> <span class="s2">&quot;This certainly isn&#39;t epic!&quot;</span>
      when: not epic
</pre></div>
</div>
<p>If a required variable has not been set, you can skip or fail using Jinja2&#8217;s <cite>defined</cite> test. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
    - shell: <span class="nb">echo</span> <span class="s2">&quot;I&#39;ve got &#39;{{ foo }}&#39; and am not afraid to use it!&quot;</span>
      when: foo is defined

    - fail: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Bailing out. this play requires &#39;bar&#39;&quot;</span>
      when: bar is undefined
</pre></div>
</div>
<p>This is especially useful in combination with the conditional import of vars files (see below).
As the examples show, you don&#8217;t need to use <cite>{{ }}</cite> to use variables inside conditionals, as these are already implied.</p>
</div>
<div class="section" id="loops-and-conditionals">
<span id="id2"></span><h5><a class="toc-backref" href="#id7">Loops and Conditionals</a><a class="headerlink" href="#loops-and-conditionals" title="Permalink to this headline">¶</a></h5>
<p>Combining <cite>when</cite> with <cite>with_items</cite> (see <a class="reference internal" href="index.html#document-playbooks_loops"><span class="doc">Loops</span></a>), be aware that the <cite>when</cite> statement is processed separately for each item. This is by design:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
    - command: <span class="nb">echo</span> <span class="o">{{</span> item <span class="o">}}</span>
      with_items: <span class="o">[</span> <span class="m">0</span>, <span class="m">2</span>, <span class="m">4</span>, <span class="m">6</span>, <span class="m">8</span>, <span class="m">10</span> <span class="o">]</span>
      when: item &gt; <span class="m">5</span>
</pre></div>
</div>
<p>If you need to skip the whole task depending on the loop variable being defined, used the <cite>|default</cite> filter to provide an empty iterator:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- command: <span class="nb">echo</span> <span class="o">{{</span> item <span class="o">}}</span>
  with_items: <span class="s2">&quot;{{ mylist|default([]) }}&quot;</span>
  when: item &gt; <span class="m">5</span>
</pre></div>
</div>
<p>If using <cite>with_dict</cite> which does not take a list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- command: <span class="nb">echo</span> <span class="o">{{</span> item.key <span class="o">}}</span>
  with_dict: <span class="s2">&quot;{{ mydict|default({}) }}&quot;</span>
  when: item.value &gt; <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="section" id="loading-in-custom-facts">
<span id="id3"></span><h5><a class="toc-backref" href="#id8">Loading in Custom Facts</a><a class="headerlink" href="#loading-in-custom-facts" title="Permalink to this headline">¶</a></h5>
<p>It&#8217;s also easy to provide your own facts if you want, which is covered in <a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a>.  To run them, just
make a call to your own custom fact gathering module at the top of your list of tasks, and variables returned
there will be accessible to future tasks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
    - name: gather site specific fact data
      action: site_facts
    - command: /usr/bin/thingy
      when: <span class="nv">my_custom_fact_just_retrieved_from_the_remote_system</span> <span class="o">==</span> <span class="s1">&#39;1234&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="applying-when-to-roles-imports-and-includes">
<span id="when-roles-and-includes"></span><h5><a class="toc-backref" href="#id9">Applying &#8216;when&#8217; to roles, imports, and includes</a><a class="headerlink" href="#applying-when-to-roles-imports-and-includes" title="Permalink to this headline">¶</a></h5>
<p>Note that if you have several tasks that all share the same conditional statement, you can affix the conditional
to a task include statement as below.  All the tasks get evaluated, but the conditional is applied to each and every task:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- import_tasks: tasks/sometasks.yml
  when: <span class="s2">&quot;&#39;reticulating splines&#39; in output&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In versions prior to 2.0 this worked with task includes but not playbook includes.  2.0 allows it to work with both.</p>
</div>
<p>Or with a role:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: webservers
  roles:
     - <span class="o">{</span> role: debian_stock_config, when: <span class="nv">ansible_os_family</span> <span class="o">==</span> <span class="s1">&#39;Debian&#39;</span> <span class="o">}</span>
</pre></div>
</div>
<p>You will note a lot of &#8216;skipped&#8217; output by default in Ansible when using this approach on systems that don&#8217;t match the criteria.
Read up on the &#8216;group_by&#8217; module in the <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> docs for a more streamlined way to accomplish the same thing.</p>
<p>When used with <cite>include_*</cite> tasks instead of imports, the conditional is applied _only_ to the include task itself and not any other
tasks within the included file(s). A common situation where this distinction is important is as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># include a file to define a variable when it is not already defined</span>

<span class="c1"># main.yml</span>
- include_tasks: other_tasks.yml
  when: x is not defined

<span class="c1"># other_tasks.yml</span>
- set_fact:
    x: foo
- debug:
    var: x
</pre></div>
</div>
<p>In the above example, if <code class="docutils literal"><span class="pre">import_tasks</span></code> had been used instead both included tasks would have also been skipped. With <code class="docutils literal"><span class="pre">include_tasks</span></code>
instead, the tasks are executed as expected because the conditional is not applied to them.</p>
</div>
<div class="section" id="conditional-imports">
<span id="id4"></span><h5><a class="toc-backref" href="#id10">Conditional Imports</a><a class="headerlink" href="#conditional-imports" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is an advanced topic that is infrequently used.  You can probably skip this section.</p>
</div>
<p>Sometimes you will want to do certain things differently in a playbook based on certain criteria.
Having one playbook that works on multiple platforms and OS versions is a good example.</p>
<p>As an example, the name of the Apache package may be different between CentOS and Debian,
but it is easily handled with a minimum of syntax in an Ansible Playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all
  remote_user: root
  vars_files:
    - <span class="s2">&quot;vars/common.yml&quot;</span>
    - <span class="o">[</span> <span class="s2">&quot;vars/{{ ansible_os_family }}.yml&quot;</span>, <span class="s2">&quot;vars/os_defaults.yml&quot;</span> <span class="o">]</span>
  tasks:
  - name: make sure apache is started
    service: <span class="nv">name</span><span class="o">={{</span> apache <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>started
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The variable &#8216;ansible_os_family&#8217; is being interpolated into
the list of filenames being defined for vars_files.</p>
</div>
<p>As a reminder, the various YAML files contain just keys and values:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># for vars/CentOS.yml</span>
apache: httpd
somethingelse: <span class="m">42</span>
</pre></div>
</div>
<p>How does this work?  If the operating system was &#8216;CentOS&#8217;, the first file Ansible would try to import
would be &#8216;vars/CentOS.yml&#8217;, followed by &#8216;/vars/os_defaults.yml&#8217; if that file
did not exist.   If no files in the list were found, an error would be raised.
On Debian, it would instead first look towards &#8216;vars/Debian.yml&#8217; instead of &#8216;vars/CentOS.yml&#8217;, before
falling back on &#8216;vars/os_defaults.yml&#8217;. Pretty simple.</p>
<p>To use this conditional import feature, you&#8217;ll need facter or ohai installed prior to running the playbook, but
you can of course push this out with Ansible if you like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># for facter</span>
ansible -m yum -a <span class="s2">&quot;pkg=facter state=present&quot;</span>
ansible -m yum -a <span class="s2">&quot;pkg=ruby-json state=present&quot;</span>

<span class="c1"># for ohai</span>
ansible -m yum -a <span class="s2">&quot;pkg=ohai state=present&quot;</span>
</pre></div>
</div>
<p>Ansible&#8217;s approach to configuration &#8211; separating variables from tasks, keeps your playbooks
from turning into arbitrary code with ugly nested ifs, conditionals, and so on - and results
in more streamlined &amp; auditable configuration rules &#8211; especially because there are a
minimum of decision points to track.</p>
</div>
<div class="section" id="selecting-files-and-templates-based-on-variables">
<h5><a class="toc-backref" href="#id11">Selecting Files And Templates Based On Variables</a><a class="headerlink" href="#selecting-files-and-templates-based-on-variables" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is an advanced topic that is infrequently used.  You can probably skip this section.</p>
</div>
<p>Sometimes a configuration file you want to copy, or a template you will use may depend on a variable.
The following construct selects the first available file appropriate for the variables of a given host, which is often much cleaner than putting a lot of if conditionals in a template.</p>
<p>The following example shows how to template out a configuration file that was very different between, say, CentOS and Debian:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: template a file
  template: <span class="nv">src</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">dest</span><span class="o">=</span>/etc/myapp/foo.conf
  with_first_found:
    - files:
       - <span class="o">{{</span> ansible_distribution <span class="o">}}</span>.conf
       - default.conf
      paths:
       - search_location_one/somedir/
       - /opt/other_location/somedir/
</pre></div>
</div>
</div>
<div class="section" id="register-variables">
<h5><a class="toc-backref" href="#id12">Register Variables</a><a class="headerlink" href="#register-variables" title="Permalink to this headline">¶</a></h5>
<p>Often in a playbook it may be useful to store the result of a given command in a variable and access
it later.  Use of the command module in this way can in many ways eliminate the need to write site specific facts, for
instance, you could test for the existence of a particular program.</p>
<p>The &#8216;register&#8217; keyword decides what variable to save a result in.  The resulting variables can be used in templates, action lines, or <em>when</em> statements.  It looks like this (in an obviously trivial example):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> play
  hosts: all

  tasks:

      - shell: cat /etc/motd
        register: motd_contents

      - shell: <span class="nb">echo</span> <span class="s2">&quot;motd contains the word hi&quot;</span>
        when: motd_contents.stdout.find<span class="o">(</span><span class="s1">&#39;hi&#39;</span><span class="o">)</span> !<span class="o">=</span> -1
</pre></div>
</div>
<p>As shown previously, the registered variable&#8217;s string contents are accessible with the &#8216;stdout&#8217; value.
The registered result can be used in the &#8220;with_items&#8221; of a task if it is converted into
a list (or already is a list) as shown below.  &#8220;stdout_lines&#8221; is already available on the object as
well though you could also call &#8220;home_dirs.stdout.split()&#8221; if you wanted, and could split by other
fields:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: registered variable usage as a with_items list
  hosts: all

  tasks:

      - name: retrieve the list of home directories
        command: ls /home
        register: home_dirs

      - name: add home <span class="nb">dirs</span> to the backup spooler
        file: <span class="nv">path</span><span class="o">=</span>/mnt/bkspool/<span class="o">{{</span> item <span class="o">}}</span> <span class="nv">src</span><span class="o">=</span>/home/<span class="o">{{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>link
        with_items: <span class="s2">&quot;{{ home_dirs.stdout_lines }}&quot;</span>
        <span class="c1"># same as with_items: &quot;{{ home_dirs.stdout.split() }}&quot;</span>
</pre></div>
</div>
<p>As shown previously, the registered variable&#8217;s string contents are accessible with the &#8216;stdout&#8217; value.
You may check the registered variable&#8217;s string contents for emptiness:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: check registered variable <span class="k">for</span> emptiness
  hosts: all

  tasks:

      - name: list contents of directory
        command: ls mydir
        register: contents

      - name: check contents <span class="k">for</span> emptiness
        debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Directory is empty&quot;</span>
        when: contents.stdout <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_loops"></span><div class="section" id="loops">
<h4><a class="toc-backref" href="#id12">Loops</a><a class="headerlink" href="#loops" title="Permalink to this headline">¶</a></h4>
<p>Often you&#8217;ll want to do many things in one task, such as create a lot of users, install a lot of packages, or
repeat a polling step until a certain result is reached.</p>
<p>This chapter is all about how to use loops in playbooks.</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#loops" id="id12">Loops</a><ul>
<li><a class="reference internal" href="#standard-loops" id="id13">Standard Loops</a></li>
<li><a class="reference internal" href="#nested-loops" id="id14">Nested Loops</a></li>
<li><a class="reference internal" href="#looping-over-hashes" id="id15">Looping over Hashes</a></li>
<li><a class="reference internal" href="#looping-over-files" id="id16">Looping over Files</a></li>
<li><a class="reference internal" href="#id4" id="id17">Looping over Fileglobs</a></li>
<li><a class="reference internal" href="#looping-over-filetrees" id="id18">Looping over Filetrees</a></li>
<li><a class="reference internal" href="#looping-over-parallel-sets-of-data" id="id19">Looping over Parallel Sets of Data</a></li>
<li><a class="reference internal" href="#looping-over-subelements" id="id20">Looping over Subelements</a></li>
<li><a class="reference internal" href="#looping-over-integer-sequences" id="id21">Looping over Integer Sequences</a></li>
<li><a class="reference internal" href="#random-choices" id="id22">Random Choices</a></li>
<li><a class="reference internal" href="#do-until-loops" id="id23">Do-Until Loops</a></li>
<li><a class="reference internal" href="#finding-first-matched-files" id="id24">Finding First Matched Files</a></li>
<li><a class="reference internal" href="#iterating-over-the-results-of-a-program-execution" id="id25">Iterating Over The Results of a Program Execution</a></li>
<li><a class="reference internal" href="#looping-over-a-list-with-an-index" id="id26">Looping Over A List With An Index</a></li>
<li><a class="reference internal" href="#using-ini-file-with-a-loop" id="id27">Using ini file with a loop</a></li>
<li><a class="reference internal" href="#flattening-a-list" id="id28">Flattening A List</a></li>
<li><a class="reference internal" href="#using-register-with-a-loop" id="id29">Using register with a loop</a></li>
<li><a class="reference internal" href="#looping-over-the-inventory" id="id30">Looping over the inventory</a></li>
<li><a class="reference internal" href="#loop-control" id="id31">Loop Control</a></li>
<li><a class="reference internal" href="#loops-and-includes-in-2-0" id="id32">Loops and Includes in 2.0</a></li>
<li><a class="reference internal" href="#writing-your-own-iterators" id="id33">Writing Your Own Iterators</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="standard-loops">
<span id="id1"></span><h5><a class="toc-backref" href="#id13">Standard Loops</a><a class="headerlink" href="#standard-loops" title="Permalink to this headline">¶</a></h5>
<p>To save some typing, repeated tasks can be written in short-hand like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: add several users
  user:
    name: <span class="s2">&quot;{{ item }}&quot;</span>
    state: present
    groups: <span class="s2">&quot;wheel&quot;</span>
  with_items:
     - testuser1
     - testuser2
</pre></div>
</div>
<p>If you have defined a YAML list in a variables file, or the &#8216;vars&#8217; section, you can also do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>with_items: <span class="s2">&quot;{{ somelist }}&quot;</span>
</pre></div>
</div>
<p>The above would be the equivalent of:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: add user testuser1
  user:
    name: <span class="s2">&quot;testuser1&quot;</span>
    state: present
    groups: <span class="s2">&quot;wheel&quot;</span>
- name: add user testuser2
  user:
    name: <span class="s2">&quot;testuser2&quot;</span>
    state: present
    groups: <span class="s2">&quot;wheel&quot;</span>
</pre></div>
</div>
<p>The yum and apt modules use with_items to execute fewer package manager transactions.</p>
<p>Note that the types of items you iterate over with &#8216;with_items&#8217; do not have to be simple lists of strings.
If you have a list of hashes, you can reference subkeys using things like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: add several users
  user:
    name: <span class="s2">&quot;{{ item.name }}&quot;</span>
    state: present
    groups: <span class="s2">&quot;{{ item.groups }}&quot;</span>
  with_items:
    - <span class="o">{</span> name: <span class="s1">&#39;testuser1&#39;</span>, groups: <span class="s1">&#39;wheel&#39;</span> <span class="o">}</span>
    - <span class="o">{</span> name: <span class="s1">&#39;testuser2&#39;</span>, groups: <span class="s1">&#39;root&#39;</span> <span class="o">}</span>
</pre></div>
</div>
<p>Also be aware that when combining <cite>when</cite> with <cite>with_items</cite> (or any other loop statement), the <cite>when</cite> statement is processed separately for each item. See <a class="reference internal" href="index.html#the-when-statement"><span class="std std-ref">The When Statement</span></a> for an example.</p>
<p>Loops are actually a combination of things <cite>with_</cite> + <cite>lookup()</cite>, so any lookup plugin can be used as a source for a loop, &#8216;items&#8217; is lookup.</p>
<p>Please note that <code class="docutils literal"><span class="pre">with_items</span></code> flattens the first depth of the list it is
provided and can yield unexpected results if you pass a list which is composed
of lists. You can work around this by wrapping your nested list inside a list:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># This will run debug three times since the list is flattened</span>
- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  vars:
    nested_list:
      - - one
        - two
        - three
  with_items: <span class="s2">&quot;{{ nested_list }}&quot;</span>

<span class="c1"># This will run debug once with the three items</span>
- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  vars:
    nested_list:
      - - one
        - two
        - three
  with_items:
    - <span class="s2">&quot;{{ nested_list }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="nested-loops">
<span id="id2"></span><h5><a class="toc-backref" href="#id14">Nested Loops</a><a class="headerlink" href="#nested-loops" title="Permalink to this headline">¶</a></h5>
<p>Loops can be nested as well:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: give users access to multiple databases
  mysql_user:
    name: <span class="s2">&quot;{{ item[0] }}&quot;</span>
    priv: <span class="s2">&quot;{{ item[1] }}.*:ALL&quot;</span>
    append_privs: yes
    password: <span class="s2">&quot;foo&quot;</span>
  with_nested:
    - <span class="o">[</span> <span class="s1">&#39;alice&#39;</span>, <span class="s1">&#39;bob&#39;</span> <span class="o">]</span>
    - <span class="o">[</span> <span class="s1">&#39;clientdb&#39;</span>, <span class="s1">&#39;employeedb&#39;</span>, <span class="s1">&#39;providerdb&#39;</span> <span class="o">]</span>
</pre></div>
</div>
<p>As with the case of &#8216;with_items&#8217; above, you can use previously defined variables.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: here, <span class="s1">&#39;users&#39;</span> contains the above list of employees
  mysql_user:
    name: <span class="s2">&quot;{{ item[0] }}&quot;</span>
    priv: <span class="s2">&quot;{{ item[1] }}.*:ALL&quot;</span>
    append_privs: yes
    password: <span class="s2">&quot;foo&quot;</span>
  with_nested:
    - <span class="s2">&quot;{{ users }}&quot;</span>
    - <span class="o">[</span> <span class="s1">&#39;clientdb&#39;</span>, <span class="s1">&#39;employeedb&#39;</span>, <span class="s1">&#39;providerdb&#39;</span> <span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="looping-over-hashes">
<span id="id3"></span><h5><a class="toc-backref" href="#id15">Looping over Hashes</a><a class="headerlink" href="#looping-over-hashes" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.5.</span></p>
</div>
<p>Suppose you have the following variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
users:
  alice:
    name: Alice Appleworth
    telephone: <span class="m">123</span>-456-7890
  bob:
    name: Bob Bananarama
    telephone: <span class="m">987</span>-654-3210
</pre></div>
</div>
<p>And you want to print every user&#8217;s name and phone number.  You can loop through the elements of a hash using <code class="docutils literal"><span class="pre">with_dict</span></code> like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
  - name: Print phone records
    debug:
      msg: <span class="s2">&quot;User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})&quot;</span>
    with_dict: <span class="s2">&quot;{{ users }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="looping-over-files">
<span id="looping-over-fileglobs"></span><h5><a class="toc-backref" href="#id16">Looping over Files</a><a class="headerlink" href="#looping-over-files" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">with_file</span></code> iterates over the content of a list of files, <cite>item</cite> will be set to the content of each file in sequence.  It can be used like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all

  tasks:

    <span class="c1"># emit a debug message containing the content of each file.</span>
    - debug:
        msg: <span class="s2">&quot;{{ item }}&quot;</span>
      with_file:
        - first_example_file
        - second_example_file
</pre></div>
</div>
<p>Assuming that <code class="docutils literal"><span class="pre">first_example_file</span></code> contained the text &#8220;hello&#8221; and <code class="docutils literal"><span class="pre">second_example_file</span></code> contained the text &#8220;world&#8221;, this would result in:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">TASK [debug msg={{ item }}] ******************************************************</span>
<span class="go">ok: [localhost] =&gt; (item=hello) =&gt; {</span>
<span class="go">    &quot;item&quot;: &quot;hello&quot;,</span>
<span class="go">    &quot;msg&quot;: &quot;hello&quot;</span>
<span class="go">}</span>
<span class="go">ok: [localhost] =&gt; (item=world) =&gt; {</span>
<span class="go">    &quot;item&quot;: &quot;world&quot;,</span>
<span class="go">    &quot;msg&quot;: &quot;world&quot;</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h5><a class="toc-backref" href="#id17">Looping over Fileglobs</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">with_fileglob</span></code> matches all files in a single directory, non-recursively, that match a pattern. It calls
<a class="reference external" href="https://docs.python.org/2/library/glob.html">Python&#8217;s glob library</a>, and can be used like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all

  tasks:

    <span class="c1"># first ensure our target directory exists</span>
    - name: Ensure target directory exists
      file:
        dest: <span class="s2">&quot;/etc/fooapp&quot;</span>
        state: directory

    <span class="c1"># copy each file over that matches the given pattern</span>
    - name: Copy each file over that matches the given pattern
      copy:
        src: <span class="s2">&quot;{{ item }}&quot;</span>
        dest: <span class="s2">&quot;/etc/fooapp/&quot;</span>
        owner: <span class="s2">&quot;root&quot;</span>
        mode: <span class="m">0600</span>
      with_fileglob:
        - <span class="s2">&quot;/playbooks/files/fooapp/*&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using a relative path with <code class="docutils literal"><span class="pre">with_fileglob</span></code> in a role, Ansible resolves the path relative to the <cite>roles/&lt;rolename&gt;/files</cite> directory.</p>
</div>
</div>
<div class="section" id="looping-over-filetrees">
<h5><a class="toc-backref" href="#id18">Looping over Filetrees</a><a class="headerlink" href="#looping-over-filetrees" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">with_filetree</span></code> recursively matches all files in a directory tree, enabling you to template a complete tree of files on a target system while retaining permissions and ownership.</p>
<p>The <code class="docutils literal"><span class="pre">filetree</span></code> lookup-plugin supports directories, files and symlinks, including SELinux and other file properties. Here is a complete list of what each file object consists of:</p>
<ul class="simple">
<li>src</li>
<li>root</li>
<li>path</li>
<li>mode</li>
<li>state</li>
<li>owner</li>
<li>group</li>
<li>seuser</li>
<li>serole</li>
<li>setype</li>
<li>selevel</li>
<li>uid</li>
<li>gid</li>
<li>size</li>
<li>mtime</li>
<li>ctime</li>
</ul>
<p>If you provide more than one path, it will implement a <code class="docutils literal"><span class="pre">with_first_found</span></code> logic, and will not process entries it already processed in previous paths. This enables the user to merge different trees in order of importance, or add role_vars specific paths to influence different instances of the same role.</p>
<p>Here is an example of how we use with_filetree within a role. The <code class="docutils literal"><span class="pre">web/</span></code> path is relative to either <code class="docutils literal"><span class="pre">roles/&lt;role&gt;/files/</span></code> or <code class="docutils literal"><span class="pre">files/</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: Create directories
  file:
    path: /web/<span class="o">{{</span> item.path <span class="o">}}</span>
    state: directory
    mode: <span class="s1">&#39;{{ item.mode }}&#39;</span>
  with_filetree: web/
  when: item.state <span class="o">==</span> <span class="s1">&#39;directory&#39;</span>

- name: Template files
  template:
    src: <span class="s1">&#39;{{ item.src }}&#39;</span>
    dest: /web/<span class="o">{{</span> item.path <span class="o">}}</span>
    mode: <span class="s1">&#39;{{ item.mode }}&#39;</span>
  with_filetree: web/
  when: item.state <span class="o">==</span> <span class="s1">&#39;file&#39;</span>

- name: Recreate symlinks
  file:
    src: <span class="s1">&#39;{{ item.src }}&#39;</span>
    dest: /web/<span class="o">{{</span> item.path <span class="o">}}</span>
    state: link
    force: yes
    mode: <span class="s1">&#39;{{ item.mode }}&#39;</span>
  with_filetree: web/
  when: item.state <span class="o">==</span> <span class="s1">&#39;link&#39;</span>
</pre></div>
</div>
<p>The following properties are also available:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">root</span></code>: allows filtering by original location</li>
<li><code class="docutils literal"><span class="pre">path</span></code>: contains the relative path to root</li>
<li><code class="docutils literal"><span class="pre">uidi</span></code>, <code class="docutils literal"><span class="pre">gid</span></code>: force-create by exact id, rather than by name</li>
<li><code class="docutils literal"><span class="pre">size</span></code>, <code class="docutils literal"><span class="pre">mtime</span></code>, <code class="docutils literal"><span class="pre">ctime</span></code>: filter out files by size, mtime or ctime</li>
</ul>
</div>
<div class="section" id="looping-over-parallel-sets-of-data">
<h5><a class="toc-backref" href="#id19">Looping over Parallel Sets of Data</a><a class="headerlink" href="#looping-over-parallel-sets-of-data" title="Permalink to this headline">¶</a></h5>
<p>Suppose you have the following variable data:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
alpha: <span class="o">[</span> <span class="s1">&#39;a&#39;</span>, <span class="s1">&#39;b&#39;</span>, <span class="s1">&#39;c&#39;</span>, <span class="s1">&#39;d&#39;</span> <span class="o">]</span>
numbers:  <span class="o">[</span> <span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span> <span class="o">]</span>
</pre></div>
</div>
<p>...and you want the set of &#8216;(a, 1)&#8217; and &#8216;(b, 2)&#8217;.   Use &#8216;with_together&#8217; to get this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:
    - debug:
        msg: <span class="s2">&quot;{{ item.0 }} and {{ item.1 }}&quot;</span>
      with_together:
        - <span class="s2">&quot;{{ alpha }}&quot;</span>
        - <span class="s2">&quot;{{ numbers }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="looping-over-subelements">
<h5><a class="toc-backref" href="#id20">Looping over Subelements</a><a class="headerlink" href="#looping-over-subelements" title="Permalink to this headline">¶</a></h5>
<p>Suppose you want to do something like loop over a list of users, creating them, and allowing them to login by a certain set of
SSH keys.</p>
<p>In this example, we&#8217;ll assume you have the following defined and loaded in via &#8220;vars_files&#8221; or maybe a &#8220;group_vars/all&#8221; file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
users:
  - name: alice
    authorized:
      - /tmp/alice/onekey.pub
      - /tmp/alice/twokey.pub
    mysql:
        password: mysql-password
        hosts:
          - <span class="s2">&quot;%&quot;</span>
          - <span class="s2">&quot;127.0.0.1&quot;</span>
          - <span class="s2">&quot;::1&quot;</span>
          - <span class="s2">&quot;localhost&quot;</span>
        privs:
          - <span class="s2">&quot;*.*:SELECT&quot;</span>
          - <span class="s2">&quot;DB1.*:ALL&quot;</span>
  - name: bob
    authorized:
      - /tmp/bob/id_rsa.pub
    mysql:
        password: other-mysql-password
        hosts:
          - <span class="s2">&quot;db1&quot;</span>
        privs:
          - <span class="s2">&quot;*.*:SELECT&quot;</span>
          - <span class="s2">&quot;DB2.*:ALL&quot;</span>
</pre></div>
</div>
<p>You could loop over these subelements like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Create User
  user:
    name: <span class="s2">&quot;{{ item.name }}&quot;</span>
    state: present
    generate_ssh_key: yes
  with_items:
    - <span class="s2">&quot;{{ users }}&quot;</span>

- name: Set authorized ssh key
  authorized_key:
    user: <span class="s2">&quot;{{ item.0.name }}&quot;</span>
    key: <span class="s2">&quot;{{ lookup(&#39;file&#39;, item.1) }}&quot;</span>
  with_subelements:
     - <span class="s2">&quot;{{ users }}&quot;</span>
     - authorized
</pre></div>
</div>
<p>Given the mysql hosts and privs subkey lists, you can also iterate over a list in a nested subkey:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Setup MySQL users
  mysql_user:
    name: <span class="s2">&quot;{{ item.0.name }}&quot;</span>
    password: <span class="s2">&quot;{{ item.0.mysql.password }}&quot;</span>
    host: <span class="s2">&quot;{{ item.1 }}&quot;</span>
    priv: <span class="s2">&quot;{{ item.0.mysql.privs | join(&#39;/&#39;) }}&quot;</span>
  with_subelements:
    - <span class="s2">&quot;{{ users }}&quot;</span>
    - mysql.hosts
</pre></div>
</div>
<p>Subelements walks a list of hashes (aka dictionaries) and then traverses a list with a given (nested sub-)key inside of those
records.</p>
<p>Optionally,  you can add a third element to the subelements list, that holds a
dictionary of flags. Currently you can add the &#8216;skip_missing&#8217; flag. If set to
True, the lookup plugin will skip the lists items that do not contain the given
subkey. Without this flag, or if that flag is set to False, the plugin will
yield an error and complain about the missing subkey.</p>
<p>The authorized_key pattern is exactly where it comes up most.</p>
</div>
<div class="section" id="looping-over-integer-sequences">
<span id="id5"></span><h5><a class="toc-backref" href="#id21">Looping over Integer Sequences</a><a class="headerlink" href="#looping-over-integer-sequences" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">with_sequence</span></code> generates a sequence of items. You
can specify a start value, an end value, an optional &#8220;stride&#8221; value that specifies the number of steps to increment the sequence, and an optional printf-style format string.</p>
<p>Arguments should be specified as key=value pair strings.</p>
<p>A simple shortcut form of the arguments string is also accepted: <code class="docutils literal"><span class="pre">[start-]end[/stride][:format]</span></code>.</p>
<p>Numerical values can be specified in decimal, hexadecimal (0x3f8) or octal (0600).
Negative numbers are not supported.  This works as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all

  tasks:

    <span class="c1"># create groups</span>
    - group:
        name: <span class="s2">&quot;evens&quot;</span>
        state: present
    - group:
        name: <span class="s2">&quot;odds&quot;</span>
        state: present

    <span class="c1"># create some test users</span>
    - user:
        name: <span class="s2">&quot;{{ item }}&quot;</span>
        state: present
        groups: <span class="s2">&quot;evens&quot;</span>
      with_sequence: <span class="nv">start</span><span class="o">=</span><span class="m">0</span> <span class="nv">end</span><span class="o">=</span><span class="m">32</span> <span class="nv">format</span><span class="o">=</span>testuser%02x

    <span class="c1"># create a series of directories with even numbers for some reason</span>
    - file:
        dest: <span class="s2">&quot;/var/stuff/{{ item }}&quot;</span>
        state: directory
      with_sequence: <span class="nv">start</span><span class="o">=</span><span class="m">4</span> <span class="nv">end</span><span class="o">=</span><span class="m">16</span> <span class="nv">stride</span><span class="o">=</span><span class="m">2</span>

    <span class="c1"># a simpler way to use the sequence plugin</span>
    <span class="c1"># create 4 groups</span>
    - group:
        name: <span class="s2">&quot;group{{ item }}&quot;</span>
        state: present
      with_sequence: <span class="nv">count</span><span class="o">=</span><span class="m">4</span>
</pre></div>
</div>
</div>
<div class="section" id="random-choices">
<span id="random-choice"></span><h5><a class="toc-backref" href="#id22">Random Choices</a><a class="headerlink" href="#random-choices" title="Permalink to this headline">¶</a></h5>
<p>The &#8216;random_choice&#8217; feature can be used to pick something at random.  While it&#8217;s not a load balancer (there are modules
for those), it can somewhat be used as a poor man&#8217;s load balancer in a MacGyver like situation:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  with_random_choice:
     - <span class="s2">&quot;go through the door&quot;</span>
     - <span class="s2">&quot;drink from the goblet&quot;</span>
     - <span class="s2">&quot;press the red button&quot;</span>
     - <span class="s2">&quot;do nothing&quot;</span>
</pre></div>
</div>
<p>One of the provided strings will be selected at random.</p>
<p>At a more basic level, they can be used to add chaos and excitement to otherwise predictable automation environments.</p>
</div>
<div class="section" id="do-until-loops">
<span id="id6"></span><h5><a class="toc-backref" href="#id23">Do-Until Loops</a><a class="headerlink" href="#do-until-loops" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>Sometimes you would want to retry a task until a certain condition is met.  Here&#8217;s an example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- shell: /usr/bin/foo
  register: result
  <span class="k">until</span>: result.stdout.find<span class="o">(</span><span class="s2">&quot;all systems go&quot;</span><span class="o">)</span> !<span class="o">=</span> -1
  retries: <span class="m">5</span>
  delay: <span class="m">10</span>
</pre></div>
</div>
<p>The above example run the shell module recursively till the module&#8217;s result has &#8220;all systems go&#8221; in its stdout or the task has
been retried for 5 times with a delay of 10 seconds. The default value for &#8220;retries&#8221; is 3 and &#8220;delay&#8221; is 5.</p>
<p>The task returns the results returned by the last task run. The results of individual retries can be viewed by -vv option.
The registered variable will also have a new key &#8220;attempts&#8221; which will have the number of the retries for the task.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the &#8220;until&#8221; parameter isn&#8217;t defined, the value for the &#8220;retries&#8221; parameter is forced to 1.</p>
</div>
</div>
<div class="section" id="finding-first-matched-files">
<span id="with-first-found"></span><h5><a class="toc-backref" href="#id24">Finding First Matched Files</a><a class="headerlink" href="#finding-first-matched-files" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is an uncommon thing to want to do, but we&#8217;re documenting it for completeness.  You probably won&#8217;t be reaching for this one often.</p>
</div>
<p>This isn&#8217;t exactly a loop, but it&#8217;s close.  What if you want to use a reference to a file based on the first file found
that matches a given criteria, and some of the filenames are determined by variable names?  Yes, you can do that as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: INTERFACES <span class="p">|</span> Create Ansible header <span class="k">for</span> /etc/network/interfaces
  template:
    src: <span class="s2">&quot;{{ item }}&quot;</span>
    dest: <span class="s2">&quot;/etc/foo.conf&quot;</span>
  with_first_found:
    - <span class="s2">&quot;{{ ansible_virtualization_type }}_foo.conf&quot;</span>
    - <span class="s2">&quot;default_foo.conf&quot;</span>
</pre></div>
</div>
<p>This tool also has a long form version that allows for configurable search paths.  Here&#8217;s an example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: some configuration template
  template:
    src: <span class="s2">&quot;{{ item }}&quot;</span>
    dest: <span class="s2">&quot;/etc/file.cfg&quot;</span>
    mode: <span class="m">0444</span>
    owner: <span class="s2">&quot;root&quot;</span>
    group: <span class="s2">&quot;root&quot;</span>
  with_first_found:
    - files:
       - <span class="s2">&quot;{{ inventory_hostname }}/etc/file.cfg&quot;</span>
      paths:
       - ../../../templates.overwrites
       - ../../../templates
    - files:
        - etc/file.cfg
      paths:
        - templates
</pre></div>
</div>
</div>
<div class="section" id="iterating-over-the-results-of-a-program-execution">
<span id="looping-over-the-results-of-a-program-execution"></span><h5><a class="toc-backref" href="#id25">Iterating Over The Results of a Program Execution</a><a class="headerlink" href="#iterating-over-the-results-of-a-program-execution" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is an uncommon thing to want to do, but we&#8217;re documenting it for completeness.  You probably won&#8217;t be reaching for this one often.</p>
</div>
<p>Sometimes you might want to execute a program, and based on the output of that program, loop over the results of that line by line.
Ansible provides a neat way to do that, though you should remember, this is always executed on the control machine, not the remote
machine:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Example of looping over a <span class="nb">command</span> result
  shell: <span class="s2">&quot;/usr/bin/frobnicate {{ item }}&quot;</span>
  with_lines:
    - <span class="s2">&quot;/usr/bin/frobnications_per_host --param {{ inventory_hostname }}&quot;</span>
</pre></div>
</div>
<p>Ok, that was a bit arbitrary.  In fact, if you&#8217;re doing something that is inventory related you might just want to write a dynamic
inventory source instead (see <a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a>), but this can be occasionally useful in quick-and-dirty implementations.</p>
<p>Should you ever need to execute a command remotely, you would not use the above method.  Instead do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Example of looping over a REMOTE <span class="nb">command</span> result
  shell: <span class="s2">&quot;/usr/bin/something&quot;</span>
  register: command_result

- name: Do something with each result
  shell: <span class="s2">&quot;/usr/bin/something_else --param {{ item }}&quot;</span>
  with_items:
    - <span class="s2">&quot;{{ command_result.stdout_lines }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="looping-over-a-list-with-an-index">
<span id="indexed-lists"></span><h5><a class="toc-backref" href="#id26">Looping Over A List With An Index</a><a class="headerlink" href="#looping-over-a-list-with-an-index" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is an uncommon thing to want to do, but we&#8217;re documenting it for completeness.  You probably won&#8217;t be reaching for this one often.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>If you want to loop over an array and also get the numeric index of where you are in the array as you go, you can also do that.
It&#8217;s uncommonly used:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: indexed loop demo
  debug:
    msg: <span class="s2">&quot;at array position {{ item.0 }} there is a value {{ item.1 }}&quot;</span>
  with_indexed_items:
    - <span class="s2">&quot;{{ some_list }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-ini-file-with-a-loop">
<span id="using-ini-with-a-loop"></span><h5><a class="toc-backref" href="#id27">Using ini file with a loop</a><a class="headerlink" href="#using-ini-file-with-a-loop" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>The ini plugin can use regexp to retrieve a set of keys. As a consequence, we can loop over this set. Here is the ini file we&#8217;ll use:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[section1]</span>
<span class="na">value1</span><span class="o">=</span><span class="s">section1/value1</span>
<span class="na">value2</span><span class="o">=</span><span class="s">section1/value2</span>

<span class="k">[section2]</span>
<span class="na">value1</span><span class="o">=</span><span class="s">section2/value1</span>
<span class="na">value2</span><span class="o">=</span><span class="s">section2/value2</span>
</pre></div>
</div>
<p>Here is an example of using <code class="docutils literal"><span class="pre">with_ini</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  with_ini:
    - value<span class="o">[</span><span class="m">1</span>-2<span class="o">]</span>
    - section: section1
    - file: <span class="s2">&quot;lookup.ini&quot;</span>
    - re: <span class="nb">true</span>
</pre></div>
</div>
<p>And here is the returned value:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>
      <span class="s2">&quot;changed&quot;</span>: false,
      <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;All items completed&quot;</span>,
      <span class="s2">&quot;results&quot;</span>: <span class="o">[</span>
          <span class="o">{</span>
              <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                  <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;msg=\&quot;section1/value1\&quot;&quot;</span>,
                  <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;debug&quot;</span>
              <span class="o">}</span>,
              <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;section1/value1&quot;</span>,
              <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;section1/value1&quot;</span>,
              <span class="s2">&quot;verbose_always&quot;</span>: <span class="nb">true</span>
          <span class="o">}</span>,
          <span class="o">{</span>
              <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                  <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;msg=\&quot;section1/value2\&quot;&quot;</span>,
                  <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;debug&quot;</span>
              <span class="o">}</span>,
              <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;section1/value2&quot;</span>,
              <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;section1/value2&quot;</span>,
              <span class="s2">&quot;verbose_always&quot;</span>: <span class="nb">true</span>
          <span class="o">}</span>
      <span class="o">]</span>
  <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="flattening-a-list">
<span id="id7"></span><h5><a class="toc-backref" href="#id28">Flattening A List</a><a class="headerlink" href="#flattening-a-list" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is an uncommon thing to want to do, but we&#8217;re documenting it for completeness.  You probably won&#8217;t be reaching for this one often.</p>
</div>
<p>In rare instances you might have several lists of lists, and you just want to iterate over every item in all of those lists.  Assume
a really crazy hypothetical datastructure:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>----
<span class="c1"># file: roles/foo/vars/main.yml</span>
packages_base:
  - <span class="o">[</span> <span class="s1">&#39;foo-package&#39;</span>, <span class="s1">&#39;bar-package&#39;</span> <span class="o">]</span>
packages_apps:
  - <span class="o">[</span> <span class="o">[</span><span class="s1">&#39;one-package&#39;</span>, <span class="s1">&#39;two-package&#39;</span> <span class="o">]]</span>
  - <span class="o">[</span> <span class="o">[</span><span class="s1">&#39;red-package&#39;</span><span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;blue-package&#39;</span><span class="o">]]</span>
</pre></div>
</div>
<p>As you can see the formatting of packages in these lists is all over the place.  How can we install all of the packages in both lists?:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: flattened loop demo
  yum:
    name: <span class="s2">&quot;{{ item }}&quot;</span>
    state: present
  with_flattened:
     - <span class="s2">&quot;{{ packages_base }}&quot;</span>
     - <span class="s2">&quot;{{ packages_apps }}&quot;</span>
</pre></div>
</div>
<p>That&#8217;s how!</p>
</div>
<div class="section" id="using-register-with-a-loop">
<span id="id8"></span><h5><a class="toc-backref" href="#id29">Using register with a loop</a><a class="headerlink" href="#using-register-with-a-loop" title="Permalink to this headline">¶</a></h5>
<p>After using <code class="docutils literal"><span class="pre">register</span></code> with a loop, the data structure placed in the variable will contain a <code class="docutils literal"><span class="pre">results</span></code> attribute that is a list of all responses from the module.</p>
<p>Here is an example of using <code class="docutils literal"><span class="pre">register</span></code> with <code class="docutils literal"><span class="pre">with_items</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- shell: <span class="s2">&quot;echo {{ item }}&quot;</span>
  with_items:
    - <span class="s2">&quot;one&quot;</span>
    - <span class="s2">&quot;two&quot;</span>
  register: <span class="nb">echo</span>
</pre></div>
</div>
<p>This differs from the data structure returned when using <code class="docutils literal"><span class="pre">register</span></code> without a loop:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;changed&quot;</span>: true,
    <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;All items completed&quot;</span>,
    <span class="s2">&quot;results&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;changed&quot;</span>: true,
            <span class="s2">&quot;cmd&quot;</span>: <span class="s2">&quot;echo \&quot;one\&quot; &quot;</span>,
            <span class="s2">&quot;delta&quot;</span>: <span class="s2">&quot;0:00:00.003110&quot;</span>,
            <span class="s2">&quot;end&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.187153&quot;</span>,
            <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;echo \&quot;one\&quot;&quot;</span>,
                <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;shell&quot;</span>
            <span class="o">}</span>,
            <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;one&quot;</span>,
            <span class="s2">&quot;rc&quot;</span>: <span class="m">0</span>,
            <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.184043&quot;</span>,
            <span class="s2">&quot;stderr&quot;</span>: <span class="s2">&quot;&quot;</span>,
            <span class="s2">&quot;stdout&quot;</span>: <span class="s2">&quot;one&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;changed&quot;</span>: true,
            <span class="s2">&quot;cmd&quot;</span>: <span class="s2">&quot;echo \&quot;two\&quot; &quot;</span>,
            <span class="s2">&quot;delta&quot;</span>: <span class="s2">&quot;0:00:00.002920&quot;</span>,
            <span class="s2">&quot;end&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.245502&quot;</span>,
            <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;echo \&quot;two\&quot;&quot;</span>,
                <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;shell&quot;</span>
            <span class="o">}</span>,
            <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;two&quot;</span>,
            <span class="s2">&quot;rc&quot;</span>: <span class="m">0</span>,
            <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.242582&quot;</span>,
            <span class="s2">&quot;stderr&quot;</span>: <span class="s2">&quot;&quot;</span>,
            <span class="s2">&quot;stdout&quot;</span>: <span class="s2">&quot;two&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Subsequent loops over the registered variable to inspect the results may look like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Fail <span class="k">if</span> <span class="k">return</span> code is not <span class="m">0</span>
  fail:
    msg: <span class="s2">&quot;The command ({{ item.cmd }}) did not have a 0 return code&quot;</span>
  when: item.rc !<span class="o">=</span> <span class="m">0</span>
  with_items: <span class="s2">&quot;{{ echo.results }}&quot;</span>
</pre></div>
</div>
<p>During iteration, the result of the current item will be placed in the variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- shell: <span class="nb">echo</span> <span class="s2">&quot;{{ item }}&quot;</span>
  with_items:
    - one
    - two
  register: <span class="nb">echo</span>
  changed_when: echo.stdout !<span class="o">=</span> <span class="s2">&quot;one&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="looping-over-the-inventory">
<span id="id9"></span><h5><a class="toc-backref" href="#id30">Looping over the inventory</a><a class="headerlink" href="#looping-over-the-inventory" title="Permalink to this headline">¶</a></h5>
<p>If you wish to loop over the inventory, or just a subset of it, there is multiple ways.
One can use a regular <code class="docutils literal"><span class="pre">with_items</span></code> with the <code class="docutils literal"><span class="pre">ansible_play_batch</span></code> or <code class="docutils literal"><span class="pre">groups</span></code> variables, like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># show all the hosts in the inventory</span>
- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items:
    - <span class="s2">&quot;{{ groups[&#39;all&#39;] }}&quot;</span>

<span class="c1"># show all the hosts in the current play</span>
- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items:
    - <span class="s2">&quot;{{ ansible_play_batch }}&quot;</span>
</pre></div>
</div>
<p>There is also a specific lookup plugin <code class="docutils literal"><span class="pre">inventory_hostnames</span></code> that can be used like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># show all the hosts in the inventory</span>
- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  with_inventory_hostnames:
    - all

<span class="c1"># show all the hosts matching the pattern, ie all but the group www</span>
- debug:
    msg: <span class="s2">&quot;{{ item }}&quot;</span>
  with_inventory_hostnames:
    - all:!www
</pre></div>
</div>
<p>More information on the patterns can be found on <a class="reference internal" href="index.html#document-intro_patterns"><span class="doc">Patterns</span></a></p>
</div>
<div class="section" id="loop-control">
<span id="id10"></span><h5><a class="toc-backref" href="#id31">Loop Control</a><a class="headerlink" href="#loop-control" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>In 2.0 you are again able to use <cite>with_</cite> loops and task includes (but not playbook includes). This adds the ability to loop over the set of tasks in one shot.
Ansible by default sets the loop variable <cite>item</cite> for each loop, which causes these nested loops to overwrite the value of <cite>item</cite> from the &#8220;outer&#8221; loops.
As of Ansible 2.1, the <cite>loop_control</cite> option can be used to specify the name of the variable to be used for the loop:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># main.yml</span>
- include_tasks: inner.yml
  with_items:
    - <span class="m">1</span>
    - <span class="m">2</span>
    - <span class="m">3</span>
  loop_control:
    loop_var: outer_item

<span class="c1"># inner.yml</span>
- debug:
    msg: <span class="s2">&quot;outer item={{ outer_item }} inner item={{ item }}&quot;</span>
  with_items:
    - a
    - b
    - c
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If Ansible detects that the current loop is using a variable which has already been defined, it will raise an error to fail the task.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>When using complex data structures for looping the display might get a bit too &#8220;busy&#8221;, this is where the C(label) directive comes to help:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: create servers
  digital_ocean:
    name: <span class="s2">&quot;{{ item.name }}&quot;</span>
    state: present
  with_items:
    - name: server1
      disks: 3gb
      ram: 15Gb
      network:
        nic01: 100Gb
        nic02: 10Gb
        ...
  loop_control:
    label: <span class="s2">&quot;{{item.name}}&quot;</span>
</pre></div>
</div>
<p>This will now display just the &#8216;label&#8217; field instead of the whole structure per &#8216;item&#8217;, it defaults to &#8216;&#8221;{{item}}&#8221;&#8217; to display things as usual.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>Another option to loop control is C(pause), which allows you to control the time (in seconds) between execution of items in a task loop.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># main.yml</span>
- name: create servers, pause 3s before creating next
  digital_ocean:
    name: <span class="s2">&quot;{{ item }}&quot;</span>
    state: present
  with_items:
    - server1
    - server2
  loop_control:
    pause: <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="section" id="loops-and-includes-in-2-0">
<span id="loops-and-includes-2-0"></span><h5><a class="toc-backref" href="#id32">Loops and Includes in 2.0</a><a class="headerlink" href="#loops-and-includes-in-2-0" title="Permalink to this headline">¶</a></h5>
<p>Because <cite>loop_control</cite> is not available in Ansible 2.0, when using an include with a loop you should use <cite>set_fact</cite> to save the &#8220;outer&#8221; loops value
for <cite>item</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># main.yml</span>
- include_tasks: inner.yml
  with_items:
    - <span class="m">1</span>
    - <span class="m">2</span>
    - <span class="m">3</span>

<span class="c1"># inner.yml</span>
- set_fact:
    outer_item: <span class="s2">&quot;{{ item }}&quot;</span>

- debug:
    msg: <span class="s2">&quot;outer item={{ outer_item }} inner item={{ item }}&quot;</span>
  with_items:
    - a
    - b
    - c
</pre></div>
</div>
</div>
<div class="section" id="writing-your-own-iterators">
<span id="id11"></span><h5><a class="toc-backref" href="#id33">Writing Your Own Iterators</a><a class="headerlink" href="#writing-your-own-iterators" title="Permalink to this headline">¶</a></h5>
<p>While you ordinarily shouldn&#8217;t have to, should you wish to write your own ways to loop over arbitrary data structures, you can read <a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a> for some starter
information.  Each of the above features are implemented as plugins in ansible, so there are many implementations to reference.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_blocks"></span><div class="section" id="blocks">
<h4>Blocks<a class="headerlink" href="#blocks" title="Permalink to this headline">¶</a></h4>
<p>In 2.0 we added a block feature to allow for logical grouping of tasks and even
in play error handling. Most of what you can apply to a single task can be applied
at the block level, which also makes it much easier to set data or directives common
to the tasks. This does not mean the directive affects the block itself, but is inherited
by the tasks enclosed by a block. i.e. a <cite>when</cite> will be applied to the tasks, not the block itself.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Block example</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-YAML"><div class="highlight"><pre><span></span>   <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install Apache</span>
<span class="hll">       <span class="l l-Scalar l-Scalar-Plain">block</span><span class="p p-Indicator">:</span>
</span>         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">yum</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name={{ item }} state=installed</span>
           <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
             <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
             <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">memcached</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">src=templates/src.j2 dest=/etc/foo.conf</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=bar state=started enabled=True</span>
       <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ansible_distribution == &#39;CentOS&#39;</span>
       <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
       <span class="l l-Scalar l-Scalar-Plain">become_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
</pre></div>
</div>
</div>
<p>In the example above, each of the 3 tasks will be executed after appending the <cite>when</cite> condition from the block
and evaluating it in the task&#8217;s context. Also they inherit the privilege escalation directives enabling &#8220;become to root&#8221;
for all the enclosed tasks.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3: </span>The <code class="docutils literal"><span class="pre">name:</span></code> keyword for <code class="docutils literal"><span class="pre">blocks:</span></code> was added in Ansible 2.3.</p>
</div>
<div class="section" id="error-handling">
<span id="block-error-handling"></span><h5>Error Handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h5>
<p>Blocks also introduce the ability to handle errors in a way similar to exceptions in most programming languages.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Block error handling example</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-YAML"><div class="highlight"><pre><span></span>  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Attempt and gracefull roll back demo</span>
<span class="hll">     <span class="l l-Scalar l-Scalar-Plain">block</span><span class="p p-Indicator">:</span>
</span>       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&#39;I execute normally&#39;</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&#39;I never execute, due to the above task failing&#39;</span>
<span class="hll">     <span class="l l-Scalar l-Scalar-Plain">rescue</span><span class="p p-Indicator">:</span>
</span>       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&#39;I caught an error&#39;</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&#39;I also never execute :-(&#39;</span>
<span class="hll">     <span class="l l-Scalar l-Scalar-Plain">always</span><span class="p p-Indicator">:</span>
</span>       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;this always executes&quot;</span>
</pre></div>
</div>
</div>
<p>The tasks in the <code class="docutils literal"><span class="pre">block</span></code> would execute normally, if there is any error the <code class="docutils literal"><span class="pre">rescue</span></code> section would get executed
with whatever you need to do to recover from the previous error. The <code class="docutils literal"><span class="pre">always</span></code> section runs no matter what previous
error did or did not occur in the <code class="docutils literal"><span class="pre">block</span></code> and <code class="docutils literal"><span class="pre">rescue</span></code> sections.</p>
<p>Another example is how to run handlers after an error occurred :</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Block run handlers in error handling</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-YAML"><div class="highlight"><pre><span></span> <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Attempt and gracefull roll back demo</span>
     <span class="l l-Scalar l-Scalar-Plain">block</span><span class="p p-Indicator">:</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&#39;I execute normally&#39;</span>
<span class="hll">         <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">run me even after an error</span>
</span>       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
     <span class="l l-Scalar l-Scalar-Plain">rescue</span><span class="p p-Indicator">:</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">make sure all handlers run</span>
<span class="hll">         <span class="l l-Scalar l-Scalar-Plain">meta</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">flush_handlers</span>
</span> <span class=" -Error"> </span><span class="l l-Scalar l-Scalar-Plain">handlers</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">run me even after an error</span>
      <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&#39;this handler runs even on error&#39;</span>
</pre></div>
</div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_strategies"></span><div class="section" id="strategies">
<h4>Strategies<a class="headerlink" href="#strategies" title="Permalink to this headline">¶</a></h4>
<p>In 2.0 we added a new way to control play execution, <code class="docutils literal"><span class="pre">strategy</span></code>, by default plays will
still run as they used to, with what we call the <code class="docutils literal"><span class="pre">linear</span></code> strategy. All hosts will run each
task before any host starts the next task, using the number of forks (default 5) to parallelize.</p>
<p>The <code class="docutils literal"><span class="pre">serial</span></code> directive can &#8216;batch&#8217; this behaviour to a subset of the hosts, which then run to
completion of the play before the next &#8216;batch&#8217; starts.</p>
<p>A second <code class="docutils literal"><span class="pre">strategy</span></code> ships with ansible <code class="docutils literal"><span class="pre">free</span></code>, which allows each host to run until the end of
the play as fast as it can.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  strategy: free
  tasks:
  ...
</pre></div>
</div>
<div class="section" id="strategy-plugins">
<span id="id1"></span><h5>Strategy Plugins<a class="headerlink" href="#strategy-plugins" title="Permalink to this headline">¶</a></h5>
<p>The strategies are implemented via a new type of plugin, this means that in the future new
execution types can be added, either locally by users or to Ansible itself by
a code contribution.</p>
<p>One example is <code class="docutils literal"><span class="pre">debug</span></code> strategy. See <a class="reference internal" href="index.html#document-playbooks_debugger"><span class="doc">Playbook Debugger</span></a> for details.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_best_practices"></span><div class="section" id="best-practices">
<h4><a class="toc-backref" href="#id9">Best Practices</a><a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h4>
<p>Here are some tips for making the most of Ansible and Ansible playbooks.</p>
<p>You can find some example playbooks illustrating these best practices in our <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-examples repository</a>.  (NOTE: These may not use all of the features in the latest release, but are still an excellent reference!).</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#best-practices" id="id9">Best Practices</a><ul>
<li><a class="reference internal" href="#content-organization" id="id10">Content Organization</a><ul>
<li><a class="reference internal" href="#directory-layout" id="id11">Directory Layout</a></li>
<li><a class="reference internal" href="#alternative-directory-layout" id="id12">Alternative Directory Layout</a></li>
<li><a class="reference internal" href="#use-dynamic-inventory-with-clouds" id="id13">Use Dynamic Inventory With Clouds</a></li>
<li><a class="reference internal" href="#how-to-differentiate-staging-vs-production" id="id14">How to Differentiate Staging vs Production</a></li>
<li><a class="reference internal" href="#group-and-host-variables" id="id15">Group And Host Variables</a></li>
<li><a class="reference internal" href="#top-level-playbooks-are-separated-by-role" id="id16">Top Level Playbooks Are Separated By Role</a></li>
<li><a class="reference internal" href="#task-and-handler-organization-for-a-role" id="id17">Task And Handler Organization For A Role</a></li>
<li><a class="reference internal" href="#what-this-organization-enables-examples" id="id18">What This Organization Enables (Examples)</a></li>
<li><a class="reference internal" href="#deployment-vs-configuration-organization" id="id19">Deployment vs Configuration Organization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#staging-vs-production" id="id20">Staging vs Production</a></li>
<li><a class="reference internal" href="#rolling-updates" id="id21">Rolling Updates</a></li>
<li><a class="reference internal" href="#always-mention-the-state" id="id22">Always Mention The State</a></li>
<li><a class="reference internal" href="#group-by-roles" id="id23">Group By Roles</a></li>
<li><a class="reference internal" href="#operating-system-and-distribution-variance" id="id24">Operating System and Distribution Variance</a></li>
<li><a class="reference internal" href="#bundling-ansible-modules-with-playbooks" id="id25">Bundling Ansible Modules With Playbooks</a></li>
<li><a class="reference internal" href="#whitespace-and-comments" id="id26">Whitespace and Comments</a></li>
<li><a class="reference internal" href="#always-name-tasks" id="id27">Always Name Tasks</a></li>
<li><a class="reference internal" href="#keep-it-simple" id="id28">Keep It Simple</a></li>
<li><a class="reference internal" href="#version-control" id="id29">Version Control</a></li>
<li><a class="reference internal" href="#variables-and-vaults" id="id30">Variables and Vaults</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="content-organization">
<span id="id1"></span><h5><a class="toc-backref" href="#id10">Content Organization</a><a class="headerlink" href="#content-organization" title="Permalink to this headline">¶</a></h5>
<p>The following section shows one of many possible ways to organize playbook content.</p>
<p>Your usage of Ansible should fit your needs, however, not ours, so feel free to modify this approach and organize as you see fit.</p>
<p>One crucial way to organize your playbook content is Ansible&#8217;s &#8220;roles&#8221; organization feature, which is documented as part
of the main playbooks page.  You should take the time to read and understand the roles documentation which is available here: <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a>.</p>
<div class="section" id="directory-layout">
<span id="id2"></span><h6><a class="toc-backref" href="#id11">Directory Layout</a><a class="headerlink" href="#directory-layout" title="Permalink to this headline">¶</a></h6>
<p>The top level of the directory would contain files and directories like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>production                <span class="c1"># inventory file for production servers</span>
staging                   <span class="c1"># inventory file for staging environment</span>

group_vars/
   group1                 <span class="c1"># here we assign variables to particular groups</span>
   group2                 <span class="c1"># &quot;&quot;</span>
host_vars/
   hostname1              <span class="c1"># if systems need specific variables, put them here</span>
   hostname2              <span class="c1"># &quot;&quot;</span>

library/                  <span class="c1"># if any custom modules, put them here (optional)</span>
module_utils/             <span class="c1"># if any custom module_utils to support modules, put them here (optional)</span>
filter_plugins/           <span class="c1"># if any custom filter plugins, put them here (optional)</span>

site.yml                  <span class="c1"># master playbook</span>
webservers.yml            <span class="c1"># playbook for webserver tier</span>
dbservers.yml             <span class="c1"># playbook for dbserver tier</span>

roles/
    common/               <span class="c1"># this hierarchy represents a &quot;role&quot;</span>
        tasks/            <span class="c1">#</span>
            main.yml      <span class="c1">#  &lt;-- tasks file can include smaller files if warranted</span>
        handlers/         <span class="c1">#</span>
            main.yml      <span class="c1">#  &lt;-- handlers file</span>
        templates/        <span class="c1">#  &lt;-- files for use with the template resource</span>
            ntp.conf.j2   <span class="c1">#  &lt;------- templates end in .j2</span>
        files/            <span class="c1">#</span>
            bar.txt       <span class="c1">#  &lt;-- files for use with the copy resource</span>
            foo.sh        <span class="c1">#  &lt;-- script files for use with the script resource</span>
        vars/             <span class="c1">#</span>
            main.yml      <span class="c1">#  &lt;-- variables associated with this role</span>
        defaults/         <span class="c1">#</span>
            main.yml      <span class="c1">#  &lt;-- default lower priority variables for this role</span>
        meta/             <span class="c1">#</span>
            main.yml      <span class="c1">#  &lt;-- role dependencies</span>
        library/          <span class="c1"># roles can also include custom modules</span>
        module_utils/     <span class="c1"># roles can also include custom module_utils</span>
        lookup_plugins/   <span class="c1"># or other types of plugins, like lookup in this case</span>

    webtier/              <span class="c1"># same kind of structure as &quot;common&quot; was above, done for the webtier role</span>
    monitoring/           <span class="c1"># &quot;&quot;</span>
    fooapp/               <span class="c1"># &quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="alternative-directory-layout">
<span id="id3"></span><h6><a class="toc-backref" href="#id12">Alternative Directory Layout</a><a class="headerlink" href="#alternative-directory-layout" title="Permalink to this headline">¶</a></h6>
<p>Alternatively you can put each inventory file with its <code class="docutils literal"><span class="pre">group_vars</span></code>/<code class="docutils literal"><span class="pre">host_vars</span></code> in a separate directory. This is particularly useful if your <code class="docutils literal"><span class="pre">group_vars</span></code>/<code class="docutils literal"><span class="pre">host_vars</span></code> don&#8217;t have that much in common in different environments. The layout could look something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>inventories/
   production/
      hosts               <span class="c1"># inventory file for production servers</span>
      group_vars/
         group1           <span class="c1"># here we assign variables to particular groups</span>
         group2           <span class="c1"># &quot;&quot;</span>
      host_vars/
         hostname1        <span class="c1"># if systems need specific variables, put them here</span>
         hostname2        <span class="c1"># &quot;&quot;</span>

   staging/
      hosts               <span class="c1"># inventory file for staging environment</span>
      group_vars/
         group1           <span class="c1"># here we assign variables to particular groups</span>
         group2           <span class="c1"># &quot;&quot;</span>
      host_vars/
         stagehost1       <span class="c1"># if systems need specific variables, put them here</span>
         stagehost2       <span class="c1"># &quot;&quot;</span>

library/
module_utils/
filter_plugins/

site.yml
webservers.yml
dbservers.yml

roles/
    common/
    webtier/
    monitoring/
    fooapp/
</pre></div>
</div>
<p>This layout gives you more flexibility for larger environments, as well as a total separation of inventory variables between different environments. The downside is that it is harder to maintain, because there are more files.</p>
</div>
<div class="section" id="use-dynamic-inventory-with-clouds">
<span id="id4"></span><h6><a class="toc-backref" href="#id13">Use Dynamic Inventory With Clouds</a><a class="headerlink" href="#use-dynamic-inventory-with-clouds" title="Permalink to this headline">¶</a></h6>
<p>If you are using a cloud provider, you should not be managing your inventory in a static file.  See <a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a>.</p>
<p>This does not just apply to clouds &#8211; If you have another system maintaining a canonical list of systems
in your infrastructure, usage of dynamic inventory is a great idea in general.</p>
</div>
<div class="section" id="how-to-differentiate-staging-vs-production">
<span id="staging-vs-prod"></span><h6><a class="toc-backref" href="#id14">How to Differentiate Staging vs Production</a><a class="headerlink" href="#how-to-differentiate-staging-vs-production" title="Permalink to this headline">¶</a></h6>
<p>If managing static inventory, it is frequently asked how to differentiate different types of environments.  The following example
shows a good way to do this.  Similar methods of grouping could be adapted to dynamic inventory (for instance, consider applying the AWS
tag &#8220;environment:production&#8221;, and you&#8217;ll get a group of systems automatically discovered named &#8220;ec2_tag_environment_production&#8221;.</p>
<p>Let&#8217;s show a static inventory example though.  Below, the <em>production</em> file contains the inventory of all of your production hosts.</p>
<p>It is suggested that you define groups based on purpose of the host (roles) and also geography or datacenter location (if applicable):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># file: production</span>

<span class="o">[</span>atlanta-webservers<span class="o">]</span>
www-atl-1.example.com
www-atl-2.example.com

<span class="o">[</span>boston-webservers<span class="o">]</span>
www-bos-1.example.com
www-bos-2.example.com

<span class="o">[</span>atlanta-dbservers<span class="o">]</span>
db-atl-1.example.com
db-atl-2.example.com

<span class="o">[</span>boston-dbservers<span class="o">]</span>
db-bos-1.example.com

<span class="c1"># webservers in all geos</span>
<span class="o">[</span>webservers:children<span class="o">]</span>
atlanta-webservers
boston-webservers

<span class="c1"># dbservers in all geos</span>
<span class="o">[</span>dbservers:children<span class="o">]</span>
atlanta-dbservers
boston-dbservers

<span class="c1"># everything in the atlanta geo</span>
<span class="o">[</span>atlanta:children<span class="o">]</span>
atlanta-webservers
atlanta-dbservers

<span class="c1"># everything in the boston geo</span>
<span class="o">[</span>boston:children<span class="o">]</span>
boston-webservers
boston-dbservers
</pre></div>
</div>
</div>
<div class="section" id="group-and-host-variables">
<span id="groups-and-hosts"></span><h6><a class="toc-backref" href="#id15">Group And Host Variables</a><a class="headerlink" href="#group-and-host-variables" title="Permalink to this headline">¶</a></h6>
<p>This section extends on the previous example.</p>
<p>Groups are nice for organization, but that&#8217;s not all groups are good for.  You can also assign variables to them!  For instance, atlanta has its own NTP servers, so when setting up ntp.conf, we should use them.  Let&#8217;s set those now:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: group_vars/atlanta</span>
ntp: ntp-atlanta.example.com
backup: backup-atlanta.example.com
</pre></div>
</div>
<p>Variables aren&#8217;t just for geographic information either!  Maybe the webservers have some configuration that doesn&#8217;t make sense for the database servers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: group_vars/webservers</span>
apacheMaxRequestsPerChild: <span class="m">3000</span>
apacheMaxClients: <span class="m">900</span>
</pre></div>
</div>
<p>If we had any default values, or values that were universally true, we would put them in a file called group_vars/all:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: group_vars/all</span>
ntp: ntp-boston.example.com
backup: backup-boston.example.com
</pre></div>
</div>
<p>We can define specific hardware variance in systems in a host_vars file, but avoid doing this unless you need to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: host_vars/db-bos-1.example.com</span>
foo_agent_port: <span class="m">86</span>
bar_agent_port: <span class="m">99</span>
</pre></div>
</div>
<p>Again, if we are using dynamic inventory sources, many dynamic groups are automatically created.  So a tag like &#8220;class:webserver&#8221; would load in
variables from the file &#8220;group_vars/ec2_tag_class_webserver&#8221; automatically.</p>
</div>
<div class="section" id="top-level-playbooks-are-separated-by-role">
<span id="split-by-role"></span><h6><a class="toc-backref" href="#id16">Top Level Playbooks Are Separated By Role</a><a class="headerlink" href="#top-level-playbooks-are-separated-by-role" title="Permalink to this headline">¶</a></h6>
<p>In site.yml, we import a playbook that defines our entire infrastructure.  This is a very short example, because it&#8217;s just importing
some other playbooks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: site.yml</span>
- import_plays: webservers.yml
- import_plays: dbservers.yml
</pre></div>
</div>
<p>In a file like webservers.yml (also at the top level), we map the configuration of the webservers group to the roles performed by the webservers group:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: webservers.yml</span>
- hosts: webservers
  roles:
    - common
    - webtier
</pre></div>
</div>
<p>The idea here is that we can choose to configure our whole infrastructure by &#8220;running&#8221; site.yml or we could just choose to run a subset by running
webservers.yml.  This is analogous to the &#8220;&#8211;limit&#8221; parameter to ansible but a little more explicit:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook site.yml --limit webservers
ansible-playbook webservers.yml
</pre></div>
</div>
</div>
<div class="section" id="task-and-handler-organization-for-a-role">
<span id="role-organization"></span><h6><a class="toc-backref" href="#id17">Task And Handler Organization For A Role</a><a class="headerlink" href="#task-and-handler-organization-for-a-role" title="Permalink to this headline">¶</a></h6>
<p>Below is an example tasks file that explains how a role works.  Our common role here just sets up NTP, but it could do more if we wanted:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: roles/common/tasks/main.yml</span>

- name: be sure ntp is installed
  yum: <span class="nv">name</span><span class="o">=</span>ntp <span class="nv">state</span><span class="o">=</span>installed
  tags: ntp

- name: be sure ntp is configured
  template: <span class="nv">src</span><span class="o">=</span>ntp.conf.j2 <span class="nv">dest</span><span class="o">=</span>/etc/ntp.conf
  notify:
    - restart ntpd
  tags: ntp

- name: be sure ntpd is running and enabled
  service: <span class="nv">name</span><span class="o">=</span>ntpd <span class="nv">state</span><span class="o">=</span>started <span class="nv">enabled</span><span class="o">=</span>yes
  tags: ntp
</pre></div>
</div>
<p>Here is an example handlers file.  As a review, handlers are only fired when certain tasks report changes, and are run at the end
of each play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: roles/common/handlers/main.yml</span>
- name: restart ntpd
  service: <span class="nv">name</span><span class="o">=</span>ntpd <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>See <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a> for more information.</p>
</div>
<div class="section" id="what-this-organization-enables-examples">
<span id="organization-examples"></span><h6><a class="toc-backref" href="#id18">What This Organization Enables (Examples)</a><a class="headerlink" href="#what-this-organization-enables-examples" title="Permalink to this headline">¶</a></h6>
<p>Above we&#8217;ve shared our basic organizational structure.</p>
<p>Now what sort of use cases does this layout enable?  Lots!  If I want to reconfigure my whole infrastructure, it&#8217;s just:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook -i production site.yml
</pre></div>
</div>
<p>What about just reconfiguring NTP on everything?  Easy.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook -i production site.yml --tags ntp
</pre></div>
</div>
<p>What about just reconfiguring my webservers?:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook -i production webservers.yml
</pre></div>
</div>
<p>What about just my webservers in Boston?:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook -i production webservers.yml --limit boston
</pre></div>
</div>
<p>What about just the first 10, and then the next 10?:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook -i production webservers.yml --limit boston<span class="o">[</span><span class="m">1</span>:10<span class="o">]</span>
ansible-playbook -i production webservers.yml --limit boston<span class="o">[</span><span class="m">11</span>:20<span class="o">]</span>
</pre></div>
</div>
<p>And of course just basic ad-hoc stuff is also possible.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible boston -i production -m ping
ansible boston -i production -m <span class="nb">command</span> -a <span class="s1">&#39;/sbin/reboot&#39;</span>
</pre></div>
</div>
<p>And there are some useful commands to know (at least in 1.1 and higher):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># confirm what task names would be run if I ran this command and said &quot;just ntp tasks&quot;</span>
ansible-playbook -i production webservers.yml --tags ntp --list-tasks

<span class="c1"># confirm what hostnames might be communicated with if I said &quot;limit to boston&quot;</span>
ansible-playbook -i production webservers.yml --limit boston --list-hosts
</pre></div>
</div>
</div>
<div class="section" id="deployment-vs-configuration-organization">
<span id="dep-vs-config"></span><h6><a class="toc-backref" href="#id19">Deployment vs Configuration Organization</a><a class="headerlink" href="#deployment-vs-configuration-organization" title="Permalink to this headline">¶</a></h6>
<p>The above setup models a typical configuration topology.  When doing multi-tier deployments, there are going
to be some additional playbooks that hop between tiers to roll out an application.  In this case, &#8216;site.yml&#8217;
may be augmented by playbooks like &#8216;deploy_exampledotcom.yml&#8217; but the general concepts can still apply.</p>
<p>Consider &#8220;playbooks&#8221; as a sports metaphor &#8211; you don&#8217;t have to just have one set of plays to use against your infrastructure
all the time &#8211; you can have situational plays that you use at different times and for different purposes.</p>
<p>Ansible allows you to deploy and configure using the same tool, so you would likely reuse groups and just
keep the OS configuration in separate playbooks from the app deployment.</p>
</div>
</div>
<div class="section" id="staging-vs-production">
<span id="id5"></span><h5><a class="toc-backref" href="#id20">Staging vs Production</a><a class="headerlink" href="#staging-vs-production" title="Permalink to this headline">¶</a></h5>
<p>As also mentioned above, a good way to keep your staging (or testing) and production environments separate is to use a separate inventory file for staging and production.   This way you pick with -i what you are targeting.  Keeping them all in one file can lead to surprises!</p>
<p>Testing things in a staging environment before trying in production is always a great idea.  Your environments need not be the same
size and you can use group variables to control the differences between those environments.</p>
</div>
<div class="section" id="rolling-updates">
<span id="rolling-update"></span><h5><a class="toc-backref" href="#id21">Rolling Updates</a><a class="headerlink" href="#rolling-updates" title="Permalink to this headline">¶</a></h5>
<p>Understand the &#8216;serial&#8217; keyword.  If updating a webserver farm you really want to use it to control how many machines you are
updating at once in the batch.</p>
<p>See <a class="reference internal" href="index.html#document-playbooks_delegation"><span class="doc">Delegation, Rolling Updates, and Local Actions</span></a>.</p>
</div>
<div class="section" id="always-mention-the-state">
<span id="mention-the-state"></span><h5><a class="toc-backref" href="#id22">Always Mention The State</a><a class="headerlink" href="#always-mention-the-state" title="Permalink to this headline">¶</a></h5>
<p>The &#8216;state&#8217; parameter is optional to a lot of modules.  Whether &#8216;state=present&#8217; or &#8216;state=absent&#8217;, it&#8217;s always best to leave that
parameter in your playbooks to make it clear, especially as some modules support additional states.</p>
</div>
<div class="section" id="group-by-roles">
<span id="id6"></span><h5><a class="toc-backref" href="#id23">Group By Roles</a><a class="headerlink" href="#group-by-roles" title="Permalink to this headline">¶</a></h5>
<p>We&#8217;re somewhat repeating ourselves with this tip, but it&#8217;s worth repeating. A system can be in multiple groups.  See <a class="reference internal" href="index.html#document-intro_inventory"><span class="doc">Inventory</span></a> and <a class="reference internal" href="index.html#document-intro_patterns"><span class="doc">Patterns</span></a>.   Having groups named after things like
<em>webservers</em> and <em>dbservers</em> is repeated in the examples because it&#8217;s a very powerful concept.</p>
<p>This allows playbooks to target machines based on role, as well as to assign role specific variables
using the group variable system.</p>
<p>See <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a>.</p>
</div>
<div class="section" id="operating-system-and-distribution-variance">
<span id="os-variance"></span><h5><a class="toc-backref" href="#id24">Operating System and Distribution Variance</a><a class="headerlink" href="#operating-system-and-distribution-variance" title="Permalink to this headline">¶</a></h5>
<p>When dealing with a parameter that is different between two different operating systems, a great way to handle this is
by using the group_by module.</p>
<p>This makes a dynamic group of hosts matching certain criteria, even if that group is not defined in the inventory file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

<span class="c1"># talk to all hosts just so we can learn about them</span>
- hosts: all
  tasks:
     - group_by: <span class="nv">key</span><span class="o">=</span>os_<span class="o">{{</span> ansible_distribution <span class="o">}}</span>

<span class="c1"># now just on the CentOS hosts...</span>

- hosts: os_CentOS
  gather_facts: False
  tasks:
     - <span class="c1"># tasks that only happen on CentOS go here</span>
</pre></div>
</div>
<p>This will throw all systems into a dynamic group based on the operating system name.</p>
<p>If group-specific settings are needed, this can also be done. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: group_vars/all</span>
asdf: <span class="m">10</span>

---
<span class="c1"># file: group_vars/os_CentOS</span>
asdf: <span class="m">42</span>
</pre></div>
</div>
<p>In the above example, CentOS machines get the value of &#8216;42&#8217; for asdf, but other machines get &#8216;10&#8217;.
This can be used not only to set variables, but also to apply certain roles to only certain systems.</p>
<p>Alternatively, if only variables are needed:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  tasks:
    - include_vars: <span class="s2">&quot;os_{{ ansible_distribution }}.yml&quot;</span>
    - debug: <span class="nv">var</span><span class="o">=</span>asdf
</pre></div>
</div>
<p>This will pull in variables based on the OS name.</p>
</div>
<div class="section" id="bundling-ansible-modules-with-playbooks">
<span id="ship-modules-with-playbooks"></span><h5><a class="toc-backref" href="#id25">Bundling Ansible Modules With Playbooks</a><a class="headerlink" href="#bundling-ansible-modules-with-playbooks" title="Permalink to this headline">¶</a></h5>
<p>If a playbook has a <code class="file docutils literal"><span class="pre">./library</span></code> directory relative to its YAML file, this directory can be used to add ansible modules that will
automatically be in the ansible module path.  This is a great way to keep modules that go with a playbook together.  This is shown
in the directory structure example at the start of this section.</p>
</div>
<div class="section" id="whitespace-and-comments">
<span id="whitespace"></span><h5><a class="toc-backref" href="#id26">Whitespace and Comments</a><a class="headerlink" href="#whitespace-and-comments" title="Permalink to this headline">¶</a></h5>
<p>Generous use of whitespace to break things up, and use of comments (which start with &#8216;#&#8217;), is encouraged.</p>
</div>
<div class="section" id="always-name-tasks">
<span id="name-tasks"></span><h5><a class="toc-backref" href="#id27">Always Name Tasks</a><a class="headerlink" href="#always-name-tasks" title="Permalink to this headline">¶</a></h5>
<p>It is possible to leave off the &#8216;name&#8217; for a given task, though it is recommended to provide a description
about why something is being done instead.  This name is shown when the playbook is run.</p>
</div>
<div class="section" id="keep-it-simple">
<span id="id7"></span><h5><a class="toc-backref" href="#id28">Keep It Simple</a><a class="headerlink" href="#keep-it-simple" title="Permalink to this headline">¶</a></h5>
<p>When you can do something simply, do something simply.  Do not reach
to use every feature of Ansible together, all at once.  Use what works
for you.  For example, you will probably not need <code class="docutils literal"><span class="pre">vars</span></code>,
<code class="docutils literal"><span class="pre">vars_files</span></code>, <code class="docutils literal"><span class="pre">vars_prompt</span></code> and <code class="docutils literal"><span class="pre">--extra-vars</span></code> all at once,
while also using an external inventory file.</p>
<p>If something feels complicated, it probably is, and may be a good opportunity to simplify things.</p>
</div>
<div class="section" id="version-control">
<span id="id8"></span><h5><a class="toc-backref" href="#id29">Version Control</a><a class="headerlink" href="#version-control" title="Permalink to this headline">¶</a></h5>
<p>Use version control.  Keep your playbooks and inventory file in git
(or another version control system), and commit when you make changes
to them.  This way you have an audit trail describing when and why you
changed the rules that are automating your infrastructure.</p>
</div>
<div class="section" id="variables-and-vaults">
<span id="best-practices-for-variables-and-vaults"></span><h5><a class="toc-backref" href="#id30">Variables and Vaults</a><a class="headerlink" href="#variables-and-vaults" title="Permalink to this headline">¶</a></h5>
<p>For general maintenance, it is often easier to use <code class="docutils literal"><span class="pre">grep</span></code>, or similar tools, to find variables in your Ansible setup. Since vaults obscure these variables, it is best to work with a layer of indirection. When running a playbook, Ansible finds the variables in the unencrypted file and all sensitive variables come from the encrypted file.</p>
<p>A best practice approach for this is to start with a <code class="docutils literal"><span class="pre">group_vars/</span></code> subdirectory named after the group. Inside of this subdirectory, create two files named <code class="docutils literal"><span class="pre">vars</span></code> and <code class="docutils literal"><span class="pre">vault</span></code>. Inside of the <code class="docutils literal"><span class="pre">vars</span></code> file, define all of the variables needed, including any sensitive ones. Next, copy all of the sensitive variables over to the <code class="docutils literal"><span class="pre">vault</span></code> file and prefix these variables with <code class="docutils literal"><span class="pre">vault_</span></code>. You should adjust the variables in the <code class="docutils literal"><span class="pre">vars</span></code> file to point to the matching <code class="docutils literal"><span class="pre">vault_</span></code> variables using jinja2 syntax, and ensure that the <code class="docutils literal"><span class="pre">vault</span></code> file is vault encrypted.</p>
<p>This best practice has no limit on the amount of variable and vault files or their names.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Review the basic playbook features</dd>
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference internal" href="index.html#document-intro_patterns"><span class="doc">Patterns</span></a></dt>
<dd>Learn about how to select hosts</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">GitHub examples directory</a></dt>
<dd>Complete playbook files from the github project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<span id="document-playbooks_special_topics"></span><div class="section" id="playbooks-special-topics">
<h3>Playbooks: Special Topics<a class="headerlink" href="#playbooks-special-topics" title="Permalink to this headline">¶</a></h3>
<p>Here are some playbook features that not everyone may need to learn, but can be quite useful for particular applications.
Browsing these topics is recommended as you may find some useful tips here, but feel free to learn the basics of Ansible first
and adopt these only if they seem relevant or useful to your environment.</p>
<div class="toctree-wrapper compound">
<span id="document-become"></span><div class="section" id="become-privilege-escalation">
<h4><a class="toc-backref" href="#id1">Become (Privilege Escalation)</a><a class="headerlink" href="#become-privilege-escalation" title="Permalink to this headline">¶</a></h4>
<p>Ansible can use existing privilege escalation systems to allow a user to execute tasks as another.</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#become-privilege-escalation" id="id1">Become (Privilege Escalation)</a><ul>
<li><a class="reference internal" href="#become" id="id2">Become</a><ul>
<li><a class="reference internal" href="#directives" id="id3">Directives</a></li>
<li><a class="reference internal" href="#connection-variables" id="id4">Connection variables</a></li>
<li><a class="reference internal" href="#command-line-options" id="id5">Command line options</a></li>
<li><a class="reference internal" href="#for-those-from-pre-1-9-sudo-and-su-still-work" id="id6">For those from Pre 1.9 , sudo and su still work!</a></li>
<li><a class="reference internal" href="#limitations" id="id7">Limitations</a><ul>
<li><a class="reference internal" href="#becoming-an-unprivileged-user" id="id8">Becoming an Unprivileged User</a></li>
<li><a class="reference internal" href="#connection-plugin-support" id="id9">Connection Plugin Support</a></li>
<li><a class="reference internal" href="#only-one-method-may-be-enabled-per-host" id="id10">Only one method may be enabled per host</a></li>
<li><a class="reference internal" href="#can-t-limit-escalation-to-certain-commands" id="id11">Can&#8217;t limit escalation to certain commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="become">
<h5><a class="toc-backref" href="#id2">Become</a><a class="headerlink" href="#become" title="Permalink to this headline">¶</a></h5>
<p>Ansible allows you to &#8216;become&#8217; another user, different from the user that logged into the machine (remote user). This is done using existing
privilege escalation tools, which you probably already use or have configured, like <cite>sudo</cite>, <cite>su</cite>, <cite>pfexec</cite>, <cite>doas</cite>, <cite>pbrun</cite>, <cite>dzdo</cite>, <cite>ksu</cite> and others.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Before 1.9 Ansible mostly allowed the use of <cite>sudo</cite> and a limited use of <cite>su</cite> to allow a login/remote user to become a different user
and execute tasks, create resources with the 2nd user&#8217;s permissions. As of 1.9 <cite>become</cite> supersedes the old sudo/su, while still being backwards compatible.
This new system also makes it easier to add other privilege escalation tools like <cite>pbrun</cite> (Powerbroker), <cite>pfexec</cite>, <cite>dzdo</cite> (Centrify), and others.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Become vars &amp; directives are independent, i.e. setting <cite>become_user</cite> does not set <cite>become</cite>.</p>
</div>
<div class="section" id="directives">
<h6><a class="toc-backref" href="#id3">Directives</a><a class="headerlink" href="#directives" title="Permalink to this headline">¶</a></h6>
<p>These can be set from play to task level, but are overridden by connection variables as they can be host specific.</p>
<dl class="docutils">
<dt>become</dt>
<dd>set to &#8216;true&#8217;/&#8217;yes&#8217; to activate privilege escalation.</dd>
<dt>become_user</dt>
<dd>set to user with desired privileges — the user you &#8216;become&#8217;, NOT the user you login as. Does NOT imply <cite>become: yes</cite>, to allow it to be set at host level.</dd>
<dt>become_method</dt>
<dd>(at play or task level) overrides the default method set in ansible.cfg, set to <cite>sudo</cite>/<cite>su</cite>/<cite>pbrun</cite>/<cite>pfexec</cite>/<cite>doas</cite>/<cite>dzdo</cite>/<cite>ksu</cite></dd>
<dt>become_flags</dt>
<dd>(at play or task level) permit to use specific flags for the tasks or role. One common use is to change user to nobody when the shell is set to no login. Added in Ansible 2.2.</dd>
</dl>
<p>For example, to manage a system service (which requires <code class="docutils literal"><span class="pre">root</span></code> privileges) when connected as a non-<code class="docutils literal"><span class="pre">root</span></code> user (this takes advantage of the fact that the default value of <code class="docutils literal"><span class="pre">become_user</span></code> is <code class="docutils literal"><span class="pre">root</span></code>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Ensure the httpd service is running
  service:
    name: httpd
    state: started
  become: <span class="nb">true</span>
</pre></div>
</div>
<p>To run a command as the <code class="docutils literal"><span class="pre">apache</span></code> user:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Run a <span class="nb">command</span> as the apache user
  command: somecommand
  become: <span class="nb">true</span>
  become_user: apache
</pre></div>
</div>
<p>To do something as the <code class="docutils literal"><span class="pre">nobody</span></code> user when the shell is nologin:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Run a <span class="nb">command</span> as nobody
  command: somecommand
  become: <span class="nb">true</span>
  become_method: su
  become_user: nobody
  become_flags: <span class="s1">&#39;-s /bin/sh&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="connection-variables">
<h6><a class="toc-backref" href="#id4">Connection variables</a><a class="headerlink" href="#connection-variables" title="Permalink to this headline">¶</a></h6>
<p>Each allows you to set an option per group and/or host, these are normally defined in inventory but can be used as normal variables.</p>
<dl class="docutils">
<dt>ansible_become</dt>
<dd>equivalent of the become directive, decides if privilege escalation is used or not.</dd>
<dt>ansible_become_method</dt>
<dd>allows to set privilege escalation method</dd>
<dt>ansible_become_user</dt>
<dd>allows to set the user you become through privilege escalation, does not imply <cite>ansible_become: True</cite></dd>
<dt>ansible_become_pass</dt>
<dd>allows you to set the privilege escalation password</dd>
</dl>
<p>For example, if you want to run all tasks as <code class="docutils literal"><span class="pre">root</span></code> on a server named <code class="docutils literal"><span class="pre">webserver</span></code>, but you can only connect as the <code class="docutils literal"><span class="pre">manager</span></code> user, you could use an inventory entry like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>webserver <span class="nv">ansible_user</span><span class="o">=</span>manager <span class="nv">ansible_become</span><span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-options">
<h6><a class="toc-backref" href="#id5">Command line options</a><a class="headerlink" href="#command-line-options" title="Permalink to this headline">¶</a></h6>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--ask-become-pass</span>, <span class="option">-K</span></kbd></td>
</tr>
<tr><td>&#160;</td><td>ask for privilege escalation password, does not imply become will be used</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--become</span>, <span class="option">-b</span></kbd></td>
<td>run operations with become (no password implied)</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--become-method=<var>BECOME_METHOD</var></span></kbd></td>
</tr>
<tr><td>&#160;</td><td>privilege escalation method to use (default=sudo),
valid choices: [ sudo | su | pbrun | pfexec | doas | dzdo | ksu ]</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--become-user=<var>BECOME_USER</var></span></kbd></td>
</tr>
<tr><td>&#160;</td><td>run operations as this user (default=root), does not imply &#8211;become/-b</td></tr>
</tbody>
</table>
</div>
<div class="section" id="for-those-from-pre-1-9-sudo-and-su-still-work">
<h6><a class="toc-backref" href="#id6">For those from Pre 1.9 , sudo and su still work!</a><a class="headerlink" href="#for-those-from-pre-1-9-sudo-and-su-still-work" title="Permalink to this headline">¶</a></h6>
<p>For those using old playbooks will not need to be changed, even though they are deprecated, sudo and su directives, variables and options
will continue to work. It is recommended to move to become as they may be retired at one point.
You cannot mix directives on the same object (become and sudo) though, Ansible will complain if you try to.</p>
<p>Become will default to using the old sudo/su configs and variables if they exist, but will override them if you specify any of the new ones.</p>
</div>
<div class="section" id="limitations">
<h6><a class="toc-backref" href="#id7">Limitations</a><a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h6>
<p>Although privilege escalation is mostly intuitive, there are a few limitations
on how it works.  Users should be aware of these to avoid surprises.</p>
<div class="section" id="becoming-an-unprivileged-user">
<h7><a class="toc-backref" href="#id8">Becoming an Unprivileged User</a><a class="headerlink" href="#becoming-an-unprivileged-user" title="Permalink to this headline">¶</a></h7>
<p>Ansible 2.0.x and below has a limitation with regards to becoming an
unprivileged user that can be a security risk if users are not aware of it.
Ansible modules are executed on the remote machine by first substituting the
parameters into the module file, then copying the file to the remote machine,
and finally executing it there.</p>
<p>Everything is fine if the module file is executed without using <code class="docutils literal"><span class="pre">become</span></code>,
when the <code class="docutils literal"><span class="pre">become_user</span></code> is root, or when the connection to the remote machine
is made as root.  In these cases the module file is created with permissions
that only allow reading by the user and root.</p>
<p>The problem occurs when the <code class="docutils literal"><span class="pre">become_user</span></code> is an unprivileged user.  Ansible
2.0.x and below make the module file world readable in this case, as the module
file is written as the user that Ansible connects as, but the file needs to
be readable by the user Ansible is set to <code class="docutils literal"><span class="pre">become</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In Ansible 2.1, this window is further narrowed: If the connection
is made as a privileged user (root), then Ansible 2.1 and above will use
chown to set the file&#8217;s owner to the unprivileged user being switched to.
This means both the user making the connection and the user being switched
to via <code class="docutils literal"><span class="pre">become</span></code> must be unprivileged in order to trigger this problem.</p>
</div>
<p>If any of the parameters passed to the module are sensitive in nature, then
those pieces of data are located in a world readable module file for the
duration of the Ansible module execution.  Once the module is done executing,
Ansible will delete the temporary file.  If you trust the client machines then
there&#8217;s no problem here.  If you do not trust the client machines then this is
a potential danger.</p>
<p>Ways to resolve this include:</p>
<ul class="simple">
<li>Use <a class="reference internal" href="index.html#pipelining"><span class="std std-ref">pipelining</span></a>.  When pipelining is enabled, Ansible doesn&#8217;t save the
module to a temporary file on the client.  Instead it pipes the module to
the remote python interpreter&#8217;s stdin.  Pipelining does not work for
non-python modules.</li>
<li>(Available in Ansible 2.1) Install POSIX.1e filesystem acl support on the
managed host.  If the temporary directory on the remote host is mounted with
POSIX acls enabled and the <strong class="command">setfacl</strong> tool is in the remote <code class="docutils literal"><span class="pre">PATH</span></code>
then Ansible will use POSIX acls to share the module file with the second
unprivileged user instead of having to make the file readable by everyone.</li>
<li>Don&#8217;t perform an action on the remote machine by becoming an unprivileged
user.  Temporary files are protected by UNIX file permissions when you
<code class="docutils literal"><span class="pre">become</span></code> root or do not use <code class="docutils literal"><span class="pre">become</span></code>.  In Ansible 2.1 and above, UNIX
file permissions are also secure if you make the connection to the managed
machine as root and then use <code class="docutils literal"><span class="pre">become</span></code> to an unprivileged account.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Although the Solaris ZFS filesystem has filesystem ACLs, the ACLs
are not POSIX.1e filesystem acls (they are NFSv4 ACLs instead).  Ansible
cannot use these ACLs to manage its temp file permissions so you may have
to resort to <code class="docutils literal"><span class="pre">allow_world_readable_tmpfiles</span></code> if the remote machines use ZFS.</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 2.1.</span></p>
</div>
<p>In addition to the additional means of doing this securely, Ansible 2.1 also
makes it harder to unknowingly do this insecurely.  Whereas in Ansible 2.0.x
and below, Ansible will silently allow the insecure behaviour if it was unable
to find another way to share the files with the unprivileged user, in Ansible
2.1 and above Ansible defaults to issuing an error if it can&#8217;t do this
securely.  If you can&#8217;t make any of the changes above to resolve the problem,
and you decide that the machine you&#8217;re running on is secure enough for the
modules you want to run there to be world readable, you can turn on
<code class="docutils literal"><span class="pre">allow_world_readable_tmpfiles</span></code> in the <code class="file docutils literal"><span class="pre">ansible.cfg</span></code> file.  Setting
<code class="docutils literal"><span class="pre">allow_world_readable_tmpfiles</span></code> will change this from an error into
a warning and allow the task to run as it did prior to 2.1.</p>
</div>
<div class="section" id="connection-plugin-support">
<h7><a class="toc-backref" href="#id9">Connection Plugin Support</a><a class="headerlink" href="#connection-plugin-support" title="Permalink to this headline">¶</a></h7>
<p>Privilege escalation methods must also be supported by the connection plugin
used.   Most connection plugins will warn if they do not support become.  Some
will just ignore it as they always run as root (jail, chroot, etc).</p>
</div>
<div class="section" id="only-one-method-may-be-enabled-per-host">
<h7><a class="toc-backref" href="#id10">Only one method may be enabled per host</a><a class="headerlink" href="#only-one-method-may-be-enabled-per-host" title="Permalink to this headline">¶</a></h7>
<p>Methods cannot be chained.  You cannot use <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">/bin/su</span> <span class="pre">-</span></code> to become a user,
you need to have privileges to run the command as that user in sudo or be able
to su directly to it (the same for pbrun, pfexec or other supported methods).</p>
</div>
<div class="section" id="can-t-limit-escalation-to-certain-commands">
<h7><a class="toc-backref" href="#id11">Can&#8217;t limit escalation to certain commands</a><a class="headerlink" href="#can-t-limit-escalation-to-certain-commands" title="Permalink to this headline">¶</a></h7>
<p>Privilege escalation permissions have to be general.  Ansible does not always
use a specific command to do something but runs modules (code) from
a temporary file name which changes every time.  If you have &#8216;/sbin/service&#8217;
or &#8216;/bin/chmod&#8217; as the allowed commands this will fail with ansible as those
paths won&#8217;t match with the temporary file that ansible creates to run the
module.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<span id="document-playbooks_acceleration"></span><div class="section" id="accelerated-mode">
<h4>Accelerated Mode<a class="headerlink" href="#accelerated-mode" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Accelerated mode is deprecated. Consider using SSH with ControlPersist and pipelining enabled instead. This feature will be removed in a future release. Deprecation warnings can be disabled by setting <code class="code docutils literal"><span class="pre">deprecation_warnings=False</span></code> in <code class="code docutils literal"><span class="pre">ansible.cfg</span></code>.</p>
</div>
<div class="section" id="you-might-not-need-this">
<h5>You Might Not Need This!<a class="headerlink" href="#you-might-not-need-this" title="Permalink to this headline">¶</a></h5>
<p>Are you running Ansible 1.5 or later? If so, you may not need accelerated mode due to a new feature called &#8220;SSH pipelining&#8221; and should read the <a class="reference internal" href="index.html#pipelining"><span class="std std-ref">pipelining</span></a> section of the documentation.</p>
<p>For users on 1.5 and later, accelerated mode only makes sense if you (A) are managing from an Enterprise Linux 6 or earlier host and still are on paramiko, or (B) can&#8217;t enable TTYs with sudo as described in the pipelining docs.</p>
<p>If you can use pipelining, Ansible will reduce the amount of files transferred over the wire,
making everything much more efficient, and performance will be on par with accelerated mode in nearly all cases, possibly excluding very large file transfer. Because less moving parts are involved, pipelining is better than accelerated mode for nearly all use cases.</p>
<p>Accelerated mode remains around in support of EL6
control machines and other constrained environments.</p>
</div>
<div class="section" id="accelerated-mode-details">
<h5>Accelerated Mode Details<a class="headerlink" href="#accelerated-mode-details" title="Permalink to this headline">¶</a></h5>
<p>While OpenSSH using the ControlPersist feature is quite fast and scalable, there is a certain small amount of overhead involved in
using SSH connections. While many people will not encounter a need, if you are running on a platform that doesn&#8217;t have ControlPersist support (such as an EL6 control machine), you&#8217;ll probably be even more interested in tuning options.</p>
<p>Accelerated mode is there to help connections work faster, but still uses SSH for initial secure key exchange. There is no
additional public key infrastructure to manage, and this does not require things like NTP or even DNS.</p>
<p>Accelerated mode can be anywhere from 2-6x faster than SSH with ControlPersist enabled, and 10x faster than paramiko.</p>
<p>Accelerated mode works by launching a temporary daemon over SSH. Once the daemon is running, Ansible will connect directly
to it via a socket connection. Ansible secures this communication by using a temporary AES key that is exchanged during
the SSH connection (this key is different for every host, and is also regenerated periodically).</p>
<p>By default, Ansible will use port 5099 for the accelerated connection, though this is configurable. Once running, the daemon will accept connections for 30 minutes, after which time it will terminate itself and need to be restarted over SSH.</p>
<p>In order to use accelerated mode, simply add <cite>accelerate: true</cite> to your play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: all
  accelerate: <span class="nb">true</span>

  tasks:

  - name: some task
    command: <span class="nb">echo</span> <span class="o">{{</span> item <span class="o">}}</span>
    with_items:
    - foo
    - bar
    - baz
</pre></div>
</div>
<p>If you wish to change the port Ansible will use for the accelerated connection, just add the <cite>accelerate_port</cite> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: all
  accelerate: <span class="nb">true</span>
  <span class="c1"># default port is 5099</span>
  accelerate_port: <span class="m">10000</span>
</pre></div>
</div>
<p>The <cite>accelerate_port</cite> option can also be specified in the environment variable <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ACCELERATE_PORT</span></code>, or in your <cite>ansible.cfg</cite> configuration:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>accelerate<span class="o">]</span>
<span class="nv">accelerate_port</span> <span class="o">=</span> <span class="m">5099</span>
</pre></div>
</div>
<p>As noted above, accelerated mode also supports running tasks via sudo, however there are two important caveats:</p>
<ul class="simple">
<li>You must remove requiretty from your sudoers options.</li>
<li>Prompting for the sudo password is not yet supported, so the NOPASSWD option is required for sudo&#8217;ed commands.</li>
</ul>
<p>As of Ansible version <cite>1.6</cite>, you can also allow the use of multiple keys for connections from multiple Ansible management nodes. To do so, add the following option
to your <cite>ansible.cfg</cite> configuration:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">accelerate_multi_key</span> <span class="o">=</span> yes
</pre></div>
</div>
<p>When enabled, the daemon will open a UNIX socket file (by default <cite>$ANSIBLE_REMOTE_TEMP/.ansible-accelerate/.local.socket</cite>). New connections over SSH can
use this socket file to upload new keys to the daemon.</p>
</div>
</div>
<span id="document-playbooks_async"></span><div class="section" id="asynchronous-actions-and-polling">
<h4>Asynchronous Actions and Polling<a class="headerlink" href="#asynchronous-actions-and-polling" title="Permalink to this headline">¶</a></h4>
<p>By default tasks in playbooks block, meaning the connections stay open
until the task is done on each node.  This may not always be desirable, or you may
be running operations that take longer than the SSH timeout.</p>
<p>The easiest way to do this is
to kick them off all at once and then poll until they are done.</p>
<p>You will also want to use asynchronous mode on very long running
operations that might be subject to timeout.</p>
<p>To launch a task asynchronously, specify its maximum runtime
and how frequently you would like to poll for status.  The default
poll value is 10 seconds if you do not specify a value for <cite>poll</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: all
  remote_user: root

  tasks:

  - name: simulate long running op <span class="o">(</span><span class="m">15</span> sec<span class="o">)</span>, <span class="nb">wait</span> <span class="k">for</span> up to <span class="m">45</span> sec, poll every <span class="m">5</span> sec
    command: /bin/sleep <span class="m">15</span>
    async: <span class="m">45</span>
    poll: <span class="m">5</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no default for the async time limit.  If you leave off the
&#8216;async&#8217; keyword, the task runs synchronously, which is Ansible&#8217;s
default.</p>
</div>
<p>Alternatively, if you do not need to wait on the task to complete, you may
&#8220;fire and forget&#8221; by specifying a poll value of 0:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: all
  remote_user: root

  tasks:

  - name: simulate long running op, allow to run <span class="k">for</span> <span class="m">45</span> sec, fire and forget
    command: /bin/sleep <span class="m">15</span>
    async: <span class="m">45</span>
    poll: <span class="m">0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You shouldn&#8217;t &#8220;fire and forget&#8221; with operations that require
exclusive locks, such as yum transactions, if you expect to run other
commands later in the playbook against those same resources.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Using a higher value for <code class="docutils literal"><span class="pre">--forks</span></code> will result in kicking off asynchronous
tasks even faster.  This also increases the efficiency of polling.</p>
</div>
<p>If you would like to perform a variation of the &#8220;fire and forget&#8221; where you
&#8220;fire and forget, check on it later&#8221; you can perform a task similar to the
following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># Requires ansible 1.8+</span>
- name: <span class="s1">&#39;YUM - fire and forget task&#39;</span>
  yum: <span class="nv">name</span><span class="o">=</span>docker-io <span class="nv">state</span><span class="o">=</span>installed
  async: <span class="m">1000</span>
  poll: <span class="m">0</span>
  register: yum_sleeper

- name: <span class="s1">&#39;YUM - check on fire and forget task&#39;</span>
  async_status: <span class="nv">jid</span><span class="o">={{</span> yum_sleeper.ansible_job_id <span class="o">}}</span>
  register: job_result
  <span class="k">until</span>: job_result.finished
  retries: <span class="m">30</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the value of <code class="docutils literal"><span class="pre">async:</span></code> is not high enough, this will cause the
&#8220;check on it later&#8221; task to fail because the temporary status file that
the <code class="docutils literal"><span class="pre">async_status:</span></code> is looking for will not have been written or no longer exist</p>
</div>
<p>If you would like to run multiple asynchronous tasks while limiting the amount
of tasks running concurrently, you can do it this way:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1">#####################</span>
<span class="c1"># main.yml</span>
<span class="c1">#####################</span>
- name: Run items asynchronously in batch of two items
  vars:
    sleep_durations:
      - <span class="m">1</span>
      - <span class="m">2</span>
      - <span class="m">3</span>
      - <span class="m">4</span>
      - <span class="m">5</span>
    durations: <span class="s2">&quot;{{ item }}&quot;</span>
  include_tasks: execute_batch.yml
  with_items:
    - <span class="s2">&quot;{{ sleep_durations | batch(2) | list }}&quot;</span>

<span class="c1">#####################</span>
<span class="c1"># execute_batch.yml</span>
<span class="c1">#####################</span>
- name: Async sleeping <span class="k">for</span> batched_items
  command: sleep <span class="o">{{</span> async_item <span class="o">}}</span>
  async: <span class="m">45</span>
  poll: <span class="m">0</span>
  with_items: <span class="s2">&quot;{{ durations }}&quot;</span>
  loop_control:
    loop_var: <span class="s2">&quot;async_item&quot;</span>
  register: async_results

- name: Check sync status
  async_status:
    jid: <span class="s2">&quot;{{ async_result_item.ansible_job_id }}&quot;</span>
  with_items: <span class="s2">&quot;{{ async_results.results }}&quot;</span>
  loop_control:
    loop_var: <span class="s2">&quot;async_result_item&quot;</span>
  register: async_poll_results
  <span class="k">until</span>: async_poll_results.finished
  retries: <span class="m">30</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-playbooks_checkmode"></span><div class="section" id="check-mode-dry-run">
<span id="check-mode-dry"></span><h4><a class="toc-backref" href="#id1">Check Mode (&#8220;Dry Run&#8221;)</a><a class="headerlink" href="#check-mode-dry-run" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1.</span></p>
</div>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#check-mode-dry-run" id="id1">Check Mode (&#8220;Dry Run&#8221;)</a><ul>
<li><a class="reference internal" href="#enabling-or-disabling-check-mode-for-tasks" id="id2">Enabling or disabling check mode for tasks</a></li>
<li><a class="reference internal" href="#information-about-check-mode-in-variables" id="id3">Information about check mode in variables</a></li>
<li><a class="reference internal" href="#showing-differences-with-diff" id="id4">Showing Differences with <code class="docutils literal"><span class="pre">--diff</span></code></a></li>
</ul>
</li>
</ul>
</div>
<p>When ansible-playbook is executed with <code class="docutils literal"><span class="pre">--check</span></code> it will not make any changes on remote systems.  Instead, any module
instrumented to support &#8216;check mode&#8217; (which contains most of the primary core modules, but it is not required that all modules do
this) will report what changes they would have made rather than making them.  Other modules that do not support check mode will also take no action, but just will not report what changes they might have made.</p>
<p>Check mode is just a simulation, and if you have steps that use conditionals that depend on the results of prior commands,
it may be less useful for you.  However it is great for one-node-at-time basic configuration management use cases.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook foo.yml --check
</pre></div>
</div>
<div class="section" id="enabling-or-disabling-check-mode-for-tasks">
<span id="forcing-to-run-in-check-mode"></span><h5><a class="toc-backref" href="#id2">Enabling or disabling check mode for tasks</a><a class="headerlink" href="#enabling-or-disabling-check-mode-for-tasks" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>Sometimes you may want to modify the check mode behavior of individual tasks. This is done via the <code class="docutils literal"><span class="pre">check_mode</span></code> option, which can
be added to tasks.</p>
<p>There are two options:</p>
<ol class="arabic simple">
<li>Force a task to <strong>run in check mode</strong>, even when the playbook is called <strong>without</strong> <code class="docutils literal"><span class="pre">--check</span></code>. This is called <code class="docutils literal"><span class="pre">check_mode:</span> <span class="pre">yes</span></code>.</li>
<li>Force a task to <strong>run in normal mode</strong> and make changes to the system, even when the playbook is called <strong>with</strong> <code class="docutils literal"><span class="pre">--check</span></code>. This is called <code class="docutils literal"><span class="pre">check_mode:</span> <span class="pre">no</span></code>.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Prior to version 2.2 only the equivalent of <code class="docutils literal"><span class="pre">check_mode:</span> <span class="pre">no</span></code> existed. The notation for that was <code class="docutils literal"><span class="pre">always_run:</span> <span class="pre">yes</span></code>.</p>
</div>
<p>Instead of <code class="docutils literal"><span class="pre">yes</span></code>/<code class="docutils literal"><span class="pre">no</span></code> you can use a Jinja2 expression, just like the <code class="docutils literal"><span class="pre">when</span></code> clause.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

  - name: this task will make changes to the system even in check mode
    command: /something/to/run --even-in-check-mode
    check_mode: no

  - name: this task will always run under checkmode and not change the system
    lineinfile: <span class="nv">line</span><span class="o">=</span><span class="s2">&quot;important config&quot;</span> <span class="nv">dest</span><span class="o">=</span>/path/to/myconfig.conf <span class="nv">state</span><span class="o">=</span>present
    check_mode: yes
</pre></div>
</div>
<p>Running single tasks with <code class="docutils literal"><span class="pre">check_mode:</span> <span class="pre">yes</span></code> can be useful to write tests for
ansible modules, either to test the module itself or to the conditions under
which a module would make changes.
With <code class="docutils literal"><span class="pre">register</span></code> (see <a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a>) you can check the
potential changes.</p>
</div>
<div class="section" id="information-about-check-mode-in-variables">
<h5><a class="toc-backref" href="#id3">Information about check mode in variables</a><a class="headerlink" href="#information-about-check-mode-in-variables" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
<p>If you want to skip, or ignore errors on some tasks in check mode
you can use a boolean magic variable <code class="docutils literal"><span class="pre">ansible_check_mode</span></code>
which will be set to <code class="docutils literal"><span class="pre">True</span></code> during check mode.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

  - name: this task will be skipped in check mode
    git: <span class="nv">repo</span><span class="o">=</span>ssh://git@github.com/mylogin/hello.git <span class="nv">dest</span><span class="o">=</span>/home/mylogin/hello
    when: not ansible_check_mode

  - name: this task will ignore errors in check mode
    git: <span class="nv">repo</span><span class="o">=</span>ssh://git@github.com/mylogin/hello.git <span class="nv">dest</span><span class="o">=</span>/home/mylogin/hello
    ignore_errors: <span class="s2">&quot;{{ ansible_check_mode }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="showing-differences-with-diff">
<span id="diff-mode"></span><h5><a class="toc-backref" href="#id4">Showing Differences with <code class="docutils literal"><span class="pre">--diff</span></code></a><a class="headerlink" href="#showing-differences-with-diff" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1.</span></p>
</div>
<p>The <code class="docutils literal"><span class="pre">--diff</span></code> option to ansible-playbook works great with <code class="docutils literal"><span class="pre">--check</span></code> (detailed above) but can also be used by itself.
When this flag is supplied and the module supports this, Ansible will report back the changes made or, if used with <code class="docutils literal"><span class="pre">--check</span></code>, the changes that would have been made.
This is mostly used in modules that manipulate files (i.e. template) but other modules might also show &#8216;before and after&#8217; information (i.e. user).
Since the diff feature produces a large amount of output, it is best used when checking a single host at a time. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook foo.yml --check --diff --limit foo.example.com
</pre></div>
</div>
</div>
</div>
<span id="document-playbooks_debugger"></span><div class="section" id="playbook-debugger">
<h4><a class="toc-backref" href="#id2">Playbook Debugger</a><a class="headerlink" href="#playbook-debugger" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#playbook-debugger" id="id2">Playbook Debugger</a><ul>
<li><a class="reference internal" href="#available-commands" id="id3">Available Commands</a><ul>
<li><a class="reference internal" href="#p-task-vars-host-result" id="id4">p <em>task/vars/host/result</em></a></li>
<li><a class="reference internal" href="#task-args-key-value" id="id5">task.args[<em>key</em>] = <em>value</em></a></li>
<li><a class="reference internal" href="#vars-key-value" id="id6">vars[<em>key</em>] = <em>value</em></a></li>
<li><a class="reference internal" href="#r-edo" id="id7">r(edo)</a></li>
<li><a class="reference internal" href="#c-ontinue" id="id8">c(ontinue)</a></li>
<li><a class="reference internal" href="#q-uit" id="id9">q(uit)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>In 2.1 we added a <code class="docutils literal"><span class="pre">debug</span></code> strategy. This strategy enables you to invoke a debugger when a task has
failed.  You have access to all of the features of the debugger in the context of the failed task.  You can then, for example, check or set the value of variables, update module arguments, and re-run the failed task with the new variables and arguments to help resolve the cause of the failure.</p>
<p>To use the <code class="docutils literal"><span class="pre">debug</span></code> strategy, change the <code class="docutils literal"><span class="pre">strategy</span></code> attribute like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: <span class="nb">test</span>
  strategy: debug
  tasks:
  ...
</pre></div>
</div>
<p>For example, run the playbook below:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: <span class="nb">test</span>
  strategy: debug
  gather_facts: no
  vars:
    var1: value1
  tasks:
    - name: wrong variable
      ping: <span class="nv">data</span><span class="o">={{</span> wrong_var <span class="o">}}</span>
</pre></div>
</div>
<p>The debugger is invoked since the <em>wrong_var</em> variable is undefined.</p>
<p>Let&#8217;s change the module&#8217;s arguments and run the task again</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>PLAY ***************************************************************************

TASK [wrong variable] **********************************************************
fatal: [192.0.2.10]: FAILED! =&gt; {&quot;failed&quot;: true, &quot;msg&quot;: &quot;ERROR! &#39;wrong_var&#39; is undefined&quot;}
Debugger invoked
(debug) p result
{&#39;msg&#39;: u&quot;ERROR! &#39;wrong_var&#39; is undefined&quot;, &#39;failed&#39;: True}
(debug) p task.args
{u&#39;data&#39;: u&#39;{{ wrong_var }}&#39;}
(debug) task.args[&#39;data&#39;] = &#39;{{ var1 }}&#39;
(debug) p task.args
{u&#39;data&#39;: &#39;{{ var1 }}&#39;}
(debug) redo
ok: [192.0.2.10]

PLAY RECAP *********************************************************************
192.0.2.10               : ok=1    changed=0    unreachable=0    failed=0
</pre></div>
</div>
<p>This time, the task runs successfully!</p>
<div class="section" id="available-commands">
<span id="id1"></span><h5><a class="toc-backref" href="#id3">Available Commands</a><a class="headerlink" href="#available-commands" title="Permalink to this headline">¶</a></h5>
<div class="section" id="p-task-vars-host-result">
<span id="p-command"></span><h6><a class="toc-backref" href="#id4">p <em>task/vars/host/result</em></a><a class="headerlink" href="#p-task-vars-host-result" title="Permalink to this headline">¶</a></h6>
<p>Print values used to execute a module:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>debug<span class="o">)</span> p task
TASK: install package
<span class="o">(</span>debug<span class="o">)</span> p task.args
<span class="o">{</span>u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;{{ pkg_name }}&#39;</span><span class="o">}</span>
<span class="o">(</span>debug<span class="o">)</span> p vars
<span class="o">{</span>u<span class="s1">&#39;ansible_all_ipv4_addresses&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;192.0.2.10&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;ansible_architecture&#39;</span>: u<span class="s1">&#39;x86_64&#39;</span>,
 ...
<span class="o">}</span>
<span class="o">(</span>debug<span class="o">)</span> p vars<span class="o">[</span><span class="s1">&#39;pkg_name&#39;</span><span class="o">]</span>
u<span class="s1">&#39;bash&#39;</span>
<span class="o">(</span>debug<span class="o">)</span> p host
<span class="m">192</span>.0.2.10
<span class="o">(</span>debug<span class="o">)</span> p result
<span class="o">{</span><span class="s1">&#39;_ansible_no_log&#39;</span>: False,
 <span class="s1">&#39;changed&#39;</span>: False,
 u<span class="s1">&#39;failed&#39;</span>: True,
 ...
 u<span class="s1">&#39;msg&#39;</span>: u<span class="s2">&quot;No package matching &#39;not_exist&#39; is available&quot;</span><span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="task-args-key-value">
<span id="update-args-command"></span><h6><a class="toc-backref" href="#id5">task.args[<em>key</em>] = <em>value</em></a><a class="headerlink" href="#task-args-key-value" title="Permalink to this headline">¶</a></h6>
<p>Update module&#8217;s argument.</p>
<p>If you run a playbook like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: <span class="nb">test</span>
  strategy: debug
  gather_facts: yes
  vars:
    pkg_name: not_exist
  tasks:
    - name: install package
      apt: <span class="nv">name</span><span class="o">={{</span> pkg_name <span class="o">}}</span>
</pre></div>
</div>
<p>Debugger is invoked due to wrong package name, so let&#8217;s fix the module&#8217;s args:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>debug<span class="o">)</span> p task.args
<span class="o">{</span>u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;{{ pkg_name }}&#39;</span><span class="o">}</span>
<span class="o">(</span>debug<span class="o">)</span> task.args<span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bash&#39;</span>
<span class="o">(</span>debug<span class="o">)</span> p task.args
<span class="o">{</span>u<span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;bash&#39;</span><span class="o">}</span>
<span class="o">(</span>debug<span class="o">)</span> redo
</pre></div>
</div>
<p>Then the task runs again with new args.</p>
</div>
<div class="section" id="vars-key-value">
<span id="update-vars-command"></span><h6><a class="toc-backref" href="#id6">vars[<em>key</em>] = <em>value</em></a><a class="headerlink" href="#vars-key-value" title="Permalink to this headline">¶</a></h6>
<p>Update vars.</p>
<p>Let&#8217;s use the same playbook above, but fix vars instead of args:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>debug<span class="o">)</span> p vars<span class="o">[</span><span class="s1">&#39;pkg_name&#39;</span><span class="o">]</span>
u<span class="s1">&#39;not_exist&#39;</span>
<span class="o">(</span>debug<span class="o">)</span> vars<span class="o">[</span><span class="s1">&#39;pkg_name&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bash&#39;</span>
<span class="o">(</span>debug<span class="o">)</span> p vars<span class="o">[</span><span class="s1">&#39;pkg_name&#39;</span><span class="o">]</span>
<span class="s1">&#39;bash&#39;</span>
<span class="o">(</span>debug<span class="o">)</span> redo
</pre></div>
</div>
<p>Then the task runs again with new vars.</p>
</div>
<div class="section" id="r-edo">
<span id="redo-command"></span><h6><a class="toc-backref" href="#id7">r(edo)</a><a class="headerlink" href="#r-edo" title="Permalink to this headline">¶</a></h6>
<p>Run the task again.</p>
</div>
<div class="section" id="c-ontinue">
<span id="continue-command"></span><h6><a class="toc-backref" href="#id8">c(ontinue)</a><a class="headerlink" href="#c-ontinue" title="Permalink to this headline">¶</a></h6>
<p>Just continue.</p>
</div>
<div class="section" id="q-uit">
<span id="quit-command"></span><h6><a class="toc-backref" href="#id9">q(uit)</a><a class="headerlink" href="#q-uit" title="Permalink to this headline">¶</a></h6>
<p>Quit from the debugger. The playbook execution is aborted.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-playbooks_delegation"></span><div class="section" id="delegation-rolling-updates-and-local-actions">
<h4><a class="toc-backref" href="#id7">Delegation, Rolling Updates, and Local Actions</a><a class="headerlink" href="#delegation-rolling-updates-and-local-actions" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#delegation-rolling-updates-and-local-actions" id="id7">Delegation, Rolling Updates, and Local Actions</a><ul>
<li><a class="reference internal" href="#rolling-update-batch-size" id="id8">Rolling Update Batch Size</a></li>
<li><a class="reference internal" href="#maximum-failure-percentage" id="id9">Maximum Failure Percentage</a></li>
<li><a class="reference internal" href="#delegation" id="id10">Delegation</a></li>
<li><a class="reference internal" href="#delegated-facts" id="id11">Delegated facts</a></li>
<li><a class="reference internal" href="#run-once" id="id12">Run Once</a></li>
<li><a class="reference internal" href="#local-playbooks" id="id13">Local Playbooks</a></li>
<li><a class="reference internal" href="#interrupt-execution-on-any-error" id="id14">Interrupt execution on any error</a></li>
</ul>
</li>
</ul>
</div>
<p>Being designed for multi-tier deployments since the beginning, Ansible is great at doing things on one host on behalf of another, or doing local steps with reference to some remote hosts.</p>
<p>This in particular is very applicable when setting up continuous deployment infrastructure or zero downtime rolling updates, where you might be talking with load balancers or monitoring systems.</p>
<p>Additional features allow for tuning the orders in which things complete, and assigning a batch window size for how many machines to process at once during a rolling update.</p>
<p>This section covers all of these features.  For examples of these items in use, <a class="reference external" href="https://github.com/ansible/ansible-examples/">please see the ansible-examples repository</a>. There are quite a few examples of zero-downtime update procedures for different kinds of applications.</p>
<p>You should also consult the <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> section, various modules like &#8216;ec2_elb&#8217;, &#8216;nagios&#8217;, and &#8216;bigip_pool&#8217;, and &#8216;netscaler&#8217; dovetail neatly with the concepts mentioned here.</p>
<p>You&#8217;ll also want to read up on <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a>, as the &#8216;pre_task&#8217; and &#8216;post_task&#8217; concepts are the places where you would typically call these modules.</p>
<p>Be aware that certain tasks are impossible to delegate, i.e. <cite>include</cite>, <cite>add_host</cite>, <cite>debug</cite>, etc as they always execute on the controller.</p>
<div class="section" id="rolling-update-batch-size">
<span id="id1"></span><h5><a class="toc-backref" href="#id8">Rolling Update Batch Size</a><a class="headerlink" href="#rolling-update-batch-size" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7.</span></p>
</div>
<p>By default, Ansible will try to manage all of the machines referenced in a play in parallel.  For a rolling updates
use case, you can define how many hosts Ansible should manage at a single time by using the &#8216;&#8217;serial&#8217;&#8217; keyword:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> play
  hosts: webservers
  serial: <span class="m">3</span>
</pre></div>
</div>
<p>In the above example, if we had 100 hosts, 3 hosts in the group &#8216;webservers&#8217;
would complete the play completely before moving on to the next 3 hosts.</p>
<p>The &#8216;&#8217;serial&#8217;&#8217; keyword can also be specified as a percentage in Ansible 1.8 and later, which will be applied to the total number of hosts in a
play, in order to determine the number of hosts per pass:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> play
  hosts: webservers
  serial: <span class="s2">&quot;30%&quot;</span>
</pre></div>
</div>
<p>If the number of hosts does not divide equally into the number of passes, the final pass will contain the remainder.</p>
<p>As of Ansible 2.2, the batch sizes can be specified as a list, as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> play
  hosts: webservers
  serial:
  - <span class="m">1</span>
  - <span class="m">5</span>
  - <span class="m">10</span>
</pre></div>
</div>
<p>In the above example, the first batch would contain a single host, the next would contain 5 hosts, and (if there are any hosts left),
every following batch would contain 10 hosts until all available hosts are used.</p>
<p>It is also possible to list multiple batch sizes as percentages:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> play
  hosts: webservers
  serial:
  - <span class="s2">&quot;10%&quot;</span>
  - <span class="s2">&quot;20%&quot;</span>
  - <span class="s2">&quot;100%&quot;</span>
</pre></div>
</div>
<p>You can also mix and match the values:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> play
  hosts: webservers
  serial:
  - <span class="m">1</span>
  - <span class="m">5</span>
  - <span class="s2">&quot;20%&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">No matter how small the percentage, the number of hosts per pass will always be 1 or greater.</p>
</div>
</div>
<div class="section" id="maximum-failure-percentage">
<span id="id2"></span><h5><a class="toc-backref" href="#id9">Maximum Failure Percentage</a><a class="headerlink" href="#maximum-failure-percentage" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>By default, Ansible will continue executing actions as long as there are hosts in the group that have not yet failed.
In some situations, such as with the rolling updates described above, it may be desirable to abort the play when a
certain threshold of failures have been reached. To achieve this, as of version 1.3 you can set a maximum failure
percentage on a play as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: webservers
  max_fail_percentage: <span class="m">30</span>
  serial: <span class="m">10</span>
</pre></div>
</div>
<p>In the above example, if more than 3 of the 10 servers in the group were to fail, the rest of the play would be aborted.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The percentage set must be exceeded, not equaled. For example, if serial were set to 4 and you wanted the task to abort
when 2 of the systems failed, the percentage should be set at 49 rather than 50.</p>
</div>
</div>
<div class="section" id="delegation">
<span id="id3"></span><h5><a class="toc-backref" href="#id10">Delegation</a><a class="headerlink" href="#delegation" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7.</span></p>
</div>
<p>This isn&#8217;t actually rolling update specific but comes up frequently in those cases.</p>
<p>If you want to perform a task on one host with reference to other hosts, use the &#8216;delegate_to&#8217; keyword on a task.
This is ideal for placing nodes in a load balanced pool, or removing them.  It is also very useful for controlling outage windows.
Be aware that it does not make sense to delegate all tasks, debug, add_host, include, etc always get executed on the controller.
Using this with the &#8216;serial&#8217; keyword to control the number of hosts executing at one time is also a good idea:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  serial: <span class="m">5</span>

  tasks:

  - name: take out of load balancer pool
    command: /usr/bin/take_out_of_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
    delegate_to: <span class="m">127</span>.0.0.1

  - name: actual steps would go here
    yum: <span class="nv">name</span><span class="o">=</span>acme-web-stack <span class="nv">state</span><span class="o">=</span>latest

  - name: add back to load balancer pool
    command: /usr/bin/add_back_to_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
    delegate_to: <span class="m">127</span>.0.0.1
</pre></div>
</div>
<p>These commands will run on 127.0.0.1, which is the machine running Ansible. There is also a shorthand syntax that you can use on a per-task basis: &#8216;local_action&#8217;. Here is the same playbook as above, but using the shorthand syntax for delegating to 127.0.0.1:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

<span class="c1"># ...</span>

  tasks:

  - name: take out of load balancer pool
    local_action: <span class="nb">command</span> /usr/bin/take_out_of_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>

<span class="c1"># ...</span>

  - name: add back to load balancer pool
    local_action: <span class="nb">command</span> /usr/bin/add_back_to_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
</pre></div>
</div>
<p>A common pattern is to use a local action to call &#8216;rsync&#8217; to recursively copy files to the managed servers.
Here is an example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># ...</span>
  tasks:

  - name: recursively copy files from management server to target
    local_action: <span class="nb">command</span> rsync -a /path/to/files <span class="o">{{</span> inventory_hostname <span class="o">}}</span>:/path/to/target/
</pre></div>
</div>
<p>Note that you must have passphrase-less SSH keys or an ssh-agent configured for this to work, otherwise rsync
will need to ask for a passphrase.</p>
<p>In case you have to specify more arguments you can use the following syntax:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># ...</span>
  tasks:

  - name: Send summary mail
    local_action:
      module: mail
      subject: <span class="s2">&quot;Summary Mail&quot;</span>
      to: <span class="s2">&quot;{{ mail_recipient }}&quot;</span>
      body: <span class="s2">&quot;{{ mail_body }}&quot;</span>
    run_once: True
</pre></div>
</div>
<p>The <cite>ansible_host</cite> variable (<cite>ansible_ssh_host</cite> in 1.x or specific to ssh/paramiko plugins) reflects the host a task is delegated to.</p>
</div>
<div class="section" id="delegated-facts">
<span id="delegate-facts"></span><h5><a class="toc-backref" href="#id11">Delegated facts</a><a class="headerlink" href="#delegated-facts" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.0.</span></p>
</div>
<p>By default, any fact gathered by a delegated task are assigned to the <cite>inventory_hostname</cite> (the current host) instead of the host which actually produced the facts (the delegated to host).
In 2.0, the directive <cite>delegate_facts</cite> may be set to <cite>True</cite> to assign the task&#8217;s gathered facts to the delegated host instead of the current one.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: app_servers
  tasks:
    - name: gather facts from db servers
      setup:
      delegate_to: <span class="s2">&quot;{{item}}&quot;</span>
      delegate_facts: True
      with_items: <span class="s2">&quot;{{groups[&#39;dbservers&#39;]}}&quot;</span>
</pre></div>
</div>
<p>The above will gather facts for the machines in the dbservers group and assign the facts to those machines and not to app_servers.
This way you can lookup <cite>hostvars[&#8216;dbhost1&#8217;][&#8216;default_ipv4&#8217;][&#8216;address&#8217;]</cite> even though dbservers were not part of the play, or left out by using <cite>&#8211;limit</cite>.</p>
</div>
<div class="section" id="run-once">
<span id="id4"></span><h5><a class="toc-backref" href="#id12">Run Once</a><a class="headerlink" href="#run-once" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.7.</span></p>
</div>
<p>In some cases there may be a need to only run a task one time and only on one host. This can be achieved
by configuring &#8220;run_once&#8221; on a task:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># ...</span>

  tasks:

    <span class="c1"># ...</span>

    - command: /opt/application/upgrade_db.py
      run_once: <span class="nb">true</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
<p>This can be optionally paired with &#8220;delegate_to&#8221; to specify an individual host to execute on:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- command: /opt/application/upgrade_db.py
  run_once: <span class="nb">true</span>
  delegate_to: web01.example.org
</pre></div>
</div>
<p>When &#8220;run_once&#8221; is not used with &#8220;delegate_to&#8221; it will execute on the first host, as defined by inventory,
in the group(s) of hosts targeted by the play - e.g. webservers[0] if the play targeted &#8220;hosts: webservers&#8221;.</p>
<p>This approach is similar to applying a conditional to a task such as:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- command: /opt/application/upgrade_db.py
  when: <span class="nv">inventory_hostname</span> <span class="o">==</span> webservers<span class="o">[</span><span class="m">0</span><span class="o">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When used together with &#8220;serial&#8221;, tasks marked as &#8220;run_once&#8221; will be run on one host in <em>each</em> serial batch.
If it&#8217;s crucial that the task is run only once regardless of &#8220;serial&#8221; mode, use
<code class="code docutils literal"><span class="pre">when:</span> <span class="pre">inventory_hostname</span> <span class="pre">==</span> <span class="pre">ansible_play_hosts[0]</span></code> construct.</p>
</div>
</div>
<div class="section" id="local-playbooks">
<span id="id5"></span><h5><a class="toc-backref" href="#id13">Local Playbooks</a><a class="headerlink" href="#local-playbooks" title="Permalink to this headline">¶</a></h5>
<p>It may be useful to use a playbook locally, rather than by connecting over SSH.  This can be useful
for assuring the configuration of a system by putting a playbook in a crontab.  This may also be used
to run a playbook inside an OS installer, such as an Anaconda kickstart.</p>
<p>To run an entire playbook locally, just set the &#8220;hosts:&#8221; line to &#8220;hosts: 127.0.0.1&#8221; and then run the playbook like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook playbook.yml --connection<span class="o">=</span><span class="nb">local</span>
</pre></div>
</div>
<p>Alternatively, a local connection can be used in a single playbook play, even if other plays in the playbook
use the default remote connection type:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: <span class="m">127</span>.0.0.1
  connection: <span class="nb">local</span>
</pre></div>
</div>
</div>
<div class="section" id="interrupt-execution-on-any-error">
<span id="id6"></span><h5><a class="toc-backref" href="#id14">Interrupt execution on any error</a><a class="headerlink" href="#interrupt-execution-on-any-error" title="Permalink to this headline">¶</a></h5>
<p>With the &#8216;&#8217;any_errors_fatal&#8217;&#8217; option, any failure on any host in a multi-host play will be treated as fatal and Ansible will exit immediately without waiting for the other hosts.</p>
<p>Sometimes &#8216;&#8217;serial&#8217;&#8217; execution is unsuitable; the number of hosts is unpredictable (because of dynamic inventory) and speed is crucial (simultaneous execution is required), but all tasks must be 100% successful to continue playbook execution.</p>
<p>For example, consider a service located in many datacenters with some load balancers to pass traffic from users to the service. There is a deploy playbook to upgrade service deb-packages. The playbook has the stages:</p>
<ul class="simple">
<li>disable traffic on load balancers (must be turned off simultaneously)</li>
<li>gracefully stop the service</li>
<li>upgrade software (this step includes tests and starting the service)</li>
<li>enable traffic on the load balancers (which should be turned on simultaneously)</li>
</ul>
<p>The service can&#8217;t be stopped with &#8220;alive&#8221; load balancers; they must be disabled first. Because of this, the second stage can&#8217;t be played if any server failed in the first stage.</p>
<p>For datacenter &#8220;A&#8221;, the playbook can be written this way:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: load_balancers_dc_a
  any_errors_fatal: True
  tasks:
  - name: <span class="s1">&#39;shutting down datacenter [ A ]&#39;</span>
    command: /usr/bin/disable-dc

- hosts: frontends_dc_a
  tasks:
  - name: <span class="s1">&#39;stopping service&#39;</span>
    command: /usr/bin/stop-software
  - name: <span class="s1">&#39;updating software&#39;</span>
    command: /usr/bin/upgrade-software

- hosts: load_balancers_dc_a
  tasks:
  - name: <span class="s1">&#39;Starting datacenter [ A ]&#39;</span>
    command: /usr/bin/enable-dc
</pre></div>
</div>
<p>In this example Ansible will start the software upgrade on the front ends only if all of the load balancers are successfully disabled.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">Ansible Examples on GitHub</a></dt>
<dd>Many examples of full-stack deployments</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_environment"></span><div class="section" id="setting-the-environment-and-working-with-proxies">
<h4>Setting the Environment (and Working With Proxies)<a class="headerlink" href="#setting-the-environment-and-working-with-proxies" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1.</span></p>
</div>
<p>It is quite possible that you may need to get package updates through a proxy, or even get some package
updates through a proxy and access other packages not through a proxy.  Or maybe a script you might wish to
call may also need certain environment variables set to run properly.</p>
<p>Ansible makes it easy for you to configure your environment by using the &#8216;environment&#8217; keyword.  Here is an example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  remote_user: root

  tasks:

    - apt: <span class="nv">name</span><span class="o">=</span>cobbler <span class="nv">state</span><span class="o">=</span>installed
      environment:
        http_proxy: http://proxy.example.com:8080
</pre></div>
</div>
<p>The environment can also be stored in a variable, and accessed like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  remote_user: root

  <span class="c1"># here we make a variable named &quot;proxy_env&quot; that is a dictionary</span>
  vars:
    proxy_env:
      http_proxy: http://proxy.example.com:8080

  tasks:

    - apt: <span class="nv">name</span><span class="o">=</span>cobbler <span class="nv">state</span><span class="o">=</span>installed
      environment: <span class="s2">&quot;{{proxy_env}}&quot;</span>
</pre></div>
</div>
<p>You can also use it at a play level:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: testhost

  roles:
     - php
     - nginx

  environment:
    http_proxy: http://proxy.example.com:8080
</pre></div>
</div>
<p>While just proxy settings were shown above, any number of settings can be supplied.  The most logical place
to define an environment hash might be a group_vars file, like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: group_vars/boston</span>

ntp_server: ntp.bos.example.com
backup: bak.bos.example.com
proxy_env:
  http_proxy: http://proxy.bos.example.com:8080
  https_proxy: http://proxy.bos.example.com:8080
</pre></div>
</div>
</div>
<div class="section" id="working-with-language-specific-version-managers">
<h4>Working With Language-Specific Version Managers<a class="headerlink" href="#working-with-language-specific-version-managers" title="Permalink to this headline">¶</a></h4>
<p>Some language-specific version managers (such as rbenv and nvm) require environment variables be set while these tools are in use. When using these tools manually, they usually require sourcing some environment variables via a script or lines added to your shell configuration file. In Ansible, you can instead use the environment directive:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1">### A playbook demonstrating a common npm workflow:</span>
<span class="c1"># - Check for package.json in the application directory</span>
<span class="c1"># - If package.json exists:</span>
<span class="c1">#   * Run npm prune</span>
<span class="c1">#   * Run npm install</span>

- hosts: application
  become: <span class="nb">false</span>

  vars:
    node_app_dir: /var/local/my_node_app

  environment:
    NVM_DIR: /var/local/nvm
    PATH: /var/local/nvm/versions/node/v4.2.1/bin:<span class="o">{{</span> ansible_env.PATH <span class="o">}}</span>

  tasks:
  - name: check <span class="k">for</span> package.json
    stat:
      path: <span class="s1">&#39;{{ node_app_dir }}/package.json&#39;</span>
    register: packagejson

  - name: npm prune
    command: npm prune
    args:
      chdir: <span class="s1">&#39;{{ node_app_dir }}&#39;</span>
    when: packagejson.stat.exists

  - name: npm install
    npm:
      path: <span class="s1">&#39;{{ node_app_dir }}&#39;</span>
    when: packagejson.stat.exists
</pre></div>
</div>
<p>You might also want to simply specify the environment for a single task:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: install ruby <span class="m">2</span>.3.1
  command: rbenv install <span class="o">{{</span> rbenv_ruby_version <span class="o">}}</span>
  args:
    creates: <span class="s1">&#39;{{ rbenv_root }}/versions/{{ rbenv_ruby_version }}/bin/ruby&#39;</span>
  vars:
    rbenv_root: /usr/local/rbenv
    rbenv_ruby_version: <span class="m">2</span>.3.1
  environment:
    CONFIGURE_OPTS: <span class="s1">&#39;--disable-install-doc&#39;</span>
    RBENV_ROOT: <span class="s1">&#39;{{ rbenv_root }}&#39;</span>
    PATH: <span class="s1">&#39;{{ rbenv_root }}/bin:{{ rbenv_root }}/shims:{{ rbenv_plugins }}/ruby-build/bin:{{ ansible_env.PATH }}&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">environment:</span></code> is not currently supported for Windows targets</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-playbooks_error_handling"></span><div class="section" id="error-handling-in-playbooks">
<h4><a class="toc-backref" href="#id4">Error Handling In Playbooks</a><a class="headerlink" href="#error-handling-in-playbooks" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#error-handling-in-playbooks" id="id4">Error Handling In Playbooks</a><ul>
<li><a class="reference internal" href="#ignoring-failed-commands" id="id5">Ignoring Failed Commands</a></li>
<li><a class="reference internal" href="#resetting-unreachable-hosts" id="id6">Resetting Unreachable Hosts</a></li>
<li><a class="reference internal" href="#handlers-and-failure" id="id7">Handlers and Failure</a></li>
<li><a class="reference internal" href="#controlling-what-defines-failure" id="id8">Controlling What Defines Failure</a></li>
<li><a class="reference internal" href="#overriding-the-changed-result" id="id9">Overriding The Changed Result</a></li>
<li><a class="reference internal" href="#aborting-the-play" id="id10">Aborting the play</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible normally has defaults that make sure to check the return codes of commands and modules and
it fails fast &#8211; forcing an error to be dealt with unless you decide otherwise.</p>
<p>Sometimes a command that returns different than 0 isn&#8217;t an error.  Sometimes a command might not always
need to report that it &#8216;changed&#8217; the remote system.  This section describes how to change
the default behavior of Ansible for certain tasks so output and error handling behavior is
as desired.</p>
<div class="section" id="ignoring-failed-commands">
<span id="id1"></span><h5><a class="toc-backref" href="#id5">Ignoring Failed Commands</a><a class="headerlink" href="#ignoring-failed-commands" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.6.</span></p>
</div>
<p>Generally playbooks will stop executing any more steps on a host that has a task fail.
Sometimes, though, you want to continue on.  To do so, write a task that looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: this will not be counted as a failure
  command: /bin/false
  ignore_errors: yes
</pre></div>
</div>
<p>Note that the above system only governs the return value of failure of the particular task,
so if you have an undefined variable used or a syntax error, it will still raise an error that users will need to address.
Note that this will not prevent failures on connection or execution issues.
This feature only works when the task must be able to run and return a value of &#8216;failed&#8217;.</p>
</div>
<div class="section" id="resetting-unreachable-hosts">
<span id="resetting-unreachable"></span><h5><a class="toc-backref" href="#id6">Resetting Unreachable Hosts</a><a class="headerlink" href="#resetting-unreachable-hosts" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>Connection failures set hosts as &#8216;UNREACHABLE&#8217;, which will remove them from the list of active hosts for the run.
To recover from these issues you can use <cite>meta: clear_host_errors</cite> to have all currently flagged hosts reactivated,
so subsequent tasks can try to use them again.</p>
</div>
<div class="section" id="handlers-and-failure">
<span id="id2"></span><h5><a class="toc-backref" href="#id7">Handlers and Failure</a><a class="headerlink" href="#handlers-and-failure" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.1.</span></p>
</div>
<p>When a task fails on a host, handlers which were previously notified
will <em>not</em> be run on that host. This can lead to cases where an unrelated failure
can leave a host in an unexpected state. For example, a task could update
a configuration file and notify a handler to restart some service. If a
task later on in the same play fails, the service will not be restarted despite
the configuration change.</p>
<p>You can change this behavior with the <code class="docutils literal"><span class="pre">--force-handlers</span></code> command-line option,
or by including <code class="docutils literal"><span class="pre">force_handlers:</span> <span class="pre">True</span></code> in a play, or <code class="docutils literal"><span class="pre">force_handlers</span> <span class="pre">=</span> <span class="pre">True</span></code>
in ansible.cfg. When handlers are forced, they will run when notified even
if a task fails on that host. (Note that certain errors could still prevent
the handler from running, such as a host becoming unreachable.)</p>
</div>
<div class="section" id="controlling-what-defines-failure">
<span id="id3"></span><h5><a class="toc-backref" href="#id8">Controlling What Defines Failure</a><a class="headerlink" href="#controlling-what-defines-failure" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>Suppose the error code of a command is meaningless and to tell if there
is a failure what really matters is the output of the command, for instance
if the string &#8220;FAILED&#8221; is in the output.</p>
<p>Ansible in 1.4 and later provides a way to specify this behavior as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Fail task when the <span class="nb">command</span> error output prints FAILED
  command: /usr/bin/example-command -x -y -z
  register: command_result
  failed_when: <span class="s2">&quot;&#39;FAILED&#39; in command_result.stderr&quot;</span>
</pre></div>
</div>
<p>or based on the return code:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Fail task when both files are identical
  raw: diff foo/file1 bar/file2
  register: diff_cmd
  failed_when: diff_cmd.rc <span class="o">==</span> <span class="m">0</span> or diff_cmd.rc &gt;<span class="o">=</span> <span class="m">2</span>
</pre></div>
</div>
<p>In previous version of Ansible, this can be still be accomplished as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: this <span class="nb">command</span> prints FAILED when it fails
  command: /usr/bin/example-command -x -y -z
  register: command_result
  ignore_errors: True

- name: fail the play <span class="k">if</span> the previous <span class="nb">command</span> did not succeed
  fail: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;the command failed&quot;</span>
  when: <span class="s2">&quot;&#39;FAILED&#39; in command_result.stderr&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="overriding-the-changed-result">
<span id="override-the-changed-result"></span><h5><a class="toc-backref" href="#id9">Overriding The Changed Result</a><a class="headerlink" href="#overriding-the-changed-result" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>When a shell/command or other module runs it will typically report
&#8220;changed&#8221; status based on whether it thinks it affected machine state.</p>
<p>Sometimes you will know, based on the return code
or output that it did not make any changes, and wish to override
the &#8220;changed&#8221; result such that it does not appear in report output or
does not cause handlers to fire:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

  - shell: /usr/bin/billybass --mode<span class="o">=</span><span class="s2">&quot;take me to the river&quot;</span>
    register: bass_result
    changed_when: <span class="s2">&quot;bass_result.rc != 2&quot;</span>

  <span class="c1"># this will never report &#39;changed&#39; status</span>
  - shell: wall <span class="s1">&#39;beep&#39;</span>
    changed_when: False
</pre></div>
</div>
</div>
<div class="section" id="aborting-the-play">
<h5><a class="toc-backref" href="#id10">Aborting the play</a><a class="headerlink" href="#aborting-the-play" title="Permalink to this headline">¶</a></h5>
<p>Sometimes it&#8217;s desirable to abort the entire play on failure, not just skip remaining tasks for a host.</p>
<p>The <code class="docutils literal"><span class="pre">any_errors_fatal</span></code> play option will mark all hosts as failed if any fails, causing an immediate abort:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: somehosts
  any_errors_fatal: <span class="nb">true</span>
  roles:
    - myrole
</pre></div>
</div>
<p>for finer-grained control <code class="docutils literal"><span class="pre">max_fail_percentage</span></code> can be used to abort the run after a given percentage of hosts has failed.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_advanced_syntax"></span><div class="section" id="advanced-syntax">
<h4><a class="toc-backref" href="#id2">Advanced Syntax</a><a class="headerlink" href="#advanced-syntax" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#advanced-syntax" id="id2">Advanced Syntax</a><ul>
<li><a class="reference internal" href="#yaml-tags-and-python-types" id="id3">YAML tags and Python types</a><ul>
<li><a class="reference internal" href="#unsafe-or-raw-strings" id="id4">Unsafe or Raw Strings</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>This page describes advanced YAML syntax that enables you to have more control over the data placed in YAML files used by Ansible.</p>
<div class="section" id="yaml-tags-and-python-types">
<span id="id1"></span><h5><a class="toc-backref" href="#id3">YAML tags and Python types</a><a class="headerlink" href="#yaml-tags-and-python-types" title="Permalink to this headline">¶</a></h5>
<p>The documentation covered here is an extension of the documentation that can be found in the <a class="reference external" href="http://pyyaml.org/wiki/PyYAMLDocumentation#YAMLtagsandPythontypes">PyYAML Documentation</a></p>
<div class="section" id="unsafe-or-raw-strings">
<span id="unsafe-strings"></span><h6><a class="toc-backref" href="#id4">Unsafe or Raw Strings</a><a class="headerlink" href="#unsafe-or-raw-strings" title="Permalink to this headline">¶</a></h6>
<p>As of Ansible 2.0, there is an internal data type for declaring variable values as &#8220;unsafe&#8221;. This means that the data held within the variables value should be treated as unsafe preventing unsafe character subsitition and information disclosure.</p>
<p>Jinja2 contains functionality for escaping, or telling Jinja2 to not template data by means of functionality such as <code class="docutils literal"><span class="pre">{%</span> <span class="pre">raw</span> <span class="pre">%}</span> <span class="pre">...</span> <span class="pre">{%</span> <span class="pre">endraw</span> <span class="pre">%}</span></code>, however this uses a more comprehensive implementation to ensure that the value is never templated.</p>
<p>Using YAML tags, you can also mark a value as &#8220;unsafe&#8221; by using the <code class="docutils literal"><span class="pre">!unsafe</span></code> tag such as:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">my_unsafe_variable</span><span class="p p-Indicator">:</span> <span class="kt">!unsafe</span> <span class="s">&#39;this</span><span class="nv"> </span><span class="s">variable</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">characters</span><span class="nv"> </span><span class="s">that</span><span class="nv"> </span><span class="s">should</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">treated</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">jinja2</span><span class="nv"> </span><span class="s">template&#39;</span>
</pre></div>
</div>
<p>In a playbook, this may look like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
hosts: all
vars:
    my_unsafe_variable: !unsafe <span class="s1">&#39;unsafe value&#39;</span>
tasks:
    ...
</pre></div>
</div>
<p>For complex variables such as hashes or arrays, <code class="docutils literal"><span class="pre">!unsafe</span></code> should be used on the individual elements such as:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
my_unsafe_array:
    - !unsafe <span class="s1">&#39;unsafe element&#39;</span>
    - <span class="s1">&#39;safe element&#39;</span>

my_unsafe_hash:
    unsafe_key: !unsafe <span class="s1">&#39;unsafe value&#39;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-playbooks_prompts"></span><div class="section" id="prompts">
<h4>Prompts<a class="headerlink" href="#prompts" title="Permalink to this headline">¶</a></h4>
<p>When running a playbook, you may wish to prompt the user for certain input, and can
do so with the &#8216;vars_prompt&#8217; section.</p>
<p>A common use for this might be for asking for sensitive data that you do not want to record.</p>
<p>This has uses beyond security, for instance, you may use the same playbook for all
software releases and would prompt for a particular release version
in a push-script.</p>
<p>Here is a most basic example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all
  remote_user: root

  vars:
    from: <span class="s2">&quot;camelot&quot;</span>

  vars_prompt:
    - name: <span class="s2">&quot;name&quot;</span>
      prompt: <span class="s2">&quot;what is your name?&quot;</span>
    - name: <span class="s2">&quot;quest&quot;</span>
      prompt: <span class="s2">&quot;what is your quest?&quot;</span>
    - name: <span class="s2">&quot;favcolor&quot;</span>
      prompt: <span class="s2">&quot;what is your favorite color?&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Prompts for individual <code class="docutils literal"><span class="pre">vars_prompt</span></code> variables will be skipped for any variable that is already defined through the command line <code class="docutils literal"><span class="pre">--extra-vars</span></code> option, or when running from a non-interactive session (such as cron or Ansible Tower). See <span class="xref std std-ref">_passing_variables_on_the_command_line</span> in the /Variables/ chapter.</p>
</div>
<p>If you have a variable that changes infrequently, it might make sense to
provide a default value that can be overridden.  This can be accomplished using
the default argument:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars_prompt:

  - name: <span class="s2">&quot;release_version&quot;</span>
    prompt: <span class="s2">&quot;Product release version&quot;</span>
    default: <span class="s2">&quot;1.0&quot;</span>
</pre></div>
</div>
<p>An alternative form of vars_prompt allows for hiding input from the user, and may later support
some other options, but otherwise works equivalently:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars_prompt:

  - name: <span class="s2">&quot;some_password&quot;</span>
    prompt: <span class="s2">&quot;Enter password&quot;</span>
    private: yes

  - name: <span class="s2">&quot;release_version&quot;</span>
    prompt: <span class="s2">&quot;Product release version&quot;</span>
    private: no
</pre></div>
</div>
<p>If <a class="reference external" href="https://passlib.readthedocs.io/en/stable/">Passlib</a> is installed, vars_prompt can also crypt the
entered value so you can use it, for instance, with the user module to define a password:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>vars_prompt:

  - name: <span class="s2">&quot;my_password2&quot;</span>
    prompt: <span class="s2">&quot;Enter password2&quot;</span>
    private: yes
    encrypt: <span class="s2">&quot;sha512_crypt&quot;</span>
    confirm: yes
    salt_size: <span class="m">7</span>
</pre></div>
</div>
<p>You can use any crypt scheme supported by &#8216;Passlib&#8217;:</p>
<ul class="simple">
<li><em>des_crypt</em> - DES Crypt</li>
<li><em>bsdi_crypt</em> - BSDi Crypt</li>
<li><em>bigcrypt</em> - BigCrypt</li>
<li><em>crypt16</em> - Crypt16</li>
<li><em>md5_crypt</em> - MD5 Crypt</li>
<li><em>bcrypt</em> - BCrypt</li>
<li><em>sha1_crypt</em> - SHA-1 Crypt</li>
<li><em>sun_md5_crypt</em> - Sun MD5 Crypt</li>
<li><em>sha256_crypt</em> - SHA-256 Crypt</li>
<li><em>sha512_crypt</em> - SHA-512 Crypt</li>
<li><em>apr_md5_crypt</em> - Apache’s MD5-Crypt variant</li>
<li><em>phpass</em> - PHPass’ Portable Hash</li>
<li><em>pbkdf2_digest</em> - Generic PBKDF2 Hashes</li>
<li><em>cta_pbkdf2_sha1</em> - Cryptacular’s PBKDF2 hash</li>
<li><em>dlitz_pbkdf2_sha1</em> - Dwayne Litzenberger’s PBKDF2 hash</li>
<li><em>scram</em> - SCRAM Hash</li>
<li><em>bsd_nthash</em> - FreeBSD’s MCF-compatible nthash encoding</li>
</ul>
<p>However, the only parameters accepted are &#8216;salt&#8217; or &#8216;salt_size&#8217;. You can use your own salt using
&#8216;salt&#8217;, or have one generated automatically using &#8216;salt_size&#8217;. If nothing is specified, a salt
of size 8 will be generated.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_conditionals"><span class="doc">Conditionals</span></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-playbooks_tags"></span><div class="section" id="tags">
<h4>Tags<a class="headerlink" href="#tags" title="Permalink to this headline">¶</a></h4>
<p>If you have a large playbook it may become useful to be able to run a specific part of the configuration without running the whole playbook.</p>
<p>Both plays and tasks support a &#8220;tags:&#8221; attribute for this reason.
You can <strong>ONLY</strong> filter tasks based on tags from the command line with <code class="docutils literal"><span class="pre">--tags</span></code> or <code class="docutils literal"><span class="pre">--skip-tags</span></code>.
Adding &#8220;tags:&#8221; in any part of a play (including roles) adds those tags to the contained tasks.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

    - yum: <span class="nv">name</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>installed
      with_items:
         - httpd
         - memcached
      tags:
         - packages

    - template: <span class="nv">src</span><span class="o">=</span>templates/src.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
      tags:
         - configuration
</pre></div>
</div>
<p>If you wanted to just run the &#8220;configuration&#8221; and &#8220;packages&#8221; part of a very long playbook, you could do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook example.yml --tags <span class="s2">&quot;configuration,packages&quot;</span>
</pre></div>
</div>
<p>On the other hand, if you want to run a playbook <em>without</em> certain tasks, you could do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook example.yml --skip-tags <span class="s2">&quot;notification&quot;</span>
</pre></div>
</div>
<div class="section" id="tag-reuse">
<span id="id1"></span><h5>Tag Reuse<a class="headerlink" href="#tag-reuse" title="Permalink to this headline">¶</a></h5>
<p>You can apply the same tag name to more than one task, in the same file
or included files. This will run all tasks with that tag.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># file: roles/common/tasks/main.yml</span>

- name: be sure ntp is installed
  yum: <span class="nv">name</span><span class="o">=</span>ntp <span class="nv">state</span><span class="o">=</span>installed
  tags: ntp

- name: be sure ntp is configured
  template: <span class="nv">src</span><span class="o">=</span>ntp.conf.j2 <span class="nv">dest</span><span class="o">=</span>/etc/ntp.conf
  notify:
    - restart ntpd
  tags: ntp

- name: be sure ntpd is running and enabled
  service: <span class="nv">name</span><span class="o">=</span>ntpd <span class="nv">state</span><span class="o">=</span>started <span class="nv">enabled</span><span class="o">=</span>yes
  tags: ntp
</pre></div>
</div>
</div>
<div class="section" id="tag-inheritance">
<span id="id2"></span><h5>Tag Inheritance<a class="headerlink" href="#tag-inheritance" title="Permalink to this headline">¶</a></h5>
<p>You can apply tags to more than tasks, but they ONLY affect the tasks themselves. Applying tags anywhere else is just a convenience so you don&#8217;t have to write it on every task:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  tags:
    - bar
  tasks:
    ...

- hosts: all
  tags: <span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="o">]</span>
  tasks:
    ...
</pre></div>
</div>
<p>You may also apply tags to roles:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles:
  - <span class="o">{</span> role: webserver, port: <span class="m">5000</span>, tags: <span class="o">[</span> <span class="s1">&#39;web&#39;</span>, <span class="s1">&#39;foo&#39;</span> <span class="o">]</span> <span class="o">}</span>
</pre></div>
</div>
<p>And import/include statements:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- import_tasks: foo.yml
  tags: <span class="o">[</span>web,foo<span class="o">]</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- include_tasks: foo.yml
  tags: <span class="o">[</span>web,foo<span class="o">]</span>
</pre></div>
</div>
<p>All of these apply the specified tags to EACH task inside the play, included
file, or role, so that these tasks can be selectively run when the playbook
is invoked with the corresponding tags.</p>
<p>Tags are inherited <em>down</em> the dependency chain. In order for tags to be applied to a role and all its dependencies,
the tag should be applied to the role, not to all the tasks within a role.</p>
<p>You can see which tags are applied to tasks by running <code class="docutils literal"><span class="pre">ansible-playbook</span></code> with the <code class="docutils literal"><span class="pre">--list-tasks</span></code> option. You can display all tags using the <code class="docutils literal"><span class="pre">--list-tags</span></code> option.</p>
</div>
<div class="section" id="special-tags">
<span id="id3"></span><h5>Special Tags<a class="headerlink" href="#special-tags" title="Permalink to this headline">¶</a></h5>
<p>There is a special <code class="docutils literal"><span class="pre">always</span></code> tag that will always run a task, unless specifically skipped (<code class="docutils literal"><span class="pre">--skip-tags</span> <span class="pre">always</span></code>)</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

    - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Always runs&quot;</span>
      tags:
        - always

    - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;runs when you use tag1&quot;</span>
      tags:
        - tag1
</pre></div>
</div>
<p>There are another 3 special keywords for tags, <code class="docutils literal"><span class="pre">tagged</span></code>, <code class="docutils literal"><span class="pre">untagged</span></code> and <code class="docutils literal"><span class="pre">all</span></code>, which run only tagged, only untagged
and all tasks respectively.</p>
<p>By default ansible runs as if <code class="docutils literal"><span class="pre">--tags</span> <span class="pre">all</span></code> had been specified.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-playbooks_vault"></span><div class="section" id="using-vault-in-playbooks">
<h4><a class="toc-backref" href="#id3">Using Vault in playbooks</a><a class="headerlink" href="#using-vault-in-playbooks" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#using-vault-in-playbooks" id="id3">Using Vault in playbooks</a><ul>
<li><a class="reference internal" href="#running-a-playbook-with-vault" id="id4">Running a Playbook With Vault</a></li>
<li><a class="reference internal" href="#single-encrypted-variable" id="id5">Single Encrypted Variable</a></li>
<li><a class="reference internal" href="#using-encrypt-string" id="id6">Using encrypt_string</a></li>
</ul>
</li>
</ul>
</div>
<p>New in Ansible 1.5, &#8220;Vault&#8221; is a feature of ansible that allows keeping sensitive data such as passwords or keys in encrypted files, rather than as plaintext in your playbooks or roles. These vault files can then be distributed or placed in source control.</p>
<p>To enable this feature, a command line tool, <cite>ansible-vault</cite> is used to edit files, and a command line flag <cite>&#8211;ask-vault-pass</cite> or <cite>&#8211;vault-password-file</cite> is used. Alternately, you may specify the location of a password file or command Ansible to always prompt for the password in your ansible.cfg file. These options require no command line flag usage.</p>
<p>For best practices advice, refer to <a class="reference internal" href="index.html#best-practices-for-variables-and-vaults"><span class="std std-ref">Variables and Vaults</span></a>.</p>
<div class="section" id="running-a-playbook-with-vault">
<span id="id1"></span><h5><a class="toc-backref" href="#id4">Running a Playbook With Vault</a><a class="headerlink" href="#running-a-playbook-with-vault" title="Permalink to this headline">¶</a></h5>
<p>To run a playbook that contains vault-encrypted data files, you must pass one of two flags.  To specify the vault-password interactively:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook site.yml --ask-vault-pass
</pre></div>
</div>
<p>This prompt will then be used to decrypt (in memory only) any vault encrypted files that are accessed.  Currently this requires that all files be encrypted with the same password.</p>
<p>Alternatively, passwords can be specified with a file or a script, the script version will require Ansible 1.7 or later.  When using this flag, ensure permissions on the file are such that no one else can access your key and do not add your key to source control:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook site.yml --vault-password-file ~/.vault_pass.txt

ansible-playbook site.yml --vault-password-file ~/.vault_pass.py
</pre></div>
</div>
<p>The password should be a string stored as a single line in the file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can also set <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_VAULT_PASSWORD_FILE</span></code> environment variable, e.g. <code class="docutils literal"><span class="pre">ANSIBLE_VAULT_PASSWORD_FILE=~/.vault_pass.txt</span></code> and Ansible will automatically search for the password in that file.</p>
</div>
<p>If you are using a script instead of a flat file, ensure that it is marked as executable, and that the password is printed to standard output.  If your script needs to prompt for data, prompts can be sent to standard error.</p>
<p>This is something you may wish to do if using Ansible from a continuous integration system like Jenkins.</p>
<p>(The <cite>&#8211;vault-password-file</cite> option can also be used with the <a class="reference internal" href="index.html#ansible-pull"><span class="std std-ref">Ansible-Pull</span></a> command if you wish, though this would require distributing the keys to your nodes, so understand the implications &#8211; vault is more intended for push mode).</p>
</div>
<div class="section" id="single-encrypted-variable">
<span id="id2"></span><h5><a class="toc-backref" href="#id5">Single Encrypted Variable</a><a class="headerlink" href="#single-encrypted-variable" title="Permalink to this headline">¶</a></h5>
<p>As of version 2.3, Ansible can now use a vaulted variable that lives in an otherwise &#8216;clear text&#8217; YAML file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>notsecret: myvalue
mysecret: !vault <span class="p">|</span>
          <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
          <span class="m">66386439653236336462626566653063336164663966303231363934653561363964363833313662</span>
          6431626536303530376336343832656537303632313433360a626438346336353331386135323734
          <span class="m">62656361653630373231613662633962316233633936396165386439616533353965373339616234</span>
          3430613539666330390a313736323265656432366236633330313963326365653937323833366536
          <span class="m">34623731376664623134383463316265643436343438623266623965636363326136</span>
other_plain_text: othervalue
</pre></div>
</div>
<p>To create a vaulted variable, use the <span class="xref std std-ref">ansible-vault encrypt_string</span> command. See <a class="reference internal" href="#encrypt-string"><span class="std std-ref">Using encrypt_string</span></a> for details.</p>
<p>This vaulted variable will be decrypted with the supplied vault secret and used as a normal variable. The <code class="docutils literal"><span class="pre">ansible-vault</span></code> command line supports stdin and stdout for encrypting data on the fly, which can be used from your favorite editor to create these vaulted variables; you just have to be sure to add the <code class="docutils literal"><span class="pre">!vault</span></code> tag so both Ansible and YAML are aware of the need to decrypt. The <code class="docutils literal"><span class="pre">|</span></code> is also required, as vault encryption results in a multi-line string.</p>
</div>
<div class="section" id="using-encrypt-string">
<span id="encrypt-string"></span><h5><a class="toc-backref" href="#id6">Using encrypt_string</a><a class="headerlink" href="#using-encrypt-string" title="Permalink to this headline">¶</a></h5>
<p>This command will output a string in the above format ready to be included in a YAML file.
The string to encrypt can be provided via stdin, command line args, or via an interactive prompt.</p>
<p>See <a class="reference internal" href="index.html#encrypt-string-for-use-in-yaml"><span class="std std-ref">Use encrypt_string to create encrypted variables to embed in yaml</span></a>.</p>
</div>
</div>
<span id="document-playbooks_startnstep"></span><div class="section" id="start-and-step">
<h4>Start and Step<a class="headerlink" href="#start-and-step" title="Permalink to this headline">¶</a></h4>
<p>This shows a few alternative ways to run playbooks. These modes are very useful for testing new plays or debugging.</p>
<div class="section" id="start-at-task">
<span id="id1"></span><h5>Start-at-task<a class="headerlink" href="#start-at-task" title="Permalink to this headline">¶</a></h5>
<p>If you want to start executing your playbook at a particular task, you can do so with the <code class="docutils literal"><span class="pre">--start-at-task</span></code> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook playbook.yml --start-at-task<span class="o">=</span><span class="s2">&quot;install packages&quot;</span>
</pre></div>
</div>
<p>The above will start executing your playbook at a task named &#8220;install packages&#8221;.</p>
</div>
<div class="section" id="step">
<span id="id2"></span><h5>Step<a class="headerlink" href="#step" title="Permalink to this headline">¶</a></h5>
<p>Playbooks can also be executed interactively with <code class="docutils literal"><span class="pre">--step</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook playbook.yml --step
</pre></div>
</div>
<p>This will cause ansible to stop on each task, and ask if it should execute that task.
Say you had a task called &#8220;configure ssh&#8221;, the playbook run will stop and ask:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Perform task: configure ssh <span class="o">(</span>y/n/c<span class="o">)</span>:
</pre></div>
</div>
<p>Answering &#8220;y&#8221; will execute the task, answering &#8220;n&#8221; will skip the task, and answering &#8220;c&#8221;
will continue executing all the remaining tasks without asking.</p>
</div>
</div>
</div>
</div>
<span id="document-modules"></span><div class="section" id="about-modules">
<h3>About Modules<a class="headerlink" href="#about-modules" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-modules_intro"></span><div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>Modules (also referred to as &#8220;task plugins&#8221; or &#8220;library plugins&#8221;) are the ones that do
the actual work in ansible, they are what gets executed in each playbook task.
But you can also run a single one using the &#8216;ansible&#8217; command.</p>
<p>Let&#8217;s review how we execute three different modules from the command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible webservers -m service -a <span class="s2">&quot;name=httpd state=started&quot;</span>
ansible webservers -m ping
ansible webservers -m <span class="nb">command</span> -a <span class="s2">&quot;/sbin/reboot -t now&quot;</span>
</pre></div>
</div>
<p>Each module supports taking arguments.  Nearly all modules take <code class="docutils literal"><span class="pre">key=value</span></code>
arguments, space delimited.  Some modules take no arguments, and the command/shell modules simply
take the string of the command you want to run.</p>
<p>From playbooks, Ansible modules are executed in a very similar way:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: reboot the servers
  action: <span class="nb">command</span> /sbin/reboot -t now
</pre></div>
</div>
<p>Which can be abbreviated to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: reboot the servers
  command: /sbin/reboot -t now
</pre></div>
</div>
<p>Another way to pass arguments to a module is using yaml syntax also called &#8216;complex args&#8217;</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: restart webserver
  service:
    name: httpd
    state: restarted
</pre></div>
</div>
<p>All modules technically return JSON format data, though if you are using the command line or playbooks, you don&#8217;t really need to know much about
that.  If you&#8217;re writing your own module, you care, and this means you do not have to write modules in any particular language &#8211; you get to choose.</p>
<p>Modules should be idempotent, and should avoid making any changes if
they detect that the current state matches the desired final state. When using
Ansible playbooks, these modules can trigger &#8216;change events&#8217; in the form of
notifying &#8216;handlers&#8217; to run additional tasks.</p>
<p>Documentation for each module can be accessed from the command line with the ansible-doc tool:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-doc yum
</pre></div>
</div>
<p>A list of all installed modules is also available:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-doc -l
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of using modules in /usr/bin/ansible</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Examples of using modules with /usr/bin/ansible-playbook</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>How to write your own modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_api"><span class="doc">Python API</span></a></dt>
<dd>Examples of using modules with the Python API</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-common_return_values"></span><div class="section" id="return-values">
<h4><a class="toc-backref" href="#id1">Return Values</a><a class="headerlink" href="#return-values" title="Permalink to this headline">¶</a></h4>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#return-values" id="id1">Return Values</a><ul>
<li><a class="reference internal" href="#common" id="id2">Common</a><ul>
<li><a class="reference internal" href="#backup-file" id="id3">backup_file</a></li>
<li><a class="reference internal" href="#changed" id="id4">changed</a></li>
<li><a class="reference internal" href="#failed" id="id5">failed</a></li>
<li><a class="reference internal" href="#invocation" id="id6">invocation</a></li>
<li><a class="reference internal" href="#msg" id="id7">msg</a></li>
<li><a class="reference internal" href="#rc" id="id8">rc</a></li>
<li><a class="reference internal" href="#results" id="id9">results</a></li>
<li><a class="reference internal" href="#skipped" id="id10">skipped</a></li>
<li><a class="reference internal" href="#stderr" id="id11">stderr</a></li>
<li><a class="reference internal" href="#stderr-lines" id="id12">stderr_lines</a></li>
<li><a class="reference internal" href="#stdout" id="id13">stdout</a></li>
<li><a class="reference internal" href="#stdout-lines" id="id14">stdout_lines</a></li>
</ul>
</li>
<li><a class="reference internal" href="#internal-use" id="id15">Internal use</a><ul>
<li><a class="reference internal" href="#ansible-facts" id="id16">ansible_facts</a></li>
<li><a class="reference internal" href="#exception" id="id17">exception</a></li>
<li><a class="reference internal" href="#warnings" id="id18">warnings</a></li>
<li><a class="reference internal" href="#deprecations" id="id19">deprecations</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>Ansible modules normally return a data structure that can be registered into a variable, or seen directly when output by
the <cite>ansible</cite> program. Each module can optionally document its own unique return values (visible through ansible-doc and <a class="reference external" href="https://docs.ansible.com">https://docs.ansible.com</a>).</p>
<p>This document covers return values common to all modules.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some of these keys might be set by Ansible itself once it processes the module&#8217;s return information.</p>
</div>
<div class="section" id="common">
<span id="common-return-values"></span><h5><a class="toc-backref" href="#id2">Common</a><a class="headerlink" href="#common" title="Permalink to this headline">¶</a></h5>
<div class="section" id="backup-file">
<h6><a class="toc-backref" href="#id3">backup_file</a><a class="headerlink" href="#backup-file" title="Permalink to this headline">¶</a></h6>
<p>For those modules that implement <cite>backup=no|yes</cite> when manipulating files, a path to the backup file created.</p>
</div>
<div class="section" id="changed">
<h6><a class="toc-backref" href="#id4">changed</a><a class="headerlink" href="#changed" title="Permalink to this headline">¶</a></h6>
<p>A boolean indicating if the task had to make changes.</p>
</div>
<div class="section" id="failed">
<h6><a class="toc-backref" href="#id5">failed</a><a class="headerlink" href="#failed" title="Permalink to this headline">¶</a></h6>
<p>A boolean that indicates if the task was failed or not.</p>
</div>
<div class="section" id="invocation">
<h6><a class="toc-backref" href="#id6">invocation</a><a class="headerlink" href="#invocation" title="Permalink to this headline">¶</a></h6>
<p>Information on how the module was invoked.</p>
</div>
<div class="section" id="msg">
<h6><a class="toc-backref" href="#id7">msg</a><a class="headerlink" href="#msg" title="Permalink to this headline">¶</a></h6>
<p>A string with a generic message relayed to the user.</p>
</div>
<div class="section" id="rc">
<h6><a class="toc-backref" href="#id8">rc</a><a class="headerlink" href="#rc" title="Permalink to this headline">¶</a></h6>
<p>Some modules execute command line utilities or are geared for executing commands directly (raw, shell, command, etc), this field contains &#8216;return code&#8217; of these utilities.</p>
</div>
<div class="section" id="results">
<h6><a class="toc-backref" href="#id9">results</a><a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h6>
<p>If this key exists, it indicates that a loop was present for the task and that it contains a list of the normal module &#8216;result&#8217; per item.</p>
</div>
<div class="section" id="skipped">
<h6><a class="toc-backref" href="#id10">skipped</a><a class="headerlink" href="#skipped" title="Permalink to this headline">¶</a></h6>
<p>A boolean that indicates if the task was skipped or not</p>
</div>
<div class="section" id="stderr">
<h6><a class="toc-backref" href="#id11">stderr</a><a class="headerlink" href="#stderr" title="Permalink to this headline">¶</a></h6>
<p>Some modules execute command line utilities or are geared for executing commands directly (raw, shell, command, etc), this field contains the error output of these utilities.</p>
</div>
<div class="section" id="stderr-lines">
<h6><a class="toc-backref" href="#id12">stderr_lines</a><a class="headerlink" href="#stderr-lines" title="Permalink to this headline">¶</a></h6>
<p>When <cite>stderr</cite> is returned we also always provide this field which is a list of strings, one item per line from the original.</p>
</div>
<div class="section" id="stdout">
<h6><a class="toc-backref" href="#id13">stdout</a><a class="headerlink" href="#stdout" title="Permalink to this headline">¶</a></h6>
<p>Some modules execute command line utilities or are geared for executing commands directly (raw, shell, command, etc). This field contains the normal output of these utilities.</p>
</div>
<div class="section" id="stdout-lines">
<h6><a class="toc-backref" href="#id14">stdout_lines</a><a class="headerlink" href="#stdout-lines" title="Permalink to this headline">¶</a></h6>
<p>When <cite>stdout</cite> is returned, Ansible always provides a list of strings, each containing one item per line from the original output.</p>
</div>
</div>
<div class="section" id="internal-use">
<span id="internal-return-values"></span><h5><a class="toc-backref" href="#id15">Internal use</a><a class="headerlink" href="#internal-use" title="Permalink to this headline">¶</a></h5>
<p>These keys can be added by modules but will be removed from registered variables; they are &#8216;consumed&#8217; by Ansible itself.</p>
<div class="section" id="ansible-facts">
<h6><a class="toc-backref" href="#id16">ansible_facts</a><a class="headerlink" href="#ansible-facts" title="Permalink to this headline">¶</a></h6>
<p>This key should contain a dictionary which will be appended to the facts assigned to the host. These will be directly accessible and don&#8217;t require using a registered variable.</p>
</div>
<div class="section" id="exception">
<h6><a class="toc-backref" href="#id17">exception</a><a class="headerlink" href="#exception" title="Permalink to this headline">¶</a></h6>
<p>This key can contain traceback information caused by an exception in a module. It will only be displayed on high verbosity (-vvv).</p>
</div>
<div class="section" id="warnings">
<h6><a class="toc-backref" href="#id18">warnings</a><a class="headerlink" href="#warnings" title="Permalink to this headline">¶</a></h6>
<p>This key contains a list of strings that will be presented to the user.</p>
</div>
<div class="section" id="deprecations">
<h6><a class="toc-backref" href="#id19">deprecations</a><a class="headerlink" href="#deprecations" title="Permalink to this headline">¶</a></h6>
<p>This key contains a list of dictionaries that will be presented to the user. Keys of the dictionaries are <cite>msg</cite> and <cite>version</cite>, values are string, value for the <cite>version</cite> key can be an empty string.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-modules-core/tree/devel">GitHub Core modules directory</a></dt>
<dd>Browse source of core modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-modules-extras/tree/devel">Github Extras modules directory</a></dt>
<dd>Browse source of extras modules.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Mailing List</a></dt>
<dd>Development mailing list</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-modules_support"></span><div class="section" id="module-maintenance-support">
<h4>Module Maintenance &amp; Support<a class="headerlink" href="#module-maintenance-support" title="Permalink to this headline">¶</a></h4>
<div class="toctree-wrapper compound">
</div>
<p>To help identify maintainers and understand how the included modules are officially supported, each module now has associated metadata that provides additional clarity for maintenance and support.</p>
<div class="section" id="core">
<h5>Core<a class="headerlink" href="#core" title="Permalink to this headline">¶</a></h5>
<p><span class="xref doc">Core modules are maintained by the Ansible Engineering Team</span>.
These modules are integral to the basic foundations of the Ansible distribution.</p>
</div>
<div class="section" id="network">
<h5>Network<a class="headerlink" href="#network" title="Permalink to this headline">¶</a></h5>
<p><span class="xref doc">Network modules are maintained by the Ansible Network Team</span>. Please note there are <span class="xref doc">additional networking modules</span> that are categorized as Certified or Community not maintained by Ansible.</p>
</div>
<div class="section" id="certified">
<h5>Certified<a class="headerlink" href="#certified" title="Permalink to this headline">¶</a></h5>
<p>Certified modules are part of a future planned program currently in development.</p>
</div>
<div class="section" id="community">
<h5>Community<a class="headerlink" href="#community" title="Permalink to this headline">¶</a></h5>
<p><span class="xref doc">Community modules are submitted and maintained by the Ansible community</span>.  These modules are not maintained by Ansible, and are included as a convenience.</p>
</div>
<div class="section" id="issue-reporting">
<h5>Issue Reporting<a class="headerlink" href="#issue-reporting" title="Permalink to this headline">¶</a></h5>
<p>If you believe you have found a bug in a module and are already running the latest stable or development version of Ansible, first look at the <a class="reference external" href="https://github.com/ansible/ansible/issues">issue tracker in the Ansible repo</a> to see if an issue has already been filed. If not, please file one.</p>
<p>Should you have a question rather than a bug report, inquiries are welcome on the <a class="reference external" href="https://groups.google.com/forum/#%21forum/ansible-project">ansible-project Google group</a> or on Ansible’s “#ansible” channel, located on irc.freenode.net.</p>
<p>For development-oriented topics, use the <a class="reference external" href="https://groups.google.com/forum/#%21forum/ansible-devel">ansible-devel Google group</a> or Ansible’s #ansible and #ansible-devel channels, located on irc.freenode.net. You should also read <a class="reference internal" href="index.html#document-community"><span class="doc">Community Information &amp; Contributing</span></a>, <span class="xref doc">Testing Ansible</span>, and <span class="xref doc">Developing Modules</span>.</p>
<p>The modules are hosted on GitHub in a subdirectory of the <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/modules">Ansible</a> repo.</p>
<p>NOTE: If you have a Red Hat Ansible Engine product subscription, please follow the standard issue reporting process via the Red Hat Customer Portal.</p>
</div>
<div class="section" id="support">
<h5>Support<a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h5>
<p>For more information on how included Ansible modules are supported by Red Hat,
please refer to the following <a class="reference external" href="https://access.redhat.com/articles/3166901">knowledgebase article</a> as well as other resources on the <a class="reference external" href="https://access.redhat.com/">Red Hat Customer Portal.</a></p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of using modules in /usr/bin/ansible</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Examples of using modules with /usr/bin/ansible-playbook</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>How to write your own modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_api"><span class="doc">Python API</span></a></dt>
<dd>Examples of using modules with the Python API</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<p>Ansible ships with a number of modules (called the &#8216;module library&#8217;)
that can be executed directly on remote hosts or through <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a>.</p>
<p>Users can also write their own modules. These modules can control system resources,
like services, packages, or files (anything really), or handle executing system commands.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_adhoc"><span class="doc">Introduction To Ad-Hoc Commands</span></a></dt>
<dd>Examples of using modules in /usr/bin/ansible</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Examples of using modules with /usr/bin/ansible-playbook</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>How to write your own modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_api"><span class="doc">Python API</span></a></dt>
<dd>Examples of using modules with the Python API</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-vault"></span><div class="section" id="ansible-vault">
<h3><a class="toc-backref" href="#id5">Ansible Vault</a><a class="headerlink" href="#ansible-vault" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#ansible-vault" id="id5">Ansible Vault</a><ul>
<li><a class="reference internal" href="#what-can-be-encrypted-with-vault" id="id6">What Can Be Encrypted With Vault</a></li>
<li><a class="reference internal" href="#creating-encrypted-files" id="id7">Creating Encrypted Files</a></li>
<li><a class="reference internal" href="#editing-encrypted-files" id="id8">Editing Encrypted Files</a></li>
<li><a class="reference internal" href="#rekeying-encrypted-files" id="id9">Rekeying Encrypted Files</a></li>
<li><a class="reference internal" href="#encrypting-unencrypted-files" id="id10">Encrypting Unencrypted Files</a></li>
<li><a class="reference internal" href="#decrypting-encrypted-files" id="id11">Decrypting Encrypted Files</a></li>
<li><a class="reference internal" href="#viewing-encrypted-files" id="id12">Viewing Encrypted Files</a></li>
<li><a class="reference internal" href="#use-encrypt-string-to-create-encrypted-variables-to-embed-in-yaml" id="id13">Use encrypt_string to create encrypted variables to embed in yaml</a></li>
<li><a class="reference internal" href="#vault-ids-and-multiple-vault-passwords" id="id14">Vault Ids and Multiple Vault Passwords</a></li>
<li><a class="reference internal" href="#providing-vault-passwords" id="id15">Providing Vault Passwords</a><ul>
<li><a class="reference internal" href="#multiple-vault-passwords" id="id16">Multiple vault passwords</a></li>
</ul>
</li>
<li><a class="reference internal" href="#speeding-up-vault-operations" id="id17">Speeding Up Vault Operations</a></li>
<li><a class="reference internal" href="#vault-format" id="id18">Vault Format</a></li>
<li><a class="reference internal" href="#vault-payload-format-1-1" id="id19">Vault Payload Format 1.1</a></li>
</ul>
</li>
</ul>
</div>
<p>New in Ansible 1.5, &#8220;Vault&#8221; is a feature of ansible that allows keeping sensitive data such as passwords or keys in encrypted files, rather than as plaintext in your playbooks or roles. These vault files can then be distributed or placed in source control.</p>
<p>To enable this feature, a command line tool - <span class="xref std std-ref">ansible-vault</span> - is used to edit files, and a command line flag (<code class="xref std std-option docutils literal"><span class="pre">--ask-vault-pass</span></code> or <code class="xref std std-option docutils literal"><span class="pre">--vault-password-file</span></code>) is used. Alternately, you may specify the location of a password file or command Ansible to always prompt for the password in your ansible.cfg file. These options require no command line flag usage.</p>
<p>For best practices advice, refer to <a class="reference internal" href="index.html#best-practices-for-variables-and-vaults"><span class="std std-ref">Variables and Vaults</span></a>.</p>
<div class="section" id="what-can-be-encrypted-with-vault">
<span id="id1"></span><h4><a class="toc-backref" href="#id6">What Can Be Encrypted With Vault</a><a class="headerlink" href="#what-can-be-encrypted-with-vault" title="Permalink to this headline">¶</a></h4>
<p>The vault feature can encrypt any structured data file used by Ansible.  This can include &#8220;group_vars/&#8221; or &#8220;host_vars/&#8221; inventory variables, variables loaded by &#8220;include_vars&#8221; or &#8220;vars_files&#8221;, or variable files passed on the ansible-playbook command line with &#8220;-e &#64;file.yml&#8221; or &#8220;-e &#64;file.json&#8221;.  Role variables and defaults are also included!</p>
<p>Ansible tasks, handlers, and so on are also data so these can be encrypted with vault as well. To hide the names of variables that you&#8217;re using, you can encrypt the task files in their entirety. However, that might be a little too much and could annoy your coworkers :)</p>
<p>The vault feature can also encrypt arbitrary files, even binary files.  If a vault-encrypted file is
given as the <span class="xref std std-ref">src</span> argument to the <span class="xref std std-ref">copy</span>, <span class="xref std std-ref">template</span>,
<span class="xref std std-ref">unarchive</span>, <span class="xref std std-ref">script</span> or <span class="xref std std-ref">assemble</span> modules, the file will be placed at the destination on the target host decrypted (assuming a valid vault password is supplied when running the play).</p>
<p>As of version 2.3, Ansible also supports encrypting single values inside a YAML file, using the <cite>!vault</cite> tag to let YAML and Ansible know it uses special processing. This feature is covered in more details below.</p>
</div>
<div class="section" id="creating-encrypted-files">
<span id="creating-files"></span><h4><a class="toc-backref" href="#id7">Creating Encrypted Files</a><a class="headerlink" href="#creating-encrypted-files" title="Permalink to this headline">¶</a></h4>
<p>To create a new encrypted data file, run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault create foo.yml
</pre></div>
</div>
<p>First you will be prompted for a password.  The password used with vault currently must be the same for all files you wish to use together at the same time.</p>
<p>After providing a password, the tool will launch whatever editor you have defined with $EDITOR, and defaults to vi (before 2.1 the default was vim).  Once you are done with the editor session, the file will be saved as encrypted data.</p>
<p>The default cipher is AES (which is shared-secret based).</p>
</div>
<div class="section" id="editing-encrypted-files">
<span id="id2"></span><h4><a class="toc-backref" href="#id8">Editing Encrypted Files</a><a class="headerlink" href="#editing-encrypted-files" title="Permalink to this headline">¶</a></h4>
<p>To edit an encrypted file in place, use the <span class="xref std std-ref">ansible-vault edit</span> command.
This command will decrypt the file to a temporary file and allow you to edit
the file, saving it back when done and removing the temporary file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault edit foo.yml
</pre></div>
</div>
</div>
<div class="section" id="rekeying-encrypted-files">
<span id="rekeying-files"></span><h4><a class="toc-backref" href="#id9">Rekeying Encrypted Files</a><a class="headerlink" href="#rekeying-encrypted-files" title="Permalink to this headline">¶</a></h4>
<p>Should you wish to change your password on a vault-encrypted file or files, you can do so with the rekey command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault rekey foo.yml bar.yml baz.yml
</pre></div>
</div>
<p>This command can rekey multiple data files at once and will ask for the original
password and also the new password.</p>
</div>
<div class="section" id="encrypting-unencrypted-files">
<span id="encrypting-files"></span><h4><a class="toc-backref" href="#id10">Encrypting Unencrypted Files</a><a class="headerlink" href="#encrypting-unencrypted-files" title="Permalink to this headline">¶</a></h4>
<p>If you have existing files that you wish to encrypt, use
the <span class="xref std std-ref">ansible-vault encrypt</span> command.  This command can operate on multiple files at once:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault encrypt foo.yml bar.yml baz.yml
</pre></div>
</div>
</div>
<div class="section" id="decrypting-encrypted-files">
<span id="decrypting-files"></span><h4><a class="toc-backref" href="#id11">Decrypting Encrypted Files</a><a class="headerlink" href="#decrypting-encrypted-files" title="Permalink to this headline">¶</a></h4>
<p>If you have existing files that you no longer want to keep encrypted, you can permanently decrypt
them by running the <span class="xref std std-ref">ansible-vault decrypt</span> command.  This command will save them unencrypted
to the disk, so be sure you do not want <span class="xref std std-ref">ansible-vault edit</span> instead:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault decrypt foo.yml bar.yml baz.yml
</pre></div>
</div>
</div>
<div class="section" id="viewing-encrypted-files">
<span id="viewing-files"></span><h4><a class="toc-backref" href="#id12">Viewing Encrypted Files</a><a class="headerlink" href="#viewing-encrypted-files" title="Permalink to this headline">¶</a></h4>
<p><em>Available since Ansible 1.8</em></p>
<p>If you want to view the contents of an encrypted file without editing it, you can use the <span class="xref std std-ref">ansible-vault view</span> command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault view foo.yml bar.yml baz.yml
</pre></div>
</div>
</div>
<div class="section" id="use-encrypt-string-to-create-encrypted-variables-to-embed-in-yaml">
<span id="encrypt-string-for-use-in-yaml"></span><h4><a class="toc-backref" href="#id13">Use encrypt_string to create encrypted variables to embed in yaml</a><a class="headerlink" href="#use-encrypt-string-to-create-encrypted-variables-to-embed-in-yaml" title="Permalink to this headline">¶</a></h4>
<p>The <span class="xref std std-ref">ansible-vault encrypt_string</span> command will encrypt and format a provided string into a format
that can be included in <span class="xref std std-ref">ansible-playbook</span> YAML files.</p>
<p>To encrypt a string provided as a cli arg:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault encrypt_string --vault-id a_password_file <span class="s1">&#39;foobar&#39;</span> --name <span class="s1">&#39;the_secret&#39;</span>
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>some_foo: !vault <span class="p">|</span>
      <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
      <span class="m">62313365396662343061393464336163383764373764613633653634306231386433626436623361</span>
      6134333665353966363534333632666535333761666131620a663537646436643839616531643561
      <span class="m">63396265333966386166373632626539326166353965363262633030333630313338646335303630</span>
      3438626666666137650a353638643435666633633964366338633066623234616432373231333331
      <span class="m">6564</span>
</pre></div>
</div>
<p>To use a vault-id label for &#8216;dev&#8217; vault-id:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault encrypt_string --vault-id dev@password <span class="s1">&#39;foooodev&#39;</span> --name <span class="s1">&#39;the_dev_secret&#39;</span>
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>the_dev_secret: !vault <span class="p">|</span>
          <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.2<span class="p">;</span>AES256<span class="p">;</span>dev
          <span class="m">30613233633461343837653833666333643061636561303338373661313838333565653635353162</span>
          3263363434623733343538653462613064333634333464660a663633623939393439316636633863
          <span class="m">61636237636537333938306331383339353265363239643939666639386530626330633337633833</span>
          6664656334373166630a363736393262666465663432613932613036303963343263623137386239
          <span class="m">6330</span>
</pre></div>
</div>
<p>To encrypt a string read from stdin and name it &#8216;db_password&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;letmein&#39;</span> <span class="p">|</span> ansible-vault encrypt_string --vault-id dev@password --stdin-name <span class="s1">&#39;db_password&#39;</span>
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Reading plaintext input from stdin. <span class="o">(</span>ctrl-d to end input<span class="o">)</span>
db_password: !vault <span class="p">|</span>
          <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.2<span class="p">;</span>AES256<span class="p">;</span>dev
          <span class="m">61323931353866666336306139373937316366366138656131323863373866376666353364373761</span>
          3539633234313836346435323766306164626134376564330a373530313635343535343133316133
          <span class="m">36643666306434616266376434363239346433643238336464643566386135356334303736353136</span>
          6565633133366366360a326566323363363936613664616364623437336130623133343530333739
          <span class="m">3039</span>
</pre></div>
</div>
<p>To be prompted for a string to encrypt, encrypt it, and give it the name &#8216;new_user_password&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-vault encrypt_string --vault-id dev@./password --stdin-name <span class="s1">&#39;new_user_password&#39;</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Reading plaintext input from stdin. <span class="o">(</span>ctrl-d to end input<span class="o">)</span>
</pre></div>
</div>
<p>User enters &#8216;hunter42&#8217; and hits ctrl-d.</p>
<p>Result:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>new_user_password: !vault <span class="p">|</span>
          <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.2<span class="p">;</span>AES256<span class="p">;</span>dev
          <span class="m">37636561366636643464376336303466613062633537323632306566653533383833366462366662</span>
          6565353063303065303831323539656138653863353230620a653638643639333133306331336365
          <span class="m">62373737623337616130386137373461306535383538373162316263386165376131623631323434</span>
          3866363862363335620a376466656164383032633338306162326639643635663936623939666238
          <span class="m">3161</span>
</pre></div>
</div>
<p>See also <a class="reference internal" href="index.html#single-encrypted-variable"><span class="std std-ref">Single Encrypted Variable</span></a></p>
</div>
<div class="section" id="vault-ids-and-multiple-vault-passwords">
<span id="vault-ids"></span><h4><a class="toc-backref" href="#id14">Vault Ids and Multiple Vault Passwords</a><a class="headerlink" href="#vault-ids-and-multiple-vault-passwords" title="Permalink to this headline">¶</a></h4>
<p><em>Available since Ansible 2.4</em></p>
<p>A vault id is an identifier for one or more vault secrets. Since Ansible 2.4,
Ansible supports multiple vault passwords. Vault ids is a way to provide
a label for a particular vault password.</p>
<p>Vault encrypted content can specify which vault id it was encrypted with.</p>
<p>Prior to Ansible 2.4, only one vault password could be used at a time. Post
Ansible 2.4, multiple vault passwords can be used each time Ansible runs, so any
vault files or vars that needed to be decrypted all had to use the same password.</p>
<p>Since Ansible 2.4, vault files or vars can be that are encrypted with different
passwords can be used at the same time.</p>
<p>For example, a playbook can now include a vars file encrypted with a &#8216;dev&#8217; vault
id and a &#8216;prod&#8217; vault id.</p>
</div>
<div class="section" id="providing-vault-passwords">
<span id="id3"></span><h4><a class="toc-backref" href="#id15">Providing Vault Passwords</a><a class="headerlink" href="#providing-vault-passwords" title="Permalink to this headline">¶</a></h4>
<p>Since Ansible 2.4, the recommended way to provide a vault password from the cli is
to use the <code class="xref std std-option docutils literal"><span class="pre">--vault-id</span></code> cli option.</p>
<p>For example, to use a password store in the text file <code class="file docutils literal"><span class="pre">/path/to/my/vault-password-file</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-id /path/to/my/vault-password-file site.yml
</pre></div>
</div>
<p>To prompt for a password:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-id @prompt site.yml
</pre></div>
</div>
<p>To get the password from a vault password executable script <code class="file docutils literal"><span class="pre">my-vault-password.py</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-id my-vault-password.py
</pre></div>
</div>
<p>The value for <code class="xref std std-option docutils literal"><span class="pre">--vault-id</span></code> can specify the type of vault id (prompt, a file path, etc)
and a label for the vault id (&#8216;dev&#8217;, &#8216;prod&#8217;, &#8216;cloud&#8217;, etc)</p>
<p>For example, to use a password file <code class="file docutils literal"><span class="pre">dev-password</span></code> for the vault-id &#8216;dev&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-id dev@dev-password site.yml
</pre></div>
</div>
<p>To prompt for the &#8216;dev&#8217; vault id:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-id dev@prompt site.yml
</pre></div>
</div>
<p><em>Prior to Ansible 2.4</em></p>
<p>To be prompted for a vault password, use the <code class="xref std std-option docutils literal"><span class="pre">--ask-vault-pass</span></code> cli option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --ask-vault-pass site.yml
</pre></div>
</div>
<p>To specify a vault password in a text file &#8216;dev-password&#8217;, use the <code class="xref std std-option docutils literal"><span class="pre">--vault-password-file</span></code> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-password-file dev-password site.yml
</pre></div>
</div>
<p>There is a config option (<span class="xref std std-ref">DEFAULT_VAULT_PASSWORD_FILE</span>) to specify a vault password file to use
without requiring the <code class="xref std std-option docutils literal"><span class="pre">--vault-password-file</span></code> cli option.</p>
<dl class="docutils">
<dt>via config</dt>
<dd><p class="first"><span class="xref std std-ref">ANSIBLE_VAULT_PASSWORD_FILE</span></p>
<p class="last"><span class="xref std std-ref">ANSIBLE_VAULT_IDENTITY_LIST</span></p>
</dd>
<dt>via env</dt>
<dd>TODO</dd>
</dl>
<div class="section" id="multiple-vault-passwords">
<h5><a class="toc-backref" href="#id16">Multiple vault passwords</a><a class="headerlink" href="#multiple-vault-passwords" title="Permalink to this headline">¶</a></h5>
<p>Since Ansible 2.4 and later support using multiple vault passwords, <code class="xref std std-option docutils literal"><span class="pre">--vault-id</span></code> can
be provided multiple times.</p>
<p>If multiple vault passwords are provided, by default Ansible will attempt to decrypt vault content
by trying each vault secret in the order they were provided on the command line.</p>
<p>For example, to use a &#8216;dev&#8217; password read from a file and to be prompted for the &#8216;prod&#8217; password:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-id dev@dev-password --vault-id prod@prompt site.yml
</pre></div>
</div>
<p>In the above case, the &#8216;dev&#8217; password will be tried first, then the &#8216;prod&#8217; password for cases
where Ansible doesn&#8217;t know which vault id is used to encrypt something.</p>
<p>If the vault content was encrypted using a <code class="xref std std-option docutils literal"><span class="pre">--vault-id</span></code> option, then the label of the
vault id is stored with the vault content. When Ansible knows the right vault-id, it will try
the matching vault id&#8217;s secret first before trying the rest of the vault-ids.</p>
<p>There is a config option (<span class="xref std std-ref">DEFAULT_VAULT_ID_MATCH</span> ) to force the vault content&#8217;s vault id label to match with one of
the provided vault ids. But the default is to try the matching id first, then try the other
vault ids in order.</p>
<p>There is also a config option (<span class="xref std std-ref">DEFAULT_VAULT_IDENTITY_LIST</span>) to specify a default list of vault ids to
use. For example, instead of requiring the cli option on every use, the (<span class="xref std std-ref">DEFAULT_VAULT_IDENTITY_LIST</span>) config option can be used:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-playbook --vault-id dev@dev-password --vault-id prod@prompt site.yml
</pre></div>
</div>
<p>The <code class="xref std std-option docutils literal"><span class="pre">--vault-id</span></code> can be used in lieu of the <code class="xref std std-option docutils literal"><span class="pre">--vault-password-file</span></code> or <code class="xref std std-option docutils literal"><span class="pre">--ask-vault-pass</span></code> options,
or it can be used in combination with them.</p>
<p>When using <span class="xref std std-ref">ansible-vault</span> commands that encrypt content (<span class="xref std std-ref">ansible-vault encrypt</span>, <span class="xref std std-ref">ansible-vault encrypt_string</span>, etc)
only one vault-id can be used.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Prior to Ansible 2.4, only one vault password could be used in each Ansible run. The
<code class="xref std std-option docutils literal"><span class="pre">--vault-id</span></code> option is not support prior to Ansible 2.4.</p>
</div>
</div>
</div>
<div class="section" id="speeding-up-vault-operations">
<span id="speeding-up-vault"></span><h4><a class="toc-backref" href="#id17">Speeding Up Vault Operations</a><a class="headerlink" href="#speeding-up-vault-operations" title="Permalink to this headline">¶</a></h4>
<p>By default, Ansible uses PyCrypto to encrypt and decrypt vault files. If you have many encrypted files, decrypting them at startup may cause a perceptible delay. To speed this up, install the cryptography package:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>pip install cryptography
</pre></div>
</div>
</div>
<div class="section" id="vault-format">
<span id="id4"></span><h4><a class="toc-backref" href="#id18">Vault Format</a><a class="headerlink" href="#vault-format" title="Permalink to this headline">¶</a></h4>
<p>A vault encrypted file is a UTF-8 encoded txt file.</p>
<p>The file format includes a new line terminated header.</p>
<p>For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
</pre></div>
</div>
<p>The header contains the vault format id, the vault format version, and a cipher id, seperated by semi-colons &#8216;;&#8217;</p>
<p>The first field <code class="docutils literal"><span class="pre">$ANSIBLE_VAULT</span></code> is the format id. Currently <code class="docutils literal"><span class="pre">$ANSIBLE_VAULT</span></code> is the only valid file format id. This is used to identify files that are vault encrypted (via vault.is_encrypted_file()).</p>
<p>The second field (<cite>1.1</cite>) is the vault format version. All supported versions of ansible will currently default to &#8216;1.1&#8217;.</p>
<p>The &#8216;1.0&#8217; format is supported for reading only (and will be converted automatically to the &#8216;1.1&#8217; format on write). The format version is currently used as an exact string compare only (version numbers are not currently &#8216;compared&#8217;).</p>
<p>The third field (<code class="docutils literal"><span class="pre">AES256</span></code>) identifies the cipher algorithmn used to encrypt the data. Currently, the only supported cipher is &#8216;AES256&#8217;. [vault format 1.0 used &#8216;AES&#8217;, but current code always uses &#8216;AES256&#8217;]</p>
<p>Note: In the future, the header could change. Anything after the vault id and version can be considered to depend on the vault format version. This includes the cipher id, and any additional fields that could be after that.</p>
<p>The rest of the content of the file is the &#8216;vaulttext&#8217;. The vaulttext is a text armored version of the
encrypted ciphertext. Each line will be 80 characters wide, except for the last line which may be shorter.</p>
</div>
<div class="section" id="vault-payload-format-1-1">
<h4><a class="toc-backref" href="#id19">Vault Payload Format 1.1</a><a class="headerlink" href="#vault-payload-format-1-1" title="Permalink to this headline">¶</a></h4>
<p>The vaulttext is a concatenation of the ciphertext and a SHA256 digest with the result &#8216;hexlifyied&#8217;.</p>
<p>&#8216;hexlify&#8217; refers to the hexlify() method of pythons binascii module.</p>
<p>hexlify()&#8217;ied result of:</p>
<ul>
<li><p class="first">hexlify()&#8217;ed string of the salt, followed by a newline (&#8216;n&#8217;)</p>
</li>
<li><p class="first">hexlify()&#8217;ed string of the crypted HMAC, followed by a newline. The HMAC is:</p>
<ul class="simple">
<li>a <cite>RFC2104 &lt;https://www.ietf.org/rfc/rfc2104.txt&gt;</cite> style HMAC<ul>
<li>inputs are:<ul>
<li>The AES256 encrypted ciphertext</li>
<li>A PBKDF2 key. This key, the cipher key, and the cipher iv are generated from:<ul>
<li>the salt, in bytes</li>
<li>10000 iterations</li>
<li>SHA256() algorithmn</li>
<li>the first 32 bytes are the cipher key</li>
<li>the second 32 bytes are the HMAC key</li>
<li>remaining 16 bytes are the cipher iv</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>hexlify()&#8217;ed string of the ciphertext. The ciphertext is:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>AES256 encrypted data. The data is encrypted using:<ul>
<li>AES-CTR stream cipher</li>
<li>b_pkey1</li>
<li>iv</li>
<li>a 128 bit counter block seeded from an integer iv</li>
<li>the plaintext<ul>
<li>the original plaintext</li>
<li>padding up to the AES256 blocksize. (The data used for padding is based on <cite>RFX5652 &lt;https://tools.ietf.org/html/rfc5652#section-6.3&gt;</cite>)</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
</div>
<span id="document-command_line_tools"></span><div class="section" id="command-line-tools">
<h3>Command Line Tools<a class="headerlink" href="#command-line-tools" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
</div>
</div>
<span id="document-guides"></span><div class="section" id="detailed-guides">
<h3>Detailed Guides<a class="headerlink" href="#detailed-guides" title="Permalink to this headline">¶</a></h3>
<p>This section is new and evolving.  The idea here is to explore particular use cases in greater depth and provide a more &#8220;top down&#8221; explanation of some basic features.</p>
<div class="toctree-wrapper compound">
<span id="document-guide_aws"></span><div class="section" id="amazon-web-services-guide">
<h4>Amazon Web Services Guide<a class="headerlink" href="#amazon-web-services-guide" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<span id="aws-intro"></span><h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<p>Ansible contains a number of modules for controlling Amazon Web Services (AWS).  The purpose of this
section is to explain how to put Ansible modules together (and use inventory scripts) to use Ansible in AWS context.</p>
<p>Requirements for the AWS modules are minimal.</p>
<p>All of the modules require and are tested against recent versions of boto.  You&#8217;ll need this Python module installed on your control machine.  Boto can be installed from your OS distribution or python&#8217;s &#8220;pip install boto&#8221;.</p>
<p>Whereas classically ansible will execute tasks in its host loop against multiple remote machines, most cloud-control steps occur on your local machine with reference to the regions to control.</p>
<p>In your playbook steps we&#8217;ll typically be using the following pattern for provisioning steps:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: localhost
  connection: <span class="nb">local</span>
  gather_facts: False
  tasks:
    - ...
</pre></div>
</div>
</div>
<div class="section" id="authentication">
<span id="aws-authentication"></span><h5>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h5>
<p>Authentication with the AWS-related modules is handled by either
specifying your access and secret key as ENV variables or module arguments.</p>
<p>For environment variables:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s1">&#39;AK123&#39;</span>
<span class="nb">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s1">&#39;abc123&#39;</span>
</pre></div>
</div>
<p>For storing these in a vars_file, ideally encrypted with ansible-vault:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
ec2_access_key: <span class="s2">&quot;--REMOVED--&quot;</span>
ec2_secret_key: <span class="s2">&quot;--REMOVED--&quot;</span>
</pre></div>
</div>
<p>Note that if you store your credentials in vars_file, you need to refer to them in each AWS-module. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- ec2
  aws_access_key: <span class="s2">&quot;{{ec2_access_key}}&quot;</span>
  aws_secret_key: <span class="s2">&quot;{{ec2_secret_key}}&quot;</span>
  image: <span class="s2">&quot;...&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="provisioning">
<span id="aws-provisioning"></span><h5>Provisioning<a class="headerlink" href="#provisioning" title="Permalink to this headline">¶</a></h5>
<p>The ec2 module provisions and de-provisions instances within EC2.</p>
<p>An example of making sure there are only 5 instances tagged &#8216;Demo&#8217; in EC2 follows.</p>
<p>In the example below, the &#8220;exact_count&#8221; of instances is set to 5.  This means if there are 0 instances already existing, then
5 new instances would be created.  If there were 2 instances, only 3 would be created, and if there were 8 instances, 3 instances would
be terminated.</p>
<p>What is being counted is specified by the &#8220;count_tag&#8221; parameter.  The parameter &#8220;instance_tags&#8221; is used to apply tags to the newly created
instance.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># demo_setup.yml</span>

- hosts: localhost
  connection: <span class="nb">local</span>
  gather_facts: False

  tasks:

    - name: Provision a <span class="nb">set</span> of instances
      ec2:
         key_name: my_key
         group: <span class="nb">test</span>
         instance_type: t2.micro
         image: <span class="s2">&quot;{{ ami_id }}&quot;</span>
         wait: <span class="nb">true</span>
         exact_count: <span class="m">5</span>
         count_tag:
            Name: Demo
         instance_tags:
            Name: Demo
      register: ec2
</pre></div>
</div>
<p>The data about what instances are created is being saved by the &#8220;register&#8221; keyword in the variable named &#8220;ec2&#8221;.</p>
<p>From this, we&#8217;ll use the add_host module to dynamically create a host group consisting of these new instances.  This facilitates performing configuration actions on the hosts immediately in a subsequent task.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># demo_setup.yml</span>

- hosts: localhost
  connection: <span class="nb">local</span>
  gather_facts: False

  tasks:

    - name: Provision a <span class="nb">set</span> of instances
      ec2:
         key_name: my_key
         group: <span class="nb">test</span>
         instance_type: t2.micro
         image: <span class="s2">&quot;{{ ami_id }}&quot;</span>
         wait: <span class="nb">true</span>
         exact_count: <span class="m">5</span>
         count_tag:
            Name: Demo
         instance_tags:
            Name: Demo
      register: ec2

   - name: Add all instance public IPs to host group
     add_host: <span class="nv">hostname</span><span class="o">={{</span> item.public_ip <span class="o">}}</span> <span class="nv">groups</span><span class="o">=</span>ec2hosts
     with_items: <span class="s2">&quot;{{ ec2.instances }}&quot;</span>
</pre></div>
</div>
<p>With the host group now created, a second play at the bottom of the same provisioning playbook file might now have some configuration steps:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># demo_setup.yml</span>

- name: Provision a <span class="nb">set</span> of instances
  hosts: localhost
  <span class="c1"># ... AS ABOVE ...</span>

- hosts: ec2hosts
  name: configuration play
  user: ec2-user
  gather_facts: <span class="nb">true</span>

  tasks:

     - name: Check NTP service
       service: <span class="nv">name</span><span class="o">=</span>ntpd <span class="nv">state</span><span class="o">=</span>started
</pre></div>
</div>
</div>
<div class="section" id="host-inventory">
<span id="aws-host-inventory"></span><h5>Host Inventory<a class="headerlink" href="#host-inventory" title="Permalink to this headline">¶</a></h5>
<p>Once your nodes are spun up, you&#8217;ll probably want to talk to them again.  With a cloud setup, it&#8217;s best to not maintain a static list of cloud hostnames
in text files.  Rather, the best way to handle this is to use the ec2 dynamic inventory script. See <a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a>.</p>
<p>This will also dynamically select nodes that were even created outside of Ansible, and allow Ansible to manage them.</p>
<p>See <a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a> for how to use this, then flip back over to this chapter.</p>
</div>
<div class="section" id="tags-and-groups-and-variables">
<span id="aws-tags-and-groups"></span><h5>Tags And Groups And Variables<a class="headerlink" href="#tags-and-groups-and-variables" title="Permalink to this headline">¶</a></h5>
<p>When using the ec2 inventory script, hosts automatically appear in groups based on how they are tagged in EC2.</p>
<p>For instance, if a host is given the &#8220;class&#8221; tag with the value of &#8220;webserver&#8221;,
it will be automatically discoverable via a dynamic group like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: tag_class_webserver
  tasks:
    - ping
</pre></div>
</div>
<p>Using this philosophy can be a great way to keep systems separated by the function they perform.</p>
<p>In this example, if we wanted to define variables that are automatically applied to each machine tagged with the &#8216;class&#8217; of &#8216;webserver&#8217;, &#8216;group_vars&#8217;
in ansible can be used.  See <a class="reference internal" href="index.html#splitting-out-vars"><span class="std std-ref">Splitting Out Host and Group Specific Data</span></a>.</p>
<p>Similar groups are available for regions and other classifications, and can be similarly assigned variables using the same mechanism.</p>
</div>
<div class="section" id="autoscaling-with-ansible-pull">
<span id="aws-pull"></span><h5>Autoscaling with Ansible Pull<a class="headerlink" href="#autoscaling-with-ansible-pull" title="Permalink to this headline">¶</a></h5>
<p>Amazon Autoscaling features automatically increase or decrease capacity based on load.  There are also Ansible modules shown in the cloud documentation that
can configure autoscaling policy.</p>
<p>When nodes come online, it may not be sufficient to wait for the next cycle of an ansible command to come along and configure that node.</p>
<p>To do this, pre-bake machine images which contain the necessary ansible-pull invocation.  Ansible-pull is a command line tool that fetches a playbook from a git server and runs it locally.</p>
<p>One of the challenges of this approach is that there needs to be a centralized way to store data about the results of pull commands in an autoscaling context.
For this reason, the autoscaling solution provided below in the next section can be a better approach.</p>
<p>Read <a class="reference internal" href="index.html#ansible-pull"><span class="std std-ref">Ansible-Pull</span></a> for more information on pull-mode playbooks.</p>
</div>
<div class="section" id="autoscaling-with-ansible-tower">
<span id="aws-autoscale"></span><h5>Autoscaling with Ansible Tower<a class="headerlink" href="#autoscaling-with-ansible-tower" title="Permalink to this headline">¶</a></h5>
<p><a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a> also contains a very nice feature for auto-scaling use cases.  In this mode, a simple curl script can call
a defined URL and the server will &#8220;dial out&#8221; to the requester and configure an instance that is spinning up.  This can be a great way
to reconfigure ephemeral nodes.  See the Tower install and product documentation for more details.</p>
<p>A benefit of using the callback in Tower over pull mode is that job results are still centrally recorded and less information has to be shared
with remote hosts.</p>
</div>
<div class="section" id="ansible-with-and-versus-cloudformation">
<span id="aws-cloudformation-example"></span><h5>Ansible With (And Versus) CloudFormation<a class="headerlink" href="#ansible-with-and-versus-cloudformation" title="Permalink to this headline">¶</a></h5>
<p>CloudFormation is a Amazon technology for defining a cloud stack as a JSON document.</p>
<p>Ansible modules provide an easier to use interface than CloudFormation in many examples, without defining a complex JSON document.
This is recommended for most users.</p>
<p>However, for users that have decided to use CloudFormation, there is an Ansible module that can be used to apply a CloudFormation template
to Amazon.</p>
<p>When using Ansible with CloudFormation, typically Ansible will be used with a tool like Packer to build images, and CloudFormation will launch
those images, or ansible will be invoked through user data once the image comes online, or a combination of the two.</p>
<p>Please see the examples in the Ansible CloudFormation module for more details.</p>
</div>
<div class="section" id="aws-image-building-with-ansible">
<span id="aws-image-build"></span><h5>AWS Image Building With Ansible<a class="headerlink" href="#aws-image-building-with-ansible" title="Permalink to this headline">¶</a></h5>
<p>Many users may want to have images boot to a more complete configuration rather than configuring them entirely after instantiation.  To do this,
one of many programs can be used with Ansible playbooks to define and upload a base image, which will then get its own AMI ID for usage with
the ec2 module or other Ansible AWS modules such as ec2_asg or the cloudformation module.   Possible tools include Packer, aminator, and Ansible&#8217;s
ec2_ami module.</p>
<p>Generally speaking, we find most users using Packer.</p>
<p>See the Packer documentation of the <a class="reference external" href="https://www.packer.io/docs/provisioners/ansible-local.html">Ansible local Packer provisioner</a> and <a class="reference external" href="https://www.packer.io/docs/provisioners/ansible.html">Ansible remote Packer provisioner</a>.</p>
<p>If you do not want to adopt Packer at this time, configuring a base-image with Ansible after provisioning (as shown above) is acceptable.</p>
</div>
<div class="section" id="next-steps-explore-modules">
<span id="aws-next-steps"></span><h5>Next Steps: Explore Modules<a class="headerlink" href="#next-steps-explore-modules" title="Permalink to this headline">¶</a></h5>
<p>Ansible ships with lots of modules for configuring a wide array of EC2 services.  Browse the &#8220;Cloud&#8221; category of the module
documentation for a full list with examples.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>All the documentation for Ansible modules</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_delegation"><span class="doc">Delegation, Rolling Updates, and Local Actions</span></a></dt>
<dd>Delegation, useful for working with loud balancers, clouds, and locally executed steps.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-guide_azure"></span><div class="section" id="getting-started-with-azure">
<h4>Getting Started with Azure<a class="headerlink" href="#getting-started-with-azure" title="Permalink to this headline">¶</a></h4>
<p>Ansible includes a suite of modules for interacting with Azure Resource Manager, giving you the tools to easily create
and orchestrate infrastructure on the Microsoft Azure Cloud.</p>
<div class="section" id="requirements">
<h5>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h5>
<p>Using the Azure Resource Manager modules requires having specific Azure SDK modules
installed on the host running Ansible.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install ansible<span class="o">[</span>azure<span class="o">]</span>
</pre></div>
</div>
<p>If you are running Ansible from source, you can install the dependencies from the
root directory of the Ansible repo.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install .<span class="o">[</span>azure<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="authenticating-with-azure">
<h5>Authenticating with Azure<a class="headerlink" href="#authenticating-with-azure" title="Permalink to this headline">¶</a></h5>
<p>Using the Azure Resource Manager modules requires authenticating with the Azure API. You can choose from two authentication strategies:</p>
<ul class="simple">
<li>Active Directory Username/Password</li>
<li>Service Principal Credentials</li>
</ul>
<p>Follow the directions for the strategy you wish to use, then proceed to <a class="reference internal" href="#providing-credentials-to-azure-modules">Providing Credentials to Azure Modules</a> for
instructions on how to actually use the modules and authenticate with the Azure API.</p>
<div class="section" id="using-service-principal">
<h6>Using Service Principal<a class="headerlink" href="#using-service-principal" title="Permalink to this headline">¶</a></h6>
<p>There is now a detailed official tutorial describing <a class="reference external" href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/">how to create a service principal</a>.</p>
<p>After stepping through the tutorial you will have:</p>
<ul class="simple">
<li>Your Client ID, which is found in the “client id” box in the “Configure” page of your application in the Azure portal</li>
<li>Your Secret key, generated when you created the application. You cannot show the key after creation.
If you lost the key, you must create a new one in the “Configure” page of your application.</li>
<li>And finally, a tenant ID. It’s a UUID (e.g. ABCDEFGH-1234-ABCD-1234-ABCDEFGHIJKL) pointing to the AD containing your
application. You will find it in the URL from within the Azure portal, or in the “view endpoints” of any given URL.</li>
</ul>
</div>
<div class="section" id="using-active-directory-username-password">
<h6>Using Active Directory Username/Password<a class="headerlink" href="#using-active-directory-username-password" title="Permalink to this headline">¶</a></h6>
<p>To create an Active Directory username/password:</p>
<ul class="simple">
<li>Connect to the Azure Classic Portal with your admin account</li>
<li>Create a user in your default AAD. You must NOT activate Multi-Factor Authentication</li>
<li>Go to Settings - Administrators</li>
<li>Click on Add and enter the email of the new user.</li>
<li>Check the checkbox of the subscription you want to test with this user.</li>
<li>Login to Azure Portal with this new user to change the temporary password to a new one. You will not be able to use the
temporary password for OAuth login.</li>
</ul>
</div>
<div class="section" id="providing-credentials-to-azure-modules">
<h6>Providing Credentials to Azure Modules<a class="headerlink" href="#providing-credentials-to-azure-modules" title="Permalink to this headline">¶</a></h6>
<p>The modules offer several ways to provide your credentials. For a CI/CD tool such as Ansible Tower or Jenkins, you will
most likely want to use environment variables. For local development you may wish to store your credentials in a file
within your home directory. And of course, you can always pass credentials as parameters to a task within a playbook. The
order of precedence is parameters, then environment variables, and finally a file found in your home directory.</p>
<div class="section" id="using-environment-variables">
<h7>Using Environment Variables<a class="headerlink" href="#using-environment-variables" title="Permalink to this headline">¶</a></h7>
<p>To pass service principal credentials via the environment, define the following variables:</p>
<ul class="simple">
<li>AZURE_CLIENT_ID</li>
<li>AZURE_SECRET</li>
<li>AZURE_SUBSCRIPTION_ID</li>
<li>AZURE_TENANT</li>
</ul>
<p>To pass Active Directory username/password via the environment, define the following variables:</p>
<ul class="simple">
<li>AZURE_AD_USER</li>
<li>AZURE_PASSWORD</li>
<li>AZURE_SUBSCRIPTION_ID</li>
</ul>
</div>
<div class="section" id="storing-in-a-file">
<h7>Storing in a File<a class="headerlink" href="#storing-in-a-file" title="Permalink to this headline">¶</a></h7>
<p>When working in a development environment, it may be desirable to store credentials in a file. The modules will look
for credentials in $HOME/.azure/credentials. This file is an ini style file. It will look as follows:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[default]</span>
<span class="na">subscription_id</span><span class="o">=</span><span class="s">xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span>
<span class="na">client_id</span><span class="o">=</span><span class="s">xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span>
<span class="na">secret</span><span class="o">=</span><span class="s">xxxxxxxxxxxxxxxxx</span>
<span class="na">tenant</span><span class="o">=</span><span class="s">xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span>
</pre></div>
</div>
<p>It is possible to store multiple sets of credentials within the credentials file by creating multiple sections. Each
section is considered a profile. The modules look for the [default] profile automatically. Define AZURE_PROFILE in the
environment or pass a profile parameter to specify a specific profile.</p>
</div>
<div class="section" id="passing-as-parameters">
<h7>Passing as Parameters<a class="headerlink" href="#passing-as-parameters" title="Permalink to this headline">¶</a></h7>
<p>If you wish to pass credentials as parameters to a task, use the following parameters for service principal:</p>
<ul class="simple">
<li>client_id</li>
<li>secret</li>
<li>subscription_id</li>
<li>tenant</li>
</ul>
<p>Or, pass the following parameters for Active Directory username/password:</p>
<ul class="simple">
<li>ad_user</li>
<li>password</li>
<li>subscription_id</li>
</ul>
</div>
</div>
</div>
<div class="section" id="other-cloud-environments">
<h5>Other Cloud Environments<a class="headerlink" href="#other-cloud-environments" title="Permalink to this headline">¶</a></h5>
<p>To use an Azure Cloud other than the default public cloud (eg, Azure China Cloud, Azure US Government Cloud, Azure Stack),
pass the &#8220;cloud_environment&#8221; argument to modules, configure it in a credential profile, or set the &#8220;AZURE_CLOUD_ENVIRONMENT&#8221;
environment variable. The value is either a cloud name as defined by the Azure Python SDK (eg, &#8220;AzureChinaCloud&#8221;,
&#8220;AzureUSGovernment&#8221;; defaults to &#8220;AzureCloud&#8221;) or an Azure metadata discovery URL (for Azure Stack).</p>
</div>
<div class="section" id="creating-virtual-machines">
<h5>Creating Virtual Machines<a class="headerlink" href="#creating-virtual-machines" title="Permalink to this headline">¶</a></h5>
<p>There are two ways to create a virtual machine, both involving the azure_rm_virtualmachine module. We can either create
a storage account, network interface, security group and public IP address and pass the names of these objects to the
module as parameters, or we can let the module do the work for us and accept the defaults it chooses.</p>
<div class="section" id="creating-individual-components">
<h6>Creating Individual Components<a class="headerlink" href="#creating-individual-components" title="Permalink to this headline">¶</a></h6>
<p>An Azure module is available to help you create a storage account, virtual network, subnet, network interface,
security group and public IP. Here is a full example of creating each of these and passing the names to the
azure_rm_virtualmachine module at the end:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create storage account</span>
  <span class="l l-Scalar l-Scalar-Plain">azure_rm_storageaccount</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testaccount001</span>
    <span class="l l-Scalar l-Scalar-Plain">account_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Standard_LRS</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create virtual network</span>
  <span class="l l-Scalar l-Scalar-Plain">azure_rm_virtualnetwork</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testvn001</span>
    <span class="l l-Scalar l-Scalar-Plain">address_prefixes</span><span class="p p-Indicator">:</span> <span class="s">&quot;10.10.0.0/16&quot;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add subnet</span>
  <span class="l l-Scalar l-Scalar-Plain">azure_rm_subnet</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">subnet001</span>
    <span class="l l-Scalar l-Scalar-Plain">address_prefix</span><span class="p p-Indicator">:</span> <span class="s">&quot;10.10.0.0/24&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">virtual_network</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testvn001</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create public ip</span>
  <span class="l l-Scalar l-Scalar-Plain">azure_rm_publicipaddress</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
    <span class="l l-Scalar l-Scalar-Plain">allocation_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Static</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">publicip001</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create security group that allows SSH</span>
  <span class="l l-Scalar l-Scalar-Plain">azure_rm_securitygroup</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">secgroup001</span>
    <span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">SSH</span>
        <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Tcp</span>
        <span class="l l-Scalar l-Scalar-Plain">destination_port_range</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
        <span class="l l-Scalar l-Scalar-Plain">access</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Allow</span>
        <span class="l l-Scalar l-Scalar-Plain">priority</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">101</span>
        <span class="l l-Scalar l-Scalar-Plain">direction</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Inbound</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create NIC</span>
  <span class="l l-Scalar l-Scalar-Plain">azure_rm_networkinterface</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testnic001</span>
    <span class="l l-Scalar l-Scalar-Plain">virtual_network</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testvn001</span>
    <span class="l l-Scalar l-Scalar-Plain">subnet</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">subnet001</span>
    <span class="l l-Scalar l-Scalar-Plain">public_ip_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">publicip001</span>
    <span class="l l-Scalar l-Scalar-Plain">security_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">secgroup001</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create virtual machine</span>
  <span class="l l-Scalar l-Scalar-Plain">azure_rm_virtualmachine</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testvm001</span>
    <span class="l l-Scalar l-Scalar-Plain">vm_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Standard_D1</span>
    <span class="l l-Scalar l-Scalar-Plain">storage_account</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testaccount001</span>
    <span class="l l-Scalar l-Scalar-Plain">storage_container</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testvm001</span>
    <span class="l l-Scalar l-Scalar-Plain">storage_blob</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testvm001.vhd</span>
    <span class="l l-Scalar l-Scalar-Plain">admin_username</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
    <span class="l l-Scalar l-Scalar-Plain">admin_password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Password!</span>
    <span class="l l-Scalar l-Scalar-Plain">network_interfaces</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testnic001</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">offer</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CentOS</span>
      <span class="l l-Scalar l-Scalar-Plain">publisher</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">OpenLogic</span>
      <span class="l l-Scalar l-Scalar-Plain">sku</span><span class="p p-Indicator">:</span> <span class="s">&#39;7.1&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
</pre></div>
</div>
<p>Each of the Azure modules offers a variety of parameter options. Not all options are demonstrated in the above example.
See each individual module for further details and examples.</p>
</div>
<div class="section" id="creating-a-virtual-machine-with-default-options">
<h6>Creating a Virtual Machine with Default Options<a class="headerlink" href="#creating-a-virtual-machine-with-default-options" title="Permalink to this headline">¶</a></h6>
<p>If you simply want to create a virtual machine without specifying all the details, you can do that as well. The only
caveat is that you will need a virtual network with one subnet already in your resource group. Assuming you have a
virtual network already with an existing subnet, you can run the following to create a VM:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">azure_rm_virtualmachine</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">resource_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Testing</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">testvm10</span>
  <span class="l l-Scalar l-Scalar-Plain">vm_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Standard_D1</span>
  <span class="l l-Scalar l-Scalar-Plain">admin_username</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">chouseknecht</span>
  <span class="l l-Scalar l-Scalar-Plain">ssh_password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">ssh_public_keys</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ssh_keys</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">offer</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CentOS</span>
    <span class="l l-Scalar l-Scalar-Plain">publisher</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">OpenLogic</span>
    <span class="l l-Scalar l-Scalar-Plain">sku</span><span class="p p-Indicator">:</span> <span class="s">&#39;7.1&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dynamic-inventory-script">
<h5>Dynamic Inventory Script<a class="headerlink" href="#dynamic-inventory-script" title="Permalink to this headline">¶</a></h5>
<p>If you are not familiar with Ansible&#8217;s dynamic inventory scripts, check out <a class="reference external" href="http://docs.ansible.com/ansible/intro_dynamic_inventory.html">Intro to Dynamic Inventory</a>.</p>
<p>The Azure Resource Manager inventory script is called azure_rm.py. It authenticates with the Azure API exactly the same as the
Azure modules, which means you will either define the same environment variables described above in <a class="reference internal" href="#using-environment-variables">Using Environment Variables</a>,
create a $HOME/.azure/credentials file (also described above in <a class="reference internal" href="#storing-in-a-file">Storing in a File</a>), or pass command line parameters. To see available command
line options execute the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ./ansible/contrib/inventory/azure_rm.py --help
</pre></div>
</div>
<p>As with all dynamic inventory scripts, the script can be executed directly, passed as a parameter to the ansible command,
or passed directly to ansible-playbook using the -i option. No matter how it is executed the script produces JSON representing
all of the hosts found in your Azure subscription. You can narrow this down to just hosts found in a specific set of
Azure resource groups, or even down to a specific host.</p>
<p>For a given host, the inventory script provides the following host variables:</p>
<div class="highlight-JSON"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;ansible_host&quot;</span><span class="p">:</span> <span class="s2">&quot;XXX.XXX.XXX.XXX&quot;</span><span class="p">,</span>
  <span class="nt">&quot;computer_name&quot;</span><span class="p">:</span> <span class="s2">&quot;computer_name2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fqdn&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/subscription-id/resourceGroups/galaxy-production/providers/Microsoft.Compute/virtualMachines/object-name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;offer&quot;</span><span class="p">:</span> <span class="s2">&quot;CentOS&quot;</span><span class="p">,</span>
    <span class="nt">&quot;publisher&quot;</span><span class="p">:</span> <span class="s2">&quot;OpenLogic&quot;</span><span class="p">,</span>
    <span class="nt">&quot;sku&quot;</span><span class="p">:</span> <span class="s2">&quot;7.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;latest&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;westus&quot;</span><span class="p">,</span>
  <span class="nt">&quot;mac_address&quot;</span><span class="p">:</span> <span class="s2">&quot;00-00-5E-00-53-FE&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;object-name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;network_interface&quot;</span><span class="p">:</span> <span class="s2">&quot;interface-name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;network_interface_id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/subscription-id/resourceGroups/galaxy-production/providers/Microsoft.Network/networkInterfaces/object-name1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;network_security_group&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&quot;network_security_group_id&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&quot;os_disk&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;object-name&quot;</span><span class="p">,</span>
    <span class="nt">&quot;operating_system_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Linux&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;plan&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&quot;powerstate&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">,</span>
  <span class="nt">&quot;private_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.3.6&quot;</span><span class="p">,</span>
  <span class="nt">&quot;private_ip_alloc_method&quot;</span><span class="p">:</span> <span class="s2">&quot;Static&quot;</span><span class="p">,</span>
  <span class="nt">&quot;provisioning_state&quot;</span><span class="p">:</span> <span class="s2">&quot;Succeeded&quot;</span><span class="p">,</span>
  <span class="nt">&quot;public_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;XXX.XXX.XXX.XXX&quot;</span><span class="p">,</span>
  <span class="nt">&quot;public_ip_alloc_method&quot;</span><span class="p">:</span> <span class="s2">&quot;Static&quot;</span><span class="p">,</span>
  <span class="nt">&quot;public_ip_id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/subscription-id/resourceGroups/galaxy-production/providers/Microsoft.Network/publicIPAddresses/object-name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;public_ip_name&quot;</span><span class="p">:</span> <span class="s2">&quot;object-name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;resource_group&quot;</span><span class="p">:</span> <span class="s2">&quot;galaxy-production&quot;</span><span class="p">,</span>
  <span class="nt">&quot;security_group&quot;</span><span class="p">:</span> <span class="s2">&quot;object-name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;/subscriptions/subscription-id/resourceGroups/galaxy-production/providers/Microsoft.Network/networkSecurityGroups/object-name&quot;</span><span class="p">,</span>
  <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.Compute/virtualMachines&quot;</span><span class="p">,</span>
  <span class="nt">&quot;virtual_machine_size&quot;</span><span class="p">:</span> <span class="s2">&quot;Standard_DS4&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="host-groups">
<h6>Host Groups<a class="headerlink" href="#host-groups" title="Permalink to this headline">¶</a></h6>
<p>By default hosts are grouped by:</p>
<ul class="simple">
<li>azure (all hosts)</li>
<li>location name</li>
<li>resource group name</li>
<li>security group name</li>
<li>tag key</li>
<li>tag key_value</li>
</ul>
<p>You can control host groupings and host selection by either defining environment variables or creating an
azure_rm.ini file in your current working directory.</p>
<p>NOTE: An .ini file will take precedence over environment variables.</p>
<p>NOTE: The name of the .ini file is the basename of the inventory script (i.e. &#8216;azure_rm&#8217;) with a &#8216;.ini&#8217;
extension. This allows you to copy, rename and customize the inventory script and have matching .ini files all in
the same directory.</p>
<p>Control grouping using the following variables defined in the environment:</p>
<ul class="simple">
<li>AZURE_GROUP_BY_RESOURCE_GROUP=yes</li>
<li>AZURE_GROUP_BY_LOCATION=yes</li>
<li>AZURE_GROUP_BY_SECURITY_GROUP=yes</li>
<li>AZURE_GROUP_BY_TAG=yes</li>
</ul>
<p>Select hosts within specific resource groups by assigning a comma separated list to:</p>
<ul class="simple">
<li>AZURE_RESOURCE_GROUPS=resource_group_a,resource_group_b</li>
</ul>
<p>Select hosts for specific tag key by assigning a comma separated list of tag keys to:</p>
<ul class="simple">
<li>AZURE_TAGS=key1,key2,key3</li>
</ul>
<p>Select hosts for specific locations by assigning a comma separated list of locations to:</p>
<ul class="simple">
<li>AZURE_LOCATIONS=eastus,eastus2,westus</li>
</ul>
<p>Or, select hosts for specific tag key:value pairs by assigning a comma separated list key:value pairs to:</p>
<ul class="simple">
<li>AZURE_TAGS=key1:value1,key2:value2</li>
</ul>
<p>If you don&#8217;t need the powerstate, you can improve performance by turning off powerstate fetching:</p>
<ul class="simple">
<li>AZURE_INCLUDE_POWERSTATE=no</li>
</ul>
<p>A sample azure_rm.ini file is included along with the inventory script in contrib/inventory. An .ini
file will contain the following:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[azure]</span>
<span class="c1"># Control which resource groups are included. By default all resources groups are included.</span>
<span class="c1"># Set resource_groups to a comma separated list of resource groups names.</span>
<span class="c1">#resource_groups=</span>

<span class="c1"># Control which tags are included. Set tags to a comma separated list of keys or key:value pairs</span>
<span class="c1">#tags=</span>

<span class="c1"># Control which locations are included. Set locations to a comma separated list of locations.</span>
<span class="c1">#locations=</span>

<span class="c1"># Include powerstate. If you don&#39;t need powerstate information, turning it off improves runtime performance.</span>
<span class="c1"># Valid values: yes, no, true, false, True, False, 0, 1.</span>
<span class="na">include_powerstate</span><span class="o">=</span><span class="s">yes</span>

<span class="c1"># Control grouping with the following boolean flags. Valid values: yes, no, true, false, True, False, 0, 1.</span>
<span class="na">group_by_resource_group</span><span class="o">=</span><span class="s">yes</span>
<span class="na">group_by_location</span><span class="o">=</span><span class="s">yes</span>
<span class="na">group_by_security_group</span><span class="o">=</span><span class="s">yes</span>
<span class="na">group_by_tag</span><span class="o">=</span><span class="s">yes</span>
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h6>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h6>
<p>Here are some examples using the inventory script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Execute /bin/uname on all instances in the Testing resource group</span>
$ ansible -i azure_rm.py Testing -m shell -a <span class="s2">&quot;/bin/uname -a&quot;</span>

<span class="c1"># Use the inventory script to print instance specific information</span>
$ ./ansible/contrib/inventory/azure_rm.py --host my_instance_host_name --resource-groups<span class="o">=</span>Testing --pretty

<span class="c1"># Use the inventory script with ansible-playbook</span>
$ ansible-playbook -i ./ansible/contrib/inventory/azure_rm.py test_playbook.yml
</pre></div>
</div>
<p>Here is a simple playbook to exercise the Azure inventory script:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Test the inventory script</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">azure</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ inventory_hostname }} has powerstate {{ powerstate }}&quot;</span>
</pre></div>
</div>
<p>You can execute the playbook with something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-playbook -i ./ansible/contrib/inventory/azure_rm.py test_azure_inventory.yml
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-guide_rax"></span><div class="section" id="rackspace-cloud-guide">
<h4>Rackspace Cloud Guide<a class="headerlink" href="#rackspace-cloud-guide" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<span id="rax-introduction"></span><h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section of the documentation is under construction. We are in the process of adding more examples about the Rackspace modules and how they work together.  Once complete, there will also be examples for Rackspace Cloud in <a class="reference external" href="https://github.com/ansible/ansible-examples/">ansible-examples</a>.</p>
</div>
<p>Ansible contains a number of core modules for interacting with Rackspace Cloud.</p>
<p>The purpose of this section is to explain how to put Ansible modules together
(and use inventory scripts) to use Ansible in a Rackspace Cloud context.</p>
<p>Prerequisites for using the rax modules are minimal.  In addition to ansible itself,
all of the modules require and are tested against pyrax 1.5 or higher.
You&#8217;ll need this Python module installed on the execution host.</p>
<p>pyrax is not currently available in many operating system
package repositories, so you will likely need to install it via pip:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install pyrax
</pre></div>
</div>
<p>The following steps will often execute from the control machine against the Rackspace Cloud API, so it makes sense
to add localhost to the inventory file.  (Ansible may not require this manual step in the future):</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[localhost]</span>
<span class="na">localhost ansible_connection</span><span class="o">=</span><span class="s">local</span>
</pre></div>
</div>
<p>In playbook steps, we&#8217;ll typically be using the following pattern:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
</pre></div>
</div>
</div>
<div class="section" id="credentials-file">
<span id="id1"></span><h5>Credentials File<a class="headerlink" href="#credentials-file" title="Permalink to this headline">¶</a></h5>
<p>The <cite>rax.py</cite> inventory script and all <cite>rax</cite> modules support a standard <cite>pyrax</cite> credentials file that looks like:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[rackspace_cloud]</span>
<span class="na">username</span> <span class="o">=</span> <span class="s">myraxusername</span>
<span class="na">api_key</span> <span class="o">=</span> <span class="s">d41d8cd98f00b204e9800998ecf8427e</span>
</pre></div>
</div>
<p>Setting the environment parameter RAX_CREDS_FILE to the path of this file will help Ansible find how to load
this information.</p>
<p>More information about this credentials file can be found at
<a class="reference external" href="https://github.com/rackspace/pyrax/blob/master/docs/getting_started.md#authenticating">https://github.com/rackspace/pyrax/blob/master/docs/getting_started.md#authenticating</a></p>
<div class="section" id="running-from-a-python-virtual-environment-optional">
<span id="virtual-environment"></span><h6>Running from a Python Virtual Environment (Optional)<a class="headerlink" href="#running-from-a-python-virtual-environment-optional" title="Permalink to this headline">¶</a></h6>
<p>Most users will not be using virtualenv, but some users, particularly Python developers sometimes like to.</p>
<p>There are special considerations when Ansible is installed to a Python virtualenv, rather than the default of installing at a global scope. Ansible assumes, unless otherwise instructed, that the python binary will live at /usr/bin/python.  This is done via the interpreter line in modules, however when instructed by setting the inventory variable &#8216;ansible_python_interpreter&#8217;, Ansible will use this specified path instead to find Python.  This can be a cause of confusion as one may assume that modules running on &#8216;localhost&#8217;, or perhaps running via &#8216;local_action&#8217;, are using the virtualenv Python interpreter.  By setting this line in the inventory, the modules will execute in the virtualenv interpreter and have available the virtualenv packages, specifically pyrax. If using virtualenv, you may wish to modify your localhost inventory definition to find this location as follows:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[localhost]</span>
<span class="na">localhost ansible_connection</span><span class="o">=</span><span class="s">local ansible_python_interpreter=/path/to/ansible_venv/bin/python</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">pyrax may be installed in the global Python package scope or in a virtual environment.  There are no special considerations to keep in mind when installing pyrax.</p>
</div>
</div>
</div>
<div class="section" id="provisioning">
<span id="id2"></span><h5>Provisioning<a class="headerlink" href="#provisioning" title="Permalink to this headline">¶</a></h5>
<p>Now for the fun parts.</p>
<p>The &#8216;rax&#8217; module provides the ability to provision instances within Rackspace Cloud.  Typically the provisioning task will be performed from your Ansible control server (in our example, localhost) against the Rackspace cloud API.  This is done for several reasons:</p>
<blockquote>
<div><ul class="simple">
<li>Avoiding installing the pyrax library on remote nodes</li>
<li>No need to encrypt and distribute credentials to remote nodes</li>
<li>Speed and simplicity</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Authentication with the Rackspace-related modules is handled by either
specifying your username and API key as environment variables or passing
them as module arguments, or by specifying the location of a credentials
file.</p>
</div>
<p>Here is a basic example of provisioning an instance in ad-hoc mode:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible localhost -m rax -a <span class="s2">&quot;name=awx flavor=4 image=ubuntu-1204-lts-precise-pangolin wait=yes&quot;</span> -c <span class="nb">local</span>
</pre></div>
</div>
<p>Here&#8217;s what it would look like in a playbook, assuming the parameters were defined in variables:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Provision a set of instances</span>
    <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">flavor</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_flavor</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_image</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">count</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_count</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">group</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">wait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>
</pre></div>
</div>
<p>The rax module returns data about the nodes it creates, like IP addresses, hostnames, and login passwords.  By registering the return value of the step, it is possible used this data to dynamically add the resulting hosts to inventory (temporarily, in memory). This facilitates performing configuration actions on the hosts in a follow-on task.  In the following example, the servers that were successfully created using the above task are dynamically added to a group called &#8220;raxhosts&#8221;, with each nodes hostname, IP address, and root password being added to the inventory.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible 2.0 has deprecated the “ssh” from <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code>, <code class="docutils literal"><span class="pre">ansible_ssh_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_ssh_port</span></code> to become <code class="docutils literal"><span class="pre">ansible_user</span></code>, <code class="docutils literal"><span class="pre">ansible_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_port</span></code>. If you are using a version of Ansible prior to 2.0,  you should continue using the older style variables (<code class="docutils literal"><span class="pre">ansible_ssh_*</span></code>). These shorter variables are ignored, without warning, in older versions of Ansible.</p>
</div>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add the instances we created (by public IP) to the group &#39;raxhosts&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">add_host</span>
      <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">ansible_host</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">ansible_ssh_pass</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_adminpass</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">groups</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">raxhosts</span>
  <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax.success</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax.action == &#39;create&#39;</span>
</pre></div>
</div>
<p>With the host group now created, the next play in this playbook could now configure servers belonging to the raxhosts group.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Configuration play</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">raxhosts</span>
  <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ntp</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">webserver</span>
</pre></div>
</div>
<p>The method above ties the configuration of a host with the provisioning step.  This isn&#8217;t always what you want, and leads us
to the next section.</p>
</div>
<div class="section" id="host-inventory">
<span id="id3"></span><h5>Host Inventory<a class="headerlink" href="#host-inventory" title="Permalink to this headline">¶</a></h5>
<p>Once your nodes are spun up, you&#8217;ll probably want to talk to them again.  The best way to handle this is to use the &#8220;rax&#8221; inventory plugin, which dynamically queries Rackspace Cloud and tells Ansible what nodes you have to manage.  You might want to use this even if you are spinning up cloud instances via other tools, including the Rackspace Cloud user interface. The inventory plugin can be used to group resources by metadata, region, OS, etc.  Utilizing metadata is highly recommended in &#8220;rax&#8221; and can provide an easy way to sort between host groups and roles. If you don&#8217;t want to use the <code class="docutils literal"><span class="pre">rax.py</span></code> dynamic inventory script, you could also still choose to manually manage your INI inventory file, though this is less recommended.</p>
<p>In Ansible it is quite possible to use multiple dynamic inventory plugins along with INI file data.  Just put them in a common directory and be sure the scripts are chmod +x, and the INI-based ones are not.</p>
<div class="section" id="rax-py">
<span id="raxpy"></span><h6>rax.py<a class="headerlink" href="#rax-py" title="Permalink to this headline">¶</a></h6>
<p>To use the rackspace dynamic inventory script, copy <code class="docutils literal"><span class="pre">rax.py</span></code> into your inventory directory and make it executable. You can specify a credentials file for <code class="docutils literal"><span class="pre">rax.py</span></code> utilizing the <code class="docutils literal"><span class="pre">RAX_CREDS_FILE</span></code> environment variable.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Dynamic inventory scripts (like <code class="docutils literal"><span class="pre">rax.py</span></code>) are saved in <code class="docutils literal"><span class="pre">/usr/share/ansible/inventory</span></code> if Ansible has been installed globally.  If installed to a virtualenv, the inventory scripts are installed to <code class="docutils literal"><span class="pre">$VIRTUALENV/share/inventory</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Users of <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a> will note that dynamic inventory is natively supported by Tower, and all you have to do is associate a group with your Rackspace Cloud credentials, and it will easily synchronize without going through these steps:</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nv">RAX_CREDS_FILE</span><span class="o">=</span>~/.raxpub ansible all -i rax.py -m setup
</pre></div>
</div>
</div>
<p><code class="docutils literal"><span class="pre">rax.py</span></code> also accepts a <code class="docutils literal"><span class="pre">RAX_REGION</span></code> environment variable, which can contain an individual region, or a comma separated list of regions.</p>
<p>When using <code class="docutils literal"><span class="pre">rax.py</span></code>, you will not have a &#8216;localhost&#8217; defined in the inventory.</p>
<p>As mentioned previously, you will often be running most of these modules outside of the host loop, and will need &#8216;localhost&#8217; defined.  The recommended way to do this, would be to create an <code class="docutils literal"><span class="pre">inventory</span></code> directory, and place both the <code class="docutils literal"><span class="pre">rax.py</span></code> script and a file containing <code class="docutils literal"><span class="pre">localhost</span></code> in it.</p>
<p>Executing <code class="docutils literal"><span class="pre">ansible</span></code> or <code class="docutils literal"><span class="pre">ansible-playbook</span></code> and specifying the <code class="docutils literal"><span class="pre">inventory</span></code> directory instead
of an individual file, will cause ansible to evaluate each file in that directory for inventory.</p>
<p>Let&#8217;s test our inventory script to see if it can talk to Rackspace Cloud.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nv">RAX_CREDS_FILE</span><span class="o">=</span>~/.raxpub ansible all -i inventory/ -m setup
</pre></div>
</div>
<p>Assuming things are properly configured, the <code class="docutils literal"><span class="pre">rax.py</span></code> inventory script will output information similar to the
following information, which will be utilized for inventory and variables.</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;ORD&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;test&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;_meta&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;hostvars&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ansible_host&quot;</span><span class="p">:</span> <span class="s2">&quot;198.51.100.1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_accessipv4&quot;</span><span class="p">:</span> <span class="s2">&quot;198.51.100.1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_accessipv6&quot;</span><span class="p">:</span> <span class="s2">&quot;2001:DB8::2342&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_addresses&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;192.0.2.2&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                        <span class="p">}</span>
                    <span class="p">],</span>
                    <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;198.51.100.1&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;2001:DB8::2342&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">6</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_config_drive&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_created&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:48:22Z&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_flavor&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;performance1-1&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/flavors/performance1-1&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_hostid&quot;</span><span class="p">:</span> <span class="s2">&quot;e7b6961a9bd943ee82b13816426f1563bfda6846aad84d52af45a4904660cde0&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_human_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_id&quot;</span><span class="p">:</span> <span class="s2">&quot;099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_image&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/images/b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_key_name&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nt">&quot;rax_links&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/v2/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;self&quot;</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="nt">&quot;rax_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_name&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_name_attr&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_networks&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;192.0.2.2&quot;</span>
                    <span class="p">],</span>
                    <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;198.51.100.1&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;2001:DB8::2342&quot;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_os-dcf_diskconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_os-ext-sts_power_state&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nt">&quot;rax_os-ext-sts_task_state&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nt">&quot;rax_os-ext-sts_vm_state&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="nt">&quot;rax_status&quot;</span><span class="p">:</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_tenant_id&quot;</span><span class="p">:</span> <span class="s2">&quot;111111&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:49:27Z&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;22222&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="standard-inventory">
<span id="id4"></span><h6>Standard Inventory<a class="headerlink" href="#standard-inventory" title="Permalink to this headline">¶</a></h6>
<p>When utilizing a standard ini formatted inventory file (as opposed to the inventory plugin), it may still be advantageous to retrieve discoverable hostvar information  from the Rackspace API.</p>
<p>This can be achieved with the <code class="docutils literal"><span class="pre">rax_facts</span></code> module and an inventory file similar to the following:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[test_servers]</span>
<span class="na">hostname1 rax_region</span><span class="o">=</span><span class="s">ORD</span>
<span class="na">hostname2 rax_region</span><span class="o">=</span><span class="s">ORD</span>
</pre></div>
</div>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Gather info about servers</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_servers</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Get facts about servers</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_region</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Map some facts</span>
      <span class="l l-Scalar l-Scalar-Plain">set_fact</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_host</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>While you don&#8217;t need to know how it works, it may be interesting to know what kind of variables are returned.</p>
<p>The <code class="docutils literal"><span class="pre">rax_facts</span></code> module provides facts as followings, which match the <code class="docutils literal"><span class="pre">rax.py</span></code> inventory script:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;ansible_facts&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;rax_accessipv4&quot;</span><span class="p">:</span> <span class="s2">&quot;198.51.100.1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_accessipv6&quot;</span><span class="p">:</span> <span class="s2">&quot;2001:DB8::2342&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_addresses&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;192.0.2.2&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;198.51.100.1&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;2001:DB8::2342&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">6</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_config_drive&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_created&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:48:22Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_flavor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;performance1-1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/flavors/performance1-1&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_hostid&quot;</span><span class="p">:</span> <span class="s2">&quot;e7b6961a9bd943ee82b13816426f1563bfda6846aad84d52af45a4904660cde0&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_human_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_id&quot;</span><span class="p">:</span> <span class="s2">&quot;099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_image&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
            <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/images/b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_key_name&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nt">&quot;rax_links&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/v2/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;self&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">&quot;rax_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_name&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_name_attr&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_networks&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;192.0.2.2&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;198.51.100.1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;2001:DB8::2342&quot;</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_os-dcf_diskconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_os-ext-sts_power_state&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;rax_os-ext-sts_task_state&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nt">&quot;rax_os-ext-sts_vm_state&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nt">&quot;rax_status&quot;</span><span class="p">:</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_tenant_id&quot;</span><span class="p">:</span> <span class="s2">&quot;111111&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:49:27Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;22222&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;changed&quot;</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="use-cases">
<h5>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h5>
<p>This section covers some additional usage examples built around a specific use case.</p>
<div class="section" id="network-and-server">
<span id="id5"></span><h6>Network and Server<a class="headerlink" href="#network-and-server" title="Permalink to this headline">¶</a></h6>
<p>Create an isolated cloud network and build a server</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Build Servers on an Isolated Network</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Network create request</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_network</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">label</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-net</span>
        <span class="l l-Scalar l-Scalar-Plain">cidr</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.3.0/24</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IAD</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Server create request</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web%04d.example.org</span>
        <span class="l l-Scalar l-Scalar-Plain">flavor</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-1204-lts-precise-pangolin</span>
        <span class="l l-Scalar l-Scalar-Plain">disk_config</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">manual</span>
        <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">public</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">my-net</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IAD</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="l l-Scalar l-Scalar-Plain">count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">exact_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
        <span class="l l-Scalar l-Scalar-Plain">wait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">wait_timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">360</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>
</pre></div>
</div>
</div>
<div class="section" id="complete-environment">
<span id="id6"></span><h6>Complete Environment<a class="headerlink" href="#complete-environment" title="Permalink to this headline">¶</a></h6>
<p>Build a complete webserver environment with servers, custom networks and load balancers, install nginx and create a custom index.html</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Build environment</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Load Balancer create request</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_clb</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-lb</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
        <span class="l l-Scalar l-Scalar-Plain">algorithm</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ROUND_ROBIN</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PUBLIC</span>
        <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IAD</span>
        <span class="l l-Scalar l-Scalar-Plain">wait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="l l-Scalar l-Scalar-Plain">meta</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-cool-app</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">clb</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Network create request</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_network</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">label</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-net</span>
        <span class="l l-Scalar l-Scalar-Plain">cidr</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.3.0/24</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IAD</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">network</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Server create request</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web%04d.example.org</span>
        <span class="l l-Scalar l-Scalar-Plain">flavor</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">performance1-1</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-1204-lts-precise-pangolin</span>
        <span class="l l-Scalar l-Scalar-Plain">disk_config</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">manual</span>
        <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">public</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">private</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">my-net</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IAD</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="l l-Scalar l-Scalar-Plain">count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">exact_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
        <span class="l l-Scalar l-Scalar-Plain">wait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add servers to web host group</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">add_host</span>
        <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_host</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_ssh_pass</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_adminpass</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class="l l-Scalar l-Scalar-Plain">groups</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax.success</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax.action == &#39;create&#39;</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add servers to Load balancer</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_clb_nodes</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">load_balancer_id</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">clb.balancer.id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">address</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_networks.private|first</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">enabled</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>
        <span class="l l-Scalar l-Scalar-Plain">wait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IAD</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax.success</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax.action == &#39;create&#39;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Configure servers</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
  <span class="l l-Scalar l-Scalar-Plain">handlers</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">restart nginx</span>
      <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=nginx state=restarted</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install nginx</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pkg=nginx state=latest update_cache=yes cache_valid_time=86400</span>
      <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">restart nginx</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure nginx starts on boot</span>
      <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=nginx state=started enabled=yes</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create custom index.html</span>
      <span class="l l-Scalar l-Scalar-Plain">copy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">content=&quot;{{ inventory_hostname }}&quot; dest=/usr/share/nginx/www/index.html</span>
            <span class="l l-Scalar l-Scalar-Plain">owner=root group=root mode=0644</span>
</pre></div>
</div>
</div>
<div class="section" id="rackconnect-and-managed-cloud">
<span id="rackconnect-and-manged-cloud"></span><h6>RackConnect and Managed Cloud<a class="headerlink" href="#rackconnect-and-managed-cloud" title="Permalink to this headline">¶</a></h6>
<p>When using RackConnect version 2 or Rackspace Managed Cloud there are Rackspace automation tasks that are executed on the servers you create after they are successfully built. If your automation executes before the RackConnect or Managed Cloud automation, you can cause failures and un-usable servers.</p>
<p>These examples show creating servers, and ensuring that the Rackspace automation has completed before Ansible continues onwards.</p>
<p>For simplicity, these examples are joined, however both are only needed when using RackConnect.  When only using Managed Cloud, the RackConnect portion can be ignored.</p>
<p>The RackConnect portions only apply to RackConnect version 2.</p>
<div class="section" id="using-a-control-machine">
<span id="id7"></span><h7>Using a Control Machine<a class="headerlink" href="#using-a-control-machine" title="Permalink to this headline">¶</a></h7>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create an exact count of servers</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Server build requests</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web%03d.example.org</span>
        <span class="l l-Scalar l-Scalar-Plain">flavor</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">performance1-1</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-1204-lts-precise-pangolin</span>
        <span class="l l-Scalar l-Scalar-Plain">disk_config</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">manual</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DFW</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="l l-Scalar l-Scalar-Plain">count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="l l-Scalar l-Scalar-Plain">exact_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
        <span class="l l-Scalar l-Scalar-Plain">wait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add servers to in memory groups</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">add_host</span>
        <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_host</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_ssh_pass</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_adminpass</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class="l l-Scalar l-Scalar-Plain">rax_id</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">groups</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web,new_web</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax.success</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax.action == &#39;create&#39;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for rackconnect and managed cloud automation to complete</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">new_web</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for rackconnnect automation to complete</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DFW</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts</span>
      <span class="l l-Scalar l-Scalar-Plain">until</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts.ansible_facts[&#39;rax_metadata&#39;][&#39;rackconnect_automation_status&#39;]|default(&#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for managed cloud automation to complete</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts</span>
        <span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~/.raxpub</span>
        <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DFW</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts</span>
      <span class="l l-Scalar l-Scalar-Plain">until</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts.ansible_facts[&#39;rax_metadata&#39;][&#39;rax_service_level_automation&#39;]|default(&#39;&#39;) == &#39;Complete&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Update new_web hosts with IP that RackConnect assigns</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">new_web</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Get facts about servers</span>
      <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_facts</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DFW</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Map some facts</span>
      <span class="l l-Scalar l-Scalar-Plain">set_fact</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">ansible_host</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Base Configure Servers</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openssh</span>
      <span class="l l-Scalar l-Scalar-Plain">opensshd_PermitRootLogin</span><span class="p p-Indicator">:</span> <span class="s">&quot;no&quot;</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ntp</span>
</pre></div>
</div>
</div>
<div class="section" id="using-ansible-pull">
<span id="id8"></span><h7>Using Ansible Pull<a class="headerlink" href="#using-ansible-pull" title="Permalink to this headline">¶</a></h7>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure Rackconnect and Managed Cloud Automation is complete</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Check for completed bootstrap</span>
      <span class="l l-Scalar l-Scalar-Plain">stat</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/bootstrap_complete</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Get region</span>
      <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">xenstore-read vm-data/provider_data/region</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rax_region</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.stat.exists != True</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for rackconnect automation to complete</span>
      <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="s">&quot;https://{{</span><span class="nv"> </span><span class="s">rax_region.stdout|trim</span><span class="nv"> </span><span class="s">}}.api.rackconnect.rackspace.com/v1/automation_status?format=json&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">return_content</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">automation_status</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l l-Scalar l-Scalar-Plain">until</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">automation_status[&#39;automation_status&#39;]|default(&#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for managed cloud automation to complete</span>
      <span class="l l-Scalar l-Scalar-Plain">wait_for</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/rs_managed_cloud_automation_complete</span>
        <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.stat.exists != True</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Set bootstrap completed</span>
      <span class="l l-Scalar l-Scalar-Plain">file</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/bootstrap_complete</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
        <span class="l l-Scalar l-Scalar-Plain">owner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0400</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Base Configure Servers</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openssh</span>
      <span class="l l-Scalar l-Scalar-Plain">opensshd_PermitRootLogin</span><span class="p p-Indicator">:</span> <span class="s">&quot;no&quot;</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ntp</span>
</pre></div>
</div>
</div>
<div class="section" id="using-ansible-pull-with-xenstore">
<span id="id9"></span><h7>Using Ansible Pull with XenStore<a class="headerlink" href="#using-ansible-pull-with-xenstore" title="Permalink to this headline">¶</a></h7>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure Rackconnect and Managed Cloud Automation is complete</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Check for completed bootstrap</span>
      <span class="l l-Scalar l-Scalar-Plain">stat</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/bootstrap_complete</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for rackconnect_automation_status xenstore key to exist</span>
      <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">xenstore-exists vm-data/user-metadata/rackconnect_automation_status</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rcas_exists</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l l-Scalar l-Scalar-Plain">failed_when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rcas_exists.rc|int &gt; 1</span>
      <span class="l l-Scalar l-Scalar-Plain">until</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rcas_exists.rc|int == 0</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for rackconnect automation to complete</span>
      <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">xenstore-read vm-data/user-metadata/rackconnect_automation_status</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rcas</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l l-Scalar l-Scalar-Plain">until</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rcas.stdout|replace(&#39;&quot;&#39;, &#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for rax_service_level_automation xenstore key to exist</span>
      <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">xenstore-exists vm-data/user-metadata/rax_service_level_automation</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rsla_exists</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l l-Scalar l-Scalar-Plain">failed_when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rsla_exists.rc|int &gt; 1</span>
      <span class="l l-Scalar l-Scalar-Plain">until</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rsla_exists.rc|int == 0</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for managed cloud automation to complete</span>
      <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">xenstore-read vm-data/user-metadata/rackconnect_automation_status</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rsla</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l l-Scalar l-Scalar-Plain">until</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rsla.stdout|replace(&#39;&quot;&#39;, &#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Set bootstrap completed</span>
      <span class="l l-Scalar l-Scalar-Plain">file</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/bootstrap_complete</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
        <span class="l l-Scalar l-Scalar-Plain">owner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
        <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0400</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Base Configure Servers</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openssh</span>
      <span class="l l-Scalar l-Scalar-Plain">opensshd_PermitRootLogin</span><span class="p p-Indicator">:</span> <span class="s">&quot;no&quot;</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ntp</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="advanced-usage">
<span id="id10"></span><h5>Advanced Usage<a class="headerlink" href="#advanced-usage" title="Permalink to this headline">¶</a></h5>
<div class="section" id="autoscaling-with-tower">
<span id="awx-autoscale"></span><h6>Autoscaling with Tower<a class="headerlink" href="#autoscaling-with-tower" title="Permalink to this headline">¶</a></h6>
<p><a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a> also contains a very nice feature for auto-scaling use cases.
In this mode, a simple curl script can call a defined URL and the server will &#8220;dial out&#8221; to the requester
and configure an instance that is spinning up.  This can be a great way to reconfigure ephemeral nodes.
See the Tower documentation for more details.</p>
<p>A benefit of using the callback in Tower over pull mode is that job results are still centrally recorded
and less information has to be shared with remote hosts.</p>
</div>
<div class="section" id="orchestration-in-the-rackspace-cloud">
<span id="pending-information"></span><h6>Orchestration in the Rackspace Cloud<a class="headerlink" href="#orchestration-in-the-rackspace-cloud" title="Permalink to this headline">¶</a></h6>
<p>Ansible is a powerful orchestration tool, and rax modules allow you the opportunity to orchestrate complex tasks, deployments, and configurations.  The key here is to automate provisioning of infrastructure, like any other piece of software in an environment.  Complex deployments might have previously required manual manipulation of load balancers, or manual provisioning of servers.  Utilizing the rax modules included with Ansible, one can make the deployment of additional nodes contingent on the current number of running nodes, or the configuration of a clustered application dependent on the number of nodes with common metadata.  One could automate the following scenarios, for example:</p>
<ul class="simple">
<li>Servers that are removed from a Cloud Load Balancer one-by-one, updated, verified, and returned to the load balancer pool</li>
<li>Expansion of an already-online environment, where nodes are provisioned, bootstrapped, configured, and software installed</li>
<li>A procedure where app log files are uploaded to a central location, like Cloud Files, before a node is decommissioned</li>
<li>Servers and load balancers that have DNS records created and destroyed on creation and decommissioning, respectively</li>
</ul>
</div>
</div>
</div>
<span id="document-guide_gce"></span><div class="section" id="google-cloud-platform-guide">
<h4>Google Cloud Platform Guide<a class="headerlink" href="#google-cloud-platform-guide" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section of the documentation is under construction. We are in the process of adding more examples about all of the GCE modules and how they work together. Upgrades via github pull requests are welcomed!</p>
</div>
<p>Ansible contains modules for managing Google Compute Engine resources, including creating instances, controlling network access, working with persistent disks, and managing
load balancers.  Additionally, there is an inventory plugin that can automatically suck down all of your GCE instances into Ansible dynamic inventory, and create groups by tag and other properties.</p>
<p>The GCE modules all require the apache-libcloud module which you can install from pip:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install apache-libcloud
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you&#8217;re using Ansible on Mac OS X, libcloud also needs to access a CA cert chain. You&#8217;ll need to download one (you can get one for <a class="reference external" href="http://curl.haxx.se/docs/caextract.html">here</a>.)</p>
</div>
</div>
<div class="section" id="credentials">
<h5>Credentials<a class="headerlink" href="#credentials" title="Permalink to this headline">¶</a></h5>
<p>To work with the GCE modules, you&#8217;ll first need to get some credentials in the
JSON format:</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount#creatinganaccount">Create a Service Account</a></li>
<li><a class="reference external" href="https://support.google.com/cloud/answer/6158849?hl=en&amp;ref_topic=6262490#serviceaccounts">Download JSON credentials</a></li>
</ol>
<p>There are three different ways to provide credentials to Ansible so that it can talk with Google Cloud for provisioning and configuration actions:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you would like to use JSON credentials you must have libcloud &gt;= 0.17.0</p>
</div>
<ul class="simple">
<li>by providing to the modules directly</li>
<li>by populating a <code class="docutils literal"><span class="pre">secrets.py</span></code> file</li>
<li>by setting environment variables</li>
</ul>
<div class="section" id="calling-modules-by-passing-credentials">
<h6>Calling Modules By Passing Credentials<a class="headerlink" href="#calling-modules-by-passing-credentials" title="Permalink to this headline">¶</a></h6>
<p>For the GCE modules you can specify the credentials as arguments:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">service_account_email</span></code>: email associated with the project</li>
<li><code class="docutils literal"><span class="pre">credentials_file</span></code>: path to the JSON credentials file</li>
<li><code class="docutils literal"><span class="pre">project_id</span></code>: id of the project</li>
</ul>
<p>For example, to create a new instance using the cloud module, you can use the following configuration:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create instance(s)</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>

  <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">service_account_email</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">unique-id@developer.gserviceaccount.com</span>
    <span class="l l-Scalar l-Scalar-Plain">credentials_file</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/project.json</span>
    <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">project-id</span>
    <span class="l l-Scalar l-Scalar-Plain">machine_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">n1-standard-1</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">debian-7</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>

   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Launch instances</span>
     <span class="l l-Scalar l-Scalar-Plain">gce</span><span class="p p-Indicator">:</span>
         <span class="l l-Scalar l-Scalar-Plain">instance_names</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dev</span>
         <span class="l l-Scalar l-Scalar-Plain">machine_type</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">machine_type</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l l-Scalar l-Scalar-Plain">service_account_email</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">service_account_email</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l l-Scalar l-Scalar-Plain">credentials_file</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">credentials_file</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">project_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>When running Ansible inside a GCE VM you can use the service account credentials from the local metadata server by
setting both <code class="docutils literal"><span class="pre">service_account_email</span></code> and <code class="docutils literal"><span class="pre">credentials_file</span></code> to a blank string.</p>
</div>
<div class="section" id="configuring-modules-with-secrets-py">
<h6>Configuring Modules with secrets.py<a class="headerlink" href="#configuring-modules-with-secrets-py" title="Permalink to this headline">¶</a></h6>
<p>Create a file <code class="docutils literal"><span class="pre">secrets.py</span></code> looking like following, and put it in some folder which is in your <code class="docutils literal"><span class="pre">$PYTHONPATH</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">GCE_PARAMS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;i...@project.googleusercontent.com&#39;</span><span class="p">,</span> <span class="s1">&#39;/path/to/project.json&#39;</span><span class="p">)</span>
<span class="n">GCE_KEYWORD_PARAMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="s1">&#39;project_id&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Ensure to enter the email address from the created services account and not the one from your main account.</p>
<p>Now the modules can be used as above, but the account information can be omitted.</p>
<p>If you are running Ansible from inside a GCE VM with an authorized service account you can set the email address and
credentials path as follows so that get automatically picked up:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">GCE_PARAMS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">GCE_KEYWORD_PARAMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="s1">&#39;datacenter&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-modules-with-environment-variables">
<h6>Configuring Modules with Environment Variables<a class="headerlink" href="#configuring-modules-with-environment-variables" title="Permalink to this headline">¶</a></h6>
<p>Set the following environment variables before running Ansible in order to configure your credentials:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>GCE_EMAIL
GCE_PROJECT
GCE_CREDENTIALS_FILE_PATH
</pre></div>
</div>
</div>
</div>
<div class="section" id="gce-dynamic-inventory">
<h5>GCE Dynamic Inventory<a class="headerlink" href="#gce-dynamic-inventory" title="Permalink to this headline">¶</a></h5>
<p>The best way to interact with your hosts is to use the gce inventory plugin, which dynamically queries GCE and tells Ansible what nodes can be managed.</p>
<p>Note that when using the inventory script <code class="docutils literal"><span class="pre">gce.py</span></code>, you also need to populate the <code class="docutils literal"><span class="pre">gce.ini</span></code> file that you can find in the contrib/inventory directory of the ansible checkout.</p>
<p>To use the GCE dynamic inventory script, copy <code class="docutils literal"><span class="pre">gce.py</span></code> from <code class="docutils literal"><span class="pre">contrib/inventory</span></code> into your inventory directory and make it executable. You can specify credentials for <code class="docutils literal"><span class="pre">gce.py</span></code> using the <code class="docutils literal"><span class="pre">GCE_INI_PATH</span></code> environment variable &#8211; the default is to look for gce.ini in the same directory as the inventory script.</p>
<p>Let&#8217;s see if inventory is working:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ./gce.py --list
</pre></div>
</div>
<p>You should see output describing the hosts you have, if any, running in Google Compute Engine.</p>
<p>Now let&#8217;s see if we can use the inventory script to talk to Google.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nv">GCE_INI_PATH</span><span class="o">=</span>~/.gce.ini ansible all -i gce.py -m setup
hostname <span class="p">|</span> success &gt;&gt; <span class="o">{</span>
  <span class="s2">&quot;ansible_facts&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;ansible_all_ipv4_addresses&quot;</span>: <span class="o">[</span>
      <span class="s2">&quot;x.x.x.x&quot;</span>
    <span class="o">]</span>,
</pre></div>
</div>
<p>As with all dynamic inventory scripts in Ansible, you can configure the inventory path in ansible.cfg.  The recommended way to use the inventory is to create an <code class="docutils literal"><span class="pre">inventory</span></code> directory, and place both the <code class="docutils literal"><span class="pre">gce.py</span></code> script and a file containing <code class="docutils literal"><span class="pre">localhost</span></code> in it.  This can allow for cloud inventory to be used alongside local inventory (such as a physical datacenter) or machines running in different providers.</p>
<p>Executing <code class="docutils literal"><span class="pre">ansible</span></code> or <code class="docutils literal"><span class="pre">ansible-playbook</span></code> and specifying the <code class="docutils literal"><span class="pre">inventory</span></code> directory instead of an individual file will cause ansible to evaluate each file in that directory for inventory.</p>
<p>Let&#8217;s once again use our inventory script to see if it can talk to Google Cloud:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible all -i inventory/ -m setup
hostname <span class="p">|</span> success &gt;&gt; <span class="o">{</span>
  <span class="s2">&quot;ansible_facts&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;ansible_all_ipv4_addresses&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;x.x.x.x&quot;</span>
    <span class="o">]</span>,
</pre></div>
</div>
<p>The output should be similar to the previous command.  If you&#8217;re wanting less output and just want to check for SSH connectivity, use &#8220;-m&#8221; ping instead.</p>
</div>
<div class="section" id="use-cases">
<h5>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h5>
<p>For the following use case, let&#8217;s use this small shell script as a wrapper.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nv">PLAYBOOK</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="k">if</span> <span class="o">[[</span> -z <span class="nv">$PLAYBOOK</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;You need to pass a playbook as argument to this script.&quot;</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="nb">export</span> <span class="nv">SSL_CERT_FILE</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/cacert.pem
<span class="nb">export</span> <span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span>False

<span class="k">if</span> <span class="o">[[</span> ! -f <span class="s2">&quot;</span><span class="nv">$SSL_CERT_FILE</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  curl -O http://curl.haxx.se/ca/cacert.pem
<span class="k">fi</span>

ansible-playbook -v -i inventory/ <span class="s2">&quot;</span><span class="nv">$PLAYBOOK</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="section" id="create-an-instance">
<h6>Create an instance<a class="headerlink" href="#create-an-instance" title="Permalink to this headline">¶</a></h6>
<p>The GCE module provides the ability to provision instances within Google Compute Engine. The provisioning task is typically performed from your Ansible control server against Google Cloud&#8217;s API.</p>
<p>A playbook would looks like this:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create instance(s)</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>

  <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">machine_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">n1-standard-1</span> <span class="c1"># default</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">debian-7</span>
    <span class="l l-Scalar l-Scalar-Plain">service_account_email</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">unique-id@developer.gserviceaccount.com</span>
    <span class="l l-Scalar l-Scalar-Plain">credentials_file</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/project.json</span>
    <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">project-id</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Launch instances</span>
      <span class="l l-Scalar l-Scalar-Plain">gce</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">instance_names</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dev</span>
          <span class="l l-Scalar l-Scalar-Plain">machine_type</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">machine_type</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">service_account_email</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">service_account_email</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">credentials_file</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">credentials_file</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">project_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">webserver</span>
      <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gce</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Wait for SSH to come up</span>
      <span class="l l-Scalar l-Scalar-Plain">wait_for</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">host={{ item.public_ip }} port=22 delay=10 timeout=60</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">gce.instance_data</span><span class="nv"> </span><span class="s">}}&quot;</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Add host to groupname</span>
      <span class="l l-Scalar l-Scalar-Plain">add_host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">hostname={{ item.public_ip }} groupname=new_instances</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">gce.instance_data</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Manage new instances</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">new_instances</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh</span>
  <span class="l l-Scalar l-Scalar-Plain">sudo</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">base_configuration</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">production_server</span>
</pre></div>
</div>
<p>Note that use of the &#8220;add_host&#8221; module above creates a temporary, in-memory group.  This means that a play in the same playbook can then manage machines
in the &#8216;new_instances&#8217; group, if so desired.  Any sort of arbitrary configuration is possible at this point.</p>
</div>
<div class="section" id="configuring-instances-in-a-group">
<h6>Configuring instances in a group<a class="headerlink" href="#configuring-instances-in-a-group" title="Permalink to this headline">¶</a></h6>
<p>All of the created instances in GCE are grouped by tag.  Since this is a cloud, it&#8217;s probably best to ignore hostnames and just focus on group management.</p>
<p>Normally we&#8217;d also use roles here, but the following example is a simple one.  Here we will also use the &#8220;gce_net&#8221; module to open up access to port 80 on
these nodes.</p>
<p>The variables in the &#8216;vars&#8217; section could also be kept in a &#8216;vars_files&#8217; file or something encrypted with Ansible-vault, if you so choose.  This is just
a basic example of what is possible:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Setup web servers
  hosts: tag_webserver
  gather_facts: no

  vars:
    machine_type: n1-standard-1 <span class="c1"># default</span>
    image: debian-7
    service_account_email: unique-id@developer.gserviceaccount.com
    credentials_file: /path/to/project.json
    project_id: project-id

  roles:

    - name: Install lighttpd
      apt: <span class="nv">pkg</span><span class="o">=</span>lighttpd <span class="nv">state</span><span class="o">=</span>installed
      sudo: True

    - name: Allow HTTP
      local_action: gce_net
      args:
        fwname: <span class="s2">&quot;all-http&quot;</span>
        name: <span class="s2">&quot;default&quot;</span>
        allowed: <span class="s2">&quot;tcp:80&quot;</span>
        state: <span class="s2">&quot;present&quot;</span>
        service_account_email: <span class="s2">&quot;{{ service_account_email }}&quot;</span>
        credentials_file: <span class="s2">&quot;{{ credentials_file }}&quot;</span>
        project_id: <span class="s2">&quot;{{ project_id }}&quot;</span>
</pre></div>
</div>
<p>By pointing your browser to the IP of the server, you should see a page welcoming you.</p>
<p>Upgrades to this documentation are welcome, hit the github link at the top right of this page if you would like to make additions!</p>
</div>
</div>
</div>
<span id="document-guide_cloudstack"></span><div class="section" id="cloudstack-cloud-guide">
<h4>CloudStack Cloud Guide<a class="headerlink" href="#cloudstack-cloud-guide" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<span id="cloudstack-introduction"></span><h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<p>The purpose of this section is to explain how to put Ansible modules together to use Ansible in a CloudStack context. You will find more usage examples in the details section of each module.</p>
<p>Ansible contains a number of extra modules for interacting with CloudStack based clouds. All modules support check mode, are designed to be idempotent, have been created and tested, and are maintained by the community.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some of the modules will require domain admin or root admin privileges.</p>
</div>
</div>
<div class="section" id="prerequisites">
<h5>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h5>
<p>Prerequisites for using the CloudStack modules are minimal. In addition to Ansible itself, all of the modules require the python library <code class="docutils literal"><span class="pre">cs</span></code> <a class="reference external" href="https://pypi.python.org/pypi/cs">https://pypi.python.org/pypi/cs</a>.</p>
<p>You&#8217;ll need this Python module installed on the execution host, usually your workstation.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install cs
</pre></div>
</div>
<p>Or alternatively starting with Debian 9 and Ubuntu 16.04:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo apt install python-cs
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">cs also includes a command line interface for ad-hoc interaction with the CloudStack API e.g. <code class="docutils literal"><span class="pre">$</span> <span class="pre">cs</span> <span class="pre">listVirtualMachines</span> <span class="pre">state=Running</span></code>.</p>
</div>
</div>
<div class="section" id="limitations-and-known-issues">
<h5>Limitations and Known Issues<a class="headerlink" href="#limitations-and-known-issues" title="Permalink to this headline">¶</a></h5>
<p>VPC support has been improved since Ansible 2.3 but is still not yet fully implemented. The community is working on the VPC integration.</p>
</div>
<div class="section" id="credentials-file">
<h5>Credentials File<a class="headerlink" href="#credentials-file" title="Permalink to this headline">¶</a></h5>
<p>You can pass credentials and the endpoint of your cloud as module arguments, however in most cases it is a far less work to store your credentials in the cloudstack.ini file.</p>
<p>The python library cs looks for the credentials file in the following order (last one wins):</p>
<ul class="simple">
<li>A <code class="docutils literal"><span class="pre">.cloudstack.ini</span></code> (note the dot) file in the home directory.</li>
<li>A <code class="docutils literal"><span class="pre">CLOUDSTACK_CONFIG</span></code> environment variable pointing to an .ini file.</li>
<li>A <code class="docutils literal"><span class="pre">cloudstack.ini</span></code> (without the dot) file in the current working directory, same directory as your playbooks are located.</li>
</ul>
<p>The structure of the ini file must look like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat <span class="nv">$HOME</span>/.cloudstack.ini
<span class="o">[</span>cloudstack<span class="o">]</span>
<span class="nv">endpoint</span> <span class="o">=</span> https://cloud.example.com/client/api
<span class="nv">key</span> <span class="o">=</span> api key
<span class="nv">secret</span> <span class="o">=</span> api secret
<span class="nv">timeout</span> <span class="o">=</span> <span class="m">30</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The section <code class="docutils literal"><span class="pre">[cloudstack]</span></code> is the default section. <code class="docutils literal"><span class="pre">CLOUDSTACK_REGION</span></code> environment variable can be used to define the default section.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.4.</span></p>
</div>
<p>The ENV variables support <code class="docutils literal"><span class="pre">CLOUDSTACK_*</span></code> as written in the documentation of the library <code class="docutils literal"><span class="pre">cs</span></code>,  like e.g <code class="docutils literal"><span class="pre">CLOUDSTACK_TIMEOUT</span></code>, <code class="docutils literal"><span class="pre">CLOUDSTACK_METHOD</span></code>, etc. has been implemented into Ansible. It is even possible to have some incomplete config in your cloudstack.ini:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat <span class="nv">$HOME</span>/.cloudstack.ini
<span class="o">[</span>cloudstack<span class="o">]</span>
<span class="nv">endpoint</span> <span class="o">=</span> https://cloud.example.com/client/api
<span class="nv">timeout</span> <span class="o">=</span> <span class="m">30</span>
</pre></div>
</div>
<p>and fulfill the missing data by either setting ENV variables or tasks params:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">provision our VMs</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-vm</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure VMs are created and running</span>
      <span class="l l-Scalar l-Scalar-Plain">cs_instance</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">api_key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">your api key</span>
        <span class="l l-Scalar l-Scalar-Plain">api_secret</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">your api secret</span>
        <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
</div>
<div class="section" id="regions">
<h5>Regions<a class="headerlink" href="#regions" title="Permalink to this headline">¶</a></h5>
<p>If you use more than one CloudStack region, you can define as many sections as you want and name them as you like, e.g.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat <span class="nv">$HOME</span>/.cloudstack.ini
<span class="o">[</span>exoscale<span class="o">]</span>
<span class="nv">endpoint</span> <span class="o">=</span> https://api.exoscale.ch/compute
<span class="nv">key</span> <span class="o">=</span> api key
<span class="nv">secret</span> <span class="o">=</span> api secret

<span class="o">[</span>exmaple_cloud_one<span class="o">]</span>
<span class="nv">endpoint</span> <span class="o">=</span> https://cloud-one.example.com/client/api
<span class="nv">key</span> <span class="o">=</span> api key
<span class="nv">secret</span> <span class="o">=</span> api secret

<span class="o">[</span>exmaple_cloud_two<span class="o">]</span>
<span class="nv">endpoint</span> <span class="o">=</span> https://cloud-two.example.com/client/api
<span class="nv">key</span> <span class="o">=</span> api key
<span class="nv">secret</span> <span class="o">=</span> api secret
</pre></div>
</div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Sections can also be used to for login into the same region using different accounts.</p>
</div>
<p>By passing the argument <code class="docutils literal"><span class="pre">api_region</span></code> with the CloudStack modules, the region wanted will be selected.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure my ssh public key exists on Exoscale</span>
  <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cs_sshkeypair</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-ssh-key</span>
    <span class="l l-Scalar l-Scalar-Plain">public_key</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">&#39;~/.ssh/id_rsa.pub&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">api_region</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">exoscale</span>
</pre></div>
</div>
<p>Or by looping over a regions list if you want to do the task in every region:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure my ssh public key exists in all CloudStack regions</span>
  <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cs_sshkeypair</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-ssh-key</span>
    <span class="l l-Scalar l-Scalar-Plain">public_key</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">&#39;~/.ssh/id_rsa.pub&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">api_region</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">exoscale</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">exmaple_cloud_one</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">exmaple_cloud_two</span>
</pre></div>
</div>
</div>
<div class="section" id="environment-variables">
<h5>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.3.</span></p>
</div>
<p>Since Ansible 2.3 it is possible to use environment variables for domain (<code class="docutils literal"><span class="pre">CLOUDSTACK_DOMAIN</span></code>), account (<code class="docutils literal"><span class="pre">CLOUDSTACK_ACCOUNT</span></code>), project (<code class="docutils literal"><span class="pre">CLOUDSTACK_PROJECT</span></code>), VPC (<code class="docutils literal"><span class="pre">CLOUDSTACK_VPC</span></code>) and zone (<code class="docutils literal"><span class="pre">CLOUDSTACK_ZONE</span></code>). This simplifies the tasks by not repeating the arguments for every tasks.</p>
<p>Below you see an example how it can be used in combination with Ansible&#8217;s block feature:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-vm</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">block</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure my ssh public key</span>
          <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cs_sshkeypair</span>
            <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-ssh-key</span>
            <span class="l l-Scalar l-Scalar-Plain">public_key</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">&#39;~/.ssh/id_rsa.pub&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>

        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure my ssh public key</span>
          <span class="l l-Scalar l-Scalar-Plain">local_action</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cs_instance</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">display_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_hostname_short</span><span class="nv"> </span><span class="s">}}&quot;</span>
              <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Linux Debian 7 64-bit 20GB Disk</span>
              <span class="l l-Scalar l-Scalar-Plain">service_offering</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cs_offering</span><span class="nv"> </span><span class="s">}}&quot;</span>
              <span class="l l-Scalar l-Scalar-Plain">ssh_key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-ssh-key</span>
              <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">running</span>

      <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">CLOUDSTACK_DOMAIN</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root/customers</span>
        <span class="l l-Scalar l-Scalar-Plain">CLOUDSTACK_PROJECT</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web-app</span>
        <span class="l l-Scalar l-Scalar-Plain">CLOUDSTACK_ZONE</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sf-1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You are still able overwrite the environment variables using the module arguments, e.g. <code class="docutils literal"><span class="pre">zone:</span> <span class="pre">sf-2</span></code></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unlike <code class="docutils literal"><span class="pre">CLOUDSTACK_REGION</span></code> these additional environment variables are ingored in the CLI <code class="docutils literal"><span class="pre">cs</span></code>.</p>
</div>
</div>
<div class="section" id="use-cases">
<h5>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h5>
<p>The following should give you some ideas how to use the modules to provision VMs to the cloud. As always, there isn&#8217;t only one way to do it. But as always: keep it simple for the beginning is always a good start.</p>
<div class="section" id="use-case-provisioning-in-a-advanced-networking-cloudstack-setup">
<h6>Use Case: Provisioning in a Advanced Networking CloudStack setup<a class="headerlink" href="#use-case-provisioning-in-a-advanced-networking-cloudstack-setup" title="Permalink to this headline">¶</a></h6>
<p>Our CloudStack cloud has an advanced networking setup, we would like to provision web servers, which get a static NAT and open firewall ports 80 and 443. Further we provision database servers, to which we do not give any access to. For accessing the VMs by SSH we use a SSH jump host.</p>
<p>This is how our inventory looks like:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>[cloud-vm:children]
webserver
db-server
jumphost

[webserver]
web-01.example.com  public_ip=198.51.100.20
web-02.example.com  public_ip=198.51.100.21

[db-server]
db-01.example.com
db-02.example.com

[jumphost]
jump.example.com  public_ip=198.51.100.22
</pre></div>
</div>
<p>As you can see, the public IPs for our web servers and jumphost has been assigned as variable <code class="docutils literal"><span class="pre">public_ip</span></code> directly in the inventory.</p>
<p>The configure the jumphost, web servers and database servers, we use <code class="docutils literal"><span class="pre">group_vars</span></code>. The <code class="docutils literal"><span class="pre">group_vars</span></code> directory contains 4 files for configuration of the groups: cloud-vm, jumphost, webserver and db-server. The cloud-vm is there for specifying the defaults of our cloud infrastructure.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: group_vars/cloud-vm</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">cs_offering</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Small</span>
<span class="l l-Scalar l-Scalar-Plain">cs_firewall</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>
</pre></div>
</div>
<p>Our database servers should get more CPU and RAM, so we define to use a <code class="docutils literal"><span class="pre">Large</span></code> offering for them.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: group_vars/db-server</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">cs_offering</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Large</span>
</pre></div>
</div>
<p>The web servers should get a <code class="docutils literal"><span class="pre">Small</span></code> offering as we would scale them horizontally, which is also our default offering. We also ensure the known web ports are opened for the world.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: group_vars/webserver</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">cs_firewall</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">port</span><span class="p p-Indicator">:</span> <span class="nv">80</span> <span class="p p-Indicator">}</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">port</span><span class="p p-Indicator">:</span> <span class="nv">443</span> <span class="p p-Indicator">}</span>
</pre></div>
</div>
<p>Further we provision a jump host which has only port 22 opened for accessing the VMs from our office IPv4 network.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: group_vars/jumphost</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">cs_firewall</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">port</span><span class="p p-Indicator">:</span> <span class="nv">22</span><span class="p p-Indicator">,</span> <span class="nv">cidr</span><span class="p p-Indicator">:</span> <span class="s">&quot;17.17.17.0/24&quot;</span> <span class="p p-Indicator">}</span>
</pre></div>
</div>
<p>Now to the fun part. We create a playbook to create our infrastructure we call it <code class="docutils literal"><span class="pre">infra.yml</span></code>:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: infra.yaml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">provision our VMs</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-vm</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure VMs are created and running</span>
      <span class="l l-Scalar l-Scalar-Plain">cs_instance</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_hostname_short</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Linux Debian 7 64-bit 20GB Disk</span>
        <span class="l l-Scalar l-Scalar-Plain">service_offering</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cs_offering</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">running</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure firewall ports opened</span>
      <span class="l l-Scalar l-Scalar-Plain">cs_firewall</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">ip_address</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">public_ip</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.port</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">cidr</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.cidr</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(&#39;0.0.0.0/0&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cs_firewall</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">public_ip is defined</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure static NATs</span>
      <span class="l l-Scalar l-Scalar-Plain">cs_staticnat</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">vm=&quot;{{ inventory_hostname_short }}&quot; ip_address=&quot;{{ public_ip }}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">public_ip is defined</span>
</pre></div>
</div>
<p>In the above play we defined 3 tasks and use the group <code class="docutils literal"><span class="pre">cloud-vm</span></code> as target to handle all VMs in the cloud but instead SSH to these VMs, we use <code class="docutils literal"><span class="pre">connetion=local</span></code> to execute the API calls locally from our workstation.</p>
<p>In the first task, we ensure we have a running VM created with the Debian template. If the VM is already created but stopped, it would just start it. If you like to change the offering on an existing VM, you must add <code class="docutils literal"><span class="pre">force:</span> <span class="pre">yes</span></code> to the task, which would stop the VM, change the offering and start the VM again.</p>
<p>In the second task we ensure the ports are opened if we give a public IP to the VM.</p>
<p>In the third task we add static NAT to the VMs having a public IP defined.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The public IP addresses must have been acquired in advance, also see <code class="docutils literal"><span class="pre">cs_ip_address</span></code></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For some modules, e.g. <code class="docutils literal"><span class="pre">cs_sshkeypair</span></code> you usually want this to be executed only once, not for every VM. Therefore you would make a separate play for it targeting localhost. You find an example in the use cases below.</p>
</div>
</div>
<div class="section" id="use-case-provisioning-on-a-basic-networking-cloudstack-setup">
<h6>Use Case: Provisioning on a Basic Networking CloudStack setup<a class="headerlink" href="#use-case-provisioning-on-a-basic-networking-cloudstack-setup" title="Permalink to this headline">¶</a></h6>
<p>A basic networking CloudStack setup is slightly different: Every VM gets a public IP directly assigned and security groups are used for access restriction policy.</p>
<p>This is how our inventory looks like:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>[cloud-vm:children]
webserver

[webserver]
web-01.example.com
web-02.example.com
</pre></div>
</div>
<p>The default for your VMs looks like this:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: group_vars/cloud-vm</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">cs_offering</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Small</span>
<span class="l l-Scalar l-Scalar-Plain">cs_securitygroups</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span> <span class="s">&#39;default&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Our webserver will also be in security group <code class="docutils literal"><span class="pre">web</span></code>:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: group_vars/webserver</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">cs_securitygroups</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span> <span class="s">&#39;default&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;web&#39;</span> <span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>The playbook looks like the following:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># file: infra.yaml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud base setup</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">upload ssh public key</span>
    <span class="l l-Scalar l-Scalar-Plain">cs_sshkeypair</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">defaultkey</span>
      <span class="l l-Scalar l-Scalar-Plain">public_key</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">&#39;~/.ssh/id_rsa.pub&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure security groups exist</span>
    <span class="l l-Scalar l-Scalar-Plain">cs_securitygroup</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">add inbound SSH to security group default</span>
    <span class="l l-Scalar l-Scalar-Plain">cs_securitygroup_rule</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">security_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
      <span class="l l-Scalar l-Scalar-Plain">start_port</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">end_port</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">22</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">add inbound TCP rules to security group web</span>
    <span class="l l-Scalar l-Scalar-Plain">cs_securitygroup_rule</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">security_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
      <span class="l l-Scalar l-Scalar-Plain">start_port</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">end_port</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">443</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">install VMs in the cloud</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-vm</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">create and run VMs on CloudStack</span>
    <span class="l l-Scalar l-Scalar-Plain">cs_instance</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_hostname_short</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Linux Debian 7 64-bit 20GB Disk</span>
      <span class="l l-Scalar l-Scalar-Plain">service_offering</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cs_offering</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">security_groups</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cs_securitygroups</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">ssh_key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">defaultkey</span>
      <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Running</span>
    <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">vm</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">show VM IP</span>
    <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;VM {{ inventory_hostname }} {{ vm.default_ip }}&quot;</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">assing IP to the inventory</span>
    <span class="l l-Scalar l-Scalar-Plain">set_fact</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ansible_ssh_host={{ vm.default_ip }}</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">waiting for SSH to come up</span>
    <span class="l l-Scalar l-Scalar-Plain">wait_for</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">port=22 host={{ vm.default_ip }} delay=5</span>
</pre></div>
</div>
<p>In the first play we setup the security groups, in the second play the VMs will created be assigned to these groups. Further you see, that we assign the public IP returned from the modules to the host inventory. This is needed as we do not know the IPs we will get in advance. In a next step you would configure the DNS servers with these IPs for accassing the VMs with their DNS name.</p>
<p>In the last task we wait for SSH to be accessible, so any later play would be able to access the VM by SSH without failure.</p>
</div>
</div>
</div>
<span id="document-guide_vagrant"></span><div class="section" id="using-vagrant-and-ansible">
<h4>Using Vagrant and Ansible<a class="headerlink" href="#using-vagrant-and-ansible" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<span id="vagrant-intro"></span><h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="http://vagrantup.com/">Vagrant</a> is a tool to manage virtual machine
environments, and allows you to configure and use reproducible work
environments on top of various virtualization and cloud platforms.
It also has integration with Ansible as a provisioner for these virtual
machines, and the two tools work together well.</p>
<p>This guide will describe how to use Vagrant 1.7+ and Ansible together.</p>
<p>If you&#8217;re not familiar with Vagrant, you should visit <a class="reference external" href="http://docs.vagrantup.com/v2/">the documentation</a>.</p>
<p>This guide assumes that you already have Ansible installed and working.
Running from a Git checkout is fine. Follow the <a class="reference internal" href="index.html#document-intro_installation"><span class="doc">Installation</span></a>
guide for more information.</p>
</div>
<div class="section" id="vagrant-setup">
<span id="id1"></span><h5>Vagrant Setup<a class="headerlink" href="#vagrant-setup" title="Permalink to this headline">¶</a></h5>
<p>The first step once you&#8217;ve installed Vagrant is to create a <code class="docutils literal"><span class="pre">Vagrantfile</span></code>
and customize it to suit your needs. This is covered in detail in the Vagrant
documentation, but here is a quick example that includes a section to use the
Ansible provisioner to manage a single machine:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span></span><span class="c1"># This guide is optimized for Vagrant 1.7 and above.</span>
<span class="c1"># Although versions 1.6.x should behave very similarly, it is recommended</span>
<span class="c1"># to upgrade instead of disabling the requirement below.</span>
<span class="no">Vagrant</span><span class="o">.</span><span class="n">require_version</span> <span class="s2">&quot;&gt;= 1.7.0&quot;</span>

<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/trusty64&quot;</span>

  <span class="c1"># Disable the new default behavior introduced in Vagrant 1.7, to</span>
  <span class="c1"># ensure that all Vagrant machines will use the same SSH key pair.</span>
  <span class="c1"># See https://github.com/mitchellh/vagrant/issues/5005</span>
  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">insert_key</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
    <span class="n">ansible</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span>
    <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;playbook.yml&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal"><span class="pre">config.vm.provision</span></code> section that refers to an Ansible playbook
called <code class="docutils literal"><span class="pre">playbook.yml</span></code> in the same directory as the <code class="docutils literal"><span class="pre">Vagrantfile</span></code>. Vagrant
runs the provisioner once the virtual machine has booted and is ready for SSH
access.</p>
<p>There are a lot of Ansible options you can configure in your <code class="docutils literal"><span class="pre">Vagrantfile</span></code>.
Visit the <a class="reference external" href="http://docs.vagrantup.com/v2/provisioning/ansible.html">Ansible Provisioner documentation</a> for more
information.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vagrant up
</pre></div>
</div>
<p>This will start the VM, and run the provisioning playbook (on the first VM
startup).</p>
<p>To re-run a playbook on an existing VM, just run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vagrant provision
</pre></div>
</div>
<p>This will re-run the playbook against the existing VM.</p>
<p>Note that having the <code class="docutils literal"><span class="pre">ansible.verbose</span></code> option enabled will instruct Vagrant
to show the full <code class="docutils literal"><span class="pre">ansible-playbook</span></code> command used behind the scene, as
illustrated by this example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span> <span class="nv">ANSIBLE_FORCE_COLOR</span><span class="o">=</span><span class="nb">true</span> <span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span><span class="nb">false</span> <span class="nv">ANSIBLE_SSH_ARGS</span><span class="o">=</span><span class="s1">&#39;-o UserKnownHostsFile=/dev/null -o ControlMaster=auto -o ControlPersist=60s&#39;</span> ansible-playbook --private-key<span class="o">=</span>/home/someone/.vagrant.d/insecure_private_key --user<span class="o">=</span>vagrant --connection<span class="o">=</span>ssh --limit<span class="o">=</span><span class="s1">&#39;machine1&#39;</span> --inventory-file<span class="o">=</span>/home/someone/coding-in-a-project/.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory playbook.yml
</pre></div>
</div>
<p>This information can be quite useful to debug integration issues and can also
be used to manually execute Ansible from a shell, as explained in the next
section.</p>
</div>
<div class="section" id="running-ansible-manually">
<span id="running-ansible"></span><h5>Running Ansible Manually<a class="headerlink" href="#running-ansible-manually" title="Permalink to this headline">¶</a></h5>
<p>Sometimes you may want to run Ansible manually against the machines. This is
faster than kicking <code class="docutils literal"><span class="pre">vagrant</span> <span class="pre">provision</span></code> and pretty easy to do.</p>
<p>With our <code class="docutils literal"><span class="pre">Vagrantfile</span></code> example, Vagrant automatically creates an Ansible
inventory file in <code class="docutils literal"><span class="pre">.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory</span></code>.
This inventory is configured according to the SSH tunnel that Vagrant
automatically creates. A typical automatically-created inventory file for a
single machine environment may look something like this:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># Generated by Vagrant

default ansible_ssh_host=127.0.0.1 ansible_ssh_port=2222
</pre></div>
</div>
<p>If you want to run Ansible manually, you will want to make sure to pass
<code class="docutils literal"><span class="pre">ansible</span></code> or <code class="docutils literal"><span class="pre">ansible-playbook</span></code> commands the correct arguments, at least
for the <em>username</em>, the <em>SSH private key</em> and the <em>inventory</em>.</p>
<p>Here is an example using the Vagrant global insecure key (<code class="docutils literal"><span class="pre">config.ssh.insert_key</span></code>
must be set to <code class="docutils literal"><span class="pre">false</span></code> in your <code class="docutils literal"><span class="pre">Vagrantfile</span></code>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-playbook --private-key<span class="o">=</span>~/.vagrant.d/insecure_private_key -u vagrant -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory playbook.yml
</pre></div>
</div>
<p>Here is a second example using the random private key that Vagrant 1.7+
automatically configures for each new VM (each key is stored in a path like
<code class="docutils literal"><span class="pre">.vagrant/machines/[machine</span> <span class="pre">name]/[provider]/private_key</span></code>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-playbook --private-key<span class="o">=</span>.vagrant/machines/default/virtualbox/private_key -u vagrant -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory playbook.yml
</pre></div>
</div>
</div>
<div class="section" id="advanced-usages">
<h5>Advanced Usages<a class="headerlink" href="#advanced-usages" title="Permalink to this headline">¶</a></h5>
<p>The &#8220;Tips and Tricks&#8221; chapter of the <a class="reference external" href="http://docs.vagrantup.com/v2/provisioning/ansible.html">Ansible Provisioner documentation</a> provides detailed information about more advanced Ansible features like:</p>
<blockquote>
<div><ul class="simple">
<li>how to parallely execute a playbook in a multi-machine environment</li>
<li>how to integrate a local <code class="docutils literal"><span class="pre">ansible.cfg</span></code> configuration file</li>
</ul>
</div></blockquote>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference external" href="http://www.vagrantup.com/">Vagrant Home</a></dt>
<dd>The Vagrant homepage with downloads</dd>
<dt><a class="reference external" href="http://docs.vagrantup.com/v2/">Vagrant Documentation</a></dt>
<dd>Vagrant Documentation</dd>
<dt><a class="reference external" href="http://docs.vagrantup.com/v2/provisioning/ansible.html">Ansible Provisioner</a></dt>
<dd>The Vagrant documentation for the Ansible provisioner</dd>
<dt><a class="reference external" href="https://github.com/mitchellh/vagrant/issues?q=is%3Aopen+is%3Aissue+label%3Aprovisioners%2Fansible">Vagrant Issue Tracker</a></dt>
<dd>The open issues for the Ansible provisioner in the Vagrant project</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
</dl>
</div>
</div>
</div>
<span id="document-guide_rolling_upgrade"></span><div class="section" id="continuous-delivery-and-rolling-upgrades">
<h4>Continuous Delivery and Rolling Upgrades<a class="headerlink" href="#continuous-delivery-and-rolling-upgrades" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<span id="lamp-introduction"></span><h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<p>Continuous Delivery is the concept of frequently delivering updates to your software application.</p>
<p>The idea is that by updating more often, you do not have to wait for a specific timed period, and your organization
gets better at the process of responding to change.</p>
<p>Some Ansible users are deploying updates to their end users on an hourly or even more frequent basis &#8211; sometimes every time
there is an approved code change.  To achieve this, you need tools to be able to quickly apply those updates in a zero-downtime way.</p>
<p>This document describes in detail how to achieve this goal, using one of Ansible&#8217;s most complete example
playbooks as a template: lamp_haproxy. This example uses a lot of Ansible features: roles, templates,
and group variables, and it also comes with an orchestration playbook that can do zero-downtime
rolling upgrades of the web application stack.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="https://github.com/ansible/ansible-examples/tree/master/lamp_haproxy">Click here for the latest playbooks for this example</a>.</p>
</div>
<p>The playbooks deploy Apache, PHP, MySQL, Nagios, and HAProxy to a CentOS-based set of servers.</p>
<p>We&#8217;re not going to cover how to run these playbooks here. Read the included README in the github project along with the
example for that information. Instead, we&#8217;re going to take a close look at every part of the playbook and describe what it does.</p>
</div>
<div class="section" id="site-deployment">
<span id="lamp-deployment"></span><h5>Site Deployment<a class="headerlink" href="#site-deployment" title="Permalink to this headline">¶</a></h5>
<p>Let&#8217;s start with <code class="docutils literal"><span class="pre">site.yml</span></code>. This is our site-wide deployment playbook. It can be used to initially deploy the site, as well
as push updates to all of the servers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># This playbook deploys the whole application stack in this site.</span>

<span class="c1"># Apply common configuration to all hosts</span>
- hosts: all

  roles:
  - common

<span class="c1"># Configure and deploy database servers.</span>
- hosts: dbservers

  roles:
  - db

<span class="c1"># Configure and deploy the web servers. Note that we include two roles</span>
<span class="c1"># here, the &#39;base-apache&#39; role which simply sets up Apache, and &#39;web&#39;</span>
<span class="c1"># which includes our example web application.</span>

- hosts: webservers

  roles:
  - base-apache
  - web

<span class="c1"># Configure and deploy the load balancer(s).</span>
- hosts: lbservers

  roles:
  - haproxy

<span class="c1"># Configure and deploy the Nagios monitoring node(s).</span>
- hosts: monitoring

  roles:
  - base-apache
  - nagios
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you&#8217;re not familiar with terms like playbooks and plays, you should review <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a>.</p>
</div>
<p>In this playbook we have 5 plays. The first one targets <code class="docutils literal"><span class="pre">all</span></code> hosts and applies the <code class="docutils literal"><span class="pre">common</span></code> role to all of the hosts.
This is for site-wide things like yum repository configuration, firewall configuration, and anything else that needs to apply to all of the servers.</p>
<p>The next four plays run against specific host groups and apply specific roles to those servers.
Along with the roles for Nagios monitoring, the database, and the web application, we&#8217;ve implemented a
<code class="docutils literal"><span class="pre">base-apache</span></code> role that installs and configures a basic Apache setup. This is used by both the
sample web application and the Nagios hosts.</p>
</div>
<div class="section" id="reusable-content-roles">
<span id="lamp-roles"></span><h5>Reusable Content: Roles<a class="headerlink" href="#reusable-content-roles" title="Permalink to this headline">¶</a></h5>
<p>By now you should have a bit of understanding about roles and how they work in Ansible. Roles are a way to organize
content: tasks, handlers, templates, and files, into reusable components.</p>
<p>This example has six roles: <code class="docutils literal"><span class="pre">common</span></code>, <code class="docutils literal"><span class="pre">base-apache</span></code>, <code class="docutils literal"><span class="pre">db</span></code>, <code class="docutils literal"><span class="pre">haproxy</span></code>, <code class="docutils literal"><span class="pre">nagios</span></code>, and <code class="docutils literal"><span class="pre">web</span></code>. How you organize
your roles is up to you and your application, but most sites will have one or more common roles that are applied to
all systems, and then a series of application-specific roles that install and configure particular parts of the site.</p>
<p>Roles can have variables and dependencies, and you can pass in parameters to roles to modify their behavior.
You can read more about roles in the <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a> section.</p>
</div>
<div class="section" id="configuration-group-variables">
<span id="lamp-group-variables"></span><h5>Configuration: Group Variables<a class="headerlink" href="#configuration-group-variables" title="Permalink to this headline">¶</a></h5>
<p>Group variables are variables that are applied to groups of servers. They can be used in templates and in
playbooks to customize behavior and to provide easily-changed settings and parameters. They are stored in
a directory called <code class="docutils literal"><span class="pre">group_vars</span></code> in the same location as your inventory.
Here is lamp_haproxy&#8217;s <code class="docutils literal"><span class="pre">group_vars/all</span></code> file. As you might expect, these variables are applied to all of the machines in your inventory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
httpd_port: <span class="m">80</span>
ntpserver: <span class="m">192</span>.0.2.23
</pre></div>
</div>
<p>This is a YAML file, and you can create lists and dictionaries for more complex variable structures.
In this case, we are just setting two variables, one for the port for the web server, and one for the
NTP server that our machines should use for time synchronization.</p>
<p>Here&#8217;s another group variables file. This is <code class="docutils literal"><span class="pre">group_vars/dbservers</span></code> which applies to the hosts in the <code class="docutils literal"><span class="pre">dbservers</span></code> group:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
mysqlservice: mysqld
mysql_port: <span class="m">3306</span>
dbuser: root
dbname: foodb
upassword: usersecret
</pre></div>
</div>
<p>If you look in the example, there are group variables for the <code class="docutils literal"><span class="pre">webservers</span></code> group and the <code class="docutils literal"><span class="pre">lbservers</span></code> group, similarly.</p>
<p>These variables are used in a variety of places. You can use them in playbooks, like this, in <code class="docutils literal"><span class="pre">roles/db/tasks/main.yml</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: Create Application Database
  mysql_db: <span class="nv">name</span><span class="o">={{</span> dbname <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>present

- name: Create Application DB User
  mysql_user: <span class="nv">name</span><span class="o">={{</span> dbuser <span class="o">}}</span> <span class="nv">password</span><span class="o">={{</span> upassword <span class="o">}}</span>
              <span class="nv">priv</span><span class="o">=</span>*.*:ALL <span class="nv">host</span><span class="o">=</span><span class="s1">&#39;%&#39;</span> <span class="nv">state</span><span class="o">=</span>present
</pre></div>
</div>
<p>You can also use these variables in templates, like this, in <code class="docutils literal"><span class="pre">roles/common/templates/ntp.conf.j2</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>driftfile /var/lib/ntp/drift

restrict <span class="m">127</span>.0.0.1
restrict -6 ::1

server <span class="o">{{</span> ntpserver <span class="o">}}</span>

includefile /etc/ntp/crypto/pw

keys /etc/ntp/keys
</pre></div>
</div>
<p>You can see that the variable substitution syntax of {{ and }} is the same for both templates and variables. The syntax
inside the curly braces is Jinja2, and you can do all sorts of operations and apply different filters to the
data inside. In templates, you can also use for loops and if statements to handle more complex situations,
like this, in <code class="docutils literal"><span class="pre">roles/common/templates/iptables.j2</span></code>:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">inventory_hostname</span> <span class="k">in</span> <span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;dbservers&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">-A INPUT -p tcp  --dport 3306 -j  ACCEPT</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>This is testing to see if the inventory name of the machine we&#8217;re currently operating on (<code class="docutils literal"><span class="pre">inventory_hostname</span></code>)
exists in the inventory group <code class="docutils literal"><span class="pre">dbservers</span></code>. If so, that machine will get an iptables ACCEPT line for port 3306.</p>
<p>Here&#8217;s another example, from the same template:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">host</span> <span class="k">in</span> <span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;monitoring&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">-A INPUT -p tcp -s </span><span class="cp">{{</span> <span class="nv">hostvars</span><span class="o">[</span><span class="nv">host</span><span class="o">]</span><span class="nv">.ansible_default_ipv4.address</span> <span class="cp">}}</span><span class="x"> --dport 5666 -j ACCEPT</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>This loops over all of the hosts in the group called <code class="docutils literal"><span class="pre">monitoring</span></code>, and adds an ACCEPT line for
each monitoring hosts&#8217; default IPV4 address to the current machine&#8217;s iptables configuration, so that Nagios can monitor those hosts.</p>
<p>You can learn a lot more about Jinja2 and its capabilities <a class="reference external" href="http://jinja.pocoo.org/docs/">here</a>, and you
can read more about Ansible variables in general in the <a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a> section.</p>
</div>
<div class="section" id="the-rolling-upgrade">
<span id="lamp-rolling-upgrade"></span><h5>The Rolling Upgrade<a class="headerlink" href="#the-rolling-upgrade" title="Permalink to this headline">¶</a></h5>
<p>Now you have a fully-deployed site with web servers, a load balancer, and monitoring. How do you update it? This is where Ansible&#8217;s
orchestration features come into play. While some applications use the term &#8216;orchestration&#8217; to mean basic ordering or command-blasting, Ansible
refers to orchestration as &#8216;conducting machines like an orchestra&#8217;, and has a pretty sophisticated engine for it.</p>
<p>Ansible has the capability to do operations on multi-tier applications in a coordinated way, making it easy to orchestrate a sophisticated zero-downtime rolling upgrade of our web application. This is implemented in a separate playbook, called <code class="docutils literal"><span class="pre">rolling_update.yml</span></code>.</p>
<p>Looking at the playbook, you can see it is made up of two plays. The first play is very simple and looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: monitoring
  tasks: <span class="o">[]</span>
</pre></div>
</div>
<p>What&#8217;s going on here, and why are there no tasks? You might know that Ansible gathers &#8220;facts&#8221; from the servers before operating upon them. These facts are useful for all sorts of things: networking information, OS/distribution versions, etc. In our case, we need to know something about all of the monitoring servers in our environment before we perform the update, so this simple play forces a fact-gathering step on our monitoring servers. You will see this pattern sometimes, and it&#8217;s a useful trick to know.</p>
<p>The next part is the update play. The first part looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: webservers
  user: root
  serial: <span class="m">1</span>
</pre></div>
</div>
<p>This is just a normal play definition, operating on the <code class="docutils literal"><span class="pre">webservers</span></code> group. The <code class="docutils literal"><span class="pre">serial</span></code> keyword tells Ansible how many servers to operate on at once. If it&#8217;s not specified, Ansible will parallelize these operations up to the default &#8220;forks&#8221; limit specified in the configuration file. But for a zero-downtime rolling upgrade, you may not want to operate on that many hosts at once. If you had just a handful of webservers, you may want to set <code class="docutils literal"><span class="pre">serial</span></code> to 1, for one host at a time. If you have 100, maybe you could set <code class="docutils literal"><span class="pre">serial</span></code> to 10, for ten at a time.</p>
<p>Here is the next part of the update play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>pre_tasks:
- name: disable nagios alerts <span class="k">for</span> this host webserver service
  nagios: <span class="nv">action</span><span class="o">=</span>disable_alerts <span class="nv">host</span><span class="o">={{</span> inventory_hostname <span class="o">}}</span> <span class="nv">services</span><span class="o">=</span>webserver
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: <span class="s2">&quot;{{ groups.monitoring }}&quot;</span>

- name: disable the server in haproxy
  shell: <span class="nb">echo</span> <span class="s2">&quot;disable server myapplb/{{ inventory_hostname }}&quot;</span> <span class="p">|</span> socat stdio /var/lib/haproxy/stats
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: <span class="s2">&quot;{{ groups.lbservers }}&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">pre_tasks</span></code> keyword just lets you list tasks to run before the roles are called. This will make more sense in a minute. If you look at the names of these tasks, you can see that we are disabling Nagios alerts and then removing the webserver that we are currently updating from the HAProxy load balancing pool.</p>
<p>The <code class="docutils literal"><span class="pre">delegate_to</span></code> and <code class="docutils literal"><span class="pre">with_items</span></code> arguments, used together, cause Ansible to loop over each monitoring server and load balancer, and perform that operation (delegate that operation) on the monitoring or load balancing server, &#8220;on behalf&#8221; of the webserver. In programming terms, the outer loop is the list of web servers, and the inner loop is the list of monitoring servers.</p>
<p>Note that the HAProxy step looks a little complicated.  We&#8217;re using HAProxy in this example because it&#8217;s freely available, though if you have (for instance) an F5 or Netscaler in your infrastructure (or maybe you have an AWS Elastic IP setup?), you can use modules included in core Ansible to communicate with them instead.  You might also wish to use other monitoring modules instead of nagios, but this just shows the main goal of the &#8216;pre tasks&#8217; section &#8211; take the server out of monitoring, and take it out of rotation.</p>
<p>The next step simply re-applies the proper roles to the web servers. This will cause any configuration management declarations in <code class="docutils literal"><span class="pre">web</span></code> and <code class="docutils literal"><span class="pre">base-apache</span></code> roles to be applied to the web servers, including an update of the web application code itself. We don&#8217;t have to do it this way&#8211;we could instead just purely update the web application, but this is a good example of how roles can be used to reuse tasks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles:
- common
- base-apache
- web
</pre></div>
</div>
<p>Finally, in the <code class="docutils literal"><span class="pre">post_tasks</span></code> section, we reverse the changes to the Nagios configuration and put the web server back in the load balancing pool:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>post_tasks:
- name: Enable the server in haproxy
  shell: <span class="nb">echo</span> <span class="s2">&quot;enable server myapplb/{{ inventory_hostname }}&quot;</span> <span class="p">|</span> socat stdio /var/lib/haproxy/stats
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: <span class="s2">&quot;{{ groups.lbservers }}&quot;</span>

- name: re-enable nagios alerts
  nagios: <span class="nv">action</span><span class="o">=</span>enable_alerts <span class="nv">host</span><span class="o">={{</span> inventory_hostname <span class="o">}}</span> <span class="nv">services</span><span class="o">=</span>webserver
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: <span class="s2">&quot;{{ groups.monitoring }}&quot;</span>
</pre></div>
</div>
<p>Again, if you were using a Netscaler or F5 or Elastic Load Balancer, you would just substitute in the appropriate modules instead.</p>
</div>
<div class="section" id="managing-other-load-balancers">
<span id="lamp-end-notes"></span><h5>Managing Other Load Balancers<a class="headerlink" href="#managing-other-load-balancers" title="Permalink to this headline">¶</a></h5>
<p>In this example, we use the simple HAProxy load balancer to front-end the web servers. It&#8217;s easy to configure and easy to manage. As we have mentioned, Ansible has built-in support for a variety of other load balancers like Citrix NetScaler, F5 BigIP, Amazon Elastic Load Balancers, and more. See the <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> documentation for more information.</p>
<p>For other load balancers, you may need to send shell commands to them (like we do for HAProxy above), or call an API, if your load balancer exposes one. For the load balancers for which Ansible has modules, you may want to run them as a <code class="docutils literal"><span class="pre">local_action</span></code> if they contact an API. You can read more about local actions in the <a class="reference internal" href="index.html#document-playbooks_delegation"><span class="doc">Delegation, Rolling Updates, and Local Actions</span></a> section.  Should you develop anything interesting for some hardware where there is not a core module, it might make for a good module for core inclusion!</p>
</div>
<div class="section" id="continuous-delivery-end-to-end">
<span id="lamp-end-to-end"></span><h5>Continuous Delivery End-To-End<a class="headerlink" href="#continuous-delivery-end-to-end" title="Permalink to this headline">¶</a></h5>
<p>Now that you have an automated way to deploy updates to your application, how do you tie it all together? A lot of organizations use a continuous integration tool like <a class="reference external" href="http://jenkins-ci.org/">Jenkins</a> or <a class="reference external" href="https://www.atlassian.com/software/bamboo">Atlassian Bamboo</a> to tie the development, test, release, and deploy steps together. You may also want to use a tool like <a class="reference external" href="https://code.google.com/p/gerrit/">Gerrit</a> to add a code review step to commits to either the application code itself, or to your Ansible playbooks, or both.</p>
<p>Depending on your environment, you might be deploying continuously to a test environment, running an integration test battery against that environment, and then deploying automatically into production.  Or you could keep it simple and just use the rolling-update for on-demand deployment into test or production specifically.  This is all up to you.</p>
<p>For integration with Continuous Integration systems, you can easily trigger playbook runs using the <code class="docutils literal"><span class="pre">ansible-playbook</span></code> command line tool, or, if you&#8217;re using <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a>, the <code class="docutils literal"><span class="pre">tower-cli</span></code> or the built-in REST API.  (The tower-cli command &#8216;joblaunch&#8217; will spawn a remote job over the REST API and is pretty slick).</p>
<p>This should give you a good idea of how to structure a multi-tier application with Ansible, and orchestrate operations upon that app, with the eventual goal of continuous delivery to your customers. You could extend the idea of the rolling upgrade to lots of different parts of the app; maybe add front-end web servers along with application servers, for instance, or replace the SQL database with something like MongoDB or Riak. Ansible gives you the capability to easily manage complicated environments and automate common operations.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples/tree/master/lamp_haproxy">lamp_haproxy example</a></dt>
<dd>The lamp_haproxy example discussed here.</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>An introduction to playbook roles</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_variables"><span class="doc">Variables</span></a></dt>
<dd>An introduction to Ansible variables</dd>
<dt><a class="reference external" href="https://www.ansible.com/ansible-continuous-delivery">Ansible.com: Continuous Delivery</a></dt>
<dd>An introduction to Continuous Delivery with Ansible</dd>
</dl>
</div>
</div>
</div>
<span id="document-guide_docker"></span><div class="section" id="getting-started-with-docker">
<h4>Getting Started with Docker<a class="headerlink" href="#getting-started-with-docker" title="Permalink to this headline">¶</a></h4>
<p>Ansible offers the following modules for orchestrating Docker containers:</p>
<blockquote>
<div><dl class="docutils">
<dt>docker_service</dt>
<dd>Use your existing Docker compose files to orchestrate containers on a single Docker daemon or on
Swarm. Supports compose versions 1 and 2.</dd>
<dt>docker_container</dt>
<dd>Manages the container lifecycle by providing the ability to create, update, stop, start and destroy a
container.</dd>
<dt>docker_image</dt>
<dd>Provides full control over images, including: build, pull, push, tag and remove.</dd>
<dt>docker_image_facts</dt>
<dd>Inspects one or more images in the Docker host&#8217;s image cache, providing the information as facts for making
decision or assertions in a playbook.</dd>
<dt>docker_login</dt>
<dd>Authenticates with Docker Hub or any Docker registry and updates the Docker Engine config file, which
in turn provides password-free pushing and pulling of images to and from the registry.</dd>
<dt>docker (dynamic inventory)</dt>
<dd>Dynamically builds an inventory of all the available containers from a set of one or more Docker hosts.</dd>
</dl>
</div></blockquote>
<p>Ansible 2.1.0 includes major updates to the Docker modules, marking the start of a project to create a complete and
integrated set of tools for orchestrating containers. In addition to the above modules, we are also working on the
following:</p>
<p>Still using Dockerfile to build images? Check out <a class="reference external" href="https://github.com/ansible/ansible-container">ansible-container</a>,
and start building images from your Ansible playbooks.</p>
<p>Use the <em>shipit</em> command in <a class="reference external" href="https://github.com/ansible/ansible-container">ansible-container</a>
to launch your docker-compose file on <a class="reference external" href="https://www.openshift.org/">OpenShift</a>. Go from an app on your laptop to a fully
scalable app in the cloud in just a few moments.</p>
<p>There&#8217;s more planned. See the latest ideas and thinking at the <a class="reference external" href="https://github.com/ansible/proposals/tree/master/docker">Ansible proposal repo</a>.</p>
<div class="section" id="requirements">
<h5>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h5>
<p>Using the docker modules requires having <a class="reference external" href="https://docker-py.readthedocs.org/en/stable/">docker-py</a>
installed on the host running Ansible. You will need to have &gt;= 1.7.0 installed.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install <span class="s1">&#39;docker-py&gt;=1.7.0&#39;</span>
</pre></div>
</div>
<p>The docker_service module also requires <a class="reference external" href="https://github.com/docker/compose">docker-compose</a></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install <span class="s1">&#39;docker-compose&gt;=1.7.0&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="connecting-to-the-docker-api">
<h5>Connecting to the Docker API<a class="headerlink" href="#connecting-to-the-docker-api" title="Permalink to this headline">¶</a></h5>
<p>You can connect to a local or remote API using parameters passed to each task or by setting environment variables.
The order of precedence is command line parameters and then environment variables. If neither a command line
option or an environment variable is found, a default value will be used. The default values are provided under
<a class="reference internal" href="#parameters">Parameters</a></p>
<div class="section" id="parameters">
<h6>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h6>
<p>Control how modules connect to the Docker API by passing the following parameters:</p>
<blockquote>
<div><dl class="docutils">
<dt>docker_host</dt>
<dd>The URL or Unix socket path used to connect to the Docker API. Defaults to <code class="docutils literal"><span class="pre">unix://var/run/docker.sock</span></code>.
To connect to a remote host, provide the TCP connection string. For example: <code class="docutils literal"><span class="pre">tcp://192.0.2.23:2376</span></code>. If
TLS is used to encrypt the connection to the API, then the module will automatically replace &#8216;tcp&#8217; in the
connection URL with &#8216;https&#8217;.</dd>
<dt>api_version</dt>
<dd>The version of the Docker API running on the Docker Host. Defaults to the latest version of the API supported
by docker-py.</dd>
<dt>timeout</dt>
<dd>The maximum amount of time in seconds to wait on a response from the API. Defaults to 60 seconds.</dd>
<dt>tls</dt>
<dd>Secure the connection to the API by using TLS without verifying the authenticity of the Docker host server.
Defaults to False.</dd>
<dt>tls_verify</dt>
<dd>Secure the connection to the API by using TLS and verifying the authenticity of the Docker host server.
Default is False.</dd>
<dt>cacert_path</dt>
<dd>Use a CA certificate when performing server verification by providing the path to a CA certificate file.</dd>
<dt>cert_path</dt>
<dd>Path to the client&#8217;s TLS certificate file.</dd>
<dt>key_path</dt>
<dd>Path to the client&#8217;s TLS key file.</dd>
<dt>tls_hostname</dt>
<dd>When verifying the authenticity of the Docker Host server, provide the expected name of the server. Defaults
to &#8216;localhost&#8217;.</dd>
<dt>ssl_version</dt>
<dd>Provide a valid SSL version number. Default value determined by docker-py, which at the time of this writing
was 1.0</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="environment-variables">
<h6>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h6>
<p>Control how the modules connect to the Docker API by setting the following variables in the environment of the host
running Ansible:</p>
<blockquote>
<div><dl class="docutils">
<dt>DOCKER_HOST</dt>
<dd>The URL or Unix socket path used to connect to the Docker API.</dd>
<dt>DOCKER_API_VERSION</dt>
<dd>The version of the Docker API running on the Docker Host. Defaults to the latest version of the API supported
by docker-py.</dd>
<dt>DOCKER_TIMEOUT</dt>
<dd>The maximum amount of time in seconds to wait on a response from the API.</dd>
<dt>DOCKER_CERT_PATH</dt>
<dd>Path to the directory containing the client certificate, client key and CA certificate.</dd>
<dt>DOCKER_SSL_VERSION</dt>
<dd>Provide a valid SSL version number.</dd>
<dt>DOCKER_TLS</dt>
<dd>Secure the connection to the API by using TLS without verifying the authenticity of the Docker Host.</dd>
<dt>DOCKER_TLS_VERIFY</dt>
<dd>Secure the connection to the API by using TLS and verify the authenticity of the Docker Host.</dd>
</dl>
</div></blockquote>
</div>
</div>
<div class="section" id="dynamic-inventory-script">
<h5>Dynamic Inventory Script<a class="headerlink" href="#dynamic-inventory-script" title="Permalink to this headline">¶</a></h5>
<p>The inventory script generates dynamic inventory by making API requests to one or more Docker APIs. It&#8217;s dynamic
because the inventory is generated at run-time rather than being read from a static file. The script generates the
inventory by connecting to one or many Docker APIs and inspecting the containers it finds at each API. Which APIs the
script contacts can be defined using environment variables or a configuration file.</p>
<div class="section" id="groups">
<h6>Groups<a class="headerlink" href="#groups" title="Permalink to this headline">¶</a></h6>
<p>The script will create the following host groups:</p>
<blockquote>
<div><ul class="simple">
<li>container id</li>
<li>container name</li>
<li>container short id</li>
<li>image_name  (image_&lt;image name&gt;)</li>
<li>docker_host</li>
<li>running</li>
<li>stopped</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="examples">
<h6>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h6>
<p>You can run the script interactively from the command line or pass it as the inventory to a playbook. Here are few
examples to get you started:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Connect to the Docker API on localhost port 4243 and format the JSON output</span>
<span class="nv">DOCKER_HOST</span><span class="o">=</span>tcp://localhost:4243 ./docker.py --pretty

<span class="c1"># Any container&#39;s ssh port exposed on 0.0.0.0 will be mapped to</span>
<span class="c1"># another IP address (where Ansible will attempt to connect via SSH)</span>
<span class="nv">DOCKER_DEFAULT_IP</span><span class="o">=</span><span class="m">192</span>.0.2.5 ./docker.py --pretty

<span class="c1"># Run as input to a playbook:</span>
ansible-playbook -i ~/projects/ansible/contrib/inventory/docker.py docker_inventory_test.yml

<span class="c1"># Simple playbook to invoke with the above example:</span>

    - name: Test docker_inventory
      hosts: all
      connection: <span class="nb">local</span>
      gather_facts: no
      tasks:
        - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Container - {{ inventory_hostname }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration">
<h6>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h6>
<p>You can control the behavior of the inventory script by defining environment variables, or
creating a docker.yml file (sample provided in ansible/contrib/inventory). The order of precedence is the docker.yml
file and then environment variables.</p>
<div class="section" id="id2">
<h7>Environment Variables<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h7>
<p>To connect to a single Docker API the following variables can be defined in the environment to control the connection
options. These are the same environment variables used by the Docker modules.</p>
<blockquote>
<div><dl class="docutils">
<dt>DOCKER_HOST</dt>
<dd>The URL or Unix socket path used to connect to the Docker API. Defaults to unix://var/run/docker.sock.</dd>
<dt>DOCKER_API_VERSION:</dt>
<dd>The version of the Docker API running on the Docker Host. Defaults to the latest version of the API supported
by docker-py.</dd>
<dt>DOCKER_TIMEOUT:</dt>
<dd>The maximum amount of time in seconds to wait on a response fromm the API. Defaults to 60 seconds.</dd>
<dt>DOCKER_TLS:</dt>
<dd>Secure the connection to the API by using TLS without verifying the authenticity of the Docker host server.
Defaults to False.</dd>
<dt>DOCKER_TLS_VERIFY:</dt>
<dd>Secure the connection to the API by using TLS and verifying the authenticity of the Docker host server.
Default is False</dd>
<dt>DOCKER_TLS_HOSTNAME:</dt>
<dd>When verifying the authenticity of the Docker Host server, provide the expected name of the server. Defaults
to localhost.</dd>
<dt>DOCKER_CERT_PATH:</dt>
<dd>Path to the directory containing the client certificate, client key and CA certificate.</dd>
<dt>DOCKER_SSL_VERSION:</dt>
<dd>Provide a valid SSL version number. Default value determined by docker-py, which at the time of this writing
was 1.0</dd>
</dl>
</div></blockquote>
<p>In addition to the connection variables there are a couple variables used to control the execution and output of the
script:</p>
<blockquote>
<div><dl class="docutils">
<dt>DOCKER_CONFIG_FILE</dt>
<dd>Path to the configuration file. Defaults to ./docker.yml.</dd>
<dt>DOCKER_PRIVATE_SSH_PORT:</dt>
<dd>The private port (container port) on which SSH is listening for connections. Defaults to 22.</dd>
<dt>DOCKER_DEFAULT_IP:</dt>
<dd>The IP address to assign to ansible_host when the container&#8217;s SSH port is mapped to interface &#8216;0.0.0.0&#8217;.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="configuration-file">
<h7>Configuration File<a class="headerlink" href="#configuration-file" title="Permalink to this headline">¶</a></h7>
<p>Using a configuration file provides a means for defining a set of Docker APIs from which to build an inventory.</p>
<p>The default name of the file is derived from the name of the inventory script. By default the script will look for
basename of the script (i.e. docker) with an extension of &#8216;.yml&#8217;.</p>
<p>You can also override the default name of the script by defining DOCKER_CONFIG_FILE in the environment.</p>
<p>Here&#8217;s what you can define in docker_inventory.yml:</p>
<blockquote>
<div><dl class="docutils">
<dt>defaults</dt>
<dd>Defines a default connection. Defaults will be taken from this and applied to any values not provided
for a host defined in the hosts list.</dd>
<dt>hosts</dt>
<dd>If you wish to get inventory from more than one Docker host, define a hosts list.</dd>
</dl>
</div></blockquote>
<p>For the default host and each host in the hosts list define the following attributes:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">The URL or Unix socket path used to connect to the Docker API.</span>
    <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="l l-Scalar l-Scalar-Plain">tls</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Connect using TLS without verifying the authenticity of the Docker host server.</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="l l-Scalar l-Scalar-Plain">tls_verify</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Connect using TLS without verifying the authenticity of the Docker host server.</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="l l-Scalar l-Scalar-Plain">cert_path</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Path to the client&#39;s TLS certificate file.</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="l l-Scalar l-Scalar-Plain">cacert_path</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Use a CA certificate when performing server verification by providing the path to a CA certificate file.</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="l l-Scalar l-Scalar-Plain">key_path</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Path to the client&#39;s TLS key file.</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">The Docker API version.</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">will be supplied by the docker-py module.</span>

<span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">The amount of time in seconds to wait on an API response.</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>

<span class="l l-Scalar l-Scalar-Plain">default_ip</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">The IP address to assign to ansible_host when the container&#39;s SSH port is mapped to interface</span>
   <span class="s">&#39;0.0.0.0&#39;</span><span class="l l-Scalar l-Scalar-Plain">.</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>

<span class="l l-Scalar l-Scalar-Plain">private_ssh_port</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">The port containers use for SSH</span>
   <span class="l l-Scalar l-Scalar-Plain">required</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
   <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-guide_packet"></span><div class="section" id="using-ansible-with-the-packet-host">
<h4>Using Ansible with the Packet host<a class="headerlink" href="#using-ansible-with-the-packet-host" title="Permalink to this headline">¶</a></h4>
<div class="section" id="introduction">
<h5>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://packet.net">Packet.net</a> is a bare metal infrastructure host that&#8217;s supported by Ansible (&gt;=2.3) via a dynamic inventory script and two cloud modules. The two modules are:</p>
<ul class="simple">
<li>packet_sshkey: adds a public SSH key from file or value to the Packet infrastructure. Every subsequently-created device will have this public key installed in .ssh/authorized_keys.</li>
<li>packet_device: manages servers on Packet. You can use this module to create, restart and delete devices.</li>
</ul>
<p>Note, this guide assumes you are familiar with Ansible and how it works. If you&#8217;re not, have a look at their <a class="reference external" href="http://docs.ansible.com/">docs</a> before getting started.</p>
</div>
<div class="section" id="requirements">
<h5>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h5>
<p>The Packet modules and inventory script connect to the Packet API using the packet-python package. You can install it with pip:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install packet-python
</pre></div>
</div>
<p>In order to check the state of devices created by Ansible on Packet, it&#8217;s a good idea to install one of the <a class="reference external" href="https://www.packet.net/developers/integrations/api-cli/">Packet CLI clients</a>. Otherwise you can check them via the <a class="reference external" href="https://app.packet.net/portal">Packet portal</a>.</p>
<p>To use the modules and inventory script you&#8217;ll need a Packet API token. You can generate an API token via the Packet portal <a class="reference external" href="https://app.packet.net/portal#/api-keys">here</a>. The simplest way to authenticate yourself is to set the Packet API token in an environment variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">PACKET_API_TOKEN</span><span class="o">=</span>Bfse9F24SFtfs423Gsd3ifGsd43sSdfs
</pre></div>
</div>
<p>If you&#8217;re not comfortable exporting your API token, you can pass it as a parameter to the modules.</p>
<p>On Packet, devices and reserved IP addresses belong to <a class="reference external" href="https://www.packet.net/developers/api/projects/">projects</a>. In order to use the packet_device module, you need to specify the UUID of the project in which you want to create or manage devices. You can find a project&#8217;s UUID in the Packet portal <a class="reference external" href="https://app.packet.net/portal#/projects/list/table/">here</a> (it&#8217;s just under the project table) or via one of the available <a class="reference external" href="https://www.packet.net/developers/integrations/api-cli/">CLIs</a>.</p>
<p>If you want to use a new SSH keypair in this tutorial, you can generate it to <code class="docutils literal"><span class="pre">./id_rsa</span></code> and <code class="docutils literal"><span class="pre">./id_rsa.pub</span></code> as:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ssh-keygen -t rsa -f ./id_rsa
</pre></div>
</div>
<p>If you want to use an existing keypair, just copy the private and public key over to the playbook directory.</p>
</div>
<div class="section" id="device-creation">
<h5>Device Creation<a class="headerlink" href="#device-creation" title="Permalink to this headline">¶</a></h5>
<p>The following code block is a simple playbook that creates one <a class="reference external" href="https://www.packet.net/bare-metal/servers/type-0/">Type 0</a> server (the &#8216;plan&#8217; parameter). You have to supply &#8216;plan&#8217; and &#8216;operating_system&#8217;. &#8216;location&#8217; defaults to &#8216;ewr1&#8217; (Parsippany, NJ). You can find all the possible values for the parameters via a <a class="reference external" href="https://www.packet.net/developers/integrations/api-cli/">CLI client</a>.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># playbook_create.yml</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">create ubuntu device</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">packet_sshkey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">key_file</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">./id_rsa.pub</span>
      <span class="l l-Scalar l-Scalar-Plain">label</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tutorial key</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">packet_device</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;your_project_id&gt;</span>
      <span class="l l-Scalar l-Scalar-Plain">hostnames</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">myserver</span>
      <span class="l l-Scalar l-Scalar-Plain">operating_system</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu_16_04</span>
      <span class="l l-Scalar l-Scalar-Plain">plan</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">baremetal_0</span>
      <span class="l l-Scalar l-Scalar-Plain">facility</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sjc1</span>
</pre></div>
</div>
<p>After running <code class="docutils literal"><span class="pre">ansible-playbook</span> <span class="pre">playbook_create.yml</span></code>, you should have a server provisioned on Packet. You can verify via a CLI or in the <a class="reference external" href="https://app.packet.net/portal#/projects/list/table">Packet portal</a>.</p>
<p>If you get an error with the message &#8220;failed to set machine state present, error: Error 404: Not Found&#8221;, please verify your project UUID.</p>
</div>
<div class="section" id="updating-devices">
<h5>Updating Devices<a class="headerlink" href="#updating-devices" title="Permalink to this headline">¶</a></h5>
<p>The two parameters used to uniquely identify Packet devices are: &#8220;device_ids&#8221; and &#8220;hostnames&#8221;. Both parameters accept either a single string (later converted to a one-element list), or a list of strings.</p>
<p>The &#8216;device_ids&#8217; and &#8216;hostnames&#8217; parameters are mutually exclusive. The following values are all acceptable:</p>
<ul class="simple">
<li>device_ids: a27b7a83-fc93-435b-a128-47a5b04f2dcf</li>
<li>hostnames: mydev1</li>
<li>device_ids: [a27b7a83-fc93-435b-a128-47a5b04f2dcf, 4887130f-0ccd-49a0-99b0-323c1ceb527b]</li>
<li>hostnames: [mydev1, mydev2]</li>
</ul>
<p>In addition, hostnames can contain a special &#8216;%d&#8217; formatter along with a &#8216;count&#8217; parameter that lets you easily expand hostnames that follow a simple name and number pattern; i.e. <code class="docutils literal"><span class="pre">hostnames:</span> <span class="pre">&quot;mydev%d&quot;,</span> <span class="pre">count:</span> <span class="pre">2</span></code> will expand to [mydev1, mydev2].</p>
<p>If your playbook acts on existing Packet devices, you can only pass the &#8216;hostname&#8217; and &#8216;device_ids&#8217; parameters. The following playbook shows how you can reboot a specific Packet device by setting the &#8216;hostname&#8217; parameter:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># playbook_reboot.yml</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">reboot myserver</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">packet_device</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;your_project_id&gt;</span>
      <span class="l l-Scalar l-Scalar-Plain">hostnames</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">myserver</span>
      <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rebooted</span>
</pre></div>
</div>
<p>You can also identify specific Packet devices with the &#8216;device_ids&#8217; parameter. The device&#8217;s UUID can be found in the <a class="reference external" href="https://app.packet.net/portal">Packet Portal</a> or by using a <a class="reference external" href="https://www.packet.net/developers/integrations/api-cli/">CLI</a>. The following playbook removes a Packet device using the &#8216;device_ids&#8217; field:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># playbook_remove.yml</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove a device</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">packet_device</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;your_project_id&gt;</span>
      <span class="l l-Scalar l-Scalar-Plain">device_ids</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;myserver_device_id&gt;</span>
      <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
</pre></div>
</div>
</div>
<div class="section" id="more-complex-playbooks">
<h5>More Complex Playbooks<a class="headerlink" href="#more-complex-playbooks" title="Permalink to this headline">¶</a></h5>
<p>In this example, we&#8217;ll create a CoreOS cluster with <a class="reference external" href="https://support.packet.net/en/support/solutions/articles/22000058261-the-basics-of-cloud-config-and-user-data">user data</a>.</p>
<p>The CoreOS cluster will use <a class="reference external" href="https://coreos.com/etcd/">etcd</a> for discovery of other servers in the cluster. Before provisioning your servers, you&#8217;ll need to generate a discovery token for your cluster:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -w <span class="s2">&quot;\n&quot;</span> <span class="s1">&#39;https://discovery.etcd.io/new?size=3&#39;</span>
</pre></div>
</div>
<p>The following playbook will create an SSH key, 3 Packet servers, and then wait until SSH is ready (or until 5 minutes passed). Make sure to substitute the discovery token URL in &#8216;user_data&#8217;, and the &#8216;project_id&#8217; before running <code class="docutils literal"><span class="pre">ansible-playbook</span></code>. Also, feel free to change &#8216;plan&#8217; and &#8216;facility&#8217;.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># playbook_coreos.yml</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Start 3 CoreOS nodes in Packet and wait until SSH is ready</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">packet_sshkey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">key_file</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">./id_rsa.pub</span>
      <span class="l l-Scalar l-Scalar-Plain">label</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">new</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">packet_device</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">hostnames</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">coreos-one</span><span class="p p-Indicator">,</span> <span class="nv">coreos-two</span><span class="p p-Indicator">,</span> <span class="nv">coreos-three</span><span class="p p-Indicator">]</span>
      <span class="l l-Scalar l-Scalar-Plain">operating_system</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coreos_beta</span>
      <span class="l l-Scalar l-Scalar-Plain">plan</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">baremetal_0</span>
      <span class="l l-Scalar l-Scalar-Plain">facility</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ewr1</span>
      <span class="l l-Scalar l-Scalar-Plain">project_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;your_project_id&gt;</span>
      <span class="l l-Scalar l-Scalar-Plain">wait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="l l-Scalar l-Scalar-Plain">user_data</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
        <span class="no">#cloud-config</span>
        <span class="no">coreos:</span>
          <span class="no">etcd2:</span>
            <span class="no">discovery: https://discovery.etcd.io/&lt;token&gt;</span>
            <span class="no">advertise-client-urls: http://$private_ipv4:2379,http://$private_ipv4:4001</span>
            <span class="no">initial-advertise-peer-urls: http://$private_ipv4:2380</span>
            <span class="no">listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001</span>
            <span class="no">listen-peer-urls: http://$private_ipv4:2380</span>
          <span class="no">fleet:</span>
            <span class="no">public-ip: $private_ipv4</span>
          <span class="no">units:</span>
            <span class="no">- name: etcd2.service</span>
              <span class="no">command: start</span>
            <span class="no">- name: fleet.service</span>
              <span class="no">command: start</span>
    <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">newhosts</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wait for ssh</span>
    <span class="l l-Scalar l-Scalar-Plain">wait_for</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.public_ipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
      <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
      <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">500</span>
    <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">newhosts.devices</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>As with most Ansible modules, the default states of the Packet modules are idempotent, meaning the resources in your project will remain the same after re-runs of a playbook. Thus, we can keep the <code class="docutils literal"><span class="pre">packet_sshkey</span></code> module call in our playbook. If the public key is already in your Packet account, the call will have no effect.</p>
<p>The second module call provisions 3 Packet Type 0 (specified using the &#8216;plan&#8217; parameter) servers in the project identified via the &#8216;project_id&#8217; parameter. The servers are all provisioned with CoresOS beta (the &#8216;operating_system&#8217; parameter) and are customized with cloud-config user data passed to the &#8216;user_data&#8217; parameter.</p>
<p>The <code class="docutils literal"><span class="pre">packet_device</span></code> module has a boolean &#8216;wait&#8217; parameter that defaults to &#8216;false&#8217;. If set to &#8216;true&#8217;, Ansible will wait until the GET API call for a device will contain an Internet-routeable IP address. The &#8216;wait&#8217; parameter allows us to use the IP address of the device as soon as it&#8217;s available.</p>
<p>Run the playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-playbook playbook_coreos.yml
</pre></div>
</div>
<p>Once the playbook quits, your new devices should be reachable via SSH. Try to connect to one and check if etcd has started properly:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tomk@work $ ssh -i id_rsa core@<span class="nv">$one_of_the_servers_ip</span>
core@coreos-one ~ $ etcdctl cluster-health
</pre></div>
</div>
<p>Once you create a couple of devices, you might appreciate the dynamic inventory script...</p>
</div>
<div class="section" id="dynamic-inventory-script">
<h5>Dynamic Inventory Script<a class="headerlink" href="#dynamic-inventory-script" title="Permalink to this headline">¶</a></h5>
<p>The dynamic inventory script queries the Packet API for a list of hosts, and exposes it to Ansible so you can easily identify and act on Packet devices. You can find it in Ansible&#8217;s git repo at <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/contrib/inventory/packet_net.py">contrib/inventory/packet_net.py</a>.</p>
<p>The inventory script is configurable via a <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/contrib/inventory/packet_net.ini">ini file</a>.</p>
<p>If you want to use the inventory script, you must first export your Packet API token to a PACKET_API_TOKEN environment variable.</p>
<p>You can either copy the inventory and ini config out from the cloned git repo, or you can download it to your working directory like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ wget https://github.com/ansible/ansible/raw/devel/contrib/inventory/packet_net.py
$ chmod +x packet_net.py
$ wget https://github.com/ansible/ansible/raw/devel/contrib/inventory/packet_net.ini
</pre></div>
</div>
<p>In order to understand what the inventory script gives to Ansible you can run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ./packet_net.py --list
</pre></div>
</div>
<p>It should print a JSON document looking similar to following trimmed dictionary:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;_meta&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;hostvars&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;147.75.64.169&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;packet_billing_cycle&quot;</span><span class="p">:</span> <span class="s2">&quot;hourly&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-02-09T17:11:26Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_facility&quot;</span><span class="p">:</span> <span class="s2">&quot;ewr1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;coreos-two&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_href&quot;</span><span class="p">:</span> <span class="s2">&quot;/devices/d0ab8972-54a8-4bff-832b-28549d1bec96&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;d0ab8972-54a8-4bff-832b-28549d1bec96&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_locked&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;packet_operating_system&quot;</span><span class="p">:</span> <span class="s2">&quot;coreos_beta&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_plan&quot;</span><span class="p">:</span> <span class="s2">&quot;baremetal_0&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_state&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2017-02-09T17:16:35Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_user&quot;</span><span class="p">:</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span>
        <span class="nt">&quot;packet_userdata&quot;</span><span class="p">:</span> <span class="s2">&quot;#cloud-config\ncoreos:\n  etcd2:\n    discovery: https://discovery.etcd.io/e0c8a4a9b8fe61acd51ec599e2a4f68e\n    advertise-client-urls: http://$private_ipv4:2379,http://$private_ipv4:4001\n    initial-advertise-peer-urls: http://$private_ipv4:2380\n    listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001\n    listen-peer-urls: http://$private_ipv4:2380\n  fleet:\n    public-ip: $private_ipv4\n  units:\n    - name: etcd2.service\n      command: start\n    - name: fleet.service\n      command: start&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;baremetal_0&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;147.75.202.255&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.202.251&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.202.249&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.64.129&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.192.51&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.64.169&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;coreos_beta&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;147.75.202.255&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.202.251&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.202.249&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.64.129&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.192.51&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.64.169&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;ewr1&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;147.75.64.129&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.192.51&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.64.169&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;sjc1&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;147.75.202.255&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.202.251&quot;</span><span class="p">,</span>
    <span class="s2">&quot;147.75.202.249&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;coreos-two&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;147.75.64.169&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;d0ab8972-54a8-4bff-832b-28549d1bec96&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;147.75.64.169&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the <code class="docutils literal"><span class="pre">['_meta']['hostvars']</span></code> key, there is a list of devices (uniquely identified by their public IPv4 address) with their parameters. The other keys under <code class="docutils literal"><span class="pre">['_meta']</span></code> are lists of devices grouped by some parameter. Here, it is type (all devices are of type baremetal_0), operating system, and facility (ewr1 and sjc1).</p>
<p>In addition to the parameter groups, there are also one-item groups with the UUID or hostname of the device.</p>
<p>You can now target groups in playbooks! The following playbook will install a role that supplies resources for an Ansible target into all devices in the &#8220;coreos_beta&#8221; group:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="c1"># playbook_bootstrap.yml</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coreos_beta</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">defunctzombie.coreos-boostrap</span>
</pre></div>
</div>
<p>Don&#8217;t forget to supply the dynamic inventory in the <code class="docutils literal"><span class="pre">-i</span></code> argument!</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-playbook -u core -i packet_net.py playbook_bootstrap.yml
</pre></div>
</div>
<p>If you have any questions or comments let us know! <a class="reference external" href="mailto:help&#37;&#52;&#48;packet&#46;net">help<span>&#64;</span>packet<span>&#46;</span>net</a></p>
</div>
</div>
</div>
<p>Pending topics may include: Docker, Jenkins, Google Compute Engine, Linode/DigitalOcean, Continuous Deployment, and more.</p>
</div>
<span id="document-dev_guide/index"></span><div class="section" id="developer-information">
<h3>Developer Information<a class="headerlink" href="#developer-information" title="Permalink to this headline">¶</a></h3>
<div class="section" id="ansible-developer-guide">
<h4>Ansible Developer Guide<a class="headerlink" href="#ansible-developer-guide" title="Permalink to this headline">¶</a></h4>
<p>Welcome to the Ansible Developer Guide!</p>
<p>The purpose of this guide is to document all of the paths available to you for interacting and shaping Ansible with code, ranging from developing modules and plugins to helping to develop the Ansible Core Engine via pull requests.</p>
<p>To get started, select one of the following topics.</p>
<div class="toctree-wrapper compound">
<span id="document-dev_guide/overview_architecture"></span><div class="section" id="ansible-architecture">
<h5>Ansible Architecture<a class="headerlink" href="#ansible-architecture" title="Permalink to this headline">¶</a></h5>
<p>Ansible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.</p>
<p>Being designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.</p>
<p>It uses no agents and no additional custom security infrastructure, so it&#8217;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English.</p>
<p>In this section, we&#8217;ll give you a really quick overview of how Ansible works so you can see how the pieces fit together.</p>
<div class="section" id="modules">
<h6>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h6>
<p>Ansible works by connecting to your nodes and pushing out small programs, called &#8220;Ansible Modules&#8221; to them. These programs are written to be resource models of the desired state of the system. Ansible then executes these modules (over SSH by default), and removes them when finished.</p>
<p>Your library of modules can reside on any machine, and there are no servers, daemons, or databases required. Typically you&#8217;ll work with your favorite terminal program, a text editor, and probably a version control system to keep track of changes to your content.</p>
</div>
<div class="section" id="plugins">
<h6>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h6>
<p>Plugins are pieces of code that augment Ansible&#8217;s core functionality. Ansible ships with a number of handy plugins, and you can easily write your own.</p>
</div>
<div class="section" id="inventory">
<h6>Inventory<a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h6>
<p>By default, Ansible represents what machines it manages using a very simple INI file that puts all of your managed machines in groups of your own choosing.</p>
<p>To add new machines, there is no additional SSL signing server involved, so there&#8217;s never any hassle deciding why a particular machine didn’t get linked up due to obscure NTP or DNS issues.</p>
<p>If there&#8217;s another source of truth in your infrastructure, Ansible can also plugin to that, such as drawing inventory, group, and variable information from sources like EC2, Rackspace, OpenStack, and more.</p>
<p>Here&#8217;s what a plain text inventory file looks like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="o">[</span>webservers<span class="o">]</span>
www1.example.com
www2.example.com

<span class="o">[</span>dbservers<span class="o">]</span>
db0.example.com
db1.example.com
</pre></div>
</div>
<p>Once inventory hosts are listed, variables can be assigned to them in simple text files (in a subdirectory called &#8216;group_vars/&#8217; or &#8216;host_vars/&#8217; or directly in the inventory file.</p>
<p>Or, as already mentioned, use a dynamic inventory to pull your inventory from data sources like EC2, Rackspace, or OpenStack.</p>
</div>
<div class="section" id="playbooks">
<h6>Playbooks<a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h6>
<p>Playbooks can finely orchestrate multiple slices of your infrastructure topology, with very detailed control over how many machines to tackle at a time.  This is where Ansible starts to get most interesting.</p>
<p>Ansible&#8217;s approach to orchestration is one of finely-tuned simplicity, as we believe your automation code should make perfect sense to you years down the road and there should be very little to remember about special syntax or features.</p>
<p>Here&#8217;s what a simple playbook looks like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: webservers
serial: <span class="m">5</span> <span class="c1"># update 5 machines at a time</span>
roles:
- common
- webapp

- hosts: content_servers
roles:
- common
- content
</pre></div>
</div>
</div>
<div class="section" id="extending-ansible-with-plug-ins-and-the-api">
<h6>Extending Ansible with Plug-ins and the API<a class="headerlink" href="#extending-ansible-with-plug-ins-and-the-api" title="Permalink to this headline">¶</a></h6>
<p>Should you want to write your own, Ansible modules can be written in any language that can return JSON (Ruby, Python, bash, etc). Inventory can also plug in to any datasource by writing a program that speaks to that datasource and returns JSON. There&#8217;s also various Python APIs for extending Ansible’s connection types (SSH is not the only transport possible), callbacks (how Ansible logs, etc), and even for adding new server side behaviors.</p>
</div>
</div>
<span id="document-dev_guide/developing_modules"></span><div class="section" id="developing-modules">
<h5><a class="toc-backref" href="#id1">Developing Modules</a><a class="headerlink" href="#developing-modules" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#developing-modules" id="id1">Developing Modules</a><ul>
<li><a class="reference internal" href="#welcome" id="id2">Welcome</a></li>
<li><a class="reference internal" href="#should-you-develop-a-module" id="id3">Should You Develop A Module?</a></li>
<li><a class="reference internal" href="#how-to-develop-a-module" id="id4">How To Develop A Module</a></li>
<li><a class="reference internal" href="#appendix-module-utilities" id="id5">Appendix: Module Utilities</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="welcome">
<span id="module-dev-welcome"></span><h6><a class="toc-backref" href="#id2">Welcome</a><a class="headerlink" href="#welcome" title="Permalink to this headline">¶</a></h6>
<p>This section discusses how to develop, debug, review, and test modules.</p>
<p>Ansible modules are reusable, standalone scripts that can be used by the Ansible API,
or by the <strong class="command">ansible</strong> or <strong class="command">ansible-playbook</strong> programs.  They
return information to ansible by printing a JSON string to stdout before
exiting.  They take arguments in one of several ways which we&#8217;ll go into
as we work through this tutorial.</p>
<p>See <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> for a list of existing modules.</p>
<p>Modules can be written in any language and are found in the path specified
by <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_LIBRARY</span></code> or the <code class="docutils literal"><span class="pre">--module-path</span></code> command line option or
in the <a class="reference external" href="http://docs.ansible.com/ansible/intro_configuration.html#library">library section of the Ansible configuration file</a>.</p>
</div>
<div class="section" id="should-you-develop-a-module">
<span id="module-dev-should-you"></span><h6><a class="toc-backref" href="#id3">Should You Develop A Module?</a><a class="headerlink" href="#should-you-develop-a-module" title="Permalink to this headline">¶</a></h6>
<p>Before diving into the work of creating a new module, you should think about whether you actually <em>should</em>
develop a module. Ask the following questions:</p>
<ol class="arabic simple">
<li>Does a similar module already exist?</li>
</ol>
<p>There are a lot of existing modules available, you should check out the list of existing modules at <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></p>
<ol class="arabic simple" start="2">
<li>Has someone already worked on a similar Pull Request?</li>
</ol>
<p>It&#8217;s possible that someone has already started developing a similar PR. There are a few ways to find open module Pull Requests:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ansible/ansible/labels/new_module">GitHub new module PRs</a></li>
<li><a class="reference external" href="https://github.com/ansible/ansible/labels/module">All updates to modules</a></li>
<li><a class="reference external" href="https://ansible.sivel.net/pr/byfile.html">New module PRs listed by directory</a> search for <cite>lib/ansible/modules/</cite></li>
</ul>
<p>If you find an existing PR that looks like it addresses the issue you are trying to solve, please provide feedback on the PR -  this will speed up getting the PR merged.</p>
<ol class="arabic simple" start="3">
<li>Should you use or develop an action plugin instead?</li>
</ol>
<p>Action plugins get run on the master instead of on the target. For modules like file/copy/template, some of the work needs to be done on the master before the module executes on the target. Action plugins execute first on the master and can then execute the normal module on the target if necessary.</p>
<p>For more information about action plugins, <a class="reference external" href="https://docs.ansible.com/ansible/dev_guide/developing_plugins.html">read the action plugins documentation here</a>.</p>
<ol class="arabic simple" start="4">
<li>Should you use a role instead?</li>
</ol>
<p>Check out the roles documentation <a class="reference external" href="http://docs.ansible.com/ansible/playbooks_reuse_roles.html#roles">available here</a>.</p>
</div>
<div class="section" id="how-to-develop-a-module">
<span id="developing-modules-all"></span><h6><a class="toc-backref" href="#id4">How To Develop A Module</a><a class="headerlink" href="#how-to-develop-a-module" title="Permalink to this headline">¶</a></h6>
<p>The following topics will discuss how to develop and work with modules:</p>
<dl class="docutils">
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules_general"><span class="doc">Ansible Module Development Walkthrough</span></a></dt>
<dd>A general overview of how to develop, debug, and test modules.</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules_general_windows"><span class="doc">Windows Ansible Module Development Walkthrough</span></a></dt>
<dd>A general overview of how to develop, debug and test Windows modules.</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules_documenting"><span class="doc">Documenting Your Module</span></a></dt>
<dd>How to include in-line documentation in your module.</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules_best_practices"><span class="doc">Conventions, Best Practices, and Pitfalls</span></a></dt>
<dd>Best practices, recommendations, and things to avoid.</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules_checklist"><span class="doc">Contributing Your Module to Ansible</span></a></dt>
<dd>Checklist for contributing your module to Ansible.</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/testing"><span class="doc">Testing Ansible</span></a></dt>
<dd>Developing unit and integration tests.</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_python3"><span class="doc">Ansible and Python 3</span></a></dt>
<dd>Adding Python 3 support to modules (all new modules must be Python-2.6 and Python-3.5 compatible).</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules_in_groups"><span class="doc">Information for submitting a group of modules</span></a></dt>
<dd>A guide for partners wanting to submit multiple modules.</dd>
</dl>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a></dt>
<dd>Learn about developing plugins</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_api"><span class="doc">Python API</span></a></dt>
<dd>Learn about the Python API for playbook and task execution</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/modules">GitHub modules directory</a></dt>
<dd>Browse module source code</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Mailing List</a></dt>
<dd>Development mailing list</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<div class="section" id="appendix-module-utilities">
<h6><a class="toc-backref" href="#id5">Appendix: Module Utilities</a><a class="headerlink" href="#appendix-module-utilities" title="Permalink to this headline">¶</a></h6>
<p>Ansible provides a number of module utilities that provide helper functions that you can use when developing your own modules. The <cite>basic.py</cite> module utility provides the main entry point for accessing the Ansible library, and all Ansible modules must, at minimum, import from basic.py:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>from ansible.module_utils.basic import *
</pre></div>
</div>
<p>The following is a list of module_utils files and a general description. The module utility source code lives in the <cite>./lib/module_utils</cite> directory under your main Ansible path - for more details on any specific module utility, please see the source code.</p>
<ul class="simple">
<li>a10.py - Utilities used by the a10_server module to manage A10 Networks devices.</li>
<li>aireos.py - Definitions and helper functions for modules that manage Cisco WLC devices.</li>
<li>api.py - Adds shared support for generic API modules.</li>
<li>aos.py - Module support utilities for managing Apstra AOS Server.</li>
<li>aruba.py - Helper functions for modules working with Aruba networking devices.</li>
<li>asa.py - Module support utilities for managing Cisco ASA network devices.</li>
<li>azure_rm_common.py - Definitions and utilities for Microsoft Azure Resource Manager template deployments.</li>
<li>basic.py - General definitions and helper utilities for Ansible modules.</li>
<li>cloudstack.py  - Utilities for CloudStack modules.</li>
<li>database.py - Miscellaneous helper functions for PostGRES and MySQL</li>
<li>docker_common.py - Definitions and helper utilities for modules working with Docker.</li>
<li>ec2.py - Definitions and utilities for modules working with Amazon EC2</li>
<li>eos.py - Helper functions for modules working with EOS networking devices.</li>
<li>f5.py - Helper functions for modules working with F5 networking devices.</li>
<li>facts.py - Helper functions for modules that return facts.</li>
<li>gce.py - Definitions and helper functions for modules that work with Google Compute Engine resources.</li>
<li>ios.py - Definitions and helper functions for modules that manage Cisco IOS networking devices</li>
<li>iosxr.py - Definitions and helper functions for modules that manage Cisco IOS-XR networking devices</li>
<li>ismount.py - Contains single helper function that fixes os.path.ismount</li>
<li>junos.py -  Definitions and helper functions for modules that manage Junos networking devices</li>
<li>known_hosts.py - utilities for working with known_hosts file</li>
<li>manageiq.py - Functions and utilities for modules that work with ManageIQ platform and its resources.</li>
<li>mysql.py - Allows modules to connect to a MySQL instance</li>
<li>netapp.py - Functions and utilities for modules that work with the NetApp storage platforms.</li>
<li>netcfg.py - Configuration utility functions for use by networking modules</li>
<li>netcmd.py - Defines commands and comparison operators for use in networking modules</li>
<li>netscaler.py - Utilities specifically for the netscaler network modules.</li>
<li>network.py - Functions for running commands on networking devices</li>
<li>nxos.py - Contains definitions and helper functions specific to Cisco NXOS networking devices</li>
<li>openstack.py - Utilities for modules that work with Openstack instances.</li>
<li>openswitch.py - Definitions and helper functions for modules that manage OpenSwitch devices</li>
<li>powershell.ps1 - Utilities for working with Microsoft Windows clients</li>
<li>pure.py - Functions and utilities for modules that work with the Pure Storage storage platforms.</li>
<li>pycompat24.py - Exception workaround for Python 2.4.</li>
<li>rax.py -  Definitions and helper functions for modules that work with Rackspace resources.</li>
<li>redhat.py - Functions for modules that manage Red Hat Network registration and subscriptions</li>
<li>service.py - Contains utilities to enable modules to work with Linux services (placeholder, not in use).</li>
<li>shell.py - Functions to allow modules to create shells and work with shell commands</li>
<li>six/__init__.py - Bundled copy of the <a class="reference external" href="https://pythonhosted.org/six/">Six Python library</a> to aid in writing code compatible with both Python 2 and Python 3.</li>
<li>splitter.py - String splitting and manipulation utilities for working with Jinja2 templates</li>
<li>urls.py - Utilities for working with http and https requests</li>
<li>vca.py - Contains utilities for modules that work with VMware vCloud Air</li>
<li>vmware.py - Contains utilities for modules that work with VMware vSphere VMs</li>
<li>vyos.py - Definitions and functions for working with VyOS networking</li>
</ul>
</div>
</div>
<span id="document-dev_guide/developing_modules_general"></span><div class="section" id="ansible-module-development-walkthrough">
<span id="module-dev-tutorial-sample"></span><h5>Ansible Module Development Walkthrough<a class="headerlink" href="#ansible-module-development-walkthrough" title="Permalink to this headline">¶</a></h5>
<p>In this section, we will walk through developing, testing, and debugging an Ansible module.</p>
<p>What&#8217;s covered in this section:</p>
<ul class="simple">
<li><a class="reference external" href="#environment-setup">Environment setup</a></li>
<li><a class="reference external" href="#new-module-development">New module development</a></li>
<li><a class="reference external" href="#localdirect-module-testing">Local/direct module testing</a></li>
<li><a class="reference external" href="#playbook-module-testing">Playbook module testing</a></li>
<li><a class="reference external" href="#debugging-local">Debugging (local)</a></li>
<li><a class="reference external" href="#debugging-remote">Debugging (remote)</a></li>
<li><a class="reference external" href="#unit-testing">Unit testing</a></li>
<li>Integration testing (coming soon)</li>
<li><a class="reference external" href="#communication-and-development-support">Communication and development
support</a></li>
<li><a class="reference external" href="#credit">Credit</a></li>
</ul>
</div>
<div class="section" id="environment-setup">
<h5>Environment setup<a class="headerlink" href="#environment-setup" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Clone the Ansible repository:
<code class="docutils literal"><span class="pre">$</span> <span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/ansible/ansible.git</span></code></li>
<li>Change directory into the repository root dir: <code class="docutils literal"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">ansible</span></code></li>
<li>Create a virtual environment: <code class="docutils literal"><span class="pre">$</span> <span class="pre">python3</span> <span class="pre">-m</span> <span class="pre">venv</span> <span class="pre">venv</span></code> (or for
Python 2 <code class="docutils literal"><span class="pre">$</span> <span class="pre">virtualenv</span> <span class="pre">venv</span></code>. Note, this requires you to install
the virtualenv package: <code class="docutils literal"><span class="pre">$</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">virtualenv</span></code>)</li>
<li>Activate the virtual environment: <code class="docutils literal"><span class="pre">$</span> <span class="pre">.</span> <span class="pre">venv/bin/activate</span></code></li>
<li>Install development requirements:
<code class="docutils literal"><span class="pre">$</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code></li>
<li>Run the environment setup script for each new dev shell process:
<code class="docutils literal"><span class="pre">$</span> <span class="pre">.</span> <span class="pre">hacking/env-setup</span></code></li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">After the initial setup above, every time you are ready to start
developing Ansible you should be able to just run the following from the
root of the Ansible repo:
<code class="docutils literal"><span class="pre">$</span> <span class="pre">.</span> <span class="pre">venv/bin/activate</span> <span class="pre">&amp;&amp;</span> <span class="pre">.</span> <span class="pre">hacking/env-setup</span></code></p>
</div>
</div>
<div class="section" id="new-module-development">
<h5>New module development<a class="headerlink" href="#new-module-development" title="Permalink to this headline">¶</a></h5>
<p>If you are creating a new module that doesn&#8217;t exist, you would start
working on a whole new file. Here is an example:</p>
<ul class="simple">
<li>Navigate to the directory that you want to develop your new module
in. E.g. <code class="docutils literal"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">lib/ansible/modules/cloud/azure/</span></code></li>
<li>Create your new module file: <code class="docutils literal"><span class="pre">$</span> <span class="pre">touch</span> <span class="pre">my_new_test_module.py</span></code></li>
<li>Paste this example code into the new module file: (explanation in comments)</li>
</ul>
<div class="code python highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="nv">ANSIBLE_METADATA</span> <span class="o">=</span> <span class="o">{</span>
    <span class="s1">&#39;metadata_version&#39;</span>: <span class="s1">&#39;1.1&#39;</span>,
    <span class="s1">&#39;status&#39;</span>: <span class="o">[</span><span class="s1">&#39;preview&#39;</span><span class="o">]</span>,
    <span class="s1">&#39;supported_by&#39;</span>: <span class="s1">&#39;community&#39;</span>
<span class="o">}</span>

<span class="nv">DOCUMENTATION</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">---</span>
<span class="s1">module: my_sample_module</span>

<span class="s1">short_description: This is my sample module</span>

<span class="s1">version_added: &quot;2.4&quot;</span>

<span class="s1">description:</span>
<span class="s1">    - &quot;This is my longer description explaining my sample module&quot;</span>

<span class="s1">options:</span>
<span class="s1">    name:</span>
<span class="s1">        description:</span>
<span class="s1">            - This is the message to send to the sample module</span>
<span class="s1">        required: true</span>
<span class="s1">    new:</span>
<span class="s1">        description:</span>
<span class="s1">            - Control to demo if the result of this module is changed or not</span>
<span class="s1">        required: false</span>

<span class="s1">extends_documentation_fragment:</span>
<span class="s1">    - azure</span>

<span class="s1">author:</span>
<span class="s1">    - Your Name (@yourhandle)</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="nv">EXAMPLES</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Pass in a message</span>
<span class="s1">- name: Test with a message</span>
<span class="s1">  my_new_test_module:</span>
<span class="s1">    name: hello world</span>

<span class="s1"># pass in a message and have changed true</span>
<span class="s1">- name: Test with a message and changed output</span>
<span class="s1">  my_new_test_module:</span>
<span class="s1">    name: hello world</span>
<span class="s1">    new: true</span>

<span class="s1"># fail the module</span>
<span class="s1">- name: Test failure of the module</span>
<span class="s1">  my_new_test_module:</span>
<span class="s1">    name: fail me</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="nv">RETURN</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">original_message:</span>
<span class="s1">    description: The original name param that was passed in</span>
<span class="s1">    type: str</span>
<span class="s1">message:</span>
<span class="s1">    description: The output message that the sample module generates</span>
<span class="s1">&#39;&#39;&#39;</span>

from ansible.module_utils.basic import AnsibleModule

def run_module<span class="o">()</span>:
    <span class="c1"># define the available arguments/parameters that a user can pass to</span>
    <span class="c1"># the module</span>
    <span class="nv">module_args</span> <span class="o">=</span> dict<span class="o">(</span>
        <span class="nv">name</span><span class="o">=</span>dict<span class="o">(</span><span class="nv">type</span><span class="o">=</span><span class="s1">&#39;str&#39;</span>, <span class="nv">required</span><span class="o">=</span>True<span class="o">)</span>,
        <span class="nv">new</span><span class="o">=</span>dict<span class="o">(</span><span class="nv">type</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span>, <span class="nv">required</span><span class="o">=</span>False, <span class="nv">default</span><span class="o">=</span>False<span class="o">)</span>
    <span class="o">)</span>

    <span class="c1"># seed the result dict in the object</span>
    <span class="c1"># we primarily care about changed and state</span>
    <span class="c1"># change is if this module effectively modified the target</span>
    <span class="c1"># state will include any data that you want your module to pass back</span>
    <span class="c1"># for consumption, for example, in a subsequent task</span>
    <span class="nv">result</span> <span class="o">=</span> dict<span class="o">(</span>
        <span class="nv">changed</span><span class="o">=</span>False,
        <span class="nv">original_message</span><span class="o">=</span><span class="s1">&#39;&#39;</span>,
        <span class="nv">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="o">)</span>

    <span class="c1"># the AnsibleModule object will be our abstraction working with Ansible</span>
    <span class="c1"># this includes instantiation, a couple of common attr would be the</span>
    <span class="c1"># args/params passed to the execution, as well as if the module</span>
    <span class="c1"># supports check mode</span>
    <span class="nv">module</span> <span class="o">=</span> AnsibleModule<span class="o">(</span>
        <span class="nv">argument_spec</span><span class="o">=</span>module_args,
        <span class="nv">supports_check_mode</span><span class="o">=</span>True
    <span class="o">)</span>

    <span class="c1"># if the user is working with this module in only check mode we do not</span>
    <span class="c1"># want to make any changes to the environment, just return the current</span>
    <span class="c1"># state with no modifications</span>
    <span class="k">if</span> module.check_mode:
        <span class="k">return</span> result

    <span class="c1"># manipulate or modify the state as needed (this is going to be the</span>
    <span class="c1"># part where your module will do what it needs to do)</span>
    result<span class="o">[</span><span class="s1">&#39;original_message&#39;</span><span class="o">]</span> <span class="o">=</span> module.params<span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
    result<span class="o">[</span><span class="s1">&#39;message&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;goodbye&#39;</span>

    <span class="c1"># use whatever logic you need to determine whether or not this module</span>
    <span class="c1"># made any modifications to your target</span>
    <span class="k">if</span> module.params<span class="o">[</span><span class="s1">&#39;new&#39;</span><span class="o">]</span>:
        result<span class="o">[</span><span class="s1">&#39;changed&#39;</span><span class="o">]</span> <span class="o">=</span> True

    <span class="c1"># during the execution of the module, if there is an exception or a</span>
    <span class="c1"># conditional state that effectively causes a failure, run</span>
    <span class="c1"># AnsibleModule.fail_json() to pass in the message and the result</span>
    <span class="k">if</span> module.params<span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;fail me&#39;</span>:
        module.fail_json<span class="o">(</span><span class="nv">msg</span><span class="o">=</span><span class="s1">&#39;You requested this to fail&#39;</span>, **result<span class="o">)</span>

    <span class="c1"># in the event of a successful module execution, you will want to</span>
    <span class="c1"># simple AnsibleModule.exit_json(), passing the key/value results</span>
    module.exit_json<span class="o">(</span>**result<span class="o">)</span>

def main<span class="o">()</span>:
    run_module<span class="o">()</span>

<span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span>:
    main<span class="o">()</span>
</pre></div>
</div>
</div>
<div class="section" id="local-direct-module-testing">
<h5>Local/direct module testing<a class="headerlink" href="#local-direct-module-testing" title="Permalink to this headline">¶</a></h5>
<p>You may want to test the module on the local machine without targeting a
remote host. This is a great way to quickly and easily debug a module
that can run locally.</p>
<ul class="simple">
<li>Create an arguments file in <code class="docutils literal"><span class="pre">/tmp/args.json</span></code> with the following
content: (explanation below)</li>
</ul>
<div class="code json highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;ANSIBLE_MODULE_ARGS&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;hello&quot;</span>,
        <span class="s2">&quot;new&quot;</span>: <span class="nb">true</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li>If you are using a virtual environment (highly recommended for
development) activate it: <code class="docutils literal"><span class="pre">$</span> <span class="pre">.</span> <span class="pre">venv/bin/activate</span></code></li>
<li>Setup the environment for development: <code class="docutils literal"><span class="pre">$</span> <span class="pre">.</span> <span class="pre">hacking/env-setup</span></code></li>
<li>Run your test module locally and directly:
<code class="docutils literal"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">./my_new_test_module.py</span> <span class="pre">/tmp/args.json</span></code></li>
</ul>
<p>This should be working output that resembles something like the
following:</p>
<div class="code json highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>: true, <span class="s2">&quot;state&quot;</span>: <span class="o">{</span><span class="s2">&quot;original_message&quot;</span>: <span class="s2">&quot;hello&quot;</span>, <span class="s2">&quot;new_message&quot;</span>: <span class="s2">&quot;goodbye&quot;</span><span class="o">}</span>, <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span><span class="s2">&quot;module_args&quot;</span>: <span class="o">{</span><span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;hello&quot;</span>, <span class="s2">&quot;new&quot;</span>: true<span class="o">}}}</span>
</pre></div>
</div>
<p>The arguments file is just a basic json config file that you can
use to pass the module your parameters to run the module it</p>
</div>
<div class="section" id="playbook-module-testing">
<h5>Playbook module testing<a class="headerlink" href="#playbook-module-testing" title="Permalink to this headline">¶</a></h5>
<p>If you want to test your new module, you can now consume it with an
Ansible playbook.</p>
<ul>
<li><p class="first">Create a playbook in any directory: <code class="docutils literal"><span class="pre">$</span> <span class="pre">touch</span> <span class="pre">testmod.yml</span></code></p>
</li>
<li><p class="first">Add the following to the new playbook file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: <span class="nb">test</span> my new module
  connection: <span class="nb">local</span>
  hosts: localhost
  tasks:
  - name: run the new module
    my_new_test_module:
      name: <span class="s1">&#39;hello&#39;</span>
      new: <span class="nb">true</span>
    register: testout
  - name: dump <span class="nb">test</span> output
    debug:
      msg: <span class="s1">&#39;{{ testout }}&#39;</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the playbook and analyze the output: <code class="docutils literal"><span class="pre">$</span> <span class="pre">ansible-playbook</span> <span class="pre">./testmod.yml</span></code></p>
</li>
</ul>
</div>
<div class="section" id="debugging-local">
<h5>Debugging (local)<a class="headerlink" href="#debugging-local" title="Permalink to this headline">¶</a></h5>
<p>If you want to break into a module and step through with the debugger, locally running the module you can do:</p>
<ul class="simple">
<li>Set a breakpoint in the module: <code class="docutils literal"><span class="pre">import</span> <span class="pre">pdb;</span> <span class="pre">pdb.set_trace()</span></code></li>
<li>Run the module on the local machine: <code class="docutils literal"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">-m</span> <span class="pre">pdb</span> <span class="pre">./my_new_test_module.py</span> <span class="pre">./args.json</span></code></li>
</ul>
</div>
<div class="section" id="debugging-remote">
<h5>Debugging (remote)<a class="headerlink" href="#debugging-remote" title="Permalink to this headline">¶</a></h5>
<p>In the event you want to debug a module that is running on a remote target (i.e. not localhost), one way to do this is the following:</p>
<ul class="simple">
<li>On your controller machine (running Ansible) set <cite>ANSIBLE_KEEP_REMOTE_FILES=1</cite> (this tells Ansible to retain the modules it sends to the remote machine instead of removing them)</li>
<li>Run your playbook targetting the remote machine and specify <code class="docutils literal"><span class="pre">-vvvv</span></code> (the verbose output will show you many things, including the remote location that Ansible uses for the modules)</li>
<li>Take note of the remote path Ansible used on the remote host</li>
<li>SSH into the remote target after the completion of the playbook</li>
<li>Navigate to the directory (most likely it is going to be your ansible remote user defined or implied from the playbook: <code class="docutils literal"><span class="pre">~/.ansible/tmp/ansible-tmp-...</span></code>)</li>
<li>Here you should see the module that you executed from your Ansible controller, but this is the zipped file that Ansible sent to the remote host. You can run this by specifying <code class="docutils literal"><span class="pre">python</span> <span class="pre">my_test_module.py</span></code> (not necessary)</li>
<li>To debug, though, we will want to extract this zip out to the original module format: <code class="docutils literal"><span class="pre">python</span> <span class="pre">my_test_module.py</span> <span class="pre">explode</span></code> (Ansible will expand the module into <code class="docutils literal"><span class="pre">./debug-dir</span></code>)</li>
<li>Navigate to <code class="docutils literal"><span class="pre">./debug-dir</span></code> (notice that unzipping has caused the generation of <code class="docutils literal"><span class="pre">ansible_module_my_test_module.py</span></code>)</li>
<li>Modify or set a breakpoint in the unzipped module</li>
<li>Ensure that the unzipped module is executable: <code class="docutils literal"><span class="pre">$</span> <span class="pre">chmod</span> <span class="pre">755</span> <span class="pre">ansible_module_my_test_module.py</span></code></li>
<li>Run the unzipped module directly passing the args file: <code class="docutils literal"><span class="pre">$</span> <span class="pre">./ansible_module_my_test_module.py</span> <span class="pre">args</span></code> (args is the file that contains the params that were originally passed. Good for repro and debugging)</li>
</ul>
</div>
<div class="section" id="unit-testing">
<h5>Unit testing<a class="headerlink" href="#unit-testing" title="Permalink to this headline">¶</a></h5>
<p>Unit tests for modules will be appropriately located in <code class="docutils literal"><span class="pre">./test/units/modules</span></code>. You must first setup your testing environment. In this example, we&#8217;re using Python 3.5.</p>
<ul class="simple">
<li>Install the requirements (outside of your virtual environment): <code class="docutils literal"><span class="pre">$</span> <span class="pre">pip3</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">./test/runner/requirements/units.txt</span></code></li>
<li>To run all tests do the following: <code class="docutils literal"><span class="pre">$</span> <span class="pre">ansible-test</span> <span class="pre">units</span> <span class="pre">--python</span> <span class="pre">3.5</span></code> (you must run <code class="docutils literal"><span class="pre">.</span> <span class="pre">hacking/env-setup</span></code> prior to this)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible uses pytest for unit testing.</p>
</div>
<p>To run pytest against a single test module, you can do the following (provide the path to the test module appropriately):</p>
<p><code class="docutils literal"><span class="pre">$</span> <span class="pre">pytest</span> <span class="pre">-r</span> <span class="pre">a</span> <span class="pre">--cov=.</span> <span class="pre">--cov-report=html</span> <span class="pre">--fulltrace</span> <span class="pre">--color</span> <span class="pre">yes</span>
<span class="pre">test/units/modules/.../test/my_new_test_module.py</span></code></p>
</div>
<div class="section" id="going-further">
<h5>Going Further<a class="headerlink" href="#going-further" title="Permalink to this headline">¶</a></h5>
<p>If you are starting new development or fixing a bug, create a new branch:</p>
<p><code class="docutils literal"><span class="pre">$</span> <span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">-b</span> <span class="pre">my-new-branch</span></code>.</p>
<p>If you are planning on contributing
back to the main Ansible repository, fork the Ansible repository into
your own GitHub account and develop against the new non-devel branch
in your fork. When you believe you have a good working code change,
submit a pull request to the Ansible repository.</p>
<p>If you want to submit a new module to the upstream Ansible repo, be sure
to run through sanity checks first. For example:</p>
<p><code class="docutils literal"><span class="pre">$</span> <span class="pre">ansible-test</span> <span class="pre">sanity</span> <span class="pre">-v</span> <span class="pre">--docker</span> <span class="pre">--python</span> <span class="pre">2.7</span> <span class="pre">MODULE_NAME</span></code></p>
<p>Note that this example requires docker to be installed and running. If you&#8217;d rather not use a
container for this, you can choose to use <code class="docutils literal"><span class="pre">--tox</span></code> instead of <code class="docutils literal"><span class="pre">--docker</span></code>.</p>
</div>
<div class="section" id="communication-and-development-support">
<h5>Communication and development support<a class="headerlink" href="#communication-and-development-support" title="Permalink to this headline">¶</a></h5>
<p>Join the IRC channel <code class="docutils literal"><span class="pre">#ansible-devel</span></code> on freenode for discussions
surrounding Ansible development.</p>
<p>For questions and discussions pertaining to using the Ansible product,
use the <code class="docutils literal"><span class="pre">#ansible</span></code> channel.</p>
</div>
<div class="section" id="credit">
<h5>Credit<a class="headerlink" href="#credit" title="Permalink to this headline">¶</a></h5>
<p>Thank you to Thomas Stringer (<a class="reference external" href="https://github.com/tstringer">&#64;tstring</a>) for contributing source
material for this topic.</p>
</div>
<span id="document-dev_guide/developing_modules_general_windows"></span><div class="section" id="windows-ansible-module-development-walkthrough">
<h5><a class="toc-backref" href="#id1">Windows Ansible Module Development Walkthrough</a><a class="headerlink" href="#windows-ansible-module-development-walkthrough" title="Permalink to this headline">¶</a></h5>
<p>In this section, we will walk through developing, testing, and debugging an
Ansible Windows module.</p>
<p>Because Windows modules are written in Powershell and need to be run on a
Windows host, this guide differs from the usual development walkthrough guide.</p>
<p>What&#8217;s covered in this section:</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#windows-ansible-module-development-walkthrough" id="id1">Windows Ansible Module Development Walkthrough</a></li>
<li><a class="reference internal" href="#windows-environment-setup" id="id2">Windows environment setup</a></li>
<li><a class="reference internal" href="#windows-new-module-development" id="id3">Windows new module development</a></li>
<li><a class="reference internal" href="#windows-playbook-module-testing" id="id4">Windows playbook module testing</a></li>
<li><a class="reference internal" href="#windows-debugging" id="id5">Windows debugging</a></li>
<li><a class="reference internal" href="#windows-unit-testing" id="id6">Windows unit testing</a></li>
<li><a class="reference internal" href="#windows-integration-testing" id="id7">Windows integration testing</a></li>
<li><a class="reference internal" href="#windows-communication-and-development-support" id="id8">Windows communication and development support</a></li>
</ul>
</div>
</div>
<div class="section" id="windows-environment-setup">
<h5><a class="toc-backref" href="#id2">Windows environment setup</a><a class="headerlink" href="#windows-environment-setup" title="Permalink to this headline">¶</a></h5>
<p>TODO: Add in more information on how to use Vagrant to setup a Windows host.</p>
</div>
<div class="section" id="windows-new-module-development">
<h5><a class="toc-backref" href="#id3">Windows new module development</a><a class="headerlink" href="#windows-new-module-development" title="Permalink to this headline">¶</a></h5>
<p>When creating a new module there are a few things to keep in mind:</p>
<ul class="simple">
<li>Module code is in Powershell (.ps1) files while the documentation is contained in Python (.py) files of the same name</li>
<li>Avoid using <code class="docutils literal"><span class="pre">Write-Host/Debug/Verbose/Error</span></code> in the module and add what needs to be returned to the <code class="docutils literal"><span class="pre">$result</span></code> variable</li>
<li>When trying an exception use <code class="docutils literal"><span class="pre">Fail-Json</span> <span class="pre">-obj</span> <span class="pre">$result</span> <span class="pre">-message</span> <span class="pre">&quot;exception</span> <span class="pre">message</span> <span class="pre">here&quot;</span></code> instead</li>
<li>Most new modules require check mode and integration tests before they are merged into the main Ansible codebase</li>
<li>Avoid using try/catch statements over a large code block, rather use them for individual calls so the error message can be more descriptive</li>
<li>Try and catch specific exceptions when using try/catch statements</li>
<li>Avoid using PSCustomObjects unless necessary</li>
<li>Look for common functions in <code class="docutils literal"><span class="pre">./lib/ansible/module_utils/powershell/</span></code> and use the code there instead of duplicating work. These can be imported by adding the line <code class="docutils literal"><span class="pre">#Requires</span> <span class="pre">-Module</span> <span class="pre">*</span></code> where * is the filename to import, and will be automatically included with the module code sent to the Windows target when run via Ansible</li>
<li>Ensure the code runs under Powershell v3 and higher on Windows Server 2008 and higher; if higher minimum Powershell or OS versions are required, ensure the documentation reflects this clearly</li>
<li>Ansible runs modules under strictmode version 2.0. Be sure to test with that enabled by putting <code class="docutils literal"><span class="pre">Set-StrictMode</span> <span class="pre">-Version</span> <span class="pre">2.0</span></code> at the top of your dev script</li>
<li>Favour native Powershell cmdlets over executable calls if possible</li>
<li>If adding an object to <code class="docutils literal"><span class="pre">$result</span></code>, ensure any trailing slashes are removed or escaped, as <code class="docutils literal"><span class="pre">ConvertTo-Json</span></code> will fail to convert it</li>
<li>Use the full cmdlet name instead of aliases, e.g. <code class="docutils literal"><span class="pre">Remove-Item</span></code> over <code class="docutils literal"><span class="pre">rm</span></code></li>
<li>Use named parameters with cmdlets, e.g. <code class="docutils literal"><span class="pre">Remove-Item</span> <span class="pre">-Path</span> <span class="pre">C:\temp</span></code> over <code class="docutils literal"><span class="pre">Remove-Item</span> <span class="pre">C:\temp</span></code></li>
</ul>
<p>A very basic powershell module template can be found found below:</p>
<div class="highlight-powershell"><div class="highlight"><pre><span></span><span class="c">#!powershell</span>
<span class="c"># This file is part of Ansible</span>

<span class="c"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span>

<span class="c">#Requires -Module Ansible.ModuleUtils.Legacy.psm1</span>

<span class="nv">$ErrorActionPreference</span> <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>

<span class="nv">$params</span> <span class="p">=</span> <span class="n">Parse-Args</span> <span class="n">-arguments</span> <span class="nv">$args</span> <span class="n">-supports_check_mode</span> <span class="nv">$true</span>
<span class="nv">$check_mode</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;_ansible_check_mode&quot;</span> <span class="n">-type</span> <span class="s2">&quot;bool&quot;</span> <span class="n">-default</span> <span class="nv">$false</span>
<span class="nv">$diff_mode</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;_ansible_diff&quot;</span> <span class="n">-type</span> <span class="s2">&quot;bool&quot;</span> <span class="n">-default</span> <span class="nv">$false</span>

<span class="c"># these are your module parameters, there are various types which can be</span>
<span class="c"># used to format your parameters. You can also set mandatory parameters</span>
<span class="c"># with -failifempty, set defaults with -default and set choices with</span>
<span class="c"># -validateset.</span>
<span class="nv">$string</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;string&quot;</span> <span class="n">-type</span> <span class="s2">&quot;str&quot;</span> <span class="n">-failifempty</span> <span class="nv">$true</span>
<span class="nv">$bool</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;bool&quot;</span> <span class="n">-type</span> <span class="s2">&quot;bool&quot;</span> <span class="n">-default</span> <span class="nv">$false</span>
<span class="nv">$int</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;int&quot;</span> <span class="n">-type</span> <span class="s2">&quot;int&quot;</span>
<span class="nv">$path</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;path&quot;</span> <span class="n">-type</span> <span class="s2">&quot;path&quot;</span>
<span class="nv">$list</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;list&quot;</span> <span class="n">-type</span> <span class="s2">&quot;list&quot;</span>
<span class="nv">$choices</span> <span class="p">=</span> <span class="nb">Get-AnsibleParam</span> <span class="n">-obj</span> <span class="nv">$params</span> <span class="n">-name</span> <span class="s2">&quot;choices&quot;</span> <span class="n">-type</span> <span class="s2">&quot;str&quot;</span> <span class="n">-default</span> <span class="s2">&quot;present&quot;</span> <span class="n">-validateset</span> <span class="s2">&quot;absent&quot;</span><span class="p">,</span><span class="s2">&quot;present&quot;</span>

<span class="nv">$result</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">changed</span> <span class="p">=</span> <span class="nv">$false</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$diff_mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$result</span><span class="p">.</span><span class="n">diff</span> <span class="p">=</span> <span class="p">@{}</span>
<span class="p">}</span>

<span class="c"># code goes here</span>

<span class="c"># you can add/set new result objects with</span>
<span class="nv">$result</span><span class="p">.</span><span class="n">changed</span> <span class="p">=</span> <span class="nv">$true</span>
<span class="nv">$result</span><span class="p">.</span><span class="n">new_result</span> <span class="p">=</span> <span class="s2">&quot;Hi&quot;</span>

<span class="nb">Exit-Json</span> <span class="n">-obj</span> <span class="nv">$result</span>
</pre></div>
</div>
<p>When in doubt, look at some of the core modules and see how things have been
implemented there.</p>
<p>Sometimes there are multiple ways that Windows offers to complete a task; this
is the order to favour when writing modules:</p>
<ul class="simple">
<li>Native Powershell cmdlets like <code class="docutils literal"><span class="pre">Remove-Item</span> <span class="pre">-Path</span> <span class="pre">C:\temp</span> <span class="pre">-Recurse</span></code></li>
<li>.NET classes like <code class="docutils literal"><span class="pre">[System.IO.Path]::GetRandomFileName()</span></code></li>
<li>WMI objects through the <code class="docutils literal"><span class="pre">New-CimInstance</span></code> cmdlet</li>
<li>COM objects through <code class="docutils literal"><span class="pre">New-Object</span> <span class="pre">-ComObject</span></code> cmdlet</li>
<li>Calls to native executables like <code class="docutils literal"><span class="pre">Secedit.exe</span></code></li>
</ul>
</div>
<div class="section" id="windows-playbook-module-testing">
<h5><a class="toc-backref" href="#id4">Windows playbook module testing</a><a class="headerlink" href="#windows-playbook-module-testing" title="Permalink to this headline">¶</a></h5>
<p>To test a module you can do so with an Ansible playbook.</p>
<ul>
<li><p class="first">Create a playbook in any directory <code class="docutils literal"><span class="pre">touch</span> <span class="pre">testmodule.yml</span></code></p>
</li>
<li><p class="first">Create an inventory file in the same directory <code class="docutils literal"><span class="pre">touch</span> <span class="pre">hosts</span></code></p>
</li>
<li><p class="first">Populate the inventory file with the variables required to connect to a Windows host(s).</p>
</li>
<li><p class="first">Add the following to the new playbook file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- name: <span class="nb">test</span> out windows module
  hosts: windows
  tasks:
  - name: <span class="nb">test</span> out module
    win_module:
      name: <span class="nb">test</span> name
</pre></div>
</div>
</li>
<li><p class="first">Run the playbook <code class="docutils literal"><span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">hosts</span> <span class="pre">testmodule.yml</span></code></p>
</li>
</ul>
<p>This can be pretty high level and is useful for seeing how Ansible runs with
the new module end to end: but there are better ways to test out the module as
shown below.</p>
</div>
<div class="section" id="windows-debugging">
<h5><a class="toc-backref" href="#id5">Windows debugging</a><a class="headerlink" href="#windows-debugging" title="Permalink to this headline">¶</a></h5>
<p>Debugging a module currently can only be done on a Windows host. This is
extremely useful when developing a new module or looking at bug fixes. These
are some steps that need to be followed to set this up.</p>
<ul>
<li><p class="first">Copy the module script to the Windows server</p>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">./lib/ansible/module_utils/powershell/Ansible.ModuleUtils.Legacy.psm1</span></code> to the same directory as the script above</p>
</li>
<li><p class="first">To stop the script from exiting the editor on a successful run, in <code class="docutils literal"><span class="pre">Ansible.ModuleUtils.Legacy.psm1</span></code> under the function <code class="docutils literal"><span class="pre">Exit-Json</span></code>, replace the last two lines of the function with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ConvertTo-Json -InputObject <span class="nv">$obj</span> -Depth <span class="m">99</span>
</pre></div>
</div>
</li>
<li><p class="first">To stop the script from exiting the editor on a failed run, in <code class="docutils literal"><span class="pre">Ansible.ModuleUtils.Legacy.psm1</span></code> under the function <code class="docutils literal"><span class="pre">Fail-Json</span></code>, replace the last two lines of the function with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Write-Error -Message <span class="o">(</span>ConvertTo-Json -InputObject <span class="nv">$obj</span> -Depth <span class="m">99</span><span class="o">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the following to the start of the module script that was copied to the server:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1">### start setup code</span>
<span class="nv">$complex_args</span> <span class="o">=</span> @<span class="o">{</span>
    <span class="s2">&quot;_ansible_check_mode&quot;</span> <span class="o">=</span> <span class="nv">$false</span>
    <span class="s2">&quot;_ansible_diff&quot;</span> <span class="o">=</span> <span class="nv">$false</span>
    <span class="s2">&quot;path&quot;</span> <span class="o">=</span> <span class="s2">&quot;C:\temp&quot;</span>
    <span class="s2">&quot;state&quot;</span> <span class="o">=</span> <span class="s2">&quot;present&quot;</span>
<span class="o">}</span>

Import-Module -Name .<span class="se">\A</span>nsible.ModuleUtils.Legacy.psm1
<span class="c1">### end setup code</span>
</pre></div>
</div>
</li>
</ul>
<p>You can add more args to <code class="docutils literal"><span class="pre">$complex_args</span></code> as required by the module. The
module can now be run on the Windows host either directly through Powershell
or through an IDE.</p>
<p>There are multiple IDEs that can be used to debug a Powershell script, two of
the most popular are</p>
<ul class="simple">
<li><a class="reference external" href="https://msdn.microsoft.com/en-us/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise">Powershell ISE</a></li>
<li><a class="reference external" href="https://blogs.technet.microsoft.com/heyscriptingguy/2017/02/06/debugging-powershell-script-in-visual-studio-code-part-1/">Visual Studio Code</a></li>
</ul>
<p>To be able to view the arguments as passed by Ansible to the module follow
these steps.</p>
<ul class="simple">
<li>Prefix the Ansible command with <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_KEEP_REMOTE_FILES=1</span></code> to get Ansible to keep the exec files on the server</li>
<li>Log onto the Windows server using the same user Ansible executed the module as</li>
<li>Navigate to <code class="docutils literal"><span class="pre">%TEMP%\..</span></code>, there should be a folder starting with <code class="docutils literal"><span class="pre">ansible-tmp-</span></code></li>
<li>Inside this folder open up the powershell script for the module</li>
<li>In this script there is a raw JSON script under <code class="docutils literal"><span class="pre">$json_raw</span></code> which contains the module arguments under <code class="docutils literal"><span class="pre">module_args</span></code></li>
<li>These args can be assigned manually to the <code class="docutils literal"><span class="pre">$complex_args</span></code> variable that is defined on your debug script</li>
</ul>
</div>
<div class="section" id="windows-unit-testing">
<h5><a class="toc-backref" href="#id6">Windows unit testing</a><a class="headerlink" href="#windows-unit-testing" title="Permalink to this headline">¶</a></h5>
<p>Currently there is no mechanism to run unit tests for Powershell modules under Ansible CI.
There is work in the pipeline to introduce this in the future, stay tuned.</p>
</div>
<div class="section" id="windows-integration-testing">
<h5><a class="toc-backref" href="#id7">Windows integration testing</a><a class="headerlink" href="#windows-integration-testing" title="Permalink to this headline">¶</a></h5>
<p>Integration tests for Ansible modules are typically written as Ansible roles. The test
roles are located in <code class="docutils literal"><span class="pre">./test/integration/targets</span></code>. You must first set up your testing
environment, and configure a test inventory for Ansible to connect to. In this example we
will set up a test inventory to connect to two hosts and run the integration
tests for win_stat.</p>
<ul class="simple">
<li>Create a copy of <code class="docutils literal"><span class="pre">./test/integration/inventory.winrm.template</span></code> and just call it <code class="docutils literal"><span class="pre">inventory.winrm</span></code></li>
<li>Fill in entries under <code class="docutils literal"><span class="pre">[windows]</span></code> and set the required vars that are needed to connect to the host</li>
<li>To execute the integration tests, run <code class="docutils literal"><span class="pre">ansible-test</span> <span class="pre">windows-integration</span> <span class="pre">win_stat</span></code>- you can replace <code class="docutils literal"><span class="pre">win_stat</span></code> with the role you wish to test</li>
</ul>
<p>This will execute all the tests currently defined for that role. You can set
the verbosity level using the <code class="docutils literal"><span class="pre">-v</span></code> argument just as you would with
ansible-playbook.</p>
<p>When developing tests for a new module, it is recommended to test a scenario in
check mode and 2 times not in check mode. This ensures that check mode
does not make any changes but reports a change, as well as that the 2nd run is
idempotent and does not report changes. Following is an example of one way that this can be done:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove a file (check mode)</span>
  <span class="l l-Scalar l-Scalar-Plain">win_file</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">C:\temp</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_check</span>
  <span class="l l-Scalar l-Scalar-Plain">check_mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">get result of remove a file (check mode)</span>
  <span class="l l-Scalar l-Scalar-Plain">win_command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">powershell.exe &quot;if (Test-Path -Path &#39;C:\temp&#39;) { &#39;true&#39; } else { &#39;false&#39; }&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual_check</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">assert remove a file (check mode)</span>
  <span class="l l-Scalar l-Scalar-Plain">assert</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">that</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_check|changed</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual_check.stdout == &#39;true\r\n&#39;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove a file</span>
  <span class="l l-Scalar l-Scalar-Plain">win_file</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">C:\temp</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">get result of remove a file</span>
  <span class="l l-Scalar l-Scalar-Plain">win_command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">powershell.exe &quot;if (Test-Path -Path &#39;C:\temp&#39;) { &#39;true&#39; } else { &#39;false&#39; }&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">assert remove a file</span>
  <span class="l l-Scalar l-Scalar-Plain">assert</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">that</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file|changed</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_actual.stdout == &#39;false\r\n&#39;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove a file (idempotent)</span>
  <span class="l l-Scalar l-Scalar-Plain">win_file</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">C:\temp</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">remove_file_again</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">assert remove a file (idempotent)</span>
  <span class="l l-Scalar l-Scalar-Plain">assert</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">that</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">not remove_file_again|changed</span>
</pre></div>
</div>
</div>
<div class="section" id="windows-communication-and-development-support">
<h5><a class="toc-backref" href="#id8">Windows communication and development support</a><a class="headerlink" href="#windows-communication-and-development-support" title="Permalink to this headline">¶</a></h5>
<p>Join the IRC channel <code class="docutils literal"><span class="pre">#ansible-devel</span></code> or <code class="docutils literal"><span class="pre">#ansible-windows</span></code> on freenode for
discussions surrounding Ansible development for Windows.</p>
<p>For questions and discussions pertaining to using the Ansible product,
use the <code class="docutils literal"><span class="pre">#ansible</span></code> channel.</p>
</div>
<span id="document-dev_guide/developing_modules_documenting"></span><div class="section" id="documenting-your-module">
<span id="module-documenting"></span><h5><a class="toc-backref" href="#id1">Documenting Your Module</a><a class="headerlink" href="#documenting-your-module" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#documenting-your-module" id="id1">Documenting Your Module</a><ul>
<li><a class="reference internal" href="#copyright" id="id2">Copyright</a></li>
<li><a class="reference internal" href="#ansible-metadata-block" id="id3">ANSIBLE_METADATA Block</a><ul>
<li><a class="reference internal" href="#version-1-1-of-the-metadata" id="id4">Version 1.1 of the metadata</a><ul>
<li><a class="reference internal" href="#structure" id="id5">Structure</a></li>
<li><a class="reference internal" href="#fields" id="id6">Fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes-from-version-1-0" id="id7">Changes from Version 1.0</a></li>
</ul>
</li>
<li><a class="reference internal" href="#documentation-block" id="id8">DOCUMENTATION Block</a></li>
<li><a class="reference internal" href="#examples-block" id="id9">EXAMPLES block</a></li>
<li><a class="reference internal" href="#return-block" id="id10">RETURN Block</a></li>
<li><a class="reference internal" href="#python-imports" id="id11">Python Imports</a></li>
<li><a class="reference internal" href="#formatting-options" id="id12">Formatting options</a></li>
<li><a class="reference internal" href="#documentation-fragments" id="id13">Documentation fragments</a></li>
<li><a class="reference internal" href="#testing-documentation" id="id14">Testing documentation</a></li>
</ul>
</li>
</ul>
</div>
<p>The online module documentation is generated from the modules themselves.
As the module documentation is generated from documentation strings contained in the modules, all modules included with Ansible must have a <code class="docutils literal"><span class="pre">DOCUMENTATION</span></code> string.
This string must be a valid YAML document
which conforms to the schema defined below. You may find it easier to
start writing your <code class="docutils literal"><span class="pre">DOCUMENTATION</span></code> string in an editor with YAML
syntax highlighting before you include it in your Python file.</p>
<p>All modules must have the following sections defined in this order:</p>
<ol class="arabic simple">
<li>Copyright</li>
<li>ANSIBLE_METADATA</li>
<li>DOCUMENTATION</li>
<li>EXAMPLES</li>
<li>RETURN</li>
<li>Python imports</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Why don&#8217;t the imports go first?</p>
<p class="last">Keen Python programmers may notice that contrary to PEP 8&#8217;s advice we don&#8217;t put <code class="docutils literal"><span class="pre">imports</span></code> at the top of the file. This is because the <code class="docutils literal"><span class="pre">ANSIBLE_METADATA</span></code> through <code class="docutils literal"><span class="pre">RETURN</span></code> sections are not used by the module code itself; they are essentially extra docstrings for the file. The imports are placed after these special variables for the same reason as PEP 8 puts the imports after the introductory comments and docstrings. This keeps the active parts of the code together and the pieces which are purely informational apart. The decision to exclude E402 is based on readability (which is what PEP 8 is about). Documentation strings in a module are much more similar to module level docstrings, than code, and are never utilized by the module itself. Placing the imports below this documentation and closer to the code, consolidates and groups all related code in a congruent manner to improve readability, debugging and understanding.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Why do some modules have imports at the bottom of the file?</p>
<p class="last">If you look at some existing older modules, you may find imports at the bottom of the file. Do not copy that idiom into new modules as it is a historical oddity due to how modules used to be combined with libraries. Over time we&#8217;re moving the imports to be in their proper place.</p>
</div>
<div class="section" id="copyright">
<h6><a class="toc-backref" href="#id2">Copyright</a><a class="headerlink" href="#copyright" title="Permalink to this headline">¶</a></h6>
<p>The beginning of every module should look about the same. After the shebang,
there should be at least two lines covering copyright and licensing of the
code.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># Copyright (c) 2017 Ansible Project</span>
<span class="c1"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span>
</pre></div>
</div>
<p>Every file should have a copyright line with the original copyright holder.
Major additions to the module (for instance, rewrites)  may add additional
copyright lines. Code from the Ansible community should typically be assigned
as &#8220;Copyright (c) 2017 Ansible Project&#8221; which covers all contributors. Any
legal questions need to review the source control history, so an exhaustive
copyright header is not necessary.</p>
<p>The license declaration should be ONLY one line, not the full GPL prefix. If
you notice a module with the full prefix, feel free to switch it to the
one-line declaration instead.</p>
<p>When adding a copyright line after completing a significant feature or rewrite,
add the newer line above the older one, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># Copyright (c) 2017 [New Contributor(s)]</span>
<span class="c1"># Copyright (c) 2015 [Original Contributor(s)]</span>
<span class="c1"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span>
</pre></div>
</div>
</div>
<div class="section" id="ansible-metadata-block">
<h6><a class="toc-backref" href="#id3">ANSIBLE_METADATA Block</a><a class="headerlink" href="#ansible-metadata-block" title="Permalink to this headline">¶</a></h6>
<p><code class="docutils literal"><span class="pre">ANSIBLE_METADATA</span></code> contains information about the module for use by other tools. At the moment, it informs other tools which type of maintainer the module has and to what degree users can rely on a module&#8217;s behaviour remaining the same over time.</p>
<p>For new modules, the following block can be simply added into your module</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ANSIBLE_METADATA</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;metadata_version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.1&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;preview&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;supported_by&#39;</span><span class="p">:</span> <span class="s1">&#39;community&#39;</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">metadata_version</span></code> is the version of the <code class="docutils literal"><span class="pre">ANSIBLE_METADATA</span></code> schema, <em>not</em> the version of the module.</li>
<li>Promoting a module&#8217;s <code class="docutils literal"><span class="pre">status</span></code> or <code class="docutils literal"><span class="pre">supported_by</span></code> status should only be done by members of the Ansible Core Team.</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Pre-released metdata version</p>
<p class="last">During development of Ansible-2.3, modules had an initial version of the
metadata.  This version was modified slightly after release to fix some
points of confusion.  You may occassionally see PRs for modules where the
ANSIBLE_METADATA doesn&#8217;t look quite right because of this.  Module
metadata should be fixed before checking it into the repository.</p>
</div>
<div class="section" id="version-1-1-of-the-metadata">
<h7><a class="toc-backref" href="#id4">Version 1.1 of the metadata</a><a class="headerlink" href="#version-1-1-of-the-metadata" title="Permalink to this headline">¶</a></h7>
<div class="section" id="structure">
<h8><a class="toc-backref" href="#id5">Structure</a><a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h8>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ANSIBLE_METADATA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;metadata_version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;supported_by&#39;</span><span class="p">:</span> <span class="s1">&#39;community&#39;</span><span class="p">,</span>
    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;preview&#39;</span><span class="p">,</span> <span class="s1">&#39;deprecated&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fields">
<h8><a class="toc-backref" href="#id6">Fields</a><a class="headerlink" href="#fields" title="Permalink to this headline">¶</a></h8>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">metadata_version:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body"><p class="first">An “X.Y” formatted string. X and Y are integers which
define the metadata format version. Modules shipped with Ansible are
tied to an Ansible release, so we will only ship with a single version
of the metadata. We’ll increment Y if we add fields or legal values
to an existing field. We’ll increment X if we remove fields or values
or change the type or meaning of a field.
Current metadata_version is &#8220;1.1&#8221;</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">supported_by:</th><td class="field-body"><p class="first">This field records who supports the module.
Default value is <code class="docutils literal"><span class="pre">community</span></code>. Values are:</p>
<ul class="simple">
<li>core</li>
<li>network</li>
<li>certified</li>
<li>community</li>
<li>curated (Deprecated.  Modules in this category should probably be core or
certified instead)</li>
</ul>
<p>For information on what the support level values entail, please see
<a class="reference external" href="http://docs.ansible.com/ansible/modules_support.html">Modules Support</a>.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">status:</th><td class="field-body"><p class="first">This field records information about the module that is
important to the end user. It’s a list of strings. The default value
is a single element list [“preview”]. The following strings are valid
statuses and have the following meanings:</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">stableinterface:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body">This means that the module’s parameters are
stable. Every effort will be made not to remove parameters or change
their meaning. It is not a rating of the module’s code quality.</td>
</tr>
<tr class="field-even field"><th class="field-name">preview:</th><td class="field-body">This module is a tech preview. This means it may be
unstable, the parameters may change, or it may require libraries or
web services that are themselves subject to incompatible changes.</td>
</tr>
<tr class="field-odd field"><th class="field-name">deprecated:</th><td class="field-body">This module is deprecated and will no longer be
available in a future release.</td>
</tr>
<tr class="field-even field"><th class="field-name">removed:</th><td class="field-body">This module is not present in the release. A stub is
kept so that documentation can be built. The documentation helps
users port from the removed module to new modules.</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="changes-from-version-1-0">
<h7><a class="toc-backref" href="#id7">Changes from Version 1.0</a><a class="headerlink" href="#changes-from-version-1-0" title="Permalink to this headline">¶</a></h7>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">metadata_version:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body"><p class="first">Version updated from 1.0 to 1.1</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">supported_by:</th><td class="field-body"><p class="first">All substantive changes were to potential values of the supported_by field</p>
<ul class="last simple">
<li>Added the certified value</li>
<li>Deprecated the curated value, modules shipped with Ansible will use
certified instead.  Third party modules are encouraged not to use this as
it is meaningless within Ansible proper.</li>
<li>Added the network value</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="documentation-block">
<h6><a class="toc-backref" href="#id8">DOCUMENTATION Block</a><a class="headerlink" href="#documentation-block" title="Permalink to this headline">¶</a></h6>
<p>See an example documentation string in the checkout under <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/examples/DOCUMENTATION.yml">examples/DOCUMENTATION.yml</a>.</p>
<p>Include it in your module file like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># Copyright (c) 2017 [REPLACE THIS]</span>
<span class="c1"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span>

<span class="n">DOCUMENTATION</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">---</span>
<span class="s1">module: modulename</span>
<span class="s1">short_description: This is a sentence describing the module</span>
<span class="s1"># ... snip ...</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
<p>The following fields can be used and are all required unless specified otherwise:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">module:</th><td class="field-body"><p class="first">The name of the module. This must be the same as the filename, without the <code class="docutils literal"><span class="pre">.py</span></code> extension.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">short_description:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><ul class="first simple">
<li>A short description which is displayed on the <span class="xref doc">../list_of_all_modules</span> page and <code class="docutils literal"><span class="pre">ansible-doc</span> <span class="pre">-l</span></code>.</li>
<li>As the short description is displayed by <code class="docutils literal"><span class="pre">ansible-doc</span> <span class="pre">-l</span></code> without the category grouping it needs enough detail to explain its purpose without the context of the directory structure in which it lives.</li>
<li>Unlike <code class="docutils literal"><span class="pre">description:</span></code> this field should not have a trailing full stop.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">description:</th><td class="field-body"><ul class="first simple">
<li>A detailed description (generally two or more sentences).</li>
<li>Must be written in full sentences, i.e. with capital letters and fullstops.</li>
<li>Shouldn&#8217;t mention the name module.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">version_added:</th><td class="field-body"><p class="first">The version of Ansible when the module was added.
This is a <cite>string</cite>, and not a float, i.e. <code class="docutils literal"><span class="pre">version_added:</span> <span class="pre">&quot;2.1&quot;</span></code></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">author:</th><td class="field-body"><p class="first">Name of the module author in the form <code class="docutils literal"><span class="pre">First</span> <span class="pre">Last</span> <span class="pre">(&#64;GitHubID)</span></code>. Use a multi-line list if there is more than one author.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">deprecated:</th><td class="field-body"><p class="first">If this module is deprecated, detail when that happened, and what to use instead, e.g.
<cite>Deprecated in 2.3. Use M(whatmoduletouseinstead) instead.</cite>
Ensure <cite>CHANGELOG.md</cite> is updated to reflect this.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">options:</th><td class="field-body"><p class="first">One per module argument:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">option-name:</th><td class="field-body"><ul class="first simple">
<li>Declarative operation (not CRUD)–this makes it easy for a user not to care what the existing state is, just about the final state, for example <cite>online:</cite>, rather than <cite>is_online:</cite>.</li>
<li>The name of the option should be consistent with the rest of the module, as well as other modules in the same category.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">description:</th><td class="field-body"><ul class="first simple">
<li>Detailed explanation of what this option does. It should be written in full sentences.</li>
<li>Should not list the options values (that&#8217;s what <code class="docutils literal"><span class="pre">choices:</span></code> is for, though it should explain <cite>what</cite> the values do if they aren&#8217;t obvious.</li>
<li>If an optional parameter is sometimes required this need to be reflected in the documentation, e.g. &#8220;Required when I(state=present).&#8221;</li>
<li>Mutually exclusive options must be documented as the final sentence on each of the options.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">required:</th><td class="field-body"><p class="first">Only needed if true, otherwise it is assumed to be false.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">default:</th><td class="field-body"><ul class="first simple">
<li>If <cite>required</cite> is false/missing, <cite>default</cite> may be specified (assumed &#8216;null&#8217; if missing).</li>
<li>Ensure that the default parameter in the docs matches the default parameter in the code.</li>
<li>The default option must not be listed as part of the description.</li>
<li>If the option is a boolean value, you can use any of the boolean values recognized by Ansible:
(such as true/false or yes/no).  Choose the one that reads better in the context of the option.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">choices:</th><td class="field-body"><p class="first">List of option values. Should be absent if empty.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">type:</th><td class="field-body"><p class="first">If an argument is <code class="docutils literal"><span class="pre">type='bool'</span></code>, this field should be set to <code class="docutils literal"><span class="pre">type:</span> <span class="pre">bool</span></code> and no <code class="docutils literal"><span class="pre">choices</span></code> should be specified.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">aliases:</th><td class="field-body"><p class="first">List of option name aliases; generally not needed.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">version_added:</th><td class="field-body"><p class="first">Only needed if this option was extended after initial Ansible release, i.e. this is greater than the top level <cite>version_added</cite> field.
This is a string, and not a float, i.e. <code class="docutils literal"><span class="pre">version_added:</span> <span class="pre">&quot;2.3&quot;</span></code>.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">suboptions:</th><td class="field-body"><p class="first last">If this option takes a dict, you can define it here. See <cite>azure_rm_securitygroup</cite>, <cite>os_ironic_node</cite> for examples.</p>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
<tr class="field-even field"><th class="field-name">requirements:</th><td class="field-body"><p class="first">List of requirements, and minimum versions (if applicable)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">notes:</th><td class="field-body"><p class="first last">Details of any important information that doesn&#8217;t fit in one of the above sections; for example if <code class="docutils literal"><span class="pre">check_mode</span></code> isn&#8217;t supported, or a link to external documentation.</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>The above fields are are all in lowercase.</li>
<li>If the module doesn&#8217;t doesn&#8217;t have any options (for example, it&#8217;s a <code class="docutils literal"><span class="pre">_facts</span></code> module), you can use <code class="docutils literal"><span class="pre">options:</span> <span class="pre">{}</span></code>.</li>
</ul>
</div>
</div>
<div class="section" id="examples-block">
<h6><a class="toc-backref" href="#id9">EXAMPLES block</a><a class="headerlink" href="#examples-block" title="Permalink to this headline">¶</a></h6>
<p>The EXAMPLES section is required for all new modules.</p>
<p>Examples should demonstrate real world usage, and be written in multi-line plain-text YAML format.</p>
<p>Ensure that examples are kept in sync with the options during the PR review and any following code refactor.</p>
<p>As per playbook best practice, a <cite>name:</cite> should be specified.</p>
<p><code class="docutils literal"><span class="pre">EXAMPLES</span></code> string within the module like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">EXAMPLES</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">- name: Ensure foo is installed</span>
<span class="s1">  modulename:</span>
<span class="s1">    name: foo</span>
<span class="s1">    state: present</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
<p>If the module returns facts that are often needed, an example of how to use them can be helpful.</p>
</div>
<div class="section" id="return-block">
<h6><a class="toc-backref" href="#id10">RETURN Block</a><a class="headerlink" href="#return-block" title="Permalink to this headline">¶</a></h6>
<p>The RETURN section documents what the module returns, and is required for all new modules.</p>
<p>For each value returned, provide a <code class="docutils literal"><span class="pre">description</span></code>, in what circumstances the value is <code class="docutils literal"><span class="pre">returned</span></code>,
the <code class="docutils literal"><span class="pre">type</span></code> of the value and a <code class="docutils literal"><span class="pre">sample</span></code>.  For example, from the <code class="docutils literal"><span class="pre">copy</span></code> module:</p>
<p>The following fields can be used and are all required unless specified otherwise.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">return name:</th><td class="field-body"><p class="first">Name of the returned field.</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">description:</th><td class="field-body"><p class="first">Detailed description of what this value represents.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">returned:</th><td class="field-body"><p class="first">When this value is returned, such as <cite>always</cite>, on <cite>success</cite>, <cite>always</cite></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">type:</th><td class="field-body"><p class="first">Data type</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">sample:</th><td class="field-body"><p class="first">One or more examples.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">version_added:</th><td class="field-body"><p class="first">Only needed if this return was extended after initial Ansible release, i.e. this is greater than the top level <cite>version_added</cite> field.
This is a string, and not a float, i.e. <code class="docutils literal"><span class="pre">version_added:</span> <span class="pre">&quot;2.3&quot;</span></code>.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">contains:</th><td class="field-body"><p class="first">Optional, if you set <cite>type: complex</cite> you can detail the dictionary here by repeating the above elements.</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">return name:</th><td class="field-body"><p class="first">One per return</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">description:</th><td class="field-body">Detailed description of what this value represents.</td>
</tr>
<tr class="field-even field"><th class="field-name">returned:</th><td class="field-body">When this value is returned, such as <cite>always</cite>, on <cite>success</cite>, <cite>always</cite></td>
</tr>
<tr class="field-odd field"><th class="field-name">type:</th><td class="field-body">Data type</td>
</tr>
<tr class="field-even field"><th class="field-name">sample:</th><td class="field-body">One or more examples.</td>
</tr>
<tr class="field-odd field"><th class="field-name">version_added:</th><td class="field-body">Only needed if this return was extended after initial Ansible release, i.e. this is greater than the top level <cite>version_added</cite> field.
This is a string, and not a float, i.e. <code class="docutils literal"><span class="pre">version_added:</span> <span class="pre">&quot;2.3&quot;</span></code>.</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<p>For complex nested returns type can be specified as <code class="docutils literal"><span class="pre">type:</span> <span class="pre">complex</span></code>.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>RETURN = &#39;&#39;&#39;
dest:
    description: destination file/path
    returned: success
    type: string
    sample: /path/to/file.txt
src:
    description: source file used for the copy on the target machine
    returned: changed
    type: string
    sample: /home/httpd/.ansible/tmp/ansible-tmp-1423796390.97-147729857856000/source
md5sum:
    description: md5 checksum of the file after running copy
    returned: when supported
    type: string
    sample: 2a5aeecc61dc98c4d780b14b330e3282
...
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If your module doesn&#8217;t return anything (apart from the standard returns), you can use <code class="docutils literal"><span class="pre">RETURN</span> <span class="pre">=</span> <span class="pre">'''</span> <span class="pre">#</span> <span class="pre">'''</span></code>.</p>
</div>
</div>
<div class="section" id="python-imports">
<h6><a class="toc-backref" href="#id11">Python Imports</a><a class="headerlink" href="#python-imports" title="Permalink to this headline">¶</a></h6>
<p>Starting with Ansible version 2.2, all new modules are required to use imports in the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">module_utils.basic</span> <span class="kn">import</span> <span class="n">AnsibleModule</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The use of &#8220;wildcard&#8221; imports such as <code class="docutils literal"><span class="pre">from</span> <span class="pre">module_utils.basic</span> <span class="pre">import</span> <span class="pre">*</span></code> is no longer allowed.</p>
</div>
</div>
<div class="section" id="formatting-options">
<h6><a class="toc-backref" href="#id12">Formatting options</a><a class="headerlink" href="#formatting-options" title="Permalink to this headline">¶</a></h6>
<p>These formatting functions are <code class="docutils literal"><span class="pre">U()</span></code> for URLs, <code class="docutils literal"><span class="pre">I()</span></code> for option names, <code class="docutils literal"><span class="pre">C()</span></code> for files and option values and <code class="docutils literal"><span class="pre">M()</span></code> for module names.
Module names should be specified as <code class="docutils literal"><span class="pre">M(module)</span></code> to create a link to the online documentation for that module.</p>
<p>Example usage:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Or <span class="k">if</span> not <span class="nb">set</span> the environment variable C<span class="o">(</span>ACME_PASSWORD<span class="o">)</span> will be used.
...
Required <span class="k">if</span> I<span class="o">(</span><span class="nv">state</span><span class="o">=</span>present<span class="o">)</span>
...
Mutually exclusive with I<span class="o">(</span>project_src<span class="o">)</span> and I<span class="o">(</span>files<span class="o">)</span>.
...
See also M<span class="o">(</span>win_copy<span class="o">)</span> or M<span class="o">(</span>win_template<span class="o">)</span>.
...
See U<span class="o">(</span>https://www.ansible.com/tower<span class="o">)</span> <span class="k">for</span> an overview.
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you wish to refer a collection of modules, use <code class="docutils literal"><span class="pre">C(..)</span></code>, e.g. <code class="docutils literal"><span class="pre">Refer</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">C(win_*)</span> <span class="pre">modules.</span></code></p>
</div>
</div>
<div class="section" id="documentation-fragments">
<h6><a class="toc-backref" href="#id13">Documentation fragments</a><a class="headerlink" href="#documentation-fragments" title="Permalink to this headline">¶</a></h6>
<p>Some categories of modules share common documentation, such as details on how to authenticate options, or file mode settings. Rather than duplicate that information it can be shared using <code class="docutils literal"><span class="pre">docs_fragments</span></code>.</p>
<p>These shared fragments are similar to the standard documentation block used in a module, they are just contained in a <code class="docutils literal"><span class="pre">ModuleDocFragment</span></code> class.</p>
<p>All the existing <code class="docutils literal"><span class="pre">docs_fragments</span></code> can be found in <code class="docutils literal"><span class="pre">lib/ansible/utils/module_docs_fragments/</span></code>.</p>
<p>To include, simply add in <code class="docutils literal"><span class="pre">extends_documentation_fragment:</span> <span class="pre">FRAGMENT_NAME</span></code> into your module.</p>
<p>Examples can be found by searching for <code class="docutils literal"><span class="pre">extends_documentation_fragment</span></code> under the Ansible source tree.</p>
</div>
<div class="section" id="testing-documentation">
<h6><a class="toc-backref" href="#id14">Testing documentation</a><a class="headerlink" href="#testing-documentation" title="Permalink to this headline">¶</a></h6>
<p>Put your completed module file into the <code class="docutils literal"><span class="pre">lib/ansible/modules/$CATEGORY/</span></code> directory and then
run the command: <code class="docutils literal"><span class="pre">make</span> <span class="pre">webdocs</span></code>. The new &#8216;modules.html&#8217; file will be
built in the <code class="docutils literal"><span class="pre">docs/docsite/_build/html/$MODULENAME_module.html</span></code> directory.</p>
<p>In order to speed up the build process, you can limit the documentation build to
only include modules you specify, or no modules at all. To do this, run the command:
<code class="docutils literal"><span class="pre">MODULES=$MODULENAME</span> <span class="pre">make</span> <span class="pre">webdocs</span></code>. The <code class="docutils literal"><span class="pre">MODULES</span></code> environment variable
accepts a comma-separated list of module names. To skip building
documentation for all modules, specify a non-existent module name, for example:
<code class="docutils literal"><span class="pre">MODULES=none</span> <span class="pre">make</span> <span class="pre">webdocs</span></code>.</p>
<p>You may also build a single page of the entire docsite. From <code class="docutils literal"><span class="pre">ansible/docs/docsite</span></code> run <code class="docutils literal"><span class="pre">make</span> <span class="pre">htmlsingle</span> <span class="pre">rst=[relative</span> <span class="pre">path</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">.rst</span> <span class="pre">file]</span></code>, for example: <code class="docutils literal"><span class="pre">make</span> <span class="pre">htmlsingle</span> <span class="pre">rst=dev_guide/developing_modules_documenting.rst</span></code></p>
<p>To test your documentation against your <code class="docutils literal"><span class="pre">argument_spec</span></code> you can use <code class="docutils literal"><span class="pre">validate-modules</span></code>. Note that this option isn&#8217;t currently enabled in Shippable due to the time it takes to run.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># If you don&#39;t already, ensure you are using your local checkout</span>
<span class="nb">source</span> hacking/env-setup
./test/sanity/validate-modules/validate-modules --arg-spec --warnings  lib/ansible/modules/your/modules/
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you&#8217;re having a problem with the syntax of your YAML you can
validate it on the <a class="reference external" href="http://www.yamllint.com/">YAML Lint</a> website.</p>
</div>
<p>For more information in testing, including how to add unit and integration tests, see <a class="reference internal" href="index.html#document-dev_guide/testing"><span class="doc">Testing Ansible</span></a>.</p>
</div>
</div>
<span id="document-dev_guide/developing_modules_best_practices"></span><div class="section" id="conventions-best-practices-and-pitfalls">
<span id="module-dev-conventions"></span><h5>Conventions, Best Practices, and Pitfalls<a class="headerlink" href="#conventions-best-practices-and-pitfalls" title="Permalink to this headline">¶</a></h5>
<p>As a reminder from the example code above, here are some basic conventions
and guidelines:</p>
<ul class="simple">
<li>If the module is addressing an object, the parameter for that object should be called &#8216;name&#8217; whenever possible, or accept &#8216;name&#8217; as an alias.</li>
<li>If you have a company module that returns facts specific to your installations, a good name for this module is <cite>site_facts</cite>.</li>
<li>Modules accepting boolean status should generally accept &#8216;yes&#8217;, &#8216;no&#8217;, &#8216;true&#8217;, &#8216;false&#8217;, or anything else a user may likely throw at them.  The AnsibleModule common code supports this with &#8220;type=&#8217;bool&#8217;&#8221;.</li>
<li>Include a minimum of dependencies if possible.  If there are dependencies, document them at the top of the module file, and have the module raise JSON error messages when the import fails.</li>
<li>Modules must be self-contained in one file to be auto-transferred by ansible.</li>
<li>If packaging modules in an RPM, they only need to be installed on the control machine and should be dropped into /usr/share/ansible.  This is entirely optional and up to you.</li>
<li>Modules must output valid JSON only. The top level return type must be a hash (dictionary) although they can be nested.  Lists or simple scalar values are not supported, though they can be trivially contained inside a dictionary.</li>
<li>In the event of failure, a key of &#8216;failed&#8217; should be included, along with a string explanation in &#8216;msg&#8217;.  Modules that raise tracebacks (stacktraces) are generally considered &#8216;poor&#8217; modules, though Ansible can deal with these returns and will automatically convert anything unparseable into a failed result.  If you are using the AnsibleModule common Python code, the &#8216;failed&#8217; element will be included for you automatically when you call &#8216;fail_json&#8217;.</li>
<li>Return codes from modules are actually not significant, but continue on with 0=success and non-zero=failure for reasons of future proofing.</li>
<li>As results from many hosts will be aggregated at once, modules should return only relevant output.  Returning the entire contents of a log file is generally bad form.</li>
</ul>
</div>
<div class="section" id="debugging-ansiblemodule-based-modules">
<span id="id1"></span><h5>Debugging AnsibleModule-based modules<a class="headerlink" href="#debugging-ansiblemodule-based-modules" title="Permalink to this headline">¶</a></h5>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you&#8217;re using the <code class="file docutils literal"><span class="pre">hacking/test-module</span></code> script then most of this
is taken care of for you.  If you need to do some debugging of the module
on the remote machine that the module will actually run on or when the
module is used in a playbook then you may need to use this information
instead of relying on test-module.</p>
</div>
<p>Starting with Ansible-2.1.0, AnsibleModule-based modules are put together as
a zip file consisting of the module file and the various python module
boilerplate inside of a wrapper script instead of as a single file with all of
the code concatenated together.  Without some help, this can be harder to
debug as the file needs to be extracted from the wrapper in order to see
what&#8217;s actually going on in the module.  Luckily the wrapper script provides
some helper methods to do just that.</p>
<p>If you are using Ansible with the <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_KEEP_REMOTE_FILES</span></code>
environment variables to keep the remote module file, here&#8217;s a sample of how
your debugging session will start:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nv">ANSIBLE_KEEP_REMOTE_FILES</span><span class="o">=</span><span class="m">1</span> ansible localhost -m ping -a <span class="s1">&#39;data=debugging_session&#39;</span> -vvv
<span class="go">&lt;127.0.0.1&gt; ESTABLISH LOCAL CONNECTION FOR USER: badger</span>
<span class="go">&lt;127.0.0.1&gt; EXEC /bin/sh -c &#39;( umask 77 &amp;&amp; mkdir -p &quot;` echo $HOME/.ansible/tmp/ansible-tmp-1461434734.35-235318071810595 `&quot; &amp;&amp; echo &quot;` echo $HOME/.ansible/tmp/ansible-tmp-1461434734.35-235318071810595 `&quot; )&#39;</span>
<span class="go">&lt;127.0.0.1&gt; PUT /var/tmp/tmpjdbJ1w TO /home/badger/.ansible/tmp/ansible-tmp-1461434734.35-235318071810595/ping</span>
<span class="go">&lt;127.0.0.1&gt; EXEC /bin/sh -c &#39;LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 LC_MESSAGES=en_US.UTF-8 /usr/bin/python /home/badger/.ansible/tmp/ansible-tmp-1461434734.35-235318071810595/ping&#39;</span>
<span class="go">localhost | SUCCESS =&gt; {</span>
<span class="go">    &quot;changed&quot;: false,</span>
<span class="go">    &quot;invocation&quot;: {</span>
<span class="go">        &quot;module_args&quot;: {</span>
<span class="go">            &quot;data&quot;: &quot;debugging_session&quot;</span>
<span class="go">        },</span>
<span class="go">        &quot;module_name&quot;: &quot;ping&quot;</span>
<span class="go">    },</span>
<span class="go">    &quot;ping&quot;: &quot;debugging_session&quot;</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Setting <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_KEEP_REMOTE_FILES</span></code> to <code class="docutils literal"><span class="pre">1</span></code> tells Ansible to keep the
remote module files instead of deleting them after the module finishes
executing.  Giving Ansible the <code class="docutils literal"><span class="pre">-vvv</span></code> option makes Ansible more verbose.
That way it prints the file name of the temporary module file for you to see.</p>
<p>If you want to examine the wrapper file you can.  It will show a small python
script with a large, base64 encoded string.  The string contains the module
that is going to be executed.  Run the wrapper&#8217;s explode command to turn the
string into some python files that you can work with:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">$</span> python /home/badger/.ansible/tmp/ansible-tmp-1461434734.35-235318071810595/ping explode
<span class="go">Module expanded into:</span>
<span class="go">/home/badger/.ansible/tmp/ansible-tmp-1461434734.35-235318071810595/debug_dir</span>
</pre></div>
</div>
<p>When you look into the debug_dir you&#8217;ll see a directory structure like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>├── ansible_module_ping.py
├── args
└── ansible
    ├── __init__.py
    └── module_utils
        ├── basic.py
        └── __init__.py
</pre></div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">ansible_module_ping.py</span></code> is the code for the module itself.  The name
is based on the name of the module with a prefix so that we don&#8217;t clash with
any other python module names.  You can modify this code to see what effect
it would have on your module.</li>
<li>The <code class="file docutils literal"><span class="pre">args</span></code> file contains a JSON string.  The string is a dictionary
containing the module arguments and other variables that Ansible passes into
the module to change its behaviour.  If you want to modify the parameters
that are passed to the module, this is the file to do it in.</li>
<li>The <code class="file docutils literal"><span class="pre">ansible</span></code> directory contains code from
<code class="xref py py-mod docutils literal"><span class="pre">ansible.module_utils</span></code> that is used by the module.  Ansible includes
files for any :<cite>module:`ansible.module_utils</cite> imports in the module but not
any files from any other module.  So if your module uses
<code class="xref py py-mod docutils literal"><span class="pre">ansible.module_utils.url</span></code> Ansible will include it for you, but if
your module includes <code class="xref py py-mod docutils literal"><span class="pre">requests</span></code> then you&#8217;ll have to make sure that
the python requests library is installed on the system before running the
module.  You can modify files in this directory if you suspect that the
module is having a problem in some of this boilerplate code rather than in
the module code you have written.</li>
</ul>
<p>Once you edit the code or arguments in the exploded tree you need some way to
run it.  There&#8217;s a separate wrapper subcommand for this:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">$</span> python /home/badger/.ansible/tmp/ansible-tmp-1461434734.35-235318071810595/ping execute
<span class="go">{&quot;invocation&quot;: {&quot;module_args&quot;: {&quot;data&quot;: &quot;debugging_session&quot;}}, &quot;changed&quot;: false, &quot;ping&quot;: &quot;debugging_session&quot;}</span>
</pre></div>
</div>
<p>This subcommand takes care of setting the PYTHONPATH to use the exploded
<code class="file docutils literal"><span class="pre">debug_dir/ansible/module_utils</span></code> directory and invoking the script using
the arguments in the <code class="file docutils literal"><span class="pre">args</span></code> file.  You can continue to run it like this
until you understand the problem.  Then you can copy it back into your real
module file and test that the real module works via <strong class="command">ansible</strong> or
<strong class="command">ansible-playbook</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The wrapper provides one more subcommand, <code class="docutils literal"><span class="pre">excommunicate</span></code>.  This
subcommand is very similar to <code class="docutils literal"><span class="pre">execute</span></code> in that it invokes the exploded
module on the arguments in the <code class="file docutils literal"><span class="pre">args</span></code>.  The way it does this is
different, however.  <code class="docutils literal"><span class="pre">excommunicate</span></code> imports the <code class="xref py py-func docutils literal"><span class="pre">main()</span></code>
function from the module and then calls that.  This makes excommunicate
execute the module in the wrapper&#8217;s process.  This may be useful for
running the module under some graphical debuggers but it is very different
from the way the module is executed by Ansible itself.  Some modules may
not work with <code class="docutils literal"><span class="pre">excommunicate</span></code> or may behave differently than when used
with Ansible normally.  Those are not bugs in the module; they&#8217;re
limitations of <code class="docutils literal"><span class="pre">excommunicate</span></code>.  Use at your own risk.</p>
</div>
</div>
<div class="section" id="module-paths">
<h5>Module Paths<a class="headerlink" href="#module-paths" title="Permalink to this headline">¶</a></h5>
<p>If you are having trouble getting your module &#8220;found&#8221; by ansible, be
sure it is in the <span class="target" id="index-2"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_LIBRARY</span></code> environment variable.</p>
<p>If you have a fork of one of the ansible module projects, do something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ANSIBLE_LIBRARY</span><span class="o">=</span>~/ansible-modules-core
</pre></div>
</div>
<p>And this will make the items in your fork be loaded ahead of what ships with Ansible.  Just be sure
to make sure you&#8217;re not reporting bugs on versions from your fork!</p>
<p>To be safe, if you&#8217;re working on a variant on something in Ansible&#8217;s normal distribution, it&#8217;s not
a bad idea to give it a new name while you are working on it, to be sure you know you&#8217;re pulling
your version.</p>
</div>
<div class="section" id="common-pitfalls">
<h5>Common Pitfalls<a class="headerlink" href="#common-pitfalls" title="Permalink to this headline">¶</a></h5>
<p>You should never do this in a module:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;some status message&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Because the output is supposed to be valid JSON.</p>
<p>Modules must not output anything on standard error, because the system will merge
standard out with standard error and prevent the JSON from parsing. Capturing standard
error and returning it as a variable in the JSON on standard out is fine, and is, in fact,
how the command module is implemented.</p>
<p>If a module returns stderr or otherwise fails to produce valid JSON, the actual output
will still be shown in Ansible, but the command will not succeed.</p>
<p>Don&#8217;t write to files directly; use a temporary file and then use the <cite>atomic_move</cite> function from <cite>ansible.module_utils.basic</cite> to move the updated temporary file into place. This prevents data corruption and ensures that the correct context for the file is kept.</p>
<p>Avoid creating a module that does the work of other modules; this leads to code duplication and divergence, and makes things less uniform, unpredictable and harder to maintain. Modules should be the building blocks. Instead of creating a module that does the work of other modules, use Plays and Roles instead.</p>
<p>Avoid creating &#8216;caches&#8217;. Ansible is designed without a central server or authority, so you cannot guarantee it will not run with different permissions, options or locations. If you need a central authority, have it on top of Ansible (for example, using bastion/cm/ci server or tower); do not try to build it into modules.</p>
<p>Always use the hacking/test-module script when developing modules and it will warn
you about these kind of things.</p>
</div>
<span id="document-dev_guide/developing_modules_checklist"></span><div class="section" id="contributing-your-module-to-ansible">
<span id="module-contribution"></span><h5>Contributing Your Module to Ansible<a class="headerlink" href="#contributing-your-module-to-ansible" title="Permalink to this headline">¶</a></h5>
<p>High-quality modules with minimal dependencies
can be included in Ansible, but modules (just due to the programming
preferences of the developers) will need to be implemented in Python and use
the AnsibleModule common code, and should generally use consistent arguments with the rest of
the program.   Stop by the mailing list to inquire about requirements if you like, and submit
a github pull request to the <a class="reference external" href="https://github.com/ansible/ansible">ansible</a> project.
Included modules will ship with ansible, and also have a chance to be promoted to &#8216;core&#8217; status, which
gives them slightly higher development priority (though they&#8217;ll work in exactly the same way).</p>
<div class="section" id="contributing-modules-checklist">
<h6>Contributing Modules Checklist<a class="headerlink" href="#contributing-modules-checklist" title="Permalink to this headline">¶</a></h6>
<p>The following  checklist items are important guidelines for people who want to contribute to the development of modules to Ansible on GitHub. Please read the guidelines before you submit your PR/proposal.</p>
<ul class="simple">
<li>The shebang must always be <code class="docutils literal"><span class="pre">#!/usr/bin/python</span></code>.  This allows <code class="docutils literal"><span class="pre">ansible_python_interpreter</span></code> to work</li>
<li>Modules must be written to support Python 2.6. If this is not possible, required minimum Python version and rationale should be explained in the requirements section in <code class="docutils literal"><span class="pre">DOCUMENTATION</span></code>.  In Ansible-2.3 the minimum requirement for modules was Python-2.4.</li>
<li>Modules must be written to use proper Python-3 syntax.  At some point in the future we&#8217;ll come up with rules for running on Python-3 but we&#8217;re not there yet.  See <a class="reference internal" href="index.html#document-dev_guide/developing_python3"><span class="doc">Ansible and Python 3</span></a> for help on how to do this.</li>
<li>Modules must have a metadata section.  For the vast majority of new modules,
the metadata should look exactly like this:</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ANSIBLE_METADATA</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;preview&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;supported_by&#39;</span><span class="p">:</span> <span class="s1">&#39;community&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;metadata_version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.1&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>The complete module metadata specification is here: <a class="reference external" href="https://docs.ansible.com/ansible/dev_guide/developing_modules_documenting.html#ansible-metadata-block">Ansible metadata block</a></p>
<ul>
<li><dl class="first docutils">
<dt>Documentation: Make sure it exists</dt>
<dd><ul class="first last simple">
<li>Module documentation should briefly and accurately define what each module and option does, and how it works with others in the underlying system. Documentation should be written for broad audience&#8211;readable both by experts and non-experts. This documentation is not meant to teach a total novice, but it also should not be reserved for the Illuminati (hard balance).</li>
<li>Descriptions should always start with a capital letter and end with a full stop. Consistency always helps.</li>
<li>The <cite>required</cite> setting is only required when true, otherwise it is assumed to be false.</li>
<li>If <cite>required</cite> is false/missing, <cite>default</cite> may be specified (assumed &#8216;null&#8217; if missing). Ensure that the default parameter in docs matches default parameter in code.</li>
<li>Documenting <cite>default</cite> is not needed for <cite>required: true</cite>.</li>
<li>Remove unnecessary doc like <cite>aliases: []</cite> or <cite>choices: []</cite>.</li>
<li>Do not use Boolean values in a choice list . For example, in the list <cite>choices: [&#8216;no&#8217;, &#8216;verify&#8217;, &#8216;always]</cite>, &#8216;no&#8217; will be interpreted as a Boolean value (you can check basic.py for BOOLEANS_* constants to see the full list of Boolean keywords). If your option actually is a boolean, just use <cite>type=bool</cite>; there is no need to populate &#8216;choices&#8217;.</li>
<li>For new modules or options in a module add version_added. The version should match the value of the current development version and is a string (not a float), so be sure to enclose it in quotes.</li>
<li>Verify that arguments in doc and module spec dict are identical.</li>
<li>For password / secret arguments no_log=True should be set.</li>
<li>Requirements should be documented, using the <cite>requirements=[]</cite> field.</li>
<li>Author should be set, with their name and their github id, at the least.</li>
<li>Ensure that you make use of <cite>U()</cite> for URLs, <cite>I()</cite> for option names, <cite>C()</cite> for files and option values, <cite>M()</cite> for module names.</li>
<li>If an optional parameter is sometimes required this need to be reflected in the documentation, e.g. &#8220;Required when C(state=present).&#8221;</li>
<li>Verify that a GPL 3 License header is included.</li>
<li>Does module use check_mode? Could it be modified to use it? Document it. Documentation is everyone&#8217;s friend.</li>
<li>Examples&#8211;include them whenever possible and make sure they are reproducible.</li>
<li>Document the return structure of the module. Refer to <a class="reference internal" href="index.html#common-return-values"><span class="std std-ref">Common</span></a> and <a class="reference internal" href="index.html#module-documenting"><span class="std std-ref">Documenting Your Module</span></a> for additional information.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Predictable user interface: This is a particularly important section as it is also an area where we need significant improvements.</dt>
<dd><ul class="first last simple">
<li>Name consistency across modules (we’ve gotten better at this, but we still have many deviations).</li>
<li>Declarative operation (not CRUD)&#8211;this makes it easy for a user not to care what the existing state is, just about the final state. <code class="docutils literal"><span class="pre">started/stopped</span></code>, <code class="docutils literal"><span class="pre">present/absent</span></code>&#8211;don&#8217;t overload options too much. It is preferable to add a new, simple option than to add choices/states that don&#8217;t fit with existing ones.</li>
<li>Keep options small, having them take large data structures might save us a few tasks, but adds a complex requirement that we cannot easily validate before passing on to the module.</li>
<li>Allow an &#8220;expert mode&#8221;. This may sound like the absolute opposite of the previous one, but it is always best to let expert users deal with complex data. This requires different modules in some cases, so that you end up having one (1) expert module and several &#8216;piecemeal&#8217; ones (ec2_vpc_net?). The reason for this is not, as many users express, because it allows a single task and keeps plays small (which just moves the data complexity into vars files, leaving you with a slightly different structure in another YAML file). It does, however, allow for a more &#8216;atomic&#8217; operation against the underlying APIs and services.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Informative responses: Please note, that for  &gt;= 2.0, it is required that return data to be documented.</dt>
<dd><ul class="first last simple">
<li>Always return useful data, even when there is no change.</li>
<li>Be consistent about returns (some modules are too random), unless it is detrimental to the state/action.</li>
<li>Make returns reusable&#8211;most of the time you don&#8217;t want to read it, but you do want to process it and re-purpose it.</li>
<li>Return diff if in diff mode. This is not required for all modules, as it won&#8217;t make sense for certain ones, but please attempt to include this when applicable).</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Code: This applies to all code in general, but often seems to be missing from modules, so please keep the following in mind as you work.</dt>
<dd><ul class="first last simple">
<li>Validate upfront&#8211;fail fast and return useful and clear error messages.</li>
<li>Defensive programming&#8211;modules should be designed simply enough that this should be easy. Modules should always handle errors gracefully and avoid direct stacktraces. Ansible deals with this better in 2.0 and returns them in the results.</li>
<li>Fail predictably&#8211;if we must fail, do it in a way that is the most expected. Either mimic the underlying tool or the general way the system works.</li>
<li>Modules should not do the job of other modules, that is what roles are for. Less magic is more.</li>
<li>Don&#8217;t reinvent the wheel. Part of the problem is that code sharing is not that easy nor documented, we also need to expand our base functions to provide common patterns (retry, throttling, etc).</li>
<li>Support check mode. This is not required for all modules, as it won&#8217;t make sense for certain ones, but please attempt to include this when applicable). For more information, refer to <a class="reference internal" href="index.html#check-mode-drift"><span class="std std-ref">Check Mode As A Drift Test</span></a> and <a class="reference internal" href="index.html#check-mode-dry"><span class="std std-ref">Check Mode (&#8220;Dry Run&#8221;)</span></a>.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Exceptions: The module must handle them. (exceptions are bugs)</dt>
<dd><ul class="first last simple">
<li>Give out useful messages on what you were doing and you can add the exception message to that.</li>
<li>Avoid catchall exceptions, they are not very useful unless the underlying API gives very good error messages pertaining the attempted action.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Module-dependent guidelines: Additional module guidelines may exist for certain families of modules.</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>Be sure to check out the modules themselves for additional information.</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/modules/cloud/amazon/GUIDELINES.md">Amazon</a></li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Modules should make use of the &#8220;extends_documentation_fragment&#8221; to ensure documentation available. For example, the AWS module should include:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>extends_documentation_fragment:
    - aws
    - ec2
</pre></div>
</div>
</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">The module must not use sys.exit() &#8211;&gt; use fail_json() from the module object.</p>
</li>
<li><p class="first">Import custom packages in try/except and handled with fail_json() in main() e.g.</p>
</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">foo</span>
    <span class="n">HAS_LIB</span><span class="o">=</span><span class="bp">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">HAS_LIB</span><span class="o">=</span><span class="bp">False</span>
</pre></div>
</div>
<ul class="simple">
<li>The return structure should be consistent, even if NA/None are used for keys normally returned under other options.</li>
<li>Are module actions idempotent? If not document in the descriptions or the notes.</li>
<li>Import <code class="docutils literal"><span class="pre">ansible.module_utils</span></code> code in the same place as you import other libraries.  In older code, this was done at the bottom of the file but that&#8217;s no longer needed.</li>
<li>Do not use wildcards for importing other python modules (ex: <code class="docutils literal"><span class="pre">from</span> <span class="pre">ansible.module_utils.basic</span> <span class="pre">import</span> <span class="pre">*</span></code>).  This used to be required for code imported from <code class="docutils literal"><span class="pre">ansible.module_utils</span></code> but, from Ansible-2.1 onwards, it&#8217;s just an outdated and bad practice.</li>
<li>The module must have a <cite>main</cite> function that wraps the normal execution.</li>
<li>Call your <code class="xref py py-func docutils literal"><span class="pre">main()</span></code> from a conditional so that it would be possible to
import them into unittests in the future example</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li>Try to normalize parameters with other modules, you can have aliases for when user is more familiar with underlying API name for the option</li>
<li>Being <a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP 8</a> compliant is a requirement. See <a class="reference internal" href="index.html#document-dev_guide/testing_pep8"><span class="doc">PEP 8</span></a> for more information.</li>
<li>Avoid &#8216;<cite>action</cite>/<cite>command</cite>&#8216;, they are imperative and not declarative, there are other ways to express the same thing</li>
<li>Do not add <cite>list</cite> or <cite>info</cite> state options to an existing module - create a new <cite>_facts</cite> module.</li>
<li>If you are asking &#8216;how can I have a module execute other modules&#8217; ... you want to write a role</li>
<li>Return values must be able to be serialized as json via the python stdlib
json library.  basic python types (strings, int, dicts, lists, etc) are
serializable.  A common pitfall is to try returning an object via
exit_json().  Instead, convert the fields you need from the object into the
fields of a dictionary and return the dictionary.</li>
<li>When fetching URLs, please use either fetch_url or open_url from ansible.module_utils.urls
rather than urllib2; urllib2 does not natively verify TLS certificates and so is insecure for https.</li>
<li>facts modules must return facts in the ansible_facts field of the result
dictionary. <span class="xref std std-ref">module_provided_facts</span></li>
<li>modules that are purely about fact gathering need to implement check_mode.
they should not cause any changes anyway so it should be as simple as adding
check_mode=True when instantiating AnsibleModule.  (The reason is that
playbooks which conditionalize based on fact information will only
conditionalize correctly in check_mode if the facts are returned in
check_mode).</li>
<li>Basic auth: module_utils.api has some helpers for doing basic auth with
module_utils.urls.fetch_url().  If you use those you may find you also want
to fallback on environment variables for default values.  If you do that,
be sure to use non-generic environment variables (like
<span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">API_&lt;MODULENAME&gt;_USERNAME</span></code>).  Using generic environment variables
like <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">API_USERNAME</span></code> would conflict between modules.</li>
</ul>
<div class="section" id="windows-modules-checklist">
<h7>Windows modules checklist<a class="headerlink" href="#windows-modules-checklist" title="Permalink to this headline">¶</a></h7>
<p>For a checklist and details on how to write Windows modules please see <a class="reference internal" href="index.html#document-dev_guide/developing_modules_general_windows"><span class="doc">Windows Ansible Module Development Walkthrough</span></a></p>
</div>
<div class="section" id="deprecating-and-making-module-aliases">
<h7>Deprecating and making module aliases<a class="headerlink" href="#deprecating-and-making-module-aliases" title="Permalink to this headline">¶</a></h7>
<p>Starting in 1.8, you can deprecate modules by renaming them with a preceding <code class="docutils literal"><span class="pre">_</span></code>, i.e. <code class="docutils literal"><span class="pre">old_cloud.py</span></code> to
<code class="docutils literal"><span class="pre">_old_cloud.py</span></code>. This keeps the module available, but hides it from the primary docs and listing.</p>
<p>When deprecating a module:</p>
<ol class="arabic">
<li><p class="first">Set the <code class="docutils literal"><span class="pre">ANSIBLE_METADATA</span></code> <cite>status</cite> to <cite>deprecated</cite>.</p>
</li>
<li><p class="first">In the <code class="docutils literal"><span class="pre">DOCUMENTATION</span></code> section, add a <cite>deprecated</cite> field along the lines of:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>deprecated: Deprecated in <span class="m">2</span>.3. Use M<span class="o">(</span>whatmoduletouseinstead<span class="o">)</span> instead.
</pre></div>
</div>
</li>
<li><p class="first">Add the deprecation to CHANGELOG.md under the <code class="docutils literal"><span class="pre">###Deprecations:</span></code> section.</p>
</li>
</ol>
<div class="section" id="alias-module-names">
<h8>Alias module names<a class="headerlink" href="#alias-module-names" title="Permalink to this headline">¶</a></h8>
<p>You can also rename modules and keep an alias to the old name by using a symlink that starts with _.
This example allows the stat module to be called with fileinfo, making the following examples equivalent:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">EXAMPLES</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">ln -s stat.py _fileinfo.py</span>
<span class="s1">ansible -m stat -a &quot;path=/tmp&quot; localhost</span>
<span class="s1">ansible -m fileinfo -a &quot;path=/tmp&quot; localhost</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-dev_guide/developing_modules_in_groups"></span><div class="section" id="information-for-submitting-a-group-of-modules">
<h5><a class="toc-backref" href="#id1">Information for submitting a group of modules</a><a class="headerlink" href="#information-for-submitting-a-group-of-modules" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#information-for-submitting-a-group-of-modules" id="id1">Information for submitting a group of modules</a><ul>
<li><a class="reference internal" href="#submitting-a-group-of-modules" id="id2">Submitting a group of modules</a></li>
<li><a class="reference internal" href="#before-you-start-coding" id="id3">Before you start coding</a></li>
<li><a class="reference internal" href="#naming-convention" id="id4">Naming Convention</a></li>
<li><a class="reference internal" href="#speak-to-us" id="id5">Speak to us</a></li>
<li><a class="reference internal" href="#where-to-get-support" id="id6">Where to get support</a></li>
<li><a class="reference internal" href="#your-first-pull-request" id="id7">Your First Pull Request</a></li>
<li><a class="reference internal" href="#subsequent-prs" id="id8">Subsequent PRs</a></li>
<li><a class="reference internal" href="#finally" id="id9">Finally</a></li>
<li><a class="reference internal" href="#new-to-git-or-github" id="id10">New to Git or GitHub</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="submitting-a-group-of-modules">
<h6><a class="toc-backref" href="#id2">Submitting a group of modules</a><a class="headerlink" href="#submitting-a-group-of-modules" title="Permalink to this headline">¶</a></h6>
<p>This section discusses how to get multiple related modules into Ansible.</p>
<p>This document is intended for both companies wishing to add modules for their own products as well as users of 3rd party products wishing to add Ansible functionality.</p>
<p>It&#8217;s based on module development best practices that the Ansible core team and community have accumulated.</p>
</div>
<div class="section" id="before-you-start-coding">
<h6><a class="toc-backref" href="#id3">Before you start coding</a><a class="headerlink" href="#before-you-start-coding" title="Permalink to this headline">¶</a></h6>
<p>Although it&#8217;s tempting to get straight into coding, there are a few things to be aware of first. This list of prerequisites is designed to help ensure that you develop high-quality modules that flow easily through the review process and get into Ansible more quickly.</p>
<ul class="simple">
<li>Read though all the pages linked off <a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a>; paying particular focus to the <a class="reference internal" href="index.html#document-dev_guide/developing_modules_checklist"><span class="doc">Contributing Your Module to Ansible</span></a>.</li>
<li>For new modules going into Ansible 2.4 we are raising the bar so they must be PEP 8 compliant. See <a class="reference internal" href="index.html#document-dev_guide/testing_pep8"><span class="doc">PEP 8</span></a> for more information.</li>
<li>Starting with Ansible version 2.4, all new modules must support Python 2.6 and Python 3.5+. If this is an issue, please contact us (see the &#8220;Speak to us&#8221; section later in this document to learn how).</li>
<li>All modules shipped with Ansible must be done so under the GPLv3 license. Files under the <code class="docutils literal"><span class="pre">lib/ansible/module_utils/</span></code> directory should be done so under the BSD license.</li>
<li>Have a look at the existing modules and how they&#8217;ve been named in the <span class="xref doc">../list_of_all_modules</span>, especially in the same functional area (such as cloud, networking, databases).</li>
<li>Shared code can be placed into <code class="docutils literal"><span class="pre">lib/ansible/module_utils/</span></code></li>
<li>Shared documentation (for example describing common arguments) can be placed in <code class="docutils literal"><span class="pre">lib/ansible/utils/module_docs_fragments/</span></code>.</li>
<li>With great power comes great responsibility: Ansible module maintainers have a duty to help keep modules up to date. As with all successful community projects, module maintainers should keep a watchful eye for reported issues and contributions.</li>
<li>Although not required, unit and/or integration tests are strongly recommended. Unit tests are especially valuable when external resources (such as cloud or network devices) are required. For more information see <a class="reference internal" href="index.html#document-dev_guide/testing"><span class="doc">Testing Ansible</span></a> and the <a class="reference external" href="https://github.com/ansible/community/blob/master/meetings/README.md">Testing Working Group</a>.
* Starting with Ansible 2.4 all <span class="xref doc">../list_of_network_modules</span> MUST have unit tests.</li>
</ul>
</div>
<div class="section" id="naming-convention">
<h6><a class="toc-backref" href="#id4">Naming Convention</a><a class="headerlink" href="#naming-convention" title="Permalink to this headline">¶</a></h6>
<p>As you may have noticed when looking under <code class="docutils literal"><span class="pre">lib/ansible/modules/</span></code> we support up to two directories deep (but no deeper), e.g. <cite>databases/mysql</cite>. This is used to group files on disk as well as group related modules into categories and topics the Module Index, for example: <span class="xref doc">../list_of_database_modules</span>.</p>
<p>The directory name should represent the <em>product</em> or <em>OS</em> name, not the company name.</p>
<p>Each module should have the above (or similar) prefix; see existing <span class="xref doc">../list_of_all_modules</span> for existing examples.</p>
<p><strong>Note:</strong></p>
<ul class="simple">
<li>File and directory names are always in lower case</li>
<li>Words are separated with an underscore (<code class="docutils literal"><span class="pre">_</span></code>) character</li>
<li>Module names should be in the singular, rather than plural, eg <code class="docutils literal"><span class="pre">command</span></code> not <code class="docutils literal"><span class="pre">commands</span></code></li>
</ul>
</div>
<div class="section" id="speak-to-us">
<h6><a class="toc-backref" href="#id5">Speak to us</a><a class="headerlink" href="#speak-to-us" title="Permalink to this headline">¶</a></h6>
<p>Circulating your ideas before coding is a good way to help you set off in the right direction.</p>
<p>After reading the &#8220;Before you start coding&#8221; section you will hopefully have a reasonable idea of the structure of your modules.</p>
<p>We&#8217;ve found that writing a list of your proposed module names and a one or two line description of what they will achieve and having that reviewed by Ansible is a great way to ensure the modules fit the way people have used Ansible Modules before, and therefore make them easier to use.</p>
</div>
<div class="section" id="where-to-get-support">
<h6><a class="toc-backref" href="#id6">Where to get support</a><a class="headerlink" href="#where-to-get-support" title="Permalink to this headline">¶</a></h6>
<p>Ansible has a thriving and knowledgeable community of module developers that is a great resource for getting your questions answered.</p>
<p>On <a class="reference internal" href="index.html#document-community"><span class="doc">Community Information &amp; Contributing</span></a> you can find how to:</p>
<ul class="simple">
<li>Subscribe to the Mailing Lists - We suggest &#8220;Ansible Development List&#8221; (for codefreeze info) and &#8220;Ansible Announce list&#8221;</li>
<li><code class="docutils literal"><span class="pre">#ansible-devel</span></code> - We have found that IRC <code class="docutils literal"><span class="pre">#ansible-devel</span></code> on FreeNodes IRC network works best for module developers so we can have an interactive dialogue.</li>
<li>IRC meetings - Join the various weekly IRC meetings <a class="reference external" href="https://github.com/ansible/community/blob/master/meetings/README.md">meeting schedule and agenda page</a></li>
</ul>
</div>
<div class="section" id="your-first-pull-request">
<h6><a class="toc-backref" href="#id7">Your First Pull Request</a><a class="headerlink" href="#your-first-pull-request" title="Permalink to this headline">¶</a></h6>
<p>Now that you&#8217;ve reviewed this document, you should be ready to open your first pull request.</p>
<p>The first PR is slightly different to the rest because it:</p>
<ul class="simple">
<li>defines the namespace</li>
<li>provides a basis for detailed review that will help shape your future PRs</li>
<li>may include shared documentation (<cite>docs_fragments</cite>) that multiple modules require</li>
<li>may include shared code (<cite>module_utils</cite>) that multiple modules require</li>
</ul>
<p>The first PR should include the following files:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">lib/ansible/modules/$category/$topic/__init__.py</span></code> - An empty file to initialize namespace and allow Python to import the files. <em>Required new file</em></li>
<li><code class="docutils literal"><span class="pre">lib/ansible/modules/$category/$topic/$yourfirstmodule.py</span></code> - A single module. <em>Required new file</em></li>
<li><code class="docutils literal"><span class="pre">lib/ansible/utils/module_docs_fragments/$topic.py</span></code> - Code documentation, such as details regarding common arguments. <em>Optional new file</em></li>
<li><code class="docutils literal"><span class="pre">lib/ansible/module_utils/$topic.py</span></code> - Code shared between more than one module, such as common arguments. <em>Optional new file</em></li>
<li><code class="docutils literal"><span class="pre">docs/docsite/rst/dev_guide/developing_module_utilities.rst</span></code> - Document your new <cite>module_utils</cite> file. <em>Optional update to existing file</em></li>
</ul>
<p>And that&#8217;s it.</p>
<p>Before pushing your PR to GitHub it&#8217;s a good idea to review the <a class="reference internal" href="index.html#document-dev_guide/developing_modules_checklist"><span class="doc">Contributing Your Module to Ansible</span></a> again.</p>
<p>After publishing your PR to <a class="reference external" href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a>, a Shippable CI test should run within a few minutes. Check the results (at the end of the PR page) to ensure that it&#8217;s passing (green). If it&#8217;s not passing, inspect each of the results. Most of the errors should be self-explanatory and are often related to badly formatted documentation (see <a class="reference internal" href="index.html#document-YAMLSyntax"><span class="doc">YAML Syntax</span></a>) or code that isn&#8217;t valid Python 2.6  or valid Python 3.5 (see <a class="reference internal" href="index.html#document-dev_guide/developing_python3"><span class="doc">Ansible and Python 3</span></a>). If you aren&#8217;t sure what a Shippable test message means, copy it into the PR along with a comment and we will review.</p>
<p>If you need further advice, consider join the <code class="docutils literal"><span class="pre">#ansible-devel</span></code> IRC channel (see how in the &#8220;Where to get support&#8221;).</p>
<p>We have a <code class="docutils literal"><span class="pre">ansibullbot</span></code> helper that comments on GitHub Issues and PRs which should highlight important information.</p>
</div>
<div class="section" id="subsequent-prs">
<h6><a class="toc-backref" href="#id8">Subsequent PRs</a><a class="headerlink" href="#subsequent-prs" title="Permalink to this headline">¶</a></h6>
<p>By this point you first PR that defined the module namespace should have been merged. You can take the lessons learned from the first PR and apply it to the rest of the modules.</p>
<p>Raise exactly one PR per module for the remaining modules.</p>
<p>Over the years we&#8217;ve experimented with different sized module PRs, ranging from one module to many tens of modules, and during that time we&#8217;ve found the following:</p>
<ul class="simple">
<li>A PR with a single file gets a higher quality review</li>
<li>PRs with multiple modules are harder for the creator to ensure all feedback has been applied</li>
<li>PRs with many modules take a lot more work to review, and tend to get passed over for easier-to-review PRs.</li>
</ul>
<p>You can raise up to five PRs at one (5 PRs = 5 new modules) <strong>after</strong> your first PR has been merged. We&#8217;ve found this is a good batch size to keep the review process flowing.</p>
</div>
<div class="section" id="finally">
<h6><a class="toc-backref" href="#id9">Finally</a><a class="headerlink" href="#finally" title="Permalink to this headline">¶</a></h6>
<p>Now that your modules are integrated there are a few bits of housekeeping to be done</p>
<p><strong>Bot Meta</strong>
Update <cite>Ansibullbot</cite> so it knows who to notify if/when bugs or PRs are raised against your modules
<a class="reference external" href="https://github.com/ansible/ansible/blob/devel/.github/BOTMETA.yml">BOTMETA.yml</a>.</p>
<p>If there are multiple people that can be notified, please list them. That avoids waiting on a single person who may be unavailable for any reason. Note that in <cite>BOTMETA.yml</cite> you can take ownership of an entire directory.</p>
<p><strong>Review Module web docs</strong>
Review the autogenerated module documentation for each of your modules, found in <a class="reference external" href="http://docs.ansible.com/ansible/modules_by_category.html">Module Docs</a> to ensure they are correctly formatted. If there are any issues please fix by raising a single PR.</p>
<p>If the module documentation hasn&#8217;t been published live yet, please let a member of the Ansible Core Team know in the <code class="docutils literal"><span class="pre">#ansible-devel</span></code> IRC channel.</p>
</div>
<div class="section" id="new-to-git-or-github">
<h6><a class="toc-backref" href="#id10">New to Git or GitHub</a><a class="headerlink" href="#new-to-git-or-github" title="Permalink to this headline">¶</a></h6>
<p>We realise this may be your first use of Git or GitHub. The following guides may be of use:</p>
<ul class="simple">
<li><a class="reference external" href="https://help.github.com/articles/fork-a-repo/">How to create a fork of ansible/ansible</a></li>
<li><a class="reference external" href="https://help.github.com/articles/syncing-a-fork/">How to sync (update) your fork</a></li>
<li><a class="reference external" href="https://help.github.com/articles/about-pull-requests/">How to create a Pull Request (PR)</a></li>
</ul>
<p>Please note that in the Ansible Git Repo the main branch is called <code class="docutils literal"><span class="pre">devel</span></code> rather than <code class="docutils literal"><span class="pre">master</span></code>, which is used in the official GitHub documentation</p>
<p>After your first PR has been merged ensure you &#8220;sync your fork&#8221; with <code class="docutils literal"><span class="pre">ansible/ansible</span></code> to ensure you&#8217;ve pulled in the directory structure and and shared code or documentation previously created.</p>
<p>As stated in the GitHub documentation, always use feature branches for your PRs, never commit directly into <cite>devel</cite>.</p>
</div>
</div>
<span id="document-dev_guide/developing_program_flow_modules"></span><div class="section" id="modules">
<span id="flow-modules"></span><h5>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h5>
<p>This in-depth dive helps you understand Ansible&#8217;s program flow to execute
modules. It is written for people working on the portions of the Core Ansible
Engine that execute a module. Those writing Ansible Modules may also find this
in-depth dive to be of interest, but individuals simply using Ansible Modules
will not likely find this to be helpful.</p>
<div class="section" id="types-of-modules">
<span id="flow-types-of-modules"></span><h6>Types of Modules<a class="headerlink" href="#types-of-modules" title="Permalink to this headline">¶</a></h6>
<p>Ansible supports several different types of modules in its code base.  Some of
these are for backwards compatibility and others are to enable flexibility.</p>
<div class="section" id="action-plugins">
<span id="flow-action-plugins"></span><h7>Action Plugins<a class="headerlink" href="#action-plugins" title="Permalink to this headline">¶</a></h7>
<p>Action Plugins look like modules to end users who are writing <a class="reference internal" href="index.html#term-playbooks"><span class="xref std std-term">playbooks</span></a> but
they&#8217;re distinct entities for the purposes of this document.  Action Plugins
always execute on the controller and are sometimes able to do all work there
(for instance, the <code class="docutils literal"><span class="pre">debug</span></code> Action Plugin which prints some text for the user to
see or the <code class="docutils literal"><span class="pre">assert</span></code> Action Plugin which can test whether several values in
a playbook satisfy certain criteria.)</p>
<p>More often, Action Plugins set up some values on the controller, then invoke an
actual module on the managed node that does something with these values.  An
easy to understand version of this is the <span class="xref std std-ref">template Action Plugin</span>.  The <span class="xref std std-ref">template Action Plugin</span> takes values from
the user to construct a file in a temporary location on the controller using
variables from the playbook environment.  It then transfers the temporary file
to a temporary file on the remote system.  After that, it invokes the
<span class="xref std std-ref">copy module</span> which operates on the remote system to move the file
into its final location, sets file permissions, and so on.</p>
</div>
<div class="section" id="new-style-modules">
<span id="flow-new-style-modules"></span><h7>New-style Modules<a class="headerlink" href="#new-style-modules" title="Permalink to this headline">¶</a></h7>
<p>All of the modules that ship with Ansible fall into this category.</p>
<p>New-style modules have the arguments to the module embedded inside of them in
some manner.  Non-new-style modules must copy a separate file over to the
managed node, which is less efficient as it requires two over-the-wire
connections instead of only one.</p>
<div class="section" id="python">
<span id="flow-python-modules"></span><h8>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h8>
<p>New-style Python modules use the <a class="reference internal" href="#ansiballz"><span class="std std-ref">Ansiballz</span></a> framework for constructing
modules.  All official modules (shipped with Ansible) use either this or the
<a class="reference internal" href="#flow-powershell-modules"><span class="std std-ref">powershell module framework</span></a>.</p>
<p>These modules use imports from <code class="code docutils literal"><span class="pre">ansible.module_utils</span></code> in order to pull in
boilerplate module code, such as argument parsing, formatting of return
values as <a class="reference internal" href="index.html#term-json"><span class="xref std std-term">JSON</span></a>, and various file operations.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In Ansible, up to version 2.0.x, the official Python modules used the
<a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a> framework.  For module authors, <a class="reference internal" href="#ansiballz"><span class="std std-ref">Ansiballz</span></a> is
largely a superset of <a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a> functionality, so you usually
do not need to know about one versus the other.</p>
</div>
</div>
<div class="section" id="powershell">
<span id="flow-powershell-modules"></span><h8>Powershell<a class="headerlink" href="#powershell" title="Permalink to this headline">¶</a></h8>
<p>New-style powershell modules use the <a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a> framework for
constructing modules.  These modules get a library of powershell code embedded
in them before being sent to the managed node.</p>
</div>
<div class="section" id="jsonargs">
<span id="flow-jsonargs-modules"></span><h8>JSONARGS<a class="headerlink" href="#jsonargs" title="Permalink to this headline">¶</a></h8>
<p>Scripts can arrange for an argument string to be placed within them by placing
the string <code class="docutils literal"><span class="pre">&lt;&lt;INCLUDE_ANSIBLE_MODULE_JSON_ARGS&gt;&gt;</span></code> somewhere inside of the
file.  The module typically sets a variable to that value like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">json_arguments</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;&lt;INCLUDE_ANSIBLE_MODULE_JSON_ARGS&gt;&gt;&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Which is expanded as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">json_arguments</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{&quot;param1&quot;: &quot;test&#39;s quotes&quot;, &quot;param2&quot;: &quot;</span><span class="se">\&quot;</span><span class="s2">To be or not to be</span><span class="se">\&quot;</span><span class="s2"> - Hamlet&quot;}&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible outputs a <a class="reference internal" href="index.html#term-json"><span class="xref std std-term">JSON</span></a> string with bare quotes.  Double quotes are
used to quote string values, double quotes inside of string values are
backslash escaped, and single quotes may appear unescaped inside of
a string value.  To use JSONARGS, your scripting language must have a way
to handle this type of string.  The example uses Python&#8217;s triple quoted
strings to do this.  Other scripting languages may have a similar quote
character that won&#8217;t be confused by any quotes in the JSON or it may
allow you to define your own start-of-quote and end-of-quote characters.
If the language doesn&#8217;t give you any of these then you&#8217;ll need to write
a <a class="reference internal" href="#flow-want-json-modules"><span class="std std-ref">non-native JSON module</span></a> or
<a class="reference internal" href="#flow-old-style-modules"><span class="std std-ref">Old-style module</span></a> instead.</p>
</div>
<p>The module typically parses the contents of <code class="docutils literal"><span class="pre">json_arguments</span></code> using a JSON
library and then use them as native variables throughout the rest of its code.</p>
</div>
</div>
<div class="section" id="non-native-want-json-modules">
<span id="flow-want-json-modules"></span><h7>Non-native want JSON modules<a class="headerlink" href="#non-native-want-json-modules" title="Permalink to this headline">¶</a></h7>
<p>If a module has the string <code class="docutils literal"><span class="pre">WANT_JSON</span></code> in it anywhere, Ansible treats
it as a non-native module that accepts a filename as its only command line
parameter.  The filename is for a temporary file containing a <a class="reference internal" href="index.html#term-json"><span class="xref std std-term">JSON</span></a>
string containing the module&#8217;s parameters.  The module needs to open the file,
read and parse the parameters, operate on the data, and print its return data
as a JSON encoded dictionary to stdout before exiting.</p>
<p>These types of modules are self-contained entities.  As of Ansible 2.1, Ansible
only modifies them to change a shebang line if present.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">Examples of Non-native modules written in ruby are in the <a class="reference external" href="https://github.com/ansible/ansible-for-rubyists">Ansible
for Rubyists</a> repository.</p>
</div>
</div>
<div class="section" id="binary-modules">
<span id="flow-binary-modules"></span><h7>Binary Modules<a class="headerlink" href="#binary-modules" title="Permalink to this headline">¶</a></h7>
<p>From Ansible 2.2 onwards, modules may also be small binary programs.  Ansible
doesn&#8217;t perform any magic to make these portable to different systems so they
may be specific to the system on which they were compiled or require other
binary runtime dependencies.  Despite these drawbacks, a site may sometimes
have no choice but to compile a custom module against a specific binary
library if that&#8217;s the only way they have to get access to certain resources.</p>
<p>Binary modules take their arguments and will return data to Ansible in the same
way as <a class="reference internal" href="#flow-want-json-modules"><span class="std std-ref">want JSON modules</span></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">One example of a <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/test/integration/targets/binary_modules/library/helloworld.go">binary module</a>
written in go.</p>
</div>
</div>
<div class="section" id="old-style-modules">
<span id="flow-old-style-modules"></span><h7>Old-style Modules<a class="headerlink" href="#old-style-modules" title="Permalink to this headline">¶</a></h7>
<p>Old-style modules are similar to
<a class="reference internal" href="#flow-want-json-modules"><span class="std std-ref">want JSON modules</span></a>, except that the file that
they take contains <code class="docutils literal"><span class="pre">key=value</span></code> pairs for their parameters instead of
<a class="reference internal" href="index.html#term-json"><span class="xref std std-term">JSON</span></a>.</p>
<p>Ansible decides that a module is old-style when it doesn&#8217;t have any of the
markers that would show that it is one of the other types.</p>
</div>
</div>
<div class="section" id="how-modules-are-executed">
<span id="flow-how-modules-are-executed"></span><h6>How modules are executed<a class="headerlink" href="#how-modules-are-executed" title="Permalink to this headline">¶</a></h6>
<p>When a user uses <strong class="program">ansible</strong> or <strong class="program">ansible-playbook</strong>, they
specify a task to execute.  The task is usually the name of a module along
with several parameters to be passed to the module.  Ansible takes these
values and processes them in various ways before they are finally executed on
the remote machine.</p>
<div class="section" id="executor-task-executor">
<span id="flow-executor-task-executor"></span><h7>executor/task_executor<a class="headerlink" href="#executor-task-executor" title="Permalink to this headline">¶</a></h7>
<p>The TaskExecutor receives the module name and parameters that were parsed from
the <a class="reference internal" href="index.html#term-playbooks"><span class="xref std std-term">playbook</span></a> (or from the command line in the case of
<strong class="command">/usr/bin/ansible</strong>).  It uses the name to decide whether it&#8217;s looking
at a module or an <a class="reference internal" href="#flow-action-plugins"><span class="std std-ref">Action Plugin</span></a>.  If it&#8217;s
a module, it loads the <a class="reference internal" href="#flow-normal-action-plugin"><span class="std std-ref">Normal Action Plugin</span></a>
and passes the name, variables, and other information about the task and play
to that Action Plugin for further processing.</p>
</div>
<div class="section" id="normal-action-plugin">
<span id="flow-normal-action-plugin"></span><h7>Normal Action Plugin<a class="headerlink" href="#normal-action-plugin" title="Permalink to this headline">¶</a></h7>
<p>The <code class="docutils literal"><span class="pre">normal</span></code> Action Plugin executes the module on the remote host.  It is
the primary coordinator of much of the work to actually execute the module on
the managed machine.</p>
<ul class="simple">
<li>It takes care of creating a connection to the managed machine by
instantiating a <code class="docutils literal"><span class="pre">Connection</span></code> class according to the inventory
configuration for that host.</li>
<li>It adds any internal Ansible variables to the module&#8217;s parameters (for
instance, the ones that pass along <code class="docutils literal"><span class="pre">no_log</span></code> to the module).</li>
<li>It takes care of creating any temporary files on the remote machine and
cleans up afterwards.</li>
<li>It does the actual work of pushing the module and module parameters to the
remote host, although the <a class="reference internal" href="#flow-executor-module-common"><span class="std std-ref">module_common</span></a>
code described in the next section does the work of deciding which format
those will take.</li>
<li>It handles any special cases regarding modules (for instance, various
complications around Windows modules that must have the same names as Python
modules, so that internal calling of modules from other Action Plugins work.)</li>
</ul>
<p>Much of this functionality comes from the <code class="xref py py-class docutils literal"><span class="pre">BaseAction</span></code> class,
which lives in <code class="file docutils literal"><span class="pre">plugins/action/__init__.py</span></code>.  It makes use of
<code class="docutils literal"><span class="pre">Connection</span></code> and <code class="docutils literal"><span class="pre">Shell</span></code> objects to do its work.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When <a class="reference internal" href="index.html#term-tasks"><span class="xref std std-term">tasks</span></a> are run with the <code class="docutils literal"><span class="pre">async:</span></code> parameter, Ansible
uses the <code class="docutils literal"><span class="pre">async</span></code> Action Plugin instead of the <code class="docutils literal"><span class="pre">normal</span></code> Action Plugin
to invoke it.  That program flow is currently not documented.  Read the
source for information on how that works.</p>
</div>
</div>
<div class="section" id="executor-module-common-py">
<span id="flow-executor-module-common"></span><h7>executor/module_common.py<a class="headerlink" href="#executor-module-common-py" title="Permalink to this headline">¶</a></h7>
<p>Code in <code class="file docutils literal"><span class="pre">executor/module_common.py</span></code> takes care of assembling the module
to be shipped to the managed node.  The module is first read in, then examined
to determine its type.  <a class="reference internal" href="#flow-powershell-modules"><span class="std std-ref">PowerShell</span></a> and
<a class="reference internal" href="#flow-jsonargs-modules"><span class="std std-ref">JSON-args modules</span></a> are passed through
<a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a>.  New-style
<a class="reference internal" href="#flow-python-modules"><span class="std std-ref">Python modules</span></a> are assembled by <a class="reference internal" href="#ansiballz"><span class="std std-ref">Ansiballz</span></a>.
<a class="reference internal" href="#flow-want-json-modules"><span class="std std-ref">Non-native-want-JSON</span></a>,
<a class="reference internal" href="#flow-binary-modules"><span class="std std-ref">Binary modules</span></a>, and
<a class="reference internal" href="#flow-old-style-modules"><span class="std std-ref">Old-Style modules</span></a> aren&#8217;t touched by either of
these and pass through unchanged.  After the assembling step, one final
modification is made to all modules that have a shebang line.  Ansible checks
whether the interpreter in the shebang line has a specific path configured via
an <code class="docutils literal"><span class="pre">ansible_$X_interpreter</span></code> inventory variable.  If it does, Ansible
substitutes that path for the interpreter path given in the module.  After
this, Ansible returns the complete module data and the module type to the
<a class="reference internal" href="#flow-normal-action-plugin"><span class="std std-ref">Normal Action</span></a> which continues execution of
the module.</p>
<p>Next we&#8217;ll go into some details of the two assembler frameworks.</p>
<div class="section" id="module-replacer">
<span id="id1"></span><h8>Module Replacer<a class="headerlink" href="#module-replacer" title="Permalink to this headline">¶</a></h8>
<p>The Module Replacer framework is the original framework implementing new-style
modules.  It is essentially a preprocessor (like the C Preprocessor for those
familiar with that programming language).  It does straight substitutions of
specific substring patterns in the module file.  There are two types of
substitutions:</p>
<ul class="simple">
<li>Replacements that only happen in the module file.  These are public
replacement strings that modules can utilize to get helpful boilerplate or
access to arguments.<ul>
<li><code class="code docutils literal"><span class="pre">from</span> <span class="pre">ansible.module_utils.MOD_LIB_NAME</span> <span class="pre">import</span> <span class="pre">*</span></code> is replaced with the
contents of the <code class="file docutils literal"><span class="pre">ansible/module_utils/MOD_LIB_NAME.py</span></code>  These should
only be used with <a class="reference internal" href="#flow-python-modules"><span class="std std-ref">new-style Python modules</span></a>.</li>
<li><code class="code docutils literal"><span class="pre">#&lt;&lt;INCLUDE_ANSIBLE_MODULE_COMMON&gt;&gt;</span></code> is equivalent to
<code class="code docutils literal"><span class="pre">from</span> <span class="pre">ansible.module_utils.basic</span> <span class="pre">import</span> <span class="pre">*</span></code> and should also only apply
to new-style Python modules.</li>
<li><code class="code docutils literal"><span class="pre">#</span> <span class="pre">POWERSHELL_COMMON</span></code> substitutes the contents of
<code class="file docutils literal"><span class="pre">ansible/module_utils/powershell.ps1</span></code>.  It should only be used with
<a class="reference internal" href="#flow-powershell-modules"><span class="std std-ref">new-style Powershell modules</span></a>.</li>
</ul>
</li>
<li>Replacements that are used by <code class="docutils literal"><span class="pre">ansible.module_utils</span></code> code.  These are internal
replacement patterns.  They may be used internally, in the above public
replacements, but shouldn&#8217;t be used directly by modules.<ul>
<li><code class="code docutils literal"><span class="pre">&quot;&lt;&lt;ANSIBLE_VERSION&gt;&gt;&quot;</span></code> is substituted with the Ansible version.  In
<a class="reference internal" href="#flow-python-modules"><span class="std std-ref">new-style Python modules</span></a> under the
<a class="reference internal" href="#ansiballz"><span class="std std-ref">Ansiballz</span></a> frameworkthe proper way is to instead instantiate an
<code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and then access the version from
:attr:<code class="docutils literal"><span class="pre">AnsibleModule.ansible_version</span></code>.</li>
<li><code class="code docutils literal"><span class="pre">&quot;&lt;&lt;INCLUDE_ANSIBLE_MODULE_COMPLEX_ARGS&gt;&gt;&quot;</span></code> is substituted with
a string which is the Python <code class="docutils literal"><span class="pre">repr</span></code> of the <a class="reference internal" href="index.html#term-json"><span class="xref std std-term">JSON</span></a> encoded module
parameters.  Using <code class="docutils literal"><span class="pre">repr</span></code> on the JSON string makes it safe to embed in
a Python file.  In new-style Python modules under the Ansiballz framework
this is better accessed by instantiating an <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and
then using <code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule.params</span></code>.</li>
<li><code class="code docutils literal"><span class="pre">&lt;&lt;SELINUX_SPECIAL_FILESYSTEMS&gt;&gt;</span></code> substitutes a string which is
a comma separated list of file systems which have a file system dependent
security context in SELinux.  In new-style Python modules, if you really
need this you should instantiate an <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and then use
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule._selinux_special_fs</span></code>.  The variable has also changed
from a comma separated string of file system names to an actual python
list of filesystem names.</li>
<li><code class="code docutils literal"><span class="pre">&lt;&lt;INCLUDE_ANSIBLE_MODULE_JSON_ARGS&gt;&gt;</span></code> substitutes the module
parameters as a JSON string.  Care must be taken to properly quote the
string as JSON data may contain quotes.  This pattern is not substituted
in new-style Python modules as they can get the module parameters another
way.</li>
<li>The string <code class="code docutils literal"><span class="pre">syslog.LOG_USER</span></code> is replaced wherever it occurs with the
<code class="docutils literal"><span class="pre">syslog_facility</span></code> which was named in <code class="file docutils literal"><span class="pre">ansible.cfg</span></code> or any
<code class="docutils literal"><span class="pre">ansible_syslog_facility</span></code> inventory variable that applies to this host.  In
new-style Python modules this has changed slightly.  If you really need to
access it, you should instantiate an <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and then use
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule._syslog_facility</span></code> to access it.  It is no longer the
actual syslog facility and is now the name of the syslog facility.  See
the <a class="reference internal" href="#flow-internal-arguments"><span class="std std-ref">documentation on internal arguments</span></a>
for details.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ansiballz">
<span id="id2"></span><h8>Ansiballz<a class="headerlink" href="#ansiballz" title="Permalink to this headline">¶</a></h8>
<p>Ansible 2.1 switched from the <a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a> framework to the
Ansiballz framework for assembling modules.  The Ansiballz framework differs
from module replacer in that it uses real Python imports of things in
<code class="file docutils literal"><span class="pre">ansible/module_utils</span></code> instead of merely preprocessing the module.  It
does this by constructing a zipfile &#8211; which includes the module file, files
in <code class="file docutils literal"><span class="pre">ansible/module_utils</span></code> that are imported by the module, and some
boilerplate to pass in the module&#8217;s parameters.  The zipfile is then Base64
encoded and wrapped in a small Python script which decodes the Base64 encoding
and places the zipfile into a temp directory on the managed node.  It then
extracts just the ansible module script from the zip file and places that in
the temporary directory as well.  Then it sets the PYTHONPATH to find python
modules inside of the zip file and invokes <strong class="command">python</strong> on the extracted
ansible module.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Ansible wraps the zipfile in the Python script for two reasons:</p>
<ul class="last simple">
<li>for compatibility with Python-2.6 which has a less
functional version of Python&#8217;s <code class="docutils literal"><span class="pre">-m</span></code> command line switch.</li>
<li>so that pipelining will function properly.  Pipelining needs to pipe the
Python module into the Python interpreter on the remote node.  Python
understands scripts on stdin but does not understand zip files.</li>
</ul>
</div>
<p>In Ansiballz, any imports of Python modules from the
<code class="xref py py-mod docutils literal"><span class="pre">ansible.module_utils</span></code> package trigger inclusion of that Python file
into the zipfile.  Instances of <code class="code docutils literal"><span class="pre">#&lt;&lt;INCLUDE_ANSIBLE_MODULE_COMMON&gt;&gt;</span></code> in
the module are turned into <code class="code docutils literal"><span class="pre">from</span> <span class="pre">ansible.module_utils.basic</span> <span class="pre">import</span> <span class="pre">*</span></code>
and <code class="file docutils literal"><span class="pre">ansible/module-utils/basic.py</span></code> is then included in the zipfile.
Files that are included from <code class="file docutils literal"><span class="pre">module_utils</span></code> are themselves scanned for
imports of other Python modules from <code class="file docutils literal"><span class="pre">module_utils</span></code> to be included in
the zipfile as well.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">At present, the Ansiballz Framework cannot determine whether an import
should be included if it is a relative import.  Always use an absolute
import that has <code class="xref py py-mod docutils literal"><span class="pre">ansible.module_utils</span></code> in it to allow Ansiballz to
determine that the file should be included.</p>
</div>
<div class="section" id="passing-args">
<span id="flow-passing-module-args"></span><h9>Passing args<a class="headerlink" href="#passing-args" title="Permalink to this headline">¶</a></h9>
<p>In <a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a>, module arguments are turned into a JSON-ified
string and substituted into the combined module file.  In <a class="reference internal" href="#ansiballz"><span class="std std-ref">Ansiballz</span></a>,
the JSON-ified string is passed into the module via stdin.  When
a  <code class="xref py py-class docutils literal"><span class="pre">ansible.module_utils.basic.AnsibleModule</span></code> is instantiated,
it parses this string and places the args into
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule.params</span></code> where it can be accessed by the module&#8217;s
other code.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Internally, the <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> uses the helper function,
<code class="xref py py-func docutils literal"><span class="pre">ansible.module_utils.basic._load_params()</span></code>, to load the parameters
from stdin and save them into an internal global variable.  Very dynamic
custom modules which need to parse the parameters prior to instantiating
an <code class="docutils literal"><span class="pre">AnsibleModule</span></code> may use <code class="docutils literal"><span class="pre">_load_params</span></code> to retrieve the
parameters.  Be aware that <code class="docutils literal"><span class="pre">_load_params</span></code> is an internal function and
may change in breaking ways if necessary to support changes in the code.
However, we&#8217;ll do our best not to break it gratuitously, which is not
something that can be said for either the way parameters are passed or
the internal global variable.</p>
</div>
</div>
</div>
<div class="section" id="internal-arguments">
<span id="flow-internal-arguments"></span><h8>Internal arguments<a class="headerlink" href="#internal-arguments" title="Permalink to this headline">¶</a></h8>
<p>Both <a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a> and <a class="reference internal" href="#ansiballz"><span class="std std-ref">Ansiballz</span></a> send additional arguments to
the module beyond those which the user specified in the playbook.  These
additional arguments are internal parameters that help implement global
Ansible features.  Modules often do not need to know about these explicitly as
the features are implemented in <code class="xref py py-mod docutils literal"><span class="pre">ansible.module_utils.basic</span></code> but certain
features need support from the module so it&#8217;s good to know about them.</p>
<div class="section" id="ansible-no-log">
<h9>_ansible_no_log<a class="headerlink" href="#ansible-no-log" title="Permalink to this headline">¶</a></h9>
<p>This is a boolean.  If it&#8217;s True then the playbook specified <code class="docutils literal"><span class="pre">no_log</span></code> (in
a task&#8217;s parameters or as a play parameter).  This automatically affects calls
to <code class="xref py py-meth docutils literal"><span class="pre">AnsibleModule.log()</span></code>.  If a module implements its own logging then
it needs to check this value.  The best way to look at this is for the module
to instantiate an <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and then check the value of
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule.no_log</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">no_log</span></code> specified in a module&#8217;s argument_spec are handled by a different mechanism.</p>
</div>
</div>
<div class="section" id="ansible-debug">
<h9>_ansible_debug<a class="headerlink" href="#ansible-debug" title="Permalink to this headline">¶</a></h9>
<p>This is a boolean that turns on more verbose logging.  If a module uses
<code class="xref py py-meth docutils literal"><span class="pre">AnsibleModule.debug()</span></code> rather than <code class="xref py py-meth docutils literal"><span class="pre">AnsibleModule.log()</span></code> then
the messages are only logged if this is True.  This also turns on logging of
external commands that the module executes.  This can be changed via
the <code class="docutils literal"><span class="pre">debug</span></code> setting in <code class="file docutils literal"><span class="pre">ansible.cfg</span></code> or the environment variable
<span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_DEBUG</span></code>.  If, for some reason, a module must access this, it
should do so by instantiating an <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and accessing
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule._debug</span></code>.</p>
</div>
<div class="section" id="ansible-diff">
<h9>_ansible_diff<a class="headerlink" href="#ansible-diff" title="Permalink to this headline">¶</a></h9>
<p>This boolean is turned on via the <code class="docutils literal"><span class="pre">--diff</span></code> command line option.  If a module
supports it, it will tell the module to show a unified diff of changes to be
made to templated files.  The proper way for a module to access this is by
instantiating an <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and accessing
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule._diff</span></code>.</p>
</div>
<div class="section" id="ansible-verbosity">
<h9>_ansible_verbosity<a class="headerlink" href="#ansible-verbosity" title="Permalink to this headline">¶</a></h9>
<p>This value could be used for finer grained control over logging. However, it
is currently unused.</p>
</div>
<div class="section" id="ansible-selinux-special-fs">
<h9>_ansible_selinux_special_fs<a class="headerlink" href="#ansible-selinux-special-fs" title="Permalink to this headline">¶</a></h9>
<p>This is a list of names of filesystems which should have a special selinux
context.  They are used by the <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> methods which operate on
files (changing attributes, moving, and copying).  The list of names is set
via a comma separated string of filesystem names from <code class="file docutils literal"><span class="pre">ansible.cfg</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># ansible.cfg</span>
<span class="o">[</span>selinux<span class="o">]</span>
<span class="nv">special_context_filesystems</span><span class="o">=</span>nfs,vboxsf,fuse,ramfs
</pre></div>
</div>
<p>If a module cannot use the builtin <code class="docutils literal"><span class="pre">AnsibleModule</span></code> methods to manipulate
files and needs to know about these special context filesystems, it should
instantiate an <code class="docutils literal"><span class="pre">AnsibleModule</span></code> and then examine the list in
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule._selinux_special_fs</span></code>.</p>
<p>This replaces <code class="xref py py-attr docutils literal"><span class="pre">ansible.module_utils.basic.SELINUX_SPECIAL_FS</span></code> from
<a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a>.  In module replacer it was a comma separated string of
filesystem names.  Under Ansiballz it&#8217;s an actual list.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
</div>
<div class="section" id="ansible-syslog-facility">
<h9>_ansible_syslog_facility<a class="headerlink" href="#ansible-syslog-facility" title="Permalink to this headline">¶</a></h9>
<p>This parameter controls which syslog facility ansible module logs to.  It may
be set by changing the <code class="docutils literal"><span class="pre">syslog_facility</span></code> value in <code class="file docutils literal"><span class="pre">ansible.cfg</span></code>.  Most
modules should just use <code class="xref py py-meth docutils literal"><span class="pre">AnsibleModule.log()</span></code> which will then make use of
this.  If a module has to use this on its own, it should instantiate an
<code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and then retrieve the name of the syslog facility from
<code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule._syslog_facility</span></code>.  The code will look slightly different
than it did under <a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a> due to how hacky the old way was</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Old way</span>
<span class="kn">import</span> <span class="nn">syslog</span>
<span class="n">syslog</span><span class="o">.</span><span class="n">openlog</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syslog</span><span class="o">.</span><span class="n">LOG_USER</span><span class="p">)</span>

<span class="c1"># New way</span>
<span class="kn">import</span> <span class="nn">syslog</span>
<span class="n">facility_name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">_syslog_facility</span>
<span class="n">facility</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">syslog</span><span class="p">,</span> <span class="n">facility_name</span><span class="p">,</span> <span class="n">syslog</span><span class="o">.</span><span class="n">LOG_USER</span><span class="p">)</span>
<span class="n">syslog</span><span class="o">.</span><span class="n">openlog</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">facility</span><span class="p">)</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
</div>
<div class="section" id="ansible-version">
<h9>_ansible_version<a class="headerlink" href="#ansible-version" title="Permalink to this headline">¶</a></h9>
<p>This parameter passes the version of ansible that runs the module.  To access
it, a module should instantiate an <code class="xref py py-class docutils literal"><span class="pre">AnsibleModule</span></code> and then retrieve it
from <code class="xref py py-attr docutils literal"><span class="pre">AnsibleModule.ansible_version</span></code>.  This replaces
<code class="xref py py-attr docutils literal"><span class="pre">ansible.module_utils.basic.ANSIBLE_VERSION</span></code> from
<a class="reference internal" href="#module-replacer"><span class="std std-ref">Module Replacer</span></a>.</p>
<div class="versionadded">
<p><span class="versionmodified">New in version 2.1.</span></p>
</div>
</div>
</div>
</div>
<div class="section" id="special-considerations">
<span id="flow-special-considerations"></span><h7>Special Considerations<a class="headerlink" href="#special-considerations" title="Permalink to this headline">¶</a></h7>
<div class="section" id="pipelining">
<span id="flow-pipelining"></span><h8>Pipelining<a class="headerlink" href="#pipelining" title="Permalink to this headline">¶</a></h8>
<p>Ansible can transfer a module to a remote machine in one of two ways:</p>
<ul class="simple">
<li>it can write out the module to a temporary file on the remote host and then
use a second connection to the remote host to execute it with the
interpreter that the module needs</li>
<li>or it can use what&#8217;s known as pipelining to execute the module by piping it
into the remote interpreter&#8217;s stdin.</li>
</ul>
<p>Pipelining only works with modules written in Python at this time because
Ansible only knows that Python supports this mode of operation.  Supporting
pipelining means that whatever format the module payload takes before being
sent over the wire must be executable by Python via stdin.</p>
</div>
<div class="section" id="why-pass-args-over-stdin">
<span id="flow-args-over-stdin"></span><h8>Why pass args over stdin?<a class="headerlink" href="#why-pass-args-over-stdin" title="Permalink to this headline">¶</a></h8>
<p>Passing arguments via stdin was chosen for the following reasons:</p>
<ul class="simple">
<li>When combined with <a class="reference internal" href="index.html#pipelining"><span class="std std-ref">pipelining</span></a>, this keeps the module&#8217;s arguments from
temporarily being saved onto disk on the remote machine.  This makes it
harder (but not impossible) for a malicious user on the remote machine to
steal any sensitive information that may be present in the arguments.</li>
<li>Command line arguments would be insecure as most systems allow unprivileged
users to read the full commandline of a process.</li>
<li>Environment variables are usually more secure than the commandline but some
systems limit the total size of the environment.  This could lead to
truncation of the parameters if we hit that limit.</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-dev_guide/developing_module_utilities"></span><div class="section" id="appendix-module-utilities">
<h5>Appendix: Module Utilities<a class="headerlink" href="#appendix-module-utilities" title="Permalink to this headline">¶</a></h5>
<p>Ansible provides a number of module utilities that provide helper functions that you can use when developing your own modules. The <cite>basic.py</cite> module utility provides the main entry point for accessing the Ansible library, and all Ansible modules must, at minimum, import from basic.py:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>from ansible.module_utils.basic import *
</pre></div>
</div>
<p>The following is a list of module_utils files and a general description. The module utility source code lives in the <cite>./lib/module_utils</cite> directory under your main Ansible path - for more details on any specific module utility, please see the source code.</p>
<ul class="simple">
<li>a10.py - Utilities used by the a10_server module to manage A10 Networks devices.</li>
<li>aireos.py - Definitions and helper functions for modules that manage Cisco WLC devices.</li>
<li>api.py - Adds shared support for generic API modules.</li>
<li>aos.py - Module support utilities for managing Apstra AOS Server.</li>
<li>aruba.py - Helper functions for modules working with Aruba networking devices.</li>
<li>asa.py - Module support utilities for managing Cisco ASA network devices.</li>
<li>azure_rm_common.py - Definitions and utilities for Microsoft Azure Resource Manager template deployments.</li>
<li>basic.py - General definitions and helper utilities for Ansible modules.</li>
<li>cloudstack.py  - Utilities for CloudStack modules.</li>
<li>database.py - Miscellaneous helper functions for PostGRES and MySQL</li>
<li>docker_common.py - Definitions and helper utilities for modules working with Docker.</li>
<li>ec2.py - Definitions and utilities for modules working with Amazon EC2</li>
<li>eos.py - Helper functions for modules working with EOS networking devices.</li>
<li>f5.py - Helper functions for modules working with F5 networking devices.</li>
<li>facts.py - Helper functions for modules that return facts.</li>
<li>gce.py - Definitions and helper functions for modules that work with Google Compute Engine resources.</li>
<li>ios.py - Definitions and helper functions for modules that manage Cisco IOS networking devices</li>
<li>iosxr.py - Definitions and helper functions for modules that manage Cisco IOS-XR networking devices</li>
<li>ismount.py - Contains single helper function that fixes os.path.ismount</li>
<li>junos.py -  Definitions and helper functions for modules that manage Junos networking devices</li>
<li>known_hosts.py - utilities for working with known_hosts file</li>
<li>manageiq.py - Functions and utilities for modules that work with ManageIQ platform and its resources.</li>
<li>mysql.py - Allows modules to connect to a MySQL instance</li>
<li>netapp.py - Functions and utilities for modules that work with the NetApp storage platforms.</li>
<li>netcfg.py - Configuration utility functions for use by networking modules</li>
<li>netcmd.py - Defines commands and comparison operators for use in networking modules</li>
<li>netscaler.py - Utilities specifically for the netscaler network modules.</li>
<li>network.py - Functions for running commands on networking devices</li>
<li>nxos.py - Contains definitions and helper functions specific to Cisco NXOS networking devices</li>
<li>openstack.py - Utilities for modules that work with Openstack instances.</li>
<li>openswitch.py - Definitions and helper functions for modules that manage OpenSwitch devices</li>
<li>powershell.ps1 - Utilities for working with Microsoft Windows clients</li>
<li>pure.py - Functions and utilities for modules that work with the Pure Storage storage platforms.</li>
<li>pycompat24.py - Exception workaround for Python 2.4.</li>
<li>rax.py -  Definitions and helper functions for modules that work with Rackspace resources.</li>
<li>redhat.py - Functions for modules that manage Red Hat Network registration and subscriptions</li>
<li>service.py - Contains utilities to enable modules to work with Linux services (placeholder, not in use).</li>
<li>shell.py - Functions to allow modules to create shells and work with shell commands</li>
<li>six/__init__.py - Bundled copy of the <a class="reference external" href="https://pythonhosted.org/six/">Six Python library</a> to aid in writing code compatible with both Python 2 and Python 3.</li>
<li>splitter.py - String splitting and manipulation utilities for working with Jinja2 templates</li>
<li>urls.py - Utilities for working with http and https requests</li>
<li>vca.py - Contains utilities for modules that work with VMware vCloud Air</li>
<li>vmware.py - Contains utilities for modules that work with VMware vSphere VMs</li>
<li>vyos.py - Definitions and functions for working with VyOS networking</li>
</ul>
</div>
<span id="document-dev_guide/developing_plugins"></span><div class="section" id="developing-plugins">
<h5><a class="toc-backref" href="#id3">Developing Plugins</a><a class="headerlink" href="#developing-plugins" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#developing-plugins" id="id3">Developing Plugins</a><ul>
<li><a class="reference internal" href="#callback-plugins" id="id4">Callback Plugins</a><ul>
<li><a class="reference internal" href="#example-callback-plugins" id="id5">Example Callback Plugins</a></li>
<li><a class="reference internal" href="#configuring-callback-plugins" id="id6">Configuring Callback Plugins</a><ul>
<li><a class="reference internal" href="#managing-stdout" id="id7">Managing stdout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#developing-callback-plugins" id="id8">Developing Callback Plugins</a></li>
</ul>
</li>
<li><a class="reference internal" href="#connection-plugins" id="id9">Connection Plugins</a></li>
<li><a class="reference internal" href="#lookup-plugins" id="id10">Lookup Plugins</a></li>
<li><a class="reference internal" href="#vars-plugins" id="id11">Vars Plugins</a></li>
<li><a class="reference internal" href="#filter-plugins" id="id12">Filter Plugins</a></li>
<li><a class="reference internal" href="#test-plugins" id="id13">Test Plugins</a></li>
<li><a class="reference internal" href="#distributing-plugins" id="id14">Distributing Plugins</a></li>
</ul>
</li>
</ul>
</div>
<p>Plugins are pieces of code that augment Ansible&#8217;s core functionality. Ansible ships with a number of handy plugins, and you can easily write your own.</p>
<p>The following types of plugins are available:</p>
<ul class="simple">
<li><em>Action</em> plugins are front ends to modules and can execute actions on the controller before calling the modules themselves.</li>
<li><em>Cache</em> plugins are used to keep a cache of &#8216;facts&#8217; to avoid costly fact-gathering operations.</li>
<li><em>Callback</em> plugins enable you to hook into Ansible events for display or logging purposes.</li>
<li><em>Connection</em> plugins define how to communicate with inventory hosts.</li>
<li><em>Filters</em> plugins allow you to manipulate data inside Ansible plays and/or templates. This is a Jinja2 feature; Ansible ships extra filter plugins.</li>
<li><em>Lookup</em> plugins are used to pull data from an external source. These are implemented using a custom Jinja2 function.</li>
<li><em>Strategy</em> plugins control the flow of a play and execution logic.</li>
<li><em>Shell</em> plugins deal with low-level commands and formatting for the different shells Ansible can encounter on remote hosts.</li>
<li><em>Test</em> plugins allow you to validate data inside Ansible plays and/or templates. This is a Jinja2 feature; Ansible ships extra test plugins.</li>
<li><em>Vars</em> plugins inject additional variable data into Ansible runs that did not come from an inventory, playbook, or the command line.</li>
</ul>
<p>This section describes the various types of plugins and how to implement them.</p>
<div class="section" id="callback-plugins">
<span id="developing-callbacks"></span><h6><a class="toc-backref" href="#id4">Callback Plugins</a><a class="headerlink" href="#callback-plugins" title="Permalink to this headline">¶</a></h6>
<p>Callback plugins enable adding new behaviors to Ansible when responding to events. By default, callback plugins control most of the output you see when running the command line programs.</p>
<div class="section" id="example-callback-plugins">
<span id="callback-examples"></span><h7><a class="toc-backref" href="#id5">Example Callback Plugins</a><a class="headerlink" href="#example-callback-plugins" title="Permalink to this headline">¶</a></h7>
<p>Ansible comes with a number of callback plugins that you can look at for examples. These can be found in <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/callback">lib/ansible/plugins/callback</a>.</p>
<p>The <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/callback/log_plays.py">log_plays</a>
callback is an example of how to intercept playbook events to a log
file, and the <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/callback/mail.py">mail</a>
callback sends email when playbooks complete.</p>
<p>The <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/callback/osx_say.py">osx_say</a>
callback provided is particularly entertaining &#8211; it will respond with
computer synthesized speech on OS X in relation to playbook events,
and is guaranteed to entertain and/or annoy coworkers.</p>
</div>
<div class="section" id="configuring-callback-plugins">
<span id="configuring-callbacks"></span><h7><a class="toc-backref" href="#id6">Configuring Callback Plugins</a><a class="headerlink" href="#configuring-callback-plugins" title="Permalink to this headline">¶</a></h7>
<p>You can activate a custom callback by either dropping it into a callback_plugins directory adjacent to your play or inside a role or by putting it in one of the callback directory sources configured in <cite>ansible.cfg</cite>.</p>
<p>Plugins are loaded in alphanumeric order; for example, a plugin implemented in a file named <cite>1_first.py</cite> would run before a plugin file named <cite>2_second.py</cite>.</p>
<p>Most callbacks shipped with Ansible are disabled by default and need to be whitelisted in your <cite>ansible.cfg</cite> file in order to function. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1">#callback_whitelist = timer, mail, mycallbackplugin</span>
</pre></div>
</div>
<div class="section" id="managing-stdout">
<h8><a class="toc-backref" href="#id7">Managing stdout</a><a class="headerlink" href="#managing-stdout" title="Permalink to this headline">¶</a></h8>
<p>You can only have one plugin be the main manager of your console output. If you want to replace the default, you should define CALLBACK_TYPE = stdout in the subclass and then configure the stdout plugin in <cite>ansible.cfg</cite>. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1">#stdout_callback = mycallbackplugin</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="developing-callback-plugins">
<span id="callback-development"></span><h7><a class="toc-backref" href="#id8">Developing Callback Plugins</a><a class="headerlink" href="#developing-callback-plugins" title="Permalink to this headline">¶</a></h7>
<p>Callback plugins are created by creating a new class with the Base(Callbacks) class as the parent:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.plugins.callback</span> <span class="kn">import</span> <span class="n">CallbackBase</span>
<span class="kn">from</span> <span class="nn">ansible</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">C</span>

<span class="k">class</span> <span class="nc">CallbackModule</span><span class="p">(</span><span class="n">CallbackBase</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>From there, override the specific methods from the CallbackBase that you want to provide a callback for. For plugins intended for use with Ansible version 2.0 and later, you should only override methods that start with <cite>v2</cite>. For a complete list of methods that you can override, please see <code class="docutils literal"><span class="pre">__init__.py</span></code> in the <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/callback">lib/ansible/plugins/callback</a> directory.</p>
<p>The following example shows how Ansible&#8217;s timer plugin is implemented:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Make coding more python3-ish</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">)</span>
<span class="vm">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">ansible.plugins.callback</span> <span class="kn">import</span> <span class="n">CallbackBase</span>


<span class="k">class</span> <span class="nc">CallbackModule</span><span class="p">(</span><span class="n">CallbackBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This callback module tells you how long your plays ran for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CALLBACK_VERSION</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">CALLBACK_TYPE</span> <span class="o">=</span> <span class="s1">&#39;aggregate&#39;</span>
    <span class="n">CALLBACK_NAME</span> <span class="o">=</span> <span class="s1">&#39;timer&#39;</span>
    <span class="n">CALLBACK_NEEDS_WHITELIST</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CallbackModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">days_hours_minutes_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">.</span><span class="n">seconds</span> <span class="o">//</span> <span class="mi">60</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span>
        <span class="n">r_seconds</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">seconds</span> <span class="o">-</span> <span class="p">(</span><span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">runtime</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="n">runtime</span><span class="o">.</span><span class="n">seconds</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">r_seconds</span>

    <span class="k">def</span> <span class="nf">playbook_on_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2_playbook_on_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">v2_playbook_on_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="s2">&quot;Playbook run took </span><span class="si">%s</span><span class="s2"> days, </span><span class="si">%s</span><span class="s2"> hours, </span><span class="si">%s</span><span class="s2"> minutes, </span><span class="si">%s</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">days_hours_minutes_seconds</span><span class="p">(</span><span class="n">runtime</span><span class="p">)))</span>
</pre></div>
</div>
<p>Note that the CALLBACK_VERSION and CALLBACK_NAME definitions are required for properly functioning plugins for Ansible &gt;=2.0.</p>
</div>
</div>
<div class="section" id="connection-plugins">
<span id="developing-connection-plugins"></span><h6><a class="toc-backref" href="#id9">Connection Plugins</a><a class="headerlink" href="#connection-plugins" title="Permalink to this headline">¶</a></h6>
<p>By default, Ansible ships with a &#8216;paramiko&#8217; SSH, native ssh (just called &#8216;ssh&#8217;), &#8216;local&#8217; connection type, and there are also some minor players like &#8216;chroot&#8217; and &#8216;jail&#8217;.  All of these can be used in playbooks and with /usr/bin/ansible to decide how you want to talk to remote machines.  The basics of these connection types
are covered in the <a class="reference internal" href="index.html#document-intro_getting_started"><span class="doc">Getting Started</span></a> section.  Should you want to extend Ansible to support other transports (SNMP, Message bus, etc) it&#8217;s as simple as copying the format of one of the existing modules and dropping it into the connection plugins
directory.   The value of &#8216;smart&#8217; for a connection allows selection of paramiko or openssh based on system capabilities, and chooses
&#8216;ssh&#8217; if OpenSSH supports ControlPersist, in Ansible 1.2.1 and later.  Previous versions did not support &#8216;smart&#8217;.</p>
<p>More documentation on writing connection plugins is pending, though you can jump into <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/connection">lib/ansible/plugins/connection</a> and figure things out pretty easily.</p>
</div>
<div class="section" id="lookup-plugins">
<span id="developing-lookup-plugins"></span><h6><a class="toc-backref" href="#id10">Lookup Plugins</a><a class="headerlink" href="#lookup-plugins" title="Permalink to this headline">¶</a></h6>
<p>Lookup plugins are used to pull in data from external data stores. Lookup plugins can be used within playbooks for both looping - playbook language constructs like &#8220;with_fileglob&#8221; and &#8220;with_items&#8221; are implemented via lookup plugins - and to return values into a variable or parameter.</p>
<p>Here&#8217;s a simple lookup plugin implementation - this lookup returns the contents of a text file as a variable:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.errors</span> <span class="kn">import</span> <span class="n">AnsibleError</span><span class="p">,</span> <span class="n">AnsibleParserError</span>
<span class="kn">from</span> <span class="nn">ansible.plugins.lookup</span> <span class="kn">import</span> <span class="n">LookupBase</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">__main__</span> <span class="kn">import</span> <span class="n">display</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ansible.utils.display</span> <span class="kn">import</span> <span class="n">Display</span>
    <span class="n">display</span> <span class="o">=</span> <span class="n">Display</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">LookupModule</span><span class="p">(</span><span class="n">LookupBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
            <span class="n">display</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;File lookup term: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>

            <span class="c1"># Find the file in the expected search path</span>
            <span class="n">lookupfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_file_in_search_path</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
            <span class="n">display</span><span class="o">.</span><span class="n">vvvv</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;File lookup using </span><span class="si">%s</span><span class="s2"> as file&quot;</span> <span class="o">%</span> <span class="n">lookupfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lookupfile</span><span class="p">:</span>
                    <span class="n">contents</span><span class="p">,</span> <span class="n">show_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">.</span><span class="n">_get_file_contents</span><span class="p">(</span><span class="n">lookupfile</span><span class="p">)</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">AnsibleParserError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AnsibleError</span><span class="p">(</span><span class="s2">&quot;could not locate file in lookup: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
<p>An example of how this lookup is called:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
- hosts: all
  vars:
     contents: <span class="s2">&quot;{{ lookup(&#39;file&#39;, &#39;/etc/foo.txt&#39;) }}&quot;</span>

  tasks:

     - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;the value of foo.txt is {{ contents }} as seen today {{ lookup(&#39;pipe&#39;, &#39;date +&quot;</span>%Y-%m-%d<span class="s2">&quot;&#39;) }}&quot;</span>
</pre></div>
</div>
<p>Errors encountered during execution should be returned by raising AnsibleError() with a message describing the error. Any strings returned by your lookup plugin implementation that could ever contain non-ASCII characters must be converted into Python&#8217;s unicode type because the strings will be run through jinja2.  To do this, you can use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.module_utils._text</span> <span class="kn">import</span> <span class="n">to_text</span>
<span class="n">result_string</span> <span class="o">=</span> <span class="n">to_text</span><span class="p">(</span><span class="n">result_string</span><span class="p">)</span>
</pre></div>
</div>
<p>For more example lookup plugins, check out the source code for the lookup plugins that are included with Ansible here: <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/lookup">lib/ansible/plugins/lookup</a>.</p>
<p>For usage examples of lookup plugins, see <a class="reference external" href="http://docs.ansible.com/ansible/playbooks_lookups.html">Using Lookups</a>.</p>
</div>
<div class="section" id="vars-plugins">
<span id="developing-vars-plugins"></span><h6><a class="toc-backref" href="#id11">Vars Plugins</a><a class="headerlink" href="#vars-plugins" title="Permalink to this headline">¶</a></h6>
<p>Playbook constructs like &#8216;host_vars&#8217; and &#8216;group_vars&#8217; work via &#8216;vars&#8217; plugins.  They inject additional variable
data into ansible runs that did not come from an inventory, playbook, or command line.  Note that variables
can also be returned from inventory, so in most cases, you won&#8217;t need to write or understand vars_plugins.</p>
<p>More documentation on writing vars plugins is pending, though you can jump into <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/">lib/ansible/plugins</a> and figure
things out pretty easily.</p>
<p>If you find yourself wanting to write a vars_plugin, it&#8217;s more likely you should write an inventory script instead.</p>
</div>
<div class="section" id="filter-plugins">
<span id="developing-filter-plugins"></span><h6><a class="toc-backref" href="#id12">Filter Plugins</a><a class="headerlink" href="#filter-plugins" title="Permalink to this headline">¶</a></h6>
<p>Filter plugins are used for manipulating data. They are a feature of Jinja2 and are also available in Jinja2 templates used by the <cite>template</cite> module. As with all plugins, they can be easily extended, but instead of having a file for each one you can have several per file. Most of the filter plugins shipped with Ansible reside in a <cite>core.py</cite>.</p>
<p>See <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/filter">lib/ansible/plugins/filter</a> for details.</p>
</div>
<div class="section" id="test-plugins">
<span id="developing-test-plugins"></span><h6><a class="toc-backref" href="#id13">Test Plugins</a><a class="headerlink" href="#test-plugins" title="Permalink to this headline">¶</a></h6>
<p>Test plugins are for verifying data. They are a feature of Jinja2 and are also available in Jinja2 templates used by the <cite>template</cite> module. As with all plugins, they can be easily extended, but instead of having a file for each one you can have several per file. Most of the test plugins shipped with Ansible reside in a <cite>core.py</cite>. These are specially useful in conjunction with some filter plugins like <cite>map</cite> and <cite>select</cite>; they are also available for conditional directives like <cite>when:</cite>.</p>
<p>See <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/test">lib/ansible/plugins/test</a> for details.</p>
</div>
<div class="section" id="distributing-plugins">
<span id="id2"></span><h6><a class="toc-backref" href="#id14">Distributing Plugins</a><a class="headerlink" href="#distributing-plugins" title="Permalink to this headline">¶</a></h6>
<p>Plugins are loaded from the library installed path and the configured plugins directory (check your <cite>ansible.cfg</cite>).
The location can vary depending on how you installed Ansible (pip, rpm, deb, etc) or by the OS/Distribution/Packager.
Plugins are automatically loaded when you have one of the following subfolders adjacent to your playbook or inside a role:</p>
<blockquote>
<div><ul class="simple">
<li>action_plugins</li>
<li>lookup_plugins</li>
<li>callback_plugins</li>
<li>connection_plugins</li>
<li>filter_plugins</li>
<li>strategy_plugins</li>
<li>cache_plugins</li>
<li>test_plugins</li>
<li>shell_plugins</li>
</ul>
</div></blockquote>
<p>When shipped as part of a role, the plugin will be available as soon as the role is called in the play.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>List of built-in modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_api"><span class="doc">Python API</span></a></dt>
<dd>Learn about the Python API for task execution</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_inventory"><span class="doc">Developing Dynamic Inventory Sources</span></a></dt>
<dd>Learn about how to develop dynamic inventory sources</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>Learn about how to write Ansible modules</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Mailing List</a></dt>
<dd>The development mailing list</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-dev_guide/developing_inventory"></span><div class="section" id="developing-dynamic-inventory-sources">
<h5>Developing Dynamic Inventory Sources<a class="headerlink" href="#developing-dynamic-inventory-sources" title="Permalink to this headline">¶</a></h5>
<div class="contents local topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#script-conventions" id="id1">Script Conventions</a></li>
<li><a class="reference internal" href="#tuning-the-external-inventory-script" id="id2">Tuning the External Inventory Script</a></li>
</ul>
</div>
<p>As described in <a class="reference internal" href="index.html#document-intro_dynamic_inventory"><span class="doc">Dynamic Inventory</span></a>, Ansible can pull inventory information from dynamic sources, including cloud sources.</p>
<p>How do we write a new one?</p>
<p>Simple!  We just create a script or program that can print JSON in the right format when fed the proper arguments.
You can do this in any language.</p>
<div class="section" id="script-conventions">
<span id="inventory-script-conventions"></span><h6><a class="toc-backref" href="#id1">Script Conventions</a><a class="headerlink" href="#script-conventions" title="Permalink to this headline">¶</a></h6>
<p>When the external node script is called with the single argument <code class="docutils literal"><span class="pre">--list</span></code>, the script must output a JSON encoded hash/dictionary of all the groups to be managed to stdout. Each group&#8217;s value should be either a hash/dictionary containing a list of each host/IP, potential child groups, and potential group variables, or simply a list of host/IP addresses, like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;databases&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;hosts&quot;</span>: <span class="o">[</span><span class="s2">&quot;host1.example.com&quot;</span>, <span class="s2">&quot;host2.example.com&quot;</span><span class="o">]</span>,
        <span class="s2">&quot;vars&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;a&quot;</span>: <span class="nb">true</span>
        <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&quot;webservers&quot;</span>: <span class="o">[</span><span class="s2">&quot;host2.example.com&quot;</span>, <span class="s2">&quot;host3.example.com&quot;</span><span class="o">]</span>,
    <span class="s2">&quot;atlanta&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;hosts&quot;</span>: <span class="o">[</span><span class="s2">&quot;host1.example.com&quot;</span>, <span class="s2">&quot;host4.example.com&quot;</span>, <span class="s2">&quot;host5.example.com&quot;</span><span class="o">]</span>,
        <span class="s2">&quot;vars&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;b&quot;</span>: <span class="nb">false</span>
        <span class="o">}</span>,
        <span class="s2">&quot;children&quot;</span>: <span class="o">[</span><span class="s2">&quot;marietta&quot;</span>, <span class="s2">&quot;5points&quot;</span><span class="o">]</span>
    <span class="o">}</span>,
    <span class="s2">&quot;marietta&quot;</span>: <span class="o">[</span><span class="s2">&quot;host6.example.com&quot;</span><span class="o">]</span>,
    <span class="s2">&quot;5points&quot;</span>: <span class="o">[</span><span class="s2">&quot;host7.example.com&quot;</span><span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0.</span></p>
</div>
<p>Before version 1.0, each group could only have a list of hostnames/IP addresses, like the webservers, marietta, and 5points groups above.</p>
<p>When called with the arguments <code class="docutils literal"><span class="pre">--host</span> <span class="pre">&lt;hostname&gt;</span></code> (where &lt;hostname&gt; is a host from above), the script must print either an empty JSON
hash/dictionary, or a hash/dictionary of variables to make available to templates and playbooks.  Printing variables is optional,
if the script does not wish to do this, printing an empty hash/dictionary is the way to go:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;favcolor&quot;</span>: <span class="s2">&quot;red&quot;</span>,
    <span class="s2">&quot;ntpserver&quot;</span>: <span class="s2">&quot;wolf.example.com&quot;</span>,
    <span class="s2">&quot;monitoring&quot;</span>: <span class="s2">&quot;pack.example.com&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="tuning-the-external-inventory-script">
<span id="inventory-script-tuning"></span><h6><a class="toc-backref" href="#id2">Tuning the External Inventory Script</a><a class="headerlink" href="#tuning-the-external-inventory-script" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>The stock inventory script system detailed above works for all versions of Ansible, but calling
<code class="docutils literal"><span class="pre">--host</span></code> for every host can be rather expensive,  especially if it involves expensive API calls to
a remote subsystem.  In Ansible
1.3 or later, if the inventory script returns a top level element called &#8220;_meta&#8221;, it is possible
to return all of the host variables in one inventory script call.  When this meta element contains
a value for &#8220;hostvars&#8221;, the inventory script will not be invoked with <code class="docutils literal"><span class="pre">--host</span></code> for each host.  This
results in a significant performance increase for large numbers of hosts, and also makes client
side caching easier to implement for the inventory script.</p>
<p>The data to be added to the top level JSON dictionary looks like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>

    <span class="c1"># results of inventory script as above go here</span>
    <span class="c1"># ...</span>

    <span class="s2">&quot;_meta&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;hostvars&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;moocow.example.com&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;asdf&quot;</span> : <span class="m">1234</span>
            <span class="o">}</span>,
            <span class="s2">&quot;llama.example.com&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;asdf&quot;</span>: <span class="m">5678</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To satisfy the requirements of using <code class="docutils literal"><span class="pre">_meta</span></code>, to prevent ansible from calling your inventory with <code class="docutils literal"><span class="pre">--host</span></code> you must at least populate <code class="docutils literal"><span class="pre">_meta</span></code> with an empty <code class="docutils literal"><span class="pre">hostvars</span></code> dictionary, such as:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>

    <span class="c1"># results of inventory script as above go here</span>
    <span class="c1"># ...</span>

    <span class="s2">&quot;_meta&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;hostvars&quot;</span>: <span class="o">{}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_api"><span class="doc">Python API</span></a></dt>
<dd>Python API to Playbooks and Ad Hoc Task Execution</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>How to develop modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a></dt>
<dd>How to develop plugins</dd>
<dt><a class="reference external" href="https://ansible.com/ansible-tower">Ansible Tower</a></dt>
<dd>REST API endpoint and GUI for Ansible, syncs with dynamic inventory</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Development Mailing List</a></dt>
<dd>Mailing list for development topics</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-dev_guide/developing_core"></span><div class="section" id="developing-the-ansible-core-engine">
<h5>Developing the Ansible Core Engine<a class="headerlink" href="#developing-the-ansible-core-engine" title="Permalink to this headline">¶</a></h5>
<p>Although many of the pieces of the Ansible Core Engine are plugins that can be
swapped out via playbook directives or configuration, there are still pieces
of the Engine that are not modular.  The documents here give insight into how
those pieces work together.</p>
<div class="toctree-wrapper compound">
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_api"><span class="doc">Python API</span></a></dt>
<dd>Learn about the Python API for task execution</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a></dt>
<dd>Learn about developing plugins</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Mailing List</a></dt>
<dd>The development mailing list</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible-devel IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-dev_guide/developing_python3"></span><div class="section" id="ansible-and-python-3">
<h5>Ansible and Python 3<a class="headerlink" href="#ansible-and-python-3" title="Permalink to this headline">¶</a></h5>
<p>Ansible is pursuing a strategy of having one code base that runs on both
Python-2 and Python-3 because we want Ansible to be able to manage a wide
variety of machines.  Contributors to Ansible should be aware of the tips in
this document so that they can write code that will run on the same versions
of Python as the rest of Ansible.</p>
<p>Ansible can be divided into three overlapping pieces for the purposes of
porting:</p>
<ol class="arabic simple">
<li>Controller-side code.  This is the code which runs on the machine where you
invoke <strong class="command">/usr/bin/ansible</strong></li>
<li>Modules.  This is the code which Ansible transmits over the wire and
invokes on the managed machine.</li>
<li>module_utils code.  This is code whose primary purpose is to be used by the
modules to perform tasks.  However, some controller-side code might use
generic functions from here.</li>
</ol>
<p>Much of the knowledge of porting code will be usable on all three of these
pieces but there are some special considerations for some of it as well.
Information that is generally applicable to all three places is located in the
controller-side section.</p>
<div class="section" id="minimum-version-of-python-3-x-and-python-2-x">
<h6>Minimum Version of Python-3.x and Python-2.x<a class="headerlink" href="#minimum-version-of-python-3-x-and-python-2-x" title="Permalink to this headline">¶</a></h6>
<p>In both controller side and module code, we support Python-3.5 or greater and Python-2.6 or
greater.  Python-3.5 was chosen as a minimum because it is the earliest Python-3 version
adopted as the default Python by a Long Term Support (LTS) Linux distribution (in this case, Ubuntu-16.04).
Previous LTS Linux distributions shipped with a Python-2 version which users can rely upon instead of the
Python-3 version.</p>
<p>For Python-2, the default is for modules to run on at least Python-2.6.  This allows
users with older distributions that are stuck on Python-2.6 to manage their
machines.  Modules are allowed to drop support for Python-2.6 when one of
their dependent libraries requires a higher version of Python.  This is not an
invitation to add unnecessary dependent libraries in order to force your
module to be usable only with a newer version of Python; instead it is an
acknowledgment that some libraries (for instance, boto3 and docker-py) will
only function with a newer version of Python.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Python-2.4 Module-side Support:</p>
<p class="last">Support for Python-2.4 and Python-2.5 was dropped in Ansible-2.4.  RHEL-5
(and its rebuilds like CentOS-5) were supported until April of 2017.
Ansible-2.3 was released in April of 2017 and was the last Ansible release
to support Python-2.4 on the module-side.</p>
</div>
</div>
<div class="section" id="porting-controller-code-to-python-3">
<h6>Porting Controller Code to Python 3<a class="headerlink" href="#porting-controller-code-to-python-3" title="Permalink to this headline">¶</a></h6>
<p>Most of the general tips for porting code to be used on both Python-2 and
Python-3 applies to porting controller code.  The best place to start learning
to port code is <a class="reference external" href="http://python3porting.com/">Lennart Regebro&#8217;s book: Porting to Python 3</a>.</p>
<p>The book describes several strategies for porting to Python 3.  The one we&#8217;re
using is <a class="reference external" href="http://python3porting.com/strategies.html#python-2-and-python-3-without-conversion">to support Python-2 and Python-3 from a single code base</a></p>
<div class="section" id="controller-string-strategy">
<h7>Controller String Strategy<a class="headerlink" href="#controller-string-strategy" title="Permalink to this headline">¶</a></h7>
<div class="section" id="background">
<h8>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h8>
<p>One of the most essential things to decide upon for porting code to Python-3
is what string model to use.  Strings can be an array of bytes (like in C) or
they can be an array of text.  Text is what we think of as letters, digits,
numbers, other printable symbols, and a small number of unprintable &#8220;symbols&#8221;
(control codes).</p>
<p>In Python-2, the two types for these (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.6)"><code class="xref py py-class docutils literal"><span class="pre">str</span></code></a> for bytes and
<code class="xref py py-class docutils literal"><span class="pre">unicode</span></code> for text) are often used interchangeably.  When dealing only
with ASCII characters, the strings can be combined, compared, and converted
from one type to another automatically.  When non-ASCII characters are
introduced, Python starts throwing exceptions due to not knowing what encoding
the non-ASCII characters should be in.</p>
<p>Python-3 changes this behavior by making the separation between bytes (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.6)"><code class="xref py py-class docutils literal"><span class="pre">bytes</span></code></a>)
and text (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.6)"><code class="xref py py-class docutils literal"><span class="pre">str</span></code></a>) more strict.  Python will throw an exception when
trying to combine and compare the two types.  The programmer has to explicitly
convert from one type to the other to mix values from each.</p>
<p>This change makes it immediately apparent to the programmer when code is
mixing the types inappropriately, rather than working until one of their users
causes an exception by entering non-ASCII input.  However, it forces the
programmer to proactively define a strategy for working with strings in their
program so that they don&#8217;t mix text and byte strings unintentionally.</p>
</div>
<div class="section" id="unicode-sandwich">
<h8>Unicode Sandwich<a class="headerlink" href="#unicode-sandwich" title="Permalink to this headline">¶</a></h8>
<p>In controller-side code we use a strategy known as the Unicode Sandwich (named
after Python-2&#8217;s <code class="xref py py-class docutils literal"><span class="pre">unicode</span></code> text type).  For Unicode Sandwich we know that
at the border of our code and the outside world (for example, file and network IO,
environment variables, and some library calls) we are going to receive bytes.
We need to transform these bytes into text and use that throughout the
internal portions of our code.  When we have to send those strings back out to
the outside world we first convert the text back into bytes.
To visualize this, imagine a &#8216;sandwich&#8217; consisting of a top and bottom layer
of bytes, a layer of conversion between, and all text type in the center.</p>
</div>
<div class="section" id="common-borders">
<h8>Common Borders<a class="headerlink" href="#common-borders" title="Permalink to this headline">¶</a></h8>
<p>This is a partial list of places where we have to convert to and from bytes.
It&#8217;s not exhaustive but gives you an idea of where to watch for problems.</p>
<div class="section" id="reading-and-writing-to-files">
<h9>Reading and writing to files<a class="headerlink" href="#reading-and-writing-to-files" title="Permalink to this headline">¶</a></h9>
<p>In Python-2, reading from files yields bytes.  In Python-3, it can yield text.
To make code that&#8217;s portable to both we don&#8217;t make use of Python-3&#8217;s ability
to yield text but instead do the conversion explicitly ourselves. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.module_utils._text</span> <span class="kn">import</span> <span class="n">to_text</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;filename-with-utf8-data.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">my_file</span><span class="p">:</span>
    <span class="n">b_data</span> <span class="o">=</span> <span class="n">my_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">to_text</span><span class="p">(</span><span class="n">b_data</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;surrogate_or_strict&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="c1"># Handle the exception gracefully -- usually by displaying a good</span>
        <span class="c1"># user-centric error message that can be traced back to this piece</span>
        <span class="c1"># of code.</span>
        <span class="k">pass</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Much of Ansible assumes that all encoded text is UTF-8.  At some
point, if there is demand for other encodings we may change that, but for
now it is safe to assume that bytes are UTF-8.</p>
</div>
<p>Writing to files is the opposite process:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.module_utils._text</span> <span class="kn">import</span> <span class="n">to_bytes</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;filename.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">my_file</span><span class="p">:</span>
    <span class="n">my_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">some_text_string</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that we don&#8217;t have to catch <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#UnicodeError" title="(in Python v3.6)"><code class="xref py py-exc docutils literal"><span class="pre">UnicodeError</span></code></a> here because we&#8217;re
transforming to UTF-8 and all text strings in Python can be transformed back
to UTF-8.</p>
</div>
<div class="section" id="filesystem-interaction">
<h9>Filesystem Interaction<a class="headerlink" href="#filesystem-interaction" title="Permalink to this headline">¶</a></h9>
<p>Dealing with filenames often involves dropping back to bytes because on UNIX-like
systems filenames are bytes.  On Python-2, if we pass a text string to these
functions, the text string will be converted to a byte string inside of the
function and a traceback will occur if non-ASCII characters are present.  In
Python-3, a traceback will only occur if the text string can&#8217;t be decoded in
the current locale, but it&#8217;s still good to be explicit and have code which
works on both versions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">from</span> <span class="nn">ansible.module_utils._text</span> <span class="kn">import</span> <span class="n">to_bytes</span>

<span class="n">filename</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;/var/tmp/くらとみ.txt&#39;</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="n">b_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>When you are only manipulating a filename as a string without talking to the
filesystem (or a C library which talks to the filesystem) you can often get
away without converting to bytes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os.path</span>

<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/var/tmp/café&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;くらとみ&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/var/tmp/café/くらとみ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>On the other hand, if the code needs to manipulate the filename and also talk
to the filesystem, it can be more convenient to transform to bytes right away
and manipulate in bytes.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure all variables passed to a function are the same type.
If you&#8217;re working with something like <a class="reference external" href="https://docs.python.org/3/library/os.path.html#os.path.join" title="(in Python v3.6)"><code class="xref py py-func docutils literal"><span class="pre">os.path.join()</span></code></a> which takes
multiple strings and uses them in combination, you need to make sure that
all the types are the same (either all bytes or all text).  Mixing
bytes and text will cause tracebacks.</p>
</div>
</div>
<div class="section" id="interacting-with-other-programs">
<h9>Interacting with Other Programs<a class="headerlink" href="#interacting-with-other-programs" title="Permalink to this headline">¶</a></h9>
<p>Interacting with other programs goes through the operating system and
C libraries and operates on things that the UNIX kernel defines.  These
interfaces are all byte-oriented so the Python interface is byte oriented as
well.  On both Python-2 and Python-3, byte strings should be given to Python&#8217;s
subprocess library and byte strings should be expected back from it.</p>
<p>One of the main places in Ansible&#8217;s controller code that we interact with
other programs is the connection plugins&#8217; <code class="docutils literal"><span class="pre">exec_command</span></code> methods.  These
methods transform any text strings they receive in the command (and arguments
to the command) to execute into bytes and return stdout and stderr as byte strings
Higher level functions (like action plugins&#8217; <code class="docutils literal"><span class="pre">_low_level_execute_command</span></code>)
transform the output into text strings.</p>
</div>
</div>
</div>
<div class="section" id="tips-tricks-and-idioms-to-adopt">
<h7>Tips, tricks, and idioms to adopt<a class="headerlink" href="#tips-tricks-and-idioms-to-adopt" title="Permalink to this headline">¶</a></h7>
<div class="section" id="forwards-compatibility-boilerplate">
<h8>Forwards Compatibility Boilerplate<a class="headerlink" href="#forwards-compatibility-boilerplate" title="Permalink to this headline">¶</a></h8>
<p>Use the following boilerplate code at the top of all controller-side modules
to make certain constructs act the same way on Python-2 and Python-3:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Make coding more python3-ish</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">)</span>
<span class="vm">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">__metaclass__</span> <span class="pre">=</span> <span class="pre">type</span></code> makes all classes defined in the file into new-style
classes without explicitly inheriting from <a class="reference external" href="https://docs.python.org/3/library/functions.html#object" title="(in Python v3.6)"><code class="xref py py-class docutils literal"><span class="pre">object</span></code></a>.</p>
<p>The <code class="docutils literal"><span class="pre">__future__</span></code> imports do the following:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">absolute_import:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body">Makes imports look in <code class="xref py py-attr docutils literal"><span class="pre">sys.path</span></code> for the modules being
imported, skipping the directory in which the module doing the importing
lives.  If the code wants to use the directory in which the module doing
the importing, there&#8217;s a new dot notation to do so.</td>
</tr>
<tr class="field-even field"><th class="field-name">division:</th><td class="field-body">Makes division of integers always return a float.  If you need to
find the quotient use <code class="docutils literal"><span class="pre">x</span> <span class="pre">//</span> <span class="pre">y</span></code> instead of <code class="docutils literal"><span class="pre">x</span> <span class="pre">/</span> <span class="pre">y</span></code>.</td>
</tr>
<tr class="field-odd field"><th class="field-name">print_function:</th><td class="field-body">Changes <a class="reference external" href="https://docs.python.org/3/library/functions.html#print" title="(in Python v3.6)"><code class="xref py py-func docutils literal"><span class="pre">print()</span></code></a> from a keyword into a function.</td>
</tr>
</tbody>
</table>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0328/#guido-s-decision">PEP 0328: Absolute Imports</a></li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0238">PEP 0238: Division</a></li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-3105">PEP 3105: Print function</a></li>
</ul>
</div>
</div>
<div class="section" id="prefix-byte-strings-with-b">
<h8>Prefix byte strings with &#8220;b_&#8221;<a class="headerlink" href="#prefix-byte-strings-with-b" title="Permalink to this headline">¶</a></h8>
<p>Since mixing text and bytes types leads to tracebacks we want to be clear
about what variables hold text and what variables hold bytes.  We do this by
prefixing any variable holding bytes with <code class="docutils literal"><span class="pre">b_</span></code>.  For instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;/var/tmp/café.txt&#39;</span>
<span class="n">b_filename</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">b_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>We do not prefix the text strings instead because we only operate
on byte strings at the borders, so there are fewer variables that need bytes
than text.</p>
</div>
<div class="section" id="bundled-six">
<h8>Bundled six<a class="headerlink" href="#bundled-six" title="Permalink to this headline">¶</a></h8>
<p>The third-party <a class="reference external" href="https://pythonhosted.org/six/">python-six</a> library exists
to help projects create code that runs on both Python-2 and Python-3.  Ansible
includes a version of the library in module_utils so that other modules can use it
without requiring that it is installed on the remote system.  To make use of
it, import it like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.module_utils</span> <span class="kn">import</span> <span class="n">six</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Ansible can also use a system copy of six</p>
<p class="last">Ansible will use a system copy of six if the system copy is a later
version than the one Ansible bundles.</p>
</div>
</div>
<div class="section" id="exceptions">
<h8>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this headline">¶</a></h8>
<p>In order for code to function on Python-2.6+ and Python-3, use the
new exception-catching syntax which uses the <code class="docutils literal"><span class="pre">as</span></code> keyword:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="mi">0</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Tried to divide by zero: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>Do <strong>not</strong> use the following syntax as it will fail on every version of Python-3:</p>
<div class="highlight-python2"><div class="highlight"><pre><span></span>try:
    a = 2/0
except ValueError, e:
    module.fail_json(msg=&quot;Tried to divide by zero: %s&quot; % e)
</pre></div>
</div>
</div>
<div class="section" id="octal-numbers">
<h8>Octal numbers<a class="headerlink" href="#octal-numbers" title="Permalink to this headline">¶</a></h8>
<p>In Python-2.x, octal literals could be specified as <code class="docutils literal"><span class="pre">0755</span></code>.  In Python-3,
octals must be specified as <code class="docutils literal"><span class="pre">0o755</span></code>.</p>
</div>
<div class="section" id="string-formatting">
<h8>String formatting<a class="headerlink" href="#string-formatting" title="Permalink to this headline">¶</a></h8>
<div class="section" id="str-format-compatibility">
<h9>str.format() compatibility<a class="headerlink" href="#str-format-compatibility" title="Permalink to this headline">¶</a></h9>
<p>Starting in Python-2.6, strings gained a method called <code class="docutils literal"><span class="pre">format()</span></code> to put
strings together.  However, one commonly used feature of <code class="docutils literal"><span class="pre">format()</span></code> wasn&#8217;t
added until Python-2.7, so you need to remember not to use it in Ansible code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Does not work in Python-2.6!</span>
<span class="n">new_string</span> <span class="o">=</span> <span class="s2">&quot;Dear {}, Welcome to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

<span class="c1"># Use this instead</span>
<span class="n">new_string</span> <span class="o">=</span> <span class="s2">&quot;Dear {0}, Welcome to {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
</pre></div>
</div>
<p>Both of the format strings above map positional arguments of the <code class="docutils literal"><span class="pre">format()</span></code>
method into the string.  However, the first version doesn&#8217;t work in
Python-2.6.  Always remember to put numbers into the placeholders so the code
is compatible with Python-2.6.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">Python documentation on <a class="reference external" href="https://docs.python.org/2/library/string.html#formatstrings">format strings</a></p>
</div>
</div>
<div class="section" id="use-percent-format-with-byte-strings">
<h9>Use percent format with byte strings<a class="headerlink" href="#use-percent-format-with-byte-strings" title="Permalink to this headline">¶</a></h9>
<p>In Python-3.x, byte strings do not have a <code class="docutils literal"><span class="pre">format()</span></code> method.  However, it
does have support for the older, percent-formatting.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">b_command_line</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;ansible-playbook --become-user </span><span class="si">%s</span><span class="s1"> -K </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">playbook_file</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Percent formatting added in Python-3.5</p>
<p class="last">Percent formatting of byte strings was added back into Python3 in 3.5.
This isn&#8217;t a problem for us because Python-3.5 is our minimum version.
However, if you happen to be testing Ansible code with Python-3.4 or
earlier, you will find that the byte string formatting here won&#8217;t work.
Upgrade to Python-3.5 to test.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">Python documentation on <a class="reference external" href="https://docs.python.org/2/library/stdtypes.html#string-formatting">percent formatting</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="porting-modules-to-python-3">
<h6>Porting Modules to Python 3<a class="headerlink" href="#porting-modules-to-python-3" title="Permalink to this headline">¶</a></h6>
<p>Ansible modules are slightly harder to port than normal code from other
projects. A lot of mocking has to go into unit testing an Ansible module so
it&#8217;s harder to test that your porting has fixed everything or to to make sure
that later commits haven&#8217;t regressed the Python-3 support.</p>
<div class="section" id="module-string-strategy">
<h7>Module String Strategy<a class="headerlink" href="#module-string-strategy" title="Permalink to this headline">¶</a></h7>
<p>There are a large number of modules in Ansible.  Most of those are maintained
by the Ansible community at large, not by a centralized team.  To make life
easier on them, it was decided not to break backwards compatibility by
mandating that all strings inside of modules are text and converting between
text and bytes at the borders; instead, we&#8217;re using a native string strategy
for now.</p>
<p>Native strings refer to the type that Python uses when you specify a bare
string literal:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="s2">&quot;This is a native string&quot;</span>
</pre></div>
</div>
<p>In Python-2, these are byte strings.  In Python-3 these are text strings.  The
module_utils shipped with Ansible attempts to accept native strings as input
to its functions and emit native strings as their output.  Modules should be
coded to expect bytes on Python-2 and text on Python-3.</p>
</div>
<div class="section" id="id1">
<h7>Tips, tricks, and idioms to adopt<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h7>
<div class="section" id="python-2-4-compatible-exception-syntax">
<h8>Python-2.4 Compatible Exception Syntax<a class="headerlink" href="#python-2-4-compatible-exception-syntax" title="Permalink to this headline">¶</a></h8>
<p>Until Ansible-2.4, modules needed to be compatible with Python-2.4 as
well.  Python-2.4 did not understand the new exception-catching syntax so
we had to write a compatibility function that could work with both
Python-2 and Python-3.  You may still see this used in some modules:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.module_utils.pycompat24</span> <span class="kn">import</span> <span class="n">get_exception</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="mi">0</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Tried to divide by zero: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>Unless a change is going to be backported to Ansible-2.3, you should not
have to use this in new code.</p>
</div>
<div class="section" id="python-2-4-octal-workaround">
<h8>Python 2.4 octal workaround<a class="headerlink" href="#python-2-4-octal-workaround" title="Permalink to this headline">¶</a></h8>
<p>Before Ansible-2.4, modules had to be compatible with Python-2.4.
Python-2.4 did not understand the new syntax for octal literals so we used
the following workaround to specify octal values:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Can&#39;t use 0755 on Python-3 and can&#39;t use 0o755 on Python-2.4</span>
<span class="n">EXECUTABLE_PERMS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;0755&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
<p>Unless a change is going to be backported to Ansible-2.3, you should not
have to use this in new code.</p>
</div>
</div>
</div>
<div class="section" id="porting-module-utils-code-to-python-3">
<h6>Porting module_utils code to Python 3<a class="headerlink" href="#porting-module-utils-code-to-python-3" title="Permalink to this headline">¶</a></h6>
<p>module_utils code is largely like module code.  However, some pieces of it are
used by the controller as well.  Because of this, it needs to be usable with
the controller&#8217;s assumptions.  This is most notable in the string strategy.</p>
<div class="section" id="module-utils-string-strategy">
<h7>Module_utils String Strategy<a class="headerlink" href="#module-utils-string-strategy" title="Permalink to this headline">¶</a></h7>
<p>Module_utils <strong>must</strong> use the Native String Strategy.  Functions in
module_utils receive either text strings or byte strings and may emit either
the same type as they were given or the native string for the Python version
they are run on depending on which makes the most sense for that function.
Functions which return strings <strong>must</strong> document whether they return text,
byte, or native strings. Module-utils functions are therefore often very
defensive in nature, converting from potential text or bytes at the
beginning of a function and converting to the native string type at the end.</p>
</div>
</div>
</div>
<span id="document-dev_guide/developing_api"></span><div class="section" id="python-api">
<h5><a class="toc-backref" href="#id2">Python API</a><a class="headerlink" href="#python-api" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This document is out of date: &#8216;ansible.parsing.dataloader&#8217; and &#8216;ansible.runner&#8217; are not available in the current version of Ansible.</p>
</div>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#python-api" id="id2">Python API</a><ul>
<li><a class="reference internal" href="#python-api-2-0" id="id3">Python API 2.0</a></li>
<li><a class="reference internal" href="#python-api-pre-2-0" id="id4">Python API pre 2.0</a><ul>
<li><a class="reference internal" href="#detailed-api-example" id="id5">Detailed API Example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>Please note that while we make this API available it is not intended for direct consumption, it is here
for the support of the Ansible command line tools. We try not to make breaking changes but we reserve the
right to do so at any time if it makes sense for the Ansible toolset.</p>
<p>The following documentation is provided for those that still want to use the API directly, but be mindful this is not something the Ansible team supports.</p>
<p>There are several interesting ways to use Ansible from an API perspective.   You can use
the Ansible python API to control nodes, you can extend Ansible to respond to various python events, you can
write various plugins, and you can plug in inventory data from external data sources.  This document
covers the execution and Playbook API at a basic level.</p>
<p>If you are looking to use Ansible programmatically from something other than Python, trigger events asynchronously,
or have access control and logging demands, take a look at <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a>
as it has a very nice REST API that provides all of these things at a higher level.</p>
<p>Ansible is written in its own API so you have a considerable amount of power across the board.
This chapter discusses the Python API.</p>
<p id="id1">The Python API is very powerful, and is how the all the ansible CLI tools are implemented.
In version 2.0 the core ansible got rewritten and the API was mostly rewritten.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible relies on forking processes, as such the API is not thread safe.</p>
</div>
<div class="section" id="python-api-2-0">
<span id="python-api-20"></span><h6><a class="toc-backref" href="#id3">Python API 2.0</a><a class="headerlink" href="#python-api-2-0" title="Permalink to this headline">¶</a></h6>
<p>In 2.0 things get a bit more complicated to start, but you end up with much more discrete and readable classes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

import json
from collections import namedtuple
from ansible.parsing.dataloader import DataLoader
from ansible.vars import VariableManager
from ansible.inventory import Inventory
from ansible.playbook.play import Play
from ansible.executor.task_queue_manager import TaskQueueManager
from ansible.plugins.callback import CallbackBase

class ResultCallback<span class="o">(</span>CallbackBase<span class="o">)</span>:
    <span class="s2">&quot;&quot;&quot;A sample callback plugin used for performing an action as results come in</span>

<span class="s2">    If you want to collect all results into a single object for processing at</span>
<span class="s2">    the end of the execution, look into utilizing the ``json`` callback plugin</span>
<span class="s2">    or writing your own custom callback plugin</span>
<span class="s2">    &quot;&quot;&quot;</span>
    def v2_runner_on_ok<span class="o">(</span>self, result, **kwargs<span class="o">)</span>:
        <span class="s2">&quot;&quot;&quot;Print a json representation of the result</span>

<span class="s2">        This method could store the result in an instance attribute for retrieval later</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="nv">host</span> <span class="o">=</span> result._host
        print json.dumps<span class="o">({</span>host.name: result._result<span class="o">}</span>, <span class="nv">indent</span><span class="o">=</span><span class="m">4</span><span class="o">)</span>

<span class="nv">Options</span> <span class="o">=</span> namedtuple<span class="o">(</span><span class="s1">&#39;Options&#39;</span>, <span class="o">[</span><span class="s1">&#39;connection&#39;</span>, <span class="s1">&#39;module_path&#39;</span>, <span class="s1">&#39;forks&#39;</span>, <span class="s1">&#39;become&#39;</span>, <span class="s1">&#39;become_method&#39;</span>, <span class="s1">&#39;become_user&#39;</span>, <span class="s1">&#39;check&#39;</span><span class="o">])</span>
<span class="c1"># initialize needed objects</span>
<span class="nv">variable_manager</span> <span class="o">=</span> VariableManager<span class="o">()</span>
<span class="nv">loader</span> <span class="o">=</span> DataLoader<span class="o">()</span>
<span class="nv">options</span> <span class="o">=</span> Options<span class="o">(</span><span class="nv">connection</span><span class="o">=</span><span class="s1">&#39;local&#39;</span>, <span class="nv">module_path</span><span class="o">=</span><span class="s1">&#39;/path/to/mymodules&#39;</span>, <span class="nv">forks</span><span class="o">=</span><span class="m">100</span>, <span class="nv">become</span><span class="o">=</span>None, <span class="nv">become_method</span><span class="o">=</span>None, <span class="nv">become_user</span><span class="o">=</span>None, <span class="nv">check</span><span class="o">=</span>False<span class="o">)</span>
<span class="nv">passwords</span> <span class="o">=</span> dict<span class="o">(</span><span class="nv">vault_pass</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="o">)</span>

<span class="c1"># Instantiate our ResultCallback for handling results as they come in</span>
<span class="nv">results_callback</span> <span class="o">=</span> ResultCallback<span class="o">()</span>

<span class="c1"># create inventory and pass to var manager</span>
<span class="nv">inventory</span> <span class="o">=</span> Inventory<span class="o">(</span><span class="nv">loader</span><span class="o">=</span>loader, <span class="nv">variable_manager</span><span class="o">=</span>variable_manager, <span class="nv">host_list</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="o">)</span>
variable_manager.set_inventory<span class="o">(</span>inventory<span class="o">)</span>

<span class="c1"># create play with tasks</span>
<span class="nv">play_source</span> <span class="o">=</span>  dict<span class="o">(</span>
        <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;Ansible Play&quot;</span>,
        <span class="nv">hosts</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>,
        <span class="nv">gather_facts</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>,
        <span class="nv">tasks</span> <span class="o">=</span> <span class="o">[</span>
            dict<span class="o">(</span><span class="nv">action</span><span class="o">=</span>dict<span class="o">(</span><span class="nv">module</span><span class="o">=</span><span class="s1">&#39;shell&#39;</span>, <span class="nv">args</span><span class="o">=</span><span class="s1">&#39;ls&#39;</span><span class="o">)</span>, <span class="nv">register</span><span class="o">=</span><span class="s1">&#39;shell_out&#39;</span><span class="o">)</span>,
            dict<span class="o">(</span><span class="nv">action</span><span class="o">=</span>dict<span class="o">(</span><span class="nv">module</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>, <span class="nv">args</span><span class="o">=</span>dict<span class="o">(</span><span class="nv">msg</span><span class="o">=</span><span class="s1">&#39;{{shell_out.stdout}}&#39;</span><span class="o">)))</span>
         <span class="o">]</span>
    <span class="o">)</span>
<span class="nv">play</span> <span class="o">=</span> Play<span class="o">()</span>.load<span class="o">(</span>play_source, <span class="nv">variable_manager</span><span class="o">=</span>variable_manager, <span class="nv">loader</span><span class="o">=</span>loader<span class="o">)</span>

<span class="c1"># actually run it</span>
<span class="nv">tqm</span> <span class="o">=</span> None
try:
    <span class="nv">tqm</span> <span class="o">=</span> TaskQueueManager<span class="o">(</span>
              <span class="nv">inventory</span><span class="o">=</span>inventory,
              <span class="nv">variable_manager</span><span class="o">=</span>variable_manager,
              <span class="nv">loader</span><span class="o">=</span>loader,
              <span class="nv">options</span><span class="o">=</span>options,
              <span class="nv">passwords</span><span class="o">=</span>passwords,
              <span class="nv">stdout_callback</span><span class="o">=</span>results_callback,  <span class="c1"># Use our custom callback instead of the ``default`` callback plugin</span>
          <span class="o">)</span>
    <span class="nv">result</span> <span class="o">=</span> tqm.run<span class="o">(</span>play<span class="o">)</span>
finally:
    <span class="k">if</span> tqm is not None:
        tqm.cleanup<span class="o">()</span>
</pre></div>
</div>
</div>
<div class="section" id="python-api-pre-2-0">
<span id="python-api-old"></span><h6><a class="toc-backref" href="#id4">Python API pre 2.0</a><a class="headerlink" href="#python-api-pre-2-0" title="Permalink to this headline">¶</a></h6>
<p>It&#8217;s pretty simple:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>import ansible.runner

<span class="nv">runner</span> <span class="o">=</span> ansible.runner.Runner<span class="o">(</span>
   <span class="nv">module_name</span><span class="o">=</span><span class="s1">&#39;ping&#39;</span>,
   <span class="nv">module_args</span><span class="o">=</span><span class="s1">&#39;&#39;</span>,
   <span class="nv">pattern</span><span class="o">=</span><span class="s1">&#39;web*&#39;</span>,
   <span class="nv">forks</span><span class="o">=</span><span class="m">10</span>
<span class="o">)</span>
<span class="nv">datastructure</span> <span class="o">=</span> runner.run<span class="o">()</span>
</pre></div>
</div>
<p>The run method returns results per host, grouped by whether they
could be contacted or not.  Return types are module specific, as
expressed in the <a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a> documentation.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;dark&quot;</span> : <span class="o">{</span>
       <span class="s2">&quot;web1.example.com&quot;</span> : <span class="s2">&quot;failure message&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;contacted&quot;</span> : <span class="o">{</span>
       <span class="s2">&quot;web2.example.com&quot;</span> : <span class="m">1</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>A module can return any type of JSON data it wants, so Ansible can
be used as a framework to rapidly build powerful applications and scripts.</p>
<div class="section" id="detailed-api-example">
<span id="detailed-api-old-example"></span><h7><a class="toc-backref" href="#id5">Detailed API Example</a><a class="headerlink" href="#detailed-api-example" title="Permalink to this headline">¶</a></h7>
<p>The following script prints out the uptime information for all hosts:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

import ansible.runner
import sys

<span class="c1"># construct the ansible runner and execute on all hosts</span>
<span class="nv">results</span> <span class="o">=</span> ansible.runner.Runner<span class="o">(</span>
    <span class="nv">pattern</span><span class="o">=</span><span class="s1">&#39;*&#39;</span>, <span class="nv">forks</span><span class="o">=</span><span class="m">10</span>,
    <span class="nv">module_name</span><span class="o">=</span><span class="s1">&#39;command&#39;</span>, <span class="nv">module_args</span><span class="o">=</span><span class="s1">&#39;/usr/bin/uptime&#39;</span>,
<span class="o">)</span>.run<span class="o">()</span>

<span class="k">if</span> results is None:
   print <span class="s2">&quot;No hosts found&quot;</span>
   sys.exit<span class="o">(</span><span class="m">1</span><span class="o">)</span>

print <span class="s2">&quot;UP ***********&quot;</span>
<span class="k">for</span> <span class="o">(</span>hostname, result<span class="o">)</span> in results<span class="o">[</span><span class="s1">&#39;contacted&#39;</span><span class="o">]</span>.items<span class="o">()</span>:
    <span class="k">if</span> not <span class="s1">&#39;failed&#39;</span> in result:
        print <span class="s2">&quot;%s &gt;&gt;&gt; %s&quot;</span> % <span class="o">(</span>hostname, result<span class="o">[</span><span class="s1">&#39;stdout&#39;</span><span class="o">])</span>

print <span class="s2">&quot;FAILED *******&quot;</span>
<span class="k">for</span> <span class="o">(</span>hostname, result<span class="o">)</span> in results<span class="o">[</span><span class="s1">&#39;contacted&#39;</span><span class="o">]</span>.items<span class="o">()</span>:
    <span class="k">if</span> <span class="s1">&#39;failed&#39;</span> in result:
        print <span class="s2">&quot;%s &gt;&gt;&gt; %s&quot;</span> % <span class="o">(</span>hostname, result<span class="o">[</span><span class="s1">&#39;msg&#39;</span><span class="o">])</span>

print <span class="s2">&quot;DOWN *********&quot;</span>
<span class="k">for</span> <span class="o">(</span>hostname, result<span class="o">)</span> in results<span class="o">[</span><span class="s1">&#39;dark&#39;</span><span class="o">]</span>.items<span class="o">()</span>:
    print <span class="s2">&quot;%s &gt;&gt;&gt; %s&quot;</span> % <span class="o">(</span>hostname, result<span class="o">)</span>
</pre></div>
</div>
<p>Advanced programmers may also wish to read the source to ansible itself,
for it uses the API (with all available options) to implement the <code class="docutils literal"><span class="pre">ansible</span></code>
command line tools (<code class="docutils literal"><span class="pre">lib/ansible/cli/</span></code>).</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_inventory"><span class="doc">Developing Dynamic Inventory Sources</span></a></dt>
<dd>Developing dynamic inventory integrations</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_modules"><span class="doc">Developing Modules</span></a></dt>
<dd>How to develop modules</dd>
<dt><a class="reference internal" href="index.html#document-dev_guide/developing_plugins"><span class="doc">Developing Plugins</span></a></dt>
<dd>How to develop plugins</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Development Mailing List</a></dt>
<dd>Mailing list for development topics</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-dev_guide/developing_rebasing"></span><div class="section" id="rebasing-a-pull-request">
<h5>Rebasing a Pull Request<a class="headerlink" href="#rebasing-a-pull-request" title="Permalink to this headline">¶</a></h5>
<p>You may find that your pull request (PR) is out-of-date and needs to be rebased. This can happen for several reasons:</p>
<ul class="simple">
<li>Files modified in your PR are in conflict with changes which have already been merged.</li>
<li>Your PR is old enough that significant changes to automated test infrastructure have occurred.</li>
</ul>
<p>Rebasing the branch used to create your PR will resolve both of these issues.</p>
<div class="section" id="configuring-your-remotes">
<h6>Configuring Your Remotes<a class="headerlink" href="#configuring-your-remotes" title="Permalink to this headline">¶</a></h6>
<p>Before you can rebase your PR, you need to make sure you have the proper remotes configured.
Assuming you cloned your fork in the usual fashion, the <code class="docutils literal"><span class="pre">origin</span></code> remote will point to your fork:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git remote -v
origin  git@github.com:YOUR_GITHUB_USERNAME/ansible.git <span class="o">(</span>fetch<span class="o">)</span>
origin  git@github.com:YOUR_GITHUB_USERNAME/ansible.git <span class="o">(</span>push<span class="o">)</span>
</pre></div>
</div>
<p>However, you also need to add a remote which points to the upstream repository:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git remote add upstream https://github.com/ansible/ansible.git
</pre></div>
</div>
<p>Which should leave you with the following remotes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git remote -v
origin  git@github.com:YOUR_GITHUB_USERNAME/ansible.git <span class="o">(</span>fetch<span class="o">)</span>
origin  git@github.com:YOUR_GITHUB_USERNAME/ansible.git <span class="o">(</span>push<span class="o">)</span>
upstream        https://github.com/ansible/ansible.git <span class="o">(</span>fetch<span class="o">)</span>
upstream        https://github.com/ansible/ansible.git <span class="o">(</span>push<span class="o">)</span>
</pre></div>
</div>
<p>Checking the status of your branch should show you&#8217;re up-to-date with your fork at the <code class="docutils literal"><span class="pre">origin</span></code> remote:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git status
On branch YOUR_BRANCH
Your branch is up-to-date with <span class="s1">&#39;origin/YOUR_BRANCH&#39;</span>.
nothing to commit, working tree clean
</pre></div>
</div>
</div>
<div class="section" id="rebasing-your-branch">
<h6>Rebasing Your Branch<a class="headerlink" href="#rebasing-your-branch" title="Permalink to this headline">¶</a></h6>
<p>Once you have an <code class="docutils literal"><span class="pre">upstream</span></code> remote configured, you can rebase the branch for your PR:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git pull --rebase upstream devel
</pre></div>
</div>
<p>This will replay the changes in your branch on top of the changes made in the upstream <code class="docutils literal"><span class="pre">devel</span></code> branch.
If there are merge conflicts, you will be prompted to resolve those before you can continue.</p>
<p>Once you&#8217;ve rebased, the status of your branch will have changed:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git status
On branch YOUR_BRANCH
Your branch and <span class="s1">&#39;origin/YOUR_BRANCH&#39;</span> have diverged,
and have <span class="m">4</span> and <span class="m">1</span> different commits each, respectively.
  <span class="o">(</span>use <span class="s2">&quot;git pull&quot;</span> to merge the remote branch into yours<span class="o">)</span>
nothing to commit, working tree clean
</pre></div>
</div>
<p>Don&#8217;t worry, this is normal after a rebase. You should ignore the <code class="docutils literal"><span class="pre">git</span> <span class="pre">status</span></code> instructions to use <code class="docutils literal"><span class="pre">git</span> <span class="pre">pull</span></code>.
We&#8217;ll cover what to do next in the following section.</p>
</div>
<div class="section" id="updating-your-pull-request">
<h6>Updating Your Pull Request<a class="headerlink" href="#updating-your-pull-request" title="Permalink to this headline">¶</a></h6>
<p>Now that you&#8217;ve rebased your branch, you need to push your changes to GitHub to update your PR.</p>
<p>Since rebasing re-writes git history, you will need to use a force push:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git push --force
</pre></div>
</div>
<p>Your PR on GitHub has now been updated. This will automatically trigger testing of your changes.
You should check in on the status of your PR after tests have completed to see if further changes are required.</p>
</div>
<div class="section" id="getting-help-rebasing">
<h6>Getting Help Rebasing<a class="headerlink" href="#getting-help-rebasing" title="Permalink to this headline">¶</a></h6>
<p>For help with rebasing your PR, or other development related questions, join us on our #ansible-devel IRC chat channel
on <a class="reference external" href="https://freenode.net">freenode.net</a>.</p>
</div>
</div>
<span id="document-dev_guide/testing"></span><div class="section" id="testing-ansible">
<h5><a class="toc-backref" href="#id1">Testing Ansible</a><a class="headerlink" href="#testing-ansible" title="Permalink to this headline">¶</a></h5>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#testing-ansible" id="id1">Testing Ansible</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#types-of-tests" id="id3">Types of tests</a></li>
<li><a class="reference internal" href="#testing-within-github-shippable" id="id4">Testing within GitHub &amp; Shippable</a><ul>
<li><a class="reference internal" href="#organization" id="id5">Organization</a></li>
<li><a class="reference internal" href="#rerunning-a-failing-ci-job" id="id6">Rerunning a failing CI job</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-test-a-pr" id="id7">How to test a PR</a><ul>
<li><a class="reference internal" href="#setup-checking-out-a-pull-request" id="id8">Setup: Checking out a Pull Request</a></li>
<li><a class="reference internal" href="#testing-the-pull-request" id="id9">Testing the Pull Request</a></li>
</ul>
</li>
<li><a class="reference internal" href="#want-to-know-more-about-testing" id="id10">Want to know more about testing?</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h6><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h6>
<p>This document describes:</p>
<ul class="simple">
<li>how Ansible is tested</li>
<li>how to test Ansible locally</li>
<li>how to extend the testing capabilities</li>
</ul>
</div>
<div class="section" id="types-of-tests">
<h6><a class="toc-backref" href="#id3">Types of tests</a><a class="headerlink" href="#types-of-tests" title="Permalink to this headline">¶</a></h6>
<p>At a high level we have the following classifications of tests:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">compile:</th><td class="field-body"><ul class="first simple">
<li><a class="reference internal" href="index.html#document-dev_guide/testing_compile"><span class="doc">Compile Tests</span></a></li>
<li>Test python code against a variety of Python versions.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">sanity:</th><td class="field-body"><ul class="first simple">
<li><a class="reference internal" href="index.html#document-dev_guide/testing_sanity"><span class="doc">Sanity Tests</span></a></li>
<li>Sanity tests are made up of scripts and tools used to perform static code analysis.</li>
<li>The primary purpose of these tests is to enforce Ansible coding standards and requirements.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">integration:</th><td class="field-body"><ul class="first simple">
<li><a class="reference internal" href="index.html#document-dev_guide/testing_integration"><span class="doc">Integration tests</span></a></li>
<li>Functional tests of modules and Ansible core functionality.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">units:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference internal" href="index.html#document-dev_guide/testing_units"><span class="doc">Unit Tests</span></a></li>
<li>Tests directly against individual parts of the code base.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>If you&#8217;re a developer, one of the most valuable things you can do is look at the GitHub issues list and help fix bugs.  We almost always prioritize bug fixing over feature development, so helping to fix bugs is one of the best things you can do.</p>
<p>Even if you&#8217;re not a developer, helping to test pull requests for bug fixes and features is still immensely valuable.</p>
</div>
<div class="section" id="testing-within-github-shippable">
<h6><a class="toc-backref" href="#id4">Testing within GitHub &amp; Shippable</a><a class="headerlink" href="#testing-within-github-shippable" title="Permalink to this headline">¶</a></h6>
<div class="section" id="organization">
<h7><a class="toc-backref" href="#id5">Organization</a><a class="headerlink" href="#organization" title="Permalink to this headline">¶</a></h7>
<p>When Pull Requests (PRs) are created they are tested using Shippable, a Continuous Integration (CI) tool. Results are shown at the end of every PR.</p>
<p>When Shippable detects an error and it can be linked back to a file that has been modified in the PR then the relevant lines will be added as a GitHub comment. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>The <span class="nb">test</span> <span class="sb">`</span>ansible-test sanity --test pep8<span class="sb">`</span> failed with the following errors:

lib/ansible/modules/network/foo/bar.py:509:17: E265 block comment should start with <span class="s1">&#39;# &#39;</span>

The <span class="nb">test</span> <span class="sb">`</span>ansible-test sanity --test validate-modules<span class="sb">`</span> failed with the following errors:
lib/ansible/modules/network/foo/bar.py:0:0: E307 version_added should be <span class="m">2</span>.4. Currently <span class="m">2</span>.3
lib/ansible/modules/network/foo/bar.py:0:0: E316 ANSIBLE_METADATA.metadata_version: required key not provided @ data<span class="o">[</span><span class="s1">&#39;metadata_version&#39;</span><span class="o">]</span>. Got None
</pre></div>
</div>
<p>From the above example we can see that <code class="docutils literal"><span class="pre">--test</span> <span class="pre">pep8</span></code> and <code class="docutils literal"><span class="pre">--test</span> <span class="pre">validate-modules</span></code> have identified issues. The commands given allow you to run the same tests locally to ensure you&#8217;ve fixed the issues without having to push your changed to GitHub and wait for Shippable, for example:</p>
<p>If you haven&#8217;t already got Ansible available, use the local checkout by running:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">source</span> hacking/env-setup
</pre></div>
</div>
<p>Then run the tests detailed in the GitHub comment:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-test sanity --test pep8
ansible-test sanity --test validate-modules
</pre></div>
</div>
<p>If there isn&#8217;t a GitHub comment stating what&#8217;s failed you can inspect the results by clicking on the &#8220;Details&#8221; button under the &#8220;checks have failed&#8221; message at the end of the PR.</p>
</div>
<div class="section" id="rerunning-a-failing-ci-job">
<h7><a class="toc-backref" href="#id6">Rerunning a failing CI job</a><a class="headerlink" href="#rerunning-a-failing-ci-job" title="Permalink to this headline">¶</a></h7>
<p>Occasionally you may find your PR fails due to a reason unrelated to your change. This could happen for several reasons, including:</p>
<ul class="simple">
<li>a temporary issue accessing an external resource, such as a yum or git repo</li>
<li>a timeout creating a virtual machine to run the tests on</li>
</ul>
<p>If either of these issues appear to be the case, you can rerun the Shippable test by:</p>
<ul class="simple">
<li>closing and re-opening the PR</li>
<li>making another change to the PR and pushing to GitHub</li>
</ul>
<p>If the issue persists, please contact us in <code class="docutils literal"><span class="pre">#ansible-devel</span></code> on Freenode IRC.</p>
</div>
</div>
<div class="section" id="how-to-test-a-pr">
<h6><a class="toc-backref" href="#id7">How to test a PR</a><a class="headerlink" href="#how-to-test-a-pr" title="Permalink to this headline">¶</a></h6>
<p>If you&#8217;re a developer, one of the most valuable things you can do is look at the GitHub issues list and help fix bugs.  We almost always prioritize bug fixing over feature development, so helping to fix bugs is one of the best things you can do.</p>
<p>Even if you&#8217;re not a developer, helping to test pull requests for bug fixes and features is still immensely valuable.</p>
<p>Ideally, code should add tests that prove that the code works. That&#8217;s not always possible and tests are not always comprehensive, especially when a user doesn&#8217;t have access to a wide variety of platforms, or is using an API or web service. In these cases, live testing against real equipment can be more valuable than automation that runs against simulated interfaces. In any case, things should always be tested manually the first time as well.</p>
<p>Thankfully, helping to test Ansible is pretty straightforward, assuming you are familiar with how Ansible works.</p>
<div class="section" id="setup-checking-out-a-pull-request">
<h7><a class="toc-backref" href="#id8">Setup: Checking out a Pull Request</a><a class="headerlink" href="#setup-checking-out-a-pull-request" title="Permalink to this headline">¶</a></h7>
<p>You can do this by:</p>
<ul class="simple">
<li>checking out Ansible</li>
<li>making a test branch off the main branch</li>
<li>merging a GitHub issue</li>
<li>testing</li>
<li>commenting on that particular issue on GitHub</li>
</ul>
<p>Here&#8217;s how:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Testing source code from GitHub pull requests sent to us does have some inherent risk, as the source code
sent may have mistakes or malicious code that could have a negative impact on your system. We recommend
doing all testing on a virtual machine, whether a cloud instance, or locally.  Some users like Vagrant
or Docker for this, but they are optional. It is also useful to have virtual machines of different Linux or
other flavors, since some features (apt vs. yum, for example) are specific to those OS versions.</p>
</div>
<p>Create a fresh area to work:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/ansible/ansible.git ansible-pr-testing
<span class="nb">cd</span> ansible-pr-testing
</pre></div>
</div>
<p>Next, find the pull request you&#8217;d like to test and make note of the line at the top which describes the source
and destination repositories. It will look something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Someuser wants to merge <span class="m">1</span> commit into ansible:devel from someuser:feature_branch_name
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Only test <code class="docutils literal"><span class="pre">ansible:devel</span></code></p>
<p class="last">It is important that the PR request target be <code class="docutils literal"><span class="pre">ansible:devel</span></code>, as we do not accept pull requests into any other branch. Dot releases are cherry-picked manually by Ansible staff.</p>
</div>
<p>The username and branch at the end are the important parts, which will be turned into git commands as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git checkout -b testing_PRXXXX devel
git pull https://github.com/someuser/ansible.git feature_branch_name
</pre></div>
</div>
<p>The first command creates and switches to a new branch named <code class="docutils literal"><span class="pre">testing_PRXXXX</span></code>, where the XXXX is the actual issue number associated with the pull request (for example, 1234). This branch is based on the <code class="docutils literal"><span class="pre">devel</span></code> branch. The second command pulls the new code from the users feature branch into the newly created branch.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the GitHub user interface shows that the pull request will not merge cleanly, we do not recommend proceeding if you are not somewhat familiar with git and coding, as you will have to resolve a merge conflict. This is the responsibility of the original pull request contributor.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some users do not create feature branches, which can cause problems when they have multiple, unrelated commits in their version of <code class="docutils literal"><span class="pre">devel</span></code>. If the source looks like <code class="docutils literal"><span class="pre">someuser:devel</span></code>, make sure there is only one commit listed on the pull request.</p>
</div>
<p>The Ansible source includes a script that allows you to use Ansible directly from source without requiring a
full installation that is frequently used by developers on Ansible.</p>
<p>Simply source it (to use the Linux/Unix terminology) to begin using it immediately:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">source</span> ./hacking/env-setup
</pre></div>
</div>
<p>This script modifies the <code class="docutils literal"><span class="pre">PYTHONPATH</span></code> environment variables (along with a few other things), which will be temporarily
set as long as your shell session is open.</p>
</div>
<div class="section" id="testing-the-pull-request">
<h7><a class="toc-backref" href="#id9">Testing the Pull Request</a><a class="headerlink" href="#testing-the-pull-request" title="Permalink to this headline">¶</a></h7>
<p>At this point, you should be ready to begin testing!</p>
<p>Some ideas of what to test are:</p>
<ul class="simple">
<li>Create a test Playbook with the examples in and check if they function correctly</li>
<li>Test to see if any Python backtraces returned (that&#8217;s a bug)</li>
<li>Test on different operating systems, or against different library versions</li>
</ul>
<p>Any potential issues should be added as comments on the pull request (and it&#8217;s acceptable to comment if the feature works as well), remembering to include the output of <code class="docutils literal"><span class="pre">ansible</span> <span class="pre">--version</span></code></p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Works <span class="k">for</span> me! Tested on <span class="sb">`</span>Ansible <span class="m">2</span>.3.0<span class="sb">`</span>.  I verified this on CentOS <span class="m">6</span>.5 and also Ubuntu <span class="m">14</span>.04.
</pre></div>
</div>
<p>If the PR does not resolve the issue, or if you see any failures from the unit/integration tests, just include that output instead:</p>
<blockquote>
<div><div class="line-block">
<div class="line">This doesn&#8217;t work for me.</div>
<div class="line"><br /></div>
<div class="line">When I ran this Ubuntu 16.04 it failed with the following:</div>
<div class="line"><br /></div>
<div class="line-block">
<div class="line">```</div>
<div class="line">some output</div>
<div class="line">StrackTrace</div>
<div class="line">some other output</div>
<div class="line">```</div>
</div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="want-to-know-more-about-testing">
<h6><a class="toc-backref" href="#id10">Want to know more about testing?</a><a class="headerlink" href="#want-to-know-more-about-testing" title="Permalink to this headline">¶</a></h6>
<p>If you&#8217;d like to know more about the plans for improving testing Ansible then why not join the <a class="reference external" href="https://github.com/ansible/community/blob/master/meetings/README.md">Testing Working Group</a>.</p>
</div>
</div>
<span id="document-dev_guide/repomerge"></span><div class="section" id="repo-merge">
<h5>Repo Merge<a class="headerlink" href="#repo-merge" title="Permalink to this headline">¶</a></h5>
<div class="section" id="background">
<h6>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h6>
<p>On Tuesday 6th December 2016, the Ansible Core Team re-merged the module repositories back into <a class="reference external" href="https://github.com/ansible/ansible/">ansible/ansible</a> in GitHub. The two module repos will be essentially locked, though they will be kept in place for the existing 2.1 and 2.2 dependencies. Once 2.2 moves out of official support (early 2018), these repositories will be fully readonly for all branches. Until then, any issues/PRs opened there will be auto-closed with a note to open it on <a class="reference external" href="https://github.com/ansible/ansible/">ansible/ansible</a>.</p>
</div>
<div class="section" id="why-are-we-doing-this-again">
<h6>Why Are We Doing This (Again...)?<a class="headerlink" href="#why-are-we-doing-this-again" title="Permalink to this headline">¶</a></h6>
<p>For those who&#8217;ve been using Ansible long enough, you know that originally we started with a single repository. The original intention of the core vs. extras split was that core would be better supported/tested/etc. Extras would have been a bit more of a &#8220;wild-west&#8221; for modules, to allow new modules to make it into the distribution more quickly. Unfortunately this never really worked out, as well as the following:</p>
<ol class="arabic simple">
<li>Many modules in the core repo were also essentially &#8220;grand-fathered&#8221; in, despite not having a good set of tests or dedicated maintainers from the community.</li>
<li>The time in queue for modules to be merged into extras was not really any different from the time to merge modules into core.</li>
<li>The split introduced a few other problems for contributors such as having to submit multiple related PRs for modules with tests, or for those which rely on action plugins.</li>
<li>git submodules are notoriously complicated, even for contributors with decent git experience. The constant need to update git submodule pointers for devel and each stable branch can lead to testing surprises and really buys us nothing in terms of flexibility.</li>
<li>Users can already be confused about where to open issues, especially when the problem appears to be with a module but is actually an action plugin (ie. template) or something more fundamental like includes. Having everything back in one repo makes it easier to link issues, and you&#8217;re always sure to open a bug report in the right place.</li>
</ol>
</div>
<div class="section" id="metadata-support-ownership-and-module-status">
<h6>Metadata - Support/Ownership and Module Status<a class="headerlink" href="#metadata-support-ownership-and-module-status" title="Permalink to this headline">¶</a></h6>
<p>As part of this move, we will be introducing module metadata, which will contain a couple of pieces of information regarding modules:</p>
<ol class="arabic simple">
<li>Support Status: This field indicates who supports the module, whether it&#8217;s the core team, the community, the person who wrote it, or if it is an abandoned module which is not receiving regular updates. The Ansible team has gone through the list of modules and we have marked about 100 of them as &#8220;Core Supported&#8221;, meaning a member of the Ansible core team should be actively fixing bugs on those modules. The vast majority of the rest will be community supported. This is not really a change from the status quo, this just makes it clearer.</li>
<li>Module Status: This field indicates how well supported that module may be. This generally applies to the maturity of the module&#8217;s parameters, however, not necessarily its bug status.</li>
</ol>
<p>The documentation pages for modules will be updated to reflect the above information as well, so that users can evaluate the status of a module before committing to using it in playbooks and roles.</p>
</div>
<div class="section" id="move-issues-and-prs-to-new-repo">
<span id="prmover"></span><h6>Move Issues and PRs to new Repo<a class="headerlink" href="#move-issues-and-prs-to-new-repo" title="Permalink to this headline">¶</a></h6>
<p>A tool has been developed to move a PR from the old repos to <cite>ansible/ansible</cite> this can be found at <a class="reference external" href="https://prmover.pythonanywhere.com/">prmover tool</a></p>
<p>Before using prmover please ensure you have a fork of the Ansible repo.</p>
<p>To move issues please use <a class="reference external" href="https://github-issue-mover.appspot.com/">GitHub Issue Mover</a></p>
<p>If you have <em>any</em> issues with updating your PR please ask for support in <cite>#ansible-devel</cite></p>
<p>For support please use <cite>#ansible-devel</cite> on Freenode IRC</p>
</div>
</div>
<span id="document-release_and_maintenance"></span><div class="section" id="release-and-maintenance">
<h5>Release and maintenance<a class="headerlink" href="#release-and-maintenance" title="Permalink to this headline">¶</a></h5>
<div class="contents local topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#release-cycle" id="id7">Release cycle</a></li>
<li><a class="reference internal" href="#release-status" id="id8">Release status</a></li>
<li><a class="reference internal" href="#development-and-stable-version-maintenance-workflow" id="id9">Development and stable version maintenance workflow</a><ul>
<li><a class="reference internal" href="#release-candidates" id="id10">Release candidates</a></li>
<li><a class="reference internal" href="#feature-freeze" id="id11">Feature freeze</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="release-cycle">
<span id="schedule"></span><h6><a class="toc-backref" href="#id7">Release cycle</a><a class="headerlink" href="#release-cycle" title="Permalink to this headline">¶</a></h6>
<p>Ansible is developed and released on a flexible 4 months release cycle.
This cycle can be extended in order to allow for larger changes to be properly
implemented and tested before a new release is made available.</p>
<p>Ansible supports the two most recent major stable releases.
For more information, read about the
<a class="reference internal" href="#development-and-stable-version-maintenance-workflow">development and stable version maintenance workflow</a>.</p>
<p>If you are using a release of Ansible that is no longer supported, we strongly
encourage you to upgrade as soon as possible in order to benefit from the
latest features and security fixes.</p>
<p>Older unsupported versions of Ansible can contain unfixed security
vulnerabilities (<em>CVE</em>).</p>
<p>You can refer to the <a class="reference external" href="https://docs.ansible.com/ansible/porting_guide_2.0.html">porting guide</a> for tips on updating your Ansible
playbooks to run on newer versions.</p>
</div>
<div class="section" id="release-status">
<h6><a class="toc-backref" href="#id8">Release status</a><a class="headerlink" href="#release-status" title="Permalink to this headline">¶</a></h6>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="33%" />
<col width="47%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Ansible release</th>
<th class="head">Latest version</th>
<th class="head">Status</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>devel</td>
<td><a class="reference external" href="https://github.com/ansible/ansible/blob/devel/CHANGELOG.md">2.4</a> (unreleased, trunk)</td>
<td>In development</td>
</tr>
<tr class="row-odd"><td>2.3</td>
<td><a class="reference external" href="https://github.com/ansible/ansible/blob/stable-2.3/CHANGELOG.md">2.3.2</a> (2017-08-08)</td>
<td>Supported (bug <strong>and</strong> security fixes)</td>
</tr>
<tr class="row-even"><td>2.2</td>
<td><a class="reference external" href="https://github.com/ansible/ansible/blob/stable-2.2/CHANGELOG.md">2.2.3</a> (2017-05-09)</td>
<td>Supported (<strong>only</strong> security fixes)</td>
</tr>
<tr class="row-odd"><td>2.1</td>
<td><a class="reference external" href="https://github.com/ansible/ansible/blob/stable-2.1/CHANGELOG.md">2.1.6</a> (2017-06-01)</td>
<td>Unsupported (end of life)</td>
</tr>
<tr class="row-even"><td>2.0</td>
<td><a class="reference external" href="https://github.com/ansible/ansible/blob/stable-2.0/CHANGELOG.md">2.0.2</a> (2016-04-19)</td>
<td>Unsupported (end of life)</td>
</tr>
<tr class="row-odd"><td>1.9</td>
<td><a class="reference external" href="https://github.com/ansible/ansible/blob/stable-1.9/CHANGELOG.md">1.9.6</a> (2016-04-15)</td>
<td>Unsupported (end of life)</td>
</tr>
<tr class="row-even"><td>&lt;1.9</td>
<td>n/a</td>
<td>Unsupported (end of life)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="development-and-stable-version-maintenance-workflow">
<span id="methods"></span><span id="support-life"></span><h6><a class="toc-backref" href="#id9">Development and stable version maintenance workflow</a><a class="headerlink" href="#development-and-stable-version-maintenance-workflow" title="Permalink to this headline">¶</a></h6>
<p>The Ansible community develops and maintains Ansible on <a class="reference external" href="https://github.com/ansible/ansible">GitHub</a>.</p>
<p>New modules, plugins, features and bugfixes will always be integrated in what
will become the next major version of Ansible.
This work is tracked on the <code class="docutils literal"><span class="pre">devel</span></code> git branch.</p>
<p>Ansible provides bugfixes and security improvements for the most recent major
release while the previous major release will only receive security patches.
This work is tracked on the <code class="docutils literal"><span class="pre">stable-&lt;version&gt;</span></code> git branches.</p>
<p>The fixes that land in supported stable branches will eventually be released
as a new version when necessary.</p>
<p>For more information on the changes included in each new version, you can refer
to the <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/CHANGELOG.md">changelog</a>, available on GitHub.</p>
<p>Note that while there are no guarantees for providing fixes for unsupported
releases of Ansible, there can sometimes be exceptions for critical issues.</p>
<div class="section" id="release-candidates">
<h7><a class="toc-backref" href="#id10">Release candidates</a><a class="headerlink" href="#release-candidates" title="Permalink to this headline">¶</a></h7>
<p>Before a new release or version of Ansible can be done, it will typically go
through a release candidate process.</p>
<p>This provides the Ansible community the opportunity to test Ansible and report
bugs or issues they might come across.</p>
<p>Ansible tags the first release candidate (<code class="docutils literal"><span class="pre">RC1</span></code>) which is usually scheduled
to last five business days. The final release is done if no major bugs or
issues are identified during this period.</p>
<p>If there are major problems with the first candidate, a second candidate will
be tagged (<code class="docutils literal"><span class="pre">RC2</span></code>) once the necessary fixes have landed.
This second candidate lasts for a shorter duration than the first.
If no problems have been reported after two business days, the final release is
done.</p>
<p>More release candidates can be tagged as required, so long as there are
bugs that the Ansible core maintainers consider should be fixed before the
final release.</p>
</div>
<div class="section" id="feature-freeze">
<span id="freezing"></span><h7><a class="toc-backref" href="#id11">Feature freeze</a><a class="headerlink" href="#feature-freeze" title="Permalink to this headline">¶</a></h7>
<p>While there is a pending release candidate, the focus of core developers and
maintainers will on fixes towards the release candidate.</p>
<p>Merging new features or fixes that are not related to the release candidate may
be delayed in order to allow the new release to be shipped as soon as possible.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-committer_guidelines"><span class="doc">Committers Guidelines (for people with commit rights to Ansible on GitHub)</span></a></dt>
<dd>Guidelines for Ansible core contributors and maintainers</dd>
<dt><a class="reference internal" href="index.html#document-test_strategies"><span class="doc">Testing Strategies</span></a></dt>
<dd>Testing strategies</dd>
<dt><a class="reference internal" href="index.html#document-community"><span class="doc">Community Information &amp; Contributing</span></a></dt>
<dd>Community information and contributing</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible/blob/devel/CHANGELOG.md">Ansible Changelog</a></dt>
<dd>Documentation of the improvements for each version of Ansible</dd>
<dt><a class="reference external" href="https://releases.ansible.com/ansible/">Ansible release tarballs</a></dt>
<dd>Ansible release tarballs</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Development Mailing List</a></dt>
<dd>Mailing list for development topics</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-committer_guidelines"></span><div class="section" id="committers-guidelines-for-people-with-commit-rights-to-ansible-on-github">
<h5>Committers Guidelines (for people with commit rights to Ansible on GitHub)<a class="headerlink" href="#committers-guidelines-for-people-with-commit-rights-to-ansible-on-github" title="Permalink to this headline">¶</a></h5>
<p>These are the guidelines for people with commit access to Ansible. Committers are essentially acting as members of the Ansible Core team, although not necessarily as an employee of Ansible and Red Hat. Please read the guidelines before you commit.</p>
<p>These guidelines apply to everyone. At the same time, this ISN’T a process document. So just use good judgement. You’ve been given commit access because we trust your judgement.</p>
<p>That said, use the trust wisely.</p>
<p>If you abuse the trust and break components and builds, etc., the trust level falls and you may be asked not to commit or you may lose access to do so.</p>
<div class="section" id="features-high-level-design-and-roadmap">
<h6>Features, High Level Design, and Roadmap<a class="headerlink" href="#features-high-level-design-and-roadmap" title="Permalink to this headline">¶</a></h6>
<p>As a core team member, you are an integral part of the team that develops the roadmap. Please be engaged, and push for the features and fixes that you want to see. Also keep in mind that Red Hat, as a company, will commit to certain features, fixes, APIs, etc. for various releases. Red Hat, the company, and the Ansible team must get these committed features (etc.) completed and released as scheduled. Obligations to users, the community, and customers must come first. Because of these commitments, a feature you want to develop yourself may not get into a release if it impacts a lot of other parts within Ansible.</p>
<p>Any other new features and changes to high level design should go through the proposal process (TBD), to ensure the community and core team have had a chance to review the idea and approve it. The core team has sole responsibility for merging new features based on proposals.</p>
</div>
<div class="section" id="our-workflow-on-github">
<h6>Our Workflow on GitHub<a class="headerlink" href="#our-workflow-on-github" title="Permalink to this headline">¶</a></h6>
<p>As a committer, you may already know this, but our workflow forms a lot of our team policies. Please ensure you’re aware of the following workflow steps:</p>
<ul class="simple">
<li>Fork the repository upon which you want to do some work to your own personal repository</li>
<li>Work on the specific branch upon which you need to commit</li>
<li>Create a Pull Request back to the Ansible repository and tag the people you would like to review; assign someone as the primary “owner” of your request</li>
<li>Adjust code as necessary based on the Comments provided</li>
<li>Ask someone on the Core Team to do a final review and merge</li>
</ul>
<div class="section" id="addendum-to-workflow-for-committers">
<h7>Addendum to workflow for Committers:<a class="headerlink" href="#addendum-to-workflow-for-committers" title="Permalink to this headline">¶</a></h7>
<p>The Core Team is aware that this can be a difficult process at times. Sometimes, the team breaks the rules: Direct commits, merging their own PRs. This section is a set of guidelines. If you’re changing a comma in a doc, or making a very minor change, you can use your best judgement. This is another trust thing. The process is critical for any major change, but for little things or getting something done quickly, use your best judgement and make sure people on the team are aware of your work.</p>
</div>
</div>
<div class="section" id="roles-on-core">
<h6>Roles on Core<a class="headerlink" href="#roles-on-core" title="Permalink to this headline">¶</a></h6>
<ul class="simple">
<li>Core Committers: Fine to do PRs for most things, but we should have a timebox. Hanging PRs may merge on the judgement of these devs.</li>
<li>Module Owners: Module Owners own specific modules and have indirect commit access via the current module PR mechanisms.</li>
</ul>
</div>
<div class="section" id="general-rules">
<h6>General Rules<a class="headerlink" href="#general-rules" title="Permalink to this headline">¶</a></h6>
<p>Individuals with direct commit access to ansible/ansible are entrusted with powers that allow them to do a broad variety of things&#8211;probably more than we can write down. Rather than rules, treat these as general <em>guidelines</em>, individuals with this power are expected to use their best judgement.</p>
<ul class="simple">
<li>Don’t<ul>
<li>Commit directly.</li>
<li>Merge your own PRs. Someone else should have a chance to review and approve the PR merge. If you are a Core Committer, you have a small amount of leeway here for very minor changes.</li>
<li>Forget about alternate environments. Consider the alternatives&#8211;yes, people have bad environments, but they are the ones who need us the most.</li>
<li>Drag your community team members down. Always discuss the technical merits, but you should never address the person’s limitations (you can later go for beers and call them idiots, but not in IRC/Github/etc.).</li>
<li>Forget about the maintenance burden. Some things are really cool to have, but they might not be worth shoehorning in if the maintenance burden is too great.</li>
<li>Break playbooks. Always keep backwards compatibility in mind.</li>
<li>Forget to keep it simple. Complexity breeds all kinds of problems.</li>
</ul>
</li>
<li>Do<ul>
<li>Squash, avoid merges whenever possible, use github&#8217;s squash commits or cherry pick if needed (bisect thanks you).</li>
<li>Be active. Committers who have no activity on the project (through merges, triage, commits, etc.) will have their permissions suspended.</li>
<li>Consider backwards compatibility (goes back to &#8220;don’t break existing playbooks&#8221;).</li>
<li>Write tests. PRs with tests are looked at with more priority than PRs without tests that should have them included. While not all changes require tests, be sure to add them for bug fixes or functionality changes.</li>
<li>Discuss with other committers, specially when you are unsure of something.</li>
<li>Document! If your PR is a new feature or a change to behavior, make sure you&#8217;ve updated all associated documentation or have notified the right people to do so. It also helps to add the version of Core against which this documentation is compatible (to avoid confusion with stable versus devel docs, for backwards compatibility, etc.).</li>
<li>Consider scope, sometimes a fix can be generalized</li>
<li>Keep it simple, then things are maintainable, debuggable and intelligible.</li>
</ul>
</li>
</ul>
<p>Committers are expected to continue to follow the same community and contribution guidelines followed by the rest of the Ansible community.</p>
</div>
<div class="section" id="people">
<h6>People<a class="headerlink" href="#people" title="Permalink to this headline">¶</a></h6>
<p>Individuals who&#8217;ve been asked to become a part of this group have generally been contributing in significant ways to the Ansible community for some time. Should they agree, they are requested to add their names and GitHub IDs to this file, in the section below, via a pull request. Doing so indicates that these individuals agree to act in the ways that their fellow committers trust that they will act.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="26%" />
<col width="24%" />
<col width="26%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Github ID</th>
<th class="head">IRC Nick</th>
<th class="head">Other</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>James Cammarata</td>
<td>jimi-c</td>
<td>jimi</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Brian Coca</td>
<td>bcoca</td>
<td>bcoca</td>
<td><a class="reference external" href="mailto:mdyson&#37;&#52;&#48;cyberdyne&#46;com">mdyson<span>&#64;</span>cyberdyne<span>&#46;</span>com</a></td>
</tr>
<tr class="row-even"><td>Matt Davis</td>
<td>nitzmahone</td>
<td>nitzmahone</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Toshio Kuratomi</td>
<td>abadger</td>
<td>abadger1999</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Jason McKerr</td>
<td>mckerrj</td>
<td>newtMcKerr</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Robyn Bergeron</td>
<td>robynbergeron</td>
<td>rbergeron</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Greg DeKoenigsberg</td>
<td>gregdek</td>
<td>gregdek</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Monty Taylor</td>
<td>emonty</td>
<td>mordred</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Matt Martz</td>
<td>sivel</td>
<td>sivel</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Nate Case</td>
<td>qalthos</td>
<td>Qalthos</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>James Tanner</td>
<td>jctanner</td>
<td>jtanner</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Peter Sprygada</td>
<td>privateip</td>
<td>privateip</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Abhijit Menon-Sen</td>
<td>amenonsen</td>
<td>crab</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Michael Scherer</td>
<td>mscherer</td>
<td>misc</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>René Moser</td>
<td>resmo</td>
<td>resmo</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>David Shrewsbury</td>
<td>Shrews</td>
<td>Shrews</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Sandra Wills</td>
<td>docschick</td>
<td>docschick</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Graham Mainwaring</td>
<td>ghjm</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Jon Davila</td>
<td>defionscode</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Chris Houseknecht</td>
<td>chouseknecht</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Trond Hindenes</td>
<td>trondhindenes</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Jon Hawkesworth</td>
<td>jhawkesworth</td>
<td>jhawkesworth</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Will Thames</td>
<td>willthames</td>
<td>willthames</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Ryan Brown</td>
<td>ryansb</td>
<td>ryansb</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Adrian Likins</td>
<td>alikins</td>
<td>alikins</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Dag Wieers</td>
<td>dagwieers</td>
<td>dagwieers</td>
<td><a class="reference external" href="mailto:dag&#37;&#52;&#48;wieers&#46;com">dag<span>&#64;</span>wieers<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
</div>
</div>
<span id="document-dev_guide/style_guide/index"></span><div class="section" id="ansible-style-guide">
<h5>Ansible Style Guide<a class="headerlink" href="#ansible-style-guide" title="Permalink to this headline">¶</a></h5>
<div class="toctree-wrapper compound">
<span id="document-dev_guide/style_guide/why_use"></span><div class="section" id="why-use-a-style-guide">
<h6>Why Use a Style Guide?<a class="headerlink" href="#why-use-a-style-guide" title="Permalink to this headline">¶</a></h6>
<p>Style guides are important because they ensure consistency in the content, look, and feel of a book or a website.</p>
<p>Remember, a style guide is only useful if it is used, updated, and enforced.  Style Guides are useful for engineering-related documentation, sales and marketing materials, support docs, community contributions, and more.</p>
<p>As changes are made to the overall Ansible site design, be sure to update this style guide with those changes. Or, should other resources listed below have major revisions, consider including company information here for ease of reference.</p>
<p>This style guide incorporates current Ansible resources and information so that overall site and documentation consistency can be met.</p>
<blockquote class="note info">

“If you don't find it in the index, look very carefully through the entire catalogue.”
 ― Sears, Roebuck and Co., 1897 Sears Roebuck & Co. Catalogue</blockquote></div>
<span id="document-dev_guide/style_guide/resources"></span><div class="section" id="resources">
<h6>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h6>
<div class="section" id="internal-resources">
<h7>Internal resources<a class="headerlink" href="#internal-resources" title="Permalink to this headline">¶</a></h7>
<ul class="simple">
<li><a class="reference external" href="http://docs.ansible.com/">http://docs.ansible.com/</a></li>
<li><a class="reference external" href="https://sites.google.com/a/ansibleworks.com/ansible-intranet/">https://sites.google.com/a/ansibleworks.com/ansible-intranet/</a></li>
<li>??? intranet Engineering doc???</li>
</ul>
</div>
<div class="section" id="external-resources">
<h7>External Resources<a class="headerlink" href="#external-resources" title="Permalink to this headline">¶</a></h7>
<ul class="simple">
<li>www.apstylebook.com</li>
<li>www.chicagomanualofstyle.org—home.html</li>
<li>www.crockford.com—style.html</li>
<li>orwell.ru—index.htm</li>
<li>www.sun.com—sun_tech_pub.xml</li>
<li>webopedia.internet.com</li>
<li>www.computeruser.com—index.html</li>
</ul>
</div>
</div>
<span id="document-dev_guide/style_guide/basic_rules"></span><div class="section" id="basic-rules">
<h6>Basic Rules<a class="headerlink" href="#basic-rules" title="Permalink to this headline">¶</a></h6>
<div class="section" id="use-standard-american-english">
<h7>Use Standard American English<a class="headerlink" href="#use-standard-american-english" title="Permalink to this headline">¶</a></h7>
<p>Ansible has customers/users all around the globe, but the headquarters is in Durham, NC, in the US. Use Standard American English rather than other variations of the English language.</p>
</div>
<div class="section" id="write-for-a-global-audience">
<h7>Write for a Global Audience<a class="headerlink" href="#write-for-a-global-audience" title="Permalink to this headline">¶</a></h7>
<p>The idea behind global writing is that everything you say should be understandable by those of many different backgrounds and cultures. References, therefore, should be as universal as possible. Avoid idioms and regionalism and maintain a neutral tone that cannot be misinterpreted. Avoid attempts at humor.</p>
</div>
<div class="section" id="follow-naming-conventions">
<h7>Follow Naming Conventions<a class="headerlink" href="#follow-naming-conventions" title="Permalink to this headline">¶</a></h7>
<p>Always follow naming conventions and trademarks. If you aren&#8217;t sure how a product should be properly referred to, ask the Engineering Product Manager of that product line (ansible-core or Tower) for information.</p>
</div>
<div class="section" id="important-information-first">
<h7>Important Information First<a class="headerlink" href="#important-information-first" title="Permalink to this headline">¶</a></h7>
<p>Important information stated at the beginning of a sentence makes it easier to understand.</p>
<blockquote>
<div><p>Unclear:
The unwise walking about upon the area near the cliff edge may result in a dangerous fall and therefore it is recommended that one remains a safe distance to maintain personal safety.</p>
<p>Clearer:
Danger! Stay away from cliff.</p>
</div></blockquote>
</div>
<div class="section" id="sentence-structure">
<h7>Sentence Structure<a class="headerlink" href="#sentence-structure" title="Permalink to this headline">¶</a></h7>
<p>Good sentence structure helps convey information. Try to keep the most important information towards the beginning of the sentence.</p>
<blockquote>
<div><p>Bad:
Furthermore, large volumes of water are also required for the process of extraction.</p>
<p>Better:
Extraction also requires large volumes of water.</p>
</div></blockquote>
</div>
<div class="section" id="avoid-padding">
<h7>Avoid padding<a class="headerlink" href="#avoid-padding" title="Permalink to this headline">¶</a></h7>
<p>When reading a piece of technical writing, the audience does not benefit from elaborate prose. They just need information on how to perform a task. Avoid using padding, or filler. Don&#8217;t use phrases such as, kind of, sort of, and essentially.</p>
</div>
<div class="section" id="avoid-redundant-prepositional-phrases">
<h7>Avoid redundant prepositional phrases<a class="headerlink" href="#avoid-redundant-prepositional-phrases" title="Permalink to this headline">¶</a></h7>
<p>Prepositional phrases, the combination of a preposition with a noun phrase, are among the worst offenders in making text long and tiresome to read. Often, it is possible to replace an entire phrase with a single word.</p>
<blockquote>
<div>Use now instead of at this point in time.
Use suddenly instead of all of the sudden.</div></blockquote>
</div>
<div class="section" id="avoid-verbosity">
<h7>Avoid verbosity<a class="headerlink" href="#avoid-verbosity" title="Permalink to this headline">¶</a></h7>
<p>Write short, succinct sentences. Never say, &#8221;...as has been said before,&#8221; &#8221;..each and every,&#8221; &#8221;...point in time,&#8221; etc. Avoid &#8221;...in order to,&#8221; especially at the beginning of sentences. Every word must contribute meaning to the sentence. Technical writing is information delivery.</p>
</div>
<div class="section" id="avoid-pomposity">
<h7>Avoid pomposity<a class="headerlink" href="#avoid-pomposity" title="Permalink to this headline">¶</a></h7>
<p>While it is good to have a wide vocabulary, technical writing is not the place for showing off linguistic abilities. Technical writing is about producing clear, plain instructions for a specific audience.</p>
</div>
<div class="section" id="action-verbs-menus-and-commands">
<h7>Action verbs, menus, and commands<a class="headerlink" href="#action-verbs-menus-and-commands" title="Permalink to this headline">¶</a></h7>
<p>We interact with computers in a variety of ways. You can select anything on an application user interface by selecting it using a keyboard or mouse. It is important to use action verbs and software terminology correctly.</p>
<p>The most frequent verbs used in software are:</p>
<ul class="simple">
<li>Click</li>
<li>Double-click</li>
<li>Select</li>
<li>Type</li>
<li>Press</li>
</ul>
<p>Use of an action verb in a sentence (<strong>bolded</strong> words):</p>
<ol class="arabic simple">
<li>In the dialog box, click <strong>Open</strong>.</li>
<li><strong>Type</strong> a name in the text box.</li>
<li>On the keyboard press <strong>Enter</strong>.</li>
</ol>
<p>Use of menu actions and commands in a sentence:</p>
<ol class="arabic simple">
<li>On the <strong>File</strong> menu, click <strong>Open</strong>.</li>
<li><strong>Type</strong> a name in the <strong>User Name</strong> field.</li>
<li>In the <strong>Open</strong> dialog box, click <strong>Save</strong>.</li>
<li>On the computer keyboard, press <strong>Enter</strong>.</li>
<li>On the toolbar, click the <strong>Open File</strong> icon.</li>
</ol>
<p>Make users aware of where they are in the application. If there is more than one method to perform an action, use the most common method. Define &#8220;what, where, and how&#8221; in each step of the task or procedure. Describe menu items for the current task left to right, top-down.</p>
</div>
</div>
<span id="document-dev_guide/style_guide/voice_style"></span><div class="section" id="voice-style">
<h6>Voice Style<a class="headerlink" href="#voice-style" title="Permalink to this headline">¶</a></h6>
<p>The essence of the Ansible writing style is short sentences that flow naturally together. Mix up sentence structures. Vary sentence subjects. Address the reader directly. Ask a question. And when the reader adjusts to the pace of shorter sentences, write a longer one.</p>
<ul class="simple">
<li>Write how real people speak...</li>
<li>...but try to avoid slang and colloquialisms that might not translate well into other languages.</li>
<li>Say big things with small words.</li>
<li>Be direct. Tell the reader exactly what you want them to do.</li>
<li>Be honest.</li>
<li>Short sentences show confidence.</li>
<li>Grammar rules are meant to be bent, but only if the reader knows you are doing this.</li>
<li>Choose words with fewer syllables for faster reading and better understanding.</li>
<li>Think of copy as one-on-one conversations rather than as a speech. It&#8217;s more difficult to ignore someone who is speaking to you directly.</li>
<li>When possible, start task-oriented sentences (those that direct a user to do something) with action words. For example: Find software... Contact support... Install the media.... and so forth.</li>
</ul>
<div class="section" id="active-voice">
<h7>Active Voice<a class="headerlink" href="#active-voice" title="Permalink to this headline">¶</a></h7>
<p>Use the active voice (&#8220;Start Linuxconf by typing...&#8221;) rather than passive (&#8220;Linuxconf can be started by typing...&#8221;) whenever possible. Active voice makes for more lively, interesting reading.
Also avoid future tense (or using the term &#8220;will&#8221;) whenever possible For example, future tense (&#8220;The screen will display...&#8221;) does not read as well as an active voice (&#8220;The screen displays&#8221;). Remember, the users you are writing for most often refer to the documentation while they are using the system, not after or in advance of using the system.</p>
</div>
</div>
<span id="document-dev_guide/style_guide/trademarks"></span><div class="section" id="trademark-usage">
<h6>Trademark Usage<a class="headerlink" href="#trademark-usage" title="Permalink to this headline">¶</a></h6>
<p>Why is it important to use the TM, SM, and ® for our registered marks?</p>
<p>Before a trademark is registered with the United States Patent and Trademark Office it is appropriate to use the TM or SM symbol depending whether the product is for goods or services. It is important to use the TM or SM as it is notification to the public that Ansible claims rights to the mark even though it has not yet been registered.</p>
<p>Once the trademark is registered, it is appropriate to use the symbol in place of the TM or SM. The symbol designation must be used in conjunction with the trademark if Ansible is to fully protect its rights. If we don&#8217;t protect these marks, we run the risk of losing them in the way of Aspirin or Trampoline or Escalator.</p>
<div class="section" id="general-rules">
<h7>General Rules:<a class="headerlink" href="#general-rules" title="Permalink to this headline">¶</a></h7>
<p>Trademarks should be used on 1st references on a page or within a section.</p>
<p>Use Ansible Tower® or Ansible®, on first reference when referring to products.</p>
<p>Use &#8220;Ansible&#8221; alone as the company name, as in &#8220;Ansible announced quarterly results,&#8221; which is not marked.</p>
<p>Also add the trademark disclaimer.
* When using Ansible trademarks in the body of written text, you should use the following credit line in a prominent place, usually a footnote.</p>
<blockquote>
<div><p>For Registered Trademarks:
- [Name of Trademark] is a registered trademark of Ansible, Inc. in the United States and other countries.</p>
<p>For Unregistered Trademarks (TMs/SMs):
- [Name of Trademark] is a trademark of Ansible, Inc. in the United States and other countries.</p>
<p>For registered and unregistered trademarks:
- [Name of Trademark] is a registered trademark and [Name of Trademark] is a trademark of Ansible, Inc. in the United States and other countries.</p>
</div></blockquote>
</div>
<div class="section" id="guidelines-for-the-proper-use-of-trademarks">
<h7>Guidelines for the proper use of trademarks:<a class="headerlink" href="#guidelines-for-the-proper-use-of-trademarks" title="Permalink to this headline">¶</a></h7>
<blockquote>
<div>Always distinguish trademarks from surround text with at least initial capital letters or in all capital letters.</div></blockquote>
<p>Always use proper trademark form and spelling.</p>
<p>Never use a trademark as a noun. Always use a trademark as an adjective modifying the noun.</p>
<blockquote>
<div><p>Correct:
Ansible Tower® system performance is incredible.</p>
<p>Incorrect:
Ansible&#8217;s performance is incredible.</p>
</div></blockquote>
<p>Never use a trademark as a verb. Trademarks are products or services, never actions.</p>
<blockquote>
<div><p>Correct:
&#8220;Orchestrate your entire network using Ansible Tower®.&#8221;</p>
<p>Incorrect:
&#8220;Ansible your entire network.&#8221;</p>
</div></blockquote>
<p>Never modify a trademark to a plural form. Instead, change the generic word from the singular to the plural.</p>
<blockquote>
<div><p>Correct:
&#8220;Corporate demand for Ansible Tower® configuration software is surging.&#8221;</p>
<p>Incorrect:
&#8220;Corporate demand for Ansible is surging.&#8221;</p>
</div></blockquote>
<p>Never modify a trademark from its possessive form, or make a trademark possessive. Always use it in the form it has been registered.</p>
<p>Never translate a trademark into another language.</p>
<p>Never use trademarks to coin new words or names.</p>
<p>Never use trademarks to create a play on words.</p>
<p>Never alter a trademark in any way including through unapproved fonts or visual identifiers.</p>
<p>Never abbreviate or use any Ansible trademarks as an acronym.</p>
</div>
<div class="section" id="the-importance-of-ansible-trademarks">
<h7>The importance of Ansible trademarks<a class="headerlink" href="#the-importance-of-ansible-trademarks" title="Permalink to this headline">¶</a></h7>
<p>The Ansible trademark and the &#8220;A&#8221; logo in a shaded circle are our most valuable assets. The value of these trademarks encompass the Ansible Brand. Effective trademark use is more than just a name, it defines the level of quality the customer will receive and it ties a product or service to a corporate image. A trademark may serve as the basis for many of our everyday decisions and choices. The Ansible Brand is about how we treat customers and each other. In order to continue to build a stronger more valuable Brand we must use it in a clear and consistent manner.</p>
<p>The mark consists of the letter &#8220;A&#8221; in a shaded circle. As of 5/11/15, this was a pending trademark (registration in process).</p>
</div>
<div class="section" id="common-ansible-trademarks">
<h7>Common Ansible Trademarks<a class="headerlink" href="#common-ansible-trademarks" title="Permalink to this headline">¶</a></h7>
<ul class="simple">
<li>Ansible®</li>
<li>Ansible Tower®</li>
</ul>
</div>
<div class="section" id="other-common-trademarks-and-resource-sites">
<h7>Other Common Trademarks and Resource Sites:<a class="headerlink" href="#other-common-trademarks-and-resource-sites" title="Permalink to this headline">¶</a></h7>
<ul class="simple">
<li>Linux is a registered trademark of Linus Torvalds.</li>
<li>UNIX® is a registered trademark of The Open Group.</li>
<li>Microsoft, Windows, Vista, XP, and NT are registered trademarks or trademarks of Microsoft Corporation in the United States and/or other countries. <a class="reference external" href="http://members.microsoft.com">http://members.microsoft.com</a>—en-us.mspx</li>
<li>Apple, Mac, Mac OS, Macintosh, Pages and TrueType are either registered trademarks or trademarks of Apple Computer, Inc. in the United States and/or other countries. <a class="reference external" href="http://www.apple.com">http://www.apple.com</a>—appletmlist.html</li>
<li>Adobe, Acrobat, GoLive, InDesign, Illustrator, PostScript , PhotoShop and the OpenType logo are either registered trademarks or trademarks of Adobe Systems Incorporated in the United States and/or other countries. htto:// www.adobe.com—trade.html</li>
<li>Macromedia and Macromedia Flash are trademarks of Macromedia, Inc. <a class="reference external" href="http://www.adobe.com">http://www.adobe.com</a>—trademarkguideline.html</li>
<li>IBM is a registered trademark of International Business Machines Corporation. <a class="reference external" href="http://www.ibm.com">http://www.ibm.com</a>—copytrade.shtml</li>
<li>Celeron, Celeron Inside, Centrino, Centrino logo, Core Inside, Intel Core, Intel Inside, Intel Inside logo, Itanium, Itanium Inside, Pentium, Pentium Inside,VTune, Xeon, and Xeon Inside are trademarks or registered trademarks of Intel Corporation or its subsidiaries in the United States and other countries. <a class="reference external" href="http://www.intel.com">http://www.intel.com</a>—tradmarx.htm</li>
</ul>
</div>
</div>
<span id="document-dev_guide/style_guide/grammar_punctuation"></span><div class="section" id="grammar-and-punctuation">
<h6>Grammar and Punctuation<a class="headerlink" href="#grammar-and-punctuation" title="Permalink to this headline">¶</a></h6>
<div class="section" id="common-styles-and-usage-and-common-mistakes">
<h7>Common Styles and Usage, and Common Mistakes<a class="headerlink" href="#common-styles-and-usage-and-common-mistakes" title="Permalink to this headline">¶</a></h7>
<div class="section" id="ansible">
<h8>Ansible<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h8>
<ul class="simple">
<li>Write &#8220;Ansible.&#8221; Not &#8220;Ansible, Inc.&#8221; or &#8220;AnsibleWorks The only exceptions to this rule are when we&#8217;re writing legal or financial statements.</li>
<li>Never use the logotype by itself in body text. Always keep the same font you are using the rest of the sentence.</li>
<li>A company is singular in the US. In other words, Ansible is an &#8220;it,&#8221; not a &#8220;they.&#8221;</li>
</ul>
</div>
<div class="section" id="capitalization">
<h8>Capitalization<a class="headerlink" href="#capitalization" title="Permalink to this headline">¶</a></h8>
<p>If it&#8217;s not a real product, service, or department at Ansible, don&#8217;t capitalize it. Not even if it seems important. Capitalize only the first letter of the first word in headlines.</p>
</div>
<div class="section" id="colon">
<h8>Colon<a class="headerlink" href="#colon" title="Permalink to this headline">¶</a></h8>
<p>A colon is generally used before a list or series:
- The Triangle Area consists of three cities: Raleigh, Durham, and Chapel Hill.</p>
<p>But not if the list is a complement or object of an element in the sentence:
- Before going on vacation, be sure to (1) set the alarm, (2) cancel the newspaper, and (3) ask a neighbor to collect your mail.</p>
<p>Use a colon after &#8220;as follows&#8221; and &#8220;the following&#8221; if the related list comes immediately after:
wedge The steps for changing directories are as follows:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Open a terminal.</li>
<li>Type cd...</li>
</ol>
</div></blockquote>
<p>Use a colon to introduce a bullet list (or dash, or icon/symbol of your choice):</p>
<blockquote>
<div><p>In the Properties dialog box, you&#8217;ll find the following entries:</p>
<ul class="simple">
<li>Connection name</li>
<li>Count</li>
<li>Cost per item</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="commas">
<h8>Commas<a class="headerlink" href="#commas" title="Permalink to this headline">¶</a></h8>
<p>Use serial commas, the comma before the &#8220;and&#8221; in a series of three or more items:</p>
<ul class="simple">
<li>&#8220;Item 1, item 2, and item 3.&#8221;</li>
</ul>
<p>It&#8217;s easier to read that way and helps avoid confusion. The primary exception to this you will see is in PR, where it is traditional not to use serial commas because it is often the style of journalists.</p>
<p>Commas are always important, considering the vast difference in meanings of the following two statements.</p>
<ul class="simple">
<li>Let&#8217;s eat, Grandma</li>
<li>Let&#8217;s eat Grandma.</li>
</ul>
<p>Correct punctation could save Grandma&#8217;s life.</p>
<p>If that does not convince you, maybe this will:</p>
<img alt="_images/commas-matter.jpg" src="_images/commas-matter.jpg" />
</div>
<div class="section" id="contractions">
<h8>Contractions<a class="headerlink" href="#contractions" title="Permalink to this headline">¶</a></h8>
<p>Do not use contractions in Ansible documents.</p>
</div>
<div class="section" id="em-dashes">
<h8>Em dashes<a class="headerlink" href="#em-dashes" title="Permalink to this headline">¶</a></h8>
<p>When possible, use em-dashes with no space on either side. When full em-dashes aren&#8217;t available, use double-dashes with no spaces on either side&#8211;like this.</p>
<p>A pair of em dashes can be used in place of commas to enhance readability. Note, however, that dashes are always more emphatic than commas.</p>
<p>A pair of em dashes can replace a pair of parentheses. Dashes are considered less formal than parentheses; they are also more intrusive. If you want to draw attention to the parenthetical content, use dashes. If you want to include the parenthetical content more subtly, use parentheses.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When dashes are used in place of parentheses, surrounding punctuation should be omitted. Compare the following examples.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Upon discovering the errors <span class="o">(</span>all <span class="m">124</span> of them<span class="o">)</span>, the publisher immediately recalled the books.

Upon discovering the errors—all <span class="m">124</span> of them—the publisher immediately recalled the books.
</pre></div>
</div>
<p>When used in place of parentheses at the end of a sentence, only a single dash is used.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>After three weeks on set, the cast was fed up with his direction <span class="o">(</span>or, rather, lack of direction<span class="o">)</span>.

After three weeks on set, the cast was fed up with his direction—or, rather, lack of direction.
</pre></div>
</div>
</div>
<div class="section" id="exclamation-points">
<h8>Exclamation points (!)<a class="headerlink" href="#exclamation-points" title="Permalink to this headline">¶</a></h8>
<p>Do not use them at the end of sentences. An exclamation point can be used when referring to a command, such as the bang (!) command.</p>
</div>
<div class="section" id="gender-references">
<h8>Gender References<a class="headerlink" href="#gender-references" title="Permalink to this headline">¶</a></h8>
<p>Do not use gender-specific pronouns in documentation. It is far less awkward to read a sentence that uses &#8220;they&#8221; and &#8220;their&#8221; rather than &#8220;he/she&#8221; and &#8220;his/hers.&#8221;</p>
<p>It is fine to use &#8220;you&#8221; when giving instructions and &#8220;the user,&#8221; &#8220;new users,&#8221; etc. in more general explanations.</p>
<p>Never use &#8220;one&#8221; in place of &#8220;you&#8221; when writing technical documentation. Using &#8220;one&#8221; is far too formal.</p>
<p>Never use &#8220;we&#8221; when writing. &#8220;We&#8221; aren&#8217;t doing anything on the user side. Ansible&#8217;s products are doing the work as requested by the user.</p>
</div>
<div class="section" id="hyphen">
<h8>Hyphen<a class="headerlink" href="#hyphen" title="Permalink to this headline">¶</a></h8>
<p>The hyphen’s primary function is the formation of certain compound terms. Do not use a hyphen unless it serves a purpose. If a compound adjective cannot be misread or, as with many psychological terms, its meaning is established, a hyphen is not necessary.</p>
<p>Use hyphens to avoid ambiguity or confusion:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>a little-used car
a little used-car

cross complaint
cross-complaint

high-school girl
high schoolgirl

fine-tooth comb <span class="o">(</span>most people <span class="k">do</span> not comb their teeth<span class="o">)</span>

third-world war
third world war
</pre></div>
</div>
<img alt="_images/hyphen-funny.jpg" src="_images/hyphen-funny.jpg" />
<p>In professionally printed material (particularly books, magazines, and newspapers), the hyphen is used to divide words between the end of one line and the beginning of the next. This allows for an evenly aligned right margin without highly variable (and distracting) word spacing.</p>
</div>
<div class="section" id="lists">
<h8>Lists<a class="headerlink" href="#lists" title="Permalink to this headline">¶</a></h8>
<p>Keep the structure of bulleted lists equivalent and consistent. If one bullet is a verb phrase, they should all be verb phrases. If one is a complete sentence, they should all be complete sentences, etc.</p>
<p>Capitalize the first word of each bullet. Unless it is obvious that it is just a list of items, such as a list of items like:
* computer
* monitor
* keyboard
* mouse</p>
<p>When the bulleted list appears within the context of other copy, (unless it&#8217;s a straight list like the previous example) add periods, even if the bullets are sentence fragments. Part of the reason behind this is that each bullet is said to complete the original sentence.</p>
<p>In some cases where the bullets are appearing independently, such as in a poster or a homepage promotion, they do not need periods.</p>
<p>When giving instructional steps, use numbered lists instead of bulleted lists.</p>
</div>
<div class="section" id="months-and-states">
<h8>Months and States<a class="headerlink" href="#months-and-states" title="Permalink to this headline">¶</a></h8>
<p>Abbreviate months and states according to AP. Months are only abbreviated if they are used in conjunction with a day. Example: &#8220;The President visited in January 1999.&#8221; or &#8220;The President visited Jan. 12.&#8221;</p>
<p>Months: Jan., Feb., March, April, May, June, July, Aug., Sept., Nov., Dec.</p>
<p>States: Ala., Ariz., Ark., Calif., Colo., Conn., Del., Fla., Ga., Ill., Ind., Kan., Ky., La., Md., Mass., Mich., Minn., Miss., Mo., Mont., Neb., Nev., NH, NJ, NM, NY, NC, ND, Okla., Ore., Pa., RI, SC, SD, Tenn., Vt., Va., Wash., W.Va., Wis., Wyo.</p>
</div>
<div class="section" id="numbers">
<h8>Numbers<a class="headerlink" href="#numbers" title="Permalink to this headline">¶</a></h8>
<p>Numbers between one and nine are written out. 10 and above are numerals. The exception to this is writing &#8220;4 million&#8221; or &#8220;4 GB.&#8221; It&#8217;s also acceptable to use numerals in tables and charts.</p>
<div class="section" id="phone-numbers">
<h9>Phone Numbers<a class="headerlink" href="#phone-numbers" title="Permalink to this headline">¶</a></h9>
<p>Phone number style: 1 (919) 555-0123 x002 and 1 888-GOTTEXT</p>
</div>
</div>
<div class="section" id="quotations-using-quotation-marks-and-writing-quotes">
<h8>Quotations (Using Quotation Marks and Writing Quotes)<a class="headerlink" href="#quotations-using-quotation-marks-and-writing-quotes" title="Permalink to this headline">¶</a></h8>
<blockquote>
<div>&#8220;Place the punctuation inside the quotes,&#8221; the editor said.</div></blockquote>
<p>Except in rare instances, use only &#8220;said&#8221; or &#8220;says&#8221; because anything else just gets in the way of the quote itself, and also tends to editorialize.</p>
<dl class="docutils">
<dt>Place the name first right after the quote:</dt>
<dd>&#8220;I like to write first-person because I like to become the character I&#8217;m writing,&#8221; Wally Lamb said.</dd>
<dt>Not:</dt>
<dd>&#8220;I like to write first-person because I like to become the character I&#8217;m writing,&#8221; said Wally Lamb.</dd>
</dl>
</div>
<div class="section" id="semicolon">
<h8>Semicolon<a class="headerlink" href="#semicolon" title="Permalink to this headline">¶</a></h8>
<p>Use a semicolon to separate items in a series if the items contain commas:</p>
<ul class="simple">
<li>Everyday I have coffee, toast, and fruit for breakfast; a salad for lunch; and a peanut butter sandwich, cookies, ice cream, and chocolate cake for dinner.</li>
</ul>
<p>Use a semicolon before a conjunctive adverb (however, therefore, otherwise, namely, for example, etc.):
- I think; therefore, I am.</p>
</div>
<div class="section" id="spacing-after-sentences">
<h8>Spacing after sentences<a class="headerlink" href="#spacing-after-sentences" title="Permalink to this headline">¶</a></h8>
<p>Use only a single space after a sentence.</p>
</div>
<div class="section" id="time">
<h8>Time<a class="headerlink" href="#time" title="Permalink to this headline">¶</a></h8>
<ul class="simple">
<li>Time of day is written as &#8220;4 p.m.&#8221;</li>
</ul>
</div>
</div>
</div>
<span id="document-dev_guide/style_guide/spelling_word_choice"></span><div class="section" id="spelling-word-usage-common-words-and-phrases-to-use-and-avoid">
<h6>Spelling - Word Usage - Common Words and Phrases to Use and Avoid<a class="headerlink" href="#spelling-word-usage-common-words-and-phrases-to-use-and-avoid" title="Permalink to this headline">¶</a></h6>
<div class="section" id="acronyms">
<h7>Acronyms<a class="headerlink" href="#acronyms" title="Permalink to this headline">¶</a></h7>
<p>Always uppercase. An acronym is a word formed from the initial letters of a name, such as ROM for Read-only memory,
SaaS for Software as a Service, or by combining initial letters or part of a series of words, such as LILO for LInux
LOader.</p>
<p>Spell out the acronym before using it in alone text, such as &#8220;The Embedded DevKit (EDK)...&#8221;</p>
</div>
<div class="section" id="applications">
<h7>Applications<a class="headerlink" href="#applications" title="Permalink to this headline">¶</a></h7>
<p>When used as a proper name, use the capitalization of the product, such as GNUPro, Source-Navigator, and Ansible Tower. When used as a command, use lowercase as appropriate, such as &#8220;To start GCC, type <code class="docutils literal"><span class="pre">gcc</span></code>.&#8221;</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#8220;vi&#8221; is always lowercase.</p>
</div>
</div>
<div class="section" id="as">
<h7>As<a class="headerlink" href="#as" title="Permalink to this headline">¶</a></h7>
<p>This is often used to mean &#8220;because&#8221;, but has other connotations, for example, parallel or simultaneous actions. If you mean &#8220;because&#8221;, say &#8220;because&#8221;.</p>
</div>
<div class="section" id="asks-for">
<h7>Asks for<a class="headerlink" href="#asks-for" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;requests&#8221; instead.</p>
</div>
<div class="section" id="assure-ensure-insure">
<h7>Assure/Ensure/Insure<a class="headerlink" href="#assure-ensure-insure" title="Permalink to this headline">¶</a></h7>
<p>Assure implies a sort of mental comfort. As in &#8220;I assured my husband that I would eventually bring home beer.&#8221;</p>
<p>Ensure means &#8220;to make sure.&#8221;</p>
<p>Insure relates to monetary insurance.</p>
</div>
<div class="section" id="back-up">
<h7>Back up<a class="headerlink" href="#back-up" title="Permalink to this headline">¶</a></h7>
<p>This is a verb. You &#8220;back up&#8221; files; you do not &#8220;backup&#8221; files.</p>
</div>
<div class="section" id="backup">
<h7>Backup<a class="headerlink" href="#backup" title="Permalink to this headline">¶</a></h7>
<p>This is a noun. You create &#8220;backup&#8221; files; you do not create &#8220;back up&#8221; files.</p>
</div>
<div class="section" id="backward">
<h7>Backward<a class="headerlink" href="#backward" title="Permalink to this headline">¶</a></h7>
<p>Correct. Avoid using backwards unless you are stating that something has &#8220;backwards compatibility.&#8221;</p>
</div>
<div class="section" id="backwards-compatibility">
<h7>Backwards compatibility<a class="headerlink" href="#backwards-compatibility" title="Permalink to this headline">¶</a></h7>
<p>Correct as is.</p>
</div>
<div class="section" id="by-way-of">
<h7>By way of<a class="headerlink" href="#by-way-of" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;using&#8221; instead.</p>
</div>
<div class="section" id="can-may">
<h7>Can/May<a class="headerlink" href="#can-may" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;can&#8221; to describe actions or conditions that are possible. Use &#8220;may&#8221; only to describe situations where permission is being given. If either &#8220;can,&#8221; &#8220;could,&#8221; or &#8220;may&#8221; apply, use &#8220;can&#8221; because it&#8217;s less tentative.</p>
</div>
<div class="section" id="cd-or-cd">
<h7>CD or cd<a class="headerlink" href="#cd-or-cd" title="Permalink to this headline">¶</a></h7>
<p>When referring to a compact disk, use CD, such as &#8220;Insert the CD into the CD-ROM drive.&#8221; When referring to the change directory command, use cd.</p>
</div>
<div class="section" id="cd-rom">
<h7>CD-ROM<a class="headerlink" href="#cd-rom" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;cdrom,&#8221; &#8220;CD-Rom,&#8221; &#8220;CDROM,&#8221; &#8220;cd-rom&#8221; or any other variation. When referring to the drive, use CD-ROM drive, such as &#8220;Insert the CD into the CD-ROM drive.&#8221; The plural is &#8220;CD-ROMs.&#8221;</p>
</div>
<div class="section" id="command-line">
<h7>Command line<a class="headerlink" href="#command-line" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;command-line&#8221; or &#8220;commandline.&#8221;</p>
<p>Use to describes where to place options for a command, but not where to type the command. Use &#8220;shell prompt&#8221; instead to describe where to type commands. The line on the display screen where a command is expected. Generally, the command line is the line that contains the most recently displayed command prompt.</p>
</div>
<div class="section" id="daylight-saving-time-dst">
<h7>Daylight saving time (DST)<a class="headerlink" href="#daylight-saving-time-dst" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use daylight savings time. Daylight Saving Time (DST) is often misspelled “Daylight Savings”, with an “s” at the end. Other common variations are “Summer Time”and “Daylight-Saving Time”. (<a class="reference external" href="http://www.timeanddate.com/time/dst/daylight-savings-time.html">http://www.timeanddate.com/time/dst/daylight-savings-time.html</a>)</p>
</div>
<div class="section" id="download">
<h7>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;down load&#8221; or &#8220;down-load.&#8221;</p>
</div>
<div class="section" id="e-g">
<h7>e.g.<a class="headerlink" href="#e-g" title="Permalink to this headline">¶</a></h7>
<p>Spell it out: &#8220;For example.&#8221;</p>
</div>
<div class="section" id="failover">
<h7>Failover<a class="headerlink" href="#failover" title="Permalink to this headline">¶</a></h7>
<p>When used as a noun, a failover is a backup operation that automatically switches to a standby database, server or network if the primary system fails or is temporarily shut down for servicing. Failover is an important fault tolerance function of mission-critical systems that rely on constant accessibility. Failover automatically and transparently to the user redirects requests from the failed or down system to the backup system that mimics the operations of the primary system.</p>
</div>
<div class="section" id="fail-over">
<h7>Fail over<a class="headerlink" href="#fail-over" title="Permalink to this headline">¶</a></h7>
<p>When used as a verb, fail over is two words since there can be different tenses such as failed over.</p>
</div>
<div class="section" id="fewer">
<h7>Fewer<a class="headerlink" href="#fewer" title="Permalink to this headline">¶</a></h7>
<p>Fewer is used with plural nouns. Think things you could count.  Time, money, distance, and weight are often listed as exceptions to the traditional “can you count it” rule, often thought of a singular amounts (the work will take less than 5 hours, for example).</p>
</div>
<div class="section" id="file-name">
<h7>File name<a class="headerlink" href="#file-name" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;filename.&#8221;</p>
</div>
<div class="section" id="file-system">
<h7>File system<a class="headerlink" href="#file-system" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;filesystem.&#8221; The system that an operating system or program uses to organize and keep track of files. For example, a hierarchical file system is one that uses directories to organize files into a tree structure. Although the operating system provides its own file management system, you can buy separate file management systems. These systems interact smoothly with the operating system but provide more features, such as improved backup procedures and stricter file protection.</p>
</div>
<div class="section" id="for-instance">
<h7>For instance<a class="headerlink" href="#for-instance" title="Permalink to this headline">¶</a></h7>
<p>For example,&#8221; instead.</p>
</div>
<div class="section" id="for-further-additional-whatever-information">
<h7>For further/additional/whatever information<a class="headerlink" href="#for-further-additional-whatever-information" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;For more information&#8221;</p>
</div>
<div class="section" id="for-this-reason">
<h7>For this reason<a class="headerlink" href="#for-this-reason" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;therefore&#8221;.</p>
</div>
<div class="section" id="forward">
<h7>Forward<a class="headerlink" href="#forward" title="Permalink to this headline">¶</a></h7>
<p>Correct. Avoid using &#8220;forwards.&#8221;</p>
</div>
<div class="section" id="gigabyte-gb">
<h7>Gigabyte (GB)<a class="headerlink" href="#gigabyte-gb" title="Permalink to this headline">¶</a></h7>
<p>2 to the 30th power (1,073,741,824) bytes. One gigabyte is equal to 1,024 megabytes. Gigabyte is often abbreviated as G or GB.</p>
</div>
<div class="section" id="got">
<h7>Got<a class="headerlink" href="#got" title="Permalink to this headline">¶</a></h7>
<p>Avoid. Use &#8220;must&#8221; instead.</p>
</div>
<div class="section" id="high-availability">
<h7>High-availability<a class="headerlink" href="#high-availability" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;high availability.&#8221;</p>
</div>
<div class="section" id="highly-available">
<h7>Highly available<a class="headerlink" href="#highly-available" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use highly-available.&#8221;</p>
</div>
<div class="section" id="hostname">
<h7>Hostname<a class="headerlink" href="#hostname" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use host name.</p>
</div>
<div class="section" id="i-e">
<h7>i.e.<a class="headerlink" href="#i-e" title="Permalink to this headline">¶</a></h7>
<p>Spell it out: &#8220;That is.&#8221;</p>
<p>Installer
Avoid. Use &#8220;installation program&#8221; instead.</p>
</div>
<div class="section" id="it-s-and-its">
<h7>It&#8217;s and its<a class="headerlink" href="#it-s-and-its" title="Permalink to this headline">¶</a></h7>
<p>&#8220;It&#8217;s&#8221; is a contraction for &#8220;it is;&#8221; use &#8220;it is&#8221; instead of &#8220;it&#8217;s.&#8221; Use &#8220;its&#8221; as a possessive pronoun (for example, &#8220;the store is known for its low prices&#8221;).</p>
</div>
<div class="section" id="less">
<h7>Less<a class="headerlink" href="#less" title="Permalink to this headline">¶</a></h7>
<p>Less is used with singular nouns. For example &#8220;View less details&#8221; wouldn&#8217;t be correct but &#8220;View less detail&#8221; works. Use fewer when you have plural nouns (things you can count).</p>
</div>
<div class="section" id="linux">
<h7>Linux<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;LINUX&#8221; or &#8220;linux&#8221; unless referring to a command, such as &#8220;To start Linux, type linux.&#8221; Linux is a registered trademark of Linus Torvalds.</p>
</div>
<div class="section" id="login">
<h7>Login<a class="headerlink" href="#login" title="Permalink to this headline">¶</a></h7>
<p>A noun used to refer to the login prompt, such as &#8220;At the login prompt, enter your username.&#8221;</p>
</div>
<div class="section" id="log-in">
<h7>Log in<a class="headerlink" href="#log-in" title="Permalink to this headline">¶</a></h7>
<p>A verb used to refer to the act of logging in. Do not use &#8220;login,&#8221; &#8220;loggin,&#8221; &#8220;logon,&#8221; and other variants. For example, &#8220;When starting your computer, you are requested to log in...&#8221;</p>
</div>
<div class="section" id="log-on">
<h7>Log on<a class="headerlink" href="#log-on" title="Permalink to this headline">¶</a></h7>
<p>To make a computer system or network recognize you so that you can begin a computer session. Most personal computers have no log-on procedure &#8211; you just turn the machine on and begin working. For larger systems and networks, however, you usually need to enter a username and password before the computer system will allow you to execute programs.</p>
</div>
<div class="section" id="lots-of">
<h7>Lots of<a class="headerlink" href="#lots-of" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;Several&#8221; or something equivalent instead.</p>
</div>
<div class="section" id="make-sure">
<h7>Make sure<a class="headerlink" href="#make-sure" title="Permalink to this headline">¶</a></h7>
<p>This means &#8220;be careful to remember, attend to, or find out something.&#8221; For example, &#8221;...make sure that the rhedk group is listed in the output.&#8221;
Try to use verify or ensure instead.</p>
</div>
<div class="section" id="manual-man-page">
<h7>Manual/man page<a class="headerlink" href="#manual-man-page" title="Permalink to this headline">¶</a></h7>
<p>Correct. Two words. Do not use &#8220;manpage&#8221;</p>
</div>
<div class="section" id="mb">
<h7>MB<a class="headerlink" href="#mb" title="Permalink to this headline">¶</a></h7>
<ol class="arabic simple">
<li>When spelled MB, short for megabyte (1,000,000 or 1,048,576 bytes, depending on the context).</li>
<li>When spelled Mb, short for megabit.</li>
</ol>
</div>
<div class="section" id="mbps">
<h7>MBps<a class="headerlink" href="#mbps" title="Permalink to this headline">¶</a></h7>
<p>Short for megabytes per second, a measure of data transfer speed. Mass storage devices are generally measured in MBps.</p>
</div>
<div class="section" id="mysql">
<h7>MySQL<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h7>
<p>Common open source database server and client package. Do not use &#8220;MYSQL&#8221; or &#8220;mySQL.&#8221;</p>
</div>
<div class="section" id="need-to">
<h7>Need to<a class="headerlink" href="#need-to" title="Permalink to this headline">¶</a></h7>
<p>Avoid. Use &#8220;must&#8221; instead.</p>
</div>
<div class="section" id="read-only">
<h7>Read-only<a class="headerlink" href="#read-only" title="Permalink to this headline">¶</a></h7>
<p>Correct. Use when referring to the access permissions of files or directories.</p>
</div>
<div class="section" id="real-time-real-time">
<h7>Real time/real-time<a class="headerlink" href="#real-time-real-time" title="Permalink to this headline">¶</a></h7>
<p>Depends. If used as a noun, it is the actual time during which something takes place. For example, &#8220;The computer may partly analyze the data in real time (as it comes in) &#8211; R. H. March.&#8221; If used as an adjective, &#8220;real-time&#8221; is appropriate. For example, &#8220;XEmacs is a self-documenting, customizable, extensible, real-time display editor.&#8221;</p>
</div>
<div class="section" id="refer-to">
<h7>Refer to<a class="headerlink" href="#refer-to" title="Permalink to this headline">¶</a></h7>
<p>Use to indicate a reference (within a manual or website) or a cross-reference (to another manual or documentation source).</p>
</div>
<div class="section" id="see">
<h7>See<a class="headerlink" href="#see" title="Permalink to this headline">¶</a></h7>
<p>Don&#8217;t use. Use &#8220;Refer to&#8221; instead.</p>
</div>
<div class="section" id="since">
<h7>Since<a class="headerlink" href="#since" title="Permalink to this headline">¶</a></h7>
<p>This is often used to mean &#8220;because&#8221;, but &#8220;since&#8221; has connotations of time, so be careful. If you mean &#8220;because&#8221;, say &#8220;because&#8221;.</p>
</div>
<div class="section" id="tells">
<h7>Tells<a class="headerlink" href="#tells" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;Instructs&#8221; instead.</p>
</div>
<div class="section" id="that-which">
<h7>That/which<a class="headerlink" href="#that-which" title="Permalink to this headline">¶</a></h7>
<p>&#8220;That&#8221; introduces a restrictive clause-a clause that must be there for the sentence to make sense. A restrictive clause often defines the noun or phrase preceding it. &#8220;Which&#8221; introduces a non-restrictive, parenthetical clause-a clause that could be omitted without affecting the meaning of the sentence. For example: The car was travelling at a speed that would endanger lives. The car, which was traveling at a speed that would endanger lives, swerved onto the sidewalk. Use &#8220;who&#8221; or &#8220;whom,&#8221; rather than &#8220;that&#8221; or &#8220;which,&#8221; when referring to a person.</p>
</div>
<div class="section" id="then-than">
<h7>Then/than<a class="headerlink" href="#then-than" title="Permalink to this headline">¶</a></h7>
<blockquote>
<div>&#8220;Then&#8221; refers to a time in the past or the next step in a sequence. &#8220;Than&#8221; is used for comparisons.</div></blockquote>
<img alt="_images/thenvsthan.jpg" src="_images/thenvsthan.jpg" />
</div>
<div class="section" id="third-party">
<h7>Third-party<a class="headerlink" href="#third-party" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;third party&#8221;.</p>
</div>
<div class="section" id="troubleshoot">
<h7>Troubleshoot<a class="headerlink" href="#troubleshoot" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;trouble shoot&#8221; or &#8220;trouble-shoot.&#8221; To isolate the source of a problem and fix it. In the case of computer systems, the term troubleshoot is usually used when the problem is suspected to be hardware -related. If the problem is known to be in software, the term debug is more commonly used.</p>
</div>
<div class="section" id="uk">
<h7>UK<a class="headerlink" href="#uk" title="Permalink to this headline">¶</a></h7>
<p>Correst as is, no periods.</p>
</div>
<div class="section" id="unix">
<h7>UNIX®<a class="headerlink" href="#unix" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;Unix&#8221; or &#8220;unix.&#8221; UNIX® is a registered trademark of The Open Group.</p>
</div>
<div class="section" id="unset">
<h7>Unset<a class="headerlink" href="#unset" title="Permalink to this headline">¶</a></h7>
<p>Don&#8217;t use. Use Clear.</p>
</div>
<div class="section" id="us">
<h7>US<a class="headerlink" href="#us" title="Permalink to this headline">¶</a></h7>
<p>Correst as is, no periods.</p>
</div>
<div class="section" id="user">
<h7>User<a class="headerlink" href="#user" title="Permalink to this headline">¶</a></h7>
<p>When referring to the reader, use &#8220;you&#8221; instead of &#8220;user.&#8221; For example, &#8220;The user must...&#8221; is incorrect. Use &#8220;You must...&#8221; instead. If referring to more than one user, calling the collection &#8220;users&#8221; is acceptable, such as &#8220;Other users may wish to access your database.&#8221;</p>
</div>
<div class="section" id="username">
<h7>Username<a class="headerlink" href="#username" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;user name.&#8221;</p>
</div>
<div class="section" id="view">
<h7>View<a class="headerlink" href="#view" title="Permalink to this headline">¶</a></h7>
<p>When using as a reference (&#8220;View the documentation available online.&#8221;), do not use View. Use &#8220;Refer to&#8221; instead.</p>
</div>
<div class="section" id="within">
<h7>Within<a class="headerlink" href="#within" title="Permalink to this headline">¶</a></h7>
<p>Don&#8217;t use to refer to a file that exists in a directory. Use &#8220;In&#8221;.</p>
</div>
<div class="section" id="world-wide-web">
<h7>World Wide Web<a class="headerlink" href="#world-wide-web" title="Permalink to this headline">¶</a></h7>
<p>Correct. Capitalize each word. Abbreviate as &#8220;WWW&#8221; or &#8220;Web.&#8221;</p>
</div>
<div class="section" id="webpage">
<h7>Webpage<a class="headerlink" href="#webpage" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;web page&#8221; or &#8220;Web page.&#8221;</p>
</div>
<div class="section" id="web-server">
<h7>Web server<a class="headerlink" href="#web-server" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;webserver&#8221;. For example, &#8220;The Apache HTTP Server is the default Web server...&#8221;</p>
</div>
<div class="section" id="website">
<h7>Website<a class="headerlink" href="#website" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;web site&#8221; or &#8220;Web site.&#8221; For example, &#8220;The Ansible website contains ...&#8221;</p>
</div>
<div class="section" id="who-whom">
<h7>Who/whom<a class="headerlink" href="#who-whom" title="Permalink to this headline">¶</a></h7>
<p>Use the pronoun &#8220;who&#8221; as a subject. Use the pronoun &#8220;whom&#8221; as a direct object, an indirect object, or the object of a preposition. For example: Who owns this? To whom does this belong?</p>
</div>
<div class="section" id="will">
<h7>Will<a class="headerlink" href="#will" title="Permalink to this headline">¶</a></h7>
<p>Do not use future tense unless it is absolutely necessary. For instance, do not use the sentence, &#8220;The next section will describe the process in more detail.&#8221; Instead, use the sentence, &#8220;The next section describes the process in more detail.&#8221;</p>
</div>
<div class="section" id="wish">
<h7>Wish<a class="headerlink" href="#wish" title="Permalink to this headline">¶</a></h7>
<p>Use &#8220;need&#8221; instead of &#8220;desire&#8221; and &#8220;wish.&#8221; Use &#8220;want&#8221; when the reader&#8217;s actions are optional (that is, they may not &#8220;need&#8221; something but may still &#8220;want&#8221; something).</p>
</div>
<div class="section" id="x86">
<h7>x86<a class="headerlink" href="#x86" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not capitalize the &#8220;x.&#8221;</p>
</div>
<div class="section" id="x86-64">
<h7>x86_64<a class="headerlink" href="#x86-64" title="Permalink to this headline">¶</a></h7>
<p>Do not use. Do not use &#8220;Hammer&#8221;. Always use &#8220;AMD64 and Intel® EM64T&#8221; when referring to this architecture.</p>
</div>
<div class="section" id="you">
<h7>You<a class="headerlink" href="#you" title="Permalink to this headline">¶</a></h7>
<p>Correct. Do not use &#8220;I,&#8221; &#8220;he,&#8221; or &#8220;she.&#8221;</p>
</div>
<div class="section" id="you-may">
<h7>You may<a class="headerlink" href="#you-may" title="Permalink to this headline">¶</a></h7>
<p>Try to avoid using this. For example, &#8220;you may&#8221; can be eliminated from this sentence &#8220;You may double-click on the desktop...&#8221;</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-tower"></span><div class="section" id="ansible-tower">
<h3>Ansible Tower<a class="headerlink" href="#ansible-tower" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://ansible.com/tower">Ansible Tower</a> (formerly &#8216;AWX&#8217;) is a web-based solution that makes Ansible even more easy to use for IT teams of all kinds.  It&#8217;s designed to be the hub for all of your automation tasks.</p>
<p>Tower allows you to control access to who can access what, even allowing sharing of SSH credentials without someone being able to transfer those credentials.  Inventory can be graphically managed or synced with a wide variety of cloud sources.  It logs all of your jobs, integrates well with LDAP, and has an amazing browsable REST API.  Command line tools are available for easy integration with Jenkins as well.  Provisioning callbacks provide great support for autoscaling topologies.</p>
<p>Find out more about Tower features and how to download it on the <a class="reference external" href="https://ansible.com/tower">Ansible Tower webpage</a>.  Tower
is free for usage for up to 10 nodes, and comes bundled with amazing support from Ansible, Inc.  As you would expect, Tower is
installed using Ansible playbooks!</p>
</div>
<span id="document-community"></span><div class="section" id="community-information-contributing">
<h3><a class="toc-backref" href="#id3">Community Information &amp; Contributing</a><a class="headerlink" href="#community-information-contributing" title="Permalink to this headline">¶</a></h3>
<p>Ansible is an open source project designed to bring together administrators and developers of all kinds to collaborate on building
IT automation solutions that work well for them.</p>
<p>Should you wish to get more involved &#8211; whether in terms of just asking a question, helping other users, introducing new people to Ansible, or helping with the software or documentation, we welcome your contributions to the project.</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#community-information-contributing" id="id3">Community Information &amp; Contributing</a><ul>
<li><a class="reference internal" href="#ansible-users" id="id4">Ansible Users</a><ul>
<li><a class="reference internal" href="#i-ve-got-a-question" id="id5">I&#8217;ve Got A Question</a></li>
<li><a class="reference internal" href="#i-d-like-to-keep-up-with-release-announcements" id="id6">I&#8217;d Like To Keep Up With Release Announcements</a></li>
<li><a class="reference internal" href="#i-d-like-to-help-share-and-promote-ansible" id="id7">I&#8217;d Like To Help Share and Promote Ansible</a></li>
<li><a class="reference internal" href="#i-d-like-to-help-ansible-move-faster" id="id8">I&#8217;d Like To Help Ansible Move Faster</a></li>
<li><a class="reference internal" href="#i-d-like-to-report-a-bug" id="id9">I&#8217;d Like To Report A Bug</a></li>
<li><a class="reference internal" href="#i-d-like-to-help-with-documentation" id="id10">I&#8217;d Like To Help With Documentation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#for-current-and-prospective-developers" id="id11">For Current and Prospective Developers</a><ul>
<li><a class="reference internal" href="#i-d-like-to-learn-how-to-develop-on-ansible" id="id12">I&#8217;d Like To Learn How To Develop on Ansible</a></li>
<li><a class="reference internal" href="#contributing-code-features-or-bugfixes" id="id13">Contributing Code (Features or Bugfixes)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-topics" id="id14">Other Topics</a><ul>
<li><a class="reference internal" href="#ansible-staff" id="id15">Ansible Staff</a></li>
<li><a class="reference internal" href="#mailing-list-information" id="id16">Mailing List Information</a></li>
<li><a class="reference internal" href="#irc-meetings" id="id17">IRC Meetings</a></li>
<li><a class="reference internal" href="#release-numbering" id="id18">Release Numbering</a></li>
<li><a class="reference internal" href="#tower-support-questions" id="id19">Tower Support Questions</a></li>
<li><a class="reference internal" href="#irc-channel" id="id20">IRC Channel</a></li>
<li><a class="reference internal" href="#notes-on-priority-flags" id="id21">Notes on Priority Flags</a></li>
</ul>
</li>
<li><a class="reference internal" href="#community-code-of-conduct" id="id22">Community Code of Conduct</a><ul>
<li><a class="reference internal" href="#anti-harassment-policy" id="id23">Anti-harassment policy</a></li>
<li><a class="reference internal" href="#policy-violations" id="id24">Policy violations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contributors-license-agreement" id="id25">Contributors License Agreement</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ansible-users">
<h4><a class="toc-backref" href="#id4">Ansible Users</a><a class="headerlink" href="#ansible-users" title="Permalink to this headline">¶</a></h4>
<div class="section" id="i-ve-got-a-question">
<h5><a class="toc-backref" href="#id5">I&#8217;ve Got A Question</a><a class="headerlink" href="#i-ve-got-a-question" title="Permalink to this headline">¶</a></h5>
<p>We&#8217;re happy to help!</p>
<p>Ansible questions are best asked on the <a class="reference external" href="http://groups.google.com/group/ansible-project">Ansible Google Group Mailing List</a>.</p>
<p>This is a very large high-traffic list for answering questions and sharing tips
and tricks. Anyone can join, and email delivery is optional if you just want to read the group online.  To cut down on spam, your first post is moderated, though posts are approved quickly.</p>
<p>Please be sure to share any relevant commands you ran, output, and detail, indicate the version of Ansible you are using when asking a question.</p>
<p>Where needed, link to gists or GitHub repos to show examples, rather than sending attachments to the list.</p>
<p>We recommend using Google search to see if a topic has been answered recently, but comments found in older threads may no longer apply, depending on the topic.</p>
<p>Before you post, be sure you are running the latest stable version of Ansible.  You can check this by comparing the output of <code class="docutils literal"><span class="pre">ansible</span> <span class="pre">--version</span></code> with the version indicated on <a class="reference external" href="https://pypi.python.org/pypi/ansible">PyPi</a>.</p>
<p>Alternatively, you can also join our IRC channel - <code class="docutils literal"><span class="pre">#ansible</span></code> on irc.freenode.net.  It&#8217;s a very high traffic channel as well, so if you don&#8217;t get an answer you like, please stop by our mailing list, which is more likely
to get the attention of core developers since it&#8217;s asynchronous.</p>
</div>
<div class="section" id="i-d-like-to-keep-up-with-release-announcements">
<h5><a class="toc-backref" href="#id6">I&#8217;d Like To Keep Up With Release Announcements</a><a class="headerlink" href="#i-d-like-to-keep-up-with-release-announcements" title="Permalink to this headline">¶</a></h5>
<p>Release announcements are posted to ansible-project, though if you don&#8217;t want to keep up with the very active list, you can join the <a class="reference external" href="http://groups.google.com/group/ansible-announce">Ansible Announce Mailing List</a>.</p>
<p>This is a low-traffic read-only list, where we&#8217;ll share release announcements and occasionally links to major Ansible Events around the world.</p>
</div>
<div class="section" id="i-d-like-to-help-share-and-promote-ansible">
<h5><a class="toc-backref" href="#id7">I&#8217;d Like To Help Share and Promote Ansible</a><a class="headerlink" href="#i-d-like-to-help-share-and-promote-ansible" title="Permalink to this headline">¶</a></h5>
<p>You can help share Ansible with others by telling friends and colleagues, writing a blog post,
or presenting at user groups (like DevOps groups or the local LUG).</p>
<p>You are also welcome to share slides on speakerdeck, sign up for a free account and tag it “Ansible”. On Twitter,
you can also share things with #ansible and may wish to <a class="reference external" href="https://twitter.com/ansible">follow us</a>.</p>
</div>
<div class="section" id="i-d-like-to-help-ansible-move-faster">
<h5><a class="toc-backref" href="#id8">I&#8217;d Like To Help Ansible Move Faster</a><a class="headerlink" href="#i-d-like-to-help-ansible-move-faster" title="Permalink to this headline">¶</a></h5>
<p>If you&#8217;re a developer, one of the most valuable things you can do is look at the GitHub issues list and help fix bugs.  We almost always prioritize bug fixing over
feature development, so clearing bugs out of the way is one of the best things you can do.</p>
<p>If you&#8217;re not a developer, helping test pull requests for bug fixes and features is still immensely valuable.  You can do this by checking out ansible, making a test
branch off the main one, merging a GitHub issue, testing, and then commenting on that particular issue on GitHub.</p>
</div>
<div class="section" id="i-d-like-to-report-a-bug">
<h5><a class="toc-backref" href="#id9">I&#8217;d Like To Report A Bug</a><a class="headerlink" href="#i-d-like-to-report-a-bug" title="Permalink to this headline">¶</a></h5>
<p>Ansible practices responsible disclosure - if this is a security related bug, email <a class="reference external" href="mailto:security&#37;&#52;&#48;ansible&#46;com">security<span>&#64;</span>ansible<span>&#46;</span>com</a> instead of filing a ticket or posting to the Google Group and you will receive a prompt response.</p>
<p>Ansible bugs should be reported to <a class="reference external" href="https://github.com/ansible/ansible">github.com/ansible/ansible</a> after
signing up for a free GitHub account.  Before reporting a bug, please use the bug/issue search
to see if the issue has already been reported.
This is listed on the bottom of the docs page for any module.</p>
<p>Knowing your ansible version and the exact commands you are running, and what you expect, saves time and helps us help everyone with their issues
more quickly.</p>
<p>Do not use the issue tracker for &#8220;how do I do this&#8221; type questions.  These are great candidates
for IRC or the mailing list instead where things are likely to be more of a discussion.</p>
<p>To be respectful of reviewers&#8217; time and allow us to help everyone efficiently, please
provide minimal well-reduced and well-commented examples versus sharing your entire production
playbook.  Include playbook snippets and output where possible.</p>
<p>When sharing YAML in playbooks, formatting can be preserved by using <a class="reference external" href="https://help.github.com/articles/creating-and-highlighting-code-blocks/">code blocks</a>.</p>
<p>For multiple-file content, we encourage use of gist.github.com.  Online pastebin content can expire, so it&#8217;s nice to have things around for a longer term if they
are referenced in a ticket.</p>
<p>If you are not sure if something is a bug yet, you are welcome to ask about something on
the mailing list or IRC first.</p>
<p>As we are a very high volume project, if you determine that
you do have a bug, please be sure to open the issue yourself to ensure we have a record of
it. Don’t rely on someone else in the community to file the bug report for you.</p>
<p>It may take some time to get to your report, see our information about priority flags below.</p>
</div>
<div class="section" id="i-d-like-to-help-with-documentation">
<h5><a class="toc-backref" href="#id10">I&#8217;d Like To Help With Documentation</a><a class="headerlink" href="#i-d-like-to-help-with-documentation" title="Permalink to this headline">¶</a></h5>
<p>Ansible documentation is a community project too!</p>
<p>If you would like to help with the
documentation, whether correcting a typo or improving a section, or maybe even
documenting a new feature, submit a GitHub pull request to  the code that
lives in the <code class="docutils literal"><span class="pre">docsite/rst</span></code> subdirectory of the project for most pages, and there is an &#8220;Edit on GitHub&#8221;
link up on those.</p>
<p>Module documentation is generated from a <code class="docutils literal"><span class="pre">DOCUMENTATION</span></code> structure embedded in the source code of each module, which is in <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/modules/">/lib/ansible/modules/</a>.</p>
<p>For more information on module documentation see <a class="reference external" href="http://docs.ansible.com/ansible/dev_guide/developing_modules_documenting.html">How to document modules</a>.</p>
<p>Aside from modules, the main docs are in restructured text
format.</p>
<p>If you aren’t comfortable with restructured text, you can also open a ticket on
GitHub about any errors you spot or sections you would like to see added. For more information
on creating pull requests, please refer to the
<a class="reference external" href="https://help.github.com/articles/using-pull-requests">GitHub help guide</a>.</p>
</div>
</div>
<div class="section" id="for-current-and-prospective-developers">
<h4><a class="toc-backref" href="#id11">For Current and Prospective Developers</a><a class="headerlink" href="#for-current-and-prospective-developers" title="Permalink to this headline">¶</a></h4>
<div class="section" id="i-d-like-to-learn-how-to-develop-on-ansible">
<h5><a class="toc-backref" href="#id12">I&#8217;d Like To Learn How To Develop on Ansible</a><a class="headerlink" href="#i-d-like-to-learn-how-to-develop-on-ansible" title="Permalink to this headline">¶</a></h5>
<p>If you&#8217;re new to Ansible and would like to figure out how to work on things, stop by the ansible-devel mailing list
and say hi, and we can hook you up.</p>
<p>A great way to get started would be reading over some of the development documentation on the module site, and then
finding a bug to fix or small feature to add.</p>
<p>Modules are some of the easiest places to get started.</p>
</div>
<div class="section" id="contributing-code-features-or-bugfixes">
<h5><a class="toc-backref" href="#id13">Contributing Code (Features or Bugfixes)</a><a class="headerlink" href="#contributing-code-features-or-bugfixes" title="Permalink to this headline">¶</a></h5>
<p>The Ansible project keeps its source on GitHub at <a class="reference external" href="https://github.com/ansible/ansible">github.com/ansible/ansible</a>.</p>
<p>The project takes contributions through <a class="reference external" href="https://help.github.com/articles/using-pull-requests">github pull requests</a>.</p>
<p>It is usually a good idea to join the ansible-devel list to discuss any large features prior to submission,
and this especially helps in avoiding duplicate work or efforts where we decide, upon seeing a pull request
for the first time, that revisions are needed. (This is not usually needed for module development, but can be nice for large changes).</p>
<p>Note that we do keep Ansible to a particular aesthetic, so if you are unclear about whether a feature
is a good fit or not, having the discussion on the development list is often a lot easier than having
to modify a pull request later.</p>
<p>New module developers should read through <a class="reference external" href="http://docs.ansible.com/ansible/dev_guide/developing_modules.html">developing modules</a>.</p>
<p>For more information about testing see <a class="reference external" href="http://docs.ansible.com/ansible/dev_guide/testing.html">testing</a>.</p>
<p>In order to keep the history clean and better audit incoming code, we will require resubmission of pull requests that
contain merge commits.  Use <code class="docutils literal"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">--rebase</span></code> (rather than <code class="docutils literal"><span class="pre">git</span> <span class="pre">pull</span></code>) and <code class="docutils literal"><span class="pre">git</span> <span class="pre">rebase</span></code> (rather than <code class="docutils literal"><span class="pre">git</span> <span class="pre">merge</span></code>). Also be sure to use topic
branches to keep your additions on different branches, such that they won&#8217;t pick up stray commits later.</p>
<p>If you make a mistake you do not need to close your PR. Instead, create a clean branch locally and then push to GitHub
with <code class="docutils literal"><span class="pre">--force</span></code> to overwrite the existing branch (permissible in this case as no one else should be using that
branch as reference). Code comments won&#8217;t be lost, they just won&#8217;t be attached to the existing branch.</p>
<p>We’ll then review your contributions and engage with you about questions and  so on.</p>
<p>Because we have a very large and active community it may take awhile to get your contributions
in!  See the notes about priorities in a later section for understanding our work queue.
Be patient, your request might not get merged right away, we also try to keep the devel branch more
or less usable so we like to examine Pull requests carefully, which takes time.</p>
<p>Patches should always be made against the <code class="docutils literal"><span class="pre">devel</span></code> branch.</p>
<p>Keep in mind that small and focused requests are easier to examine and accept, having example cases
also help us understand the utility of a bug fix or a new feature.</p>
<p>Contributions can be for new features like modules, or to fix bugs you or others have found. If you
are interested in writing new modules to be included in the core Ansible distribution, please refer
to the <a class="reference external" href="http://docs.ansible.com/developing_modules.html">module development documentation</a>.</p>
<p>Ansible&#8217;s aesthetic encourages simple, readable code and consistent,
conservatively extending, backwards-compatible improvements. When contributing code to Ansible,
please observe the following guidelines:</p>
<ul class="simple">
<li>Code developed for Ansible needs to support Python2-2.6 or higher and Python3-3.5 or higher.</li>
<li>Use a 4-space indent, not  tabs.</li>
<li>We do not enforce 80 column lines; up to 160 columns are acceptable.</li>
<li>We do not accept &#8216;style only&#8217; pull requests unless the code is nearly unreadable.</li>
<li>We are &#8220;PEP8ish&#8221;, but not strictly compliant, see <span class="xref doc">testing_pep8</span> for more information.</li>
</ul>
<p>You can also contribute by testing and revising other requests, especially if it is one you are interested
in using. Please keep your comments clear and to the point, courteous and constructive, tickets are not a
good place to start discussions (ansible-devel and IRC exist for this).</p>
<p>Tip: To easily run from a checkout, source <code class="docutils literal"><span class="pre">./hacking/env-setup</span></code> and that&#8217;s it &#8211; no install
required.  You&#8217;re now live! For more information see <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/hacking/README.md">hacking/README.md</a>.</p>
</div>
</div>
<div class="section" id="other-topics">
<h4><a class="toc-backref" href="#id14">Other Topics</a><a class="headerlink" href="#other-topics" title="Permalink to this headline">¶</a></h4>
<div class="section" id="ansible-staff">
<h5><a class="toc-backref" href="#id15">Ansible Staff</a><a class="headerlink" href="#ansible-staff" title="Permalink to this headline">¶</a></h5>
<p>Ansible, Inc is a company supporting Ansible and building additional solutions based on
Ansible.  We also do services and support for those that are interested. We also offer an
enterprise web front end to Ansible (see Tower below).</p>
<p>Our most important task however is enabling all the great things that happen in the Ansible
community, including organizing software releases of Ansible.  For more information about
any of these things, contact <a class="reference external" href="mailto:info&#37;&#52;&#48;ansible&#46;com">info<span>&#64;</span>ansible<span>&#46;</span>com</a></p>
<p>On IRC, you can find us as jimi_c, abadger1999, Tybstar, bcoca, and others.   On the mailing list,
we post with an &#64;ansible.com address.</p>
</div>
<div class="section" id="mailing-list-information">
<h5><a class="toc-backref" href="#id16">Mailing List Information</a><a class="headerlink" href="#mailing-list-information" title="Permalink to this headline">¶</a></h5>
<p>Ansible has several mailing lists.  Your first post to the mailing list will be
moderated (to reduce spam), so please allow a day or less for your first post.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-project">Ansible Project List</a> is for sharing Ansible Tips,
answering questions, and general user discussion.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-devel">Ansible Development List</a> is for learning how to develop on Ansible,
asking about prospective feature design, or discussions about extending ansible or features in progress.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-announce">Ansible Announce list</a> is a read-only list that shares information
about new releases of Ansible, and also rare infrequent event information, such as announcements about an AnsibleFest coming up,
which is our official conference series.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-lockdown">Ansible Lockdown List</a> is for all things related to Ansible Lockdown projects, including DISA STIG automation and CIS Benchmarks.</p>
<p>To subscribe to a group from a non-google account, you can send an email to the subscription address requesting the subscription. For example: <a class="reference external" href="mailto:ansible-devel+subscribe&#37;&#52;&#48;googlegroups&#46;com">ansible-devel+subscribe<span>&#64;</span>googlegroups<span>&#46;</span>com</a></p>
</div>
<div class="section" id="irc-meetings">
<h5><a class="toc-backref" href="#id17">IRC Meetings</a><a class="headerlink" href="#irc-meetings" title="Permalink to this headline">¶</a></h5>
<p>The Ansible community holds regular IRC meetings on various topics, and anyone who is interested is invited to
participate. For more information about Ansible meetings, consult the <a class="reference external" href="https://github.com/ansible/community/blob/master/meetings/README.md">meeting schedule and agenda page</a>.</p>
</div>
<div class="section" id="release-numbering">
<h5><a class="toc-backref" href="#id18">Release Numbering</a><a class="headerlink" href="#release-numbering" title="Permalink to this headline">¶</a></h5>
<p>Releases ending in &#8221;.0&#8221; are major releases and this is where all new features land.  Releases ending
in another integer, like &#8220;0.X.1&#8221; and &#8220;0.X.2&#8221; are dot releases, and these are only going to contain
bugfixes.</p>
<p>Typically we don&#8217;t do dot releases for minor bugfixes (reserving these for larger items),
but may occasionally decide to cut dot releases containing a large number of smaller fixes if it&#8217;s still a fairly long time before
the next release comes out.</p>
<p>Releases are also given code names based on Van Halen songs, that no one really uses.</p>
</div>
<div class="section" id="tower-support-questions">
<h5><a class="toc-backref" href="#id19">Tower Support Questions</a><a class="headerlink" href="#tower-support-questions" title="Permalink to this headline">¶</a></h5>
<p>Ansible <a class="reference external" href="https://ansible.com/tower">Tower</a> is a UI, Server, and REST endpoint for Ansible, produced by Ansible, Inc.</p>
<p>If you have a question about Tower, visit <a class="reference external" href="https://access.redhat.com/products/ansible-tower-red-hat/">Red Hat support</a> rather than using the IRC
channel or the general project mailing list.</p>
</div>
<div class="section" id="irc-channel">
<h5><a class="toc-backref" href="#id20">IRC Channel</a><a class="headerlink" href="#irc-channel" title="Permalink to this headline">¶</a></h5>
<p>Ansible has several IRC channels on Freenode (irc.freenode.net):</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">#ansible</span></code> - For general use questions and support.</li>
<li><code class="docutils literal"><span class="pre">#ansible-devel</span></code> - For discussions on developer topics and code related to features/bugs.</li>
<li><code class="docutils literal"><span class="pre">#ansible-aws</span></code> - For discussions on Amazon Web Services.</li>
<li><code class="docutils literal"><span class="pre">#ansible-container</span></code> - For discussions on Ansible Container.</li>
<li><code class="docutils literal"><span class="pre">#ansible-vmware</span></code> - For discussions on Ansible &amp; VMware.</li>
<li><code class="docutils literal"><span class="pre">#ansible-windows</span></code> - For discussions on Ansible &amp; Windows.</li>
<li><code class="docutils literal"><span class="pre">#ansible-meeting</span></code> - For public community meetings. We will generally announce these on one or more of the above mailing lists. See the <a class="reference external" href="https://github.com/ansible/community/blob/master/meetings/README.md">meeting schedule and agenda page</a></li>
<li><code class="docutils literal"><span class="pre">#ansible-notices</span></code> - Mostly bot output from things like Github, etc.</li>
</ul>
</div>
<div class="section" id="notes-on-priority-flags">
<h5><a class="toc-backref" href="#id21">Notes on Priority Flags</a><a class="headerlink" href="#notes-on-priority-flags" title="Permalink to this headline">¶</a></h5>
<p>Ansible was one of the top 5 projects with the most OSS contributors on GitHub in 2013, and has over 1400 contributors
to the project to date, not to mention a very large user community that has downloaded the application well over a million
times. As a result, we have a LOT of incoming activity to process.</p>
<p>In the interest of transparency, we&#8217;re telling you how we sort incoming requests.</p>
<p>In our bug tracker you&#8217;ll notice some labels - P1 and P2.  These are the internal
priority orders that we use to sort tickets.</p>
<p>With some exceptions for easy merges (like documentation typos for instance),
we&#8217;re going to spend most of our time working on P1 and P2 items first, including pull requests.
These usually relate to important bugs or features affecting large segments of the userbase.  If you see something categorized without P1 or P2, and it&#8217;s not appearing to get a lot of immediate attention, this is why.</p>
<p>These labels don&#8217;t really have a definition - they are a simple ordering.  However something
affecting a major module (yum, apt, etc) is likely to be prioritized higher than a module
affecting a smaller number of users.</p>
<p>Since we place a strong emphasis on testing and code review, it may take a few months for a minor feature to get merged. This doesn&#8217;t mean that we&#8217;ll be exhausting all of the higher-priority queues before getting to your ticket; we will also take periodic sweeps through the lower priority queues and give them some attention as well, particularly in the area of new module changes.</p>
<p>Every bit of effort helps - if you&#8217;re wishing to expedite the inclusion of a P3 feature pull request for instance, the best thing you can do is help close P2 bug reports.</p>
</div>
</div>
<div class="section" id="community-code-of-conduct">
<h4><a class="toc-backref" href="#id22">Community Code of Conduct</a><a class="headerlink" href="#community-code-of-conduct" title="Permalink to this headline">¶</a></h4>
<p>Every community can be strengthened by a diverse variety of viewpoints, insights,
opinions, skillsets, and skill levels. However, with diversity comes the potential for
disagreement and miscommunication. The purpose of this Code of Conduct is to ensure that
disagreements and differences of opinion are conducted respectfully and on their own
merits, without personal attacks or other behavior that might create an unsafe or
unwelcoming environment.</p>
<p>These policies are not designed to be a comprehensive set of Things You Cannot Do. We ask
that you treat your fellow community members with respect and courtesy, and in general,
Don&#8217;t Be A Jerk. This Code of Conduct is meant to be followed in spirit as much as in
letter and is not exhaustive.</p>
<p>All Ansible events and participants therein are governed by this Code of Conduct and
anti-harassment policy. We expect organizers to enforce these guidelines throughout all events,
and we expect attendees, speakers, sponsors, and volunteers to help ensure a safe
environment for our whole community. Specifically, this Code of Conduct covers
participation in all Ansible-related forums and mailing lists, code and documentation
contributions, public IRC channels, private correspondence, and public meetings.</p>
<p>Ansible community members are...</p>
<p><strong>Considerate</strong></p>
<p>Contributions of every kind have far-ranging consequences. Just as your work depends on
the work of others, decisions you make surrounding your contributions to the Ansible
community will affect your fellow community members. You are strongly encouraged to take
those consequences into account while making decisions.</p>
<p><strong>Patient</strong></p>
<p>Asynchronous communication can come with its own frustrations, even in the most responsive
of communities. Please remember that our community is largely built on volunteered time,
and that questions, contributions, and requests for support may take some time to receive
a response. Repeated &#8220;bumps&#8221; or &#8220;reminders&#8221; in rapid succession are not good displays of
patience. Additionally, it is considered poor manners to ping a specific person with
general questions. Pose your question to the community as a whole, and wait patiently for
a response.</p>
<p><strong>Respectful</strong></p>
<p>Every community inevitably has disagreements, but remember that it is
possible to disagree respectfully and courteously. Disagreements are never an excuse for
rudeness, hostility, threatening behavior, abuse (verbal or physical), or personal attacks.</p>
<p><strong>Kind</strong></p>
<p>Everyone should feel welcome in the Ansible community, regardless of their background.
Please be courteous, respectful and polite to fellow community members. Do not make or
post offensive comments related to skill level, gender, gender identity or expression,
sexual orientation, disability, physical appearance, body size, race, or religion.
Sexualized images or imagery, real or implied violence, intimidation, oppression,
stalking, sustained disruption of activities, publishing the personal information of
others without explicit permission to do so, unwanted physical contact, and unwelcome
sexual attention are all strictly prohibited.  Additionally, you are encouraged not to
make assumptions about the background or identity of your fellow community members.</p>
<p><strong>Inquisitive</strong></p>
<p>The only stupid question is the one that does not get asked. We
encourage our users to ask early and ask often. Rather than asking whether you can ask a
question (the answer is always yes!), instead, simply ask your question. You are
encouraged to provide as many specifics as possible. Code snippets in the form of Gists or
other paste site links are almost always needed in order to get the most helpful answers.
Refrain from pasting multiple lines of code directly into the IRC channels - instead use
gist.github.com or another paste site to provide code snippets.</p>
<p><strong>Helpful</strong></p>
<p>The Ansible community is committed to being a welcoming environment for all users,
regardless of skill level. We were all beginners once upon a time, and our community
cannot grow without an environment where new users feel safe and comfortable asking questions.
It can become frustrating to answer the same questions repeatedly; however, community
members are expected to remain courteous and helpful to all users equally, regardless of
skill or knowledge level. Avoid providing responses that prioritize snideness and snark over
useful information. At the same time, everyone is expected to read the provided
documentation thoroughly. We are happy to answer questions, provide strategic guidance,
and suggest effective workflows, but we are not here to do your job for you.</p>
<div class="section" id="anti-harassment-policy">
<h5><a class="toc-backref" href="#id23">Anti-harassment policy</a><a class="headerlink" href="#anti-harassment-policy" title="Permalink to this headline">¶</a></h5>
<p>Harassment includes (but is not limited to) all of the following behaviors:</p>
<ul class="simple">
<li>Offensive comments related to gender (including gender expression and identity), age, sexual orientation, disability, physical appearance, body size, race, and religion</li>
<li>Derogatory terminology including words commonly known to be slurs</li>
<li>Posting sexualized images or imagery in public spaces</li>
<li>Deliberate intimidation</li>
<li>Stalking</li>
<li>Posting others&#8217; personal information without explicit permission</li>
<li>Sustained disruption of talks or other events</li>
<li>Inappropriate physical contact</li>
<li>Unwelcome sexual attention</li>
</ul>
<p>Participants asked to stop any harassing behavior are expected to comply immediately.
Sponsors are also subject to the anti-harassment policy. In particular, sponsors should
not use sexualized images, activities, or other material. Meetup organizing staff and
other volunteer organizers should not use sexualized attire or otherwise create a
sexualized environment at community events.</p>
<p>In addition to the behaviors outlined above, continuing to behave a certain way after you
have been asked to stop also constitutes harassment, even if that behavior is not
specifically outlined in this policy. It is considerate and respectful to stop doing
something after you have been asked to stop, and all community members are expected to
comply with such requests immediately.</p>
</div>
<div class="section" id="policy-violations">
<h5><a class="toc-backref" href="#id24">Policy violations</a><a class="headerlink" href="#policy-violations" title="Permalink to this headline">¶</a></h5>
<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be reported by
contacting <a class="reference external" href="mailto:greg&#37;&#52;&#48;ansible&#46;com">greg<span>&#64;</span>ansible<span>&#46;</span>com</a>, to any channel operator in the community IRC
channels, or to the local organizers of an event. Meetup organizers are encouraged to
prominently display points of contact for reporting unacceptable behavior at local events.</p>
<p>If a participant engages in harassing behavior, the meetup organizers may take any action
they deem appropriate. These actions may include but are not limited to warning the
offender, expelling the offender from the event, and barring the offender from future
community events.</p>
<p>Organizers will be happy to help participants contact security or local law enforcement,
provide escorts to an alternate location, or otherwise assist those experiencing
harassment to feel safe for the duration of the meetup. We value the safety and well-being
of our community members and want everyone to feel welcome at our events, both online and
offline.</p>
<p>We expect all participants, organizers, speakers, and attendees to follow these policies at
all of our event venues and event-related social events.</p>
<p>The Ansible Community Code of Conduct is licensed under the Creative Commons
Attribution-Share Alike 3.0 license. Our Code of Conduct was adapted from Codes of Conduct
of other open source projects, including:</p>
<ul class="simple">
<li>Contributor Covenant</li>
<li>Elastic</li>
<li>The Fedora Project</li>
<li>OpenStack</li>
<li>Puppet Labs</li>
<li>Ubuntu</li>
</ul>
</div>
</div>
<div class="section" id="contributors-license-agreement">
<h4><a class="toc-backref" href="#id25">Contributors License Agreement</a><a class="headerlink" href="#contributors-license-agreement" title="Permalink to this headline">¶</a></h4>
<p>By contributing you agree that these contributions are your own (or approved by your employer) and you grant a full, complete, irrevocable
copyright license to all users and developers of the project, present and future, pursuant to the license of the project.</p>
</div>
</div>
<span id="document-galaxy"></span><div class="section" id="ansible-galaxy">
<h3><a class="toc-backref" href="#id2">Ansible Galaxy</a><a class="headerlink" href="#ansible-galaxy" title="Permalink to this headline">¶</a></h3>
<p><em>Ansible Galaxy</em> refers to the <a class="reference external" href="https://galaxy.ansible.com">Galaxy</a>  website where users can share roles, and to a command line tool for installing,
creating and managing roles.</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#ansible-galaxy" id="id2">Ansible Galaxy</a><ul>
<li><a class="reference internal" href="#the-website" id="id3">The Website</a></li>
<li><a class="reference internal" href="#the-command-line-tool" id="id4">The command line tool</a><ul>
<li><a class="reference internal" href="#installing-roles" id="id5">Installing Roles</a><ul>
<li><a class="reference internal" href="#roles-path" id="id6">roles_path</a></li>
<li><a class="reference internal" href="#version" id="id7">version</a></li>
<li><a class="reference internal" href="#installing-multiple-roles-from-a-file" id="id8">Installing multiple roles from a file</a></li>
<li><a class="reference internal" href="#installing-multiple-roles-from-multiple-files" id="id9">Installing multiple roles from multiple files</a></li>
<li><a class="reference internal" href="#dependencies" id="id10">Dependencies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#create-roles" id="id11">Create roles</a><ul>
<li><a class="reference internal" href="#force" id="id12">Force</a></li>
<li><a class="reference internal" href="#container-enabled" id="id13">Container Enabled</a></li>
<li><a class="reference internal" href="#using-a-custom-role-skeleton" id="id14">Using a Custom Role Skeleton</a></li>
</ul>
</li>
<li><a class="reference internal" href="#search-for-roles" id="id15">Search for Roles</a></li>
<li><a class="reference internal" href="#get-more-information-about-a-role" id="id16">Get more information about a role</a></li>
<li><a class="reference internal" href="#list-installed-roles" id="id17">List installed roles</a></li>
<li><a class="reference internal" href="#remove-an-installed-role" id="id18">Remove an installed role</a></li>
<li><a class="reference internal" href="#authenticate-with-galaxy" id="id19">Authenticate with Galaxy</a></li>
<li><a class="reference internal" href="#import-a-role" id="id20">Import a role</a><ul>
<li><a class="reference internal" href="#branch" id="id21">Branch</a></li>
<li><a class="reference internal" href="#role-name" id="id22">Role name</a></li>
<li><a class="reference internal" href="#no-wait" id="id23">No wait</a></li>
</ul>
</li>
<li><a class="reference internal" href="#delete-a-role" id="id24">Delete a role</a></li>
<li><a class="reference internal" href="#travis-integrations" id="id25">Travis integrations</a><ul>
<li><a class="reference internal" href="#list-travis-integrations" id="id26">List Travis integrations</a></li>
<li><a class="reference internal" href="#remove-travis-integrations" id="id27">Remove Travis integrations</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="the-website">
<h4><a class="toc-backref" href="#id3">The Website</a><a class="headerlink" href="#the-website" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://galaxy.ansible.com">Galaxy</a>, is a free site for finding, downloading, and sharing community developed roles. Downloading roles from Galaxy is
a great way to jumpstart your automation projects.</p>
<p>You can also use the site to share roles that you create. By authenticating with the site using your GitHub account, you&#8217;re able to <em>import</em> roles, making
them available to the Ansible community. Imported roles become available in the Galaxy search index and visible on the site, allowing users to
discover and download them.</p>
<p>Learn more by viewing <a class="reference external" href="https://galaxy.ansible.com/intro">the About page</a>.</p>
</div>
<div class="section" id="the-command-line-tool">
<h4><a class="toc-backref" href="#id4">The command line tool</a><a class="headerlink" href="#the-command-line-tool" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal"><span class="pre">ansible-galaxy</span></code> command comes bundled with Ansible, and you can use it to install roles from Galaxy or directly from a git based SCM. You can
also use it to create a new role, remove roles, or perform tasks on the Galaxy website.</p>
<p>The command line tool by default communicates with the Galaxy website API using the server address <em>https://galaxy.ansible.com</em>. Since the <a class="reference external" href="https://github.com/ansible/galaxy">Galaxy project</a>
is an open source project, you may be running your own internal Galaxy server and wish to override the default server address. You can do this using the <em>&#8211;server</em> option
or by setting the Galaxy server value in your <em>ansible.cfg</em> file. For information on setting the value in <em>ansible.cfg</em> visit <a class="reference external" href="./intro_configuration.html#galaxy-settings">Galaxy Settings</a>.</p>
<div class="section" id="installing-roles">
<h5><a class="toc-backref" href="#id5">Installing Roles</a><a class="headerlink" href="#installing-roles" title="Permalink to this headline">¶</a></h5>
<p>Use the <code class="docutils literal"><span class="pre">ansible-galaxy</span></code> command to download roles from the <a class="reference external" href="https://galaxy.ansible.com">Galaxy website</a></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy install username.role_name
</pre></div>
</div>
<div class="section" id="roles-path">
<h6><a class="toc-backref" href="#id6">roles_path</a><a class="headerlink" href="#roles-path" title="Permalink to this headline">¶</a></h6>
<p>Be aware that by default Ansible downloads roles to the path specified by the environment variable <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_ROLES_PATH</span></code>. This can be set to a series of
directories (i.e. <em>/etc/ansible/roles:~/.ansible/roles</em>), in which case the first writable path will be used. When Ansible is first installed it defaults
to <em>/etc/ansible/roles</em>, which requires <em>root</em> privileges.</p>
<p>You can override this by setting the environment variable in your session, defining <em>roles_path</em> in an <em>ansible.cfg</em> file, or by using the <em>&#8211;roles-path</em> option.
The following provides an example of using <em>&#8211;roles-path</em> to install the role into the current working directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy install --roles-path . geerlingguy.apache
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-intro_configuration"><span class="doc">Configuration file</span></a></dt>
<dd>All about configuration files</dd>
</dl>
</div>
</div>
<div class="section" id="version">
<h6><a class="toc-backref" href="#id7">version</a><a class="headerlink" href="#version" title="Permalink to this headline">¶</a></h6>
<p>You can install a specific version of a role from Galaxy by appending a comma and the value of a GitHub release tag. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy install geerlingguy.apache,v1.0.0
</pre></div>
</div>
<p>It&#8217;s also possible to point directly to the git repository and specify a branch name or commit hash as the version. For example, the following will
install a specific commit:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy install git+https://github.com/geerlingguy/ansible-role-apache.git,0b7cd353c0250e87a26e0499e59e7fd265cc2f25
</pre></div>
</div>
</div>
<div class="section" id="installing-multiple-roles-from-a-file">
<h6><a class="toc-backref" href="#id8">Installing multiple roles from a file</a><a class="headerlink" href="#installing-multiple-roles-from-a-file" title="Permalink to this headline">¶</a></h6>
<p>Beginning with Ansible 1.8 it is possible to install multiple roles by including the roles in a <em>requirements.yml</em> file. The format of the file is YAML, and the
file extension must be either <em>.yml</em> or <em>.yaml</em>.</p>
<p>Use the following command to install roles included in <em>requirements.yml</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy install -r requirements.yml
</pre></div>
</div>
<p>Again, the extension is important. If the <em>.yml</em> extension is left off, the <code class="docutils literal"><span class="pre">ansible-galaxy</span></code> CLI assumes the file is in an older, now deprecated,
&#8220;basic&#8221; format.</p>
<p>Each role in the file will have one or more of the following attributes:</p>
<blockquote>
<div><dl class="docutils">
<dt>src</dt>
<dd>The source of the role. Use the format <em>username.role_name</em>, if downloading from Galaxy; otherwise, provide a URL pointing
to a repository within a git based SCM. See the examples below. This is a required attribute.</dd>
<dt>scm</dt>
<dd>Specify the SCM. As of this writing only <em>git</em> or <em>hg</em> are supported. See the examples below. Defaults to <em>git</em>.</dd>
<dt>version:</dt>
<dd>The version of the role to download. Provide a release tag value, commit hash, or branch name. Defaults to <em>master</em>.</dd>
<dt>name:</dt>
<dd>Download the role to a specific name. Defaults to the Galaxy name when downloading from Galaxy, otherwise it defaults
to the name of the repository.</dd>
</dl>
</div></blockquote>
<p>Use the following example as a guide for specifying roles in <em>requirements.yml</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># from galaxy</span>
- src: yatesr.timezone

<span class="c1"># from GitHub</span>
- src: https://github.com/bennojoy/nginx

<span class="c1"># from GitHub, overriding the name and specifying a specific tag</span>
- src: https://github.com/bennojoy/nginx
  version: master
  name: nginx_role

<span class="c1"># from a webserver, where the role is packaged in a tar.gz</span>
- src: https://some.webserver.example.com/files/master.tar.gz
  name: http-role

<span class="c1"># from Bitbucket</span>
- src: git+http://bitbucket.org/willthames/git-ansible-galaxy
  version: v1.4

<span class="c1"># from Bitbucket, alternative syntax and caveats</span>
- src: http://bitbucket.org/willthames/hg-ansible-galaxy
  scm: hg

<span class="c1"># from GitLab or other git-based scm</span>
- src: git@gitlab.company.com:mygroup/ansible-base.git
  scm: git
  version: <span class="s2">&quot;0.1&quot;</span>  <span class="c1"># quoted, so YAML doesn&#39;t parse this as a floating-point value</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-multiple-roles-from-multiple-files">
<h6><a class="toc-backref" href="#id9">Installing multiple roles from multiple files</a><a class="headerlink" href="#installing-multiple-roles-from-multiple-files" title="Permalink to this headline">¶</a></h6>
<p>At a basic level, including requirements files allows you to break up bits of roles into smaller files. Role includes pull in roles from other files.</p>
<p>Use the following command to install roles includes in <em>requirements.yml</em>  + <em>webserver,yml</em></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible-galaxy install -r requirements.yml
</pre></div>
</div>
<p>Content of the <em>requirements.yml</em> file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># from galaxy</span>
- src: yatesr.timezone

- import_tasks: &lt;path_to_requirements&gt;/webserver.yml
</pre></div>
</div>
<p>Content of the <em>webserver.yml</em> file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># from github</span>
- src: https://github.com/bennojoy/nginx

<span class="c1"># from Bitbucket</span>
- src: git+http://bitbucket.org/willthames/git-ansible-galaxy
  version: v1.4
</pre></div>
</div>
</div>
<div class="section" id="dependencies">
<h6><a class="toc-backref" href="#id10">Dependencies</a><a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h6>
<p>Roles can also be dependent on other roles, and when you install a role that has dependencies, those dependenices will automatically be installed.</p>
<p>You specify role dependencies in the <code class="docutils literal"><span class="pre">meta/main.yml</span></code> file by providing a list of roles. If the source of a role is Galaxy, you can simply specify the role in
the format <code class="docutils literal"><span class="pre">username.role_name</span></code>. The more complex format used in <code class="docutils literal"><span class="pre">requirements.yml</span></code> is also supported, allowing you to provide <code class="docutils literal"><span class="pre">src</span></code>, <code class="docutils literal"><span class="pre">scm</span></code>, <code class="docutils literal"><span class="pre">version</span></code>, and <code class="docutils literal"><span class="pre">name</span></code>.</p>
<p>Tags are inherited <em>down</em> the dependency chain. In order for tags to be applied to a role and all its dependencies, the tag should be applied to the role, not to all the tasks within a role.</p>
<p>Roles listed as dependencies are subject to conditionals and tag filtering, and may not execute fully depeneding on
what tags and conditinoals are applied.</p>
<p>Dependencies found in Galaxy can be specified as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>dependencies:
  - geerlingguy.apache
  - geerlingguy.ansible
</pre></div>
</div>
<p>The complex form can also be used as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>dependencies:
  - src: geerlingguy.ansible
  - src: git+https://github.com/geerlingguy/ansible-role-composer.git
    version: 775396299f2da1f519f0d8885022ca2d6ee80ee8
    name: composer
</pre></div>
</div>
<p>When dependencies are encountered by <code class="docutils literal"><span class="pre">ansible-galaxy</span></code>, it will automatically install each dependency to the <code class="docutils literal"><span class="pre">roles_path</span></code>. To understand how dependencies are handled during play execution, see <a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">At the time of this writing, the Galaxy website expects all role dependencies to exist in Galaxy, and therefore dependencies to be specified in the
<code class="docutils literal"><span class="pre">username.role_name</span></code> format. If you import a role with a dependency where the <code class="docutils literal"><span class="pre">src</span></code> value is a URL, the import process will fail.</p>
</div>
</div>
</div>
<div class="section" id="create-roles">
<h5><a class="toc-backref" href="#id11">Create roles</a><a class="headerlink" href="#create-roles" title="Permalink to this headline">¶</a></h5>
<p>Use the <code class="docutils literal"><span class="pre">init</span></code> command to initialize the base structure of a new role, saving time on creating the various directories and main.yml files a role requires</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy init role_name
</pre></div>
</div>
<p>The above will create the following directory structure in the current working directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>README.md
.travis.yml
defaults/
    main.yml
files/
handlers/
    main.yml
meta/
    main.yml
templates/
tests/
    inventory
    test.yml
vars/
    main.yml
</pre></div>
</div>
<div class="section" id="force">
<h6><a class="toc-backref" href="#id12">Force</a><a class="headerlink" href="#force" title="Permalink to this headline">¶</a></h6>
<p>If a directory matching the name of the role already exists in the current working directory, the init command will result in an error. To ignore the error
use the <em>&#8211;force</em> option. Force will create the above subdirectories and files, replacing anything that matches.</p>
</div>
<div class="section" id="container-enabled">
<h6><a class="toc-backref" href="#id13">Container Enabled</a><a class="headerlink" href="#container-enabled" title="Permalink to this headline">¶</a></h6>
<p>If you are creating a Container Enabled role, use the <em>&#8211;container-enabled</em> option. This will create the same directory structure as above, but populate it
with default files appropriate for a Container Enabled role. For instance, the README.md has a slightly different structure, the <em>.travis.yml</em> file tests
the role using <a class="reference external" href="https://github.com/ansible/ansible-container">Ansible Container</a>, and the meta directory includes a <em>container.yml</em> file.</p>
</div>
<div class="section" id="using-a-custom-role-skeleton">
<h6><a class="toc-backref" href="#id14">Using a Custom Role Skeleton</a><a class="headerlink" href="#using-a-custom-role-skeleton" title="Permalink to this headline">¶</a></h6>
<p>A custom role skeleton directory can be supplied as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy init --role-skeleton<span class="o">=</span>/path/to/skeleton role_name
</pre></div>
</div>
<p>When a skeleton is provided, init will:</p>
<ul class="simple">
<li>copy all files and directories from the skeleton to the new role</li>
<li>any .j2 files found outside of a templates folder will be rendered as templates. The only useful variable at the moment is role_name</li>
<li>The .git folder and any .git_keep files will not be copied</li>
</ul>
<p>Alternatively, the role_skeleton and ignoring of files can be configured via ansible.cfg</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>galaxy<span class="o">]</span>
<span class="nv">role_skeleton</span> <span class="o">=</span> /path/to/skeleton
<span class="nv">role_skeleton_ignore</span> <span class="o">=</span> ^.git$,^.*/.git_keep$
</pre></div>
</div>
</div>
</div>
<div class="section" id="search-for-roles">
<h5><a class="toc-backref" href="#id15">Search for Roles</a><a class="headerlink" href="#search-for-roles" title="Permalink to this headline">¶</a></h5>
<p>Search the Galaxy database by tags, platforms, author and multiple keywords. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy search elasticsearch --author geerlingguy
</pre></div>
</div>
<p>The search command will return a list of the first 1000 results matching your search:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Found <span class="m">2</span> roles matching your search:

Name                              Description
----                              -----------
geerlingguy.elasticsearch         Elasticsearch <span class="k">for</span> Linux.
geerlingguy.elasticsearch-curator Elasticsearch curator <span class="k">for</span> Linux.
</pre></div>
</div>
</div>
<div class="section" id="get-more-information-about-a-role">
<h5><a class="toc-backref" href="#id16">Get more information about a role</a><a class="headerlink" href="#get-more-information-about-a-role" title="Permalink to this headline">¶</a></h5>
<p>Use the <code class="docutils literal"><span class="pre">info</span></code> command to view more detail about a specific role:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy info username.role_name
</pre></div>
</div>
<p>This returns everything found in Galaxy for the role:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Role: username.role_name
    description: Installs and configures a thing, a distributed, highly available NoSQL thing.
    active: True
    commit: c01947b7bc89ebc0b8a2e298b87ab416aed9dd57
    commit_message: Adding travis
    commit_url: https://github.com/username/repo_name/commit/c01947b7bc89ebc0b8a2e298b87ab
    company: My Company, Inc.
    created: <span class="m">2015</span>-12-08T14:17:52.773Z
    download_count: <span class="m">1</span>
    forks_count: <span class="m">0</span>
    github_branch:
    github_repo: repo_name
    github_user: username
    id: <span class="m">6381</span>
    is_valid: True
    issue_tracker_url:
    license: Apache
    min_ansible_version: <span class="m">1</span>.4
    modified: <span class="m">2015</span>-12-08T18:43:49.085Z
    namespace: username
    open_issues_count: <span class="m">0</span>
    path: /Users/username/projects/roles
    scm: None
    src: username.repo_name
    stargazers_count: <span class="m">0</span>
    travis_status_url: https://travis-ci.org/username/repo_name.svg?branch<span class="o">=</span>master
    version:
    watchers_count: <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="section" id="list-installed-roles">
<h5><a class="toc-backref" href="#id17">List installed roles</a><a class="headerlink" href="#list-installed-roles" title="Permalink to this headline">¶</a></h5>
<p>Use <code class="docutils literal"><span class="pre">list</span></code> to show the name and version of each role installed in the <em>roles_path</em>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy list

- chouseknecht.role-install_mongod, master
- chouseknecht.test-role-1, v1.0.2
- chrismeyersfsu.role-iptables, master
- chrismeyersfsu.role-required_vars, master
</pre></div>
</div>
</div>
<div class="section" id="remove-an-installed-role">
<h5><a class="toc-backref" href="#id18">Remove an installed role</a><a class="headerlink" href="#remove-an-installed-role" title="Permalink to this headline">¶</a></h5>
<p>Use <code class="docutils literal"><span class="pre">remove</span></code> to delete a role from <em>roles_path</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy remove username.role_name
</pre></div>
</div>
</div>
<div class="section" id="authenticate-with-galaxy">
<h5><a class="toc-backref" href="#id19">Authenticate with Galaxy</a><a class="headerlink" href="#authenticate-with-galaxy" title="Permalink to this headline">¶</a></h5>
<p>Using the <code class="docutils literal"><span class="pre">import</span></code>, <code class="docutils literal"><span class="pre">delete</span></code> and <code class="docutils literal"><span class="pre">setup</span></code> commands to manage your roles on the Galaxy website requires authentication, and the <code class="docutils literal"><span class="pre">login</span></code> command
can be used to do just that. Before you can use the <code class="docutils literal"><span class="pre">login</span></code> command, you must create an account on the Galaxy website.</p>
<p>The <code class="docutils literal"><span class="pre">login</span></code> command requires using your GitHub credentials. You can use your username and password, or you can create a <a class="reference external" href="https://help.github.com/articles/creating-an-access-token-for-command-line-use/">personal access token</a>. If you choose to create a token, grant minimal access to the token, as it is used just to verify identify.</p>
<p>The following shows authenticating with the Galaxy website using a GitHub username and password:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy login

We need your GitHub login to identify you.
This information will not be sent to Galaxy, only to api.github.com.
The password will not be displayed.

Use --github-token <span class="k">if</span> you <span class="k">do</span> not want to enter your password.

Github Username: dsmith
Password <span class="k">for</span> dsmith:
Successfully logged into Galaxy as dsmith
</pre></div>
</div>
<p>When you choose to use your username and password, your password is not sent to Galaxy. It is used to authenticates with GitHub and create a personal access token.
It then sends the token to Galaxy, which in turn verifies that your identity and returns a Galaxy access token. After authentication completes the GitHub token is
destroyed.</p>
<p>If you do not wish to use your GitHub password, or if you have two-factor authentication enabled with GitHub, use the <em>&#8211;github-token</em> option to pass a personal access token
that you create.</p>
</div>
<div class="section" id="import-a-role">
<h5><a class="toc-backref" href="#id20">Import a role</a><a class="headerlink" href="#import-a-role" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal"><span class="pre">import</span></code> command requires that you first authenticate using the <code class="docutils literal"><span class="pre">login</span></code> command. Once authenticated you can import any GitHub repository that you own or have
been granted access.</p>
<p>Use the following to import to role:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy import github_user github_repo
</pre></div>
</div>
<p>By default the command will wait for Galaxy to complete the import process, displaying the results as the import progresses:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Successfully submitted import request <span class="m">41</span>
Starting import <span class="m">41</span>: <span class="nv">role_name</span><span class="o">=</span>myrole <span class="nv">repo</span><span class="o">=</span>githubuser/ansible-role-repo <span class="nv">ref</span><span class="o">=</span>
Retrieving GitHub repo githubuser/ansible-role-repo
Accessing branch: master
Parsing and validating meta/main.yml
Parsing galaxy_tags
Parsing platforms
Adding dependencies
Parsing and validating README.md
Adding repo tags as role versions
Import completed
Status SUCCESS : <span class="nv">warnings</span><span class="o">=</span><span class="m">0</span> <span class="nv">errors</span><span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
<div class="section" id="branch">
<h6><a class="toc-backref" href="#id21">Branch</a><a class="headerlink" href="#branch" title="Permalink to this headline">¶</a></h6>
<p>Use the <em>&#8211;branch</em> option to import a specific branch. If not specified, the default branch for the repo will be used.</p>
</div>
<div class="section" id="role-name">
<h6><a class="toc-backref" href="#id22">Role name</a><a class="headerlink" href="#role-name" title="Permalink to this headline">¶</a></h6>
<p>By default the name given to the role will be derived from the GitHub repository name. However, you can use the <em>&#8211;role-name</em> option to override this and set the name.</p>
</div>
<div class="section" id="no-wait">
<h6><a class="toc-backref" href="#id23">No wait</a><a class="headerlink" href="#no-wait" title="Permalink to this headline">¶</a></h6>
<p>If the <em>&#8211;no-wait</em> option is present, the command will not wait for results. Results of the most recent import for any of your roles is available on the Galaxy web site
by visiting <em>My Imports</em>.</p>
</div>
</div>
<div class="section" id="delete-a-role">
<h5><a class="toc-backref" href="#id24">Delete a role</a><a class="headerlink" href="#delete-a-role" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal"><span class="pre">delete</span></code> command requires that you first authenticate using the <code class="docutils literal"><span class="pre">login</span></code> command. Once authenticated you can remove a role from the Galaxy web site. You are only allowed
to remove roles where you have access to the repository in GitHub.</p>
<p>Use the following to delete a role:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy delete github_user github_repo
</pre></div>
</div>
<p>This only removes the role from Galaxy. It does not remove or alter the actual GitHub repository.</p>
</div>
<div class="section" id="travis-integrations">
<h5><a class="toc-backref" href="#id25">Travis integrations</a><a class="headerlink" href="#travis-integrations" title="Permalink to this headline">¶</a></h5>
<p>You can create an integration or connection between a role in Galaxy and <a class="reference external" href="http://travis-ci.org">Travis</a>. Once the connection is established, a build in Travis will
automatically trigger an import in Galaxy, updating the search index with the latest information about the role.</p>
<p>You create the integration using the <code class="docutils literal"><span class="pre">setup</span></code> command, but before an integration can be created, you must first authenticate using the <code class="docutils literal"><span class="pre">login</span></code> command; you will
also need an account in Travis, and your Travis token. Once you&#8217;re ready, use the following command to create the integration:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy setup travis github_user github_repo xxx-travis-token-xxx
</pre></div>
</div>
<p>The setup command requires your Travis token, however the token is not stored in Galaxy. It is used along with the GitHub username and repo to create a hash as described
in <a class="reference external" href="https://docs.travis-ci.com/user/notifications/">the Travis documentation</a>. The hash is stored in Galaxy and used to verify notifications received from Travis.</p>
<p>The setup command enables Galaxy to respond to notifications. To configure Travis to run a build on your repository and send a notification, follow the
<a class="reference external" href="https://docs.travis-ci.com/user/getting-started/">Travis getting started guide</a>.</p>
<p>To instruct Travis to notify Galaxy when a build completes, add the following to your .travis.yml file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>notifications:
    webhooks: https://galaxy.ansible.com/api/v1/notifications/
</pre></div>
</div>
<div class="section" id="list-travis-integrations">
<h6><a class="toc-backref" href="#id26">List Travis integrations</a><a class="headerlink" href="#list-travis-integrations" title="Permalink to this headline">¶</a></h6>
<p>Use the <em>&#8211;list</em> option to display your Travis integrations:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy setup --list


ID         Source     Repo
---------- ---------- ----------
<span class="m">2</span>          travis     github_user/github_repo
<span class="m">1</span>          travis     github_user/github_repo
</pre></div>
</div>
</div>
<div class="section" id="remove-travis-integrations">
<h6><a class="toc-backref" href="#id27">Remove Travis integrations</a><a class="headerlink" href="#remove-travis-integrations" title="Permalink to this headline">¶</a></h6>
<p>Use the <em>&#8211;remove</em> option to disable and remove a Travis integration:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ansible-galaxy setup --remove ID
</pre></div>
</div>
<p>Provide the ID of the integration to be disabled. You can find the ID by using the <em>&#8211;list</em> option.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks_reuse_roles"><span class="doc">Roles</span></a></dt>
<dd>All about ansible roles</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<span id="document-test_strategies"></span><div class="section" id="testing-strategies">
<h3>Testing Strategies<a class="headerlink" href="#testing-strategies" title="Permalink to this headline">¶</a></h3>
<div class="section" id="integrating-testing-with-ansible-playbooks">
<span id="testing-intro"></span><h4>Integrating Testing With Ansible Playbooks<a class="headerlink" href="#integrating-testing-with-ansible-playbooks" title="Permalink to this headline">¶</a></h4>
<p>Many times, people ask, &#8220;how can I best integrate testing with Ansible playbooks?&#8221;  There are many options.  Ansible is actually designed
to be a &#8220;fail-fast&#8221; and ordered system, therefore it makes it easy to embed testing directly in Ansible playbooks.  In this chapter,
we&#8217;ll go into some patterns for integrating tests of infrastructure and discuss the right level of testing that may be appropriate.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is a chapter about testing the application you are deploying, not the chapter on how to test Ansible modules during development.  For that content, please hop over to the Development section.</p>
</div>
<p>By incorporating a degree of testing into your deployment workflow, there will be fewer surprises when code hits production and, in many cases,
tests can be leveraged in production to prevent failed updates from migrating across an entire installation.  Since it&#8217;s push-based, it&#8217;s
also very easy to run the steps on the localhost or testing servers. Ansible lets you insert as many checks and balances into your upgrade workflow as you would like to have.</p>
</div>
<div class="section" id="the-right-level-of-testing">
<h4>The Right Level of Testing<a class="headerlink" href="#the-right-level-of-testing" title="Permalink to this headline">¶</a></h4>
<p>Ansible resources are models of desired-state.  As such, it should not be necessary to test that services are started, packages are
installed, or other such things.  Ansible is the system that will ensure these things are declaratively true.   Instead, assert these
things in your playbooks.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=foo state=started enabled=yes</span>
</pre></div>
</div>
<p>If you think the service may not be started, the best thing to do is request it to be started.  If the service fails to start, Ansible
will yell appropriately. (This should not be confused with whether the service is doing something functional, which we&#8217;ll show more about how to
do later).</p>
</div>
<div class="section" id="check-mode-as-a-drift-test">
<span id="check-mode-drift"></span><h4>Check Mode As A Drift Test<a class="headerlink" href="#check-mode-as-a-drift-test" title="Permalink to this headline">¶</a></h4>
<p>In the above setup, <cite>&#8211;check</cite> mode in Ansible can be used as a layer of testing as well.  If running a deployment playbook against an
existing system, using the <cite>&#8211;check</cite> flag to the <cite>ansible</cite> command will report if Ansible thinks it would have had to have made any changes to
bring the system into a desired state.</p>
<p>This can let you know up front if there is any need to deploy onto the given system.  Ordinarily scripts and commands don&#8217;t run in check mode, so if you
want certain steps to always execute in check mode, such as calls to the script module, disable check mode for those tasks:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roles:
  - webserver

tasks:
  - script: verify.sh
    check_mode: no
</pre></div>
</div>
</div>
<div class="section" id="modules-that-are-useful-for-testing">
<h4>Modules That Are Useful for Testing<a class="headerlink" href="#modules-that-are-useful-for-testing" title="Permalink to this headline">¶</a></h4>
<p>Certain playbook modules are particularly good for testing.  Below is an example that ensures a port is open:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

  - wait_for: <span class="nv">host</span><span class="o">={{</span> inventory_hostname <span class="o">}}</span> <span class="nv">port</span><span class="o">=</span><span class="m">22</span>
    delegate_to: localhost
</pre></div>
</div>
<p>Here&#8217;s an example of using the URI module to make sure a web service returns:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

  - action: uri <span class="nv">url</span><span class="o">=</span>http://www.example.com <span class="nv">return_content</span><span class="o">=</span>yes
    register: webpage

  - fail: <span class="nv">msg</span><span class="o">=</span><span class="s1">&#39;service is not happy&#39;</span>
    when: <span class="s2">&quot;&#39;AWESOME&#39; not in webpage.content&quot;</span>
</pre></div>
</div>
<p>It&#8217;s easy to push an arbitrary script (in any language) on a remote host and the script will automatically fail if it has a non-zero return code:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

  - script: test_script1
  - script: test_script2 --parameter value --parameter2 value
</pre></div>
</div>
<p>If using roles (you should be, roles are great!), scripts pushed by the script module can live in the &#8216;files/&#8217; directory of a role.</p>
<p>And the assert module makes it very easy to validate various kinds of truth:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

   - shell: /usr/bin/some-command --parameter value
     register: cmd_result

   - assert:
       that:
         - <span class="s2">&quot;&#39;not ready&#39; not in cmd_result.stderr&quot;</span>
         - <span class="s2">&quot;&#39;gizmo enabled&#39; in cmd_result.stdout&quot;</span>
</pre></div>
</div>
<p>Should you feel the need to test for existence of files that are not declaratively set by your Ansible configuration, the &#8216;stat&#8217; module is a great choice:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tasks:

   - stat: <span class="nv">path</span><span class="o">=</span>/path/to/something
     register: p

   - assert:
       that:
         - p.stat.exists and p.stat.isdir
</pre></div>
</div>
<p>As mentioned above, there&#8217;s no need to check things like the return codes of commands.  Ansible is checking them automatically.
Rather than checking for a user to exist, consider using the user module to make it exist.</p>
<p>Ansible is a fail-fast system, so when there is an error creating that user, it will stop the playbook run.  You do not have
to check up behind it.</p>
</div>
<div class="section" id="testing-lifecycle">
<h4>Testing Lifecycle<a class="headerlink" href="#testing-lifecycle" title="Permalink to this headline">¶</a></h4>
<p>If writing some degree of basic validation of your application into your playbooks, they will run every time you deploy.</p>
<p>As such, deploying into a local development VM and a staging environment will both validate that things are according to plan
ahead of your production deploy.</p>
<p>Your workflow may be something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- Use the same playbook all the <span class="nb">time</span> with embedded tests in development
- Use the playbook to deploy to a staging environment <span class="o">(</span>with the same playbooks<span class="o">)</span> that simulates production
- Run an integration <span class="nb">test</span> battery written by your QA team against staging
- Deploy to production, with the same integrated tests.
</pre></div>
</div>
<p>Something like an integration test battery should be written by your QA team if you are a production webservice.  This would include
things like Selenium tests or automated API tests and would usually not be something embedded into your Ansible playbooks.</p>
<p>However, it does make sense to include some basic health checks into your playbooks, and in some cases it may be possible to run
a subset of the QA battery against remote nodes.   This is what the next section covers.</p>
</div>
<div class="section" id="integrating-testing-with-rolling-updates">
<h4>Integrating Testing With Rolling Updates<a class="headerlink" href="#integrating-testing-with-rolling-updates" title="Permalink to this headline">¶</a></h4>
<p>If you have read into <a class="reference internal" href="index.html#document-playbooks_delegation"><span class="doc">Delegation, Rolling Updates, and Local Actions</span></a> it may quickly become apparent that the rolling update pattern can be extended, and you
can use the success or failure of the playbook run to decide whether to add a machine into a load balancer or not.</p>
<p>This is the great culmination of embedded tests:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  serial: <span class="m">5</span>

  pre_tasks:

    - name: take out of load balancer pool
      command: /usr/bin/take_out_of_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: <span class="m">127</span>.0.0.1

  roles:

     - common
     - webserver
     - apply_testing_checks

  post_tasks:

    - name: add back to load balancer pool
      command: /usr/bin/add_back_to_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: <span class="m">127</span>.0.0.1
</pre></div>
</div>
<p>Of course in the above, the &#8220;take out of the pool&#8221; and &#8220;add back&#8221; steps would be replaced with a call to a Ansible load balancer
module or appropriate shell command.  You might also have steps that use a monitoring module to start and end an outage window
for the machine.</p>
<p>However, what you can see from the above is that tests are used as a gate &#8211; if the &#8220;apply_testing_checks&#8221; step is not performed,
the machine will not go back into the pool.</p>
<p>Read the delegation chapter about &#8220;max_fail_percentage&#8221; and you can also control how many failing tests will stop a rolling update
from proceeding.</p>
<p>This above approach can also be modified to run a step from a testing machine remotely against a machine:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---

- hosts: webservers
  serial: <span class="m">5</span>

  pre_tasks:

    - name: take out of load balancer pool
      command: /usr/bin/take_out_of_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: <span class="m">127</span>.0.0.1

  roles:

     - common
     - webserver

  tasks:
     - script: /srv/qa_team/app_testing_script.sh --server <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
       delegate_to: testing_server

  post_tasks:

    - name: add back to load balancer pool
      command: /usr/bin/add_back_to_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: <span class="m">127</span>.0.0.1
</pre></div>
</div>
<p>In the above example, a script is run from the testing server against a remote node prior to bringing it back into
the pool.</p>
<p>In the event of a problem, fix the few servers that fail using Ansible&#8217;s automatically generated
retry file to repeat the deploy on just those servers.</p>
</div>
<div class="section" id="achieving-continuous-deployment">
<h4>Achieving Continuous Deployment<a class="headerlink" href="#achieving-continuous-deployment" title="Permalink to this headline">¶</a></h4>
<p>If desired, the above techniques may be extended to enable continuous deployment practices.</p>
<p>The workflow may look like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- Write and use automation to deploy <span class="nb">local</span> development VMs
- Have a CI system like Jenkins deploy to a staging environment on every code change
- The deploy job calls testing scripts to pass/fail a build on every deploy
- If the deploy job succeeds, it runs the same deploy playbook against production inventory
</pre></div>
</div>
<p>Some Ansible users use the above approach to deploy a half-dozen or dozen times an hour without taking all of their infrastructure
offline.  A culture of automated QA is vital if you wish to get to this level.</p>
<p>If you are still doing a large amount of manual QA, you should still make the decision on whether to deploy manually as well, but
it can still help to work in the rolling update patterns of the previous section and incorporate some basic health checks using
modules like &#8216;script&#8217;, &#8216;stat&#8217;, &#8216;uri&#8217;, and &#8216;assert&#8217;.</p>
</div>
<div class="section" id="conclusion">
<h4>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h4>
<p>Ansible believes you should not need another framework to validate basic things of your infrastructure is true.  This is the case
because Ansible is an order-based system that will fail immediately on unhandled errors for a host, and prevent further configuration
of that host.  This forces errors to the top and shows them in a summary at the end of the Ansible run.</p>
<p>However, as Ansible is designed as a multi-tier orchestration system, it makes it very easy to incorporate tests into the end of
a playbook run, either using loose tasks or roles.  When used with rolling updates, testing steps can decide whether to put a machine
back into a load balanced pool or not.</p>
<p>Finally, because Ansible errors propagate all the way up to the return code of the Ansible program itself, and Ansible by default
runs in an easy push-based mode, Ansible is a great step to put into a build environment if you wish to use it to roll out systems
as part of a Continuous Integration/Continuous Delivery pipeline, as is covered in sections above.</p>
<p>The focus should not be on infrastructure testing, but on application testing, so we strongly encourage getting together with your
QA team and ask what sort of tests would make sense to run every time you deploy development VMs, and which sort of tests they would like
to run against the staging environment on every deploy.  Obviously at the development stage, unit tests are great too.  But don&#8217;t unit
test your playbook.  Ansible describes states of resources declaratively, so you don&#8217;t have to.  If there are cases where you want
to be sure of something though, that&#8217;s great, and things like stat/assert are great go-to modules for that purpose.</p>
<p>In all, testing is a very organizational and site-specific thing.  Everybody should be doing it, but what makes the most sense for your
environment will vary with what you are deploying and who is using it &#8211; but everyone benefits from a more robust and reliable deployment
system.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-modules"><span class="doc">About Modules</span></a></dt>
<dd>All the documentation for Ansible modules</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_delegation"><span class="doc">Delegation, Rolling Updates, and Local Actions</span></a></dt>
<dd>Delegation, useful for working with load balancers, clouds, and locally executed steps.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-faq"></span><div class="section" id="frequently-asked-questions">
<h3>Frequently Asked Questions<a class="headerlink" href="#frequently-asked-questions" title="Permalink to this headline">¶</a></h3>
<p>Here are some commonly asked questions and their answers.</p>
<div class="section" id="how-can-i-set-the-path-or-any-other-environment-variable-for-a-task-or-entire-playbook">
<span id="set-environment"></span><h4>How can I set the PATH or any other environment variable for a task or entire playbook?<a class="headerlink" href="#how-can-i-set-the-path-or-any-other-environment-variable-for-a-task-or-entire-playbook" title="Permalink to this headline">¶</a></h4>
<p>Setting environment variables can be done with the <cite>environment</cite> keyword. It can be used at the task or the play level:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>environment:
  PATH: <span class="s2">&quot;{{ ansible_env.PATH }}:/thingy/bin&quot;</span>
  SOME: value
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">starting in 2.0.1 the setup task from gather_facts also inherits the environment directive from the play, you might need to use the <cite>|default</cite> filter to avoid errors if setting this at play level.</p>
</div>
</div>
<div class="section" id="how-do-i-handle-different-machines-needing-different-user-accounts-or-ports-to-log-in-with">
<h4>How do I handle different machines needing different user accounts or ports to log in with?<a class="headerlink" href="#how-do-i-handle-different-machines-needing-different-user-accounts-or-ports-to-log-in-with" title="Permalink to this headline">¶</a></h4>
<p>Setting inventory variables in the inventory file is the easiest way.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible 2.0 has deprecated the “ssh” from <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code>, <code class="docutils literal"><span class="pre">ansible_ssh_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_ssh_port</span></code> to become <code class="docutils literal"><span class="pre">ansible_user</span></code>, <code class="docutils literal"><span class="pre">ansible_host</span></code>, and <code class="docutils literal"><span class="pre">ansible_port</span></code>. If you are using a version of Ansible prior to 2.0,  you should continue using the older style variables (<code class="docutils literal"><span class="pre">ansible_ssh_*</span></code>). These shorter variables are ignored, without warning, in older versions of Ansible.</p>
</div>
<p>For instance, suppose these hosts have different usernames and ports:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[webservers]</span>
<span class="na">asdf.example.com  ansible_port</span><span class="o">=</span><span class="s">5000   ansible_user=alice</span>
<span class="na">jkl.example.com   ansible_port</span><span class="o">=</span><span class="s">5001   ansible_user=bob</span>
</pre></div>
</div>
<p>You can also dictate the connection type to be used, if you want:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[testcluster]</span>
<span class="na">localhost           ansible_connection</span><span class="o">=</span><span class="s">local</span>
<span class="na">/path/to/chroot1    ansible_connection</span><span class="o">=</span><span class="s">chroot</span>
<span class="na">foo.example.com     ansible_connection</span><span class="o">=</span><span class="s">paramiko</span>
</pre></div>
</div>
<p>You may also wish to keep these in group variables instead, or file them in a group_vars/&lt;groupname&gt; file.
See the rest of the documentation for more information about how to organize variables.</p>
</div>
<div class="section" id="how-do-i-get-ansible-to-reuse-connections-enable-kerberized-ssh-or-have-ansible-pay-attention-to-my-local-ssh-config-file">
<span id="use-ssh"></span><h4>How do I get ansible to reuse connections, enable Kerberized SSH, or have Ansible pay attention to my local SSH config file?<a class="headerlink" href="#how-do-i-get-ansible-to-reuse-connections-enable-kerberized-ssh-or-have-ansible-pay-attention-to-my-local-ssh-config-file" title="Permalink to this headline">¶</a></h4>
<p>Switch your default connection type in the configuration file to &#8216;ssh&#8217;, or use &#8216;-c ssh&#8217; to use
Native OpenSSH for connections instead of the python paramiko library.  In Ansible 1.2.1 and later, &#8216;ssh&#8217; will be used
by default if OpenSSH is new enough to support ControlPersist as an option.</p>
<p>Paramiko is great for starting out, but the OpenSSH type offers many advanced options.  You will want to run Ansible
from a machine new enough to support ControlPersist, if you are using this connection type.  You can still manage
older clients.  If you are using RHEL 6, CentOS 6, SLES 10 or SLES 11 the version of OpenSSH is still a bit old, so
consider managing from a Fedora or openSUSE client even though you are managing older nodes, or just use paramiko.</p>
<p>We keep paramiko as the default as if you are first installing Ansible on an EL box, it offers a better experience
for new users.</p>
</div>
<div class="section" id="how-do-i-configure-a-jump-host-to-access-servers-that-i-have-no-direct-access-to">
<span id="use-ssh-jump-hosts"></span><h4>How do I configure a jump host to access servers that I have no direct access to?<a class="headerlink" href="#how-do-i-configure-a-jump-host-to-access-servers-that-i-have-no-direct-access-to" title="Permalink to this headline">¶</a></h4>
<p>With Ansible 2, you can set a <cite>ProxyCommand</cite> in the
<cite>ansible_ssh_common_args</cite> inventory variable. Any arguments specified in
this variable are added to the sftp/scp/ssh command line when connecting
to the relevant host(s). Consider the following inventory group:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[gatewayed]</span>
<span class="na">foo ansible_host</span><span class="o">=</span><span class="s">192.0.2.1</span>
<span class="na">bar ansible_host</span><span class="o">=</span><span class="s">192.0.2.2</span>
</pre></div>
</div>
<p>You can create <cite>group_vars/gatewayed.yml</cite> with the following contents:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ansible_ssh_common_args: <span class="s1">&#39;-o ProxyCommand=&quot;ssh -W %h:%p -q user@gateway.example.com&quot;&#39;</span>
</pre></div>
</div>
<p>Ansible will append these arguments to the command line when trying to
connect to any hosts in the group <cite>gatewayed</cite>. (These arguments are used
in addition to any <cite>ssh_args</cite> from <cite>ansible.cfg</cite>, so you do not need to
repeat global <cite>ControlPersist</cite> settings in <cite>ansible_ssh_common_args</cite>.)</p>
<p>Note that <cite>ssh -W</cite> is available only with OpenSSH 5.4 or later. With
older versions, it&#8217;s necessary to execute <cite>nc %h:%p</cite> or some equivalent
command on the bastion host.</p>
<p>With earlier versions of Ansible, it was necessary to configure a
suitable <cite>ProxyCommand</cite> for one or more hosts in <cite>~/.ssh/config</cite>,
or globally by setting <cite>ssh_args</cite> in <cite>ansible.cfg</cite>.</p>
</div>
<div class="section" id="how-do-i-speed-up-management-inside-ec2">
<span id="ec2-cloud-performance"></span><h4>How do I speed up management inside EC2?<a class="headerlink" href="#how-do-i-speed-up-management-inside-ec2" title="Permalink to this headline">¶</a></h4>
<p>Don&#8217;t try to manage a fleet of EC2 machines from your laptop.  Connect to a management node inside EC2 first
and run Ansible from there.</p>
</div>
<div class="section" id="how-do-i-handle-python-pathing-not-having-a-python-2-x-in-usr-bin-python-on-a-remote-machine">
<span id="python-interpreters"></span><h4>How do I handle python pathing not having a Python 2.X in /usr/bin/python on a remote machine?<a class="headerlink" href="#how-do-i-handle-python-pathing-not-having-a-python-2-x-in-usr-bin-python-on-a-remote-machine" title="Permalink to this headline">¶</a></h4>
<p>While you can write ansible modules in any language, most ansible modules are written in Python, and some of these
are important core ones.</p>
<p>By default, Ansible assumes it can find a /usr/bin/python on your remote system that is a 2.X version of Python, specifically
2.6 or higher.</p>
<p>Setting the inventory variable &#8216;ansible_python_interpreter&#8217; on any host will allow Ansible to auto-replace the interpreter
used when executing python modules.   Thus, you can point to any python you want on the system if /usr/bin/python on your
system does not point to a Python 2.X interpreter.</p>
<p>Some Linux operating systems, such as Arch, may only have Python 3 installed by default.  This is not sufficient and you will
get syntax errors trying to run modules with Python 3.  Python 3 is essentially not the same language as Python 2.  Python 3
support is being worked on but some Ansible modules are not yet ported to run under Python 3.0.  This is not a problem though
as you can just install Python 2 also on a managed host.</p>
<p>Do not replace the shebang lines of your python modules.  Ansible will do this for you automatically at deploy time.</p>
</div>
<div class="section" id="what-is-the-best-way-to-make-content-reusable-redistributable">
<span id="use-roles"></span><h4>What is the best way to make content reusable/redistributable?<a class="headerlink" href="#what-is-the-best-way-to-make-content-reusable-redistributable" title="Permalink to this headline">¶</a></h4>
<p>If you have not done so already, read all about &#8220;Roles&#8221; in the playbooks documentation.  This helps you make playbook content
self-contained, and works well with things like git submodules for sharing content with others.</p>
<p>If some of these plugin types look strange to you, see the API documentation for more details about ways Ansible can be extended.</p>
</div>
<div class="section" id="where-does-the-configuration-file-live-and-what-can-i-configure-in-it">
<span id="configuration-file"></span><h4>Where does the configuration file live and what can I configure in it?<a class="headerlink" href="#where-does-the-configuration-file-live-and-what-can-i-configure-in-it" title="Permalink to this headline">¶</a></h4>
<p>See <a class="reference internal" href="index.html#document-intro_configuration"><span class="doc">Configuration file</span></a>.</p>
</div>
<div class="section" id="how-do-i-disable-cowsay">
<span id="who-would-ever-want-to-disable-cowsay-but-ok-here-is-how"></span><h4>How do I disable cowsay?<a class="headerlink" href="#how-do-i-disable-cowsay" title="Permalink to this headline">¶</a></h4>
<p>If cowsay is installed, Ansible takes it upon itself to make your day happier when running playbooks.  If you decide
that you would like to work in a professional cow-free environment, you can either uninstall cowsay, or set the <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_NOCOWS</span></code> environment variable:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">export ANSIBLE_NOCOWS=1</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-see-a-list-of-all-of-the-ansible-variables">
<span id="browse-facts"></span><h4>How do I see a list of all of the ansible_ variables?<a class="headerlink" href="#how-do-i-see-a-list-of-all-of-the-ansible-variables" title="Permalink to this headline">¶</a></h4>
<p>Ansible by default gathers &#8220;facts&#8221; about the machines under management, and these facts can be accessed in Playbooks and in templates. To see a list of all of the facts that are available about a machine, you can run the &#8220;setup&#8221; module as an ad-hoc action:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">ansible -m setup hostname</span>
</pre></div>
</div>
<p>This will print out a dictionary of all of the facts that are available for that particular host. You might want to pipe the output to a pager.</p>
</div>
<div class="section" id="how-do-i-see-all-the-inventory-vars-defined-for-my-host">
<span id="browse-inventory-vars"></span><h4>How do I see all the inventory vars defined for my host?<a class="headerlink" href="#how-do-i-see-all-the-inventory-vars-defined-for-my-host" title="Permalink to this headline">¶</a></h4>
<p>By running the following command, you can see vars resulting from what you&#8217;ve defined in the inventory:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">ansible -m debug -a &quot;var=hostvars[&#39;hostname&#39;]&quot; localhost</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-loop-over-a-list-of-hosts-in-a-group-inside-of-a-template">
<span id="host-loops"></span><h4>How do I loop over a list of hosts in a group, inside of a template?<a class="headerlink" href="#how-do-i-loop-over-a-list-of-hosts-in-a-group-inside-of-a-template" title="Permalink to this headline">¶</a></h4>
<p>A pretty common pattern is to iterate over a list of hosts inside of a host group, perhaps to populate a template configuration
file with a list of servers. To do this, you can just access the &#8220;$groups&#8221; dictionary in your template, like this:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">host</span> <span class="k">in</span> <span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;db_servers&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">host</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>If you need to access facts about these hosts, for instance, the IP address of each hostname, you need to make sure that the facts have been populated. For example, make sure you have a play that talks to db_servers:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts:  db_servers
  tasks:
    - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;doesn&#39;t matter what you do, just that they were talked to previously.&quot;</span>
</pre></div>
</div>
<p>Then you can use the facts inside your template, like this:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">host</span> <span class="k">in</span> <span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;db_servers&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">   </span><span class="cp">{{</span> <span class="nv">hostvars</span><span class="o">[</span><span class="nv">host</span><span class="o">][</span><span class="s1">&#39;ansible_eth0&#39;</span><span class="o">][</span><span class="s1">&#39;ipv4&#39;</span><span class="o">][</span><span class="s1">&#39;address&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-access-a-variable-name-programmatically">
<span id="programatic-access-to-a-variable"></span><h4>How do I access a variable name programmatically?<a class="headerlink" href="#how-do-i-access-a-variable-name-programmatically" title="Permalink to this headline">¶</a></h4>
<p>An example may come up where we need to get the ipv4 address of an arbitrary interface, where the interface to be used may be supplied
via a role parameter or other input.  Variable names can be built by adding strings together, like so:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{{</span> <span class="nv">hostvars</span><span class="o">[</span><span class="nv">inventory_hostname</span><span class="o">][</span><span class="s1">&#39;ansible_&#39;</span> <span class="o">+</span> <span class="nv">which_interface</span><span class="o">][</span><span class="s1">&#39;ipv4&#39;</span><span class="o">][</span><span class="s1">&#39;address&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
<p>The trick about going through hostvars is necessary because it&#8217;s a dictionary of the entire namespace of variables.  &#8216;inventory_hostname&#8217;
is a magic variable that indicates the current host you are looping over in the host loop.</p>
</div>
<div class="section" id="how-do-i-access-a-variable-of-the-first-host-in-a-group">
<span id="first-host-in-a-group"></span><h4>How do I access a variable of the first host in a group?<a class="headerlink" href="#how-do-i-access-a-variable-of-the-first-host-in-a-group" title="Permalink to this headline">¶</a></h4>
<p>What happens if we want the ip address of the first webserver in the webservers group?  Well, we can do that too.  Note that if we
are using dynamic inventory, which host is the &#8216;first&#8217; may not be consistent, so you wouldn&#8217;t want to do this unless your inventory
is static and predictable.  (If you are using <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a>, it will use database order, so this isn&#8217;t a problem even if you are using cloud
based inventory scripts).</p>
<p>Anyway, here&#8217;s the trick:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{{</span> <span class="nv">hostvars</span><span class="o">[</span><span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;webservers&#39;</span><span class="o">][</span><span class="m">0</span><span class="o">]][</span><span class="s1">&#39;ansible_eth0&#39;</span><span class="o">][</span><span class="s1">&#39;ipv4&#39;</span><span class="o">][</span><span class="s1">&#39;address&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
<p>Notice how we&#8217;re pulling out the hostname of the first machine of the webservers group.  If you are doing this in a template, you
could use the Jinja2 &#8216;#set&#8217; directive to simplify this, or in a playbook, you could also use set_fact:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- set_fact: <span class="nv">headnode</span><span class="o">={{</span> groups<span class="o">[[</span><span class="s1">&#39;webservers&#39;</span><span class="o">][</span><span class="m">0</span><span class="o">]]</span> <span class="o">}}</span>

- debug: <span class="nv">msg</span><span class="o">={{</span> hostvars<span class="o">[</span>headnode<span class="o">]</span>.ansible_eth0.ipv4.address <span class="o">}}</span>
</pre></div>
</div>
<p>Notice how we interchanged the bracket syntax for dots &#8211; that can be done anywhere.</p>
</div>
<div class="section" id="how-do-i-copy-files-recursively-onto-a-target-host">
<span id="file-recursion"></span><h4>How do I copy files recursively onto a target host?<a class="headerlink" href="#how-do-i-copy-files-recursively-onto-a-target-host" title="Permalink to this headline">¶</a></h4>
<p>The &#8220;copy&#8221; module has a recursive parameter.  However, take a look at the &#8220;synchronize&#8221; module if you want to do something more efficient for a large number of files.  The &#8220;synchronize&#8221; module wraps rsync.  See the module index for info on both of these modules.</p>
</div>
<div class="section" id="how-do-i-access-shell-environment-variables">
<span id="shell-env"></span><h4>How do I access shell environment variables?<a class="headerlink" href="#how-do-i-access-shell-environment-variables" title="Permalink to this headline">¶</a></h4>
<p>If you just need to access existing variables, use the &#8216;env&#8217; lookup plugin.  For example, to access the value of the HOME
environment variable on the management machine:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># ...</span>
  vars:
     local_home: <span class="s2">&quot;{{ lookup(&#39;env&#39;,&#39;HOME&#39;) }}&quot;</span>
</pre></div>
</div>
<p>If you need to set environment variables, see the Advanced Playbooks section about environments.</p>
<p>Starting with Ansible 1.4, remote environment variables are available via facts in the &#8216;ansible_env&#8217; variable:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{{</span> <span class="nv">ansible_env.SOME_VARIABLE</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-generate-crypted-passwords-for-the-user-module">
<span id="user-passwords"></span><h4>How do I generate crypted passwords for the user module?<a class="headerlink" href="#how-do-i-generate-crypted-passwords-for-the-user-module" title="Permalink to this headline">¶</a></h4>
<p>The mkpasswd utility that is available on most Linux systems is a great option:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">mkpasswd --method=sha-512</span>
</pre></div>
</div>
<p>If this utility is not installed on your system (e.g. you are using OS X) then you can still easily
generate these passwords using Python. First, ensure that the <a class="reference external" href="https://bitbucket.org/ecollins/passlib/wiki/Home">Passlib</a>
password hashing library is installed:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">pip install passlib</span>
</pre></div>
</div>
<p>Once the library is ready, SHA512 password values can then be generated as follows:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="go">python -c &quot;from passlib.hash import sha512_crypt; import getpass; print sha512_crypt.using(rounds=5000).hash(getpass.getpass())&quot;</span>
</pre></div>
</div>
<p>Use the integrated <a class="reference internal" href="index.html#hash-filters"><span class="std std-ref">Hashing filters</span></a> to generate a hashed version of a password.
You shouldn&#8217;t put plaintext passwords in your playbook or host_vars; instead, use <a class="reference internal" href="index.html#document-playbooks_vault"><span class="doc">Using Vault in playbooks</span></a> to encrypt sensitive data.</p>
</div>
<div class="section" id="can-i-get-training-on-ansible">
<span id="commercial-support"></span><h4>Can I get training on Ansible?<a class="headerlink" href="#can-i-get-training-on-ansible" title="Permalink to this headline">¶</a></h4>
<p>Yes!  See our <a class="reference external" href="https://www.ansible.com/consulting">services page</a> for information on our services and training offerings. Email <a class="reference external" href="mailto:info&#37;&#52;&#48;ansible&#46;com">info<span>&#64;</span>ansible<span>&#46;</span>com</a> for further details.</p>
<p>We also offer free web-based training classes on a regular basis. See our <a class="reference external" href="https://www.ansible.com/webinars-training">webinar page</a> for more info on upcoming webinars.</p>
</div>
<div class="section" id="is-there-a-web-interface-rest-api-etc">
<span id="web-interface"></span><h4>Is there a web interface / REST API / etc?<a class="headerlink" href="#is-there-a-web-interface-rest-api-etc" title="Permalink to this headline">¶</a></h4>
<p>Yes!  Ansible, Inc makes a great product that makes Ansible even more powerful
and easy to use. See <a class="reference internal" href="index.html#document-tower"><span class="doc">Ansible Tower</span></a>.</p>
</div>
<div class="section" id="how-do-i-submit-a-change-to-the-documentation">
<span id="docs-contributions"></span><h4>How do I submit a change to the documentation?<a class="headerlink" href="#how-do-i-submit-a-change-to-the-documentation" title="Permalink to this headline">¶</a></h4>
<p>Great question!  Documentation for Ansible is kept in the main project git repository, and complete instructions for contributing can be found in the docs README <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/docs/docsite/README.md">viewable on GitHub</a>.  Thanks!</p>
</div>
<div class="section" id="how-do-i-keep-secret-data-in-my-playbook">
<span id="keep-secret-data"></span><h4>How do I keep secret data in my playbook?<a class="headerlink" href="#how-do-i-keep-secret-data-in-my-playbook" title="Permalink to this headline">¶</a></h4>
<p>If you would like to keep secret data in your Ansible content and still share it publicly or keep things in source control, see <a class="reference internal" href="index.html#document-playbooks_vault"><span class="doc">Using Vault in playbooks</span></a>.</p>
<p>In Ansible 1.8 and later, if you have a task that you don&#8217;t want to show the results or command given to it when using -v (verbose) mode, the following task or playbook attribute can be useful:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- name: secret task
  shell: /usr/bin/do_something --value<span class="o">={{</span> secret_value <span class="o">}}</span>
  no_log: True
</pre></div>
</div>
<p>This can be used to keep verbose output but hide sensitive information from others who would otherwise like to be able to see the output.</p>
<p>The no_log attribute can also apply to an entire play:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>- hosts: all
  no_log: True
</pre></div>
</div>
<p>Though this will make the play somewhat difficult to debug.  It&#8217;s recommended that this
be applied to single tasks only, once a playbook is completed. Note that the use of the
no_log attribute does not prevent data from being shown when debugging Ansible itself via
the <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">ANSIBLE_DEBUG</span></code> environment variable.</p>
</div>
<div class="section" id="when-should-i-use-also-how-to-interpolate-variables-or-dynamic-variable-names">
<span id="interpolate-variables"></span><span id="dynamic-variables"></span><span id="when-to-use-brackets"></span><h4>When should I use {{ }}? Also, how to interpolate variables or dynamic variable names<a class="headerlink" href="#when-should-i-use-also-how-to-interpolate-variables-or-dynamic-variable-names" title="Permalink to this headline">¶</a></h4>
<p>A steadfast rule is &#8216;always use {{ }} except when <cite>when:</cite>&#8216;.
Conditionals are always run through Jinja2 as to resolve the expression,
so <cite>when:</cite>, <cite>failed_when:</cite> and <cite>changed_when:</cite> are always templated and you should avoid adding <cite>{{}}</cite>.</p>
<p>In most other cases you should always use the brackets, even if previously you could use variables without specifying (like <cite>with_</cite> clauses),
as this made it hard to distinguish between an undefined variable and a string.</p>
<p>Another rule is &#8216;moustaches don&#8217;t stack&#8217;. We often see this:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{{</span> <span class="nv">somevar_</span><span class="o">{{</span><span class="nv">other_var</span><span class="cp">}}</span><span class="x"> }}</span>
</pre></div>
</div>
<p>The above DOES NOT WORK, if you need to use a dynamic variable use the hostvars or vars dictionary as appropriate:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{{</span> <span class="nv">hostvars</span><span class="o">[</span><span class="nv">inventory_hostname</span><span class="o">][</span><span class="s1">&#39;somevar_&#39;</span> <span class="o">+</span> <span class="nv">other_var</span><span class="o">]</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="section" id="why-don-t-you-ship-in-x-format">
<span id="i-dont-see-my-question"></span><h4>Why don&#8217;t you ship in X format?<a class="headerlink" href="#why-don-t-you-ship-in-x-format" title="Permalink to this headline">¶</a></h4>
<p>Several reasons, in most cases it has to do with maintainability, there are tons of ways to ship software and it is a herculean task to try to support them all.
In other cases there are technical issues, for example, for python wheels, our dependencies are not present so there is little to no gain.</p>
</div>
<div class="section" id="i-don-t-see-my-question-here">
<h4>I don&#8217;t see my question here<a class="headerlink" href="#i-don-t-see-my-question-here" title="Permalink to this headline">¶</a></h4>
<p>Please see the section below for a link to IRC and the Google Group, where you can ask your question there.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-index"><span class="doc">Ansible Documentation</span></a></dt>
<dd>The documentation index</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices advice</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-glossary"></span><div class="section" id="glossary">
<h3>Glossary<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h3>
<p>The following is a list (and re-explanation) of term definitions used elsewhere in the Ansible documentation.</p>
<p>Consult the documentation home page for the full documentation and to see the terms in context, but this should be a good resource
to check your knowledge of Ansible&#8217;s components and understand how they fit together.  It&#8217;s something you might wish to read for review or
when a term comes up on the mailing list.</p>
<dl class="glossary docutils">
<dt id="term-action">Action</dt>
<dd>An action is a part of a task that specifies which of the modules to
run and which arguments to pass to that module.  Each task can have
only one action, but it may also have other parameters.</dd>
<dt id="term-ad-hoc">Ad Hoc</dt>
<dd>Refers to running Ansible to perform some quick command, using
<strong class="command">/usr/bin/ansible</strong>, rather than the <a class="reference internal" href="#term-orchestration"><span class="xref std std-term">orchestration</span></a>
language, which is <strong class="command">/usr/bin/ansible-playbook</strong>.  An example
of an ad hoc command might be rebooting 50 machines in your
infrastructure.  Anything you can do ad hoc can be accomplished by
writing a <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> and playbooks can also glue
lots of other operations together.</dd>
<dt id="term-async">Async</dt>
<dd>Refers to a task that is configured to run in the background rather
than waiting for completion.  If you have a long process that would
run longer than the SSH timeout, it would make sense to launch that
task in async mode.  Async modes can poll for completion every so many
seconds or can be configured to &#8220;fire and forget&#8221;, in which case
Ansible will not even check on the task again; it will just kick it
off and proceed to future steps.  Async modes work with both
<strong class="command">/usr/bin/ansible</strong> and <strong class="command">/usr/bin/ansible-playbook</strong>.</dd>
<dt id="term-callback-plugin">Callback Plugin</dt>
<dd>Refers to some user-written code that can intercept results from
Ansible and do something with them.  Some supplied examples in the
GitHub project perform custom logging, send email, or even play sound
effects.</dd>
<dt id="term-check-mode">Check Mode</dt>
<dd>Refers to running Ansible with the <code class="docutils literal"><span class="pre">--check</span></code> option, which does not
make any changes on the remote systems, but only outputs the changes
that might occur if the command ran without this flag.  This is
analogous to so-called &#8220;dry run&#8221; modes in other systems, though the
user should be warned that this does not take into account unexpected
command failures or cascade effects (which is true of similar modes in
other systems).  Use this to get an idea of what might happen, but do
not substitute it for a good staging environment.</dd>
<dt id="term-connection-plugin">Connection Plugin</dt>
<dd>By default, Ansible talks to remote machines through pluggable
libraries.  Ansible supports native OpenSSH (<a class="reference internal" href="#term-ssh-native"><span class="xref std std-term">SSH (Native)</span></a>) or
a Python implementation called <a class="reference internal" href="#term-paramiko"><span class="xref std std-term">paramiko</span></a>.  OpenSSH is preferred
if you are using a recent version, and also enables some features like
Kerberos and jump hosts.  This is covered in the <a class="reference internal" href="index.html#remote-connection-information"><span class="std std-ref">getting
started section</span></a>.  There are also
other connection types like <code class="docutils literal"><span class="pre">accelerate</span></code> mode, which must be
bootstrapped over one of the SSH-based connection types but is very
fast, and local mode, which acts on the local system.  Users can also
write their own connection plugins.</dd>
<dt id="term-conditionals">Conditionals</dt>
<dd>A conditional is an expression that evaluates to true or false that
decides whether a given task is executed on a given machine or not.
Ansible&#8217;s conditionals are powered by the &#8216;when&#8217; statement, which are
discussed in the <a class="reference internal" href="index.html#document-playbooks"><span class="doc">playbook documentation</span></a>.</dd>
<dt id="term-declarative">Declarative</dt>
<dd>An approach to achieving a task that uses a description of the
final state rather than a description of the sequence of steps
necessary to achieve that state. For a real world example, a
declarative specification of a task would be: &#8220;put me in California&#8221;.
Depending on your current location, the sequence of steps to get you to
California may vary, and if you are already in California, nothing
at all needs to be done. Ansible&#8217;s Resources are declarative; it
figures out the steps needed to achieve the final state. It also lets
you know whether or not any steps needed to be taken to get to the
final state.</dd>
<dt id="term-diff-mode">Diff Mode</dt>
<dd>A <code class="docutils literal"><span class="pre">--diff</span></code> flag can be passed to Ansible to show what changed on
modules that support it. You can combine it with <code class="docutils literal"><span class="pre">--check</span></code> to get a
good &#8216;dry run&#8217;.  File diffs are normally in unified diff format.</dd>
<dt id="term-executor">Executor</dt>
<dd>A core software component of Ansible that is the power behind
<strong class="command">/usr/bin/ansible</strong> directly &#8211; and corresponds to the
invocation of each task in a <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>.  The
Executor is something Ansible developers may talk about, but it&#8217;s not
really user land vocabulary.</dd>
<dt id="term-facts">Facts</dt>
<dd>Facts are simply things that are discovered about remote nodes.  While
they can be used in <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbooks</span></a> and templates just like
variables, facts are things that are inferred, rather than set.  Facts
are automatically discovered by Ansible when running plays by
executing the internal <span class="xref std std-ref">setup module</span> on the remote nodes.  You
never have to call the setup module explicitly, it just runs, but it
can be disabled to save time if it is not needed or you can tell
ansible to collect only a subset of the full facts via the
<code class="docutils literal"><span class="pre">gather_subset:</span></code> option. For the convenience of users who are
switching from other configuration management systems, the fact module
will also pull in facts from the <strong class="program">ohai</strong> and <strong class="program">facter</strong>
tools if they are installed.  These are fact libraries from Chef and
Puppet, respectively. (These may also be disabled via
<code class="docutils literal"><span class="pre">gather_subset:</span></code>)</dd>
<dt id="term-filter-plugin">Filter Plugin</dt>
<dd>A filter plugin is something that most users will never need to
understand.  These allow for the creation of new <a class="reference internal" href="#term-jinja2"><span class="xref std std-term">Jinja2</span></a>
filters, which are more or less only of use to people who know what
Jinja2 filters are.  If you need them, you can learn how to write them
in the <a class="reference internal" href="index.html#developing-filter-plugins"><span class="std std-ref">API docs section</span></a>.</dd>
<dt id="term-forks">Forks</dt>
<dd>Ansible talks to remote nodes in parallel and the level of parallelism
can be set either by passing <code class="docutils literal"><span class="pre">--forks</span></code> or editing the default in
a configuration file.  The default is a very conservative five (5)
forks, though if you have a lot of RAM, you can easily set this to
a value like 50 for increased parallelism.</dd>
<dt id="term-gather-facts-boolean">Gather Facts (Boolean)</dt>
<dd><a class="reference internal" href="#term-facts"><span class="xref std std-term">Facts</span></a> are mentioned above.  Sometimes when running a multi-play
<a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>, it is desirable to have some plays that
don&#8217;t bother with fact computation if they aren&#8217;t going to need to
utilize any of these values.  Setting <code class="docutils literal"><span class="pre">gather_facts:</span> <span class="pre">False</span></code> on
a playbook allows this implicit fact gathering to be skipped.</dd>
<dt id="term-globbing">Globbing</dt>
<dd>Globbing is a way to select lots of hosts based on wildcards, rather
than the name of the host specifically, or the name of the group they
are in.  For instance, it is possible to select <code class="docutils literal"><span class="pre">ww*</span></code> to match all
hosts starting with <code class="docutils literal"><span class="pre">www</span></code>.   This concept is pulled directly from
<strong class="program">Func</strong>, one of Michael DeHaan&#8217;s (an Ansible Founder) earlier
projects.  In addition to basic globbing, various set operations are
also possible, such as &#8216;hosts in this group and not in another group&#8217;,
and so on.</dd>
<dt id="term-group">Group</dt>
<dd>A group consists of several hosts assigned to a pool that can be
conveniently targeted together, as well as given variables that they
share in common.</dd>
<dt id="term-group-vars">Group Vars</dt>
<dd>The <code class="file docutils literal"><span class="pre">group_vars/</span></code> files are files that live in a directory
alongside an inventory file, with an optional filename named after
each group.  This is a convenient place to put variables that are
provided to a given group, especially complex data structures, so that
these variables do not have to be embedded in the <a class="reference internal" href="#term-inventory"><span class="xref std std-term">inventory</span></a>
file or <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>.</dd>
<dt id="term-handlers">Handlers</dt>
<dd>Handlers are just like regular tasks in an Ansible
<a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> (see <a class="reference internal" href="#term-tasks"><span class="xref std std-term">Tasks</span></a>) but are only run if
the Task contains a <code class="docutils literal"><span class="pre">notify</span></code> directive and also indicates that it
changed something.  For example, if a config file is changed, then the
task referencing the config file templating operation may notify
a service restart handler.  This means services can be bounced only if
they need to be restarted.  Handlers can be used for things other than
service restarts, but service restarts are the most common usage.</dd>
<dt id="term-host">Host</dt>
<dd>A host is simply a remote machine that Ansible manages.  They can have
individual variables assigned to them, and can also be organized in
groups.  All hosts have a name they can be reached at (which is either
an IP address or a domain name) and, optionally, a port number, if they
are not to be accessed on the default SSH port.</dd>
<dt id="term-host-specifier">Host Specifier</dt>
<dd><p class="first">Each <a class="reference internal" href="#term-plays"><span class="xref std std-term">Play</span></a> in Ansible maps a series of <a class="reference internal" href="#term-tasks"><span class="xref std std-term">tasks</span></a> (which define the role,
purpose, or orders of a system) to a set of systems.</p>
<p>This <code class="docutils literal"><span class="pre">hosts:</span></code> directive in each play is often called the hosts specifier.</p>
<p class="last">It may select one system, many systems, one or more groups, or even
some hosts that are in one group and explicitly not in another.</p>
</dd>
<dt id="term-host-vars">Host Vars</dt>
<dd>Just like <a class="reference internal" href="#term-group-vars"><span class="xref std std-term">Group Vars</span></a>, a directory alongside the inventory file named
<code class="file docutils literal"><span class="pre">host_vars/</span></code> can contain a file named after each hostname in the
inventory file, in <a class="reference internal" href="#term-yaml"><span class="xref std std-term">YAML</span></a> format.  This provides a convenient place to
assign variables to the host without having to embed them in the
<a class="reference internal" href="#term-inventory"><span class="xref std std-term">inventory</span></a> file.  The Host Vars file can also be used to define complex
data structures that can&#8217;t be represented in the inventory file.</dd>
<dt id="term-idempotency">Idempotency</dt>
<dd>An operation is idempotent if the result of performing it once is
exactly the same as the result of performing it repeatedly without
any intervening actions.</dd>
<dt id="term-includes">Includes</dt>
<dd>The idea that <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> files (which are nothing
more than lists of <a class="reference internal" href="#term-plays"><span class="xref std std-term">plays</span></a>) can include other lists of plays,
and task lists can externalize lists of <a class="reference internal" href="#term-tasks"><span class="xref std std-term">tasks</span></a> in other files,
and similarly with <a class="reference internal" href="#term-handlers"><span class="xref std std-term">handlers</span></a>.  Includes can be parameterized,
which means that the loaded file can pass variables.  For instance, an
included play for setting up a WordPress blog may take a parameter
called <code class="docutils literal"><span class="pre">user</span></code> and that play could be included more than once to
create a blog for both <code class="docutils literal"><span class="pre">alice</span></code> and <code class="docutils literal"><span class="pre">bob</span></code>.</dd>
<dt id="term-inventory">Inventory</dt>
<dd>A file (by default, Ansible uses a simple INI format) that describes
<a class="reference internal" href="#term-host"><span class="xref std std-term">Hosts</span></a> and <a class="reference internal" href="#term-group"><span class="xref std std-term">Groups</span></a> in Ansible.  Inventory
can also be provided via an <a class="reference internal" href="#term-inventory-script"><span class="xref std std-term">Inventory Script</span></a> (sometimes called
an &#8220;External Inventory Script&#8221;).</dd>
<dt id="term-inventory-script">Inventory Script</dt>
<dd>A very simple program (or a complicated one) that looks up
<a class="reference internal" href="#term-host"><span class="xref std std-term">hosts</span></a>, <a class="reference internal" href="#term-group"><span class="xref std std-term">group</span></a> membership for hosts, and variable
information from an external resource &#8211; whether that be a SQL
database, a CMDB solution, or something like LDAP.  This concept was
adapted from Puppet (where it is called an &#8220;External Nodes
Classifier&#8221;) and works more or less exactly the same way.</dd>
<dt id="term-jinja2">Jinja2</dt>
<dd>Jinja2 is the preferred templating language of Ansible&#8217;s template
module.  It is a very simple Python template language that is
generally readable and easy to write.</dd>
<dt id="term-json">JSON</dt>
<dd>Ansible uses JSON for return data from remote modules.  This allows
modules to be written in any language, not just Python.</dd>
<dt id="term-lazy-evaluation">Lazy Evaluation</dt>
<dd>In general, Ansible evaluates any variables in
<a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> content at the last possible second,
which means that if you define a data structure that data structure
itself can define variable values within it, and everything &#8220;just
works&#8221; as you would expect.  This also means variable strings can
include other variables inside of those strings.</dd>
<dt id="term-library">Library</dt>
<dd>A collection of modules made available to <strong class="command">/usr/bin/ansible</strong>
or an Ansible <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>.</dd>
<dt id="term-limit-groups">Limit Groups</dt>
<dd>By passing <code class="docutils literal"><span class="pre">--limit</span> <span class="pre">somegroup</span></code> to <strong class="command">ansible</strong> or
<strong class="command">ansible-playbook</strong>, the commands can be limited to a subset
of <a class="reference internal" href="#term-host"><span class="xref std std-term">hosts</span></a>.  For instance, this can be used to run
a <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> that normally targets an entire set of
servers to one particular server.</dd>
<dt id="term-local-action">Local Action</dt>
<dd>A local_action directive in a <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> targeting
remote machines means that the given step will actually occur on the
local machine, but that the variable <code class="docutils literal"><span class="pre">{{</span> <span class="pre">ansible_hostname</span> <span class="pre">}}</span></code> can be
passed in to reference the remote hostname being referred to in that
step.  This can be used to trigger, for example, an rsync operation.</dd>
<dt id="term-local-connection">Local Connection</dt>
<dd>By using <code class="docutils literal"><span class="pre">connection:</span> <span class="pre">local</span></code> in a <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>, or
passing <code class="docutils literal"><span class="pre">-c</span> <span class="pre">local</span></code> to <strong class="command">/usr/bin/ansible</strong>, this indicates
that we are managing the local host and not a remote machine.</dd>
<dt id="term-lookup-plugin">Lookup Plugin</dt>
<dd>A lookup plugin is a way to get data into Ansible from the outside
world.  These are how such things as <code class="docutils literal"><span class="pre">with_items</span></code>, a basic looping
plugin, are implemented.  There are also lookup plugins like
<code class="docutils literal"><span class="pre">with_file</span></code> which load data from a file and ones for querying
environment variables, DNS text records, or key value stores.  Lookup
plugins can also be accessed in templates, e.g.,
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">lookup('file','/path/to/file')</span> <span class="pre">}}</span></code>.</dd>
<dt id="term-loops">Loops</dt>
<dd>Generally, Ansible is not a programming language. It prefers to be
more declarative, though various constructs like <code class="docutils literal"><span class="pre">with_items</span></code> allow
a particular task to be repeated for multiple items in a list.
Certain modules, like <span class="xref std std-ref">yum</span> and <span class="xref std std-ref">apt</span>, are actually
optimized for this, and can install all packages given in those lists
within a single transaction, dramatically speeding up total time to
configuration.</dd>
<dt id="term-modules">Modules</dt>
<dd>Modules are the units of work that Ansible ships out to remote
machines.   Modules are kicked off by either
<strong class="command">/usr/bin/ansible</strong> or <strong class="command">/usr/bin/ansible-playbook</strong>
(where multiple tasks use lots of different modules in conjunction).
Modules can be implemented in any language, including Perl, Bash, or
Ruby &#8211; but can leverage some useful communal library code if written
in Python.  Modules just have to return <a class="reference internal" href="#term-json"><span class="xref std std-term">JSON</span></a>.  Once modules are
executed on remote machines, they are removed, so no long running
daemons are used.  Ansible refers to the collection of available
modules as a <a class="reference internal" href="#term-library"><span class="xref std std-term">library</span></a>.</dd>
<dt id="term-multi-tier">Multi-Tier</dt>
<dd>The concept that IT systems are not managed one system at a time, but
by interactions between multiple systems and groups of systems in
well defined orders.  For instance, a web server may need to be
updated before a database server and pieces on the web server may
need to be updated after <em>THAT</em> database server and various load
balancers and monitoring servers may need to be contacted.  Ansible
models entire IT topologies and workflows rather than looking at
configuration from a &#8220;one system at a time&#8221; perspective.</dd>
<dt id="term-notify">Notify</dt>
<dd>The act of a <a class="reference internal" href="#term-tasks"><span class="xref std std-term">task</span></a> registering a change event and
informing a <a class="reference internal" href="#term-handlers"><span class="xref std std-term">handler</span></a> task that another
<a class="reference internal" href="#term-action"><span class="xref std std-term">action</span></a> needs to be run at the end of the <a class="reference internal" href="#term-plays"><span class="xref std std-term">play</span></a>.  If
a handler is notified by multiple tasks, it will still be run only
once.  Handlers are run in the order they are listed, not in the order
that they are notified.</dd>
<dt id="term-orchestration">Orchestration</dt>
<dd>Many software automation systems use this word to mean different
things.  Ansible uses it as a conductor would conduct an orchestra.
A datacenter or cloud architecture is full of many systems, playing
many parts &#8211; web servers, database servers, maybe load balancers,
monitoring systems, continuous integration systems, etc.  In
performing any process, it is necessary to touch systems in particular
orders, often to simulate rolling updates or to deploy software
correctly.  Some system may perform some steps, then others, then
previous systems already processed may need to perform more steps.
Along the way, emails may need to be sent or web services contacted.
Ansible orchestration is all about modeling that kind of process.</dd>
<dt id="term-paramiko">paramiko</dt>
<dd>By default, Ansible manages machines over SSH.   The library that
Ansible uses by default to do this is a Python-powered library called
paramiko.  The paramiko library is generally fast and easy to manage,
though users desiring Kerberos or Jump Host support may wish to switch
to a native SSH binary such as OpenSSH by specifying the connection
type in their <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbooks</span></a>, or using the <code class="docutils literal"><span class="pre">-c</span> <span class="pre">ssh</span></code> flag.</dd>
<dt id="term-playbooks">Playbooks</dt>
<dd>Playbooks are the language by which Ansible orchestrates, configures,
administers, or deploys systems.  They are called playbooks partially
because it&#8217;s a sports analogy, and it&#8217;s supposed to be fun using them.
They aren&#8217;t workbooks :)</dd>
<dt id="term-plays">Plays</dt>
<dd>A <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> is a list of plays.  A play is
minimally a mapping between a set of <a class="reference internal" href="#term-host"><span class="xref std std-term">hosts</span></a> selected by a host
specifier (usually chosen by <a class="reference internal" href="#term-group"><span class="xref std std-term">groups</span></a> but sometimes by
hostname <a class="reference internal" href="#term-globbing"><span class="xref std std-term">globs</span></a>) and the <a class="reference internal" href="#term-tasks"><span class="xref std std-term">tasks</span></a> which run on those
hosts to define the role that those systems will perform. There can be
one or many plays in a playbook.</dd>
<dt id="term-pull-mode">Pull Mode</dt>
<dd><p class="first">By default, Ansible runs in <a class="reference internal" href="#term-push-mode"><span class="xref std std-term">push mode</span></a>, which allows it very
fine-grained control over when it talks to each system.  Pull mode is
provided for when you would rather have nodes check in every N minutes
on a particular schedule.  It uses a program called
<strong class="command">ansible-pull</strong> and can also be set up (or reconfigured) using
a push-mode <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>.  Most Ansible users use push
mode, but pull mode is included for variety and the sake of having
choices.</p>
<p class="last"><strong class="command">ansible-pull</strong> works by checking configuration orders out of
git on a crontab and then managing the machine locally, using the
<a class="reference internal" href="#term-local-connection"><span class="xref std std-term">local connection</span></a> plugin.</p>
</dd>
<dt id="term-push-mode">Push Mode</dt>
<dd>Push mode is the default mode of Ansible. In fact, it&#8217;s not really
a mode at all &#8211; it&#8217;s just how Ansible works when you aren&#8217;t thinking
about it.  Push mode allows Ansible to be fine-grained and conduct
nodes through complex orchestration processes without waiting for them
to check in.</dd>
<dt id="term-register-variable">Register Variable</dt>
<dd>The result of running any <a class="reference internal" href="#term-tasks"><span class="xref std std-term">task</span></a> in Ansible can be
stored in a variable for use in a template or a conditional statement.
The keyword used to define the variable is called <code class="docutils literal"><span class="pre">register</span></code>, taking
its name from the idea of registers in assembly programming (though
Ansible will never feel like assembly programming).  There are an
infinite number of variable names you can use for registration.</dd>
<dt id="term-resource-model">Resource Model</dt>
<dd>Ansible modules work in terms of resources.   For instance, the
<span class="xref std std-ref">file module</span> will select a particular file and ensure
that the attributes of that resource match a particular model. As an
example, we might wish to change the owner of <code class="file docutils literal"><span class="pre">/etc/motd</span></code> to
<code class="docutils literal"><span class="pre">root</span></code> if it is not already set to <code class="docutils literal"><span class="pre">root</span></code>, or set its mode to
<code class="docutils literal"><span class="pre">0644</span></code> if it is not already set to <code class="docutils literal"><span class="pre">0644</span></code>.  The resource models
are <a class="reference internal" href="#term-idempotency"><span class="xref std std-term">idempotent</span></a> meaning change commands are not
run unless needed, and Ansible will bring the system back to a desired
state regardless of the actual state &#8211; rather than you having to tell
it how to get to the state.</dd>
<dt id="term-roles">Roles</dt>
<dd>Roles are units of organization in Ansible.  Assigning a role to
a group of <a class="reference internal" href="#term-host"><span class="xref std std-term">hosts</span></a> (or a set of <a class="reference internal" href="#term-group"><span class="xref std std-term">groups</span></a>,
or <a class="reference internal" href="#term-globbing"><span class="xref std std-term">host patterns</span></a>, etc.) implies that they should
implement a specific behavior.  A role may include applying certain
variable values, certain <a class="reference internal" href="#term-tasks"><span class="xref std std-term">tasks</span></a>, and certain <a class="reference internal" href="#term-handlers"><span class="xref std std-term">handlers</span></a>
&#8211; or just one or more of these things.  Because of the file structure
associated with a role, roles become redistributable units that allow
you to share behavior among <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbooks</span></a> &#8211; or even with other users.</dd>
<dt id="term-rolling-update">Rolling Update</dt>
<dd>The act of addressing a number of nodes in a group N at a time to
avoid updating them all at once and bringing the system offline.  For
instance, in a web topology of 500 nodes handling very large volume,
it may be reasonable to update 10 or 20 machines at a time, moving on
to the next 10 or 20 when done.  The <code class="docutils literal"><span class="pre">serial:</span></code> keyword in an Ansible
<a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbooks</span></a> control the size of the rolling update pool.  The
default is to address the batch size all at once, so this is something
that you must opt-in to.  OS configuration (such as making sure config
files are correct) does not typically have to use the rolling update
model, but can do so if desired.</dd>
<dt id="term-serial">Serial</dt>
<dd><div class="first last admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="#term-rolling-update"><span class="xref std std-term">Rolling Update</span></a></p>
</div>
</dd>
<dt id="term-sudo">Sudo</dt>
<dd>Ansible does not require root logins, and since it&#8217;s daemonless,
definitely does not require root level daemons (which can be
a security concern in sensitive environments).  Ansible can log in and
perform many operations wrapped in a sudo command, and can work with
both password-less and password-based sudo.  Some operations that
don&#8217;t normally work with sudo (like scp file transfer) can be achieved
with Ansible&#8217;s <span class="xref std std-ref">copy</span>, <span class="xref std std-ref">template</span>, and
<span class="xref std std-ref">fetch</span> modules while running in sudo mode.</dd>
<dt id="term-ssh-native">SSH (Native)</dt>
<dd>Native OpenSSH as an Ansible transport is specified with <code class="docutils literal"><span class="pre">-c</span> <span class="pre">ssh</span></code>
(or a config file, or a directive in the <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>)
and can be useful if wanting to login via Kerberized SSH or using SSH
jump hosts, etc.  In 1.2.1, <code class="docutils literal"><span class="pre">ssh</span></code> will be used by default if the
OpenSSH binary on the control machine is sufficiently new.
Previously, Ansible selected <code class="docutils literal"><span class="pre">paramiko</span></code> as a default.  Using
a client that supports <code class="docutils literal"><span class="pre">ControlMaster</span></code> and <code class="docutils literal"><span class="pre">ControlPersist</span></code> is
recommended for maximum performance &#8211; if you don&#8217;t have that and
don&#8217;t need Kerberos, jump hosts, or other features, <code class="docutils literal"><span class="pre">paramiko</span></code> is
a good choice.  Ansible will warn you if it doesn&#8217;t detect
ControlMaster/ControlPersist capability.</dd>
<dt id="term-tags">Tags</dt>
<dd>Ansible allows tagging resources in a <a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a>
with arbitrary keywords, and then running only the parts of the
playbook that correspond to those keywords.  For instance, it is
possible to have an entire OS configuration, and have certain steps
labeled <code class="docutils literal"><span class="pre">ntp</span></code>, and then run just the <code class="docutils literal"><span class="pre">ntp</span></code> steps to reconfigure
the time server information on a remote host.</dd>
<dt id="term-task">Task</dt>
<dd><a class="reference internal" href="#term-playbooks"><span class="xref std std-term">Playbooks</span></a> exist to run tasks.  Tasks combine an <a class="reference internal" href="#term-action"><span class="xref std std-term">action</span></a>
(a module and its arguments) with a name and optionally some other
keywords (like <a class="reference internal" href="#term-loops"><span class="xref std std-term">looping directives</span></a>).   <a class="reference internal" href="#term-handlers"><span class="xref std std-term">Handlers</span></a>
are also tasks, but they are a special kind of task that do not run
unless they are notified by name when a task reports an underlying
change on a remote system.</dd>
<dt id="term-tasks">Tasks</dt>
<dd>A list of <a class="reference internal" href="#term-task"><span class="xref std std-term">Task</span></a>.</dd>
<dt id="term-templates">Templates</dt>
<dd>Ansible can easily transfer files to remote systems but often it is
desirable to substitute variables in other files.  Variables may come
from the <a class="reference internal" href="#term-inventory"><span class="xref std std-term">inventory</span></a> file, <a class="reference internal" href="#term-host-vars"><span class="xref std std-term">Host Vars</span></a>, <a class="reference internal" href="#term-group-vars"><span class="xref std std-term">Group
Vars</span></a>, or <a class="reference internal" href="#term-facts"><span class="xref std std-term">Facts</span></a>. Templates use the <a class="reference internal" href="#term-jinja2"><span class="xref std std-term">Jinja2</span></a> template
engine and can also include logical constructs like loops and if
statements.</dd>
<dt id="term-transport">Transport</dt>
<dd>Ansible uses :term:<code class="docutils literal"><span class="pre">Connection</span> <span class="pre">Plugins</span></code> to define types of available
transports.  These are simply how Ansible will reach out to managed
systems.  Transports included are <a class="reference internal" href="#term-paramiko"><span class="xref std std-term">paramiko</span></a>,
<a class="reference internal" href="#term-ssh-native"><span class="xref std std-term">ssh</span></a> (using OpenSSH), and
<a class="reference internal" href="#term-local-connection"><span class="xref std std-term">local</span></a>.</dd>
<dt id="term-when">When</dt>
<dd>An optional conditional statement attached to a <a class="reference internal" href="#term-tasks"><span class="xref std std-term">task</span></a> that is used to
determine if the task should run or not. If the expression following
the <code class="docutils literal"><span class="pre">when:</span></code> keyword evaluates to false, the task will be ignored.</dd>
<dt id="term-vars-variables">Vars (Variables)</dt>
<dd>As opposed to <a class="reference internal" href="#term-facts"><span class="xref std std-term">Facts</span></a>, variables are names of values (they can
be simple scalar values &#8211; integers, booleans, strings) or complex
ones (dictionaries/hashes, lists) that can be used in templates and
<a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbooks</span></a>.  They are declared things, not things that are
inferred from the remote system&#8217;s current state or nature (which is
what Facts are).</dd>
<dt id="term-yaml">YAML</dt>
<dd>Ansible does not want to force people to write programming language
code to automate infrastructure, so Ansible uses YAML to define
<a class="reference internal" href="#term-playbooks"><span class="xref std std-term">playbook</span></a> configuration languages and also variable
files.  YAML is nice because it has a minimum of syntax and is very
clean and easy for people to skim.  It is a good data format for
configuration files and humans, but also machine readable.  Ansible&#8217;s
usage of YAML stemmed from Michael DeHaan&#8217;s first use of it inside of
Cobbler around 2006.  YAML is fairly popular in the dynamic language
community and the format has libraries available for serialization in
many languages (Python, Perl, Ruby, etc.).</dd>
</dl>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-faq"><span class="doc">Frequently Asked Questions</span></a></dt>
<dd>Frequently asked questions</dd>
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-playbooks_best_practices"><span class="doc">Best Practices</span></a></dt>
<dd>Best practices advice</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-YAMLSyntax"></span><div class="section" id="yaml-syntax">
<h3>YAML Syntax<a class="headerlink" href="#yaml-syntax" title="Permalink to this headline">¶</a></h3>
<p>This page provides a basic overview of correct YAML syntax, which is how Ansible
playbooks (our configuration management language) are expressed.</p>
<p>We use YAML because it is easier for humans to read and write than other common
data formats like XML or JSON.  Further, there are libraries available in most
programming languages for working with YAML.</p>
<p>You may also wish to read <a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a> at the same time to see how this
is used in practice.</p>
<div class="section" id="yaml-basics">
<h4>YAML Basics<a class="headerlink" href="#yaml-basics" title="Permalink to this headline">¶</a></h4>
<p>For Ansible, nearly every YAML file starts with a list.
Each item in the list is a list of key/value pairs, commonly
called a &#8220;hash&#8221; or a &#8220;dictionary&#8221;.  So, we need to know how
to write lists and dictionaries in YAML.</p>
<p>There&#8217;s another small quirk to YAML.  All YAML files (regardless of their association with Ansible or not) can optionally
begin with <code class="docutils literal"><span class="pre">---</span></code> and end with <code class="docutils literal"><span class="pre">...</span></code>.  This is part of the YAML format and indicates the start and end of a document.</p>
<p>All members of a list are lines beginning at the same indentation level starting with a <code class="docutils literal"><span class="pre">&quot;-</span> <span class="pre">&quot;</span></code> (a dash and a space):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
<span class="c1"># A list of tasty fruits</span>
fruits:
    - Apple
    - Orange
    - Strawberry
    - Mango
...
</pre></div>
</div>
<p>A dictionary is represented in a simple <code class="docutils literal"><span class="pre">key:</span> <span class="pre">value</span></code> form (the colon must be followed by a space):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span># An employee record
martin:
    name: Martin D&#39;vloper
    job: Developer
    skill: Elite
</pre></div>
</div>
<p>More complicated data structures are possible, such as lists of dictionaries, dictionaries whose values are lists or a mix of both:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span># Employee records
-  martin:
    name: Martin D&#39;vloper
    job: Developer
    skills:
      - python
      - perl
      - pascal
-  tabitha:
    name: Tabitha Bitumen
    job: Developer
    skills:
      - lisp
      - fortran
      - erlang
</pre></div>
</div>
<p>Dictionaries and lists can also be represented in an abbreviated form if you really want to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
martin: {name: Martin D&#39;vloper, job: Developer, skill: Elite}
fruits: [&#39;Apple&#39;, &#39;Orange&#39;, &#39;Strawberry&#39;, &#39;Mango&#39;]
</pre></div>
</div>
<p id="truthiness">Ansible doesn&#8217;t really use these too much, but you can also specify a boolean value (true/false) in several forms:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>create_key: yes
needs_agent: no
knows_oop: True
likes_emacs: TRUE
uses_cvs: <span class="nb">false</span>
</pre></div>
</div>
<p>Values can span multiple lines using <code class="docutils literal"><span class="pre">|</span></code> or <code class="docutils literal"><span class="pre">&gt;</span></code>.  Spanning multiple lines using a <code class="docutils literal"><span class="pre">|</span></code> will include the newlines.  Using a <code class="docutils literal"><span class="pre">&gt;</span></code> will ignore newlines; it&#8217;s used to make what would otherwise be a very long line easier to read and edit.
In either case the indentation will be ignored.
Examples are:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>include_newlines: <span class="p">|</span>
            exactly as you see
            will appear these three
            lines of poetry

ignore_newlines: &gt;
            this is really a
            single line of text
            despite appearances
</pre></div>
</div>
<p>Let&#8217;s combine what we learned so far in an arbitrary YAML example.
This really has nothing to do with Ansible, but will give you a feel for the format:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>---
# An employee record
name: Martin D&#39;vloper
job: Developer
skill: Elite
employed: True
foods:
    - Apple
    - Orange
    - Strawberry
    - Mango
languages:
    perl: Elite
    python: Elite
    pascal: Lame
education: |
    4 GCSEs
    3 A-Levels
    BSc in the Internet of Things
</pre></div>
</div>
<p>That&#8217;s all you really need to know about YAML to start writing <cite>Ansible</cite> playbooks.</p>
</div>
<div class="section" id="gotchas">
<h4>Gotchas<a class="headerlink" href="#gotchas" title="Permalink to this headline">¶</a></h4>
<p>While YAML is generally friendly, the following is going to result in a YAML syntax error:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>foo: somebody said I should put a colon here: so I did

windows_drive: c:
</pre></div>
</div>
<p>...but this will work:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>windows_path: c:<span class="se">\w</span>indows
</pre></div>
</div>
<p>You will want to quote hash values using colons followed by a space or the end of the line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>foo: <span class="s2">&quot;somebody said I should put a colon here: so I did&quot;</span>

windows_drive: <span class="s2">&quot;c:&quot;</span>
</pre></div>
</div>
<p>...and then the colon will be preserved.</p>
<p>Further, Ansible uses &#8220;{{ var }}&#8221; for variables.  If a value after a colon starts
with a &#8220;{&#8221;, YAML will think it is a dictionary, so you must quote it, like so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>foo: <span class="s2">&quot;{{ variable }}&quot;</span>
</pre></div>
</div>
<p>If your value starts with a quote the entire value must be quoted, not just part of it. Here are some additional examples of how to properly quote things:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>foo: <span class="s2">&quot;{{ variable }}/additional/string/literal&quot;</span>
foo2: <span class="s2">&quot;{{ variable }}\\backslashes\\are\\also\\special\\characters&quot;</span>
foo3: <span class="s2">&quot;even if it&#39;s just a string literal it must all be quoted&quot;</span>
</pre></div>
</div>
<p>Not valid:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>foo: <span class="s2">&quot;E:\\path\\&quot;</span>rest<span class="se">\\</span>of<span class="se">\\</span>path
</pre></div>
</div>
<p>The same applies for strings that start or contain any YAML special characters <code class="docutils literal"><span class="pre">[]</span> <span class="pre">{}</span> <span class="pre">:</span> <span class="pre">&gt;</span> <span class="pre">|</span></code> .</p>
<p>Boolean conversion is helpful, but this can be a problem when you want a literal <cite>yes</cite> or other boolean values as a string.
In these cases just use quotes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>non_boolean: <span class="s2">&quot;yes&quot;</span>
other_string: <span class="s2">&quot;False&quot;</span>
</pre></div>
</div>
<p>YAML converts certain strings into floating-point values, such as the string
<cite>1.0</cite>. If you need to specify a version number (in a requirements.yml file, for
example), you will need to quote the value if it looks like a floating-point
value:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>version: <span class="s2">&quot;1.0&quot;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-playbooks"><span class="doc">Playbooks</span></a></dt>
<dd>Learn what playbooks can do and how to write/run them.</dd>
<dt><a class="reference external" href="http://yamllint.com/">YAMLLint</a></dt>
<dd>YAML Lint (online) helps you debug YAML syntax if you are having problems</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">Github examples directory</a></dt>
<dd>Complete playbook files from the github project source</dd>
<dt><a class="reference external" href="https://en.wikipedia.org/wiki/YAML">Wikipedia YAML syntax reference</a></dt>
<dd>A good guide to YAML syntax</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-porting_guides"></span><div class="section" id="ansible-porting-guides">
<span id="porting-guides"></span><h3>Ansible Porting Guides<a class="headerlink" href="#ansible-porting-guides" title="Permalink to this headline">¶</a></h3>
<p>This section lists porting guides that can help you playbooks, plugins and other parts of your Ansible infrastructure from one version of Ansible to the next. Please note that this is not a complete list. If you believe any extra information would be useful in these pages, you can edit by clicking <cite>Edit on GitHub</cite> on the top right, or raising an issue.</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#porting-2-0-guide"><span class="std std-ref">Ansible 1.x to 2.0 porting guide</span></a></li>
<li><a class="reference internal" href="index.html#porting-2-3-guide"><span class="std std-ref">Ansible 2.2 to 2.3 porting guide</span></a></li>
<li><a class="reference internal" href="index.html#porting-2-4-guide"><span class="std std-ref">Ansible 2.3 to 2.4 porting guide</span></a></li>
</ul>
</div>
<span id="document-python_3_support"></span><div class="section" id="python-3-support">
<h3>Python 3 Support<a class="headerlink" href="#python-3-support" title="Permalink to this headline">¶</a></h3>
<p>Ansible 2.2 features a tech preview of Python 3 support. This topic discusses how you can test to make sure your modules and playbooks work with Python 3.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible supports Python version 3.5 and above only.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Technology preview features provide early access to upcoming product innovations,
enabling you to test functionality and provide feedback during the development process.
Please be aware that tech preview features may not be functionally complete and are not
intended for production use. To report a Python 3 bug, please see <a class="reference external" href="http://docs.ansible.com/ansible/community.html#i-d-like-to-report-a-bug">Community Information &amp; Contributing</a>.</p>
</div>
<div class="section" id="testing-python-3-with-commands-and-playbooks">
<h4>Testing Python 3 with commands and playbooks<a class="headerlink" href="#testing-python-3-with-commands-and-playbooks" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><cite>Run Ansible 2.2+ :ref:`from_source</cite></li>
<li>To test Python 3 on the controller, run your ansible command via
<code class="docutils literal"><span class="pre">python3</span></code>. For example:</li>
</ul>
<div class="highlight-shell"><div class="highlight"><pre><span></span>python3 /usr/bin/ansible localhost -m ping
python3 /usr/bin/ansible-playbook sample-playbook.yml
</pre></div>
</div>
<p>You can also install Ansible using <strong class="program">pip</strong> for Python3 which will make the default
<strong class="command">/usr/bin/ansible</strong> run with Python3:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>$ virtualenv py3-ansible
$ <span class="nb">source</span> ./bin/activate
$ pip3 install ansible
$ ansible --version<span class="p">|</span>grep python
python <span class="nv">version</span> <span class="o">=</span> <span class="m">3</span>.5.3 <span class="o">(</span>default, May <span class="m">10</span> <span class="m">2017</span>, <span class="m">15</span>:05:55<span class="o">)</span> <span class="o">[</span>GCC <span class="m">6</span>.3.1 <span class="m">20161221</span> <span class="o">(</span>Red Hat <span class="m">6</span>.3.1-1<span class="o">)]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Individual Linux distribution packages may be packaged for Python2 or Python3.  When running from
distro packages you&#8217;ll only be able to use Ansible with the Python version for which it was
installed.  Sometimes distros will provide a means of installing for several Python versions
(via a separate package or via some commands that are run after install).  You&#8217;ll need to check
with your distro to see if that applies in your case.</p>
</div>
</div>
<div class="section" id="testing-python-3-module-support">
<h4>Testing Python 3 module support<a class="headerlink" href="#testing-python-3-module-support" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Set the ansible_python_interpreter configuration option to
<strong class="command">/usr/bin/python3</strong>. The <code class="docutils literal"><span class="pre">ansible_python_interpreter</span></code> configuration option is
usually set per-host as an inventory variable associated with a host or group of hosts:</li>
</ul>
<div class="highlight-ini"><div class="highlight"><pre><span></span>  <span class="c1"># Example inventory that makes an alias for localhost that uses python3</span>
  <span class="k">[py3-hosts]</span>
  <span class="na">localhost-py3 ansible_host</span><span class="o">=</span><span class="s">localhost ansible_connection=local</span>

  <span class="k">[py3-hosts:vars]</span>
  <span class="na">ansible_python_interpreter</span><span class="o">=</span><span class="s">/usr/bin/python3</span>

<span class="na">See the :ref:`inventory documentation &lt;inventory&gt;` for more information.</span>
</pre></div>
</div>
<ul class="simple">
<li>Run your command or playbook:</li>
</ul>
<div class="highlight-shell"><div class="highlight"><pre><span></span>ansible localhost-py3 -m ping
ansible-playbook sample-playbook.yml
</pre></div>
</div>
<p>Note that you can also use the <code class="xref std std-option docutils literal"><span class="pre">-e</span></code> command line option to manually
set the python interpreter when you run a command. For example:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>ansible localhost -m ping -e <span class="s1">&#39;ansible_python_interpreter=/usr/bin/python3&#39;</span>
ansible-playbook sample-playbook.yml -e <span class="s1">&#39;ansible_python_interpreter=/usr/bin/python3&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="what-to-do-if-an-incompatibility-is-found">
<h4>What to do if an incompatibility is found<a class="headerlink" href="#what-to-do-if-an-incompatibility-is-found" title="Permalink to this headline">¶</a></h4>
<p>If you find a bug while testing modules with Python3 you can submit a bug
report on <a class="reference external" href="https://github.com/ansible/ansible/issues/">Ansible&#8217;s GitHub project</a>.  Be sure to mention Python3 in
the bug report so that the right people look at it.</p>
<p>If you would like to fix the code and submit a pull request on github, you can
refer to <a class="reference internal" href="index.html#document-dev_guide/developing_python3"><span class="doc">Ansible and Python 3</span></a> for information on how we fix
common Python3 compatibility issues in the Ansible codebase.</p>
</div>
</div>
</div>
</div>
</div>


          </div>
          <div id="search-results"><gcse:searchresults-only></div>
          <footer>
  

  <hr/>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');
</script>

  <p>
  Copyright © 2017 Red Hat, Inc.
  <br>
    Last updated on Sep 20, 2017.
  </p>
<p>
Ansible docs are generated from <a href="https://github.com/ansible/ansible">GitHub sources</a> using <a href="http://sphinx-doc.org/">Sphinx</a> using a theme provided by <a href="http://readthedocs.org">Read the Docs</a>. 
</p>
</footer>
        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="icon icon-book"> Read the Docs</span>
      v: stable 
      <span class="icon icon-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//readthedocs.org/projects/ansible/downloads/pdf/stable/">pdf</a></dd>
        
          <dd><a href="//readthedocs.org/projects/ansible/downloads/htmlzip/stable/">htmlzip</a></dd>
        
          <dd><a href="//readthedocs.org/projects/ansible/downloads/epub/stable/">epub</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/ansible/?fromdocs=ansible">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/ansible/?fromdocs=ansible">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



<!-- begin analytics -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "standard-page"]);
        (function(d,s,i,r) {
        if (d.getElementById(i)){return;}
        var n = d.createElement(s),e = document.getElementsByTagName(s)[0];
        n.id=i;n.src = '//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/330046.js';
        e.parentNode.insertBefore(n, e);
        })(document, "script", "hs-analytics",300000);
</script>
<!-- end analytics -->
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
_satellite.pageBottom();
}
</script>
</body>
</html>